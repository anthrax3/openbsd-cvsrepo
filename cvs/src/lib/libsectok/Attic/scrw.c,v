head	1.7;
access;
symbols
	OPENBSD_4_8:1.6.0.38
	OPENBSD_4_8_BASE:1.6
	OPENBSD_4_7:1.6.0.34
	OPENBSD_4_7_BASE:1.6
	OPENBSD_4_6:1.6.0.36
	OPENBSD_4_6_BASE:1.6
	OPENBSD_4_5:1.6.0.32
	OPENBSD_4_5_BASE:1.6
	OPENBSD_4_4:1.6.0.30
	OPENBSD_4_4_BASE:1.6
	OPENBSD_4_3:1.6.0.28
	OPENBSD_4_3_BASE:1.6
	OPENBSD_4_2:1.6.0.26
	OPENBSD_4_2_BASE:1.6
	OPENBSD_4_1:1.6.0.24
	OPENBSD_4_1_BASE:1.6
	OPENBSD_4_0:1.6.0.22
	OPENBSD_4_0_BASE:1.6
	OPENBSD_3_9:1.6.0.20
	OPENBSD_3_9_BASE:1.6
	OPENBSD_3_8:1.6.0.18
	OPENBSD_3_8_BASE:1.6
	OPENBSD_3_7:1.6.0.16
	OPENBSD_3_7_BASE:1.6
	OPENBSD_3_6:1.6.0.14
	OPENBSD_3_6_BASE:1.6
	OPENBSD_3_5:1.6.0.12
	OPENBSD_3_5_BASE:1.6
	OPENBSD_3_4:1.6.0.10
	OPENBSD_3_4_BASE:1.6
	OPENBSD_3_3:1.6.0.8
	OPENBSD_3_3_BASE:1.6
	OPENBSD_3_2:1.6.0.6
	OPENBSD_3_2_BASE:1.6
	OPENBSD_3_1:1.6.0.4
	OPENBSD_3_1_BASE:1.6
	OPENBSD_3_0:1.6.0.2
	OPENBSD_3_0_BASE:1.6;
locks; strict;
comment	@ * @;


1.7
date	2010.10.17.08.45.17;	author djm;	state dead;
branches;
next	1.6;

1.6
date	2001.07.20.15.51.45;	author rees;	state Exp;
branches;
next	1.5;

1.5
date	2001.07.02.20.07.09;	author rees;	state Exp;
branches;
next	1.4;

1.4
date	2001.06.08.15.04.05;	author rees;	state Exp;
branches;
next	1.3;

1.3
date	2001.06.07.20.19.43;	author rees;	state Exp;
branches;
next	1.2;

1.2
date	2001.06.07.16.10.00;	author rees;	state Exp;
branches;
next	1.1;

1.1
date	2001.06.07.15.17.33;	author rees;	state Exp;
branches;
next	;


desc
@@


1.7
log
@remove libsectok; it hasn't been updated in years and doesn't work
with the current generation of tokens; ok markus@@ deraadt@@
@
text
@/* $Id: scrw.c,v 1.6 2001/07/20 15:51:45 rees Exp $ */

/*
copyright 1997, 1999, 2000
the regents of the university of michigan
all rights reserved

permission is granted to use, copy, create derivative works
and redistribute this software and such derivative works
for any purpose, so long as the name of the university of
michigan is not used in any advertising or publicity
pertaining to the use or distribution of this software
without specific, written prior authorization.  if the
above copyright notice or any other identification of the
university of michigan is included in any copy of any
portion of this software, then the disclaimer below must
also be included.

this software is provided as is, without representation
from the university of michigan as to its fitness for any
purpose, and without warranty by the university of
michigan of any kind, either express or implied, including
without limitation the implied warranties of
merchantability and fitness for a particular purpose. the
regents of the university of michigan shall not be liable
for any damages, including special, indirect, incidental, or
consequential damages, with respect to any claim arising
out of or in connection with the use of the software, even
if it has been or is hereafter advised of the possibility of
such damages.
*/

/*
 * OS independent part
 *
 * Jim Rees, University of Michigan, October 1997
 */

#ifdef __palmos__
#include <Common.h>
#include <System/SysAll.h>
#include <System/Unix/unix_stdio.h>
#include <System/Unix/unix_stdlib.h>
#include <System/Unix/unix_string.h>
#include <UI/UIAll.h>
#include "field.h"
#else
#include <stdio.h>
#include <string.h>
#endif
#ifdef SCPERF
#define SCPERF_FIRST_APPEARANCE
#endif /* SCPERF */
#include "sectok.h"
#include "sc7816.h"
#include "todos_scrw.h"

/* external variable */
#ifdef BYTECOUNT
extern int num_getc, num_putc;
#endif /* BYTECOUNT */

struct scparam scparam[4];

/* reset the card, and return answer to reset (atr) */

int
todos_scxreset(int ttyn, int flags, unsigned char *atr, int *ep)
{
    unsigned char buf[33];
    int n, err;

    if (ep)
	*ep = SCEOK;
    else
	ep = &err;

    if (!todos_sccardpresent(ttyn)) {
	*ep = SCENOCARD;
	return 0;
    }

    if (!atr)
	atr = buf;

    if (!(flags & SCRTODOS) && (todos_scsetflags(ttyn, 0, 0) & SCOXDTR))
	flags |= SCRTODOS;

    todos_scsetspeed(ttyn, 9600);
    todos_scsetflags(ttyn, 0, SCOINVRT);

    if (todos_scdtr(ttyn, (flags & SCRTODOS)) < 0) {
	*ep = SCENOCARD;
	return 0;
    }

    /* 7816-3 sec 5.2 says >= 40000 clock cycles, ~=12 msec */
    scsleep(20);

    todos_scdtr(ttyn, !(flags & SCRTODOS));

    n = todos_get_atr(ttyn, flags, atr, &scparam[ttyn]);
    if (!n && ep)
	*ep = SCESLAG;
    if (scparam[ttyn].t < 0 && ep)
	*ep = SCENOSUPP;

    return n;
}

static int
todos_scioproc(int ttyn, int io, unsigned char *cp)
{
    int code;

    /* Wait extra guard time if needed */
    if (!io && scparam[ttyn].n)
	scsleep(((scparam[ttyn].n * scparam[ttyn].etu) + 999) / 1000);

    code = (!io ? scputc(ttyn, *cp) : scgetc(ttyn, cp, scparam[ttyn].cwt));

    return code;
}

/* This does the real work of transferring data to or from the card.  Since the ack
   handling is the same for both send and receive, we do it all here. */

static int
todos_scioT0(int ttyn, int io, int cla, int ins, int p1, int p2, int p3, unsigned char *buf, int *sw1p, int *sw2p)
{
    int n = 0, ack, ackxins;
    unsigned char *bp = buf, c, apdu[5];
#ifdef BYTECOUNT
    int tmp_num_getc, tmp_num_putc;
#endif /* BYTECOUNT */
	
#ifdef BYTECOUNT
    tmp_num_getc = num_getc;
    tmp_num_putc = num_putc;
#endif /* BYTECOUNT */

#ifdef SCPERF
    SetTime("SCIO starts");
#endif /* SCPERF */

#ifdef DEBUG
    printf("scioT0 %3s %02x %02x %02x %02x %02x\n", io ? "out" : "in", cla, ins, p1, p2, p3);
#endif

    apdu[0] = cla;
    apdu[1] = ins;
    apdu[2] = p1;
    apdu[3] = p2;
    apdu[4] = p3;
    scputblk(ttyn, apdu, 5);

#ifdef SCPERF
    SetTime("Finish sending APDU");
#endif /* SCPERF */

    while (1) {
	/* read ack byte; see 7816-3 8.2.2 */
	if (scgetc(ttyn, &c, scparam[ttyn].cwt) != SCEOK) {
#ifdef DEBUG
	    printf("%d ms timeout reading ack\n", scparam[ttyn].cwt);
#endif
	    return -1;
	}
	ack = c;

	if (ack == 0x60) {
	    /* null (no-op but resets timer) */
#ifdef DEBUG
	    printf("got 0x60 (null) ack; reset timer\n");
#endif
	    continue;
	}

	if ((ack & 0xf0) == 0x60 || (ack & 0xf0) == 0x90) {
	    /* SW1; get SW2 and return */
	    *sw1p = ack;
	    if (scgetc(ttyn, &c, scparam[ttyn].cwt) != SCEOK) {
#ifdef DEBUG
		printf("%d ms timeout reading sw2\n", scparam[ttyn].cwt);
#endif
		return -1;
	    }
	    *sw2p = (c & 0xff);
	    break;
	}

	/* we would set VPP here if the interface supported it */

	ackxins = (ack ^ ins) & 0xfe;
	if (ackxins == 0xfe) {
	    if (n < p3) {
		/* xfer next data byte */
		if (todos_scioproc(ttyn, io, bp++) != SCEOK) {
#ifdef DEBUG
		    printf("%d ms timeout reading next data byte\n", scparam[ttyn].cwt);
#endif
		    return -1;
		}
		n++;
	    }

	} else if (ackxins == 0) {
	    /* xfer all remaining data bytes */
	    while (n < p3) {
		if (todos_scioproc(ttyn, io, bp++) != SCEOK) {
#ifdef DEBUG
		    printf("%d ms timeout reading all remaining data bytes\n", scparam[ttyn].cwt);
#endif
		    return -1;
		}
		n++;
	    }
#ifdef SCPERF
	    SetTime("Finish sending or receiving DATA");
#endif /* SCPERF */
	} else {
	    /* ?? unknown ack byte */
#ifdef DEBUG
	    printf("unknown ack %x\n", ack);
	    continue;
#else
	    return -1;
#endif
	}
    }

#ifdef SCPERF
    SetTime("Finish scio");
#endif /* SCPERF */

#ifdef BYTECOUNT
    tmp_num_putc = num_putc - tmp_num_putc;
    tmp_num_getc = num_getc - tmp_num_getc - tmp_num_putc;
    MESSAGE3("#getc=%d, #putc=%d\n", tmp_num_getc, tmp_num_putc);
#endif /* BYTECOUNT */

    return n;
}

int
todos_scrw(int ttyn, int cla, int ins, int p1, int p2, int ilen, unsigned char *ibuf, int olen, unsigned char *obuf, int *sw1p, int *sw2p)
{
    int r;

    if (scparam[ttyn].t == 0) {
	if (ilen > 0 && ibuf) {
	    /* Send "in" data */
	    r = (todos_scioT0(ttyn, 0, cla, ins, p1, p2, ilen, ibuf, sw1p, sw2p) >= 0) ? 0 : -1;
	    if (r >= 0 && *sw1p == 0x61 && olen >= *sw2p && obuf) {
		/* Response available; get it */
		r = todos_scioT0(ttyn, 1, cla, 0xc0, 0, 0, *sw2p, obuf, sw1p, sw2p);
	    }
	} else {
	    /* Get "out" data */
	    r = todos_scioT0(ttyn, 1, cla, ins, p1, p2, olen, obuf, sw1p, sw2p);
	}
#ifndef NO_T_EQ_1
    } else if (scparam[ttyn].t == 1) {
	r = scioT1(ttyn, cla, ins, p1, p2, ilen, ibuf, olen, obuf, sw1p, sw2p);
#endif
    } else
	r = -1;

    return r;
}
@


1.6
log
@parse_atr -> sectok_parse_atr
remove sc7816.h from installed includes
move struct scparam to sectok.h
lookup_cmdname -> sectok_get_ins
@
text
@d1 1
a1 1
/* $Id: scrw.c,v 1.5 2001/07/02 20:07:09 rees Exp $ */
@


1.5
log
@separate sectok from sc7816 and give each its own include file
change status word to a single word instead of two bytes
add sc7816 layer for backward compatibility
other minor changes
@
text
@d1 1
a1 1
/* $Id: scrw.c,v 1.4 2001/06/08 15:04:05 rees Exp $ */
d54 1
@


1.4
log
@Move copyright notice to top of file
@
text
@d1 1
a1 1
/* $Id: scrw.c,v 1.12 2001/06/07 20:15:05 rees Exp rees $ */
d54 1
a54 1
#include "sectok.h"
d195 3
a197 2
	    /* xfer next data byte */
	    if (todos_scioproc(ttyn, io, bp++) != SCEOK) {
d199 1
a199 1
		printf("%d ms timeout reading next data byte\n", scparam[ttyn].cwt);
d201 3
a203 1
		return -1;
a204 1
	    n++;
@


1.3
log
@import latest from CITI with Palm support
@
text
@d1 32
a35 2
 * See copyright notice at end of file
 *
a37 1
static char *rcsid = "$Id: scrw.c,v 1.12 2001/06/07 20:15:05 rees Exp $";
a267 30

/*
copyright 1997, 1999, 2000
the regents of the university of michigan
all rights reserved

permission is granted to use, copy, create derivative works
and redistribute this software and such derivative works
for any purpose, so long as the name of the university of
michigan is not used in any advertising or publicity
pertaining to the use or distribution of this software
without specific, written prior authorization.  if the
above copyright notice or any other identification of the
university of michigan is included in any copy of any
portion of this software, then the disclaimer below must
also be included.

this software is provided as is, without representation
from the university of michigan as to its fitness for any
purpose, and without warranty by the university of
michigan of any kind, either express or implied, including
without limitation the implied warranties of
merchantability and fitness for a particular purpose. the
regents of the university of michigan shall not be liable
for any damages, including special, indirect, incidental, or
consequential damages, with respect to any claim arising
out of or in connection with the use of the software, even
if it has been or is hereafter advised of the possibility of
such damages.
*/
@


1.2
log
@fix compiler warnings
@
text
@d8 1
a8 1
static char *rcsid = "$Id: scrw.c,v 1.9 2001/06/07 16:01:26 rees Exp $";
d22 1
a22 1
#ifdef SCPERF 
a27 8
/* Global interface bytes */
#define TA1 (tpb[0][0])
#define TB1 (tpb[0][1])
#define TC1 (tpb[0][2])
#define TD1 (tpb[0][3])
#define TC2 (tpb[1][2])
#define TA2 (tpb[1][0])

a34 4
#ifndef NO_T_EQ_1
int todos_scioT1(int ttyn, int cla, int ins, int p1, int p2, int ilen, unsigned char *ibuf, int olen, unsigned char *obuf, int *sw1p, int *sw2p);
#endif

d68 1
a68 1
    todos_scsleep(20);
d88 1
a88 1
	todos_scsleep(((scparam[ttyn].n * scparam[ttyn].etu) + 999) / 1000);
d90 1
a90 1
    code = (!io ? todos_scputc(ttyn, *cp) : todos_scgetc(ttyn, cp, scparam[ttyn].cwt));
d102 1
a102 1
    unsigned char *bp = buf, c;
d119 7
a125 6
  
    c = cla; todos_scioproc(ttyn, 0, &c);
    c = ins; todos_scioproc(ttyn, 0, &c);
    c = p1;  todos_scioproc(ttyn, 0, &c);
    c = p2;  todos_scioproc(ttyn, 0, &c);
    c = p3;  todos_scioproc(ttyn, 0, &c);
d133 1
a133 1
	if (todos_scgetc(ttyn, &c, scparam[ttyn].cwt) != SCEOK) {
d152 1
a152 1
	    if (todos_scgetc(ttyn, &c, scparam[ttyn].cwt) != SCEOK) {
d207 1
a207 1
    MESSAGE3("#getc=%d, #putc=%d\n", tmp_num_getc, tmp_num_putc); 
d232 1
a232 1
	r = todos_scioT1(ttyn, cla, ins, p1, p2, ilen, ibuf, olen, obuf, sw1p, sw2p);
d245 9
a253 9
permission is granted to use, copy, create derivative works 
and redistribute this software and such derivative works 
for any purpose, so long as the name of the university of 
michigan is not used in any advertising or publicity 
pertaining to the use or distribution of this software 
without specific, written prior authorization.  if the 
above copyright notice or any other identification of the 
university of michigan is included in any copy of any 
portion of this software, then the disclaimer below must 
d256 11
a266 11
this software is provided as is, without representation 
from the university of michigan as to its fitness for any 
purpose, and without warranty by the university of 
michigan of any kind, either express or implied, including 
without limitation the implied warranties of 
merchantability and fitness for a particular purpose. the 
regents of the university of michigan shall not be liable 
for any damages, including special, indirect, incidental, or 
consequential damages, with respect to any claim arising 
out of or in connection with the use of the software, even 
if it has been or is hereafter advised of the possibility of 
@


1.1
log
@libsectok for secure tokens (smartcard, iButton, etc)
@
text
@d8 1
a8 1
static char *rcsid = "$Id: scrw.c,v 1.7 2001/04/27 14:59:19 rees Exp $";
d52 1
a52 1
    unsigned char *ap, buf[33];
@

