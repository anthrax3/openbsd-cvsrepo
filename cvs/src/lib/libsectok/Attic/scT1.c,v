head	1.6;
access;
symbols
	OPENBSD_4_8:1.5.0.38
	OPENBSD_4_8_BASE:1.5
	OPENBSD_4_7:1.5.0.34
	OPENBSD_4_7_BASE:1.5
	OPENBSD_4_6:1.5.0.36
	OPENBSD_4_6_BASE:1.5
	OPENBSD_4_5:1.5.0.32
	OPENBSD_4_5_BASE:1.5
	OPENBSD_4_4:1.5.0.30
	OPENBSD_4_4_BASE:1.5
	OPENBSD_4_3:1.5.0.28
	OPENBSD_4_3_BASE:1.5
	OPENBSD_4_2:1.5.0.26
	OPENBSD_4_2_BASE:1.5
	OPENBSD_4_1:1.5.0.24
	OPENBSD_4_1_BASE:1.5
	OPENBSD_4_0:1.5.0.22
	OPENBSD_4_0_BASE:1.5
	OPENBSD_3_9:1.5.0.20
	OPENBSD_3_9_BASE:1.5
	OPENBSD_3_8:1.5.0.18
	OPENBSD_3_8_BASE:1.5
	OPENBSD_3_7:1.5.0.16
	OPENBSD_3_7_BASE:1.5
	OPENBSD_3_6:1.5.0.14
	OPENBSD_3_6_BASE:1.5
	OPENBSD_3_5:1.5.0.12
	OPENBSD_3_5_BASE:1.5
	OPENBSD_3_4:1.5.0.10
	OPENBSD_3_4_BASE:1.5
	OPENBSD_3_3:1.5.0.8
	OPENBSD_3_3_BASE:1.5
	OPENBSD_3_2:1.5.0.6
	OPENBSD_3_2_BASE:1.5
	OPENBSD_3_1:1.5.0.4
	OPENBSD_3_1_BASE:1.5
	OPENBSD_3_0:1.5.0.2
	OPENBSD_3_0_BASE:1.5;
locks; strict;
comment	@ * @;


1.6
date	2010.10.17.08.45.17;	author djm;	state dead;
branches;
next	1.5;

1.5
date	2001.07.20.15.51.45;	author rees;	state Exp;
branches;
next	1.4;

1.4
date	2001.07.02.20.07.08;	author rees;	state Exp;
branches;
next	1.3;

1.3
date	2001.06.08.15.04.04;	author rees;	state Exp;
branches;
next	1.2;

1.2
date	2001.06.07.20.19.43;	author rees;	state Exp;
branches;
next	1.1;

1.1
date	2001.06.07.15.17.33;	author rees;	state Exp;
branches;
next	;


desc
@@


1.6
log
@remove libsectok; it hasn't been updated in years and doesn't work
with the current generation of tokens; ok markus@@ deraadt@@
@
text
@/* $Id: scT1.c,v 1.5 2001/07/20 15:51:45 rees Exp $ */

/*
copyright 1997, 1999, 2000
the regents of the university of michigan
all rights reserved

permission is granted to use, copy, create derivative works 
and redistribute this software and such derivative works 
for any purpose, so long as the name of the university of 
michigan is not used in any advertising or publicity 
pertaining to the use or distribution of this software 
without specific, written prior authorization.  if the 
above copyright notice or any other identification of the 
university of michigan is included in any copy of any 
portion of this software, then the disclaimer below must 
also be included.

this software is provided as is, without representation 
from the university of michigan as to its fitness for any 
purpose, and without warranty by the university of 
michigan of any kind, either express or implied, including 
without limitation the implied warranties of 
merchantability and fitness for a particular purpose. the 
regents of the university of michigan shall not be liable 
for any damages, including special, indirect, incidental, or 
consequential damages, with respect to any claim arising 
out of or in connection with the use of the software, even 
if it has been or is hereafter advised of the possibility of 
such damages.
*/

/*
 * T=1 protocol engine
 *
 * Jim Rees, University of Michigan, October 1997
 */

#ifdef __palmos__
#include <Common.h>
#include <System/SysAll.h>
#include <System/MemoryMgr.h>
#include <System/Unix/unix_stdlib.h>
#include <System/Unix/sys_socket.h>
#else
#include <stdio.h>
#endif
#include <string.h>
#ifdef TIMING
#include <sys/time.h>
#endif

#include "sectok.h"
#include "sc7816.h"

#ifdef __palmos__
#undef printf
#undef sprintf
#define printf palmprintf
#endif

int
scioT1(int ttyn, int cla, int ins, int p1, int p2, int ilen, unsigned char *ibuf, int olen, unsigned char *obuf, int *sw1p, int *sw2p)
{
    int i, len, n;
    unsigned char *bp, *obp, tbuf[256];

    /* Send 3 bytes prologue (7816-3 sec 9.4.1 fig 16) */

    bp = tbuf;
    len = 5 + ilen;

    /* Send APDU */

    *bp++ = cla;
    *bp++ = ins;
    *bp++ = p1;
    *bp++ = p2;
    *bp++ = ilen;

    /* Send data */

    for (i = 0; i < ilen; i++)
	*bp++ = ibuf[i];
#ifndef HUH
    if (ilen) {
	/* I don't understand this, but Visa card wants it */
	*bp++ = 0;
	len++;
    }
#endif

    obp = obuf ? obuf : tbuf;

    n = scioT1Iblk(ttyn, len, tbuf, obp);

    if (n >= 2) {
	*sw1p = obp[n-2];
	*sw2p = obp[n-1];
	n -= 2;
    }
    return n;
}

int
scioT1Iblk(int ttyn, int ilen, unsigned char *ibuf, unsigned char *obuf)
{
    int n;
    unsigned char tbuf[256];
    static unsigned char ssn;

    tbuf[0] = 0;
    tbuf[1] = ssn;
    ssn ^= 0x40;
    tbuf[2] = ilen;
    memcpy(&tbuf[3], ibuf, ilen);
    n = scioT1pkt(ttyn, tbuf, tbuf);
    if (n < 0)
	return n;
    memcpy(obuf, &tbuf[3], tbuf[2]);
    return tbuf[2];
}

int
scioT1pkt(int ttyn, unsigned char *ibuf, unsigned char *obuf)
{
    int i, len;
    unsigned char edc, *bp;

    len = ibuf[2] + 3;

    /* Calculate checksum */

    for (i = 0, edc = 0; i < len; i++)
	edc ^= ibuf[i];
    ibuf[len++] = edc;

    /* Wait BGT = 22 etu */

    scsleep(scparam[ttyn].etu * 22 / 1000 + 1);

    /* Send the packet */

    scputblk(ttyn, ibuf, len);

    /* Read return packet */

    bp = obuf;

    /* Read three byte header */
    for (i = 0; i < 3; i++) {
	if (scgetc(ttyn, bp++, (i == 0) ? scparam[ttyn].bwt : scparam[ttyn].cwt) != SCEOK) {
#ifdef DEBUG
	    printf("T=1 header read timeout\n");
#endif
	    return -1;
	}
    }
    len = obuf[2];

    /* Read data and edc */
    for (i = 0; i < len + 1; i++) {
	if (scgetc(ttyn, bp++, scparam[ttyn].cwt) != SCEOK) {
#ifdef DEBUG
	    printf("T=1 data read timeout\n");
#endif
	    return -1;
	}
    }

    /* Check edc */
    for (i = 0, edc = 0; i < len + 3; i++)
	edc ^= obuf[i];
#ifdef DEBUG
    if (edc != obuf[len + 3])
	printf("edc mismatch, %02x != %02x\n", edc, obuf[len + 3]);
#endif

    return len;
}
@


1.5
log
@parse_atr -> sectok_parse_atr
remove sc7816.h from installed includes
move struct scparam to sectok.h
lookup_cmdname -> sectok_get_ins
@
text
@d1 1
a1 1
/* $Id: scT1.c,v 1.4 2001/07/02 20:07:08 rees Exp $ */
@


1.4
log
@separate sectok from sc7816 and give each its own include file
change status word to a single word instead of two bytes
add sc7816 layer for backward compatibility
other minor changes
@
text
@d1 1
a1 1
/* $Id: scT1.c,v 1.3 2001/06/08 15:04:04 rees Exp $ */
d53 1
@


1.3
log
@Move copyright notice to top of file
@
text
@d1 1
a1 1
/* $Id: scT1.c,v 1.6 2001/06/07 20:15:05 rees Exp rees $ */
d53 1
a53 1
#include "sectok.h"
@


1.2
log
@import latest from CITI with Palm support
@
text
@d1 32
a37 1
static char *rcsid = "$Id: scT1.c,v 1.6 2001/06/07 20:15:05 rees Exp $";
a179 30

/*
copyright 1997, 1999, 2000
the regents of the university of michigan
all rights reserved

permission is granted to use, copy, create derivative works 
and redistribute this software and such derivative works 
for any purpose, so long as the name of the university of 
michigan is not used in any advertising or publicity 
pertaining to the use or distribution of this software 
without specific, written prior authorization.  if the 
above copyright notice or any other identification of the 
university of michigan is included in any copy of any 
portion of this software, then the disclaimer below must 
also be included.

this software is provided as is, without representation 
from the university of michigan as to its fitness for any 
purpose, and without warranty by the university of 
michigan of any kind, either express or implied, including 
without limitation the implied warranties of 
merchantability and fitness for a particular purpose. the 
regents of the university of michigan shall not be liable 
for any damages, including special, indirect, incidental, or 
consequential damages, with respect to any claim arising 
out of or in connection with the use of the software, even 
if it has been or is hereafter advised of the possibility of 
such damages.
*/
@


1.1
log
@libsectok for secure tokens (smartcard, iButton, etc)
@
text
@a3 2
 * See copyright notice at end of file
 *
d6 1
a6 1
static char *rcsid = "$Id: scT1.c,v 1.1 2001/05/22 15:35:57 rees Exp $";
d23 6
a28 1
#include "todos_scrw.h"
d31 1
a31 1
todos_scioT1(int ttyn, int cla, int ins, int p1, int p2, int ilen, unsigned char *ibuf, int olen, unsigned char *obuf, int *sw1p, int *sw2p)
d63 1
a63 1
    n = todos_scioT1Iblk(ttyn, len, tbuf, obp);
d74 1
a74 1
todos_scioT1Iblk(int ttyn, int ilen, unsigned char *ibuf, unsigned char *obuf)
d85 1
a85 1
    n = todos_scioT1pkt(ttyn, tbuf, tbuf);
d93 1
a93 1
todos_scioT1pkt(int ttyn, unsigned char *ibuf, unsigned char *obuf)
d108 1
a108 1
    todos_scsleep(scparam[ttyn].etu * 22 / 1000 + 1);
d112 1
a112 1
    todos_scputblk(ttyn, ibuf, len);
d120 1
a120 1
	if (todos_scgetc(ttyn, bp++, (i == 0) ? scparam[ttyn].bwt : scparam[ttyn].cwt) != SCEOK) {
d131 1
a131 1
	if (todos_scgetc(ttyn, bp++, scparam[ttyn].cwt) != SCEOK) {
@

