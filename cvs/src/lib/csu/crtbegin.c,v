head	1.24;
access;
symbols
	OPENBSD_6_1_BASE:1.24
	OPENBSD_6_0:1.20.0.4
	OPENBSD_6_0_BASE:1.20
	OPENBSD_5_9:1.20.0.2
	OPENBSD_5_9_BASE:1.20
	OPENBSD_5_8:1.19.0.4
	OPENBSD_5_8_BASE:1.19
	OPENBSD_5_7:1.17.0.2
	OPENBSD_5_7_BASE:1.17;
locks; strict;
comment	@ * @;


1.24
date	2017.02.19.21.39.32;	author guenther;	state Exp;
branches;
next	1.23;
commitid	Z96qiiaWGY4tB48u;

1.23
date	2017.01.21.05.46.56;	author guenther;	state Exp;
branches;
next	1.22;
commitid	5Lv01jWRADlxDkcl;

1.22
date	2017.01.21.00.45.13;	author guenther;	state Exp;
branches;
next	1.21;
commitid	TdwnlwbfWriSs7fI;

1.21
date	2016.12.22.09.32.04;	author kettenis;	state Exp;
branches;
next	1.20;
commitid	mbYGQa0a84R69mqQ;

1.20
date	2015.11.10.04.14.03;	author guenther;	state Exp;
branches;
next	1.19;
commitid	SlaqG0vnitmMjAjz;

1.19
date	2015.04.07.01.27.06;	author guenther;	state Exp;
branches;
next	1.18;
commitid	oQvh7XA3Kql35r0J;

1.18
date	2015.04.04.18.05.05;	author guenther;	state Exp;
branches;
next	1.17;
commitid	JLMS0l1gREgLc0hW;

1.17
date	2013.12.28.18.38.42;	author kettenis;	state Exp;
branches;
next	1.16;

1.16
date	2012.09.08.20.08.33;	author matthew;	state Exp;
branches;
next	1.15;

1.15
date	2012.08.28.16.39.09;	author matthew;	state Exp;
branches;
next	1.14;

1.14
date	2010.05.01.11.32.43;	author kettenis;	state Exp;
branches;
next	1.13;

1.13
date	2009.04.13.20.15.24;	author kurt;	state Exp;
branches;
next	1.12;

1.12
date	2007.09.03.14.40.16;	author millert;	state Exp;
branches;
next	1.11;

1.11
date	2004.10.26.20.18.24;	author kettenis;	state Exp;
branches;
next	1.10;

1.10
date	2004.10.10.18.29.15;	author kettenis;	state Exp;
branches;
next	1.9;

1.9
date	2004.01.26.20.04.11;	author espie;	state Exp;
branches;
next	1.8;

1.8
date	2004.01.26.20.00.37;	author espie;	state Exp;
branches;
next	1.7;

1.7
date	2004.01.08.14.59.15;	author drahn;	state Exp;
branches;
next	1.6;

1.6
date	2002.02.16.21.27.20;	author millert;	state Exp;
branches;
next	1.5;

1.5
date	2001.02.03.23.11.23;	author art;	state Exp;
branches;
next	1.4;

1.4
date	2001.02.03.23.08.41;	author art;	state Exp;
branches;
next	1.3;

1.3
date	2001.02.03.22.59.13;	author art;	state Exp;
branches;
next	1.2;

1.2
date	2001.02.03.22.51.31;	author art;	state Exp;
branches;
next	1.1;

1.1
date	2001.02.03.22.47.00;	author art;	state Exp;
branches;
next	;


desc
@@


1.24
log
@Move static variables from .data to .bss by not initializing them to zero

ok kettenis@@
@
text
@/*	$OpenBSD: crtbegin.c,v 1.23 2017/01/21 05:46:56 guenther Exp $	*/
/*	$NetBSD: crtbegin.c,v 1.1 1996/09/12 16:59:03 cgd Exp $	*/

/*
 * Copyright (c) 1993 Paul Kranenburg
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *      This product includes software developed by Paul Kranenburg.
 * 4. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * Run-time module for GNU C++ compiled shared libraries.
 *
 * The linker constructs the following arrays of pointers to global
 * constructors and destructors. The first element contains the
 * number of pointers in each.
 * The tables are also null-terminated.
 */
#include <stdlib.h>

#include "md_init.h"
#include "os-note-elf.h"
#include "extern.h"

struct dwarf2_eh_object {
	void *space[8];
};

void __register_frame_info(const void *, struct dwarf2_eh_object *)
    __attribute__((weak));

void __register_frame_info(const void *begin, struct dwarf2_eh_object *ob)
{
}

MD_DATA_SECTION_FLAGS_SYMBOL(".eh_frame", "a", const void *, __EH_FRAME_BEGIN__);

/*
 * java class registration hooks
 */

MD_DATA_SECTION_FLAGS_SYMBOL(".jcr", "aw", void *, __JCR_LIST__);

extern void _Jv_RegisterClasses (void *)
    __attribute__((weak));


/*
 * Include support for the __cxa_atexit/__cxa_finalize C++ abi for
 * gcc > 2.x. __dso_handle is NULL in the main program and a unique
 * value for each C++ shared library. For more info on this API, see:
 *
 *     http://www.codesourcery.com/cxx-abi/abi.html#dso-dtor
 */

void *__dso_handle = NULL;
__asm(".hidden  __dso_handle");

long __guard_local __dso_hidden __attribute__((section(".openbsd.randomdata")));

MD_DATA_SECTION_SYMBOL_VALUE(".ctors", init_f, __CTOR_LIST__, -1);
MD_DATA_SECTION_SYMBOL_VALUE(".dtors", init_f, __DTOR_LIST__, -1);


static void
__ctors(void)
{
	unsigned long i = (unsigned long) __CTOR_LIST__[0];
	const init_f *p;

	if (i == -1)  {
		for (i = 1; __CTOR_LIST__[i] != NULL; i++)
			;
		i--;
	}
	p = __CTOR_LIST__ + i;
	while (i--)
		(**p--)();
}

static void
__dtors(void)
{
	const init_f *p = __DTOR_LIST__ + 1;

	while (*p)
		(**p++)();
}

void __init(void);
void __fini(void);
static void __do_init(void) __used;
static void __do_fini(void) __used;

MD_SECTION_PROLOGUE(".init", __init);

MD_SECTION_PROLOGUE(".fini", __fini);

MD_SECT_CALL_FUNC(".init", __do_init);
MD_SECT_CALL_FUNC(".fini", __do_fini);


void
__do_init(void)
{
	static int initialized;
	static struct dwarf2_eh_object object;

	/*
	 * Call global constructors.
	 * Arrange to call global destructors at exit.
	 */
	if (!initialized) {
		initialized = 1;

		__register_frame_info(__EH_FRAME_BEGIN__, &object);
		if (__JCR_LIST__[0] && _Jv_RegisterClasses)
			_Jv_RegisterClasses(__JCR_LIST__);
		__ctors();

		atexit(__fini);
	}
}

void
__do_fini(void)
{
	static int finalized;

	if (!finalized) {
		finalized = 1;
		/*
		 * Call global destructors.
		 */
		__dtors();
	}
}

@


1.23
log
@Make crtbegin.c and crtbeginS.c consistent on stylistic points

ok kettenis@@
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.22 2017/01/21 00:45:13 guenther Exp $	*/
d129 1
a129 1
	static int initialized = 0;
d151 1
a151 1
	static int finalized = 0;
@


1.22
log
@Declare the symbols that label the .ctors, .dtors, .eh_frame, and .jcr
sections as extern hidden arrays of indefinite size, so that the compiler
(well, clang) doesn't believe it knows the exact contents and thus optimize
things into infinite loops.  Actually set the symbols to be in the sections
and insert the leading and trailing values via __asm().

Problem pointed out by patrick@@
testing and ok kettenis@@
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.21 2016/12/22 09:32:04 kettenis Exp $	*/
a86 2
static void	__dtors(void) __used;
static void	__ctors(void) __used;
d89 1
a89 1
__ctors()
d105 1
a105 1
__dtors()
d127 1
a127 1
__do_init()
d142 1
a142 1
		(__ctors)();
d149 1
a149 1
__do_fini()
d158 1
a158 1
		(__dtors)();
@


1.21
log
@Don't make __CTOR_LIST__ and __DTOR_LIST__ const.  This makes the .ctors and
.dtors sections writable just like they are in crtend.o and code generated
by compilers.  This is necessary to make sure that linkers that respect the
ELF spec a bit better (such as lld) correctly concatenate the secttions.

ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.20 2015/11/10 04:14:03 guenther Exp $	*/
d59 1
a59 2
static const char __EH_FRAME_BEGIN__[]
    __attribute__((section(".eh_frame"), aligned(4))) = { };
d65 1
a65 2
static void *__JCR_LIST__[]
    __attribute__((section(".jcr"), aligned(sizeof(void*)))) = { };
d84 2
a85 5

static init_f __CTOR_LIST__[1]
    __attribute__((section(".ctors"))) = { (void *)-1 };	/* XXX */
static init_f __DTOR_LIST__[1]
    __attribute__((section(".dtors"))) = { (void *)-1 };	/* XXX */
@


1.20
log
@libc.so can't be unloaded, so move the hidden atexit() and pthread_atfork()
stubs for the executable from crtbegin.o into libc, which lets them be
excluded from static links that don't use them.
For this, drop the normal crt{begin,end}S.o from libc.so: the .init and .fini
sections for libc aren't called at the right times anyway, so it's good that
they're unused.  libc.so just needs __guard_local and the .note.openbsd.ident
section, so add them to stack_protector.c for now (this will be improved)

"good time" deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.19 2015/04/07 01:27:06 guenther Exp $	*/
d87 1
a87 1
static const init_f __CTOR_LIST__[1]
d89 1
a89 1
static const init_f __DTOR_LIST__[1]
@


1.19
log
@Make pthread_atfork() track the DSO that called it like atexit() does,
unregistering callbacks if the DSO is unloaded.  Move the callback
handling from libpthread to libc, though libpthread still overrides the
inner call to handle locking and thread-library reinitialization.
Major version bump for both libc and libpthread.

verification that this fixes various ports ajacoutot@@
asm assistance miod@@; ok millert@@ deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.18 2015/04/04 18:05:05 guenther Exp $	*/
a84 21

extern int __cxa_atexit(void (*)(void *), void *, void *) __attribute__((weak));

int
atexit(void (*fn)(void))
{
	return (__cxa_atexit((void (*)(void *))fn, NULL, NULL));
}

/*
 * Ditto for pthread_atfork()
 */
int	_thread_atfork(void (*)(void), void (*)(void), void (*)(void), void *)
	    __attribute__((weak));

int
pthread_atfork(void (*prep)(void), void (*parent)(void), void (*child)(void))
{
	return (_thread_atfork(prep, parent, child, NULL));
}
asm(".weak pthread_atfork");
@


1.18
log
@gcc 2.x is dead

ok millert@@
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.17 2013/12/28 18:38:42 kettenis Exp $	*/
d93 13
@


1.17
log
@Move atexit(3) into crtbegin.c and certbeginS.c such that we can pass the
right __dso_handle and have dlopen'ed shared objects run their atexit handlers
when they get unloaded.  This is what Linux does, and several ports depend on
this behaviour (and will crash upon exit without this chang).

Based on an earlier diff from matthew@@
Tested by ajacoutot@@
ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.16 2012/09/08 20:08:33 matthew Exp $	*/
a65 1
#if (__GNUC__ > 2)
d71 1
a71 1
#endif
a80 1
#if (__GNUC__ > 2)
d93 1
a93 1
#endif
a154 2

#if (__GNUC__ > 2)
a156 2
#endif

@


1.16
log
@Reverse the order that ctors and dtors are run in accordance with
GCC's documentation.  Fixes GNU C++'s init_priority attribute.

ok miod
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.15 2012/08/28 16:39:09 matthew Exp $	*/
d87 8
@


1.15
log
@Add __guard_local as a hidden symbol to ld.so, kernel, and every
executable and DSO (via crtbegin.c/crtbeginS.c).  Not used yet, but
needed before GCC can start emitting -fstack-protector code that uses
them instead of __guard.
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.14 2010/05/01 11:32:43 kettenis Exp $	*/
d98 1
a98 1
__dtors()
d100 1
a100 1
	unsigned long i = (unsigned long) __DTOR_LIST__[0];
d104 1
a104 1
		for (i = 1; __DTOR_LIST__[i] != NULL; i++)
d108 1
a108 1
	p = __DTOR_LIST__ + i;
d114 1
a114 1
__ctors()
d116 1
a116 1
	const init_f *p = __CTOR_LIST__ + 1;
@


1.14
log
@Sprinkle a few __used markers to prevent gcc4 from throwing away essential
bits of code and data.  With this change gcc4 builds usable crt*.o on sparc64,
other architectures probably need some more love.

ok marco@@, jsg@@
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.13 2009/04/13 20:15:24 kurt Exp $	*/
d85 2
@


1.13
log
@Add gcj java class registration hooks for gcc3 elf archs. From NetBSD
with minor differences.

okay kettenis@@ drahn@@
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.12 2007/09/03 14:40:16 millert Exp $	*/
d92 2
a93 2
static void	__dtors(void);
static void	__ctors(void);
d122 2
a123 2
static void __do_init(void);
static void __do_fini(void);
@


1.12
log
@Add __cxa_atexit() support for gcc3.  This provides support for shared object destructors called at dlclose() time.  Inspired by similar changes in FreeBSD and NetBSD.
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.11 2004/10/26 20:18:24 kettenis Exp $	*/
d63 12
d147 5
@


1.11
log
@Change __register_frame_info into a weakly defined symbol.
ok drahn@@, pval@@, deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.10 2004/10/10 18:29:15 kettenis Exp $	*/
d61 13
@


1.10
log
@Add support for DWARF2 exception handling.
ok drahn@@, millert@@
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.9 2004/01/26 20:04:11 espie Exp $	*/
d52 6
a57 2
extern void __register_frame_info(const void *,
    struct dwarf2_eh_object *) __attribute__((weak));
d121 1
a121 2
		if (__register_frame_info != NULL)
			__register_frame_info(__EH_FRAME_BEGIN__, &object);
@


1.9
log
@add finalized guard to destructor calls, to prevent multiple calls.
stop most kde apps from burping all over the place on exit, which
means that, somehow, our destructors get registered twice... :-(

Okay drahn@@
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.7 2004/01/08 14:59:15 drahn Exp $	*/
d48 10
d108 1
d116 4
@


1.8
log
@small clean-up: typedef to desambiguate const, prototypes...

ok drahn@@, some time ago.
@
text
@d114 9
a122 4
	/*
	 * Call global destructors.
	 */
	(__dtors)();
@


1.7
log
@__init/__fini handling on ELF has not been correct. It is supposed to
be a section which code stubs (branches) can be added to initialize/destructor
This adds MD stubs to allow this to operate as expected. should fix wine
and behave according to ELF specs. ok miod@@
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.6 2002/02/16 21:27:20 millert Exp $	*/
d46 1
d48 1
a48 1
static const void (*__CTOR_LIST__[1])(void)
d50 1
a50 1
static const void (*__DTOR_LIST__[1])(void)
d60 1
a60 1
	void const (**p)(void);
d75 1
a75 1
	void const (**p)(void) = __CTOR_LIST__ + 1;
@


1.6
log
@Part one of userland __P removal.  Done with a simple regexp with some minor hand editing to make comments line up correctly.  Another pass is forthcoming that handles the cases that could not be done automatically.
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.5 2001/02/03 23:11:23 art Exp $	*/
d44 1
d47 1
a47 1
static void (*__CTOR_LIST__[1])(void)
d49 1
a49 1
static void (*__DTOR_LIST__[1])(void)
d59 1
a59 1
	void (**p)(void);
d74 1
a74 1
	void (**p)(void) = __CTOR_LIST__ + 1;
d80 12
a91 2
void __init(void) __attribute__((section(".init")));
void __fini(void) __attribute__((section(".fini")));
d94 1
a94 1
__init()
d104 3
a106 1
		__ctors();
a107 2

	atexit(__fini);
d111 1
a111 1
__fini()
d116 1
a116 1
	__dtors();
@


1.5
log
@oops.
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.4 2001/02/03 23:08:41 art Exp $	*/
d46 1
a46 1
static void (*__CTOR_LIST__[1]) __P((void))
d48 1
a48 1
static void (*__DTOR_LIST__[1]) __P((void))
d51 2
a52 2
static void	__dtors __P((void));
static void	__ctors __P((void));
@


1.4
log
@Schedule running of __fini in __init, not __start.
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.3 2001/02/03 22:59:13 art Exp $	*/
d79 2
a80 1
extern void __init(void) __attribute__((section(".init")));
a97 2

extern void __fini(void) __attribute__((section(".fini")));
@


1.3
log
@Add an OS note identifying OpenBSD binaries.
This appears to be the standard way to do it.
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.2 2001/02/03 22:51:31 art Exp $	*/
d95 1
@


1.2
log
@Decruftification.
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.1 2001/02/03 22:47:00 art Exp $	*/
d43 2
@


1.1
log
@Create a common_elf directory with crtbegin and crtend that can
be shared between archs.
@
text
@d1 1
a1 1
/*	$OpenBSD: crtbegin.c,v 1.1 1996/11/13 21:28:03 niklas Exp $	*/
a33 6
#ifndef ECOFF_COMPAT

/*
 * XXX EVENTUALLY SHOULD BE MERGED BACK WITH c++rt0.c
 */

a105 1
#endif /* !ECOFF_COMPAT */
@

