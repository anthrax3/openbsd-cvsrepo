head	1.7;
access;
symbols
	OPENBSD_5_4:1.6.0.12
	OPENBSD_5_4_BASE:1.6
	OPENBSD_5_3:1.6.0.10
	OPENBSD_5_3_BASE:1.6
	OPENBSD_5_2:1.6.0.8
	OPENBSD_5_2_BASE:1.6
	OPENBSD_5_1_BASE:1.6
	OPENBSD_5_1:1.6.0.6
	OPENBSD_5_0:1.6.0.4
	OPENBSD_5_0_BASE:1.6
	OPENBSD_4_9:1.6.0.2
	OPENBSD_4_9_BASE:1.6
	OPENBSD_4_8:1.5.0.4
	OPENBSD_4_8_BASE:1.5
	OPENBSD_4_7:1.5.0.2
	OPENBSD_4_7_BASE:1.5
	OPENBSD_4_6:1.4.0.20
	OPENBSD_4_6_BASE:1.4
	OPENBSD_4_5:1.4.0.16
	OPENBSD_4_5_BASE:1.4
	OPENBSD_4_4:1.4.0.14
	OPENBSD_4_4_BASE:1.4
	OPENBSD_4_3:1.4.0.12
	OPENBSD_4_3_BASE:1.4
	OPENBSD_4_2:1.4.0.10
	OPENBSD_4_2_BASE:1.4
	OPENBSD_4_1:1.4.0.8
	OPENBSD_4_1_BASE:1.4
	OPENBSD_4_0:1.4.0.6
	OPENBSD_4_0_BASE:1.4
	OPENBSD_3_9:1.4.0.4
	OPENBSD_3_9_BASE:1.4
	OPENBSD_3_8:1.4.0.2
	OPENBSD_3_8_BASE:1.4
	OPENBSD_3_7:1.3.0.4
	OPENBSD_3_7_BASE:1.3
	OPENBSD_3_6:1.3.0.2
	OPENBSD_3_6_BASE:1.3;
locks; strict;
comment	@ * @;


1.7
date	2013.12.03.06.21.41;	author guenther;	state dead;
branches;
next	1.6;

1.6
date	2010.09.12.12.13.51;	author kettenis;	state Exp;
branches;
next	1.5;

1.5
date	2009.12.10.05.46.29;	author miod;	state Exp;
branches;
next	1.4;

1.4
date	2005.08.04.16.33.05;	author espie;	state Exp;
branches;
next	1.3;

1.3
date	2004.09.09.17.45.26;	author pefo;	state Exp;
branches;
next	1.2;

1.2
date	2004.08.23.18.58.37;	author pvalchev;	state Exp;
branches;
next	1.1;

1.1
date	2004.08.06.22.21.16;	author pefo;	state Exp;
branches;
next	;


desc
@@


1.7
log
@Merge the per-arch crt0.c files into common_elf/crt0.c, with MD macros in
the md_init.h files.

Worked out with and ok miod@@; ok matthew@@
@
text
@/*	$OpenBSD: crt0.c,v 1.6 2010/09/12 12:13:51 kettenis Exp $	*/
/*	$NetBSD: crt0.c,v 1.7 1995/06/03 13:16:15 pk Exp $	*/
/*
 * Copyright (c) 1993 Paul Kranenburg
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *      This product includes software developed by Paul Kranenburg.
 * 4. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 */

#include <sys/param.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

extern void	__init __P((void));
extern void     _mcleanup __P((void));
extern unsigned char    eprol asm ("eprol");
extern unsigned char    etext;

char			**environ;
static char		empty[1];
char			*__progname = empty;
void     __perf_init __P((void));

static inline int
_perfcall(int func, void *arg)
{
  int status = 0;
#if 0
  __asm__ volatile (	"move   $4, %1\n\t"
			"move   $5, %2\n\t"
			"teqi   $0, 0\n\t"
			"move   %0, $2"
			: "=r" (status)
			: "r" (func), "r" (arg)
			: "$2", "$3", "$4", "$5", "$6", "$7", "$8", "$9", "$10",
			  "$11", "$12","$13","$14","$15","$24","$25", "memory");
#endif
  return(status);
}

void
__start()
{
	struct kframe {
		long	kargc;
		char	*kargv[1];	/* size depends on kargc */
		char	kargstr[1];	/* size varies */
		char	kenvstr[1];	/* size varies */
	};

	register struct kframe *kfp;
	register char **argv, *ap;

/*
 *  Do GP register setup. Differs depending on shared lib stuff or not.
 */
#if defined(_NO_ABICALLS)
	asm("	dla	$28,_gp");
	asm("	daddiu	%0,$29,32" : "=r" (kfp));
#else
#if defined(__GNUC__) && __GNUC__ > 3
	asm("	daddiu	%0,$29,64" : "=r" (kfp));
#else
	asm("	daddiu	%0,$29,80" : "=r" (kfp));
#endif
#endif
	/* just above the saved frame pointer
	kfp = (struct kframe *) (&param-1);*/
	argv = &kfp->kargv[0];
	environ = argv + kfp->kargc + 1;

	if (ap = argv[0])
		if ((__progname = strrchr(ap, '/')) == NULL)
			__progname = ap;
		else
			++__progname;

asm("eprol:");

#ifdef MCRT0
	atexit(_mcleanup);
	monstartup((u_long)&eprol, (u_long)&etext);
#endif /*MCRT0*/

	__init();
	__perf_init();

asm ("_callmain:");		/* Defined for the benefit of debuggers */
	exit(main(kfp->kargc, argv, environ));
}

#ifdef MCRT0
asm ("	.text");
asm ("_eprol:");
#endif

/************/
#include <stdio.h>

void     _perf_cleanup __P((void));

#define PCNT_CE                 0x0400  /* Count enable */
#define PCNT_UM                 0x0200  /* Count in User mode */
#define PCNT_KM                 0x0100  /* Count in kernel mode */

#define PCNT_FNC_SELECT         0x0001  /* Select counter source */
#define PCNT_FNC_READ           0x0002  /* Read current value of counter */

struct cname {
	char *name;
	int  cval;
} cn_tab[] = {
	{ "CLOCKS",	0x00 },
	{ "INSTR",	0x01 },
	{ "FPINSTR",	0x02 },
	{ "IINSTR",	0x03 },
	{ "LOAD",	0x04 },
	{ "STORE",	0x05 },
	{ "DUAL",	0x06 },
	{ "BRPREF",	0x07 },
	{ "EXTMISS",	0x08 },
	{ "STALL",	0x09 },
	{ "SECMISS",	0x0a },
	{ "INSMISS",	0x0b },
	{ "DTAMISS",	0x0c },
	{ "DTLBMISS",	0x0d },
	{ "ITLBMISS",	0x0e },
	{ "JTLBIMISS",	0x0f },
	{ "JTLBDMISS",	0x10 },
	{ "BRTAKEN",	0x11 },
	{ "BRISSUED",	0x12 },
	{ "SECWBACK",	0x13 },
	{ "PRIWBACK",	0x14 },
	{ "DCSTALL",	0x15 },
	{ "MISS",	0x16 },
	{ "FPEXC",	0x17 },
	{ "MULSLIP",	0x18 },
	{ "CP0SLIP",	0x19 },
	{ "LDSLIP",	0x1a },
	{ "WBFULL",	0x1b },
	{ "CISTALL",	0x1c },
	{ "MULSTALL",	0x1d },
	{ "ELDSTALL",	0x1e },
};
#define NCNTAB (sizeof(cn_tab) / sizeof(struct cname))

void
__perf_init()
{
	long pselect;
	char *cn;

	if((cn = getenv("__PERF_SELECT")) == NULL) {
		return;
	}
	
	for(pselect = 0; pselect < NCNTAB; pselect++) {
		if(strcmp(cn, cn_tab[pselect].name) == 0) {
			pselect = cn_tab[pselect].cval;
			break;
		}
	}
	if(pselect >= NCNTAB) {
		fprintf(stderr, "!! Invalid __PERF_SELECT !!\n");
		exit(255);
	}
	_perfcall(PCNT_FNC_SELECT, (void *)(PCNT_CE|PCNT_UM|pselect)); /*XXX*/
	atexit(_perf_cleanup);

	if((cn = getenv("__PERF_START")) == NULL) {
		return;
	}
}

void
_perf_cleanup()
{
	quad_t countvalue;

	_perfcall(PCNT_FNC_READ, &countvalue);
	printf("\ncount = %qd.\n", countvalue);
}
@


1.6
log
@Since the stack layout changes from gcc3 to gcc4, change the inline asm to
deal with this.

ok miod@@
@
text
@d1 1
a1 1
/*	$OpenBSD: crt0.c,v 1.5 2009/12/10 05:46:29 miod Exp $	*/
@


1.5
log
@Make sure to use 64 bit instructions in the assembly statements (addi -> daddi)
in the prologue; this gives a chance for binaries loaded with their stack over
2GB virtual, to run. Who's your daddi now?
@
text
@d1 1
a1 1
/*	$OpenBSD: crt0.c,v 1.4 2005/08/04 16:33:05 espie Exp $	*/
d86 3
d90 1
@


1.4
log
@zap rcsid. Okay deraadt@@, krw@@
@
text
@d1 1
a1 1
/*	$OpenBSD: crt0.c,v 1.3 2004/09/09 17:45:26 pefo Exp $	*/
d83 2
a84 2
	asm("	la	$28,_gp");
	asm("	addiu	%0,$29,32" : "=r" (kfp));
d86 1
a86 5
#ifdef __LP64__
	asm("	addiu	%0,$29,80" : "=r" (kfp));
#else
	asm("	addiu	%0,$29,56" : "=r" (kfp));
#endif
@


1.3
log
@Shared libs now works. Changes here for ABI64.
@
text
@d1 1
a1 1
/*	$OpenBSD: crt0.c,v 1.2 2004/08/23 18:58:37 pvalchev Exp $	*/
a32 4

#if defined(LIBC_SCCS) && !defined(lint)
static char rcsid[] = "$OpenBSD: crt0.c,v 1.2 2004/08/23 18:58:37 pvalchev Exp $";
#endif /* LIBC_SCCS and not lint */
@


1.2
log
@kill useless __main() symbol which clashes w/ certain evil software in
the ports tree; ok pefo
@
text
@d1 1
a1 1
/*	$OpenBSD: crt0.c,v 1.1 2004/08/06 22:21:16 pefo Exp $	*/
d35 1
a35 1
static char rcsid[] = "$OpenBSD: crt0.c,v 1.1 2004/08/06 22:21:16 pefo Exp $";
d74 1
a74 1
		int	kargc;
d90 5
a94 1
	asm("	addiu	%0,$29,48" : "=r" (kfp));
@


1.1
log
@csu stuff for sgi et al
@
text
@d1 1
a1 1
/*	$OpenBSD: crt0.c,v 1.5 2001/07/11 03:02:27 pvalchev dead $	*/
d35 1
a35 1
static char rcsid[] = "$OpenBSD: crt0.c,v 1.5 2001/07/11 03:02:27 pvalchev dead $";
a115 2

__main() {}
@

