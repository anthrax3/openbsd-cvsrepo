head	1.22;
access;
symbols
	OPENBSD_5_6:1.21.0.6
	OPENBSD_5_6_BASE:1.21
	OPENBSD_5_5:1.21.0.4
	OPENBSD_5_5_BASE:1.21
	OPENBSD_5_4:1.20.0.8
	OPENBSD_5_4_BASE:1.20
	OPENBSD_5_3:1.20.0.6
	OPENBSD_5_3_BASE:1.20
	OPENBSD_5_2:1.20.0.4
	OPENBSD_5_2_BASE:1.20
	OPENBSD_5_1_BASE:1.20
	OPENBSD_5_1:1.20.0.2
	OPENBSD_5_0:1.19.0.8
	OPENBSD_5_0_BASE:1.19
	OPENBSD_4_9:1.19.0.6
	OPENBSD_4_9_BASE:1.19
	OPENBSD_4_8:1.19.0.4
	OPENBSD_4_8_BASE:1.19
	OPENBSD_4_7:1.19.0.2
	OPENBSD_4_7_BASE:1.19
	OPENBSD_4_6:1.18.0.6
	OPENBSD_4_6_BASE:1.18
	OPENBSD_4_5:1.18.0.2
	OPENBSD_4_5_BASE:1.18
	OPENBSD_4_4:1.16.0.12
	OPENBSD_4_4_BASE:1.16
	OPENBSD_4_3:1.16.0.10
	OPENBSD_4_3_BASE:1.16
	OPENBSD_4_2:1.16.0.8
	OPENBSD_4_2_BASE:1.16
	OPENBSD_4_1:1.16.0.6
	OPENBSD_4_1_BASE:1.16
	OPENBSD_4_0:1.16.0.4
	OPENBSD_4_0_BASE:1.16
	OPENBSD_3_9:1.16.0.2
	OPENBSD_3_9_BASE:1.16
	OPENBSD_3_8:1.15.0.4
	OPENBSD_3_8_BASE:1.15
	OPENBSD_3_7:1.15.0.2
	OPENBSD_3_7_BASE:1.15
	OPENBSD_3_6:1.14.0.4
	OPENBSD_3_6_BASE:1.14
	OPENBSD_3_5:1.14.0.2
	OPENBSD_3_5_BASE:1.14
	OPENBSD_3_4:1.13.0.2
	OPENBSD_3_4_BASE:1.13
	OPENBSD_3_3:1.12.0.8
	OPENBSD_3_3_BASE:1.12
	OPENBSD_3_2:1.12.0.6
	OPENBSD_3_2_BASE:1.12
	OPENBSD_3_1:1.12.0.4
	OPENBSD_3_1_BASE:1.12
	OPENBSD_3_0:1.12.0.2
	OPENBSD_3_0_BASE:1.12
	OPENBSD_2_9:1.11.0.2
	OPENBSD_2_9_BASE:1.11
	OPENBSD_2_8:1.6.0.10
	OPENBSD_2_8_BASE:1.6
	OPENBSD_2_7:1.6.0.8
	OPENBSD_2_7_BASE:1.6
	OPENBSD_2_6:1.6.0.6
	OPENBSD_2_6_BASE:1.6
	OPENBSD_2_5:1.6.0.4
	OPENBSD_2_5_BASE:1.6
	OPENBSD_2_4:1.6.0.2
	OPENBSD_2_4_BASE:1.6
	OPENBSD_2_3:1.5.0.6
	OPENBSD_2_3_BASE:1.5
	OPENBSD_2_2:1.5.0.4
	OPENBSD_2_2_BASE:1.5
	OPENBSD_2_1:1.5.0.2
	OPENBSD_2_1_BASE:1.5
	OPENBSD_2_0:1.3.0.2
	OPENBSD_2_0_BASE:1.3
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@# @;


1.22
date	2014.11.12.02.31.47;	author guenther;	state dead;
branches;
next	1.21;
commitid	yVvDwJtYN2JUuiTV;

1.21
date	2013.12.03.06.21.40;	author guenther;	state Exp;
branches;
next	1.20;

1.20
date	2011.11.08.10.37.09;	author guenther;	state Exp;
branches;
next	1.19;

1.19
date	2009.10.27.23.59.58;	author deraadt;	state Exp;
branches;
next	1.18;

1.18
date	2008.11.11.23.49.46;	author kurt;	state Exp;
branches;
next	1.17;

1.17
date	2008.10.06.14.17.49;	author kurt;	state Exp;
branches;
next	1.16;

1.16
date	2005.09.25.19.59.00;	author kettenis;	state Exp;
branches;
next	1.15;

1.15
date	2004.10.21.19.57.42;	author kettenis;	state Exp;
branches;
next	1.14;

1.14
date	2004.01.08.14.59.15;	author drahn;	state Exp;
branches;
next	1.13;

1.13
date	2003.05.30.19.03.24;	author drahn;	state Exp;
branches;
next	1.12;

1.12
date	2001.05.29.07.34.30;	author deraadt;	state Exp;
branches;
next	1.11;

1.11
date	2001.03.24.18.40.20;	author tholo;	state Exp;
branches;
next	1.10;

1.10
date	2001.02.03.22.48.36;	author art;	state Exp;
branches;
next	1.9;

1.9
date	2001.02.03.03.21.35;	author art;	state Exp;
branches;
next	1.8;

1.8
date	2001.01.31.06.55.17;	author art;	state Exp;
branches;
next	1.7;

1.7
date	2001.01.25.05.37.20;	author art;	state Exp;
branches;
next	1.6;

1.6
date	98.06.01.19.38.04;	author mickey;	state Exp;
branches;
next	1.5;

1.5
date	97.04.27.20.55.59;	author millert;	state Exp;
branches;
next	1.4;

1.4
date	96.11.13.21.23.13;	author niklas;	state Exp;
branches;
next	1.3;

1.3
date	95.12.21.14.54.27;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	95.12.15.01.45.45;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.41.17;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.41.17;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.22
log
@Merge Makefiles, moving the build up a level and putting the CPU-specific
build flags into conditionals in the Makefile, fixing a few inconsistencies
in the process.

\o/ miod@@
@
text
@#	$OpenBSD: Makefile,v 1.21 2013/12/03 06:21:40 guenther Exp $
#	$NetBSD: Makefile,v 1.6 1996/10/18 05:27:38 thorpej Exp $

CFLAGS+=	-DELFSIZE=64
OBJS=		crt0.o gcrt0.o crtbegin.o crtend.o crtbeginS.o crtendS.o
SRCS=		crt0.c crtbegin.c crtbeginS.c crtend.c crtendS.c

ELFDIR=		${.CURDIR}/../common_elf
.PATH:		${ELFDIR}
CFLAGS+=	-I${ELFDIR} -I${.CURDIR}

all: ${OBJS}

crt0.o: crt0.c
	@@echo ${COMPILE.c} -DCRT0 -fPIE ${ELFDIR}/crt0.c -o ${.TARGET}
	@@${COMPILE.c} -DCRT0 -fPIE ${ELFDIR}/crt0.c -o ${.TARGET}.o
	@@${LD} -x -r -o ${.TARGET} ${.TARGET}.o
	@@rm -f ${.TARGET}.o

gcrt0.o: crt0.c
	@@echo ${COMPILE.c} -DMCRT0 ${ELFDIR}/crt0.c -o ${.TARGET}
	@@${COMPILE.c} -DMCRT0 ${ELFDIR}/crt0.c -o ${.TARGET}.o
	@@${LD} -x -r -o ${.TARGET} ${.TARGET}.o
	@@rm -f ${.TARGET}.o

crtbegin.o: crtbegin.c
	@@echo ${COMPILE.c} -fPIE ${ELFDIR}/crtbegin.c -o ${.TARGET}
	@@${COMPILE.c} -fPIE ${ELFDIR}/crtbegin.c -o ${.TARGET}.o
	@@${LD} -x -r -o ${.TARGET} ${.TARGET}.o
	@@rm -f ${.TARGET}.o

crtbeginS.o: crtbeginS.c
	@@echo ${COMPILE.c} ${PICFLAG} ${ELFDIR}/crtbeginS.c -o ${.TARGET}
	@@${COMPILE.c} ${PICFLAG} ${ELFDIR}/crtbeginS.c -o ${.TARGET}.o
	@@${LD} -x -r -o ${.TARGET} ${.TARGET}.o
	@@rm -f ${.TARGET}.o

crtend.o: crtend.c
	@@echo ${COMPILE.c} -fPIE ${ELFDIR}/crtend.c -o ${.TARGET}
	@@${COMPILE.c} -fPIE ${ELFDIR}/crtend.c -o ${.TARGET}.o
	@@${LD} -x -r -o ${.TARGET} ${.TARGET}.o
	@@rm -f ${.TARGET}.o

crtendS.o: crtendS.c
	@@echo ${COMPILE.c} ${PICFLAG} ${ELFDIR}/crtendS.c -o ${.TARGET}
	@@${COMPILE.c} ${PICFLAG} ${ELFDIR}/crtendS.c -o ${.TARGET}.o
	@@${LD} -x -r -o ${.TARGET} ${.TARGET}.o
	@@rm -f ${.TARGET}.o

realinstall:
	${INSTALL} ${INSTALL_COPY} -S -o ${BINOWN} -g ${BINGRP} -m 444 ${OBJS} \
	    ${DESTDIR}/usr/lib

afterdepend:: .depend
	@@(TMP=/tmp/_depend$$$$; \
	    sed -e 's/^\([^\.]*\).o[ ]*:/\1.o g\1.o:/' \
	    < .depend > $$TMP; \
	mv $$TMP .depend)

.include <bsd.prog.mk>
@


1.21
log
@Merge the per-arch crt0.c files into common_elf/crt0.c, with MD macros in
the md_init.h files.

Worked out with and ok miod@@; ok matthew@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.20 2011/11/08 10:37:09 guenther Exp $
@


1.20
log
@Pass install the -S option to avoid a window where the target isn't
executable (by mode or content), which can trip up builds with 'make -j'
(The generic fix is in share/mk/*; some Makefiles have their own INSTALL lines)

ok millert@@ deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.19 2009/10/27 23:59:58 deraadt Exp $
d15 2
a16 2
	@@echo ${COMPILE.c} -DCRT0 -fPIE ${.CURDIR}/crt0.c -o ${.TARGET}
	@@${COMPILE.c} -DCRT0 -fPIE ${.CURDIR}/crt0.c -o ${.TARGET}.o
d21 2
a22 2
	@@echo ${COMPILE.c} -DMCRT0 ${.CURDIR}/crt0.c -o ${.TARGET}
	@@${COMPILE.c} -DMCRT0 ${.CURDIR}/crt0.c -o ${.TARGET}.o
@


1.19
log
@rcsid[] and sccsid[] and copyright[] are essentially unmaintained (and
unmaintainable).  these days, people use source.  these id's do not provide
any benefit, and do hurt the small install media
(the 33,000 line diff is essentially mechanical)
ok with the idea millert, ok dms
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.18 2008/11/11 23:49:46 kurt Exp $
d51 1
a51 1
	${INSTALL} ${INSTALL_COPY} -o ${BINOWN} -g ${BINGRP} -m 444 ${OBJS} \
@


1.18
log
@Compile crt0.o, crtbegin.o and crtend.o with -fpie/-fPIE. This requires
gcc with pie support to be built first.

ok kettenis@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.17 2008/10/06 14:17:49 kurt Exp $
d4 1
a4 1
CFLAGS+=	-DLIBC_SCCS -DELFSIZE=64
@


1.17
log
@The recent change to bsd.own.mk to allow PICFLAG to be overridden made
these previously ignored PICFLAG settings become active. Remove PICFLAG
overrides to restore -fpic/-fPIC modes. In snaps for a week.

okay drahn@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.16 2005/09/25 19:59:00 kettenis Exp $
d15 2
a16 2
	@@echo ${COMPILE.c} -DCRT0 ${.CURDIR}/crt0.c -o ${.TARGET}
	@@${COMPILE.c} -DCRT0 ${.CURDIR}/crt0.c -o ${.TARGET}.o
d27 2
a28 2
	@@echo ${COMPILE.c} ${ELFDIR}/crtbegin.c -o ${.TARGET}
	@@${COMPILE.c} ${ELFDIR}/crtbegin.c -o ${.TARGET}.o
d39 2
a40 2
	@@echo ${COMPILE.c} ${ELFDIR}/crtend.c -o ${.TARGET}
	@@${COMPILE.c} ${ELFDIR}/crtend.c -o ${.TARGET}.o
@


1.16
log
@Revert temporary hack.
ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.15 2004/10/21 19:57:42 kettenis Exp $
a10 2

PICFLAG?=-fpic
@


1.15
log
@Temporary hack to make alpha build again.
ok drahn@@, deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.14 2004/01/08 14:59:15 drahn Exp $
a27 1
# XXX temporary hack until __register_frame_info issue is sorted out.
d29 2
a30 2
	@@echo ${COMPILE.c} ${.CURDIR}/crtbegin.c -o ${.TARGET}
	@@${COMPILE.c} ${.CURDIR}/crtbegin.c -o ${.TARGET}.o
@


1.14
log
@__init/__fini handling on ELF has not been correct. It is supposed to
be a section which code stubs (branches) can be added to initialize/destructor
This adds MD stubs to allow this to operate as expected. should fix wine
and behave according to ELF specs. ok miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.13 2003/05/30 19:03:24 drahn Exp $
d28 1
d30 2
a31 2
	@@echo ${COMPILE.c} ${ELFDIR}/crtbegin.c -o ${.TARGET}
	@@${COMPILE.c} ${ELFDIR}/crtbegin.c -o ${.TARGET}.o
@


1.13
log
@Fix dependancy building for ELF startup code. Changed Makefiles
to build startup code the same on all (ELF) archs. hppa ok mickey@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.12 2001/05/29 07:34:30 deraadt Exp $
d10 1
a10 1
CFLAGS+=	-I${ELFDIR}
@


1.12
log
@fix the alpha after that last diff which was obviously not tested
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.11 2001/03/24 18:40:20 tholo Exp $
d4 1
a4 2
CFLAGS+=	-DLIBC_SCCS -DPIC -DELFSIZE=64

d6 1
d8 3
a10 4
CLEANFILES+=	core a.out

.PATH:		${.CURDIR}/../common_elf
CFLAGS+=	-I${.CURDIR}/../common_elf
d17 2
a18 1
	${COMPILE.c} -DCRT0 ${.ALLSRC} -o ${.TARGET}.o
d23 2
a24 1
	${COMPILE.c} -DMCRT0 ${.ALLSRC} -o ${.TARGET}.o
d29 2
a30 1
	${COMPILE.c} ${.ALLSRC} -o ${.TARGET}.o
d35 2
a36 1
	${COMPILE.c} ${PICFLAG} ${.ALLSRC} -o ${.TARGET}.o
d41 2
a42 1
	${COMPILE.c} ${.ALLSRC} -o ${.TARGET}.o
d47 2
a48 1
	${COMPILE.c} ${PICFLAG} ${.ALLSRC} -o ${.TARGET}.o
d55 6
@


1.11
log
@Use "realinstall" to allow the framework to do other work if needed;
path of least surprise.  Ok millert@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.10 2001/02/03 22:48:36 art Exp $
d32 1
a32 1
crtbeginS.o: crtbegin.c
d42 1
a42 1
crtendS.o: crtend.c
@


1.10
log
@Use crtbegin and crtend from common_elf.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.9 2001/02/03 03:21:35 art Exp $
d47 1
a47 1
install:
@


1.9
log
@Don't define ECOFF_COMPAT. We're ELF.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.8 2001/01/31 06:55:17 art Exp $
a3 2
.include <bsd.own.mk>			# for ELF_TOOLCHAIN definition

a4 1
CFLAGS+=	-I${.CURDIR}/../
d9 3
@


1.8
log
@deconfuse include path. (XXX - this for my future hacks).
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.7 2001/01/25 05:37:20 art Exp $
a7 4

.if !defined(ELF_TOOLCHAIN)
CFLAGS+=	-DECOFF_COMPAT
.endif
@


1.7
log
@This is not how we'll do dynamic libraries on alpha anyway.
Zap dead code.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.6 1998/06/01 19:38:04 mickey Exp $
d7 1
a7 1
CFLAGS+=	-I${.CURDIR}/../../../libexec/elf_rtld/include
@


1.6
log
@consitancize with other archs
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.5 1997/04/27 20:55:59 millert Exp $
d6 1
a6 1
CFLAGS+=	-DLIBC_SCCS -DPIC -DDYNAMIC -DELFSIZE=64
d13 1
a13 1
OBJS=		crt0.o gcrt0.o crtbegin.o crtend.o
d17 2
d36 5
d43 5
@


1.5
log
@COPY -> INSTALL_COPY and STRIP -> INSTALL_STRIP
This fixes namespace problems where STRIP is sometimes used as
the name of the strip(1) to use and other times used as
the flag to send install(1) when stripping (or not).
COPY doesn't have this problem (yet) but was poorly named.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.4 1996/11/13 21:23:13 niklas Exp $
d20 1
a20 2
	@@echo ${CC} ${CFLAGS} -DCRT0 -c ${.ALLSRC} -o ${.TARGET}
	@@${CC} ${CFLAGS} -DCRT0 -c ${.ALLSRC} -o ${.TARGET}.o
d25 1
a25 2
	@@echo ${CC} ${CFLAGS} -DMCRT0 -c ${.ALLSRC} -o ${.TARGET}
	@@${CC} ${CFLAGS} -DMCRT0 -c ${.ALLSRC} -o ${.TARGET}.o
d30 1
a30 2
	@@echo ${CC} ${CFLAGS} -c ${.ALLSRC} -o ${.TARGET}
	@@${CC} ${CFLAGS} -c ${.ALLSRC} -o ${.TARGET}.o
d35 1
a35 2
	@@echo ${CC} ${CFLAGS} -c ${.ALLSRC} -o ${.TARGET}
	@@${CC} ${CFLAGS} -c ${.ALLSRC} -o ${.TARGET}.o
@


1.4
log
@Sync with NetBSD, Add OpenBSD tags.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.6 1996/10/18 05:27:38 thorpej Exp $
d44 1
a44 1
	${INSTALL} ${COPY} -o ${BINOWN} -g ${BINGRP} -m 444 ${OBJS} \
@


1.3
log
@from netbsd; limit the flags that get passed to cpp
@
text
@d1 13
a13 1
#	$NetBSD: Makefile,v 1.3 1995/12/20 12:36:56 cgd Exp $
a14 2
CFLAGS+=	-DLIBC_SCCS
OBJS=		crt0.o gcrt0.o
d19 23
a41 9
crt0.o: crt0.s
	${CPP} -DCRT0 ${CFLAGS:M-[ID]*} ${.ALLSRC} | ${AS} -o $@@
	@@${LD} -x -r ${.TARGET}
	@@mv a.out ${.TARGET}

gcrt0.o: crt0.s
	${CPP} -DMCRT0 ${CFLAGS:M-[ID]*} ${.ALLSRC} | ${AS} -o $@@
	@@${LD} -x -r ${.TARGET}
	@@mv a.out ${.TARGET}
d44 2
a45 4
	install ${COPY} -o ${BINOWN} -g ${BINGRP} -m 444 ${OBJS} \
		${DESTDIR}/usr/lib

depend lint tags:
@


1.2
log
@from netbsd; do not override other CFLAGS settings
@
text
@d1 1
a1 1
#	$NetBSD: Makefile,v 1.2 1995/12/12 01:53:50 cgd Exp $
d10 1
a10 1
	${CPP} -DCRT0 ${CFLAGS} ${.ALLSRC} | ${AS} -o $@@
d15 1
a15 1
	${CPP} -DMCRT0 ${CFLAGS} ${.ALLSRC} | ${AS} -o $@@
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
#	$NetBSD: Makefile,v 1.1 1995/02/10 17:53:00 cgd Exp $
d3 1
a3 1
CFLAGS=		-DLIBC_SCCS
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
