head	1.9;
access;
symbols
	OPENBSD_6_1:1.8.0.8
	OPENBSD_6_1_BASE:1.8
	OPENBSD_6_0:1.8.0.4
	OPENBSD_6_0_BASE:1.8
	OPENBSD_5_9:1.8.0.2
	OPENBSD_5_9_BASE:1.8
	OPENBSD_5_8:1.5.0.4
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.4.0.2
	OPENBSD_5_7_BASE:1.4
	OPENBSD_5_6:1.4.0.6
	OPENBSD_5_6_BASE:1.4
	OPENBSD_5_5:1.4.0.4
	OPENBSD_5_5_BASE:1.4
	OPENBSD_5_4:1.2.0.2
	OPENBSD_5_4_BASE:1.2;
locks; strict;
comment	@ * @;


1.9
date	2017.09.10.18.20.00;	author guenther;	state Exp;
branches;
next	1.8;
commitid	NWv0a8Ic70s94wVI;

1.8
date	2015.12.10.13.03.22;	author tedu;	state Exp;
branches;
next	1.7;
commitid	QB4XkMnUDZtR5zsn;

1.7
date	2015.09.12.15.01.33;	author guenther;	state Exp;
branches;
next	1.6;
commitid	dfMQJx74EsNUV6au;

1.6
date	2015.08.31.02.53.57;	author guenther;	state Exp;
branches;
next	1.5;
commitid	lTMF8Y3C9fQGd6jQ;

1.5
date	2015.05.11.00.42.54;	author guenther;	state Exp;
branches;
next	1.4;
commitid	ERk0TOjsvusMAegY;

1.4
date	2013.11.12.06.09.48;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	2013.10.25.19.42.18;	author tedu;	state Exp;
branches;
next	1.2;

1.2
date	2013.06.02.21.08.19;	author tedu;	state Exp;
branches;
next	1.1;

1.1
date	2013.05.31.18.41.25;	author tedu;	state Exp;
branches;
next	;


desc
@@


1.9
log
@shm_open(), sysconf(), tcflow(), and tcsendbreak() are not permitted to be
cancellation points in POSIX, so change them to invoke the non-cancellation
point versions of open(), close(), nanosleep(), and write()

ok deraadt@@ millert@@
@
text
@/* $OpenBSD: shm_open.c,v 1.8 2015/12/10 13:03:22 tedu Exp $ */
/*
 * Copyright (c) 2013 Ted Unangst <tedu@@openbsd.org>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */
#include <sys/types.h>
#include <sys/mman.h>
#include <sys/stat.h>

#include <errno.h>
#include <fcntl.h>
#include <limits.h>
#include <sha2.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

/* SHA256_DIGEST_STRING_LENGTH includes nul */
/* "/tmp/" + sha256 + ".shm" */
#define SHM_PATH_SIZE (5 + SHA256_DIGEST_STRING_LENGTH + 4)

/* O_CLOEXEC and O_NOFOLLOW are extensions to POSIX */
#define OK_FLAGS	(O_CREAT | O_EXCL | O_TRUNC | O_CLOEXEC | O_NOFOLLOW)

static void
makeshmpath(const char *origpath, char *shmpath, size_t len)
{
	char buf[SHA256_DIGEST_STRING_LENGTH];

	SHA256Data(origpath, strlen(origpath), buf);
	snprintf(shmpath, len, "/tmp/%s.shm", buf);
}

int
shm_open(const char *path, int flags, mode_t mode)
{
	char shmpath[SHM_PATH_SIZE];
	struct stat sb;
	int fd;

	if (((flags & O_ACCMODE) != O_RDONLY && (flags & O_ACCMODE) != O_RDWR)
	    || (flags & ~(O_ACCMODE | OK_FLAGS))) {
		errno = EINVAL;
		return -1;
	}

	flags |= O_CLOEXEC | O_NOFOLLOW;
	mode = mode & 0600;

	makeshmpath(path, shmpath, sizeof(shmpath));

	fd = HIDDEN(open)(shmpath, flags, mode);
	if (fd == -1)
		return -1;
	if (fstat(fd, &sb) == -1 || !S_ISREG(sb.st_mode)) {
		HIDDEN(close)(fd);
		errno = EINVAL;
		return -1;
	}
	if (sb.st_uid != geteuid()) {
		HIDDEN(close)(fd);
		errno = EPERM;
		return -1;
	}
	return fd;
}
DEF_WEAK(shm_open);

int
shm_unlink(const char *path)
{
	char shmpath[SHM_PATH_SIZE];

	makeshmpath(path, shmpath, sizeof(shmpath));
	return unlink(shmpath);
}

int
shm_mkstemp(char *template)
{
	size_t templatelen;
	char *t;
	int i, fd;

	templatelen = strlen(template);
	t = malloc(templatelen + 1);
	if (!t)
		return -1;
	t[templatelen] = '\0';

	fd = -1;
	for (i = 0; i < INT_MAX; i++) {
		memcpy(t, template, templatelen);
		if (!_mktemp(t))
			break;
		fd = shm_open(t, O_RDWR | O_EXCL | O_CREAT, 0600);
		if (fd != -1) {
			memcpy(template, t, templatelen);
			break;
		}
	}

	free(t);
	return fd;
}

@


1.8
log
@use geteuid to make it easier for root to communicate.
reported by Jeunder Yu
@
text
@d1 1
a1 1
/* $OpenBSD: shm_open.c,v 1.7 2015/09/12 15:01:33 guenther Exp $ */
d64 1
a64 1
	fd = open(shmpath, flags, mode);
d68 1
a68 1
		close(fd);
d73 1
a73 1
		close(fd);
@


1.7
log
@Wrap shm_open() to go direct and mark shm_{mkstemp,unlink}() as weak
@
text
@d1 1
a1 1
/* $OpenBSD: shm_open.c,v 1.6 2015/08/31 02:53:57 guenther Exp $ */
d72 1
a72 1
	if (sb.st_uid != getuid()) {
@


1.6
log
@Add framework for resolving (pun intended) libc namespace issues, using
wrapper .h files and asm labels to let internal calls resolve directly and
not be overridable or use the PLT.  Then, apply that framework to most of
the functions in stdio.h, string.h, err.h, and wchar.h.  Delete the
should-have-been-hidden-all-along _v?(err|warn)[cx]? symbols while here.

tests clean on i386, amd64, sparc64, powerpc, and mips64

naming feedback from kettenis@@ and millert@@
ok kettenis@@
@
text
@d1 1
a1 1
/* $OpenBSD: shm_open.c,v 1.5 2015/05/11 00:42:54 guenther Exp $ */
d79 1
@


1.5
log
@When checking flags that will be passed to open(), test the O_ACCMODE portion
separately to avoid false negatives.

ok miod@@ millert@@
@
text
@d1 1
a1 1
/* $OpenBSD: shm_open.c,v 1.4 2013/11/12 06:09:48 deraadt Exp $ */
a87 2

char *_mktemp(char *);
@


1.4
log
@pull in missing includes (math.h, unistd.h, stdlib.h) needed for
prototypes
@
text
@d1 1
a1 1
/* $OpenBSD: shm_open.c,v 1.3 2013/10/25 19:42:18 tedu Exp $ */
d34 3
d53 2
a54 2
	if (flags & ~(O_RDONLY | O_RDWR |
	    O_CREAT | O_EXCL | O_TRUNC | O_CLOEXEC | O_NOFOLLOW)) {
@


1.3
log
@close(fd), then set errno
@
text
@d1 1
a1 1
/* $OpenBSD: shm_open.c,v 1.2 2013/06/02 21:08:19 tedu Exp $ */
d28 1
@


1.2
log
@fix id, from brad
@
text
@d1 1
a1 1
/* $OpenBSD$ */
d64 1
a65 1
		close(fd);
d69 1
a70 1
		close(fd);
@


1.1
log
@add shm_open and friends which i have been told ports programs would
like to use.
ok deraadt guenther
@
text
@d1 1
a1 1
/* $OpenBSD */
@

