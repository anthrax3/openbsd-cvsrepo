head	1.1;
access;
symbols
	OPENBSD_6_2:1.1.0.4
	OPENBSD_6_2_BASE:1.1;
locks; strict;
comment	@# @;


1.1
date	2017.08.15.06.13.24;	author guenther;	state Exp;
branches;
next	;
commitid	2ly112pNJTEbf5qJ;


desc
@@


1.1
log
@Copy files from ../librthread in preparation for moving functionality
from libpthread to libc.  No changes to the build yet, just making it
easier to review the substantive diffs.

ok beck@@ kettenis@@ tedu@@
@
text
@/*	$OpenBSD: _atomic_lock.S,v 1.3 2013/06/04 17:55:51 miod Exp $	*/
/* David Leonard, <d@@csee.uq.edu.au>. Public domain. */

#include <machine/asm.h>

LEAF(_atomic_lock,1)
        LDGP(pv)

				/* NOTE: using ldl_l/stl_c instead of
				   ldq_l and stq_c as machine/spinlock.h
				   defines _atomic_lock_t as int */
0:      ldl_l   v0, 0(a0)       /* read existing lock value */
        mov     1, t0           /* locked value to store */
        stl_c   t0, 0(a0)       /* attempt to store, status in t0 */
        beq     t0, 1f          /* branch forward to optimise prediction */
        mb                      /* sync with other processors */
        RET                     /* return with v0==0 if lock obtained */
1:      br      0b              /* loop to try again */
END(_atomic_lock)
@
