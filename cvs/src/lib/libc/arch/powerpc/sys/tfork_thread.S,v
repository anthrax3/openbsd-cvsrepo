head	1.7;
access;
symbols
	OPENBSD_6_2:1.7.0.8
	OPENBSD_6_2_BASE:1.7
	OPENBSD_6_1:1.7.0.6
	OPENBSD_6_1_BASE:1.7
	OPENBSD_6_0:1.7.0.2
	OPENBSD_6_0_BASE:1.7
	OPENBSD_5_9:1.5.0.2
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.2.0.16
	OPENBSD_5_8_BASE:1.2
	OPENBSD_5_7:1.2.0.8
	OPENBSD_5_7_BASE:1.2
	OPENBSD_5_6:1.2.0.12
	OPENBSD_5_6_BASE:1.2
	OPENBSD_5_5:1.2.0.10
	OPENBSD_5_5_BASE:1.2
	OPENBSD_5_4:1.2.0.6
	OPENBSD_5_4_BASE:1.2
	OPENBSD_5_3:1.2.0.4
	OPENBSD_5_3_BASE:1.2
	OPENBSD_5_2:1.2.0.2
	OPENBSD_5_2_BASE:1.2;
locks; strict;
comment	@# @;


1.7
date	2016.05.15.00.15.10;	author guenther;	state Exp;
branches;
next	1.6;
commitid	q5ZHgo4XiUrTIUH8;

1.6
date	2016.05.07.19.05.22;	author guenther;	state Exp;
branches;
next	1.5;
commitid	d9R7VGw9CHTkwXE1;

1.5
date	2015.09.05.06.22.47;	author guenther;	state Exp;
branches;
next	1.4;
commitid	YcHx4KWjuOzN6Vj2;

1.4
date	2015.08.27.07.24.17;	author guenther;	state Exp;
branches;
next	1.3;
commitid	Cvr3ukdxCqajIo9q;

1.3
date	2015.08.23.15.51.28;	author kettenis;	state Exp;
branches;
next	1.2;
commitid	SYSxZ1Y24CowNLv4;

1.2
date	2012.06.21.00.56.59;	author guenther;	state Exp;
branches;
next	1.1;

1.1
date	2012.03.22.00.44.56;	author guenther;	state Exp;
branches;
next	;


desc
@@


1.7
log
@TIB conversion is complete, so set errno in the syscall stub and eliminate
__cerror

ok ketternis@@
@
text
@/*	$OpenBSD: tfork_thread.S,v 1.6 2016/05/07 19:05:22 guenther Exp $	*/

/*
 * Copyright (c) 2005 Tim Wiess <tim@@nop.cx>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#include "SYS.h"

ENTRY(__tfork_thread)
	/* call __tfork */
	li	%r0, SYS___tfork
	sc
	cmpwi	%r0, 0
	bne	1f
	
	/* check if we are parent or child */
	cmpwi	%r3, 0
	bnelr
	
	/* child */
	mtlr	%r5		/* fp */
	mr	%r3, %r6	/* arg */
	subi	%r1, %r1, 16	/* fixup sp to get headroom */
	blrl
	
	/* child returned, call __threxit */
	li	%r0, SYS___threxit
	sc
1:
	stw	0, R2_OFFSET_ERRNO(%r2)
	li	%r3, -1
	blr
END(__tfork_thread)
@


1.6
log
@Use a Thread Information Block in both single and multi-threaded programs.
This stores errno, the cancelation flags, and related bits for each thread
and is allocated by ld.so or libc.a.  This is an ABI break from 5.9-stable!

Make libpthread dlopen'able by moving the cancelation wrappers into libc
and doing locking and fork/errno handling via callbacks that libpthread
registers when it first initializes.  'errno' *must* be declared via
<errno.h> now!

Clean up libpthread's symbol exports like libc.

On powerpc, offset the TIB/TCB/TLS data from the register per the ELF spec.

Testing by various, particularly sthen@@ and patrick@@
ok kettenis@@
@
text
@d1 1
a1 1
/*	$OpenBSD: tfork_thread.S,v 1.5 2015/09/05 06:22:47 guenther Exp $	*/
d19 1
a19 2
#include <sys/syscall.h>
#include <machine/asm.h>
a21 4
	/* sanity check */
	cmpwi	%r5, 0
	beq	1f
	
d26 1
a26 1
	bne	2f
d42 1
d44 1
a44 2
2:
	b	_C_LABEL(__cerror)
@


1.5
log
@Adds hidden _libc_FOO aliases for the system call stubs.
Stop generating _brk and _sbrk symbols: they've already been hidden.
Set the ELF symbol size on the syscall stubs.
Give the __{min,cur}brk symbols a size and type, and hide more jump labels.

ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: tfork_thread.S,v 1.4 2015/08/27 07:24:17 guenther Exp $	*/
d49 1
a49 1
	b	_C_LABEL(___cerror)
@


1.4
log
@fix comment
@
text
@d1 1
a1 1
/*	$OpenBSD: tfork_thread.S,v 1.3 2015/08/23 15:51:28 kettenis Exp $	*/
d50 1
@


1.3
log
@Make __cerror() use the per-thread errno location if r2 isn't zero.  This way
libpthread no longer has to override it which means that we can use a local
call and can avoid setting up r30 as a _GLOBAL_OFFSET_TABLE_ pointer, which
is hard the way the powerpc ABI works.

For now we continue to provide __cerror as a weak symbol, but ___cerror is
now protected and internal calls within libc now use ___cerror instead of
__cerror.

discussed with guenther@@
@
text
@d1 1
a1 1
/*	$OpenBSD: tfork_thread.S,v 1.2 2012/06/21 00:56:59 guenther Exp $	*/
d43 1
a43 1
	/* child returned, call _exit */
@


1.2
log
@__tfork() needs to set the stack address of the new thread in the kernel,
so that it can't get a signal while still running on the parent thread's
stack.  Also, pass in sizeof(struct __tfork) to provide forward compat
when more members are added.  This is an ABI change, so switch syscall
numbers and bump lib majors this time.

ok deraadt@@ matthew@@
@
text
@d1 1
a1 1
/*	$OpenBSD: tfork_thread.S,v 1.1 2012/03/22 00:44:56 guenther Exp $	*/
d49 1
a49 1
	b PIC_PLT(_C_LABEL(__cerror))
@


1.1
log
@Move __tfork_thread() from rthreads (libpthread) to libc so that
it can be used for not-strictly-threading purposes

ok matthew@@ kurt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: rfork_thread.S,v 1.5 2012/01/17 02:34:18 guenther Exp $	*/
a23 2
	cmpwi	%r4, 0
	beq	1f
a26 2
	mr	%r7,%r4
	
d40 1
a40 1
	subi	%r1, %r7, 16	/* fixup sp to get headroom */
@

