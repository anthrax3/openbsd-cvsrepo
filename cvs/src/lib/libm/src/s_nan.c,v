head	1.14;
access;
symbols
	OPENBSD_6_1:1.14.0.4
	OPENBSD_6_1_BASE:1.14
	OPENBSD_6_0:1.13.0.10
	OPENBSD_6_0_BASE:1.13
	OPENBSD_5_9:1.13.0.6
	OPENBSD_5_9_BASE:1.13
	OPENBSD_5_8:1.13.0.8
	OPENBSD_5_8_BASE:1.13
	OPENBSD_5_7:1.13.0.2
	OPENBSD_5_7_BASE:1.13
	OPENBSD_5_6:1.13.0.4
	OPENBSD_5_6_BASE:1.13
	OPENBSD_5_5:1.12.0.4
	OPENBSD_5_5_BASE:1.12
	OPENBSD_5_4:1.11.0.2
	OPENBSD_5_4_BASE:1.11
	OPENBSD_5_3:1.9.0.2
	OPENBSD_5_3_BASE:1.9
	OPENBSD_5_2:1.7.0.6
	OPENBSD_5_2_BASE:1.7
	OPENBSD_5_1_BASE:1.7
	OPENBSD_5_1:1.7.0.4
	OPENBSD_5_0:1.7.0.2
	OPENBSD_5_0_BASE:1.7
	OPENBSD_4_9:1.6.0.10
	OPENBSD_4_9_BASE:1.6
	OPENBSD_4_8:1.6.0.8
	OPENBSD_4_8_BASE:1.6
	OPENBSD_4_7:1.6.0.4
	OPENBSD_4_7_BASE:1.6
	OPENBSD_4_6:1.6.0.6
	OPENBSD_4_6_BASE:1.6
	OPENBSD_4_5:1.6.0.2
	OPENBSD_4_5_BASE:1.6
	OPENBSD_4_4:1.1.0.2
	OPENBSD_4_4_BASE:1.1;
locks; strict;
comment	@ * @;


1.14
date	2016.09.12.19.47.02;	author guenther;	state Exp;
branches;
next	1.13;
commitid	Lp8bnB2xK76nGFvJ;

1.13
date	2014.07.21.01.51.11;	author guenther;	state Exp;
branches;
next	1.12;
commitid	ro8JUTvBpvQMiFY9;

1.12
date	2013.11.22.18.27.25;	author deraadt;	state Exp;
branches;
next	1.11;

1.11
date	2013.07.03.04.46.36;	author espie;	state Exp;
branches;
next	1.10;

1.10
date	2013.03.28.18.09.38;	author martynas;	state Exp;
branches;
next	1.9;

1.9
date	2013.01.13.03.45.00;	author martynas;	state Exp;
branches;
next	1.8;

1.8
date	2012.12.05.23.20.04;	author deraadt;	state Exp;
branches;
next	1.7;

1.7
date	2011.05.30.18.34.38;	author martynas;	state Exp;
branches;
next	1.6;

1.6
date	2008.12.10.01.08.25;	author martynas;	state Exp;
branches;
next	1.5;

1.5
date	2008.12.09.20.00.35;	author martynas;	state Exp;
branches;
next	1.4;

1.4
date	2008.09.07.20.36.09;	author martynas;	state Exp;
branches;
next	1.3;

1.3
date	2008.08.08.00.41.17;	author martynas;	state Exp;
branches;
next	1.2;

1.2
date	2008.08.08.00.32.47;	author martynas;	state Exp;
branches;
next	1.1;

1.1
date	2008.07.24.09.40.16;	author martynas;	state Exp;
branches;
next	;


desc
@@


1.14
log
@Reduce libm's exports and make internal calls go direct.
All dependencies on libc are now via reserved/standardized names.

ok kettenis@@ millert@@ deraadt@@
@
text
@/*	$OpenBSD: s_nan.c,v 1.13 2014/07/21 01:51:11 guenther Exp $	*/
/*-
 * Copyright (c) 2007 David Schultz
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 * $FreeBSD: src/lib/msun/src/s_nan.c,v 1.2 2007/12/18 23:46:32 das Exp $
 */

#include <sys/types.h>
#include <ctype.h>
#include <endian.h>
#include <float.h>
#include <math.h>
#include <stdint.h>
#include <strings.h>

#include "math_private.h"

/*
 * OpenBSD's ctype doesn't have digittoint, so we define it here.
 */
static int
_digittoint(int c)
{
	if (!isxdigit(c))
		return 0;

	if (isdigit(c))
		return c - '0';
	else
		return isupper(c) ? c - 'A' + 10 : c - 'a' + 10;
}

/*
 * Scan a string of hexadecimal digits (the format nan(3) expects) and
 * make a bit array (using the local endianness). We stop when we
 * encounter an invalid character, NUL, etc.  If we overflow, we do
 * the same as gcc's __builtin_nan(), namely, discard the high order bits.
 *
 * The format this routine accepts needs to be compatible with what is used
 * in contrib/gdtoa/hexnan.c (for strtod/scanf) and what is used in
 * __builtin_nan(). In fact, we're only 100% compatible for strings we
 * consider valid, so we might be violating the C standard. But it's
 * impossible to use nan(3) portably anyway, so this seems good enough.
 */
void
_scan_nan(uint32_t *words, int num_words, const char *s)
{
	int si;		/* index into s */
	int bitpos;	/* index into words (in bits) */

	bzero(words, num_words * sizeof(uint32_t));

	/* Allow a leading '0x'. (It's expected, but redundant.) */
	if (s[0] == '0' && (s[1] == 'x' || s[1] == 'X'))
		s += 2;

	/* Scan forwards in the string, looking for the end of the sequence. */
	for (si = 0; isxdigit((unsigned char)s[si]); si++)
		;

	/* Scan backwards, filling in the bits in words[] as we go. */
#if BYTE_ORDER == LITTLE_ENDIAN
	for (bitpos = 0; bitpos < 32 * num_words; bitpos += 4) {
#else
	for (bitpos = 32 * num_words - 4; bitpos >= 0; bitpos -= 4) {
#endif
		if (--si < 0)
			break;
		words[bitpos / 32] |= _digittoint((unsigned char)s[si]) << (bitpos % 32);
	}
}

double
nan(const char *s)
{
	union {
		double d;
		uint32_t bits[2];
	} u;

	_scan_nan(u.bits, 2, s);
#if BYTE_ORDER == LITTLE_ENDIAN
	u.bits[1] |= 0x7ff80000;
#else
	u.bits[0] |= 0x7ff80000;
#endif
	return (u.d);
}
DEF_STD(nan);
LDBL_MAYBE_UNUSED_CLONE(nan);

float
nanf(const char *s)
{
	union {
		float f;
		uint32_t bits[1];
	} u;

	_scan_nan(u.bits, 1, s);
	u.bits[0] |= 0x7fc00000;
	return (u.f);
}
@


1.13
log
@Switch from <sys/endian.h> or <machine/endian.h> to the new,
being-standardized <endian.h>

ok deraadt@@ millert@@ beck@@
@
text
@d1 1
a1 1
/*	$OpenBSD: s_nan.c,v 1.12 2013/11/22 18:27:25 deraadt Exp $	*/
d111 2
a125 4

#if	LDBL_MANT_DIG == DBL_MANT_DIG
__strong_alias(nanl, nan);
#endif	/* LDBL_MANT_DIG == DBL_MANT_DIG */
@


1.12
log
@unsigned char casts for ctype macros
ok martynas
@
text
@d1 1
a1 1
/*	$OpenBSD: s_nan.c,v 1.11 2013/07/03 04:46:36 espie Exp $	*/
a30 1
#include <sys/endian.h>
d32 1
d84 1
a84 1
#if _BYTE_ORDER == _LITTLE_ENDIAN
d104 1
a104 1
#if _BYTE_ORDER == _LITTLE_ENDIAN
@


1.11
log
@test LDBL_MANT_DIG == DBL_MANT_DIG instead of hardcoding 53.
-> test becomes meaningful on vax
No actual change, no bump
okay martynas@@
@
text
@d1 1
a1 1
/*	$OpenBSD: s_nan.c,v 1.10 2013/03/28 18:09:38 martynas Exp $	*/
d80 1
a80 1
	for (si = 0; isxdigit(s[si]); si++)
d91 1
a91 1
		words[bitpos / 32] |= _digittoint(s[si]) << (bitpos % 32);
@


1.10
log
@Switch libc and libm to use strong aliases rather than weak aliases
where appropriate.  Among other things makes the symbols consistent
across all architectures (notably where ldbl mantissa is 53 bits).

While at it, kill unused LINTLIBRARY/PROTOLIB1 cruft which was there
to trick lint into recording the right prototypes for aliased
functions.  Most of the work done at the awesome n2k13 hackathon.

Agreed by kettenis@@, guenther@@, matthew@@.
@
text
@d1 1
a1 1
/*	$OpenBSD: s_nan.c,v 1.9 2013/01/13 03:45:00 martynas Exp $	*/
d125 1
a125 1
#if	LDBL_MANT_DIG == 53
d127 1
a127 1
#endif	/* LDBL_MANT_DIG == 53 */
@


1.9
log
@Get rid of the very ugly lint workarounds: LINTLIBRARY, PROTOLIB,
and a few empty files for lint to chew on.
@
text
@d1 1
a1 1
/*	$OpenBSD: s_nan.c,v 1.8 2012/12/05 23:20:04 deraadt Exp $	*/
d126 1
a126 1
__weak_alias(nanl, nan);
@


1.8
log
@Remove excessive sys/cdefs.h inclusion
ok guenther millert kettenis
@
text
@d1 1
a1 1
/*	$OpenBSD: s_nan.c,v 1.7 2011/05/30 18:34:38 martynas Exp $	*/
a29 2
/* LINTLIBRARY */

a125 4
#ifdef	lint
/* PROTOLIB1 */
long double nanl(const char *);
#else	/* lint */
a126 1
#endif	/* lint */
@


1.7
log
@Trick lint into recording the right prototypes in the llib-lm.ln
database on platforms without extended-precision floating-point
support.

Seems like a reasonable approach to millert@@.
@
text
@d1 1
a1 1
/*	$OpenBSD: s_nan.c,v 1.6 2008/12/10 01:08:25 martynas Exp $	*/
a31 1
#include <sys/cdefs.h>
@


1.6
log
@use sys/cdefs.h;  pointed out by theo
@
text
@d1 1
a1 1
/*	$OpenBSD: s_nan.c,v 1.5 2008/12/09 20:00:35 martynas Exp $	*/
d30 2
d128 5
a132 2
#if LDBL_MANT_DIG == 53
#ifdef __weak_alias
d134 2
a135 2
#endif /* __weak_alias */
#endif /* LDBL_MANT_DIG == 53 */
@


1.5
log
@- 80-bit and quad precision trigonometric and other most
important functions: acosl, asinl, atanl, atan2l, cosl,
sinl, tanl, exp2l, frexpl, ilogbl, ldexpl, logbl, scalbnl,
fabsl, hypotl, powl, sqrtl, rintl, copysignl, nanl, fdiml,
fmaxl, fminl.  mostly taken from freebsd, needed alot of
changes to adapt.  note, these are all c versions;  and are
quite slow when architectures have, e.g. sqrt.  assembly
versions will be added afterwards
- make them .weak/__weak_alias to the double precision
versions on other archs
- no need to have two finites.  finite() and finitef() are
non-standard 3BSD obsolete versions of isfinite.  remove
from libm.  make them weak_alias in libc to __isfinite and
__isfinitef instead.  similarly make 3BSD obsolete versions
of isinf, isinff, isnan, isnanf weak_aliases to C99's
__isinf, __isinff, __isnan, __isnanf
- remove unused infinity.c.  the c library has infinities
for each supported platform
- use STRICT_ASSIGN cast hack for _kernel_rem_pio2, so that
the double version has a chance of working on i386 with
extra precision
- avoid storing multiple copies of the pi/2 array, since
it won't vary
- bump major due to removed finite/finitef.  although they
will be in libc, which anything is linked to, minor bump
might be enough
ok millert@@.   tested by sthen@@, jsg@@, ajacoutot@@, kili@@, naddy@@
@
text
@d1 1
a1 1
/*	$OpenBSD: s_nan.c,v 1.4 2008/09/07 20:36:09 martynas Exp $	*/
d30 1
a30 1
#include <machine/cdefs.h>
@


1.4
log
@- replace dtoa w/ David's gdtoa, version 2008-03-15
- provide proper dtoa locks
- use the real strtof implementation
- add strtold, __hdtoa, __hldtoa
- add %a/%A support
- don't lose precision in printf, don't round to double anymore
- implement extended-precision versions of libc functions: fpclassify,
isnan, isinf, signbit, isnormal, isfinite, now that the ieee.h is
fixed
- separate vax versions of strtof, and __hdtoa
- add complex math support.  added functions: cacos, casin, catan,
ccos, csin, ctan, cacosh, casinh, catanh, ccosh, csinh, ctanh, cexp,
clog, cabs, cpow, csqrt, carg, cimag, conj, cproj, creal, cacosf,
casinf, catanf, ccosf, csinf, ctanf, cacoshf, casinhf, catanhf,
ccoshf, csinhf, ctanhf, cexpf, clogf, cabsf, cpowf, csqrtf, cargf,
cimagf, conjf, cprojf, crealf
- add fdim, fmax, fmin
- add log2. (adapted implementation e_log.c.  could be more acruate
& faster, but it's good enough for now)
- remove wrappers & cruft in libm, supposed to work-around mistakes
in SVID, etc.;  use ieee versions.  fixes issues in python 2.6 for
djm@@
- make _digittoint static
- proper definitions for i386, and amd64 in ieee.h
- sh, powerpc don't really have extended-precision
- add missing definitions for mips64 (quad), m{6,8}k (96-bit) float.h
for LDBL_*
- merge lead to frac for m{6,8}k, for gdtoa to work properly
- add FRAC*BITS & EXT_TO_ARRAY32 definitions in ieee.h, for hdtoa&ldtoa
to use
- add EXT_IMPLICIT_NBIT definition, which indicates implicit
normalization bit
- add regression tests for libc: fpclassify and printf
- arith.h & gd_qnan.h definitions
- update ieee.h: hppa doesn't have quad-precision, hppa64 does
- add missing prototypes to gdtoaimp
- on 64-bit platforms make sure gdtoa doesn't use a long when it
really wants an int
- etc., what i may have forgotten...
- bump libm major, due to removed&changed symbols
- no libc bump, since this is riding on djm's libc major crank from
a day ago

discussed with / requested by / testing theo, sthen@@, djm@@, jsg@@,
merdely@@, jsing@@, tedu@@, brad@@, jakemsr@@, and others.
looks good to millert@@
parts of the diff ok kettenis@@

this commit does not include:
- man page changes
@
text
@d1 1
a1 1
/*	$OpenBSD: s_nan.c,v 1.3 2008/08/08 00:41:17 martynas Exp $	*/
d30 1
d125 6
@


1.3
log
@revert
@
text
@d1 1
a1 1
/*	$OpenBSD: s_nan.c,v 1.2 2008/08/08 00:32:47 martynas Exp $	*/
d43 1
a43 1
int
@


1.2
log
@make _digittoint static
@
text
@d1 1
a1 1
/*	$OpenBSD: s_nan.c,v 1.1 2008/07/24 09:40:16 martynas Exp $	*/
d43 1
a43 1
static int
@


1.1
log
@- remove isinff, isnanf.  this has been moved to libc
- remove never-enabled signbit.  libc has is now
- add C99 implementations, from freebsd, for nan(), nanf() (needed
to write _digittoint for it), exp2(), exp2f(), remquo(), remquof(),
needed STRICT_ASSIGN macro for math_private.h
- bump major
man pages will follow
exp2{,f} has been requested by chl@@
ok millert@@
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d43 1
a43 1
int
@

