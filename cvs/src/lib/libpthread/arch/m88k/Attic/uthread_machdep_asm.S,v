head	1.3;
access;
symbols
	OPENBSD_5_2:1.2.0.36
	OPENBSD_5_2_BASE:1.2
	OPENBSD_5_1_BASE:1.2
	OPENBSD_5_1:1.2.0.34
	OPENBSD_5_0:1.2.0.32
	OPENBSD_5_0_BASE:1.2
	OPENBSD_4_9:1.2.0.30
	OPENBSD_4_9_BASE:1.2
	OPENBSD_4_8:1.2.0.28
	OPENBSD_4_8_BASE:1.2
	OPENBSD_4_7:1.2.0.24
	OPENBSD_4_7_BASE:1.2
	OPENBSD_4_6:1.2.0.26
	OPENBSD_4_6_BASE:1.2
	OPENBSD_4_5:1.2.0.22
	OPENBSD_4_5_BASE:1.2
	OPENBSD_4_4:1.2.0.20
	OPENBSD_4_4_BASE:1.2
	OPENBSD_4_3:1.2.0.18
	OPENBSD_4_3_BASE:1.2
	OPENBSD_4_2:1.2.0.16
	OPENBSD_4_2_BASE:1.2
	OPENBSD_4_1:1.2.0.14
	OPENBSD_4_1_BASE:1.2
	OPENBSD_4_0:1.2.0.12
	OPENBSD_4_0_BASE:1.2
	OPENBSD_3_9:1.2.0.10
	OPENBSD_3_9_BASE:1.2
	OPENBSD_3_8:1.2.0.8
	OPENBSD_3_8_BASE:1.2
	OPENBSD_3_7:1.2.0.6
	OPENBSD_3_7_BASE:1.2
	OPENBSD_3_6:1.2.0.4
	OPENBSD_3_6_BASE:1.2
	OPENBSD_3_5:1.2.0.2
	OPENBSD_3_5_BASE:1.2;
locks; strict;
comment	@# @;


1.3
date	2012.09.01.00.32.24;	author guenther;	state dead;
branches;
next	1.2;

1.2
date	2004.03.02.23.41.29;	author miod;	state Exp;
branches;
next	1.1;

1.1
date	2004.02.27.22.19.46;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.3
log
@   So passes uthreads
Like autumn leaves on water
   don't fear the tedu@@
@
text
@/*	$OpenBSD: uthread_machdep_asm.S,v 1.2 2004/03/02 23:41:29 miod Exp $	*/

/*
 * Copyright (c) 2004 Theo de Raadt
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#include <machine/asm.h>

/*
 * void _thread_machdep_switch(new, oldsave);
 */
ENTRY(_thread_machdep_switch)
	subu	r31, r31, 4 * 28

	/* save all registers but r0, r2, r3 and r31 on stack */
	st.d	r4,  r31, 4 * 0
	st.d	r6,  r31, 4 * 2
	st.d	r8,  r31, 4 * 4
	st.d	r10, r31, 4 * 6
	st.d	r12, r31, 4 * 8
	st.d	r14, r31, 4 * 10
	st.d	r16, r31, 4 * 12
	st.d	r18, r31, 4 * 14
	st.d	r20, r31, 4 * 16
	st.d	r22, r31, 4 * 18
	st.d	r24, r31, 4 * 20
	st.d	r26, r31, 4 * 22
	st.d	r28, r31, 4 * 24
	st	r30, r31, 4 * 26
	st	r1,  r31, 4 * 27
	
	/* exchange stacks */
	st	r31, r3,  0	/* oldsave->frame = r31 */
	ld	r31, r2,  0	/* r31 = oldsave->frame */

	/* restore registers */
	ld.d	r4,  r31, 4 * 0
	ld.d	r6,  r31, 4 * 2
	ld.d	r8,  r31, 4 * 4
	ld.d	r10, r31, 4 * 6
	ld.d	r12, r31, 4 * 8
	ld.d	r14, r31, 4 * 10
	ld.d	r16, r31, 4 * 12
	ld.d	r18, r31, 4 * 14
	ld.d	r20, r31, 4 * 16
	ld.d	r22, r31, 4 * 18
	ld.d	r24, r31, 4 * 20
	ld.d	r26, r31, 4 * 22
	ld.d	r28, r31, 4 * 24
	ld	r30, r31, 4 * 26
	ld	r1,  r31, 4 * 27

	jmp.n	r1
	 addu	r31, r31, 4 * 28
@


1.2
log
@Use double load/store instructions whenever possible.
@
text
@d1 1
a1 1
/*	$OpenBSD: uthread_machdep_asm.S,v 1.1 2004/02/27 22:19:46 deraadt Exp $	*/
@


1.1
log
@88k uthread stuff.  some regress succeeds, a few others still fail.  This
is enough to start debugging further..  ok miod
@
text
@d1 1
a1 1
/*	$OpenBSD: uthread_machdep_asm.S,v 1.4 2002/12/12 18:26:18 marc Exp $	*/
d21 22
a42 34
	global	__thread_machdep_switch
	.type	__thread_machdep_switch, @@function
__thread_machdep_switch:
	subu    r31,r31,4*30

	st	r1,r31,4*29
	st	r3,r31,4*0
	st	r4,r31,4*1
	st	r5,r31,4*2
	st	r6,r31,4*3
	st	r7,r31,4*4
	st	r8,r31,4*5
	st	r9,r31,4*6
	st	r10,r31,4*7
	st	r11,r31,4*8
	st	r12,r31,4*9
	st	r13,r31,4*10
	st	r14,r31,4*11
	st	r15,r31,4*12
	st	r16,r31,4*13
	st	r17,r31,4*14
	st	r18,r31,4*15
	st	r19,r31,4*16
	st	r20,r31,4*17
	st	r21,r31,4*18
	st	r22,r31,4*19
	st	r23,r31,4*20
	st	r24,r31,4*21
	st	r25,r31,4*22
	st	r26,r31,4*23
	st	r27,r31,4*24
	st	r28,r31,4*25
	st	r29,r31,4*26
	st	r30,r31,4*27
d44 20
a63 32
	st	r31,r0,r3
	ld	r31,r0,r2

	ld	r1,r31,4*29
	ld	r3,r31,4*0
	ld	r4,r31,4*1
	ld	r5,r31,4*2
	ld	r6,r31,4*3
	ld	r7,r31,4*4
	ld	r8,r31,4*5
	ld	r9,r31,4*6
	ld	r10,r31,4*7
	ld	r11,r31,4*8
	ld	r12,r31,4*9
	ld	r13,r31,4*10
	ld	r14,r31,4*11
	ld	r15,r31,4*12
	ld	r16,r31,4*13
	ld	r17,r31,4*14
	ld	r18,r31,4*15
	ld	r19,r31,4*16
	ld	r20,r31,4*17
	ld	r21,r31,4*18
	ld	r22,r31,4*19
	ld	r23,r31,4*20
	ld	r24,r31,4*21
	ld	r25,r31,4*22
	ld	r26,r31,4*23
	ld	r27,r31,4*24
	ld	r28,r31,4*25
	ld	r29,r31,4*26
	ld	r30,r31,4*27
d66 1
a66 4
	addu    r31,r31,4*30

	.size	__thread_machdep_switch , . - __thread_machdep_switch
	.align 8
@

