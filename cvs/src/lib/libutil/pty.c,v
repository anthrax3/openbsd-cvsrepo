head	1.20;
access;
symbols
	OPENBSD_6_1:1.20.0.4
	OPENBSD_6_1_BASE:1.20
	OPENBSD_6_0:1.19.0.14
	OPENBSD_6_0_BASE:1.19
	OPENBSD_5_9:1.19.0.10
	OPENBSD_5_9_BASE:1.19
	OPENBSD_5_8:1.19.0.12
	OPENBSD_5_8_BASE:1.19
	OPENBSD_5_7:1.19.0.4
	OPENBSD_5_7_BASE:1.19
	OPENBSD_5_6:1.19.0.8
	OPENBSD_5_6_BASE:1.19
	OPENBSD_5_5:1.19.0.6
	OPENBSD_5_5_BASE:1.19
	OPENBSD_5_4:1.19.0.2
	OPENBSD_5_4_BASE:1.19
	OPENBSD_5_3:1.18.0.2
	OPENBSD_5_3_BASE:1.18
	OPENBSD_5_2:1.17.0.2
	OPENBSD_5_2_BASE:1.17
	OPENBSD_5_1_BASE:1.15
	OPENBSD_5_1:1.15.0.24
	OPENBSD_5_0:1.15.0.22
	OPENBSD_5_0_BASE:1.15
	OPENBSD_4_9:1.15.0.20
	OPENBSD_4_9_BASE:1.15
	OPENBSD_4_8:1.15.0.18
	OPENBSD_4_8_BASE:1.15
	OPENBSD_4_7:1.15.0.14
	OPENBSD_4_7_BASE:1.15
	OPENBSD_4_6:1.15.0.16
	OPENBSD_4_6_BASE:1.15
	OPENBSD_4_5:1.15.0.12
	OPENBSD_4_5_BASE:1.15
	OPENBSD_4_4:1.15.0.10
	OPENBSD_4_4_BASE:1.15
	OPENBSD_4_3:1.15.0.8
	OPENBSD_4_3_BASE:1.15
	OPENBSD_4_2:1.15.0.6
	OPENBSD_4_2_BASE:1.15
	OPENBSD_4_1:1.15.0.4
	OPENBSD_4_1_BASE:1.15
	OPENBSD_4_0:1.15.0.2
	OPENBSD_4_0_BASE:1.15
	OPENBSD_3_9:1.14.0.4
	OPENBSD_3_9_BASE:1.14
	OPENBSD_3_8:1.14.0.2
	OPENBSD_3_8_BASE:1.14
	OPENBSD_3_7:1.13.0.4
	OPENBSD_3_7_BASE:1.13
	OPENBSD_3_6:1.13.0.2
	OPENBSD_3_6_BASE:1.13
	OPENBSD_3_5:1.11.0.2
	OPENBSD_3_5_BASE:1.11
	OPENBSD_3_4:1.10.0.2
	OPENBSD_3_4_BASE:1.10
	OPENBSD_3_3:1.9.0.4
	OPENBSD_3_3_BASE:1.9
	OPENBSD_3_2:1.9.0.2
	OPENBSD_3_2_BASE:1.9
	OPENBSD_3_1:1.6.0.12
	OPENBSD_3_1_BASE:1.6
	OPENBSD_3_0:1.6.0.10
	OPENBSD_3_0_BASE:1.6
	OPENBSD_2_9:1.6.0.8
	OPENBSD_2_9_BASE:1.6
	OPENBSD_2_8:1.6.0.6
	OPENBSD_2_8_BASE:1.6
	OPENBSD_2_7:1.6.0.4
	OPENBSD_2_7_BASE:1.6
	OPENBSD_2_6:1.6.0.2
	OPENBSD_2_6_BASE:1.6
	OPENBSD_2_5:1.5.0.12
	OPENBSD_2_5_BASE:1.5
	OPENBSD_2_4:1.5.0.10
	OPENBSD_2_4_BASE:1.5
	OPENBSD_2_3:1.5.0.8
	OPENBSD_2_3_BASE:1.5
	OPENBSD_2_2:1.5.0.6
	OPENBSD_2_2_BASE:1.5
	OPENBSD_2_1:1.5.0.4
	OPENBSD_2_1_BASE:1.5
	OPENBSD_2_0:1.5.0.2
	OPENBSD_2_0_BASE:1.5
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@ * @;


1.20
date	2016.08.30.14.44.45;	author guenther;	state Exp;
branches;
next	1.19;
commitid	mK1myQm2bRfAlqwG;

1.19
date	2013.05.21.19.07.02;	author matthew;	state Exp;
branches;
next	1.18;

1.18
date	2012.12.05.23.20.06;	author deraadt;	state Exp;
branches;
next	1.17;

1.17
date	2012.07.09.14.26.40;	author nicm;	state Exp;
branches;
next	1.16;

1.16
date	2012.04.26.05.55.36;	author matthew;	state Exp;
branches;
next	1.15;

1.15
date	2006.03.30.20.44.19;	author deraadt;	state Exp;
branches;
next	1.14;

1.14
date	2005.08.02.21.46.23;	author espie;	state Exp;
branches;
next	1.13;

1.13
date	2004.05.28.07.03.47;	author deraadt;	state Exp;
branches;
next	1.12;

1.12
date	2004.04.11.18.04.36;	author millert;	state Exp;
branches;
next	1.11;

1.11
date	2004.02.10.01.31.20;	author millert;	state Exp;
branches;
next	1.10;

1.10
date	2003.06.02.20.18.42;	author millert;	state Exp;
branches;
next	1.9;

1.9
date	2002.06.09.22.18.43;	author fgsch;	state Exp;
branches;
next	1.8;

1.8
date	2002.05.24.22.04.02;	author deraadt;	state Exp;
branches;
next	1.7;

1.7
date	2002.05.24.21.24.15;	author deraadt;	state Exp;
branches;
next	1.6;

1.6
date	99.05.24.21.24.29;	author deraadt;	state Exp;
branches;
next	1.5;

1.5
date	96.08.09.00.26.15;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	96.06.29.18.44.17;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	96.06.17.07.46.05;	author downsj;	state Exp;
branches;
next	1.2;

1.2
date	96.05.22.11.35.11;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.43.13;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.43.13;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.20
log
@Use O_CLOEXEC when opening fds local to a function

ok jca@@ krw@@
@
text
@/*	$OpenBSD: pty.c,v 1.19 2013/05/21 19:07:02 matthew Exp $	*/

/*-
 * Copyright (c) 1990, 1993
 *	The Regents of the University of California.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */

#include <sys/types.h>
#include <sys/stat.h>
#include <sys/ioctl.h>
#include <fcntl.h>
#include <termios.h>
#include <errno.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>
#include <grp.h>
#include <sys/tty.h>

#include "util.h"

int
openpty(int *amaster, int *aslave, char *name, struct termios *termp,
    struct winsize *winp)
{
	int master, slave, fd;
	struct ptmget ptm;

	/*
	 * Use /dev/ptm and the PTMGET ioctl to get a properly set up and
	 * owned pty/tty pair.
	 */
	fd = open(PATH_PTMDEV, O_RDWR|O_CLOEXEC);
	if (fd == -1)
		return (-1);
	if ((ioctl(fd, PTMGET, &ptm) == -1)) {
		close(fd);
		return (-1);
	}
	close(fd);
	master = ptm.cfd;
	slave = ptm.sfd;
	if (name) {
		/*
		 * Manual page says "at least 16 characters".
		 */
		strlcpy(name, ptm.sn, 16);
	}
	*amaster = master;
	*aslave = slave;
	if (termp)
		(void) tcsetattr(slave, TCSAFLUSH, termp);
	if (winp)
		(void) ioctl(slave, TIOCSWINSZ, winp);
	return (0);
}

pid_t
forkpty(int *amaster, char *name, struct termios *termp, struct winsize *winp)
{
	int master, slave;
	pid_t pid;

	if (openpty(&master, &slave, name, termp, winp) == -1)
		return (-1);
	switch (pid = fork()) {
	case -1:
		(void) close(master);
		(void) close(slave);
		return (-1);
	case 0:
		/*
		 * child
		 */
		(void) close(master);
		login_tty(slave);
		return (0);
	}
	/*
	 * parent
	 */
	*amaster = master;
	(void) close(slave);
	return (pid);
}
@


1.19
log
@Fix pty descriptor leak if fork() fails.

ok millert
@
text
@d1 1
a1 1
/*	$OpenBSD: pty.c,v 1.18 2012/12/05 23:20:06 deraadt Exp $	*/
d57 1
a57 1
	fd = open(PATH_PTMDEV, O_RDWR, 0);
@


1.18
log
@Remove excessive sys/cdefs.h inclusion
ok guenther millert kettenis
@
text
@d1 1
a1 1
/*	$OpenBSD: pty.c,v 1.17 2012/07/09 14:26:40 nicm Exp $	*/
d92 2
@


1.17
log
@ANSIfy forkpty, add missing $OpenBSD$ in duid.c, style (no arg names) in
util.h.

ok guenther
@
text
@d1 1
a1 1
/*	$OpenBSD: pty.c,v 1.16 2012/04/26 05:55:36 matthew Exp $	*/
a31 1
#include <sys/cdefs.h>
@


1.16
log
@Drop support from openpty() for 8+ year old kernels that don't support
/dev/ptm.  Users are strongly encouraged to upgrade to a more recent
release if they haven't already.

ok deraadt
@
text
@d1 1
a1 1
/*	$OpenBSD: pty.c,v 1.15 2006/03/30 20:44:19 deraadt Exp $	*/
d84 1
a84 5
forkpty(amaster, name, termp, winp)
	int *amaster;
	char *name;
	struct termios *termp;
	struct winsize *winp;
@


1.15
log
@please lint (without making anything else worse)
@
text
@d1 1
a1 1
/*	$OpenBSD: pty.c,v 1.14 2005/08/02 21:46:23 espie Exp $	*/
a46 3
#define TTY_LETTERS "pqrstuvwxyzPQRST"
#define TTY_SUFFIX "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"

a50 2
	char line[] = "/dev/ptyXX";
	const char *cp1, *cp2;
a52 2
	struct group *gr;
	gid_t ttygid;
d55 2
a56 6
	 * Try to use /dev/ptm and the PTMGET ioctl to get a properly set up
	 * and owned pty/tty pair. If this fails, (because we might not have
	 * the ptm device, etc.) fall back to using the traditional method
	 * of walking through the pty entries in /dev for the moment, until
	 * there is less chance of people being seriously boned by running
	 * kernels without /dev/ptm in them.
d60 1
a60 1
		goto walkit;
d63 1
a63 1
		goto walkit;
a80 43
 walkit:
	if ((gr = getgrnam("tty")) != NULL)
		ttygid = gr->gr_gid;
	else
		ttygid = (gid_t)-1;

	for (cp1 = TTY_LETTERS; *cp1; cp1++) {
		line[8] = *cp1;
		for (cp2 = TTY_SUFFIX; *cp2; cp2++) {
			line[9] = *cp2;
			line[5] = 'p';
			if ((master = open(line, O_RDWR, 0)) == -1) {
				if (errno == ENOENT)
					return (-1);	/* out of ptys */
			} else {
				line[5] = 't';
				(void) chown(line, getuid(), ttygid);
				(void) chmod(line, S_IRUSR|S_IWUSR|S_IWGRP);
				(void) revoke(line);
				if ((slave = open(line, O_RDWR, 0)) != -1) {
					*amaster = master;
					*aslave = slave;
					if (name) {
						/*
						 * Manual page says "at least
						 * 16 characters".
						 */
						strlcpy(name, line, 16);
					}
					if (termp)
						(void) tcsetattr(slave,
						    TCSAFLUSH, termp);
					if (winp)
						(void) ioctl(slave, TIOCSWINSZ,
						    winp);
					return (0);
				}
				(void) close(master);
			}
		}
	}
	errno = ENOENT;	/* out of ptys */
	return (-1);
@


1.14
log
@scrape $Id$ tags.
okay deraadt@@, millert@@, krw@@
@
text
@d1 1
a1 1
/*	$OpenBSD: pty.c,v 1.13 2004/05/28 07:03:47 deraadt Exp $	*/
d90 1
a90 1
		(void) ioctl(slave, TIOCSWINSZ, (char *)winp);
d96 1
a96 1
		ttygid = -1;
d126 1
a126 1
						    (char *)winp);
@


1.13
log
@knf; otto ok
@
text
@d1 1
a1 1
/*	$OpenBSD: pty.c,v 1.12 2004/04/11 18:04:36 millert Exp $	*/
a30 5

#if defined(LIBC_SCCS) && !defined(lint)
/* from: static char sccsid[] = "@@(#)pty.c	8.1 (Berkeley) 6/4/93"; */
static const char rcsid[] = "$Id: pty.c,v 1.12 2004/04/11 18:04:36 millert Exp $";
#endif /* LIBC_SCCS and not lint */
@


1.12
log
@Crank max ptys to 992.  We now have 62 pty/tty pairs for each letter
instead of 16.  E.g. it is now /dev/{p,t}typ[0-9a-zA-z] instead of just
/dev/{p,t}typ[0-9a-f].  This requires that you update MAKEDEV and run:
# cd /dev && ./MAKEDEV pty0 && rm -f [pt]ty[rq]*
@
text
@d1 2
a2 1
/*	$OpenBSD: pty.c,v 1.11 2004/02/10 01:31:20 millert Exp $	*/
d34 1
a34 1
static const char rcsid[] = "$Id: pty.c,v 1.11 2004/02/10 01:31:20 millert Exp $";
d56 2
a57 5
openpty(amaster, aslave, name, termp, winp)
	int *amaster, *aslave;
	char *name;
	struct termios *termp;
	struct winsize *winp;
d61 2
a62 1
	int master, slave, ttygid;
d64 1
a64 2
	struct ptmget ptm;
	int fd;
d66 2
a67 1
	/* Try to use /dev/ptm and the PTMGET ioctl to get a properly set up
a73 1

d78 1
a78 1
		close(fd); 
@


1.11
log
@Add the ptm device to pty(4).  By opening /dev/ptm and using the PTMGET
ioctl(2), an unprivileged process may allocate a pty and have its owner
and mode set appropriately.  This means that programs such as xterm and
screen no longer need to be setuid.  Programs using the openpty()
function require zero changes and will "just work".

Designed by beck@@ and deraadt@@; changes by beck@@ with cleanup (and
a rewrite of the vnode bits) by art@@ and tweaks/bugfixes by me.
Tested by many.
@
text
@d1 1
a1 1
/*	$OpenBSD: pty.c,v 1.10 2003/06/02 20:18:42 millert Exp $	*/
d33 1
a33 1
static const char rcsid[] = "$Id: pty.c,v 1.10 2003/06/02 20:18:42 millert Exp $";
d52 1
d62 2
a63 2
	register const char *cp1, *cp2;
	register int master, slave, ttygid;
d107 1
a107 1
		for (cp2 = "0123456789abcdef"; *cp2; cp2++) {
@


1.10
log
@Remove the advertising clause in the UCB license which Berkeley
rescinded 22 July 1999.  Proofed by myself and Theo.
@
text
@d1 1
a1 1
/*	$OpenBSD: pty.c,v 1.9 2002/06/09 22:18:43 fgsch Exp $	*/
d33 1
a33 1
static const char rcsid[] = "$Id: pty.c,v 1.9 2002/06/09 22:18:43 fgsch Exp $";
d47 1
d64 2
d67 32
@


1.9
log
@some -Wall and spaces cleanup, scsi.c left.
some brave soul should look at it.
@
text
@d1 1
a1 1
/*	$OpenBSD: pty.c,v 1.8 2002/05/24 22:04:02 deraadt Exp $	*/
d14 1
a14 5
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by the University of
 *	California, Berkeley and its contributors.
 * 4. Neither the name of the University nor the names of its contributors
d33 1
a33 1
static const char rcsid[] = "$Id: pty.c,v 1.8 2002/05/24 22:04:02 deraadt Exp $";
@


1.8
log
@strlcpy at most 16 characters, so says man page
@
text
@d1 1
a1 1
/*	$OpenBSD: pty.c,v 1.7 2002/05/24 21:24:15 deraadt Exp $	*/
d37 1
a37 1
static char *rcsid = "$Id: pty.c,v 1.7 2002/05/24 21:24:15 deraadt Exp $";
d97 1
a97 1
						(void) tcsetattr(slave, 
d100 1
a100 1
						(void) ioctl(slave, TIOCSWINSZ, 
d128 1
a128 1
		/* 
@


1.7
log
@KNF
@
text
@d1 1
a1 1
/*	$OpenBSD: pty.c,v 1.6 1999/05/24 21:24:29 deraadt Exp $	*/
d37 1
a37 1
static char *rcsid = "$Id: pty.c,v 1.6 1999/05/24 21:24:29 deraadt Exp $";
d89 7
a95 2
					if (name)
						strcpy(name, line);
@


1.6
log
@permit threaded use; jb@@freebsd
@
text
@d1 1
a1 1
/*	$OpenBSD: pty.c,v 1.5 1996/08/09 00:26:15 deraadt Exp $	*/
d37 1
a37 1
static char *rcsid = "$Id: pty.c,v 1.5 1996/08/09 00:26:15 deraadt Exp $";
d93 1
a93 1
							TCSAFLUSH, termp);
d96 1
a96 1
							(char *)winp);
@


1.5
log
@pty from p to z, P to T. includes v
@
text
@d1 1
a1 1
/*	$OpenBSD: pty.c,v 1.4 1996/06/29 18:44:17 deraadt Exp $	*/
d37 1
a37 1
static char *rcsid = "$Id: pty.c,v 1.4 1996/06/29 18:44:17 deraadt Exp $";
d63 1
a63 1
	static char line[] = "/dev/ptyXX";
@


1.4
log
@fix multiple invocations; from tlb@@viaweb.com
@
text
@d1 1
a1 1
/*	$OpenBSD: pty.c,v 1.3 1996/06/17 07:46:05 downsj Exp $	*/
d37 1
a37 1
static char *rcsid = "$Id: pty.c,v 1.3 1996/06/17 07:46:05 downsj Exp $";
a53 4
#ifdef i386
/* PCVT conflicts with ttyv*. */
#define TTY_LETTERS "pqrstuwxyzPQRST"
#else
a54 1
#endif
@


1.3
log
@util.h: new resting place
opendev.h: ok, so I merged it with util.h
opendev.h: use util.h
everything else: use "util.h"
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d37 1
a37 1
static char *rcsid = "$Id: pty.c,v 1.2 1996/05/22 11:35:11 deraadt Exp $";
d82 1
a104 1
				line[5] = 'p';
@


1.2
log
@libutil
@
text
@d1 1
d37 1
a37 1
static char *rcsid = "$Id: pty.c,v 1.1.1.1 1995/10/18 08:43:13 deraadt Exp $";
d51 2
a52 1
#include <util.h>
@


1.1
log
@Initial revision
@
text
@d36 1
a36 1
static char *rcsid = "$Id: pty.c,v 1.5 1995/06/05 19:44:01 pk Exp $";
d50 1
d52 6
a57 3
int login_tty __P((int));
int openpty __P((int *, int *, char *, struct termios *, struct winsize *));
pid_t forkpty __P((int *, char *, struct termios *, struct winsize *));
d76 1
a76 1
	for (cp1 = "pqrstuvwxyzPQRST"; *cp1; cp1++) {
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
