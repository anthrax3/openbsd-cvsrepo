head	1.6;
access;
symbols
	OPENBSD_2_4:1.5.0.2
	OPENBSD_2_4_BASE:1.5
	OPENBSD_2_3:1.1.0.2
	OPENBSD_2_3_BASE:1.1;
locks; strict;
comment	@ * @;


1.6
date	99.01.18.19.09.18;	author millert;	state dead;
branches;
next	1.5;

1.5
date	98.09.13.19.16.31;	author millert;	state Exp;
branches;
next	1.4;

1.4
date	98.08.15.18.44.46;	author millert;	state Exp;
branches;
next	1.3;

1.3
date	98.08.14.21.11.44;	author millert;	state Exp;
branches;
next	1.2;

1.2
date	98.07.23.21.20.06;	author millert;	state Exp;
branches;
next	1.1;

1.1
date	97.12.03.05.21.44;	author millert;	state Exp;
branches;
next	;


desc
@@


1.6
log
@ncurses-4.2-990116
@
text
@/*	$OpenBSD: trace_buf.c,v 1.5 1998/09/13 19:16:31 millert Exp $	*/

/****************************************************************************
 * Copyright (c) 1998 Free Software Foundation, Inc.                        *
 *                                                                          *
 * Permission is hereby granted, free of charge, to any person obtaining a  *
 * copy of this software and associated documentation files (the            *
 * "Software"), to deal in the Software without restriction, including      *
 * without limitation the rights to use, copy, modify, merge, publish,      *
 * distribute, distribute with modifications, sublicense, and/or sell       *
 * copies of the Software, and to permit persons to whom the Software is    *
 * furnished to do so, subject to the following conditions:                 *
 *                                                                          *
 * The above copyright notice and this permission notice shall be included  *
 * in all copies or substantial portions of the Software.                   *
 *                                                                          *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS  *
 * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF               *
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.   *
 * IN NO EVENT SHALL THE ABOVE COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,   *
 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR    *
 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR    *
 * THE USE OR OTHER DEALINGS IN THE SOFTWARE.                               *
 *                                                                          *
 * Except as contained in this notice, the name(s) of the above copyright   *
 * holders shall not be used in advertising or otherwise to promote the     *
 * sale, use or other dealings in this Software without prior written       *
 * authorization.                                                           *
 ****************************************************************************/

/****************************************************************************
 *  Author: Thomas E. Dickey <dickey@@clark.net> 1997                        *
 ****************************************************************************/
/*
 *	trace_buf.c - Tracing/Debugging buffers (attributes)
 */

#include <curses.priv.h>

MODULE_ID("$From: trace_buf.c,v 1.6 1998/08/15 23:37:25 tom Exp $")

typedef struct {
	char *text;
	size_t size;
} LIST;

char * _nc_trace_buf(int bufnum, size_t want)
{
	static LIST *list;
	static size_t have;

#if NO_LEAKS
	if (bufnum < 0) {
		if (have) {
			while (have--) {
				free(list[have].text);
			}
			free(list);
		}
		return 0;
	}
#endif

	if ((size_t)(bufnum+1) > have) {
		size_t need = (bufnum + 1) * 2;
		size_t used = sizeof(*list) * need;
		if ((list = (LIST *)_nc_doalloc(list, used)) == 0)
			return(0);
		while (need > have)
			list[have++].text = 0;
	}

	if (list[bufnum].text == 0
	 || want > list[bufnum].size)
	{
		if ((list[bufnum].text = (char *)_nc_doalloc(list[bufnum].text, want)) != 0)
			list[bufnum].size = want;
	}

	if (list[bufnum].text != 0)
		*(list[bufnum].text) = '\0';
	return list[bufnum].text;
}
@


1.5
log
@ncurses-4.2-980905
@
text
@d1 1
a1 1
/*	$OpenBSD: trace_buf.c,v 1.4 1998/08/15 18:44:46 millert Exp $	*/
@


1.4
log
@fix broken realloc fix from yesterday
@
text
@d1 1
a1 1
/*	$OpenBSD: trace_buf.c,v 1.3 1998/08/14 21:11:44 millert Exp $	*/
d40 6
a45 1
MODULE_ID("$From: trace_buf.c,v 1.5 1998/05/30 23:30:09 Todd.Miller Exp $")
d49 1
a49 4
	static struct {
		char *text;
		size_t size;
	} *list, *nlist;
d67 2
a68 7
		nlist = (list == 0) ? malloc(used) : realloc(list, used);
		if (nlist == 0) {
			if (list != 0)
				free(list);
			return(NULL);
		}
		list = nlist;
d73 2
a74 1
	if (list[bufnum].text == 0)
d76 2
a77 1
		list[bufnum].text = malloc(want);
a78 3
	else if (want > list[bufnum].size)
	{
		void *p = realloc(list[bufnum].text, want);
a79 8
		if (p != 0) {
			list[bufnum].text = p;
		} else {
			free(list[bufnum].text);
			list[bufnum].text = 0;
		}
	}
	list[bufnum].size = want;
@


1.3
log
@fix realloc usage
@
text
@d1 1
a1 1
/*	$OpenBSD: trace_buf.c,v 1.2 1998/07/23 21:20:06 millert Exp $	*/
d82 1
a82 1
		char *p = realloc(list[bufnum].text, want);
@


1.2
log
@ncurses-4.2-980718
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d47 1
a47 1
	} *list;
d65 4
a68 2
		list = (list == 0) ? malloc(used) : realloc(list, used);
		if (list == 0) {
d71 1
a78 1
		list[bufnum].size = want;
d80 10
a89 3
	else if (want > list[bufnum].size) {
		list[bufnum].text = realloc(list[bufnum].text, want);
		list[bufnum].size = want;
d91 1
@


1.1
log
@Merge of ncurses-4.1-971129
@
text
@d3 31
a33 20
/******************************************************************************
 * Copyright 1997 by Thomas E. Dickey <dickey@@clark.net>                      *
 * All Rights Reserved.                                                       *
 *                                                                            *
 * Permission to use, copy, modify, and distribute this software and its      *
 * documentation for any purpose and without fee is hereby granted, provided  *
 * that the above copyright notice appear in all copies and that both that    *
 * copyright notice and this permission notice appear in supporting           *
 * documentation, and that the name of the above listed copyright holder(s)   *
 * not be used in advertising or publicity pertaining to distribution of the  *
 * software without specific, written prior permission.                       *
 *                                                                            *
 * THE ABOVE LISTED COPYRIGHT HOLDER(S) DISCLAIM ALL WARRANTIES WITH REGARD   *
 * TO THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND  *
 * FITNESS, IN NO EVENT SHALL THE ABOVE LISTED COPYRIGHT HOLDER(S) BE LIABLE  *
 * FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES          *
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN      *
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR *
 * IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.                *
 ******************************************************************************/
d40 1
a40 1
MODULE_ID("Id: trace_buf.c,v 1.2 1997/10/26 22:09:05 tom Exp $")
a66 1
			errno = ENOMEM;
a83 2
	else
		errno = ENOMEM;
@

