head	1.14;
access;
symbols
	OPENBSD_6_2:1.14.0.6
	OPENBSD_6_2_BASE:1.14
	OPENBSD_6_1:1.14.0.4
	OPENBSD_6_1_BASE:1.14
	OPENBSD_6_0:1.11.0.8
	OPENBSD_6_0_BASE:1.11
	OPENBSD_5_9:1.11.0.4
	OPENBSD_5_9_BASE:1.11
	OPENBSD_5_8:1.11.0.6
	OPENBSD_5_8_BASE:1.11
	OPENBSD_5_7:1.11.0.2
	OPENBSD_5_7_BASE:1.11
	OPENBSD_5_6:1.10.0.4
	OPENBSD_5_6_BASE:1.10
	OPENBSD_5_5:1.9.0.4
	OPENBSD_5_5_BASE:1.9
	OPENBSD_5_4:1.4.0.2
	OPENBSD_5_4_BASE:1.4;
locks; strict;
comment	@ * @;


1.14
date	2016.09.07.17.53.35;	author natano;	state Exp;
branches;
next	1.13;
commitid	bTUYWm2clD2A9qNB;

1.13
date	2016.08.30.16.45.54;	author natano;	state Exp;
branches;
next	1.12;
commitid	bR1BHPSoghZ5Wk7v;

1.12
date	2016.08.27.01.57.27;	author guenther;	state Exp;
branches;
next	1.11;
commitid	bLHpXmM9WTmU7O33;

1.11
date	2015.01.16.16.48.51;	author deraadt;	state Exp;
branches;
next	1.10;
commitid	0DYulI8hhujBHMcR;

1.10
date	2014.04.28.13.08.34;	author syl;	state Exp;
branches;
next	1.9;

1.9
date	2013.12.03.09.59.40;	author syl;	state Exp;
branches;
next	1.8;

1.8
date	2013.11.06.19.53.20;	author syl;	state Exp;
branches;
next	1.7;

1.7
date	2013.11.02.09.00.49;	author syl;	state Exp;
branches;
next	1.6;

1.6
date	2013.11.01.18.16.22;	author syl;	state Exp;
branches;
next	1.5;

1.5
date	2013.10.07.18.41.01;	author syl;	state Exp;
branches;
next	1.4;

1.4
date	2013.06.14.20.49.06;	author syl;	state Exp;
branches;
next	1.3;

1.3
date	2013.06.12.22.36.06;	author tedu;	state Exp;
branches;
next	1.2;

1.2
date	2013.06.03.16.21.08;	author tedu;	state Exp;
branches;
next	1.1;

1.1
date	2013.06.03.16.00.50;	author tedu;	state Exp;
branches;
next	;


desc
@@


1.14
log
@Fix fuse node lookups. Currently fusefs nodes in the kernel remember the
parent inode number for ".." lookups. This only works until the kernel
starts to reuse vnodes and the parent's vnode is reclaimed and the ino
to path mapping is removed from the userland process by libfuse. Fix
this by using reference counting in libfuse, so that parent mapping are
retained as long as a child uses them. Also, don't free the root node.

This commit resolves following issue:

$ doas fuse-zip ~/Downloads/foo.zip /mnt
$ ls /mnt
openbsd-www
$ grep -IR foo /usr/src > /dev/null	# force vfs to reclaim vnodes
$ ls /mnt
ls: /mnt: No such file or directory
$

ok tedu
@
text
@/* $OpenBSD: fuse_private.h,v 1.13 2016/08/30 16:45:54 natano Exp $ */
/*
 * Copyright (c) 2013 Sylvestre Gallon <ccna.syl@@gmail.com>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#ifndef _FUSE_SUBR_H_
#define _FUSE_SUBR_H_

#include <sys/dirent.h>
#include <sys/event.h>
#include <sys/mount.h>
#include <sys/stat.h>
#include <sys/statvfs.h>
#include <sys/tree.h>
#include <sys/fusebuf.h>
#include <limits.h>

#include "fuse.h"

struct fuse_dirhandle;
struct fuse_args;

struct fuse_vnode {
	ino_t ino;
	struct fuse_vnode *parent;
	unsigned int ref;

	char path[NAME_MAX + 1];
	struct fuse_dirhandle *fd;

	SIMPLEQ_ENTRY(fuse_vnode) node; /* for dict */
};

SIMPLEQ_HEAD(fuse_vn_head, fuse_vnode);
SPLAY_HEAD(dict, dictentry);
SPLAY_HEAD(tree, treeentry);

struct fuse_session {
	void *args;
};

struct fuse_chan {
	char *dir;
	struct fuse_args *args;

	int fd;
	int dead;

	/* kqueue stuff */
	int kq;
	struct kevent event;
};

struct fuse_config {
	uid_t			uid;
	gid_t			gid;
	pid_t			pid;
	mode_t			umask;
	int			set_mode;
	int			set_uid;
	int			set_gid;
};

struct fuse_core_opt {
	char *mp;
};

struct fuse {
	struct fuse_chan	*fc;
	struct fuse_operations	op;

	int			compat;

	struct tree		vnode_tree;
	struct dict		name_tree;
	uint64_t		max_ino;
	void			*private_data;

	struct fuse_config	conf;
	struct fuse_session	se;
};

#define	FUSE_MAX_OPS	39
#define FUSE_ROOT_INO ((ino_t)1)

/* fuse_ops.c */
int	ifuse_exec_opcode(struct fuse *, struct fusebuf *);

/* fuse_subr.c */
struct fuse_vnode	*alloc_vn(struct fuse *, const char *, ino_t, ino_t);
void			 ref_vn(struct fuse_vnode *);
void			 unref_vn(struct fuse *, struct fuse_vnode *);
struct fuse_vnode	*get_vn_by_name_and_parent(struct fuse *, uint8_t *,
    ino_t);
void			remove_vnode_from_name_tree(struct fuse *,
    struct fuse_vnode *);
int			set_vn(struct fuse *, struct fuse_vnode *);
char			*build_realname(struct fuse *, ino_t);

/* tree.c */
#define tree_init(t)	SPLAY_INIT((t))
#define tree_empty(t)	SPLAY_EMPTY((t))
int			tree_check(struct tree *, uint64_t);
void			*tree_set(struct tree *, uint64_t, void *);
void			*tree_get(struct tree *, uint64_t);;
void			*tree_pop(struct tree *, uint64_t);

/* dict.c */
int			dict_check(struct dict *, const char *);
void			*dict_set(struct dict *, const char *, void *);
void			*dict_get(struct dict *, const char *);;
void			*dict_pop(struct dict *, const char *);

#define FUSE_VERSION_PKG_INFO "2.8.0"
#define unused __attribute__ ((unused))

#endif /* _FUSE_SUBR_ */
@


1.13
log
@Use struct stat for storing attributes in fusebufs, because using struct
vattr in userspace is suboptimal as some related helpers are not
available, e.g. VATTR_NULL() and IFTOVT(). The conversion is now done in
the kernel where it belongs. As a side effect the <sys/vnode.h> include
can be removed from libfuse.

tweaks and ok guenther
@
text
@d1 1
a1 1
/* $OpenBSD: fuse_private.h,v 1.12 2016/08/27 01:57:27 guenther Exp $ */
d37 2
a38 1
	ino_t parent;
d103 2
@


1.12
log
@Pull in <sys/time.h> for struct timespec

ok deraadt@@
@
text
@d1 1
a1 1
/* $OpenBSD: fuse_private.h,v 1.11 2015/01/16 16:48:51 deraadt Exp $ */
d22 1
d24 1
d26 1
a26 2
#include <sys/time.h>
#include <sys/vnode.h>
@


1.11
log
@Move to the <limits.h> universe.
review by millert, binary checking process with doug, concept with guenther
@
text
@d1 1
a1 1
/* $OpenBSD: fuse_private.h,v 1.10 2014/04/28 13:08:34 syl Exp $ */
d24 1
@


1.10
log
@Add support for 255 character file names in fuse.

from Helg Bredow, thanks!
input/OK reyk@@
@
text
@d1 1
a1 1
/* $OpenBSD: fuse_private.h,v 1.9 2013/12/03 09:59:40 syl Exp $ */
a20 1
#include <sys/param.h>
d26 1
@


1.9
log
@Add support for FBT_RECLAIM that allow us to free the representation
of vnode in userspace.

"I think it's right" from tedu@@.
@
text
@d1 1
a1 1
/* $OpenBSD: fuse_private.h,v 1.8 2013/11/06 19:53:20 syl Exp $ */
d37 1
a37 1
	char path[NAME_MAX];
@


1.8
log
@Handle fuse client private data. Needed by encfs.
Bump shlib_version.

ok stsp@@.
@
text
@d1 1
a1 1
/* $OpenBSD: fuse_private.h,v 1.7 2013/11/02 09:00:49 syl Exp $ */
d102 2
@


1.7
log
@Update the fuse_opt to have option like -h working.

ok ajacoutot@@
@
text
@d1 1
a1 1
/* $OpenBSD: fuse_private.h,v 1.6 2013/11/01 18:16:22 syl Exp $ */
d86 1
@


1.6
log
@Add missing bitfields needed by gvfs.
Bump pkg_config version to 2.8.0

ok ajacoutot@@
@
text
@d1 1
a1 1
/* $OpenBSD: fuse_private.h,v 1.5 2013/10/07 18:41:01 syl Exp $ */
d71 4
@


1.5
log
@Fix some different signedness error. this commit make clang happier.

Thanks to Pedro Martelletto.
@
text
@d1 1
a1 1
/* $OpenBSD: fuse_private.h,v 1.4 2013/06/14 20:49:06 syl Exp $ */
d114 1
a114 1
#define FUSE_VERSION_PKG_INFO "2.6.9"
@


1.4
log
@Add support for fuse_get_context(3) needed by ntfs-3g.

OK pirofti@@ and beck@@ "assuming I am getting to setting
the initial pid/gid/uid values correctly soon".
@
text
@d1 1
a1 1
/* $OpenBSD: fuse_private.h,v 1.3 2013/06/12 22:36:06 tedu Exp $ */
d95 1
a95 1
struct fuse_vnode	*get_vn_by_name_and_parent(struct fuse *, const char *,
@


1.3
log
@fuse_opt support from Sylvestre
@
text
@d1 1
a1 1
/* $OpenBSD: fuse_private.h,v 1.2 2013/06/03 16:21:08 tedu Exp $ */
d66 1
@


1.2
log
@rcsids
@
text
@d1 1
a1 1
/* $OpenBSD$ */
d31 1
a45 6

struct fuse_args {
	int	argc;
	char	**argv;
	int	allocated;
};
@


1.1
log
@add userland fuse library. ok beck deraadt
from Sylvestre Gallon ccna.syl gmail.com
@
text
@d1 1
@

