head	1.6;
access;
symbols
	OPENBSD_6_2:1.6.0.2
	OPENBSD_6_2_BASE:1.6;
locks; strict;
comment	@# @;


1.6
date	2017.08.22.20.14.57;	author anton;	state Exp;
branches;
next	1.5;
commitid	VuHaVgjwvlebBt9w;

1.5
date	2017.07.22.13.50.54;	author anton;	state Exp;
branches;
next	1.4;
commitid	6r4QszwV0bHrjk08;

1.4
date	2017.07.19.20.09.35;	author anton;	state Exp;
branches;
next	1.3;
commitid	9MGMBJiyBYpL0tDy;

1.3
date	2017.07.05.19.40.58;	author anton;	state Exp;
branches;
next	1.2;
commitid	XhpJMASkzL1MdbIl;

1.2
date	2017.06.20.16.46.51;	author anton;	state Exp;
branches;
next	1.1;
commitid	5NXqyjKHdpwEz6sD;

1.1
date	2017.06.05.14.10.11;	author anton;	state Exp;
branches;
next	;
commitid	gyBA1jDSy3L9LYuX;


desc
@@


1.6
log
@Make the edit regress tests respect the KSH variable just like the main regress
tests. Makes it easier to run all tests using another binary:

  $ pwd
  /usr/src/regress/bin/ksh
  $ make KSH=/usr/src/bin/ksh/obj/ksh
@
text
@#!/bin/sh
#
# $OpenBSD: vi.sh,v 1.5 2017/07/22 13:50:54 anton Exp $
#
# Copyright (c) 2016 Ingo Schwarze <schwarze@@openbsd.org>
# Copyright (c) 2017 Anton Lindqvist <anton@@openbsd.org>
#
# Permission to use, copy, modify, and distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

. "${1:-.}/subr.sh"

KSH=$2

EDITOR=
ENV=
HISTFILE=
MAIL=
MALLOC_OPTIONS=S
PS1=' # '
VISUAL=vi
export EDITOR ENV HISTFILE MAIL MALLOC_OPTIONS PS1 VISUAL

# ^H, ^?: Erase.
testseq "ab\bc" " # ab\b \bc"
testseq "ab\0177c" " # ab\b \bc"

# ^J, ^M: End of line.
testseq "echo a\nb" " # echo a\r\r\na\r\n # b"
testseq "echo a\rb" " # echo a\r\r\na\r\n # b"
testseq "echo a\0033\nb" " # echo a\b\r\r\na\r\n # b"
testseq "echo a\0033\rb" " # echo a\b\r\r\na\r\n # b"

# ^U: Kill.
testseq "ab\0033ic\0025d" " # ab\bcb\b\b\bb  \b\b\bdb\b"

# ^V: Literal next.
testseq "a\0026\0033b" " # a^\b^[b"

# ^W: Word erase.
testseq "one two\0027rep" " # one two\b\b\b   \b\b\brep"

# A: Append at end of line.
# 0: Move to column 0.
testseq "one\00330A two" " # one\b\b\bone two"
testseq "one\003302A two\0033" " # one\b\b\bone two two\b"

# a: Append.
# .: Redo.
testseq "ab\00330axy" " # ab\b\baxb\byb\b"
testseq "ab\003302axy\0033" " # ab\b\baxb\byb\bxyb\b\b"
testseq "ab\00330axy\0033." " # ab\b\baxb\byb\b\byxyb\b\b"

# B: Move back big word.
testseq "one 2.0\0033BD" " # one 2.0\b\b\b   \b\b\b\b"

# b: Move back word.
# C: Change to end of line.
# D: Delete to end of line.
testseq "one ab.cd\0033bDa.\00332bD" \
	" # one ab.cd\b\b  \b\b\b..\b\b\b\b    \b\b\b\b\b"
testseq "one two\0033bCrep" " # one two\b\b\b   \b\b\brep"

# c: Change region.
testseq "one two\0033cbrep" " # one two\b\b\bo  \b\b\bro\beo\bpo\b"
testseq "one two\00332chx" " # one two\b\b\bo  \b\b\bxo\b"

# d: Delete region.
testseq "one two\0033db" " # one two\b\b\bo  \b\b\b"
testseq "one two xy\00332db" " # one two xy\b\b\b\b\b\by     \b\b\b\b\b\b"

# E: Move to end of big word.
testseq "1.00 two\00330ED" " # 1.00 two\b\r # 1.0     \b\b\b\b\b\b"

# e: Move to end of word.
testseq "onex two\00330eD" " # onex two\b\r # one     \b\b\b\b\b\b"

# F: Find character backward.
# ;: Repeat last search.
# ,: Repeat last search in opposite direction.
testseq "hello\00332FlD" " # hello\b\b\b   \b\b\b\b"
testseq "hello\0033Flix\0033;ix" " # hello\b\bxlo\b\b\b\bxlxlo\b\b\b\b"
testseq "hello\00332Flix\00332,ix" " # hello\b\b\bxllo\b\b\b\bxlxlo\b\b"

# f: Find character forward.
testseq "hello\003302flD" " # hello\b\b\b\b\bhel  \b\b\b"

# h, ^H: Move left.
# i: Insert.
testseq "hello\00332hix" " # hello\b\b\bxllo\b\b\b"
testseq "hello\00332\b2ix\0033" " # hello\b\b\bxllo\b\b\bxllo\b\b\b\b"

# I: Insert before first non-blank.
# ^: Move to the first non-whitespace character.
testseq "  ab\0033Ixy" " #   ab\b\bxab\b\byab\b\b"
testseq "  ab\00332Ixy\0033" " #   ab\b\bxab\b\byab\b\bxyab\b\b\b"
testseq "  ab\0033^ixy" " #   ab\b\bxab\b\byab\b\b"

# L: Undefined command (beep).
testseq "ab\0033Lx" " # ab\b\a \b\b"

# l, space: Move right.
# ~: Change case.
testseq "abc\003302l~" " # abc\b\b\babC\b"
testseq "abc\00330 rx" " # abc\b\b\bax\b"

# P: Paste at current position.
testseq "abcde\0033hDhP" " # abcde\b\b  \b\b\b\bdebc\b\b"
testseq "abcde\0033hDh2P" " # abcde\b\b  \b\b\b\bdedebc\b\b\b"

# p: Paste after current position.
testseq "abcd\0033hDhp" " # abcd\b\b  \b\b\b\bacdb\b\b"
testseq "abcd\0033hDh2p" " # abcd\b\b  \b\b\b\bacdcdb\b\b"

# R: Replace.
testseq "abcd\00332h2Rx\0033" " # abcd\b\b\bxx\b"
testseq "abcdef\00334h2Rxy\0033" " # abcdef\b\b\b\b\bxyxy\b"

# r: Replace character.
testseq "abcd\00332h2rxiy" " # abcd\b\b\bxx\byxd\b\b"
testseq "\0303\0266\0033ro" " # \0303\0266\bo \b\b"
testseq "\0342\0202\0254\0033ro" " # \0342\0202\0254\bo  \b\b\b"
testseq "\0303\0266\00332ro" " # \0303\0266\b\a"

# S: Substitute whole line.
testseq "oldst\0033Snew" " # oldst\b\b\b\b\b     \r # new"
testseq "oldstr\033Snew" " # oldstr\b\r #       \r # new"

# s: Substitute.
testseq "abcd\00332h2sx" " # abcd\b\b\bd  \b\b\bxd\b"
testseq "\0303\0266\0033s" " # \0303\0266\b  \b\b"

# T: Move backward after character.
testseq "helloo\0033TlD" " # helloo\b\b  \b\b\b"
testseq "hello\00332TlD" " # hello\b\b  \b\b\b"

# t: Move forward before character.
testseq "abc\00330tcD" " # abc\b\b\ba  \b\b\b"
testseq "hello\003302tlD" " # hello\b\b\b\b\bhe   \b\b\b\b"

# U: Undo all changes.
testseq "test\0033U" " # test\b\b\b\b    \b\b\b\b"

# u: Undo.
testseq "test\0033hxu" " # test\b\bt \b\bst\b\b"

# W: Move forward big word.
testseq "1.0 two\00330WD" " # 1.0 two\b\r # 1.0    \b\b\b\b"

# w: Move forward word.
testseq "ab cd ef\003302wD" " # ab cd ef\b\r # ab cd   \b\b\b"

# X: Delete previous character.
testseq "abcd\00332X" " # abcd\b\b\bd  \b\b\b"

# x: Delete character.
# |: Move to column.
testseq "abcd\00332|2x" " # abcd\b\b\bd  \b\b\b"
testseq "\0303\0266a\0033xx" " # \0303\0266a\b \b\b  \b\b"

# Y: Yank to end of line.
testseq "abcd\0033hYp" " # abcd\b\bccdd\b\b"

# y: Yank region.
# $: Move to the last character.
testseq "abcd\00332h2ylp" " # abcd\b\b\bbbccd\b\b\b"
testseq "abcd\00332h2yl\$p" " # abcd\b\b\bbcdbc\b"

# %: Find match.
testseq "(x)\0033%lrc" " # (x)\b\b\b(c\b"
testseq "(x)\00330%hrc" " # (x)\b\b\b(x\bc\b"

# ^L, ^R: Redraw.
testseq "test\0033\0014" " # test\b\r\r\n # test\b"
testseq "test\0033h\0022" " # test\b\b\r\r\n # test\b\b"
@


1.5
log
@Add missing RCS IDs and zap redundant SRCS from Makefile.
@
text
@d3 1
a3 1
# $OpenBSD$
d21 2
@


1.4
log
@The first version of the edit program used to test csh, ksh and mail was based
on the following reasoning: once the program to test has written some data it
has entered the main-loop and is by now ready to receive user input. At this
point it should be safe to start writing input and once the program once again
enters a blocking reading state, its done processing the input. This approach
was sensitive to timing and determining when a shell is done processing its
input (if ever) is tricky.

This iteration of the edit program takes a new approach and uses presence of a
prompt for synchronisation of I/O. It doesn't solve all problems but is a step
in the right direction.

Joint work with bluhm@@
@
text
@d3 2
@


1.3
log
@Favor a UID-agnostic prompt in ksh edit mode tests. Allows the tests to pass
when executed as root.

Spotted by bluhm@@
@
text
@a17 2
set -e

@


1.2
log
@Fix EOL tests for ksh vi mode.
@
text
@d27 1
a27 1
PS1=' $ '
d32 2
a33 2
testseq "ab\bc" " $ ab\b \bc"
testseq "ab\0177c" " $ ab\b \bc"
d36 4
a39 4
testseq "echo a\nb" " $ echo a\r\r\na\r\n $ b"
testseq "echo a\rb" " $ echo a\r\r\na\r\n $ b"
testseq "echo a\0033\nb" " $ echo a\b\r\r\na\r\n $ b"
testseq "echo a\0033\rb" " $ echo a\b\r\r\na\r\n $ b"
d42 1
a42 1
testseq "ab\0033ic\0025d" " $ ab\bcb\b\b\bb  \b\b\bdb\b"
d45 1
a45 1
testseq "a\0026\0033b" " $ a^\b^[b"
d48 1
a48 1
testseq "one two\0027rep" " $ one two\b\b\b   \b\b\brep"
d52 2
a53 2
testseq "one\00330A two" " $ one\b\b\bone two"
testseq "one\003302A two\0033" " $ one\b\b\bone two two\b"
d57 3
a59 3
testseq "ab\00330axy" " $ ab\b\baxb\byb\b"
testseq "ab\003302axy\0033" " $ ab\b\baxb\byb\bxyb\b\b"
testseq "ab\00330axy\0033." " $ ab\b\baxb\byb\b\byxyb\b\b"
d62 1
a62 1
testseq "one 2.0\0033BD" " $ one 2.0\b\b\b   \b\b\b\b"
d68 2
a69 2
	" $ one ab.cd\b\b  \b\b\b..\b\b\b\b    \b\b\b\b\b"
testseq "one two\0033bCrep" " $ one two\b\b\b   \b\b\brep"
d72 2
a73 2
testseq "one two\0033cbrep" " $ one two\b\b\bo  \b\b\bro\beo\bpo\b"
testseq "one two\00332chx" " $ one two\b\b\bo  \b\b\bxo\b"
d76 2
a77 2
testseq "one two\0033db" " $ one two\b\b\bo  \b\b\b"
testseq "one two xy\00332db" " $ one two xy\b\b\b\b\b\by     \b\b\b\b\b\b"
d80 1
a80 1
testseq "1.00 two\00330ED" " $ 1.00 two\b\r $ 1.0     \b\b\b\b\b\b"
d83 1
a83 1
testseq "onex two\00330eD" " $ onex two\b\r $ one     \b\b\b\b\b\b"
d88 3
a90 3
testseq "hello\00332FlD" " $ hello\b\b\b   \b\b\b\b"
testseq "hello\0033Flix\0033;ix" " $ hello\b\bxlo\b\b\b\bxlxlo\b\b\b\b"
testseq "hello\00332Flix\00332,ix" " $ hello\b\b\bxllo\b\b\b\bxlxlo\b\b"
d93 1
a93 1
testseq "hello\003302flD" " $ hello\b\b\b\b\bhel  \b\b\b"
d97 2
a98 2
testseq "hello\00332hix" " $ hello\b\b\bxllo\b\b\b"
testseq "hello\00332\b2ix\0033" " $ hello\b\b\bxllo\b\b\bxllo\b\b\b\b"
d102 3
a104 3
testseq "  ab\0033Ixy" " $   ab\b\bxab\b\byab\b\b"
testseq "  ab\00332Ixy\0033" " $   ab\b\bxab\b\byab\b\bxyab\b\b\b"
testseq "  ab\0033^ixy" " $   ab\b\bxab\b\byab\b\b"
d107 1
a107 1
testseq "ab\0033Lx" " $ ab\b\a \b\b"
d111 2
a112 2
testseq "abc\003302l~" " $ abc\b\b\babC\b"
testseq "abc\00330 rx" " $ abc\b\b\bax\b"
d115 2
a116 2
testseq "abcde\0033hDhP" " $ abcde\b\b  \b\b\b\bdebc\b\b"
testseq "abcde\0033hDh2P" " $ abcde\b\b  \b\b\b\bdedebc\b\b\b"
d119 2
a120 2
testseq "abcd\0033hDhp" " $ abcd\b\b  \b\b\b\bacdb\b\b"
testseq "abcd\0033hDh2p" " $ abcd\b\b  \b\b\b\bacdcdb\b\b"
d123 2
a124 2
testseq "abcd\00332h2Rx\0033" " $ abcd\b\b\bxx\b"
testseq "abcdef\00334h2Rxy\0033" " $ abcdef\b\b\b\b\bxyxy\b"
d127 4
a130 4
testseq "abcd\00332h2rxiy" " $ abcd\b\b\bxx\byxd\b\b"
testseq "\0303\0266\0033ro" " $ \0303\0266\bo \b\b"
testseq "\0342\0202\0254\0033ro" " $ \0342\0202\0254\bo  \b\b\b"
testseq "\0303\0266\00332ro" " $ \0303\0266\b\a"
d133 2
a134 2
testseq "oldst\0033Snew" " $ oldst\b\b\b\b\b     \r $ new"
testseq "oldstr\033Snew" " $ oldstr\b\r $       \r $ new"
d137 2
a138 2
testseq "abcd\00332h2sx" " $ abcd\b\b\bd  \b\b\bxd\b"
testseq "\0303\0266\0033s" " $ \0303\0266\b  \b\b"
d141 2
a142 2
testseq "helloo\0033TlD" " $ helloo\b\b  \b\b\b"
testseq "hello\00332TlD" " $ hello\b\b  \b\b\b"
d145 2
a146 2
testseq "abc\00330tcD" " $ abc\b\b\ba  \b\b\b"
testseq "hello\003302tlD" " $ hello\b\b\b\b\bhe   \b\b\b\b"
d149 1
a149 1
testseq "test\0033U" " $ test\b\b\b\b    \b\b\b\b"
d152 1
a152 1
testseq "test\0033hxu" " $ test\b\bt \b\bst\b\b"
d155 1
a155 1
testseq "1.0 two\00330WD" " $ 1.0 two\b\r $ 1.0    \b\b\b\b"
d158 1
a158 1
testseq "ab cd ef\003302wD" " $ ab cd ef\b\r $ ab cd   \b\b\b"
d161 1
a161 1
testseq "abcd\00332X" " $ abcd\b\b\bd  \b\b\b"
d165 2
a166 2
testseq "abcd\00332|2x" " $ abcd\b\b\bd  \b\b\b"
testseq "\0303\0266a\0033xx" " $ \0303\0266a\b \b\b  \b\b"
d169 1
a169 1
testseq "abcd\0033hYp" " $ abcd\b\bccdd\b\b"
d173 2
a174 2
testseq "abcd\00332h2ylp" " $ abcd\b\b\bbbccd\b\b\b"
testseq "abcd\00332h2yl\$p" " $ abcd\b\b\bbcdbc\b"
d177 2
a178 2
testseq "(x)\0033%lrc" " $ (x)\b\b\b(c\b"
testseq "(x)\00330%hrc" " $ (x)\b\b\b(x\bc\b"
d181 2
a182 2
testseq "test\0033\0014" " $ test\b\r\r\n $ test\b"
testseq "test\0033h\0022" " $ test\b\b\r\r\n $ test\b\b"
@


1.1
log
@Add new edit regress files.

Absent from my previous commit.
@
text
@d36 4
a39 4
# XXX testseq "a\nab" " $ a\r\na"
# XXX testseq "a\rab" " $ a\r\na"
# XXX testseq "a\0033\nab" " $ a\b\r\na"
# XXX testseq "a\0033\rab" " $ a\b\r\na"
@

