head	1.7;
access;
symbols;
locks; strict;
comment	@# @;


1.7
date	2017.07.19.20.09.35;	author anton;	state Exp;
branches;
next	1.6;
commitid	9MGMBJiyBYpL0tDy;

1.6
date	2017.07.05.19.40.58;	author anton;	state Exp;
branches;
next	1.5;
commitid	XhpJMASkzL1MdbIl;

1.5
date	2017.07.05.19.27.26;	author anton;	state Exp;
branches;
next	1.4;
commitid	psa7ha1wQQGA2NPN;

1.4
date	2017.07.05.06.31.59;	author anton;	state Exp;
branches;
next	1.3;
commitid	l3TaM7dOrpz93VaH;

1.3
date	2017.06.06.08.05.01;	author anton;	state Exp;
branches;
next	1.2;
commitid	xhp6jWyAk1WvKV9N;

1.2
date	2017.06.05.17.34.09;	author schwarze;	state Exp;
branches;
next	1.1;
commitid	KNizanNKmXW79Eym;

1.1
date	2017.06.05.14.10.11;	author anton;	state Exp;
branches;
next	;
commitid	gyBA1jDSy3L9LYuX;


desc
@@


1.7
log
@The first version of the edit program used to test csh, ksh and mail was based
on the following reasoning: once the program to test has written some data it
has entered the main-loop and is by now ready to receive user input. At this
point it should be safe to start writing input and once the program once again
enters a blocking reading state, its done processing the input. This approach
was sensitive to timing and determining when a shell is done processing its
input (if ever) is tricky.

This iteration of the edit program takes a new approach and uses presence of a
prompt for synchronisation of I/O. It doesn't solve all problems but is a step
in the right direction.

Joint work with bluhm@@
@
text
@#!/bin/sh
#
# Copyright (c) 2017 Anton Lindqvist <anton@@openbsd.org>
# Copyright (c) 2017 Ingo Schwarze <schwarze@@openbsd.org>
#
# Permission to use, copy, modify, and distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

. "${1:-.}/subr.sh"

EDITOR=
ENV=
HISTFILE=
MAIL=
MALLOC_OPTIONS=S
PS1=' # '
VISUAL=emacs
export EDITOR ENV HISTFILE MAIL MALLOC_OPTIONS PS1 VISUAL

# auto-insert
testseq "abc" " # abc"

# insertion of valid UTF-8
testseq "z\0002\0302\0200" " # z\b\0302\0200z\b"
testseq "z\0002\0337\0277" " # z\b\0337\0277z\b"
testseq "z\0002\0340\0240\0200" " # z\b\0340\0240\0200z\b"
testseq "z\0002\0354\0277\0277" " # z\b\0354\0277\0277z\b"
testseq "z\0002\0355\0200\0200" " # z\b\0355\0200\0200z\b"
testseq "z\0002\0355\0237\0277" " # z\b\0355\0237\0277z\b"
testseq "z\0002\0356\0200\0200" " # z\b\0356\0200\0200z\b"
testseq "z\0002\0357\0277\0277" " # z\b\0357\0277\0277z\b"
testseq "z\0002\0364\0200\0200\0200" " # z\b\0364\0200\0200\0200z\b"
testseq "z\0002\0364\0217\0277\0277" " # z\b\0364\0217\0277\0277z\b"

# insertion of incomplete UTF-8
testseq "z\0002\0302\0006" " # z\b\0302z\bz"
testseq "z\0002\0377\0006" " # z\b\0377z\bz"
testseq "z\0002\0337\0006" " # z\b\0337z\bz"
testseq "z\0002\0340\0006" " # z\b\0340z\bz"
testseq "z\0002\0357\0006" " # z\b\0357z\bz"
testseq "z\0002\0364\0006" " # z\b\0364z\bz"
testseq "z\0002\0340\0240\0006" " # z\b\0340\0240z\bz"
testseq "z\0002\0354\0277\0006" " # z\b\0354\0277z\bz"
testseq "z\0002\0355\0200\0006" " # z\b\0355\0200z\bz"
testseq "z\0002\0355\0237\0006" " # z\b\0355\0237z\bz"
testseq "z\0002\0356\0200\0006" " # z\b\0356\0200z\bz"
testseq "z\0002\0357\0277\0006" " # z\b\0357\0277z\bz"
testseq "z\0002\0364\0200\0200\0006" " # z\b\0364\0200\0200z\bz"
testseq "z\0002\0364\0217\0277\0006" " # z\b\0364\0217\0277z\bz"

# insertion of invalid bytes
testseq "z\0002\0300\0277" " # z\b\0300z\b\b\0300\0277z\b"
testseq "z\0002\0301\0277" " # z\b\0301z\b\b\0301\0277z\b"
testseq "z\0002\0360\0217" " # z\b\0360z\b\b\0360\0217z\b"
testseq "z\0002\0363\0217" " # z\b\0363z\b\b\0363\0217z\b"
testseq "z\0002\0365\0217" " # z\b\0365z\b\b\0365\0217z\b"
testseq "z\0002\0367\0217" " # z\b\0367z\b\b\0367\0217z\b"
testseq "z\0002\0370\0217" " # z\b\0370z\b\b\0370\0217z\b"
testseq "z\0002\0377\0217" " # z\b\0377z\b\b\0377\0217z\b"

# insertion of excessively long encodings
testseq "z\0002\0340\0200\0200" \
	" # z\b\0340z\b\b\0340\0200z\b\b\0340\0200\0200z\b"
testseq "z\0002\0340\0201\0277" \
	" # z\b\0340z\b\b\0340\0201z\b\b\0340\0201\0277z\b"
testseq "z\0002\0340\0202\0200" \
	" # z\b\0340z\b\b\0340\0202z\b\b\0340\0202\0200z\b"
testseq "z\0002\0340\0237\0277" \
	" # z\b\0340z\b\b\0340\0237z\b\b\0340\0237\0277z\b"

# insertion of surrogates and execessive code points
testseq "z\0002\0355\0240\0200" \
	" # z\b\0355z\b\b\0355\0240z\b\b\0355\0240\0200z\b"
testseq "z\0002\0355\0277\0277" \
	" # z\b\0355z\b\b\0355\0277z\b\b\0355\0277\0277z\b"
testseq "z\0002\0364\0220\0200\0200" \
  " # z\b\0364z\b\b\0364\0220z\b\b\0364\0220\0200z\b\b\0364\0220\0200\0200z\b"
testseq "z\0002\0364\0277\0277\0277" \
  " # z\b\0364z\b\b\0364\0277z\b\b\0364\0277\0277z\b\b\0364\0277\0277\0277z\b"

# insertion of unmatched meta sequence
testseq "z\0002\0033[3z" " # z\b\0007"
@


1.6
log
@Favor a UID-agnostic prompt in ksh edit mode tests. Allows the tests to pass
when executed as root.

Spotted by bluhm@@
@
text
@a17 2
set -e

@


1.5
log
@Revert previously added tests for file completion that are currently failing.

Prodded by bluhm@@
@
text
@d27 1
a27 1
PS1=' $ '
d32 1
a32 1
testseq "abc" " $ abc"
d35 10
a44 10
testseq "z\0002\0302\0200" " $ z\b\0302\0200z\b"
testseq "z\0002\0337\0277" " $ z\b\0337\0277z\b"
testseq "z\0002\0340\0240\0200" " $ z\b\0340\0240\0200z\b"
testseq "z\0002\0354\0277\0277" " $ z\b\0354\0277\0277z\b"
testseq "z\0002\0355\0200\0200" " $ z\b\0355\0200\0200z\b"
testseq "z\0002\0355\0237\0277" " $ z\b\0355\0237\0277z\b"
testseq "z\0002\0356\0200\0200" " $ z\b\0356\0200\0200z\b"
testseq "z\0002\0357\0277\0277" " $ z\b\0357\0277\0277z\b"
testseq "z\0002\0364\0200\0200\0200" " $ z\b\0364\0200\0200\0200z\b"
testseq "z\0002\0364\0217\0277\0277" " $ z\b\0364\0217\0277\0277z\b"
d47 14
a60 14
testseq "z\0002\0302\0006" " $ z\b\0302z\bz"
testseq "z\0002\0377\0006" " $ z\b\0377z\bz"
testseq "z\0002\0337\0006" " $ z\b\0337z\bz"
testseq "z\0002\0340\0006" " $ z\b\0340z\bz"
testseq "z\0002\0357\0006" " $ z\b\0357z\bz"
testseq "z\0002\0364\0006" " $ z\b\0364z\bz"
testseq "z\0002\0340\0240\0006" " $ z\b\0340\0240z\bz"
testseq "z\0002\0354\0277\0006" " $ z\b\0354\0277z\bz"
testseq "z\0002\0355\0200\0006" " $ z\b\0355\0200z\bz"
testseq "z\0002\0355\0237\0006" " $ z\b\0355\0237z\bz"
testseq "z\0002\0356\0200\0006" " $ z\b\0356\0200z\bz"
testseq "z\0002\0357\0277\0006" " $ z\b\0357\0277z\bz"
testseq "z\0002\0364\0200\0200\0006" " $ z\b\0364\0200\0200z\bz"
testseq "z\0002\0364\0217\0277\0006" " $ z\b\0364\0217\0277z\bz"
d63 8
a70 8
testseq "z\0002\0300\0277" " $ z\b\0300z\b\b\0300\0277z\b"
testseq "z\0002\0301\0277" " $ z\b\0301z\b\b\0301\0277z\b"
testseq "z\0002\0360\0217" " $ z\b\0360z\b\b\0360\0217z\b"
testseq "z\0002\0363\0217" " $ z\b\0363z\b\b\0363\0217z\b"
testseq "z\0002\0365\0217" " $ z\b\0365z\b\b\0365\0217z\b"
testseq "z\0002\0367\0217" " $ z\b\0367z\b\b\0367\0217z\b"
testseq "z\0002\0370\0217" " $ z\b\0370z\b\b\0370\0217z\b"
testseq "z\0002\0377\0217" " $ z\b\0377z\b\b\0377\0217z\b"
d74 1
a74 1
	" $ z\b\0340z\b\b\0340\0200z\b\b\0340\0200\0200z\b"
d76 1
a76 1
	" $ z\b\0340z\b\b\0340\0201z\b\b\0340\0201\0277z\b"
d78 1
a78 1
	" $ z\b\0340z\b\b\0340\0202z\b\b\0340\0202\0200z\b"
d80 1
a80 1
	" $ z\b\0340z\b\b\0340\0237z\b\b\0340\0237\0277z\b"
d84 1
a84 1
	" $ z\b\0355z\b\b\0355\0240z\b\b\0355\0240\0200z\b"
d86 1
a86 1
	" $ z\b\0355z\b\b\0355\0277z\b\b\0355\0277\0277z\b"
d88 1
a88 1
  " $ z\b\0364z\b\b\0364\0220z\b\b\0364\0220\0200z\b\b\0364\0220\0200\0200z\b"
d90 1
a90 1
  " $ z\b\0364z\b\b\0364\0277z\b\b\0364\0277\0277z\b\b\0364\0277\0277\0277z\b"
d93 1
a93 1
testseq "z\0002\0033[3z" " $ z\b\0007"
@


1.4
log
@Add tests for file completion in ksh emacs mode, currently failing.

While here, pass the v option to hexdump in order to output all data.
@
text
@a21 4
tmp=$(mktemp -d)
trap 'rm -r $tmp' 0
>$tmp/.profile

d23 1
a23 1
ENV=$tmp/.profile
a93 13

# file completion
echo "cd $tmp" >$tmp/.profile
mkdir -p \
	$tmp/a/a{1,2} $tmp/b\ b/b{1,2} $tmp/\(ccc\)/c{1,2} $tmp/\(d\ d\)/d{1,2}
testseq "cd a/\t" \
	" $ cd a/\b\b  \b\b\r $ cd a/a$(genseq 70 " " "\b")\r $ cd a/a \b"
testseq "cd b\ b/\t" \
	" $ cd b\ b/$(genseq 5 "\b" " " "\b")\r $ cd b\ b/b$(genseq 67 " " "\b")\r $ cd b\ b/b \b"
testseq "cd \(ccc\)/\t" \
	" $ cd \(ccc\)/$(genseq 8 "\b" " " "\b")\r $ cd \(ccc\)/c$(genseq 64 " " "\b")\r $ cd \(ccc\)/c \b"
testseq "cd \(d\ d\)/\t" \
	" $ cd \(d\ d\)/$(genseq 9 "\b" " " "\b")\r $ cd \(d\ d\)/d$(genseq 63 " " "\b")\r $ cd \(d\ d\)/d \b"
@


1.3
log
@Test insertion of unmatched meta sequence.
@
text
@d22 4
d27 1
a27 1
ENV=
d98 13
@


1.2
log
@Test insertion of non-ASCII characters, in particular making sure
that valid input does not cause writing invalid intermediate states
to the terminal, and that invalid input is not delayed waiting for
more input, but written through right away.

Currently failing, but expected to be fixed shortly.
@
text
@d91 3
@


1.1
log
@Add new edit regress files.

Absent from my previous commit.
@
text
@d4 1
d33 58
@

