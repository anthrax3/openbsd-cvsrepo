head	1.5;
access;
symbols
	OPENBSD_6_2:1.5.0.10
	OPENBSD_6_2_BASE:1.5
	OPENBSD_6_1:1.5.0.8
	OPENBSD_6_1_BASE:1.5
	OPENBSD_6_0:1.5.0.4
	OPENBSD_6_0_BASE:1.5
	OPENBSD_5_9:1.5.0.2
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.4.0.20
	OPENBSD_5_8_BASE:1.4
	OPENBSD_5_7:1.4.0.18
	OPENBSD_5_7_BASE:1.4
	OPENBSD_5_6:1.4.0.16
	OPENBSD_5_6_BASE:1.4
	OPENBSD_5_5:1.4.0.14
	OPENBSD_5_5_BASE:1.4
	OPENBSD_5_4:1.4.0.10
	OPENBSD_5_4_BASE:1.4
	OPENBSD_5_3:1.4.0.8
	OPENBSD_5_3_BASE:1.4
	OPENBSD_5_2:1.4.0.6
	OPENBSD_5_2_BASE:1.4
	OPENBSD_5_1_BASE:1.4
	OPENBSD_5_1:1.4.0.4
	OPENBSD_5_0:1.4.0.2
	OPENBSD_5_0_BASE:1.4
	OPENBSD_4_9:1.3.0.8
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.3.0.6
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.3.0.2
	OPENBSD_4_7_BASE:1.3
	OPENBSD_4_6:1.3.0.4
	OPENBSD_4_6_BASE:1.3
	OPENBSD_4_5:1.2.0.8
	OPENBSD_4_5_BASE:1.2
	OPENBSD_4_4:1.2.0.6
	OPENBSD_4_4_BASE:1.2
	OPENBSD_4_3:1.2.0.4
	OPENBSD_4_3_BASE:1.2
	OPENBSD_4_2:1.2.0.2
	OPENBSD_4_2_BASE:1.2;
locks; strict;
comment	@# @;


1.5
date	2015.10.14.13.22.56;	author semarie;	state Exp;
branches;
next	1.4;
commitid	7PZlIsxlzDSoChgS;

1.4
date	2011.04.18.16.52.11;	author thib;	state Exp;
branches;
next	1.3;

1.3
date	2009.04.26.21.32.31;	author okan;	state Exp;
branches;
next	1.2;

1.2
date	2007.05.19.19.11.08;	author otto;	state Exp;
branches;
next	1.1;

1.1
date	2007.04.18.10.18.23;	author otto;	state Exp;
branches;
next	;


desc
@@


1.5
log
@unbreak regress/sbin/newfs

/dev/prandom is no more since Nov 30, 2008

OK otto@@
@
text
@#!/bin/ksh
#	$OpenBSD: checknewfs,v 1.4 2011/04/18 16:52:11 thib Exp $
# Written by Otto Moerbeek, 2007,  Public domain


cleanup() {
	vnconfig -u vnd0
	rm -f $image
}

trap 'cleanup' INT

dotest() {
	image=$(mktemp -t imageXXXXXXXXXX);
	dd if=/dev/random of=$image bs=512 count=$1 2>/dev/null &&
	vnconfig vnd0 $image &&
	disklabel -w vnd0 $2 &&
	newfs $3 /dev/rvnd0a
	if [ $? != 0 ]; then
		ret=$(($ret + 1))
		echo TEST $1 $2 \"$3\" failed
	else
		(fsck -nf /dev/vnd0a | fgrep SALVAGE)
		if [ $? == 0 ]; then
			ret=$(($ret + 1))
			echo TEST $1 $2 \"$3\" failed
		else
			echo TEST $1 $2 \"$3\" OK
		fi
	fi
	echo ==========================
	if [ $clean == 1 ]; then
		cleanup
	fi
}

ret=0

vnconfig -u vnd0 > /dev/null 2>&1
if [ $# == 0 ]; then 
	clean=1
	dotest 3800 rdroot "-m 0 -o space -i 4096" 
	dotest 5760 floppy288 "-m 0 -o space -i 81920 -c 5760" 
	dotest 5760 floppy288 "-m 0 -o space -i 81920 -c 5752" 
	dotest 5760 floppy288 "-m 0 -o space -i 524288 -c 5760" 
	dotest 5760 floppy288 "-m 0 -o space -i 524288 -c 5761" 
	dotest 2880 floppy3 "-m 0 -o space -i 81920"
	dotest 2880 floppy3 "-m 0 -o space -i 81920 -c 2880"
	dotest 2880 floppy3 "-m 0 -o space -i 524288 -c 2880"
else
	clean=0
	dotest "${@@}"
fi

exit $ret
@


1.4
log
@Deprecate vnds in favour of svnds.

In effect, this removes the "old" vndX nodes, and renames
the svndX nodes to vndX.

Old svndX nodes will still continue to work though, for now.

Cleanup accordingly.

ok deraadt@@, todd@@
comments and ok on the man page bits from jmc@@
@
text
@d2 1
a2 1
#	$OpenBSD: checknewfs,v 1.3 2009/04/26 21:32:31 okan Exp $
d15 1
a15 1
	dd if=/dev/prandom of=$image bs=512 count=$1 2>/dev/null &&
@


1.3
log
@- check equality with '==', from skreuzer@@exit2shell.com
- unbreak, since -r was removed from disklabel(8)

ok otto@@
@
text
@d2 1
a2 1
#	$OpenBSD: checknewfs,v 1.2 2007/05/19 19:11:08 otto Exp $
d7 1
a7 1
	vnconfig -u svnd0
d16 3
a18 3
	vnconfig svnd0 $image &&
	disklabel -w svnd0 $2 &&
	newfs $3 /dev/rsvnd0a
d23 1
a23 1
		(fsck -nf /dev/svnd0a | fgrep SALVAGE)
d39 1
a39 1
vnconfig -u svnd0 > /dev/null 2>&1
@


1.2
log
@detect if newfs fails and add an extra test (amd64 floppy)
@
text
@d2 1
a2 1
#	$OpenBSD: checknewfs,v 1.1 2007/04/18 10:18:23 otto Exp $
d17 1
a17 1
	disklabel -w -r svnd0 $2 &&
d32 1
a32 1
	if [ $clean = 1 ]; then
@


1.1
log
@some newfs checks, not hooked in, because it needs certain disktab
entries which are not available on all platforms
@
text
@d2 1
a2 1
#	$OpenBSD$
d18 2
a19 3
	newfs $3 /dev/rsvnd0a &&
	fsck -nf /dev/svnd0a | fgrep SALVAGE
	if [ $? == 0 ]; then
d23 7
a29 1
		echo TEST $1 $2 \"$3\" OK
d49 1
@

