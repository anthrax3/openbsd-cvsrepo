head	1.6;
access;
symbols
	OPENBSD_6_1_BASE:1.6
	OPENBSD_6_0:1.1.0.26
	OPENBSD_6_0_BASE:1.1
	OPENBSD_5_9:1.1.0.16
	OPENBSD_5_9_BASE:1.1
	OPENBSD_5_8:1.1.0.24
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.22
	OPENBSD_5_7_BASE:1.1
	OPENBSD_5_6:1.1.0.20
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.18
	OPENBSD_5_5_BASE:1.1
	OPENBSD_5_4:1.1.0.14
	OPENBSD_5_4_BASE:1.1
	OPENBSD_5_3:1.1.0.12
	OPENBSD_5_3_BASE:1.1
	OPENBSD_5_2:1.1.0.10
	OPENBSD_5_2_BASE:1.1
	OPENBSD_5_1_BASE:1.1
	OPENBSD_5_1:1.1.0.8
	OPENBSD_5_0:1.1.0.6
	OPENBSD_5_0_BASE:1.1
	OPENBSD_4_9:1.1.0.4
	OPENBSD_4_9_BASE:1.1
	OPENBSD_4_8:1.1.0.2
	OPENBSD_4_8_BASE:1.1;
locks; strict;
comment	@# @;


1.6
date	2017.01.23.23.10.35;	author bluhm;	state Exp;
branches;
next	1.5;
commitid	ovfWkE5T5Yhm6J2a;

1.5
date	2017.01.23.22.26.19;	author bluhm;	state Exp;
branches;
next	1.4;
commitid	mXNzadu7ER1PPyw0;

1.4
date	2017.01.23.22.03.46;	author bluhm;	state Exp;
branches;
next	1.3;
commitid	i395q4wxIDZseBGR;

1.3
date	2017.01.19.08.41.50;	author beck;	state Exp;
branches;
next	1.2;
commitid	uAJGYGixRznWCJoy;

1.2
date	2016.09.28.11.46.45;	author bluhm;	state Exp;
branches;
next	1.1;
commitid	u9rycPDvA0jA7fDN;

1.1
date	2010.07.14.06.19.26;	author halex;	state Exp;
branches;
next	;


desc
@@


1.6
log
@For testing http redirect unset http_proxy, not ftp_proxy.
@
text
@#!/bin/sh
#	$OpenBSD: redirect.sh,v 1.5 2017/01/23 22:26:19 bluhm Exp $

: ${FTP:=ftp}

: ${rport1:=9000}
: ${rport2:=9001}

req1=$1
loc=$2
req2=$3

echo "Testing $req1 => $loc => $req2"

# Be sure to kill any previous nc running on our port
while pkill -fx "nc -4 -l $rport1" && sleep 1; do done

echo "HTTP/1.0 302 Found\r\nLocation: $loc\r\n\r" | \
     nc -4 -l $rport1 >/dev/null &

# Wait for the "server" to start
until fstat | egrep 'nc[ ]+.*tcp 0x[0-9a-f]* \*:9000' > /dev/null; do
	sleep .1
done

unset http_proxy

res=$(${FTP} -4 -o/dev/null -v $req1 2>&1 | \
    sed '/^Redirected to /{s///;x;};$!d;x')

if [ X"$res" != X"$req2" ]; then
	echo "*** Fail; expected \"$req2\", got \"$res\""
	exit 1
fi
@


1.5
log
@The ftp program is only verbose by default, if stdin is a tty.  As
the test greps for messages that are in the verbose output, add a
ftp -v option so that make regress can be run by cron(8).
@
text
@d2 1
a2 1
#	$OpenBSD: redirect.sh,v 1.4 2017/01/23 22:03:46 bluhm Exp $
d26 1
a26 1
unset ftp_proxy
@


1.4
log
@When run as root, fstat prints the pcb pointer instead of 0x0.
Force netcat and ftp to use IPv4.  Unset ftp proxy environment.
@
text
@d2 1
a2 1
#	$OpenBSD: redirect.sh,v 1.3 2017/01/19 08:41:50 beck Exp $
d23 1
a23 1
sleep .1
d28 2
a29 1
res=$(${FTP} -4 -o/dev/null $req1 2>&1 | sed '/^Redirected to /{s///;x;};$!d;x')
@


1.3
log
@Make it so if the "server" is slow starting we don't fail..
Since I suspect bluhm@@ is hitting this on whatever derpy thing
is running the ftp regress test continuously
@
text
@d2 1
a2 1
#	$OpenBSD: redirect.sh,v 1.2 2016/09/28 11:46:45 bluhm Exp $
d16 1
a16 1
while pkill -fx "nc -l $rport1" && sleep 1; do done
d18 2
a19 1
echo "HTTP/1.0 302 Found\r\nLocation: $loc\r\n\r" | nc -l $rport1 >/dev/null &
d22 1
a22 1
until fstat | egrep 'nc[ ]+.*tcp 0x0 \*:9000' > /dev/null; do
d26 3
a28 1
res=$(${FTP} -o/dev/null $req1 2>&1 | sed '/^Redirected to /{s///;x;};$!d;x')
@


1.2
log
@Do not close stdout when starting netcat, redirect to /dev/null
instead.  This prevents that the ftp test hangs in nc poll(2).  Add
OpenBSD RCS id while there.
@
text
@d2 1
a2 1
#	$OpenBSD$
d20 2
a21 1
# Give the "server" some time to start
d23 1
@


1.1
log
@add regress tests for upcoming redirection changes to ftp
@
text
@d2 1
d18 1
a18 1
echo "HTTP/1.0 302 Found\r\nLocation: $loc\r\n\r" | nc -l $rport1 >&- &
@

