head	1.3;
access;
symbols
	OPENBSD_6_0:1.3.0.8
	OPENBSD_6_0_BASE:1.3
	OPENBSD_5_9:1.3.0.2
	OPENBSD_5_9_BASE:1.3
	OPENBSD_5_8:1.3.0.6
	OPENBSD_5_8_BASE:1.3
	OPENBSD_5_7:1.3.0.4
	OPENBSD_5_7_BASE:1.3
	OPENBSD_5_6:1.1.0.10
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.8
	OPENBSD_5_5_BASE:1.1
	OPENBSD_5_4:1.1.0.4
	OPENBSD_5_4_BASE:1.1
	OPENBSD_5_3:1.1.0.2
	OPENBSD_5_3_BASE:1.1;
locks; strict;
comment	@# @;


1.3
date	2015.02.12.12.20.47;	author schwarze;	state Exp;
branches;
next	1.2;
commitid	SViaEKzwzmf0o0kW;

1.2
date	2014.08.26.11.32.54;	author schwarze;	state Exp;
branches;
next	1.1;
commitid	QJnN8iCFzEXgbRZx;

1.1
date	2012.11.16.13.25.34;	author schwarze;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Delete the mdoc_node.pending pointer and the function calculating
it, make_pending(), which was the most difficult function of the
whole mdoc(7) parser.  After almost five years of maintaining this
hellhole, i just noticed the pointer isn't needed after all.

Blocks are always rewound in the reverse order they were opened;
that even holds for broken blocks.  Consequently, it is sufficient
to just mark broken blogs with the flag MDOC_BROKEN and breaking
blocks with the flag MDOC_ENDED.  When rewinding, instead of iterating
the pending pointers, just iterate from each broken block to its
parents, rewinding all that are MDOC_ENDED and stopping after
processing the first ancestor that it not MDOC_BROKEN.  For ENDBODY
markers, use the mdoc_node.body pointer in place of the former
mdoc_node.pending.

This also fixes an assertion failure found by jsg@@ with afl,
test case #467 (Bo Bl It Bd Bc It), where (surprise surprise)
the pending pointer got corrupted.

Improved functionality, minus one function, minus one struct field,
minus 50 lines of code.
@
text
@BL-BROKEN(1)                General Commands Manual               BL-BROKEN(1)

NNAAMMEE
     BBll--bbrrookkeenn - list broken by another block

DDEESSCCRRIIPPTTIIOONN
     before both [before list

           1.   inside both] after bracket
     after list [before list

           1.   inside list

                      inside display] after bracket

           2.   next item
     after list

OpenBSD                        February 12, 2015                       OpenBSD
@


1.2
log
@inevitable churn caused by the section title change
@
text
@d10 1
a10 1
     after both
d12 8
a19 1
OpenBSD                        November 10, 2012                       OpenBSD
@


1.1
log
@Fix a crash triggered by .Bl -tag .It Xo .El .Sh found by florian@@.

* When allocating a body end marker, copy the pointer to the normalized
block information from the body block, avoiding the risk of subsequent
null pointer derefence.
* When inserting the body end marker into the syntax tree, do not try to
copy that pointer from the parent block, because not being a direkt child
of the block it belongs to is the whole point of a body end marker.
* Even non-callable blocks (like Bd and Bl) can break other blocks;
when this happens, postpone closing them out in the usual way.
@
text
@d1 1
a1 1
BL-BROKEN(1)               OpenBSD Reference Manual               BL-BROKEN(1)
@

