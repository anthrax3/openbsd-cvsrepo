head	1.8;
access;
symbols
	OPENBSD_6_1:1.8.0.4
	OPENBSD_6_1_BASE:1.8
	OPENBSD_6_0:1.7.0.10
	OPENBSD_6_0_BASE:1.7
	OPENBSD_5_9:1.7.0.6
	OPENBSD_5_9_BASE:1.7
	OPENBSD_5_8:1.7.0.8
	OPENBSD_5_8_BASE:1.7
	OPENBSD_5_7:1.7.0.2
	OPENBSD_5_7_BASE:1.7
	OPENBSD_5_6:1.7.0.4
	OPENBSD_5_6_BASE:1.7
	OPENBSD_5_5:1.6.0.4
	OPENBSD_5_5_BASE:1.6
	OPENBSD_5_4:1.5.0.2
	OPENBSD_5_4_BASE:1.5
	OPENBSD_5_3:1.4.0.34
	OPENBSD_5_3_BASE:1.4
	OPENBSD_5_2:1.4.0.32
	OPENBSD_5_2_BASE:1.4
	OPENBSD_5_1_BASE:1.4
	OPENBSD_5_1:1.4.0.30
	OPENBSD_5_0:1.4.0.28
	OPENBSD_5_0_BASE:1.4
	OPENBSD_4_9:1.4.0.26
	OPENBSD_4_9_BASE:1.4
	OPENBSD_4_8:1.4.0.24
	OPENBSD_4_8_BASE:1.4
	OPENBSD_4_7:1.4.0.20
	OPENBSD_4_7_BASE:1.4
	OPENBSD_4_6:1.4.0.22
	OPENBSD_4_6_BASE:1.4
	OPENBSD_4_5:1.4.0.18
	OPENBSD_4_5_BASE:1.4
	OPENBSD_4_4:1.4.0.16
	OPENBSD_4_4_BASE:1.4
	OPENBSD_4_3:1.4.0.14
	OPENBSD_4_3_BASE:1.4
	OPENBSD_4_2:1.4.0.12
	OPENBSD_4_2_BASE:1.4
	OPENBSD_4_1:1.4.0.10
	OPENBSD_4_1_BASE:1.4
	OPENBSD_4_0:1.4.0.8
	OPENBSD_4_0_BASE:1.4
	OPENBSD_3_9:1.4.0.6
	OPENBSD_3_9_BASE:1.4
	OPENBSD_3_8:1.4.0.4
	OPENBSD_3_8_BASE:1.4
	OPENBSD_3_7:1.4.0.2
	OPENBSD_3_7_BASE:1.4
	OPENBSD_3_6:1.3.0.4
	OPENBSD_3_6_BASE:1.3
	OPENBSD_3_5:1.3.0.2
	OPENBSD_3_5_BASE:1.3;
locks; strict;
comment	@# @;


1.8
date	2016.12.16.01.06.27;	author dtucker;	state Exp;
branches;
next	1.7;
commitid	Q8QqRgY9IYItm25a;

1.7
date	2014.03.13.20.44.49;	author djm;	state Exp;
branches;
next	1.6;

1.6
date	2014.02.27.20.04.16;	author djm;	state Exp;
branches;
next	1.5;

1.5
date	2013.05.17.10.23.52;	author dtucker;	state Exp;
branches;
next	1.4;

1.4
date	2005.02.27.23.13.36;	author djm;	state Exp;
branches;
next	1.3;

1.3
date	2004.03.08.10.17.12;	author dtucker;	state Exp;
branches;
next	1.2;

1.2
date	2004.02.29.22.04.45;	author dtucker;	state Exp;
branches;
next	1.1;

1.1
date	2004.02.17.08.23.20;	author dtucker;	state Exp;
branches;
next	;


desc
@@


1.8
log
@Move the "stop sshd" code into its own helper function.  Patch from
Zev Weiss <zev at bewilderbeest.net>, ok djm@@
@
text
@#	$OpenBSD: login-timeout.sh,v 1.7 2014/03/13 20:44:49 djm Exp $
#	Placed in the Public Domain.

tid="connect after login grace timeout"

trace "test login grace with privsep"
cp $OBJ/sshd_config $OBJ/sshd_config.orig
grep -vi LoginGraceTime $OBJ/sshd_config.orig > $OBJ/sshd_config
echo "LoginGraceTime 10s" >> $OBJ/sshd_config
echo "MaxStartups 1" >> $OBJ/sshd_config
start_sshd

(echo SSH-2.0-fake; sleep 60) | telnet 127.0.0.1 ${PORT} >/dev/null 2>&1 & 
sleep 15
${SSH} -F $OBJ/ssh_config somehost true
if [ $? -ne 0 ]; then
	fail "ssh connect after login grace timeout failed with privsep"
fi

stop_sshd

trace "test login grace without privsep"
echo "UsePrivilegeSeparation no" >> $OBJ/sshd_config
start_sshd
sleep 1

(echo SSH-2.0-fake; sleep 60) | telnet 127.0.0.1 ${PORT} >/dev/null 2>&1 & 
sleep 15
${SSH} -F $OBJ/ssh_config somehost true
if [ $? -ne 0 ]; then
	fail "ssh connect after login grace timeout failed without privsep"
fi
@


1.7
log
@this test is a sorry mess of race conditions; add another sleep
to avoid a failure on slow machines (at least until I find a
better way)
@
text
@d1 1
a1 1
#	$OpenBSD: login-timeout.sh,v 1.6 2014/02/27 20:04:16 djm Exp $
d20 1
a20 1
$SUDO kill `$SUDO cat $PIDFILE`
@


1.6
log
@remove any existing LoginGraceTime from sshd_config before adding
a specific one for the test back in
@
text
@d1 1
a1 1
#	$OpenBSD: login-timeout.sh,v 1.5 2013/05/17 10:23:52 dtucker Exp $
d25 1
@


1.5
log
@Use SUDO when cat'ing pid files and running the sshd log wrapper so that
it works with a restrictive umask and the pid files are not world readable.
Changes from -portable.
@
text
@d1 1
a1 1
#	$OpenBSD: login-timeout.sh,v 1.4 2005/02/27 23:13:36 djm Exp $
d7 2
@


1.4
log
@avoid nameservice lookups in regress test; ok dtucker@@
@
text
@d1 1
a1 1
#	$OpenBSD: login-timeout.sh,v 1.3 2004/03/08 10:17:12 dtucker Exp $
d18 1
a18 1
$SUDO kill `cat $PIDFILE`
@


1.3
log
@Missing OBJ, from tim@@.  ok markus@@
@
text
@d1 1
a1 1
#	$OpenBSD: login-timeout.sh,v 1.2 2004/02/29 22:04:45 dtucker Exp $
d11 1
a11 1
(echo SSH-2.0-fake; sleep 60) | telnet localhost ${PORT} >/dev/null 2>&1 & 
d24 1
a24 1
(echo SSH-2.0-fake; sleep 60) | telnet localhost ${PORT} >/dev/null 2>&1 & 
@


1.2
log
@Use sudo when restarting daemon during test.  ok markus@@
@
text
@d1 1
a1 1
#	$OpenBSD: login-timeout.sh,v 1.1 2004/02/17 08:23:20 dtucker Exp $
d21 1
a21 1
echo "UsePrivilegeSeparation no" >>sshd_config
@


1.1
log
@Add regression test for LoginGraceTime; ok markus@@
@
text
@d1 1
a1 1
#	$OpenBSD$
d18 1
a18 1
kill `cat $PIDFILE`
@

