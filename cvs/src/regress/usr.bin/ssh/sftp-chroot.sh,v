head	1.5;
access;
symbols
	OPENBSD_6_1_BASE:1.5
	OPENBSD_6_0:1.4.0.12
	OPENBSD_6_0_BASE:1.4
	OPENBSD_5_9:1.4.0.8
	OPENBSD_5_9_BASE:1.4
	OPENBSD_5_8:1.4.0.10
	OPENBSD_5_8_BASE:1.4
	OPENBSD_5_7:1.4.0.2
	OPENBSD_5_7_BASE:1.4
	OPENBSD_5_6:1.4.0.6
	OPENBSD_5_6_BASE:1.4
	OPENBSD_5_5:1.4.0.4
	OPENBSD_5_5_BASE:1.4
	OPENBSD_5_4:1.2.0.2
	OPENBSD_5_4_BASE:1.2;
locks; strict;
comment	@# @;


1.5
date	2016.09.26.21.34.38;	author bluhm;	state Exp;
branches;
next	1.4;
commitid	78ojOtQPiUY00oy2;

1.4
date	2014.01.20.00.00.30;	author dtucker;	state Exp;
branches;
next	1.3;

1.3
date	2014.01.19.23.43.02;	author dtucker;	state Exp;
branches;
next	1.2;

1.2
date	2013.05.17.04.29.14;	author dtucker;	state Exp;
branches;
next	1.1;

1.1
date	2013.04.18.02.46.12;	author djm;	state Exp;
branches;
next	;


desc
@@


1.5
log
@Allow to run ssh regression tests as root.  If the user is already
root, the test should not expect that SUDO is set.  If ssh needs
another user, use sudo or doas to switch from root if necessary.
OK dtucker@@
@
text
@#	$OpenBSD: sftp-chroot.sh,v 1.4 2014/01/20 00:00:30 dtucker Exp $
#	Placed in the Public Domain.

tid="sftp in chroot"

CHROOT=/var/run
FILENAME=testdata_${USER}
PRIVDATA=${CHROOT}/${FILENAME}

if [ -z "$SUDO" -a ! -w /var/run ]; then
	fatal "need SUDO to create file in /var/run, test won't work without"
fi

$SUDO sh -c "echo mekmitastdigoat > $PRIVDATA" || \
	fatal "create $PRIVDATA failed"

start_sshd -oChrootDirectory=$CHROOT -oForceCommand="internal-sftp -d /"

verbose "test $tid: get"
${SFTP} -S "$SSH" -F $OBJ/ssh_config host:/${FILENAME} $COPY \
    >>$TEST_REGRESS_LOGFILE 2>&1 || \
	fatal "Fetch ${FILENAME} failed"
cmp $PRIVDATA $COPY || fail "$PRIVDATA $COPY differ"

$SUDO rm $PRIVDATA
@


1.4
log
@append to rather than truncating the log file
@
text
@d1 1
a1 1
#	$OpenBSD: sftp-chroot.sh,v 1.3 2014/01/19 23:43:02 dtucker Exp $
d10 1
a10 1
if [ -z "$SUDO" ]; then
@


1.3
log
@Don't use -q on sftp as it suppresses logging, instead redirect the output to
the regress logfile.
@
text
@d1 1
a1 1
#	$OpenBSD: sftp-chroot.sh,v 1.2 2013/05/17 04:29:14 dtucker Exp $
d21 1
a21 1
    >$TEST_REGRESS_LOGFILE 2>&1 || \
@


1.2
log
@Move the setting of DATA and COPY into test-exec.sh
@
text
@d1 1
a1 1
#	$OpenBSD: sftp-chroot.sh,v 1.1 2013/04/18 02:46:12 djm Exp $
d20 2
a21 1
${SFTP} -qS "$SSH" -F $OBJ/ssh_config host:/${FILENAME} $COPY || \
@


1.1
log
@test sshd ChrootDirectory+internal-sftp; feedback & ok dtucker@@
@
text
@d1 1
a1 1
#	$OpenBSD$
a5 1
COPY=${OBJ}/copy
a19 1
rm -f ${COPY}
@

