head	1.5;
access;
symbols
	OPENBSD_6_2:1.5.0.4
	OPENBSD_6_2_BASE:1.5
	OPENBSD_6_1:1.4.0.6
	OPENBSD_6_1_BASE:1.4
	OPENBSD_6_0:1.4.0.2
	OPENBSD_6_0_BASE:1.4
	OPENBSD_5_9:1.2.0.2
	OPENBSD_5_9_BASE:1.2;
locks; strict;
comment	@ * @;


1.5
date	2017.07.05.15.31.45;	author bluhm;	state Exp;
branches;
next	1.4;
commitid	eYx6IbLq0jXNHWKX;

1.4
date	2016.04.11.21.33.03;	author schwarze;	state Exp;
branches;
next	1.3;
commitid	FJB2JuLIq3pDRXf5;

1.3
date	2016.03.01.16.12.11;	author schwarze;	state Exp;
branches;
next	1.2;
commitid	WpEedg9ROj05L4FI;

1.2
date	2016.02.11.20.54.06;	author schwarze;	state Exp;
branches;
next	1.1;
commitid	uZ3KkinhgQq1HyTI;

1.1
date	2016.02.11.15.37.20;	author schwarze;	state Exp;
branches;
next	;
commitid	HXxulMOT7085CpbX;


desc
@@


1.5
log
@Implement the generated dependency with a stamp file to avoid needless
recompiling of the test programs.  Add some RCS ids.
@
text
@/*	$OpenBSD$	*/
/*
 * Copyright (c) 2016 Ingo Schwarze <schwarze@@openbsd.org>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#include <err.h>
#include <locale.h>
#include <stdio.h>
#include <stdlib.h>

#include "read.c"
#include "glue.c"

/*
 * Unit test steering program for editline/read.c, read_char().
 * Reads from standard input until read_char() returns 0.
 * Writes the code points read to standard output in %x format.
 * If EILSEQ is set after read_char(), indicating that there were some
 * garbage bytes before the character, the code point gets * prefixed.
 * The return value is indicated by appending to the code point:
 * a comma for 1, a full stop for 0, [%d] otherwise.
 * Errors out on unexpected failure (setlocale failure, malloc
 * failure, or unexpected errno).
 * Since ENOMSG is very unlikely to occur, it is used to make
 * sure that read_char() doesn't clobber errno.
 */

int
main(void)
{
	EditLine el;
	int irc;
	wchar_t cp;

	if (setlocale(LC_CTYPE, "") == NULL)
		err(1, "setlocale");
	el.el_flags = CHARSET_IS_UTF8;
	el.el_infd = STDIN_FILENO;
	if ((el.el_signal = calloc(1, sizeof(*el.el_signal))) == NULL)
		err(1, NULL);
	do {
		errno = ENOMSG;
		irc = read_char(&el, &cp);
		switch (errno) {
		case ENOMSG:
			break;
		case EILSEQ:
			putchar('*');
			break;
		default:
			err(1, NULL);
		}
		printf("%x", cp);
		switch (irc) {
		case 1:
			putchar(',');
			break;
		case 0:
			putchar('.');
			break;
		default:
			printf("[%d]", irc);
			break;
		}
	} while (irc != 0);
	return 0;
}
@


1.4
log
@cope with the deletion of Char, use wchar_t
@
text
@d1 1
@


1.3
log
@More unit tests for libedit.
Those that still fail are commented out in the Makefiles for now;
i have patches for them.
@
text
@d44 1
a44 1
	Char cp;
@


1.2
log
@Test the C/POSIX locale too, in addition to UTF-8.
@
text
@d23 1
a23 37

/*
 * Glue for unit tests of libedit/read.c.
 * Rather than linking in all the various libedit modules,
 * provide dummies for those functions called in read.c.
 * Most aren't actually called in read_char().
 * Requires "make obj && make depend" in src/lib/libedit.
 */

#define EL EditLine *el __attribute__((__unused__))
#define UU __attribute__((__unused__))

int ch_enlargebufs(EL, size_t addlen UU) { return 1; }
void ch_reset(EL, int mclear UU) { }
void el_resize(EL) { }
int el_set(EL, int op UU, ...) { return 0; }
void re_clear_display(EL) { }
void re_clear_lines(EL) { }
void re_refresh(EL) { }
void re_refresh_cursor(EL) { }
void sig_clr(EL) { }
void sig_set(EL) { }
void terminal__flush(EL) { }
void terminal_beep(EL) { }
int tty_cookedmode(EL) { return 0; }
int tty_rawmode(EL) { return 0; }

int
keymacro_get(EL, Char *ch, keymacro_value_t *val)
{
	val->str = NULL;
	*ch = '\0';
	return XK_STR;
}

#undef EL
#undef UU
@


1.1
log
@Slowly start a unit test suite for libedit; Christos is right that
fiddling with the internals of that code is dangerous without it.
Intentionally not linked to the build yet, because many of the tests
still fail: The related bugfixes are too intrusive right now and will
go in after unlock.
@
text
@d82 1
a82 1
	if (setlocale(LC_CTYPE, "en_US.UTF-8") == NULL)
@

