head	1.5;
access;
symbols
	OPENBSD_6_1:1.5.0.6
	OPENBSD_6_1_BASE:1.5
	OPENBSD_6_0:1.5.0.4
	OPENBSD_6_0_BASE:1.5
	OPENBSD_5_9:1.5.0.2
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.3.0.6
	OPENBSD_5_8_BASE:1.3
	OPENBSD_5_7:1.3.0.4
	OPENBSD_5_7_BASE:1.3;
locks; strict;
comment	@ * @;


1.5
date	2015.09.11.13.10.42;	author beck;	state Exp;
branches;
next	1.4;
commitid	ucxf0FJxy86BwCNQ;

1.4
date	2015.09.11.12.57.24;	author beck;	state Exp;
branches;
next	1.3;
commitid	m3aLgSQB1I17TKWq;

1.3
date	2015.02.22.15.14.32;	author jsing;	state Exp;
branches;
next	1.2;
commitid	IYDmj8mqnK9qAXnY;

1.2
date	2014.12.07.16.56.17;	author bcook;	state Exp;
branches;
next	1.1;
commitid	ig91zabTuUs7Q4W8;

1.1
date	2014.11.01.11.55.27;	author jsing;	state Exp;
branches;
next	;
commitid	QNBSYdzwXq8mAQJU;


desc
@@


1.5
log
@regress test that we do not allow a wildcard match for ".openbsd.org"
against a wildcard of "*.openbsd.org"
@
text
@/*	$OpenBSD: verifytest.c,v 1.4 2015/09/11 12:57:24 beck Exp $	*/
/*
 * Copyright (c) 2014 Joel Sing <jsing@@openbsd.org>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#include <err.h>
#include <stdio.h>
#include <stdlib.h>

#include <openssl/x509v3.h>
#include <tls.h>

extern int tls_check_name(struct tls *ctx, X509 *cert, const char *name);

struct verify_test {
	const char common_name[128];
	const char alt_name[128];
	int alt_name_len;
	int alt_name_type;
	const char name[128];
	int want;
};

struct verify_test verify_tests[] = {
	{
		.common_name = "www.openbsd.org",
		.name = "www.openbsd.org",
		.want = 0,
	},
	{
		.common_name = "www.openbsd.org",
		.name = "",
		.want = -1,
	},
	{
		.common_name = "*.openbsd.org",
		.name = "www.openbsd.org",
		.want = 0,
	},
	{
		.common_name = "www.openbsdfoundation.org",
		.name = "www.openbsd.org",
		.want = -1,
	},
	{
		.common_name = "w*.openbsd.org",
		.name = "www.openbsd.org",
		.want = -1,
	},
	{
		.common_name = "www.*.org",
		.name = "www.openbsd.org",
		.want = -1,
	},
	{
		.common_name = "www.openbsd.*",
		.name = "www.openbsd.org",
		.want = -1,
	},
	{
		.common_name = "*",
		.name = "www.openbsd.org",
		.want = -1,
	},
	{
		.common_name = "*.org",
		.name = "www.openbsd.org",
		.want = -1,
	},
	{
		.common_name = "*.org",
		.name = "openbsd.org",
		.want = -1,
	},
	{
		.common_name = "1.2.3.4",
		.name = "1.2.3.4",
		.want = 0,
	},
	{
		.common_name = "*.2.3.4",
		.name = "1.2.3.4",
		.want = -1,
	},
	{
		.common_name = "cafe::beef",
		.name = "cafe::beef",
		.want = 0,
	},
	{
		.common_name = "www.openbsd.org",
		.alt_name = "ftp.openbsd.org",
		.alt_name_len = -1,
		.alt_name_type = GEN_DNS,
		.name = "ftp.openbsd.org",
		.want = 0,
	},
	{
		.common_name = "www.openbsdfoundation.org",
		.alt_name = "*.openbsd.org",
		.alt_name_len = -1,
		.alt_name_type = GEN_DNS,
		.name = "www.openbsd.org",
		.want = 0,
	},
	{
		.common_name = "www.openbsdfoundation.org",
		.alt_name = "*.org",
		.alt_name_len = -1,
		.alt_name_type = GEN_DNS,
		.name = "www.openbsd.org",
		.want = -1,
	},
	{
		.common_name = "www.openbsd.org",
		.alt_name = "1.2.3.4",
		.alt_name_len = -1,
		.alt_name_type = GEN_DNS,
		.name = "1.2.3.4",
		.want = -1,
	},
	{
		.common_name = "www.openbsd.org",
		.alt_name = {0x1, 0x2, 0x3, 0x4},
		.alt_name_len = 4,
		.alt_name_type = GEN_IPADD,
		.name = "1.2.3.4",
		.want = 0,
	},
	{
		.common_name = "www.openbsd.org",
		.alt_name = {
			0xca, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xbe, 0xef,
		},
		.alt_name_len = 16,
		.alt_name_type = GEN_IPADD,
		.name = "cafe::beef",
		.want = 0,
	},
	{
		.common_name = "*.openbsd.org",
		.name = ".openbsd.org",
		.want = -1,
	},
};

#define N_VERIFY_TESTS \
    (sizeof(verify_tests) / sizeof(*verify_tests))

static int
do_verify_test(int test_no, struct verify_test *vt)
{
	STACK_OF(GENERAL_NAME) *alt_name_stack = NULL;
	ASN1_STRING *alt_name_str;
	GENERAL_NAME *alt_name;
	X509_NAME *name;
	X509 *cert;
	struct tls *tls;

	/* Build certificate structure. */
	if ((cert = X509_new()) == NULL)
		errx(1, "failed to malloc X509");
	if ((name = X509_NAME_new()) == NULL)
		errx(1, "failed to malloc X509_NAME");
	if (X509_NAME_add_entry_by_NID(name, NID_commonName, MBSTRING_ASC,
	    (unsigned char *)vt->common_name, -1, -1, 0) == 0)
		errx(1, "failed to add name entry");
	if (X509_set_subject_name(cert, name) == 0)
		errx(1, "failed to set subject name");
	X509_NAME_free(name);
	if ((tls = tls_client()) == NULL)
		errx(1, "failed to malloc tls_client");

	if (vt->alt_name_type != 0) {
		if ((alt_name_stack = sk_GENERAL_NAME_new_null()) == NULL)
			errx(1, "failed to malloc sk_GENERAL_NAME");
		if ((alt_name = GENERAL_NAME_new()) == NULL)
			errx(1, "failed to malloc GENERAL_NAME");
		alt_name->type = vt->alt_name_type;

		if ((alt_name_str = ASN1_STRING_new()) == NULL)
			errx(1, "failed to malloc alt name");
		if (ASN1_STRING_set(alt_name_str, vt->alt_name,
		    vt->alt_name_len) == 0)
			errx(1, "failed to set alt name");

		switch (alt_name->type) {
		case GEN_DNS:
			alt_name->d.dNSName = alt_name_str;
			break;

		case GEN_IPADD:
			alt_name->d.iPAddress = alt_name_str;
			break;

		default:
			errx(1, "unknown alt name type (%i)", alt_name->type);
		}
	
		if (sk_GENERAL_NAME_push(alt_name_stack, alt_name) == 0)
			errx(1, "failed to push alt_name");
		if (X509_add1_ext_i2d(cert, NID_subject_alt_name,
		    alt_name_stack, 0, 0) == 0)
			errx(1, "failed to set subject alt name");
		sk_GENERAL_NAME_pop_free(alt_name_stack, GENERAL_NAME_free);
	}

	if (tls_check_name(tls, cert, vt->name) != vt->want) {
		fprintf(stderr, "FAIL: test %i failed with common name "
		    "'%s', alt name '%s' and name '%s'\n", test_no,
		    vt->common_name, vt->alt_name, vt->name);
		return (1);
	}

	X509_free(cert);

	return (0);
}

int
main(int argc, char **argv)
{
	int failed = 0;
	size_t i;

	for (i = 0; i < N_VERIFY_TESTS; i++)
		failed += do_verify_test(i, &verify_tests[i]);

	return (failed);
}
@


1.4
log
@fix verify to allow for servername->name
ok jsing@@
@
text
@d1 1
a1 1
/*	$OpenBSD: verifytest.c,v 1.3 2015/02/22 15:14:32 jsing Exp $	*/
d152 5
@


1.3
log
@Update for recent verify related naming changes.
@
text
@d1 1
a1 1
/*	$OpenBSD: verifytest.c,v 1.2 2014/12/07 16:56:17 bcook Exp $	*/
d25 1
a25 1
extern int tls_check_servername(struct tls *ctx, X509 *cert, const char *name);
d32 1
a32 1
	const char servername[128];
d39 1
a39 1
		.servername = "www.openbsd.org",
d44 1
a44 1
		.servername = "",
d49 1
a49 1
		.servername = "www.openbsd.org",
d54 1
a54 1
		.servername = "www.openbsd.org",
d59 1
a59 1
		.servername = "www.openbsd.org",
d64 1
a64 1
		.servername = "www.openbsd.org",
d69 1
a69 1
		.servername = "www.openbsd.org",
d74 1
a74 1
		.servername = "www.openbsd.org",
d79 1
a79 1
		.servername = "www.openbsd.org",
d84 1
a84 1
		.servername = "openbsd.org",
d89 1
a89 1
		.servername = "1.2.3.4",
d94 1
a94 1
		.servername = "1.2.3.4",
d99 1
a99 1
		.servername = "cafe::beef",
d107 1
a107 1
		.servername = "ftp.openbsd.org",
d115 1
a115 1
		.servername = "www.openbsd.org",
d123 1
a123 1
		.servername = "www.openbsd.org",
d131 1
a131 1
		.servername = "1.2.3.4",
d139 1
a139 1
		.servername = "1.2.3.4",
d150 1
a150 1
		.servername = "cafe::beef",
d216 1
a216 1
	if (tls_check_servername(tls, cert, vt->servername) != vt->want) {
d218 2
a219 2
		    "'%s', alt name '%s' and servername '%s'\n", test_no,
		    vt->common_name, vt->alt_name, vt->servername);
@


1.2
log
@Allow specific libtls hostname validation errors to propagate.

Remove direct calls to printf from the tls_check_hostname() path. This allows
NUL byte error messages to bubble up to the caller, to be logged in a
program-appropriate way. It also removes non-portable calls to getprogname().

ok jsing@@
@
text
@d1 1
a1 1
/*	$OpenBSD: verifytest.c,v 1.1 2014/11/01 11:55:27 jsing Exp $	*/
d25 1
a25 1
extern int tls_check_hostname(struct tls *ctx, X509 *cert, const char *host);
d32 1
a32 1
	const char hostname[128];
d39 1
a39 1
		.hostname = "www.openbsd.org",
d44 1
a44 1
		.hostname = "",
d49 1
a49 1
		.hostname = "www.openbsd.org",
d54 1
a54 1
		.hostname = "www.openbsd.org",
d59 1
a59 1
		.hostname = "www.openbsd.org",
d64 1
a64 1
		.hostname = "www.openbsd.org",
d69 1
a69 1
		.hostname = "www.openbsd.org",
d74 1
a74 1
		.hostname = "www.openbsd.org",
d79 1
a79 1
		.hostname = "www.openbsd.org",
d84 1
a84 1
		.hostname = "openbsd.org",
d89 1
a89 1
		.hostname = "1.2.3.4",
d94 1
a94 1
		.hostname = "1.2.3.4",
d99 1
a99 1
		.hostname = "cafe::beef",
d107 1
a107 1
		.hostname = "ftp.openbsd.org",
d115 1
a115 1
		.hostname = "www.openbsd.org",
d123 1
a123 1
		.hostname = "www.openbsd.org",
d131 1
a131 1
		.hostname = "1.2.3.4",
d139 1
a139 1
		.hostname = "1.2.3.4",
d150 1
a150 1
		.hostname = "cafe::beef",
d216 1
a216 1
	if (tls_check_hostname(tls, cert, vt->hostname) != vt->want) {
d218 2
a219 2
		    "'%s', alt name '%s' and hostname '%s'\n", test_no,
		    vt->common_name, vt->alt_name, vt->hostname);
@


1.1
log
@Initial regress for libtls hostname verification.
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d23 1
d25 1
a25 1
extern int tls_check_hostname(X509 *cert, const char *host);
d166 1
d179 2
d216 1
a216 1
	if (tls_check_hostname(cert, vt->hostname) != vt->want) {
@

