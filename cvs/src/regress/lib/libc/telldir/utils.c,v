head	1.1;
access;
symbols
	OPENBSD_6_0:1.1.0.12
	OPENBSD_6_0_BASE:1.1
	OPENBSD_5_9:1.1.0.2
	OPENBSD_5_9_BASE:1.1
	OPENBSD_5_8:1.1.0.10
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.8
	OPENBSD_5_7_BASE:1.1
	OPENBSD_5_6:1.1.0.6
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.4
	OPENBSD_5_5_BASE:1.1;
locks; strict;
comment	@ * @;


1.1
date	2013.11.03.00.20.24;	author schwarze;	state Exp;
branches;
next	;


desc
@@


1.1
log
@Add a second test, shortseek(), to make sure that seekdir() also works
correctly when moving the directory pointer by small distances.
This is currently failing, i will send an updated libc/gen patch
to fix this right afterwards.

Move the functions createfiles() and delfiles() to utils.{h,c} for reuse.
Minor cleanup in telldir.c.
@
text
@/*	$OpenBSD$	*/

/*	Written by Otto Moerbeek, 2006,  Public domain.	*/

#include <sys/types.h>
#include <sys/stat.h>
#include <dirent.h>
#include <err.h>
#include <fcntl.h>
#include <limits.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

#include "utils.h"

void
createfiles(int nfiles)
{
	int i, fd;
	char file[PATH_MAX];

	mkdir("d", 0755);
	for (i = 0; i < nfiles; i++) {
		snprintf(file, sizeof file, "d/%d", i);
		if ((fd = open(file, O_CREAT | O_WRONLY, 0600)) == -1)
			err(1, "open %s", file);
		close(fd);
	}
}

void
delfiles(void)
{
	DIR *dp;
	struct dirent *f;
	char file[PATH_MAX];

	dp = opendir("d");
	if (dp == NULL)
		err(1, "opendir");
	while (f = readdir(dp)) {
		if (strcmp(f->d_name, ".") == 0 ||
		    strcmp(f->d_name, "..") == 0)
			continue;
		snprintf(file, sizeof file, "d/%s", f->d_name);
		if (unlink(file) == -1)
			err(1, "unlink %s", f->d_name);
	}
	closedir(dp);
	if (rmdir("d") == -1)
		err(1, "rmdir");
}
@
