head	1.6;
access;
symbols
	OPENBSD_6_0:1.5.0.8
	OPENBSD_6_0_BASE:1.5
	OPENBSD_5_9:1.5.0.2
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.5.0.6
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.5.0.4
	OPENBSD_5_7_BASE:1.5
	OPENBSD_5_6:1.4.0.6
	OPENBSD_5_6_BASE:1.4
	OPENBSD_5_5:1.4.0.4
	OPENBSD_5_5_BASE:1.4
	OPENBSD_5_4:1.3.0.12
	OPENBSD_5_4_BASE:1.3
	OPENBSD_5_3:1.3.0.10
	OPENBSD_5_3_BASE:1.3
	OPENBSD_5_2:1.3.0.8
	OPENBSD_5_2_BASE:1.3
	OPENBSD_5_1_BASE:1.3
	OPENBSD_5_1:1.3.0.6
	OPENBSD_5_0:1.3.0.4
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_9:1.3.0.2
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.2.0.4
	OPENBSD_4_8_BASE:1.2
	OPENBSD_4_7:1.2.0.2
	OPENBSD_4_7_BASE:1.2
	OPENBSD_4_6:1.1.0.6
	OPENBSD_4_6_BASE:1.1
	OPENBSD_4_5:1.1.0.2
	OPENBSD_4_5_BASE:1.1;
locks; strict;
comment	@ * @;


1.6
date	2016.08.24.22.31.41;	author bluhm;	state dead;
branches;
next	1.5;
commitid	KP8unw6UeQJTXleN;

1.5
date	2015.02.09.12.01.41;	author deraadt;	state Exp;
branches;
next	1.4;
commitid	YoBWfZHGt7kD7yQt;

1.4
date	2013.08.09.21.07.22;	author bluhm;	state Exp;
branches;
next	1.3;

1.3
date	2011.01.11.13.07.40;	author bluhm;	state Exp;
branches;
next	1.2;

1.2
date	2010.02.14.12.30.29;	author miod;	state Exp;
branches;
next	1.1;

1.1
date	2008.08.22.00.48.33;	author bluhm;	state Exp;
branches;
next	;


desc
@@


1.6
log
@Move the pf address printing test into its own subdirectory.  This
makes it consistent with the regress tree structure.
@
text
@/*	$OpenBSD: pf_print_test.c,v 1.5 2015/02/09 12:01:41 deraadt Exp $ */

/*
 * Copyright (c) 2008, 2013 Alexander Bluhm <bluhm@@openbsd.org>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#include <sys/types.h>
#include <sys/socket.h>
#include <sys/wait.h>

#include <net/if.h>
#include <net/route.h>
#include <netinet/in.h>
#include <arpa/inet.h>

#include <net/pfvar.h>

#include <err.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define	INET	1
#define	INET6	1

void			pf_print_host(struct pf_addr *, u_int16_t, u_int8_t);
#define	addlog		printf

char *ipv6_addrs[] = {
	"::",
	"::1",
	"1::",
	"1::1",
	"0:1::1:0",
	"::1:2:0",
	"0:1::",
	"::1:0:0:0",
	"1:2:3:4:5:6:7:8",
	"0:2:3:4:5:6:7:8",
	"1:2:3:4:5:6:7:0",
	"1:0:3:0:5:0:7:8",
	"::3:4:5:6:7:8",
	"1:2:3:4:5:6::",
	"0:2:3::6:7:8",
	"1:2:0:4:5::8",
	"1::4:5:0:0:8",
	"1::5:0:0:8",
	"1:0:0:4::8",
	"::4:5:6:0:0",
	"0:0:3:4:5::",
	"::4:5:0:0:0",
	"1234:5678:90ab:cdef:1234:5678:90ab:cdef",
	NULL
};

int
main(int argc, char *argv[])
{
	char str[100];
	struct pf_addr addr;
	FILE *fpipe;
	char **in, *out;
	size_t len;
	pid_t pid;
	int fds[2];
	int status, ret = 0;

	for (in = ipv6_addrs; *in; in++) {
		if (!inet_pton(AF_INET6, *in, &addr.v6))
			errx(2, "inet_pton %s", *in);
		if (!inet_ntop(AF_INET6, &addr.v6, str, sizeof(str)))
			errx(2, "inet_ntop %s", *in);
		if (strcmp(*in, str) != 0) {
			warnx("not equal\nin:\t%s\nstr:\t%s", *in, str);
			ret = 2;
		}
		if (pipe(fds) == -1)
			err(2, "pipe");
		if ((pid = fork()) == -1)
			err(2, "fork");
		if (pid == 0) {
			close(fds[0]);
			if (dup2(fds[1], 1) == -1)
				err(2, "dup2");
			close(fds[1]);
			pf_print_host(&addr, 0, AF_INET6);
			fflush(stdout);
			_exit(0);
		}
		close(fds[1]);
		if ((fpipe = fdopen(fds[0], "r")) == NULL)
			err(2, "fdopen");
		if ((out = fgetln(fpipe, &len)) == NULL)
			err(2, "fgetln");
		if (out[len - 1] == '\n')
			out[len - 1] = '\0';
		else {
			char *tmp;
			/* EOF without EOL, copy and add the NUL */
			if ((tmp = malloc(len + 1)) == NULL)
				err(2, "malloc");
			memcpy(tmp, out, len);
			tmp[len] = '\0';
			out = tmp;
		}
		if (fclose(fpipe) == EOF)
			err(2, "fclose");
		if (wait(&status) <= 0)
			err(2, "wait");
		if (status != 0)
			errx(2, "child exit status: %d", status);
		if (strcmp(*in, out) != 0) {
			warnx("not equal\nin:\t%s\nout:\t%s", *in, out);
			ret = 1;
		}
	}
	return (ret);
}

#include "pf_print_host.c"
@


1.5
log
@sort includes correctly
@
text
@d1 1
a1 1
/*	$OpenBSD: pf_print_test.c,v 1.4 2013/08/09 21:07:22 bluhm Exp $ */
@


1.4
log
@Add RCS id and ISC license.
@
text
@d1 1
a1 1
/*	$OpenBSD$ */
a23 1
#include <net/pfvar.h>
d27 2
@


1.3
log
@Fix compiler warning in regression test.
@
text
@d1 18
@


1.2
log
@Sync with current state of the tree.
@
text
@d4 1
a4 1
#include <arpa/inet.h>
d9 1
@


1.1
log
@Test the IPv6 address printing of pf_print_host() in net/pf.c.
help and ok mpf
@
text
@d19 2
a20 1
void			 pf_print_host(struct pf_addr *, u_int16_t, u_int8_t);
@

