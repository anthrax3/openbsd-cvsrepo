head	1.2;
access;
symbols
	OPENBSD_6_1:1.1.0.4
	OPENBSD_6_1_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2017.07.11.00.25.19;	author bluhm;	state Exp;
branches;
next	1.1;
commitid	0VQSEMQi3RKFkwsk;

1.1
date	2016.08.16.22.25.08;	author vgross;	state Exp;
branches;
next	;
commitid	L5MVWgWH1T8jSGIx;


desc
@@


1.2
log
@Rewrite regress sendsrcaddr so that is uses UDP sockets on localhost,
does not try to connect to google and avoids BPF programming.
@
text
@# $OpenBSD: Makefile,v 1.1 2016/08/16 22:25:08 vgross Exp $

PROG =		runtest
CFLAGS =	-Wall
DESTADDR =	127.0.0.1
TESTIFACE =	vether12
TESTNET !!=	jot -s '.' 2 0 255
RESV_ADDR =	10.${TESTNET}.1
BIND_ADDR =	10.${TESTNET}.2
CMSG_ADDR =	10.${TESTNET}.3
NONE_ADDR =	10.${TESTNET}.4
CLEANFILES =	stamp-*

REGRESS_TARGETS =	run-regress-1 \
			run-regress-2 \
			run-regress-3 \
			run-regress-4 \
			run-regress-5 \
			run-regress-6 \
			run-regress-7 \
			run-regress-8 \
			run-regress-9 \
			run-regress-cleanup

stamp-setup:
	-! ${SUDO} ifconfig ${TESTIFACE} destroy
	${SUDO} ifconfig ${TESTIFACE} create
	${SUDO} ifconfig ${TESTIFACE} inet ${RESV_ADDR}/24 up
	${SUDO} ifconfig ${TESTIFACE} inet ${BIND_ADDR}/24 alias
	${SUDO} ifconfig ${TESTIFACE} inet ${CMSG_ADDR}/24 alias
	${SUDO} ifconfig ${TESTIFACE}
	date >$@@

run-regress-1: ${PROG} stamp-setup
	./${PROG} -D ${DESTADDR} -R ${RESV_ADDR} -B ${BIND_ADDR} -W ${BIND_ADDR}

run-regress-2: ${PROG} stamp-setup
	./${PROG} -D ${DESTADDR} -R ${RESV_ADDR} -B ${BIND_ADDR} -C ${CMSG_ADDR} -W ${CMSG_ADDR}

run-regress-3: ${PROG} stamp-setup
	./${PROG} -D ${DESTADDR} -R ${RESV_ADDR} -B ${BIND_ADDR} -C ${BIND_ADDR} -W ${BIND_ADDR}

run-regress-4: ${PROG} stamp-setup
	./${PROG} -D ${DESTADDR} -R ${RESV_ADDR} -B ${BIND_ADDR} -C ${NONE_ADDR} -E 49

run-regress-5: ${PROG} stamp-setup
	./${PROG} -D ${DESTADDR} -R ${RESV_ADDR} -B ${BIND_ADDR} -C ${RESV_ADDR} -E 48

run-regress-6: ${PROG} stamp-setup
	./${PROG} -D ${DESTADDR} -R ${RESV_ADDR} -B 0.0.0.0 -C ${BIND_ADDR} -W ${BIND_ADDR}

run-regress-7: ${PROG} stamp-setup
	./${PROG} -D ${DESTADDR} -R ${RESV_ADDR} -B 0.0.0.0 -C ${RESV_ADDR} -W ${RESV_ADDR}

run-regress-8: ${PROG} stamp-setup
	./${PROG} -D ${DESTADDR} -R ${RESV_ADDR} -B ${BIND_ADDR} -C 0.0.0.0 -W ${BIND_ADDR}

run-regress-9: ${PROG} stamp-setup
	./${PROG} -D ${DESTADDR} -R ${RESV_ADDR} -B ${BIND_ADDR} -C ${CMSG_ADDR} -f -E 22

run-regress-cleanup:
	rm -f stamp-setup
	-${SUDO} ifconfig ${TESTIFACE} destroy

.include <bsd.regress.mk>
@


1.1
log
@Add regression tests for IP_SENDSRCADDR.
@
text
@d1 1
a1 1
# $OpenBSD$
d3 10
a12 8
PROG	   = runtest
DESTADDR   = www.google.com
TESTIFACE  = vether12
TESTNET   != jot -r -s '.' 2 0 255
RESV_ADDR  = 10.${TESTNET}.1
BIND_ADDR  = 10.${TESTNET}.2
CMSG_ADDR  = 10.${TESTNET}.3
NONE_ADDR  = 10.${TESTNET}.4
d14 13
a26 1
run-regress-runtest: ${PROG}
a30 1
	sleep 1
d32 32
a63 10
	${.OBJDIR}/${PROG}  0 ${DESTADDR}=destination ${RESV_ADDR}=reserved_saddr ${BIND_ADDR}=bind_saddr
	${.OBJDIR}/${PROG}  0 ${DESTADDR}=destination ${RESV_ADDR}=reserved_saddr ${BIND_ADDR}=bind_saddr ${CMSG_ADDR}=cmsg_saddr,wire_saddr
	${.OBJDIR}/${PROG}  0 ${DESTADDR}=destination ${RESV_ADDR}=reserved_saddr ${BIND_ADDR}=bind_saddr ${BIND_ADDR}=cmsg_saddr,wire_saddr
	${.OBJDIR}/${PROG} 49 ${DESTADDR}=destination ${RESV_ADDR}=reserved_saddr ${BIND_ADDR}=bind_saddr ${NONE_ADDR}=cmsg_saddr
	${.OBJDIR}/${PROG} 48 ${DESTADDR}=destination ${RESV_ADDR}=reserved_saddr ${BIND_ADDR}=bind_saddr ${RESV_ADDR}=cmsg_saddr
	${.OBJDIR}/${PROG}  0 ${DESTADDR}=destination ${RESV_ADDR}=reserved_saddr 0.0.0.0=bind_saddr ${BIND_ADDR}=cmsg_saddr,wire_saddr
	${.OBJDIR}/${PROG}  0 ${DESTADDR}=destination ${RESV_ADDR}=reserved_saddr 0.0.0.0=bind_saddr ${RESV_ADDR}=cmsg_saddr,wire_saddr
	${.OBJDIR}/${PROG}  0 ${DESTADDR}=destination ${RESV_ADDR}=reserved_saddr ${BIND_ADDR}=bind_saddr 0.0.0.0=cmsg_saddr
	${.OBJDIR}/${PROG} 22 ${DESTADDR}=destination ${RESV_ADDR}=reserved_saddr ${BIND_ADDR}=bind_saddr ${CMSG_ADDR}=cmsg_saddr fuzz
	${SUDO} ifconfig ${TESTIFACE} destroy
@

