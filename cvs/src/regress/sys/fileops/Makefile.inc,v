head	1.1;
access;
symbols;
locks; strict;
comment	@# @;


1.1
date	2017.05.29.11.01.16;	author sf;	state Exp;
branches;
next	;
commitid	FXwPKnNAsiqtDvGB;


desc
@@


1.1
log
@Regress test for sparse files & mmap with different FSs

This test creates a file with a hole in the middle and then checks that
when reading or mmaping the whole file, the data is correct.

This catches the bug introduced by the
"Implement VFS read clustering for MSDOSFS" commit that hat to be
reverted.

For now, we run the test with FAT16, FAT32, FFS

With much advice from bluhm@@
@
text
@# $OpenBSD$

TESTS=		create read mmap

FILEOPS_MNT=	/mnt/regress-fileops
FILEOPS_PROG=	${.OBJDIR}/../fileops
IMG=		${.OBJDIR}/diskimage
CLEANFILES=	${IMG} stamp-*


.poison !defined (MOUNT)
.poison !defined (NEWFS)

.PHONY: disk mount unconfig clean

disk: unconfig
	dd if=/dev/urandom of=${IMG} bs=1M count=32
	vnconfig vnd0 ${IMG}
	${NEWFS} /dev/rvnd0c

mount: disk
	mkdir -p ${FILEOPS_MNT}
	${MOUNT} /dev/vnd0c ${FILEOPS_MNT}

unconfig:
	-umount -f /dev/vnd0c 2>/dev/null || true
	-rmdir ${FILEOPS_MNT} 2>/dev/null || true
	-vnconfig -u vnd0 2>/dev/null || true
	-rm -f stamp-setup ${IMG}

stamp-setup:
	@@echo '\n======== $@@ ========'
	${.MAKE} -C ${.CURDIR} mount
	date >$@@

${.OBJDIR}/../fileops:
	${.MAKE} -C ${.CURDIR}/.. fileops

.for t in ${TESTS}
REGRESS_TARGETS+=	run-regress-${t}
run-regress-${t}: stamp-setup ${.OBJDIR}/../fileops
	@@echo '\n======== $@@ ========'
	cd ${FILEOPS_MNT} && \
	    ${FILEOPS_PROG} ${t} ${FILEOPS_MNT}/file
.endfor

REGRESS_TARGETS+=	run-regress-cleanup
run-regress-cleanup:
	@@echo '\n======== $@@ ========'
	umount ${FILEOPS_MNT}
	${.MAKE} -C ${.CURDIR} unconfig
@
