head	1.2;
access;
symbols
	OPENBSD_6_1_BASE:1.2
	OPENBSD_6_0:1.2.0.26
	OPENBSD_6_0_BASE:1.2
	OPENBSD_5_9:1.2.0.16
	OPENBSD_5_9_BASE:1.2
	OPENBSD_5_8:1.2.0.24
	OPENBSD_5_8_BASE:1.2
	OPENBSD_5_7:1.2.0.22
	OPENBSD_5_7_BASE:1.2
	OPENBSD_5_6:1.2.0.20
	OPENBSD_5_6_BASE:1.2
	OPENBSD_5_5:1.2.0.18
	OPENBSD_5_5_BASE:1.2
	OPENBSD_5_4:1.2.0.14
	OPENBSD_5_4_BASE:1.2
	OPENBSD_5_3:1.2.0.12
	OPENBSD_5_3_BASE:1.2
	OPENBSD_5_2:1.2.0.10
	OPENBSD_5_2_BASE:1.2
	OPENBSD_5_1_BASE:1.2
	OPENBSD_5_1:1.2.0.8
	OPENBSD_5_0:1.2.0.6
	OPENBSD_5_0_BASE:1.2
	OPENBSD_4_9:1.2.0.4
	OPENBSD_4_9_BASE:1.2
	OPENBSD_4_8:1.2.0.2
	OPENBSD_4_8_BASE:1.2
	OPENBSD_4_7:1.1.0.10
	OPENBSD_4_7_BASE:1.1
	OPENBSD_4_6:1.1.0.12
	OPENBSD_4_6_BASE:1.1
	OPENBSD_4_5:1.1.0.8
	OPENBSD_4_5_BASE:1.1
	OPENBSD_4_4:1.1.0.6
	OPENBSD_4_4_BASE:1.1
	OPENBSD_4_3:1.1.0.4
	OPENBSD_4_3_BASE:1.1
	OPENBSD_4_2:1.1.0.2
	OPENBSD_4_2_BASE:1.1;
locks; strict;
comment	@ * @;


1.2
date	2010.06.20.17.56.07;	author phessler;	state Exp;
branches;
next	1.1;

1.1
date	2007.05.21.07.27.37;	author art;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Add some missing includes, so we do not have implicit function
declarations.

OK miod@@ stsp@@
@
text
@/*	$OpenBSD: mmap_mod.c,v 1.1 2007/05/21 07:27:37 art Exp $	*/

/*
 * Public domain. 2007, Artur Grabowski <art@@openbsd.org>
 */

#include <sys/types.h>
#include <sys/mman.h>
#include <err.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

/*
 * Test a corner case where a pmap can lose mod/ref bits after unmapping
 * and remapping a page.
 */
int
main()
{
	char name[20] = "/tmp/fluff.XXXXXX";
	char *buf, *pat;
	size_t ps;
	int fd;

	ps = getpagesize();

	if ((fd = mkstemp(name)) == -1)
		err(1, "mkstemp");

	if (unlink(name) == -1)
		err(1, "unlink");

	if (ftruncate(fd, ps))
		err(1, "ftruncate");

	if ((pat = malloc(ps)) == NULL)
		err(1, "malloc");

	memset(pat, 'a', ps);

	if (pwrite(fd, pat, ps, 0) != ps)
		err(1, "write");

	buf = mmap(NULL, ps, PROT_READ|PROT_WRITE, MAP_FILE|MAP_SHARED, fd, 0);
	if (buf == MAP_FAILED)
		err(1, "mmap");

	if (*buf != 'a')
		errx(1, "mapped area - no file data ('%c' != 'a')", *buf);

	memset(buf, 'x', ps);

	if (munmap(buf, ps) == -1)
		err(1, "munmap");

	buf = mmap(NULL, ps, PROT_READ|PROT_WRITE, MAP_FILE|MAP_SHARED, fd, 0);
	if (buf == MAP_FAILED)
		err(1, "mmap 2");

	if (*buf != 'x')
		errx(1, "mapped area lost modifications ('%c' != 'x')", *buf);

	if (msync(buf, ps, MS_SYNC) == -1)
		err(1, "msync");

	if (pread(fd, pat, ps, 0) != ps)
		err(1, "pread");

	if (*pat != 'x')
		errx(1, "synced area lost modifications ('%c' != 'x')", *pat);

	return (0);
}
@


1.1
log
@A test for a corner-case that some pmaps get wrong.
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d12 1
@

