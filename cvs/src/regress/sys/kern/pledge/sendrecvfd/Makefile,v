head	1.1;
access;
symbols
	OPENBSD_6_1:1.1.0.2
	OPENBSD_6_1_BASE:1.1;
locks; strict;
comment	@# @;


1.1
date	2017.02.22.11.30.00;	author tb;	state Exp;
branches;
next	;
commitid	oKn9vUrl4PNNmkaZ;


desc
@@


1.1
log
@Add regress tests for fd passing and pledge. Check sending and receiving
all 7 types of vnodes as follows:
  - nopledge:	 no pledge - verify that send/recv work as expected
  - sendfd:	 pledge the sender with "stdio sendfd"
  - recvfd:	 pledge the receiver with "stdio recvfd"
  - nosendfd:	 pledge the sender with "stdio" (it is expected to fail)
  - norecvfd:	 pledge the receiver with "stdio" (it is expected to fail)
This results in 35 possible combinations with different semantics depending
on the vnode type.

From semarie, many thanks!
@
text
@#	$OpenBSD$
CFLAGS+=	-Wall -Werror

testtype=	nopledge sendfd recvfd nosendfd norecvfd
vnodetype=	VREG VDIR VBLK VCHR VLNK VSOCK VFIFO

PASS_TARGETS=	test-nopledge-VREG \
		test-nopledge-VDIR \
		test-nopledge-VBLK \
		test-nopledge-VCHR \
		test-nopledge-VLNK \
		test-nopledge-VSOCK \
		test-nopledge-VFIFO \
		\
		test-sendfd-VREG \
		test-sendfd-VBLK \
		test-sendfd-VCHR \
		test-sendfd-VLNK \
		test-sendfd-VSOCK \
		test-sendfd-VFIFO \
		\
		test-recvfd-VREG \
		test-recvfd-VBLK \
		test-recvfd-VCHR \
		test-recvfd-VLNK \
		test-recvfd-VSOCK \
		test-recvfd-VFIFO

FAIL_TARGETS=	test-sendfd-VDIR \
		test-recvfd-VDIR \
		\
		test-nosendfd-VREG \
		test-nosendfd-VDIR \
		test-nosendfd-VBLK \
		test-nosendfd-VCHR \
		test-nosendfd-VLNK \
		test-nosendfd-VSOCK \
		test-nosendfd-VFIFO \
		\
		test-norecvfd-VREG \
		test-norecvfd-VDIR \
		test-norecvfd-VBLK \
		test-norecvfd-VCHR \
		test-norecvfd-VLNK \
		test-norecvfd-VSOCK \
		test-norecvfd-VFIFO

CLEANFILES+=	sendrecvfd

.for _test in ${testtype}
. for _vnode in ${vnodetype}
REGRESS_TARGETS+=	test-${_test}-${_vnode}

.  if ${PASS_TARGETS:Mtest-${_test}-${_vnode}} 
test-${_test}-${_vnode}: sendrecvfd
	@@echo test-${_test}-${_vnode}: expected PASS
	@@./sendrecvfd ${_test} ${_vnode}

.  elif ${FAIL_TARGETS:Mtest-${_test}-${_vnode}}
test-${_test}-${_vnode}: sendrecvfd
	@@echo test-${_test}-${_vnode}: expected FAIL
	@@if ./sendrecvfd ${_test} ${_vnode}; then false; else true; fi

.  else
test-${_test}-${_vnode}:
	@@echo "ERROR: test-${_test}-${_vnode} is missing"
	@@false
.  endif
. endfor
.endfor

.include <bsd.regress.mk>
@
