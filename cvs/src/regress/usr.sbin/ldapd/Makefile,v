head	1.8;
access;
symbols
	OPENBSD_6_2:1.8.0.2
	OPENBSD_6_2_BASE:1.8
	OPENBSD_6_1:1.7.0.4
	OPENBSD_6_1_BASE:1.7;
locks; strict;
comment	@# @;


1.8
date	2017.06.25.22.06.06;	author bluhm;	state Exp;
branches;
next	1.7;
commitid	LeQRWps9eiCpHIVu;

1.7
date	2017.02.22.14.36.20;	author gsoares;	state Exp;
branches;
next	1.6;
commitid	WAX2blaKbzC0Fl8l;

1.6
date	2017.01.26.02.06.37;	author jmatthew;	state Exp;
branches;
next	1.5;
commitid	O02vn7QZUWGxdyW2;

1.5
date	2016.09.28.18.00.01;	author bluhm;	state Exp;
branches;
next	1.4;
commitid	nUAlpvi9d2NUjq8q;

1.4
date	2016.09.18.21.00.15;	author bluhm;	state Exp;
branches;
next	1.3;
commitid	7RGN4zAOILqUmUIG;

1.3
date	2016.09.10.06.45.35;	author landry;	state Exp;
branches;
next	1.2;
commitid	PTjC0WZ2mbEpOrKS;

1.2
date	2016.09.05.06.20.29;	author landry;	state Exp;
branches;
next	1.1;
commitid	uKDLOuf5Bv7GqDlU;

1.1
date	2016.09.01.14.59.52;	author landry;	state Exp;
branches;
next	;
commitid	oylhQRvIFkmVfvOa;


desc
@@


1.8
log
@Do not run .END cleanup during clean, cleandir, obj in ldapd regress.
@
text
@# $OpenBSD: Makefile,v 1.7 2017/02/22 14:36:20 gsoares Exp $

OUT=${.CURDIR}/out
DIT=dc=example,dc=com
DIT2=dc=bar,dc=quux
NLV=0.65
CLEANFILES=ldapd.pid log ldapd1.conf ${DIT}_indx.db ${DIT}_data.db ${DIT2}_indx.db ${DIT2}_data.db

# Needs p5-ldap and openldap (client)

PERL_REQUIRE !=	perl -Mstrict -Mwarnings -e ' \
    eval { require Net::LDAP } or print $@@; \
'
.if ! empty (PERL_REQUIRE)
regress:
	@@echo "${PERL_REQUIRE}"
	@@echo install package p5-ldap
	@@echo SKIPPED
.endif

.if ! (make(clean) || make(cleandir) || make(obj))
LDAP_DEP != ldapsearch -VV 2>/dev/null ; echo $?
.endif
.if ("${LDAP_DEP}" != 0)
regress:
	@@echo openldap-client must be installed
	@@echo SKIPPED
.endif

REGRESS_TARGETS = connect import perl purge #cpan

bootstrap:
	@@[ -z "${SUDO}" ] || ${SUDO} true
	@@${SUDO} install -m 600 -o root ${.CURDIR}/ldapd.conf ${.OBJDIR}/ldapd1.conf
	@@${SUDO} ldapd -n -r ${.OBJDIR} -f ${.OBJDIR}/ldapd1.conf
	@@${SUDO} ldapd -dvv -r ${.OBJDIR} -f ${.OBJDIR}/ldapd1.conf > ${.OBJDIR}/log 2>&1 &
	@@sleep 1
	@@grep -a startup ${.OBJDIR}/log |sed -e 's/.*\[// ; s/\].*//' > ${.OBJDIR}/ldapd.pid

.if ! (make(clean) || make(cleandir) || make(obj))
.END:
	@@[ -f ${.OBJDIR}/ldapd.pid ] &&\
	    ${SUDO} kill $$(cat ${.OBJDIR}/ldapd.pid) &&\
	    rm ${.OBJDIR}/ldapd.pid
.endif

connect: bootstrap
	-ldapsearch -x -H ldapi://%2ftmp%2fldapi | diff - ${OUT}/empty.log
	-ldapsearch -x -p 6639 -h localhost 2>&1 | diff - ${OUT}/empty.log
	-ldapsearch -x -p 6636 -h localhost 2>&1 | diff - ${OUT}/empty.log

import: bootstrap
	ldapadd -f ${.CURDIR}/dit-example.ldif -Dcn=admin,${DIT} -x -w secret -h localhost -p 6639 | diff - ${OUT}/adding.log
	ldapsearch -x -b ${DIT} -h localhost -p 6639 | diff - ${OUT}/example.log
	ldapsearch -x -D cn=admin,${DIT} -w secret -b ${DIT} -h localhost -p 6639 | diff - ${OUT}/example.log

purge: bootstrap
	ldapdelete -Dcn=admin,${DIT} -x -w secret -h localhost -p 6639 -r ${DIT}
	-ldapsearch -x -p 6639 -h localhost 2>&1 | diff - ${OUT}/empty.log

perl: bootstrap
	@@-perl ${.CURDIR}/run-tests.pl

# run tests from Net::LDAP
# requires all of databases/p5-ldap RUN_DEPENDS
# tests above 41 fail because ldapd doesnt handle uppercase namespaces
cpan: bootstrap
	tar -C ${.OBJDIR} -xzf /usr/ports/distfiles/perl-ldap-${NLV}.tar.gz
	@@${SUDO} install -m 600 -o root ${.CURDIR}/nldapd.conf ${.OBJDIR}/perl-ldap-${NLV}
	cp common.pl ${.OBJDIR}/perl-ldap-${NLV}/t
	cd ${.OBJDIR}/perl-ldap-${NLV} && perl Makefile.PL --skipdeps
	sed -i -e 's/OpenLDAPperson/inetOrgPerson/' ${.OBJDIR}/perl-ldap-${NLV}/data/*.ldif
	@@-${SUDO} ${MAKE} -C ${.OBJDIR}/perl-ldap-${NLV} test

.include <bsd.regress.mk>
@


1.7
log
@ldapd regress tests depends on openldap-client, check
if that package is installed, otherwise print
a warning and skip them but not fail.

requested by/ok mpi@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.6 2017/01/26 02:06:37 jmatthew Exp $
d40 1
d42 4
a45 1
	@@[ -f ${.OBJDIR}/ldapd.pid ] && ${SUDO} kill $$(cat ${.OBJDIR}/ldapd.pid) && rm ${.OBJDIR}/ldapd.pid
@


1.6
log
@Each entry in REGRESS_TARGETS is run in a separate make process, so the
.END target will kill ldapd after each one.  To compensate, make each test
target depend on bootstrap to ensure ldapd is running.  In .END, remove the
pid file after killing ldapd so reduce noise.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.5 2016/09/28 18:00:01 bluhm Exp $
d18 9
@


1.5
log
@The ldap regression test should behave more like the other tests.
So use REGRESS_TARGETS provided by bsd.regress.mk.
OK landry@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.4 2016/09/18 21:00:15 bluhm Exp $
d21 1
a21 1
REGRESS_TARGETS = bootstrap connect import perl purge #cpan
d30 1
d32 1
a32 1
	@@[ -f ${.OBJDIR}/ldapd.pid ] && ${SUDO} kill $$(cat ${.OBJDIR}/ldapd.pid)
d34 1
a34 1
connect:
d39 1
a39 1
import:
d44 1
a44 1
purge: import
d48 1
a48 1
perl:
d54 1
a54 1
cpan:
@


1.4
log
@Test should print SKIPPED if a package is missing.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.3 2016/09/10 06:45:35 landry Exp $
a18 2
.else
regress: bootstrap connect import perl purge #cpan
d20 2
@


1.3
log
@Improve Makefile by using ${.OBJDIR} and stop creating files in
${.CURDIR}. Don't start the server in .BEGIN - make obj should only
create the symlink. Add CLEANFILES for proper cleaning.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.2 2016/09/05 06:20:29 landry Exp $
d17 4
a20 2
	@@echo install p5-ldap
	@@exit 1
a31 2

all: bootstrap connect import perl purge #cpan
@


1.2
log
@Add purge to the all: target and comment out cpan for now
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.1 2016/09/01 14:59:52 landry Exp $
a2 1
LOG=${.CURDIR}/log
a3 1
WRK!=mktemp -d
d7 1
d21 1
a21 1
.BEGIN:
d23 3
a25 3
	@@${SUDO} install -m 600 -o root ${.CURDIR}/ldapd.conf ${WRK}
	@@${SUDO} ldapd -n -r ${WRK} -f ${WRK}/ldapd.conf
	@@${SUDO} ldapd -dvv -r ${WRK} -f ${WRK}/ldapd.conf > ${LOG} 2>&1 &
d27 1
a27 1
	@@grep -a startup ${LOG} |sed -e 's/.*\[// ; s/\].*//' > ldapd.pid
d29 1
a29 2
	@@${SUDO} kill $$(cat ldapd.pid)
	@@-${SUDO} rm -Rf ${WRK}
d31 1
a31 4
clean:
	@@-${SUDO} rm -Rf ${WRK}

all: connect import perl purge #cpan
d48 1
a48 1
	@@-perl run-tests.pl
d54 6
a59 6
	tar -C ${WRK} -xzf /usr/ports/distfiles/perl-ldap-${NLV}.tar.gz
	@@${SUDO} install -m 600 -o root ${.CURDIR}/nldapd.conf ${WRK}/perl-ldap-${NLV}
	cp common.pl ${WRK}/perl-ldap-${NLV}/t
	cd ${WRK}/perl-ldap-${NLV} && perl Makefile.PL --skipdeps
	sed -i -e 's/OpenLDAPperson/inetOrgPerson/' ${WRK}/perl-ldap-${NLV}/data/*.ldif
	@@-${SUDO} ${MAKE} -C ${WRK}/perl-ldap-${NLV} test
@


1.1
log
@Add basic regress tests for ldapd.

- first pass of tests adding a DIT, then searching in it
- second pass of tests runs Net::LDAP regress suite against ldapd (not
  all tests are passing, and that requires Net::LDAP installed and
distfiles present on the system)
@
text
@d1 1
a1 1
# $OpenBSD$
d36 1
a36 1
all: connect import perl cpan
@

