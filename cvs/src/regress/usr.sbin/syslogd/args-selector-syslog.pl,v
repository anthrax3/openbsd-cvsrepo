head	1.3;
access;
symbols
	OPENBSD_6_2:1.3.0.4
	OPENBSD_6_2_BASE:1.3;
locks; strict;
comment	@# @;


1.3
date	2017.09.12.15.24.21;	author bluhm;	state Exp;
branches;
next	1.2;
commitid	fQcw2c9T4xGELf8r;

1.2
date	2017.04.07.15.49.46;	author bluhm;	state Exp;
branches;
next	1.1;
commitid	UeGzQyxdfaHiOc9Q;

1.1
date	2017.04.06.16.56.44;	author bluhm;	state Exp;
branches;
next	;
commitid	ksZqqvb6rOiQTz4j;


desc
@@


1.3
log
@Syslogd does no longer keep the *:514 UDP sockets open by default.
Adapt tests.
@
text
@# The client connects with TCP.
# The syslogd writes local messages into multiple files depending on priority.
# The syslogd writes it into a file and through a pipe.
# The syslogd passes it via UDP to the loghost.
# The server receives the message on its UDP socket.
# Find the message in client, file, pipe, syslogd, server log.
# Check that local syslog messages end up the correct priority file.

use strict;
use warnings;
use Socket;
use Sys::Syslog;

my %selector2messages = (
    "syslog.*"       =>
	[qw{ start .*accepted .*close .*accepted .*peer exiting.* }],
    "syslog.debug"   =>
	[qw{ start .*accepted .*close .*accepted .*peer exiting.* }],
    "syslog.info"    => [qw{ start .*peer exiting.* }],
    "syslog.notice"  => [qw{ .*peer exiting.* }],
    "syslog.warning" => [qw{ exiting.* }],
    "syslog.err"     => [qw{ exiting.* }],
    "syslog.crit"    => [],
    "syslog.alert"   => [],
    "syslog.emerg"   => [],
    "syslog.none"    => [],
);

our %args = (
    client => {
	connect => { domain => AF_INET, proto => "tcp", addr => "127.0.0.1",
	    port => 514 },
	redo => 2,
	func => sub {
	    my $self = shift;
	    $self->{redo}--;
	    if ($self->{redo}) {
		write_message($self, get_testlog());
		IO::Handle::flush(\*STDOUT);
		${$self->{syslogd}}->loggrep(get_testgrep(), 2);
	    } else {
		write_message($self, get_testlog());
		IO::Handle::flush(\*STDOUT);
		${$self->{syslogd}}->loggrep(get_testgrep(), 2);
		setsockopt(STDOUT, SOL_SOCKET, SO_LINGER, pack('ii', 1, 0))
		    or die "set socket linger failed: $!";
		write_shutdown($self);
	    }
	},
    },
    syslogd => {
	options => ["-T", "127.0.0.1:514"],
	conf => selector2config(%selector2messages),
    },
    multifile => [
	(map { { loggrep => $_ } } (selector2loggrep(%selector2messages))),
    ],
);

1;
@


1.2
log
@Adapt test to new syslogd's local message priority.
@
text
@d11 1
@


1.1
log
@Check that local syslog messages have the the expected priority.
@
text
@d14 6
a19 4
    "syslog.*"       => [qw{ start .*accepted .*close exiting.* }],
    "syslog.debug"   => [qw{ start .*accepted .*close exiting.* }],
    "syslog.info"    => [qw{ start .*accepted .*close exiting.* }],
    "syslog.notice"  => [qw{ exiting.* }],
d30 19
a48 1
	logsock => { type => "tcp", host => "127.0.0.1", port => 514 },
@

