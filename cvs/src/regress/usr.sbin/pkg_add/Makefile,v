head	1.53;
access;
symbols
	OPENBSD_6_1:1.52.0.8
	OPENBSD_6_1_BASE:1.52
	OPENBSD_6_0:1.52.0.4
	OPENBSD_6_0_BASE:1.52
	OPENBSD_5_9:1.52.0.2
	OPENBSD_5_9_BASE:1.52
	OPENBSD_5_8:1.51.0.10
	OPENBSD_5_8_BASE:1.51
	OPENBSD_5_7:1.51.0.8
	OPENBSD_5_7_BASE:1.51
	OPENBSD_5_6:1.51.0.6
	OPENBSD_5_6_BASE:1.51
	OPENBSD_5_5:1.51.0.4
	OPENBSD_5_5_BASE:1.51
	OPENBSD_5_4:1.50.0.4
	OPENBSD_5_4_BASE:1.50
	OPENBSD_5_3:1.50.0.2
	OPENBSD_5_3_BASE:1.50
	OPENBSD_5_2:1.49.0.2
	OPENBSD_5_2_BASE:1.49
	OPENBSD_5_1_BASE:1.48
	OPENBSD_5_1:1.48.0.2
	OPENBSD_5_0:1.47.0.2
	OPENBSD_5_0_BASE:1.47
	OPENBSD_4_9:1.40.0.2
	OPENBSD_4_9_BASE:1.40
	OPENBSD_4_8:1.39.0.2
	OPENBSD_4_8_BASE:1.39
	OPENBSD_4_7:1.37.0.2
	OPENBSD_4_7_BASE:1.37
	OPENBSD_4_6:1.3.0.16
	OPENBSD_4_6_BASE:1.3
	OPENBSD_4_5:1.3.0.12
	OPENBSD_4_5_BASE:1.3
	OPENBSD_4_4:1.3.0.10
	OPENBSD_4_4_BASE:1.3
	OPENBSD_4_3:1.3.0.8
	OPENBSD_4_3_BASE:1.3
	OPENBSD_4_2:1.3.0.6
	OPENBSD_4_2_BASE:1.3
	OPENBSD_4_1:1.3.0.4
	OPENBSD_4_1_BASE:1.3
	OPENBSD_4_0:1.3.0.2
	OPENBSD_4_0_BASE:1.3
	OPENBSD_3_9:1.2.0.10
	OPENBSD_3_9_BASE:1.2
	OPENBSD_3_8:1.2.0.8
	OPENBSD_3_8_BASE:1.2
	OPENBSD_3_7:1.2.0.6
	OPENBSD_3_7_BASE:1.2
	OPENBSD_3_6:1.2.0.4
	OPENBSD_3_6_BASE:1.2
	OPENBSD_3_5:1.2.0.2
	OPENBSD_3_5_BASE:1.2;
locks; strict;
comment	@# @;


1.53
date	2017.07.12.15.21.12;	author bluhm;	state Exp;
branches;
next	1.52;
commitid	jbFKHXtTJw37HGwu;

1.52
date	2016.01.22.16.45.52;	author landry;	state Exp;
branches;
next	1.51;
commitid	JzlN0BWTSDa9nc0q;

1.51
date	2014.01.31.10.13.13;	author espie;	state Exp;
branches;
next	1.50;

1.50
date	2012.08.17.23.40.02;	author espie;	state Exp;
branches;
next	1.49;

1.49
date	2012.05.05.10.19.10;	author espie;	state Exp;
branches;
next	1.48;

1.48
date	2011.12.03.16.16.26;	author espie;	state Exp;
branches;
next	1.47;

1.47
date	2011.07.13.11.57.10;	author espie;	state Exp;
branches;
next	1.46;

1.46
date	2011.07.12.23.33.42;	author espie;	state Exp;
branches;
next	1.45;

1.45
date	2011.07.12.23.17.21;	author espie;	state Exp;
branches;
next	1.44;

1.44
date	2011.07.02.10.31.21;	author espie;	state Exp;
branches;
next	1.43;

1.43
date	2011.05.27.12.24.45;	author espie;	state Exp;
branches;
next	1.42;

1.42
date	2011.05.21.21.59.40;	author landry;	state Exp;
branches;
next	1.41;

1.41
date	2011.05.17.19.54.29;	author landry;	state Exp;
branches;
next	1.40;

1.40
date	2010.12.24.10.36.48;	author espie;	state Exp;
branches;
next	1.39;

1.39
date	2010.08.07.19.39.33;	author espie;	state Exp;
branches;
next	1.38;

1.38
date	2010.05.01.09.03.05;	author espie;	state Exp;
branches;
next	1.37;

1.37
date	2010.01.24.15.33.38;	author espie;	state Exp;
branches;
next	1.36;

1.36
date	2010.01.18.12.58.12;	author espie;	state Exp;
branches;
next	1.35;

1.35
date	2010.01.14.19.38.37;	author espie;	state Exp;
branches;
next	1.34;

1.34
date	2010.01.14.13.55.58;	author espie;	state Exp;
branches;
next	1.33;

1.33
date	2010.01.10.16.06.10;	author espie;	state Exp;
branches;
next	1.32;

1.32
date	2010.01.10.12.41.20;	author espie;	state Exp;
branches;
next	1.31;

1.31
date	2010.01.10.11.49.56;	author espie;	state Exp;
branches;
next	1.30;

1.30
date	2010.01.03.23.51.40;	author espie;	state Exp;
branches;
next	1.29;

1.29
date	2010.01.01.16.36.17;	author espie;	state Exp;
branches;
next	1.28;

1.28
date	2009.12.31.13.31.53;	author espie;	state Exp;
branches;
next	1.27;

1.27
date	2009.12.31.12.58.22;	author espie;	state Exp;
branches;
next	1.26;

1.26
date	2009.12.31.12.12.59;	author espie;	state Exp;
branches;
next	1.25;

1.25
date	2009.12.31.11.32.09;	author espie;	state Exp;
branches;
next	1.24;

1.24
date	2009.12.31.10.46.15;	author espie;	state Exp;
branches;
next	1.23;

1.23
date	2009.12.12.17.15.58;	author espie;	state Exp;
branches;
next	1.22;

1.22
date	2009.12.12.07.06.45;	author espie;	state Exp;
branches;
next	1.21;

1.21
date	2009.12.11.20.57.45;	author espie;	state Exp;
branches;
next	1.20;

1.20
date	2009.12.11.13.02.59;	author espie;	state Exp;
branches;
next	1.19;

1.19
date	2009.12.03.18.45.50;	author espie;	state Exp;
branches;
next	1.18;

1.18
date	2009.12.02.11.40.12;	author espie;	state Exp;
branches;
next	1.17;

1.17
date	2009.12.02.11.21.42;	author espie;	state Exp;
branches;
next	1.16;

1.16
date	2009.11.22.12.57.35;	author espie;	state Exp;
branches;
next	1.15;

1.15
date	2009.11.22.12.44.06;	author espie;	state Exp;
branches;
next	1.14;

1.14
date	2009.11.22.11.32.17;	author espie;	state Exp;
branches;
next	1.13;

1.13
date	2009.11.16.15.15.15;	author espie;	state Exp;
branches;
next	1.12;

1.12
date	2009.11.15.08.50.59;	author espie;	state Exp;
branches;
next	1.11;

1.11
date	2009.11.15.08.46.07;	author espie;	state Exp;
branches;
next	1.10;

1.10
date	2009.11.15.08.38.19;	author espie;	state Exp;
branches;
next	1.9;

1.9
date	2009.11.14.21.04.24;	author espie;	state Exp;
branches;
next	1.8;

1.8
date	2009.11.14.20.48.14;	author espie;	state Exp;
branches;
next	1.7;

1.7
date	2009.11.14.10.25.53;	author espie;	state Exp;
branches;
next	1.6;

1.6
date	2009.11.14.10.13.32;	author espie;	state Exp;
branches;
next	1.5;

1.5
date	2009.11.14.10.09.24;	author espie;	state Exp;
branches;
next	1.4;

1.4
date	2009.11.14.09.34.56;	author espie;	state Exp;
branches;
next	1.3;

1.3
date	2006.08.18.13.14.34;	author espie;	state Exp;
branches;
next	1.2;

1.2
date	2004.03.02.06.55.26;	author david;	state Exp;
branches;
next	1.1;

1.1
date	2004.02.21.19.07.29;	author espie;	state Exp;
branches;
next	;


desc
@@


1.53
log
@Disable failing pkg_add tests and document when they were added.
Targets are still executed, but are expected to fail.
@
text
@# $OpenBSD: Makefile,v 1.52 2016/01/22 16:45:52 landry Exp $

REGRESS_TARGETS=pkgnames pkgpaths signatures depends-check longnames pkgcfl \
	collision-check1-disabled collision-check2-disabled collision-check3 \
	collision-check4 collision-check5-disabled collision-check6-disabled \
	collision-check7-disabled \
	update-check1 partial-update-test conflict-update \
	merge-update split-update big-merge family-circus missing \
	lib-report1 lib-report2 lib-report3 loop1 \
	lib-report4 lib-report5 lib-report6 lib-report7 \
	qttest gstest exotest-disabled inter1 manual1 oldlib1

collision-check{1,2}-disabled:
	@@! ${MAKE} -C ${.CURDIR} ${@@:S/-disabled$//}
	# Failing test ${@@:S/-disabled$//} added in rev 1.8.
	# more half-baked regress-targets
	@@echo DISABLED

collision-check5-disabled:
	@@! ${MAKE} -C ${.CURDIR} ${@@:S/-disabled$//}
	# Failing test ${@@:S/-disabled$//} added in rev 1.35.
	# new test for vstat
	@@echo DISABLED

collision-check6-disabled:
	@@! ${MAKE} -C ${.CURDIR} ${@@:S/-disabled$//}
	# Failing test ${@@:S/-disabled$//} added in rev 1.9.
	# more tests
	@@echo DISABLED

collision-check7-disabled:
	@@! ${MAKE} -C ${.CURDIR} ${@@:S/-disabled$//}
	# Failing test added in rev 1.48.
	# pure display check, not linked since it fails
	@@echo DISABLED

exotest-disabled:
	@@! ${MAKE} -C ${.CURDIR} ${@@:S/-disabled$//}
	# Failing test ${@@:S/-disabled$//} added in rev 1.41.
	# Workaround in ports/x11/xfce4/exo/Makefile rev 1.32.
	@@echo DISABLED

ADD_PKG=perl ${.CURDIR}/my add
DELETE_PKG=perl ${.CURDIR}/my delete
INFO_PKG=perl ${.CURDIR}/my info
CREATE_PKG=perl ${.CURDIR}/mycreate
LONG1=iamareallongfilenamethatcantberepresentedcorrectlyinatararchivebutwewantittohappenanywaysohmygodaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa42
LONG2=iamanotherreallygfilenamethatcantberepresentedcorrectlyinatararchivebutwewantittohappenanywaysohmygodaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa42
LONG3=iamanotherreallylonglinkthatcantberepresentedcorrectlyinatararchivebutwewantittohappenanywaysohmygodaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa42
LONG4=iamanotherreallylonghardlinkthatcantberepresentedcorrectlyinatararchivebutwewantittohappenanywaysohmygodaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa42

.for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 \
    26 27 28 29 30 31 32 33 34 35
S$i ?= ${.OBJDIR}/src$i
SRC$i ?= ${S$i}/usr/local
D$i ?= ${.OBJDIR}/dest$i
DEST$i ?= ${D$i}/usr/local
.endfor

# current maxes (used): D33, SRC23, plist21
pkgnames:
	perl ${.CURDIR}/check-name

pkgcfl:
	perl ${.CURDIR}/check-cfl

pkgpaths:
	perl ${.CURDIR}/check-path

signatures: 
	-rm -f signatures.out
	perl ${.CURDIR}/check-sig 2>signatures.out
	diff -u signatures.out ${.CURDIR}/signatures.ref

depends-check: rep0/a-0.tgz rep0/b-0.tgz rep1/a-1.tgz rep1/b-1.tgz
	@@-rm -rf ${D1}
	@@ROOT=${D1} ${ADD_PKG} rep0/a-0.tgz rep0/b-0.tgz
	@@ROOT=${D1} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -u a b
	@@ROOT=${D1} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} -D downgrade -u a b

longnames: rep1/c-0.tgz
	@@-rm -rf ${D2}
	@@ROOT=${D2} ${ADD_PKG} rep1/c-0.tgz
	@@test -f ${DEST2}/${LONG1}
	@@test -f ${DEST2}/${LONG2}
	@@cd ${DEST2} && test -h ${LONG3} && test `readlink ${LONG3}` = ${LONG2}
	@@cd ${DEST2} && test `stat -f '%i' ${LONG1}` = `stat -f '%i' ${LONG4}`

collision-check1: rep1/d-0.tgz rep1/e-0.tgz
	@@-rm -rf ${D3}
	@@ROOT=${D3} ${ADD_PKG} rep1/d-0.tgz
	@@ROOT=${D3} ${ADD_PKG} rep1/e-0.tgz

collision-check2: rep1/d-0.tgz rep1/e-0.tgz
	@@-rm -rf ${D4}
	@@ROOT=${D4} ${ADD_PKG} rep1/d-0.tgz
	@@-rm -rf ${D4}/pkgdb/d-0
	@@ROOT=${D4} ${ADD_PKG} -I rep1/e-0.tgz

collision-check3: rep1/d-0.tgz rep1/f-0.tgz
	@@-rm -rf ${D5}
	@@ROOT=${D5} ${ADD_PKG} rep1/d-0.tgz rep1/f-0.tgz
	@@-rm -rf ${D5}/pkgdb/d-0
	@@ROOT=${D5} ${ADD_PKG} -D repair rep1/d-0.tgz
	PKG_DBDIR=${D5}/pkgdb pkg_info -qR d

collision-check4: rep1/d-0.tgz rep1/e-0.tgz
	@@-rm -rf ${D6}
	@@ROOT=${D6} ${ADD_PKG} rep1/d-0.tgz
	@@-rm -rf ${D6}/pkgdb/d-0
	@@ROOT=${D6} ${ADD_PKG} -D repair rep1/e-0.tgz

collision-check5: rep1/d-0.tgz rep1/e-0.tgz
	@@-rm -rf ${D21}
	@@ROOT=${D21} ${ADD_PKG} -n rep1/d-0.tgz rep1/e-0.tgz

collision-check6: rep1/d-0.tgz rep1/e-0.tgz
	@@-rm -rf ${D7}
	@@ROOT=${D7} ${ADD_PKG} rep1/d-0.tgz
	@@-rm -rf ${D7}/pkgdb/d-0
	@@ROOT=${D7} ${ADD_PKG} -D removecollisions rep1/d-0.tgz

collision-check7: rep0/cola-0.tgz rep1/cola-1.tgz rep1/colb-0.tgz
	@@-rm -rf ${D32}
	@@ROOT=${D32} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} cola-0
	@@ROOT=${D32} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -r cola-1

update-check1: rep0/g-0.tgz rep1/g-0.tgz rep0/ga-0.tgz rep1/ga-0.tgz \
	rep0/gb-0.tgz rep1/gb-0p0.tgz rep0/gc-0.tgz rep1/gc-0.tgz \
	rep0/gd-0.tgz rep1/gd-1.tgz rep0/ge-0.tgz rep1/ge-1.tgz \
	rep0/gf-1.tgz rep1/gf-0.tgz rep0/gg-0.tgz rep1/gg-0.tgz
	@@-rm -rf ${D8}
	@@ROOT=${D8} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} g ga gb gc gd ge gf gg
	@@-ROOT=${D8} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -Iu
	@@PKG_DBDIR=${D8}/pkgdb pkg_info |diff - ${.CURDIR}/list7.out
	@@ROOT=${D8} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -u -Dupdate_gd
	@@PKG_DBDIR=${D8}/pkgdb pkg_info |diff - ${.CURDIR}/list8.out

list-check: rep1/a-1.tgz rep1/b-1.tgz rep1/c-0.tgz rep1/d-0.tgz \
	rep1/e-0.tgz rep1/f-0.tgz rep1/g-0.tgz
	@@-rm -rf ${D9}
	@@ROOT=${D9} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -l ${.CURDIR}/list
	@@PKG_DBDIR=${D9}/pkgdb pkg_info -q|diff - ${.CURDIR}/list.out

partial-update-test: rep0/h-0.tgz rep0/i-0.tgz rep0/j-0.tgz \
	rep1/h-1.tgz rep1/i-1.tgz rep1/j-1.tgz
	@@-rm -rf ${D10}
	@@ROOT=${D10} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} h j
	@@ROOT=${D10} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -u h
	@@PKG_DBDIR=${D10}/pkgdb pkg_info -q|diff - ${.CURDIR}/list2.out

conflict-update: rep0/k-0.tgz rep0/l-0.tgz rep1/k-1.tgz rep1/l-1.tgz
	@@-rm -rf ${D11}
	@@ROOT=${D11} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} k l
	@@ROOT=${D11} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -u k
	@@PKG_DBDIR=${D11}/pkgdb pkg_info -q|diff - ${.CURDIR}/list3.out

merge-update: rep0/m-0.tgz rep0/n-0.tgz rep1/m-1.tgz rep1/n-1.tgz
	@@-rm -rf ${D12}
	@@ROOT=${D12} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} m n
	@@ROOT=${D12} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -u n
	@@PKG_DBDIR=${D12}/pkgdb pkg_info -q|diff - ${.CURDIR}/list4.out

split-update: rep0/o-0.tgz rep1/o-1.tgz rep1/p-0.tgz
	@@-rm -rf ${D13}
	@@ROOT=${D13} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} o
	@@ROOT=${D13} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -u o
	@@PKG_DBDIR=${D13}/pkgdb pkg_info -q |diff - ${.CURDIR}/list5.out

big-merge: rep0/q1-0.tgz rep0/q2-0.tgz rep0/q3-0.tgz rep0/q4-0.tgz \
	rep0/q5-0.tgz rep0/q6-0.tgz rep1/q5-1.tgz rep1/q6-1.tgz \
	rep1/q1-1.tgz rep1/q2-1.tgz rep1/q3-1.tgz rep1/q4-1.tgz
	@@-rm -rf ${D14}
	@@ROOT=${D14} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} q1 q2 q3 q4 q5 q6
	@@ROOT=${D14} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -x -D update -u 2>&1 |fgrep XXX|fgrep -v @@|diff - ${.CURDIR}/list6.out

family-circus: rep0/glib-0.tgz rep0/fam-0.tgz rep1/fam-1.tgz rep1/glib-1.tgz rep1/gamin-0.tgz
	@@-rm -rf ${D15}
	@@ROOT=${D15} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} glib
	@@ROOT=${D15} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -u glib

missing: rep1/missa-0.tgz rep1/missb-0.tgz rep1/missc-0.tgz rep1/missd-0.tgz rep1/missf-0.tgz
	@@-rm -rf ${D16}
	@@ROOT=${D16} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} missc
	@@-ROOT=${D15} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} missa missb missf

lib-report1: rep0/o1-0.tgz rep1/o1-1.tgz rep1/p1-0.tgz
	@@-rm -rf ${D17}
	@@ROOT=${D17} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} o1
	-@@ROOT=${D17} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -u o1

lib-report2: rep0/o2-0.tgz rep1/o2-1.tgz rep1/p2-0.tgz
	@@-rm -rf ${D18}
	@@ROOT=${D18} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} o2
	-@@ROOT=${D18} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -u o2

lib-report3: rep0/o3-0.tgz
	@@-rm -rf ${D19}
	-@@ROOT=${D19} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} o3

lib-report4: rep0/o4-0.tgz rep0/p4-0.tgz
	@@-rm -rf ${D22}
	-@@ROOT=${D22} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} o4

lib-report5: rep0/o5-0.tgz rep0/p4-0.tgz
	@@-rm -rf ${D23}
	-@@ROOT=${D23} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} o5

lib-report6: rep0/o6-0.tgz rep0/p4-0.tgz rep0/oo6-0.tgz
	@@-rm -rf ${D24}
	-@@ROOT=${D24} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} o6 oo6

lib-report7: rep0/o7-0.tgz rep0/p4-0.tgz
	@@-rm -rf ${D25}
	-@@ROOT=${D25} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} o7

oldlib1: rep0/ol-0.tgz rep1/ol-1.tgz
	@@-rm -rf ${D33}
	-@@ROOT=${D33} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} ol
	-@@ROOT=${D33} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -u ol
	@@ROOT=${D33} ${INFO_PKG} -f .libs-ol-0|grep '^lib/subdir/$$'

loop1: rep0/ocaml-3.11.1.tgz rep0/tcl-8.5.7.tgz rep0/tk-8.5.7.tgz
	@@-rm -rf ${D20}
	-@@ROOT=${D20} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} -z ocaml-3.11.1p0 tcl-8.5.8 tk-8.5.8

qttest: rep0/qt-0.tgz rep1/qt-1.tgz
	@@-rm -rf ${D26}
	@@ROOT=${D26} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} qt
	@@ROOT=${D26} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -u qt

gstest: rep0/gs-0.tgz rep0/gs-0-no_x11.tgz rep0/purple-0.tgz
	@@-rm -rf ${D27}
	-@@ROOT=${D27} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} purple-0
	@@if ROOT=${D27} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} -r gs-0-no_x11; then exit 1; fi

exotest: rep0/exo-0.tgz rep1/exo-1.tgz
	@@-rm -rf ${D28}
	@@ROOT=${D28} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} exo
	@@ROOT=${D28} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -Iu exo

thunarvfstest: rep0/thunar-0.tgz rep0/q-0.tgz rep1/thunar-vfs-1.tgz rep1/q-1.tgz rep1/thunar-1.tgz
	@@-rm -rf ${D29}
	@@ROOT=${D29} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} q
	@@ROOT=${D29} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -u q

# test for manual install
manual1: rep0/ma-0.tgz rep0/mb-0.tgz rep0/mc-0.tgz rep0/md-0.tgz \
	rep1/ma-1.tgz rep1/mb-1.tgz rep1/me-1.tgz rep1/md-1.tgz
	@@-rm -rf ${D30}
	@@ROOT=${D30} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} md mb
	@@ROOT=${D30} ${INFO_PKG} -mq|diff -u - ${.CURDIR}/list9.out
	@@ROOT=${D30} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -u
	@@ROOT=${D30} ${INFO_PKG} -mq|diff -u - ${.CURDIR}/list10.out
	@@ROOT=${D30} ${DELETE_PKG} -a
	@@ROOT=${D30} ${INFO_PKG} -q|diff -u - ${.CURDIR}/list11.out

inter1: rep0/inta-0.tgz rep0/intb-0.tgz
	-rm -rf ${D31}
	@@ROOT=${D31} PKG_PATH=${.OBJDIR}/rep0 ${ADD_PKG} inta intb
	@@ROOT=${D31} ${DELETE_PKG} inta intb

plist1:
	@@echo "@@owner "`id -un` >$@@
	@@echo "@@group "`id -gn` >>$@@
	@@echo ${LONG1} >>$@@
	@@echo ${LONG2} >>$@@
	@@echo ${LONG3} >>$@@
	@@echo ${LONG4} >>$@@

plist2:
	@@echo "@@owner "`id -un` >$@@
	@@echo "@@group "`id -gn` >>$@@
	@@echo a >>$@@
	@@echo b >>$@@
	@@echo c >>$@@
	@@echo f >>$@@
	@@echo g >>$@@

plist3:
	@@echo "@@owner "`id -un` >$@@
	@@echo "@@group "`id -gn` >>$@@
	@@echo a >>$@@
	@@echo c >>$@@
	@@echo d >>$@@
	@@echo f >>$@@
	@@echo g >>$@@

plist4:
	@@echo "@@option always-update" >$@@

plist5:
	@@echo "@@ask-update gd-<1 Make sure yadada is backed up" >$@@

plist6:
	@@echo "@@conflict l-<1" >$@@

plist7:
	@@echo "@@conflict m-<1" >$@@
	@@echo "@@pkgpath t/m" >>$@@

plist8:
	@@echo "@@conflict o-<1" >$@@
	@@echo "@@pkgpath t/o" >>$@@
	@@echo "@@owner "`id -un` >>$@@
	@@echo "@@group "`id -gn` >>$@@
	@@echo '@@lib lib/libcoincoin.so.$${LIBcoincoin_VERSION}' >>$@@

plist9:
	@@echo "@@conflict gamin-*" >$@@

plist10:
	@@echo "@@conflict fam-*" >$@@
	@@echo "@@pkgpath t/fam" >>$@@

plist11:
	@@echo "@@conflict missc-*" >$@@

plist12:
	@@echo "@@owner "`id -un` >>$@@
	@@echo "@@group "`id -gn` >>$@@
	@@echo '@@lib lib/liba.so.$${LIBa_VERSION}' >>$@@

plist13:
	@@echo "@@owner "`id -un` >>$@@
	@@echo "@@group "`id -gn` >>$@@
	@@echo phonon/ >>$@@
	@@echo phonon/a >>$@@

plist14:
	@@echo "@@owner "`id -un` >>$@@
	@@echo "@@group "`id -gn` >>$@@
	@@echo phonon >>$@@

plist15:
	@@echo "@@owner "`id -un` >>$@@
	@@echo "@@group "`id -gn` >>$@@
	@@echo foo/ >>$@@
	@@echo foo/a >>$@@
	@@echo bar >>$@@

plist16:
	@@echo "@@owner "`id -un` >>$@@
	@@echo "@@group "`id -gn` >>$@@
	@@echo foo/ >>$@@
	@@echo foo/a >>$@@
	@@echo bar/ >>$@@
	@@echo bar/a >>$@@

plist17:
	@@echo "@@owner "`id -un` >>$@@
	@@echo "@@group "`id -gn` >>$@@
	@@echo '@@lib lib/libthunar-vfs.so.$${LIBthunar-vfs_VERSION}' >>$@@

plist18:
	@@echo "@@owner "`id -un` >>$@@
	@@echo "@@group "`id -gn` >>$@@
	@@echo "@@conflict thunar-<1" >>$@@
	@@echo '@@lib lib/libthunar-vfs.so.$${LIBthunar-vfs_VERSION}' >>$@@

plist19:
	@@echo "@@owner "`id -un` >>$@@
	@@echo "@@group "`id -gn` >>$@@
	@@echo a >>$@@

plist20:
	@@echo "@@owner "`id -un` >>$@@
	@@echo "@@group "`id -gn` >>$@@
	@@echo "@@conflict cola-<1" >>$@@
	@@echo a >>$@@

plist21:
	@@echo "@@owner "`id -un` >$@@
	@@echo "@@group "`id -gn` >>$@@
	@@echo '@@lib lib/subdir/libol.so.$${LIBol_VERSION}' >>$@@

rep0/a-0.tgz:
	@@${CREATE_PKG} -P't/b:b-*:b-0' -f ${.CURDIR}/empty $@@

rep1/a-1.tgz rep0/b-0.tgz rep0/i-0.tgz rep0/j-0.tgz rep1/j-1.tgz \
rep1/i-1.tgz rep0/k-0.tgz rep0/l-0.tgz rep1/l-1.tgz rep0/m-0.tgz \
rep0/n-0.tgz rep1/m-1.tgz rep0/o-0.tgz rep0/fam-0.tgz \
rep0/o1-0.tgz rep0/o2-0.tgz rep0/ga-0.tgz \
rep0/gb-0.tgz rep1/gb-0p0.tgz rep0/gd-0.tgz rep0/ge-0.tgz \
rep0/gf-1.tgz rep1/gf-0.tgz \
rep1/missc-0.tgz rep0/q5-0.tgz rep1/q5-1.tgz \
rep0/ma-0.tgz rep1/ma-1.tgz rep0/mc-0.tgz rep1/me-1.tgz \
rep0/tcl-8.5.7.tgz:
	@@${CREATE_PKG} -f ${.CURDIR}/empty $@@

rep0/md-0.tgz:
	@@${CREATE_PKG} -P't/ma:ma-*:ma-0' -P't/mb:mb-*:mb-0' -P't/mc:mc-*:mc-0' -f ${.CURDIR}/empty $@@
rep1/md-1.tgz:
	@@${CREATE_PKG} -P't/ma:ma-*:ma-1' -P't/mb:mb-*:mb-1' -P't/me:me-*:me-1' -f ${.CURDIR}/empty $@@
rep0/mb-0.tgz:
	@@${CREATE_PKG} -P't/ma:ma-*:ma-0' -f ${.CURDIR}/empty $@@
rep1/mb-1.tgz:
	@@${CREATE_PKG} -P't/ma:ma-*:ma-1' -f ${.CURDIR}/empty $@@

rep0/inta-0.tgz:
	@@${CREATE_PKG} -P't/intb:intb-*:intb-0' -f ${.CURDIR}/empty $@@
rep0/intb-0.tgz:
	@@${CREATE_PKG} -P't/inta:inta-*:inta-0' -f ${.CURDIR}/empty $@@
 
rep1/o-1.tgz:
	@@${CREATE_PKG} -DREGRESSION_TESTING -P't/p:p-*:p-0' -W'coincoin.0.0' -f ${.CURDIR}/empty $@@

rep1/o1-1.tgz:
	@@${CREATE_PKG} -DREGRESSION_TESTING -P't/p1:p1-*:p1-0' -W'coincoin.0' -f ${.CURDIR}/empty $@@

rep1/o2-1.tgz:
	@@${CREATE_PKG} -DREGRESSION_TESTING -P't/p2:p2-*:p2-0' -W'coincoin.0' -f ${.CURDIR}/empty $@@

rep0/o3-0.tgz:
	@@${CREATE_PKG} -DREGRESSION_TESTING -W'unlikelylibraryname.0.0' -f ${.CURDIR}/empty $@@

rep1/p-0.tgz rep1/p1-0.tgz: plist8
	@@mkdir -p ${SRC13}/lib
	@@touch ${SRC13}/lib/libcoincoin.so.0.0
	@@${CREATE_PKG} -B src13 -DLIBcoincoin_VERSION=0.0 -f plist8 $@@

rep1/p2-0.tgz: plist8
	@@mkdir -p ${SRC14}/lib
	@@touch ${SRC14}/lib/libcoincoin.so.0
	@@${CREATE_PKG} -DREGRESSION_TESTING -B src14 -DLIBcoincoin_VERSION=0 -f plist8 $@@

rep0/p4-0.tgz: plist12
	@@mkdir -p ${SRC15}/lib
	@@touch ${SRC15}/lib/liba.so.0.0
	@@${CREATE_PKG} -B src15 -DLIBa_VERSION=0.0 -f plist12 $@@

rep0/o4-0.tgz:
	@@${CREATE_PKG} -DREGRESSION_TESTING -W'a.1.0' -P't/p4:p4-*:p4-0' -f ${.CURDIR}/empty $@@

rep0/o5-0.tgz:
	@@${CREATE_PKG} -DREGRESSION_TESTING -W'a.0.2' -P't/p4:p4-*:p4-0' -f ${.CURDIR}/empty $@@

rep0/o6-0.tgz:
	@@${CREATE_PKG} -DREGRESSION_TESTING -W'a.0.0' -P't/p4:p4-*:p4-0' -f ${.CURDIR}/empty $@@

rep0/oo6-0.tgz:
	@@${CREATE_PKG} -DREGRESSION_TESTING -W'a.0.0' -f ${.CURDIR}/empty $@@

rep0/o7-0.tgz:
	@@${CREATE_PKG} -DREGRESSION_TESTING -W'dir/a.0.0' -P't/p4:p4-*:p4-0' -f ${.CURDIR}/empty $@@

rep1/b-1.tgz:
	@@${CREATE_PKG} -P't/a:a-*:a-1' -f ${.CURDIR}/empty $@@

rep0/qt-0.tgz: plist13
	@@mkdir -p ${SRC17}/phonon
	touch ${SRC17}/phonon/a
	@@${CREATE_PKG} -B src17 -f plist13 $@@

rep1/qt-1.tgz: plist14
	@@mkdir -p ${SRC16}
	touch ${SRC16}/phonon
	@@${CREATE_PKG} -B src16 -f plist14 $@@

rep0/exo-0.tgz: plist15
	@@mkdir -p ${SRC18}/foo
	touch ${SRC18}/foo/a
	cd ${SRC18} && ln -s foo bar
	@@${CREATE_PKG} -B src18 -f plist15 $@@

rep1/exo-1.tgz: plist16
	@@mkdir -p ${SRC19}/{foo,bar}
	touch ${SRC19}/{bar,foo}/a
	@@${CREATE_PKG} -B src19 -f plist16 $@@

rep0/thunar-0.tgz: plist17
	@@mkdir -p ${SRC20}/lib
	@@touch ${SRC20}/lib/libthunar-vfs.so.0.0
	@@${CREATE_PKG} -B src20 -DLIBthunar-vfs_VERSION=0.0 -f plist17 $@@

rep1/thunar-vfs-1.tgz: plist18
	@@mkdir -p ${SRC20}/lib
	@@touch ${SRC20}/lib/libthunar-vfs.so.0.0
	@@${CREATE_PKG} -B src20 -DLIBthunar-vfs_VERSION=0.0 -f plist18 $@@

rep1/thunar-1.tgz:
	@@${CREATE_PKG} -f ${.CURDIR}/empty $@@


rep0/q-0.tgz:
	@@${CREATE_PKG} -P't/thunar:thunar-*:thunar-0' -f ${.CURDIR}/empty $@@

rep1/q-1.tgz:
	@@${CREATE_PKG} -P't/thunar-vfs:thunar-vfs-*:thunar-vfs-1' -f ${.CURDIR}/empty $@@

rep0/gs-0.tgz:
	@@${CREATE_PKG} -f ${.CURDIR}/empty $@@
rep0/gs-0-no_x11.tgz:
	@@${CREATE_PKG} -f ${.CURDIR}/empty $@@

rep0/purple-0.tgz:
	@@${CREATE_PKG} -P't/gs:gs-*-!no_x11:gs-0' -f ${.CURDIR}/empty $@@

rep1/c-0.tgz: plist1
	@@mkdir -p ${SRC1}
	@@touch ${SRC1}/${LONG1}
	@@touch ${SRC1}/${LONG2}
	@@cd ${SRC1} && ln -sf ${LONG2} ${LONG3}
	@@cd ${SRC1} && ln -f ${LONG1} ${LONG4}
	@@${CREATE_PKG} -B src1 -f plist1 $@@

rep1/k-1.tgz: plist6
	@@${CREATE_PKG} -f plist6 $@@

rep1/n-1.tgz: plist7
	@@${CREATE_PKG} -f plist7 $@@

rep1/d-0.tgz: plist2
	@@mkdir -p ${SRC2}
	@@touch ${SRC2}/a ${SRC2}/b ${SRC2}/c
	@@echo "coucou" >${SRC2}/f
	@@echo "not coucou" >${SRC2}/g
	@@${CREATE_PKG} -B src2 -f plist2 $@@

rep1/e-0.tgz: plist3
	@@mkdir -p ${SRC3}
	@@touch ${SRC3}/a ${SRC3}/c ${SRC3}/d
	@@echo "coucou" >${SRC3}/f
	@@echo "coucou" >${SRC3}/g
	@@${CREATE_PKG} -B src3 -f plist3 $@@

rep1/f-0.tgz:
	@@${CREATE_PKG} -P't/d:d-*:d-0' -f ${.CURDIR}/empty $@@

rep0/g-0.tgz: plist4
	@@${CREATE_PKG} -f plist4 $@@

rep1/g-0.tgz: plist4
	@@PACKAGE_COMMENT=updated ${CREATE_PKG} -f plist4 $@@

rep0/gg-0.tgz: plist4 
	@@${CREATE_PKG} -P't/g:g-*:g-1' -f plist4 $@@

rep1/gg-0.tgz: plist4 
	@@PACKAGE_COMMENT=updated ${CREATE_PKG} -P't/g:g-*:g-0' -f plist4 $@@

rep1/gd-1.tgz rep1/ge-1.tgz: plist5
	@@${CREATE_PKG} -f plist5 $@@

rep1/ga-0.tgz:
	@@PACKAGE_COMMENT=updated ${CREATE_PKG} -f ${.CURDIR}/empty $@@

rep0/gc-0.tgz:
	@@${CREATE_PKG} -P't/ga:gb-*:gb-0' -f ${.CURDIR}/empty $@@

rep1/gc-0.tgz:
	@@PACKAGE_COMMENT=updated ${CREATE_PKG} -P't/ga:gb-*:gb-0p0' -f ${.CURDIR}/empty $@@

rep0/h-0.tgz:
	@@${CREATE_PKG} -P't/i:i-*:i-0' -f ${.CURDIR}/empty $@@

rep1/h-1.tgz:
	@@${CREATE_PKG} -P't/j:j->=1:j-1' -f ${.CURDIR}/empty $@@

rep0/cola-0.tgz: plist19
	@@mkdir -p ${SRC22}
	@@touch ${SRC22}/a
	@@${CREATE_PKG} -B src22 -f plist19 $@@

rep1/cola-1.tgz: plist19
	@@mkdir -p ${SRC22}
	@@touch ${SRC22}/a
	@@${CREATE_PKG} -B src22 -P't/colb:colb-*:colb-0' -f plist19 $@@

rep1/colb-0.tgz: plist20
	@@mkdir -p ${SRC22}
	@@touch ${SRC22}/a
	@@${CREATE_PKG} -B src22 -f plist20 $@@

depend_q1=-P't/q5:q5-*:q5-0'
depend_q2=${depend_q1} -P't/q1:q1-*:q1-0'
depend_q3=${depend_q1} -P't/q2:q2-*:q2-0'
depend_q4=${depend_q1} -P't/q3:q3-*:q3-0'

.for n in q1 q2 q3 q4
plist-rep0-$n:
	@@echo "@@unexec echo 1>&2 'XXXrep0 $n'" >$@@

rep0/$n-0.tgz: plist-rep0-$n
	@@${CREATE_PKG} ${depend_$n} -f plist-rep0-$n $@@
rep1/$n-1.tgz: plist-rep1-$n
	@@${CREATE_PKG} ${depend_$n} -f plist-rep1-$n $@@

plist-rep1-$n:
	@@echo "@@conflict q1-0" >$@@
	@@echo "@@conflict q2-0" >>$@@
	@@echo "@@conflict q3-0" >>$@@
	@@echo "@@conflict q4-0" >>$@@
	@@echo "@@exec echo 1>&2 'XXXrep1 $n'" >>$@@

.endfor
	
rep0/q6-0.tgz:
	@@${CREATE_PKG} -P't/q3:q3-*:q3-0' -f ${.CURDIR}/empty $@@

rep1/q6-1.tgz:
	@@${CREATE_PKG} -P't/q3:q3-*:q3-0' -f ${.CURDIR}/empty $@@

rep0/glib-0.tgz:
	@@${CREATE_PKG} -P't/fam:fam-*:fam-0' -f ${.CURDIR}/empty $@@

rep1/glib-1.tgz:
	@@${CREATE_PKG} -P't/gamin:gamin-*:gamin-0' -f ${.CURDIR}/empty $@@

rep1/fam-1.tgz: plist9
	@@${CREATE_PKG} -f plist9 $@@

rep1/gamin-0.tgz: plist10
	@@${CREATE_PKG} -f plist10 $@@

rep1/missa-0.tgz:
	@@${CREATE_PKG} -P't/misse:misse-*:misse-0' -f ${.CURDIR}/empty $@@

rep1/missb-0.tgz:
	@@${CREATE_PKG} -P't/missd:missd-*:missd-0' -f ${.CURDIR}/empty $@@

rep1/missd-0.tgz: plist11
	@@${CREATE_PKG} -f plist11 $@@

rep1/missf-0.tgz:
	@@${CREATE_PKG} -P't/misse:misse-*:misse-0' -f ${.CURDIR}/empty $@@

rep0/ocaml-3.11.1.tgz:
	@@${CREATE_PKG} -P'test/tcl:tcl->=8.5,<8.6:tcl-8.5.7' \
		-P'test/tk:tk->=8.5,<8.6:tk-8.5.7' -f ${.CURDIR}/empty $@@

rep0/tk-8.5.7.tgz:
	@@${CREATE_PKG} -P'test/tcl:tcl->=8.5.7,<8.5.8:tcl-8.5.7' \
		-f ${.CURDIR}/empty $@@

rep0/ol-0.tgz: plist21
	@@mkdir -p ${SRC23}/lib/subdir
	@@touch ${SRC23}/lib/subdir/libol.so.0.0
	@@${CREATE_PKG} -B src23 -DLIBol_VERSION=0.0 -f plist21 $@@

rep1/ol-1.tgz: plist21
	@@mkdir -p ${SRC23}/lib/subdir
	@@touch ${SRC23}/lib/subdir/libol.so.1.0
	@@${CREATE_PKG} -B src23 -DLIBol_VERSION=1.0 -f plist21 $@@

keys:
	mkdir signify
	signify -G -n -s signify/test-pkg.sec -p signify/test-pkg.pub

.PHONY: ${REGRESS_TARGETS}

clean:
	-rm -rf rep* dest* plist* src* signatures.out

.include <bsd.regress.mk>
@


1.52
log
@Replace a (broken) test for @@option explicit-update (the code has been
removed 2 years ago) by a (working) test for @@ask-update
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.51 2014/01/31 10:13:13 espie Exp $
d3 5
a7 3
REGRESS_TARGETS=pkgnames pkgpaths signatures depends-check longnames \
	pkgcfl update-check1 \
	collision-check3 collision-check5 partial-update-test conflict-update \
d11 1
a11 5
	qttest gstest exotest inter1 manual1 oldlib1 \

# extra stuff
#	collision-check1 collision-check2 collision-check4 collision-check6
#	collision-check7
d13 29
d98 1
a98 1
	@@ROOT=${D4} ${ADD_PKG} rep1/e-0.tgz
d650 1
a650 3
# some extra tests do not yet pass correctly
.PHONY: ${REGRESS_TARGETS} \
	collision-check1 collision-check2 collision-check4 collision-check5
@


1.51
log
@basic check for pkg names conflicts, to be augmented
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.50 2012/08/17 23:40:02 espie Exp $
d107 1
a107 1
	@@ROOT=${D8} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -u
d109 1
a109 1
	@@ROOT=${D8} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -u gd ge
d266 1
a266 1
	@@echo "@@option explicit-update" >$@@
d357 1
a357 1
rep0/gb-0.tgz rep1/gb-0p0.tgz rep1/gd-1.tgz rep0/ge-0.tgz \
d515 1
a515 1
rep0/gd-0.tgz rep1/ge-1.tgz: plist5
@


1.50
log
@oops, shouldn't go interactive (found by matthew@@)
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.49 2012/05/05 10:19:10 espie Exp $
d4 1
a4 1
	update-check1 \
d37 3
d618 4
@


1.49
log
@old libs outside of /usr/local should keep their directories around too
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.48 2011/12/03 16:16:26 espie Exp $
d210 1
a210 1
	@@ROOT=${D28} PKG_PATH=${.OBJDIR}/rep1 ${ADD_PKG} -u exo
@


1.48
log
@pure display check, not linked since it fails, but the reported message
should be better.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.47 2011/07/13 11:57:10 espie Exp $
d9 1
a9 1
	qttest gstest exotest inter1 manual1
d33 1
a33 1
# current maxes (used): D32, SRC22, plist20
d187 6
d342 5
d605 10
@


1.47
log
@tweak script to handle add/delete/info
finish the manual1 test
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.46 2011/07/12 23:33:42 espie Exp $
d11 3
d33 1
a33 1
# current maxes: D31, SRC20, plist18
d87 1
a87 1
collision-check5: rep1/d-0.tgz rep1/e-0.tgz
d93 5
d325 11
d351 1
a351 1
	${CREATE_PKG} -P't/ma:ma-*:ma-0' -P't/mb:mb-*:mb-0' -P't/mc:mc-*:mc-0' -f ${.CURDIR}/empty $@@
d353 1
a353 1
	${CREATE_PKG} -P't/ma:ma-*:ma-1' -P't/mb:mb-*:mb-1' -P't/me:me-*:me-1' -f ${.CURDIR}/empty $@@
d355 1
a355 1
	${CREATE_PKG} -P't/ma:ma-*:ma-0' -f ${.CURDIR}/empty $@@
d357 1
a357 1
	${CREATE_PKG} -P't/ma:ma-*:ma-1' -f ${.CURDIR}/empty $@@
d360 1
a360 1
	${CREATE_PKG} -P't/intb:intb-*:intb-0' -f ${.CURDIR}/empty $@@
d362 1
a362 1
	${CREATE_PKG} -P't/inta:inta-*:inta-0' -f ${.CURDIR}/empty $@@
d518 15
@


1.46
log
@create packages with inter-dependencies... and delete them
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.45 2011/07/12 23:17:21 espie Exp $
d9 1
a9 1
	qttest gstest exotest inter1
d13 3
a15 1
ADD_PKG=perl ${.CURDIR}/myadd
d208 1
a208 1
	PKG_DBDIR=${D30}/pkgdb pkg_info -m
d210 3
a212 3
	@@PKG_DBDIR=${D30}/pkgdb pkg_info -m
	PKG_DBDIR=${D30}/pkgdb pkg_delete -Dnonroot -B ${D30} -a
	@@PKG_DBDIR=${D30}/pkgdb pkg_info
d217 1
a217 2
	@@PKG_DBDIR=${D31}/pkgdb pkg_delete -Dnonroot -B ${D30} inta intb

@


1.45
log
@start adding regress for manual installs, not fully working yet...
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.44 2011/07/02 10:31:21 espie Exp $
d9 1
a9 1
	qttest gstest exotest
d28 1
a28 1
# current maxes: D29, SRC20, plist18
d212 5
d338 5
@


1.44
log
@"repair" the thunarvfs test, except it's not repaired, as it does not
exemplify anything interesting now.

zap it from the list until it gets properly fixed
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.43 2011/05/27 12:24:45 espie Exp $
d201 12
d321 1
d325 9
@


1.43
log
@unit-test @@pkgpath before we add a lot of junk to it
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.42 2011/05/21 21:59:40 landry Exp $
d9 1
a9 1
	qttest gstest exotest thunarvfstest
d28 1
a28 1
# current maxes: D29, SRC20, plist17
d196 1
a196 1
thunarvfstest: rep0/thunar-0.tgz rep0/q-0.tgz rep1/thunar-vfs-1.tgz rep1/q-1.tgz
d293 6
d383 8
a390 4
rep1/thunar-vfs-1.tgz: plist17
	@@mkdir -p ${SRC21}/lib
	@@touch ${SRC21}/lib/libthunar-vfs.so.0.0
	@@${CREATE_PKG} -B src21 -DLIBthunar-vfs_VERSION=0.0 -f plist17 $@@
@


1.42
log
@Add a (failing atm) regress test for when a library moves from a package
to another without minor being bumped and a package depending on it needs to
be updated, like what happened in the thunar-vfs-1 @@lib split from
thunar-1.0.x to thunar-vfs 1.2.x package.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.41 2011/05/17 19:54:29 landry Exp $
d3 2
a4 1
REGRESS_TARGETS=pkgnames signatures depends-check longnames update-check1 \
d31 3
@


1.41
log
@Add a (failing atm) regress test for the case a symlink to a directory
containing entries becomes a real directory with the same entries, like in
the upcoming exo-0.6.0 -> exo-0.6.1 update.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.40 2010/12/24 10:36:48 espie Exp $
d8 1
a8 1
	qttest gstest exotest
d27 1
a27 1
# current maxes: D28, SRC19, plist16
d192 5
d284 5
d367 16
@


1.40
log
@now that pkg_create checks more stuff, we have to ask for it to create
more bogus packages so that we can get errors out of pkg_add...
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.39 2010/08/07 19:39:33 espie Exp $
d8 1
a8 1
	qttest gstest
d27 1
a27 1
# current maxes: D26, SRC17, plist14
d187 5
d264 15
d346 11
@


1.39
log
@new test for merging because of wrong deps that must lead to failure.
also, PKG_ADD -> ADD_PKG to avoid confusion with bsd.port.mk.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.38 2010/05/01 09:03:05 espie Exp $
d273 1
a273 1
	@@${CREATE_PKG} -P't/p:p-*:p-0' -W'coincoin.0.0' -f ${.CURDIR}/empty $@@
d282 1
a282 1
	@@${CREATE_PKG} -W'unlikelylibraryname.0.0' -f ${.CURDIR}/empty $@@
d300 1
a300 1
	@@${CREATE_PKG} -W'a.1.0' -P't/p4:p4-*:p4-0' -f ${.CURDIR}/empty $@@
d303 1
a303 1
	@@${CREATE_PKG} -W'a.0.2' -P't/p4:p4-*:p4-0' -f ${.CURDIR}/empty $@@
d306 1
a306 1
	@@${CREATE_PKG} -W'a.0.0' -P't/p4:p4-*:p4-0' -f ${.CURDIR}/empty $@@
d309 1
a309 1
	@@${CREATE_PKG} -W'a.0.0' -f ${.CURDIR}/empty $@@
d312 1
a312 1
	@@${CREATE_PKG} -W'dir/a.0.0' -P't/p4:p4-*:p4-0' -f ${.CURDIR}/empty $@@
@


1.38
log
@this one is going to be fun to fix...
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.37 2010/01/24 15:33:38 espie Exp $
d8 1
a8 1
	qttest
d12 2
a13 2
PKG_ADD=perl ${.CURDIR}/myadd
PKG_CREATE=perl ${.CURDIR}/mycreate
d27 1
a27 1
# current maxes: D25, SRC17, plist14
d38 3
a40 3
	@@ROOT=${D1} ${PKG_ADD} rep0/a-0.tgz rep0/b-0.tgz
	@@ROOT=${D1} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u a b
	@@ROOT=${D1} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} -D downgrade -u a b
d44 1
a44 1
	@@ROOT=${D2} ${PKG_ADD} rep1/c-0.tgz
d52 2
a53 2
	@@ROOT=${D3} ${PKG_ADD} rep1/d-0.tgz
	@@ROOT=${D3} ${PKG_ADD} rep1/e-0.tgz
d57 1
a57 1
	@@ROOT=${D4} ${PKG_ADD} rep1/d-0.tgz
d59 1
a59 1
	@@ROOT=${D4} ${PKG_ADD} rep1/e-0.tgz
d63 1
a63 1
	@@ROOT=${D5} ${PKG_ADD} rep1/d-0.tgz rep1/f-0.tgz
d65 1
a65 1
	@@ROOT=${D5} ${PKG_ADD} -D repair rep1/d-0.tgz
d70 1
a70 1
	@@ROOT=${D6} ${PKG_ADD} rep1/d-0.tgz
d72 1
a72 1
	@@ROOT=${D6} ${PKG_ADD} -D repair rep1/e-0.tgz
d76 1
a76 1
	@@ROOT=${D21} ${PKG_ADD} -n rep1/d-0.tgz rep1/e-0.tgz
d80 1
a80 1
	@@ROOT=${D7} ${PKG_ADD} rep1/d-0.tgz
d82 1
a82 1
	@@ROOT=${D7} ${PKG_ADD} -D removecollisions rep1/d-0.tgz
d89 2
a90 2
	@@ROOT=${D8} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} g ga gb gc gd ge gf gg
	@@ROOT=${D8} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u
d92 1
a92 1
	@@ROOT=${D8} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u gd ge
d98 1
a98 1
	@@ROOT=${D9} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -l ${.CURDIR}/list
d104 2
a105 2
	@@ROOT=${D10} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} h j
	@@ROOT=${D10} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u h
d110 2
a111 2
	@@ROOT=${D11} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} k l
	@@ROOT=${D11} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u k
d116 2
a117 2
	@@ROOT=${D12} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} m n
	@@ROOT=${D12} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u n
d122 2
a123 2
	@@ROOT=${D13} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} o
	@@ROOT=${D13} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u o
d130 2
a131 2
	@@ROOT=${D14} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} q1 q2 q3 q4 q5 q6
	@@ROOT=${D14} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -x -D update -u 2>&1 |fgrep XXX|fgrep -v @@|diff - ${.CURDIR}/list6.out
d135 2
a136 2
	@@ROOT=${D15} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} glib
	@@ROOT=${D15} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u glib
d140 2
a141 2
	@@ROOT=${D16} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} missc
	@@-ROOT=${D15} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} missa missb missf
d145 2
a146 2
	@@ROOT=${D17} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} o1
	-@@ROOT=${D17} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u o1
d150 2
a151 2
	@@ROOT=${D18} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} o2
	-@@ROOT=${D18} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u o2
d155 1
a155 1
	-@@ROOT=${D19} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} o3
d159 1
a159 1
	-@@ROOT=${D22} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} o4
d163 1
a163 1
	-@@ROOT=${D23} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} o5
d167 1
a167 1
	-@@ROOT=${D24} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} o6 oo6
d171 1
a171 1
	-@@ROOT=${D25} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} o7
d175 1
a175 1
	-@@ROOT=${D20} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} -z ocaml-3.11.1p0 tcl-8.5.8 tk-8.5.8
d179 7
a185 2
	-@@ROOT=${D26} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} qt
	-@@ROOT=${D26} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u qt
d260 1
a260 1
	@@${PKG_CREATE} -P't/b:b-*:b-0' -f ${.CURDIR}/empty $@@
d270 1
a270 1
	@@${PKG_CREATE} -f ${.CURDIR}/empty $@@
d273 1
a273 1
	@@${PKG_CREATE} -P't/p:p-*:p-0' -W'coincoin.0.0' -f ${.CURDIR}/empty $@@
d276 1
a276 1
	@@${PKG_CREATE} -DREGRESSION_TESTING -P't/p1:p1-*:p1-0' -W'coincoin.0' -f ${.CURDIR}/empty $@@
d279 1
a279 1
	@@${PKG_CREATE} -DREGRESSION_TESTING -P't/p2:p2-*:p2-0' -W'coincoin.0' -f ${.CURDIR}/empty $@@
d282 1
a282 1
	@@${PKG_CREATE} -W'unlikelylibraryname.0.0' -f ${.CURDIR}/empty $@@
d287 1
a287 1
	@@${PKG_CREATE} -B src13 -DLIBcoincoin_VERSION=0.0 -f plist8 $@@
d292 1
a292 1
	@@${PKG_CREATE} -DREGRESSION_TESTING -B src14 -DLIBcoincoin_VERSION=0 -f plist8 $@@
d297 1
a297 1
	@@${PKG_CREATE} -B src15 -DLIBa_VERSION=0.0 -f plist12 $@@
d300 1
a300 1
	@@${PKG_CREATE} -W'a.1.0' -P't/p4:p4-*:p4-0' -f ${.CURDIR}/empty $@@
d303 1
a303 1
	@@${PKG_CREATE} -W'a.0.2' -P't/p4:p4-*:p4-0' -f ${.CURDIR}/empty $@@
d306 1
a306 1
	@@${PKG_CREATE} -W'a.0.0' -P't/p4:p4-*:p4-0' -f ${.CURDIR}/empty $@@
d309 1
a309 1
	@@${PKG_CREATE} -W'a.0.0' -f ${.CURDIR}/empty $@@
d312 1
a312 1
	@@${PKG_CREATE} -W'dir/a.0.0' -P't/p4:p4-*:p4-0' -f ${.CURDIR}/empty $@@
d315 1
a315 1
	@@${PKG_CREATE} -P't/a:a-*:a-1' -f ${.CURDIR}/empty $@@
d320 1
a320 1
	@@${PKG_CREATE} -B src17 -f plist13 $@@
d325 9
a333 1
	@@${PKG_CREATE} -B src16 -f plist14 $@@
d341 1
a341 1
	@@${PKG_CREATE} -B src1 -f plist1 $@@
d344 1
a344 1
	@@${PKG_CREATE} -f plist6 $@@
d347 1
a347 1
	@@${PKG_CREATE} -f plist7 $@@
d354 1
a354 1
	@@${PKG_CREATE} -B src2 -f plist2 $@@
d361 1
a361 1
	@@${PKG_CREATE} -B src3 -f plist3 $@@
d364 1
a364 1
	@@${PKG_CREATE} -P't/d:d-*:d-0' -f ${.CURDIR}/empty $@@
d367 1
a367 1
	@@${PKG_CREATE} -f plist4 $@@
d370 1
a370 1
	@@PACKAGE_COMMENT=updated ${PKG_CREATE} -f plist4 $@@
d373 1
a373 1
	@@${PKG_CREATE} -P't/g:g-*:g-1' -f plist4 $@@
d376 1
a376 1
	@@PACKAGE_COMMENT=updated ${PKG_CREATE} -P't/g:g-*:g-0' -f plist4 $@@
d379 1
a379 1
	@@${PKG_CREATE} -f plist5 $@@
d382 1
a382 1
	@@PACKAGE_COMMENT=updated ${PKG_CREATE} -f ${.CURDIR}/empty $@@
d385 1
a385 1
	@@${PKG_CREATE} -P't/ga:gb-*:gb-0' -f ${.CURDIR}/empty $@@
d388 1
a388 1
	@@PACKAGE_COMMENT=updated ${PKG_CREATE} -P't/ga:gb-*:gb-0p0' -f ${.CURDIR}/empty $@@
d391 1
a391 1
	@@${PKG_CREATE} -P't/i:i-*:i-0' -f ${.CURDIR}/empty $@@
d394 1
a394 1
	@@${PKG_CREATE} -P't/j:j->=1:j-1' -f ${.CURDIR}/empty $@@
d406 1
a406 1
	@@${PKG_CREATE} ${depend_$n} -f plist-rep0-$n $@@
d408 1
a408 1
	@@${PKG_CREATE} ${depend_$n} -f plist-rep1-$n $@@
d420 1
a420 1
	@@${PKG_CREATE} -P't/q3:q3-*:q3-0' -f ${.CURDIR}/empty $@@
d423 1
a423 1
	@@${PKG_CREATE} -P't/q3:q3-*:q3-0' -f ${.CURDIR}/empty $@@
d426 1
a426 1
	@@${PKG_CREATE} -P't/fam:fam-*:fam-0' -f ${.CURDIR}/empty $@@
d429 1
a429 1
	@@${PKG_CREATE} -P't/gamin:gamin-*:gamin-0' -f ${.CURDIR}/empty $@@
d432 1
a432 1
	@@${PKG_CREATE} -f plist9 $@@
d435 1
a435 1
	@@${PKG_CREATE} -f plist10 $@@
d438 1
a438 1
	@@${PKG_CREATE} -P't/misse:misse-*:misse-0' -f ${.CURDIR}/empty $@@
d441 1
a441 1
	@@${PKG_CREATE} -P't/missd:missd-*:missd-0' -f ${.CURDIR}/empty $@@
d444 1
a444 1
	@@${PKG_CREATE} -f plist11 $@@
d447 1
a447 1
	@@${PKG_CREATE} -P't/misse:misse-*:misse-0' -f ${.CURDIR}/empty $@@
d450 1
a450 1
	@@${PKG_CREATE} -P'test/tcl:tcl->=8.5,<8.6:tcl-8.5.7' \
d454 1
a454 1
	@@${PKG_CREATE} -P'test/tcl:tcl->=8.5.7,<8.5.8:tcl-8.5.7' \
@


1.37
log
@tests for shared libs update issues...
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.36 2010/01/18 12:58:12 espie Exp $
d7 2
a8 1
	lib-report4 lib-report5 lib-report6 lib-report7
d27 1
d177 5
d243 11
d311 10
@


1.36
log
@even in @@option always-update, normal dependency comparison should still
occur (and thus we shouldn't downgrade packages if the version changes)
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.35 2010/01/14 19:38:37 espie Exp $
d6 4
a9 1
	lib-report1 lib-report2 lib-report3 loop1
d18 2
a19 1
.for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25
d155 16
d231 5
d270 20
@


1.35
log
@new test for vstat
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.34 2010/01/14 13:55:58 espie Exp $
d81 1
a81 1
	rep0/gf-1.tgz rep1/gf-0.tgz
d83 1
a83 1
	@@ROOT=${D8} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} g ga gb gc gd ge gf
d285 6
@


1.34
log
@set group+owner as some tests require both
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.33 2010/01/10 16:06:10 espie Exp $
d4 1
a4 1
	collision-check3 partial-update-test conflict-update \
d15 1
a15 1
.for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20
d34 1
a34 1
	@@ROOT=${D1} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} -F downgrade -u a b
d59 1
a59 1
	@@ROOT=${D5} ${PKG_ADD} -F repair rep1/d-0.tgz
d66 5
a70 1
	@@ROOT=${D6} ${PKG_ADD} -F repair rep1/e-0.tgz
d76 1
a76 1
	@@ROOT=${D7} ${PKG_ADD} -F removecollisions rep1/d-0.tgz
d125 1
a125 1
	@@ROOT=${D14} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -x -F update -u 2>&1 |fgrep XXX|fgrep -v @@|diff - ${.CURDIR}/list6.out
@


1.33
log
@nits
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.32 2010/01/10 12:41:20 espie Exp $
d152 2
a153 1
	@@echo "@@owner "`whoami` >$@@
d160 2
a161 1
	@@echo "@@owner "`whoami` >$@@
d169 2
a170 1
	@@echo "@@owner "`whoami` >$@@
d193 2
a194 1
	@@echo "@@owner "`whoami` >>$@@
@


1.32
log
@more signatures checks
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.31 2010/01/10 11:49:56 espie Exp $
d25 2
a26 1
signatures.out:
a27 2

signatures: signatures.out
d126 1
a126 1
	@@ROOT=${D15} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -F updatedepends -u glib
@


1.31
log
@add REGRESSION_TESTING markers so tests still run.
new test for signature comparison checks
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.30 2010/01/03 23:51:40 espie Exp $
d25 5
a29 2
signatures:
	perl ${.CURDIR}/check-sig
d363 1
a363 1
	-rm -rf rep* dest* plist* src*
@


1.30
log
@ouch, bad loop
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.29 2010/01/01 16:36:17 espie Exp $
d3 1
a3 1
REGRESS_TARGETS=pkgnames depends-check longnames update-check1 \
d25 3
d218 1
a218 1
	@@${PKG_CREATE} -P't/p1:p1-*:p1-0' -W'coincoin.0' -f ${.CURDIR}/empty $@@
d221 1
a221 1
	@@${PKG_CREATE} -P't/p2:p2-*:p2-0' -W'coincoin.0' -f ${.CURDIR}/empty $@@
d234 1
a234 1
	@@${PKG_CREATE} -B src14 -DLIBcoincoin_VERSION=0 -f plist8 $@@
@


1.29
log
@check for most update situations
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.28 2009/12/31 13:31:53 espie Exp $
d6 1
a6 1
	lib-report1 lib-report2 lib-report3
d142 4
d207 2
a208 1
rep1/missc-0.tgz rep0/q5-0.tgz rep1/q5-1.tgz:
d343 8
@


1.28
log
@and yet another library check error
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.27 2009/12/31 12:58:22 espie Exp $
d3 1
a3 1
REGRESS_TARGETS=pkgnames depends-check longnames always-update \
d69 4
a72 1
always-update: rep0/g-0.tgz rep1/g-0.tgz
d74 1
a74 1
	@@ROOT=${D8} ${PKG_ADD} rep0/g-0.tgz
d76 3
a78 1
	@@PKG_DBDIR=${D8}/pkgdb pkg_info -qf g|fgrep -q comment2
a166 1
	@@echo "@@comment comment1" >>$@@
d169 1
a169 2
	@@echo "@@option always-update" >$@@
	@@echo "@@comment comment2" >>$@@
d200 3
a202 1
rep0/o1-0.tgz rep0/o2-0.tgz \
d265 4
a268 1
rep1/g-0.tgz: plist5
d270 9
@


1.27
log
@remove all noise, have myadd display a simplified version of what it's doing
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.26 2009/12/31 12:12:59 espie Exp $
d5 2
a6 1
	merge-update split-update big-merge family-circus missing
d126 1
a126 1
	@@ROOT=${D17} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u o1
d131 6
a136 1
	@@ROOT=${D18} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u o2
d210 3
d324 1
a324 2
	collision-check1 collision-check2 collision-check4 collision-check5 \
	lib-report1 lib-report2
@


1.26
log
@add some lib report checks where the error messages are currently very bad.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.25 2009/12/31 11:32:09 espie Exp $
d25 4
a28 4
	-rm -rf ${D1}
	ROOT=${D1} ${PKG_ADD} rep0/a-0.tgz rep0/b-0.tgz
	ROOT=${D1} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u a b
	ROOT=${D1} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} -F downgrade -u a b
d31 2
a32 2
	-rm -rf ${D2}
	ROOT=${D2} ${PKG_ADD} rep1/c-0.tgz
d39 3
a41 3
	-rm -rf ${D3}
	ROOT=${D3} ${PKG_ADD} rep1/d-0.tgz
	ROOT=${D3} ${PKG_ADD} rep1/e-0.tgz
d44 4
a47 4
	-rm -rf ${D4}
	ROOT=${D4} ${PKG_ADD} rep1/d-0.tgz
	-rm -rf ${D4}/pkgdb/d-0
	ROOT=${D4} ${PKG_ADD} rep1/e-0.tgz
d50 4
a53 4
	-rm -rf ${D5}
	ROOT=${D5} ${PKG_ADD} rep1/d-0.tgz rep1/f-0.tgz
	-rm -rf ${D5}/pkgdb/d-0
	ROOT=${D5} ${PKG_ADD} -F repair rep1/d-0.tgz
d57 4
a60 4
	-rm -rf ${D6}
	ROOT=${D6} ${PKG_ADD} rep1/d-0.tgz
	-rm -rf ${D6}/pkgdb/d-0
	ROOT=${D6} ${PKG_ADD} -F repair rep1/e-0.tgz
d63 4
a66 4
	-rm -rf ${D7}
	ROOT=${D7} ${PKG_ADD} rep1/d-0.tgz
	-rm -rf ${D7}/pkgdb/d-0
	ROOT=${D7} ${PKG_ADD} -F removecollisions rep1/d-0.tgz
d69 4
a72 4
	-rm -rf ${D8}
	ROOT=${D8} ${PKG_ADD} rep0/g-0.tgz
	ROOT=${D8} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u
	PKG_DBDIR=${D8}/pkgdb pkg_info -qf g|fgrep -q comment2
d76 3
a78 3
	-rm -rf ${D9}
	ROOT=${D9} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -l ${.CURDIR}/list
	PKG_DBDIR=${D9}/pkgdb pkg_info -q|diff - ${.CURDIR}/list.out
d82 4
a85 4
	-rm -rf ${D10}
	ROOT=${D10} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} h j
	ROOT=${D10} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u h
	PKG_DBDIR=${D10}/pkgdb pkg_info -q|diff - ${.CURDIR}/list2.out
d88 4
a91 4
	-rm -rf ${D11}
	ROOT=${D11} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} k l
	ROOT=${D11} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u k
	PKG_DBDIR=${D11}/pkgdb pkg_info -q|diff - ${.CURDIR}/list3.out
d94 4
a97 4
	-rm -rf ${D12}
	ROOT=${D12} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} m n
	ROOT=${D12} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u n
	PKG_DBDIR=${D12}/pkgdb pkg_info -q|diff - ${.CURDIR}/list4.out
d100 4
a103 4
	-rm -rf ${D13}
	ROOT=${D13} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} o
	ROOT=${D13} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u o
	PKG_DBDIR=${D13}/pkgdb pkg_info -q |diff - ${.CURDIR}/list5.out
d108 3
a110 3
	-rm -rf ${D14}
	ROOT=${D14} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} q1 q2 q3 q4 q5 q6
	ROOT=${D14} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -x -F update -u 2>&1 |fgrep XXX|fgrep -v @@|diff - ${.CURDIR}/list6.out
d113 3
a115 3
	-rm -rf ${D15}
	ROOT=${D15} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} glib
	ROOT=${D15} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -F updatedepends -u glib
d118 3
a120 3
	-rm -rf ${D16}
	ROOT=${D16} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} missc
	-ROOT=${D15} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} missa missb missf
d123 3
a125 3
	-rm -rf ${D17}
	ROOT=${D17} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} o1
	ROOT=${D17} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u o1
d128 3
a130 3
	-rm -rf ${D18}
	ROOT=${D18} PKG_PATH=${.OBJDIR}/rep0 ${PKG_ADD} o2
	ROOT=${D18} PKG_PATH=${.OBJDIR}/rep1 ${PKG_ADD} -u o2
d186 1
a186 1
	${PKG_CREATE} -P't/b:b-*:b-0' -f ${.CURDIR}/empty $@@
d192 2
a193 2
rep1/missc-0.tgz:
	${PKG_CREATE} -f ${.CURDIR}/empty $@@
d196 1
a196 1
	${PKG_CREATE} -P't/p:p-*:p-0' -W'coincoin.0.0' -f ${.CURDIR}/empty $@@
d199 1
a199 1
	${PKG_CREATE} -P't/p1:p1-*:p1-0' -W'coincoin.0' -f ${.CURDIR}/empty $@@
d202 1
a202 1
	${PKG_CREATE} -P't/p2:p2-*:p2-0' -W'coincoin.0' -f ${.CURDIR}/empty $@@
d205 1
a205 1
	mkdir -p ${SRC13}/lib
d207 1
a207 1
	${PKG_CREATE} -B src13 -DLIBcoincoin_VERSION=0.0 -f plist8 $@@
d210 1
a210 1
	mkdir -p ${SRC14}/lib
d212 1
a212 1
	${PKG_CREATE} -B src14 -DLIBcoincoin_VERSION=0 -f plist8 $@@
d215 1
a215 1
	${PKG_CREATE} -P't/a:a-*:a-1' -f ${.CURDIR}/empty $@@
d218 1
a218 1
	mkdir -p ${SRC1}
d223 1
a223 1
	${PKG_CREATE} -B src1 -f plist1 $@@
d226 1
a226 1
	${PKG_CREATE} -f plist6 $@@
d229 1
a229 1
	${PKG_CREATE} -f plist7 $@@
d232 5
a236 5
	mkdir -p ${SRC2}
	touch ${SRC2}/a ${SRC2}/b ${SRC2}/c
	echo "coucou" >${SRC2}/f
	echo "not coucou" >${SRC2}/g
	${PKG_CREATE} -B src2 -f plist2 $@@
d239 5
a243 5
	mkdir -p ${SRC3}
	touch ${SRC3}/a ${SRC3}/c ${SRC3}/d
	echo "coucou" >${SRC3}/f
	echo "coucou" >${SRC3}/g
	${PKG_CREATE} -B src3 -f plist3 $@@
d246 1
a246 1
	${PKG_CREATE} -P't/d:d-*:d-0' -f ${.CURDIR}/empty $@@
d249 1
a249 1
	${PKG_CREATE} -f plist4 $@@
d252 1
a252 1
	${PKG_CREATE} -f plist5 $@@
d255 1
a255 1
	${PKG_CREATE} -P't/i:i-*:i-0' -f ${.CURDIR}/empty $@@
d258 1
a258 1
	${PKG_CREATE} -P't/j:j->=1:j-1' -f ${.CURDIR}/empty $@@
d270 1
a270 1
	${PKG_CREATE} ${depend_$n} -f plist-rep0-$n $@@
d272 1
a272 1
	${PKG_CREATE} ${depend_$n} -f plist-rep1-$n $@@
a282 6
rep0/q5-0.tgz:
	${PKG_CREATE} -f ${.CURDIR}/empty $@@

rep1/q5-1.tgz:
	${PKG_CREATE} -f ${.CURDIR}/empty $@@

d284 1
a284 1
	${PKG_CREATE} -P't/q3:q3-*:q3-0' -f ${.CURDIR}/empty $@@
d287 1
a287 1
	${PKG_CREATE} -P't/q3:q3-*:q3-0' -f ${.CURDIR}/empty $@@
d290 1
a290 1
	${PKG_CREATE} -P't/fam:fam-*:fam-0' -f ${.CURDIR}/empty $@@
d293 1
a293 1
	${PKG_CREATE} -P't/gamin:gamin-*:gamin-0' -f ${.CURDIR}/empty $@@
d296 1
a296 1
	${PKG_CREATE} -f plist9 $@@
d299 1
a299 1
	${PKG_CREATE} -f plist10 $@@
d302 1
a302 1
	${PKG_CREATE} -P't/misse:misse-*:misse-0' -f ${.CURDIR}/empty $@@
d305 1
a305 1
	${PKG_CREATE} -P't/missd:missd-*:missd-0' -f ${.CURDIR}/empty $@@
d308 1
a308 1
	${PKG_CREATE} -f plist11 $@@
d311 1
a311 1
	${PKG_CREATE} -P't/misse:misse-*:misse-0' -f ${.CURDIR}/empty $@@
@


1.25
log
@simplify and rationalize names
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.24 2009/12/31 10:46:15 espie Exp $
d122 9
d191 1
d198 7
a204 1
rep1/p-0.tgz: plist8
d209 4
d321 2
a322 1
	collision-check1 collision-check2 collision-check4 collision-check5
@


1.24
log
@check for infinite loops in case of install problems
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.23 2009/12/12 17:15:58 espie Exp $
d24 1
a24 1
depends-check: old/a-0.0.tgz old/b-0.0.tgz new/a-1.0.tgz new/b-1.0.tgz
d26 3
a28 3
	ROOT=${D1} ${PKG_ADD} old/a-0.0.tgz old/b-0.0.tgz
	ROOT=${D1} PKG_PATH=${.OBJDIR}/new ${PKG_ADD} -u a b
	ROOT=${D1} PKG_PATH=${.OBJDIR}/old ${PKG_ADD} -F downgrade -u a b
d30 1
a30 1
longnames: new/c-0.0.tgz
d32 1
a32 1
	ROOT=${D2} ${PKG_ADD} new/c-0.0.tgz
d38 1
a38 1
collision-check1: new/d-0.0.tgz new/e-0.0.tgz
d40 2
a41 2
	ROOT=${D3} ${PKG_ADD} new/d-0.0.tgz
	ROOT=${D3} ${PKG_ADD} new/e-0.0.tgz
d43 1
a43 1
collision-check2: new/d-0.0.tgz new/e-0.0.tgz
d45 3
a47 3
	ROOT=${D4} ${PKG_ADD} new/d-0.0.tgz
	-rm -rf ${D4}/pkgdb/d-0.0
	ROOT=${D4} ${PKG_ADD} new/e-0.0.tgz
d49 1
a49 1
collision-check3: new/d-0.0.tgz new/f-0.0.tgz
d51 3
a53 3
	ROOT=${D5} ${PKG_ADD} new/d-0.0.tgz new/f-0.0.tgz
	-rm -rf ${D5}/pkgdb/d-0.0
	ROOT=${D5} ${PKG_ADD} -F repair new/d-0.0.tgz
d56 1
a56 1
collision-check4: new/d-0.0.tgz new/e-0.0.tgz
d58 3
a60 3
	ROOT=${D6} ${PKG_ADD} new/d-0.0.tgz
	-rm -rf ${D6}/pkgdb/d-0.0
	ROOT=${D6} ${PKG_ADD} -F repair new/e-0.0.tgz
d62 1
a62 1
collision-check5: new/d-0.0.tgz new/e-0.0.tgz
d64 3
a66 3
	ROOT=${D7} ${PKG_ADD} new/d-0.0.tgz
	-rm -rf ${D7}/pkgdb/d-0.0
	ROOT=${D7} ${PKG_ADD} -F removecollisions new/d-0.0.tgz
d68 1
a68 1
always-update: old/g-0.0.tgz new/g-0.0.tgz
d70 2
a71 2
	ROOT=${D8} ${PKG_ADD} old/g-0.0.tgz
	ROOT=${D8} PKG_PATH=${.OBJDIR}/new ${PKG_ADD} -u
d74 2
a75 2
list-check: new/a-1.0.tgz new/b-1.0.tgz new/c-0.0.tgz new/d-0.0.tgz \
	new/e-0.0.tgz new/f-0.0.tgz new/g-0.0.tgz
d77 1
a77 1
	ROOT=${D9} PKG_PATH=${.OBJDIR}/new ${PKG_ADD} -l ${.CURDIR}/list
d80 2
a81 2
partial-update-test: old/h-0.0.tgz old/i-0.0.tgz old/j-0.0.tgz \
	new/h-1.0.tgz new/i-1.0.tgz new/j-1.0.tgz
d83 2
a84 2
	ROOT=${D10} PKG_PATH=${.OBJDIR}/old ${PKG_ADD} h j
	ROOT=${D10} PKG_PATH=${.OBJDIR}/new ${PKG_ADD} -u h
d87 1
a87 1
conflict-update: old/k-0.0.tgz old/l-0.0.tgz new/k-1.0.tgz new/l-1.0.tgz
d89 2
a90 2
	ROOT=${D11} PKG_PATH=${.OBJDIR}/old ${PKG_ADD} k l
	ROOT=${D11} PKG_PATH=${.OBJDIR}/new ${PKG_ADD} -u k
d93 1
a93 1
merge-update: old/m-0.0.tgz old/n-0.0.tgz new/m-1.0.tgz new/n-1.0.tgz
d95 2
a96 2
	ROOT=${D12} PKG_PATH=${.OBJDIR}/old ${PKG_ADD} m n
	ROOT=${D12} PKG_PATH=${.OBJDIR}/new ${PKG_ADD} -u n
d99 1
a99 1
split-update: old/o-0.0.tgz new/o-1.0.tgz new/p-0.0.tgz
d101 2
a102 2
	ROOT=${D13} PKG_PATH=${.OBJDIR}/old ${PKG_ADD} o
	ROOT=${D13} PKG_PATH=${.OBJDIR}/new ${PKG_ADD} -u o
d105 3
a107 3
big-merge: old/q1-0.0.tgz old/q2-0.0.tgz old/q3-0.0.tgz old/q4-0.0.tgz \
	old/q5-0.0.tgz old/q6-0.0.tgz new/q5-1.0.tgz new/q6-1.0.tgz \
	new/q1-1.0.tgz new/q2-1.0.tgz new/q3-1.0.tgz new/q4-1.0.tgz
d109 2
a110 2
	ROOT=${D14} PKG_PATH=${.OBJDIR}/old ${PKG_ADD} q1 q2 q3 q4 q5 q6
	ROOT=${D14} PKG_PATH=${.OBJDIR}/new ${PKG_ADD} -F update -u 2>&1|fgrep XXX|fgrep -v @@|diff - ${.CURDIR}/list6.out
d112 1
a112 1
family-circus: old/glib-0.0.tgz old/fam-0.0.tgz new/fam-1.0.tgz new/glib-1.0.tgz new/gamin-0.0.tgz
d114 2
a115 2
	ROOT=${D15} PKG_PATH=${.OBJDIR}/old ${PKG_ADD} glib
	ROOT=${D15} PKG_PATH=${.OBJDIR}/new ${PKG_ADD} -F updatedepends -u glib
d117 1
a117 1
missing: new/missa-0.tgz new/missb-0.tgz new/missc-0.tgz new/missd-0.tgz new/missf-0.tgz
d119 2
a120 2
	ROOT=${D16} PKG_PATH=${.OBJDIR}/new ${PKG_ADD} missc
	ROOT=${D15} PKG_PATH=${.OBJDIR}/new ${PKG_ADD} missa missb missf
d154 1
a154 1
	@@echo "@@conflict l-<1.0" >$@@
d157 2
a158 2
	@@echo "@@conflict m-<1.0" >$@@
	@@echo "@@pkgpath test/m" >>$@@
d161 2
a162 2
	@@echo "@@conflict o-<1.0" >$@@
	@@echo "@@pkgpath test/o" >>$@@
d171 1
a171 1
	@@echo "@@pkgpath test/fam" >>$@@
d176 2
a177 2
old/a-0.0.tgz:
	${PKG_CREATE} -P'test/b:b-*:b-0.0' -f ${.CURDIR}/empty $@@
d179 4
a182 4
new/a-1.0.tgz old/b-0.0.tgz old/i-0.0.tgz old/j-0.0.tgz new/j-1.0.tgz \
new/i-1.0.tgz old/k-0.0.tgz old/l-0.0.tgz new/l-1.0.tgz old/m-0.0.tgz \
old/n-0.0.tgz new/m-1.0.tgz old/o-0.0.tgz old/fam-0.0.tgz \
new/missc-0.tgz:
d185 2
a186 2
new/o-1.0.tgz:
	${PKG_CREATE} -P'test/p:p-*:p-0.0' -W'coincoin.0.0' -f ${.CURDIR}/empty $@@
d188 1
a188 1
new/p-0.0.tgz: plist8
d194 2
a195 2
new/b-1.0.tgz:
	${PKG_CREATE} -P'test/a:a-*:a-1.0' -f ${.CURDIR}/empty $@@
d197 1
a197 1
new/c-0.0.tgz: plist1
d205 1
a205 1
new/k-1.0.tgz: plist6
d208 1
a208 1
new/n-1.0.tgz: plist7
d211 1
a211 1
new/d-0.0.tgz: plist2
d218 1
a218 1
new/e-0.0.tgz: plist3
d225 2
a226 2
new/f-0.0.tgz:
	${PKG_CREATE} -P'test/d:d-*:d-0.0' -f ${.CURDIR}/empty $@@
d228 1
a228 1
old/g-0.0.tgz: plist4
d231 1
a231 1
new/g-0.0.tgz: plist5
d234 2
a235 2
old/h-0.0.tgz:
	${PKG_CREATE} -P'test/i:i-*:i-0.0' -f ${.CURDIR}/empty $@@
d237 2
a238 2
new/h-1.0.tgz:
	${PKG_CREATE} -P'test/j:j->=1:j-1.0' -f ${.CURDIR}/empty $@@
d240 4
a243 4
depend_q1=-P'test/q5:q5-*:q5-0.0'
depend_q2=${depend_q1} -P'test/q1:q1-*:q1-0.0'
depend_q3=${depend_q1} -P'test/q2:q2-*:q2-0.0'
depend_q4=${depend_q1} -P'test/q3:q3-*:q3-0.0'
d246 2
a247 2
plist-old-$n:
	@@echo "@@unexec echo 1>&2 'XXXold $n'" >$@@
d249 11
a259 11
old/$n-0.0.tgz: plist-old-$n
	${PKG_CREATE} ${depend_$n} -f plist-old-$n $@@
new/$n-1.0.tgz: plist-new-$n
	${PKG_CREATE} ${depend_$n} -f plist-new-$n $@@

plist-new-$n:
	@@echo "@@conflict q1-0.0" >$@@
	@@echo "@@conflict q2-0.0" >>$@@
	@@echo "@@conflict q3-0.0" >>$@@
	@@echo "@@conflict q4-0.0" >>$@@
	@@echo "@@exec echo 1>&2 'XXXnew $n'" >>$@@
d263 1
a263 1
old/q5-0.0.tgz:
d266 1
a266 1
new/q5-1.0.tgz:
d269 2
a270 2
old/q6-0.0.tgz:
	${PKG_CREATE} -P'test/q3:q3-*:q3-0.0' -f ${.CURDIR}/empty $@@
d272 2
a273 2
new/q6-1.0.tgz:
	${PKG_CREATE} -P'test/q3:q3-*:q3-0.0' -f ${.CURDIR}/empty $@@
d275 2
a276 2
old/glib-0.0.tgz:
	${PKG_CREATE} -P 'test/fam:fam-*:fam-0.0' -f ${.CURDIR}/empty $@@
d278 2
a279 2
new/glib-1.0.tgz:
	${PKG_CREATE} -P 'test/gamin:gamin-*:gamin-0.0' -f ${.CURDIR}/empty $@@
d281 1
a281 1
new/fam-1.0.tgz: plist9
d284 1
a284 1
new/gamin-0.0.tgz: plist10
d287 2
a288 2
new/missa-0.tgz:
	${PKG_CREATE} -P'test/misse:misse-*:misse-0' -f ${.CURDIR}/empty $@@
d290 2
a291 2
new/missb-0.tgz:
	${PKG_CREATE} -P'test/missd:missd-*:missd-0' -f ${.CURDIR}/empty $@@
d293 1
a293 1
new/missd-0.tgz: plist11
d296 2
a297 2
new/missf-0.tgz:
	${PKG_CREATE} -P'test/misse:misse-*:misse-0' -f ${.CURDIR}/empty $@@
d304 1
a304 1
	-rm -rf old new dest* plist* src*
@


1.23
log
@test case for the gamin/fam scenario
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.22 2009/12/12 07:06:45 espie Exp $
d5 1
a5 1
	merge-update split-update big-merge family-circus
d117 5
d173 3
d181 2
a182 1
old/n-0.0.tgz new/m-1.0.tgz old/o-0.0.tgz old/fam-0.0.tgz:
d286 12
@


1.22
log
@more complex testcase: let q1-q4 have dependencies with outside q5,q6.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.21 2009/12/11 20:57:45 espie Exp $
d5 1
a5 1
	merge-update split-update big-merge
d112 5
a116 1
	
a155 1
	@@mkdir -p ${@@D}
d161 7
d173 1
a173 1
old/n-0.0.tgz new/m-1.0.tgz old/o-0.0.tgz:
d265 12
@


1.21
log
@sample case we fail (kili/edd): if updatesets contain "self" dependencies,
they should install/uninstall in the correct order to be able to handle any
@@exec activity...
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.20 2009/12/11 13:02:59 espie Exp $
d106 1
d109 2
a110 2
	ROOT=${D14} PKG_PATH=${.OBJDIR}/old ${PKG_ADD} q1 q2 q3 q4
	ROOT=${D14} PKG_PATH=${.OBJDIR}/new ${PKG_ADD} -F update -u q1 q2 q3 q4 2>&1|fgrep XXX|fgrep -v @@|diff - ${.CURDIR}/list6.out
d221 4
a224 4
depend_q1=
depend_q2=-P'test/q1:q1-*:q1-0.0'
depend_q3=-P'test/q2:q2-*:q2-0.0'
depend_q4=-P'test/q3:q3-*:q3-0.0'
d244 11
@


1.20
log
@simplify building of libs
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.19 2009/12/03 18:45:50 espie Exp $
d5 1
a5 1
	merge-update split-update
d105 7
d220 23
@


1.19
log
@split-update test with shared libraries, twice the fun.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.18 2009/12/02 11:40:12 espie Exp $
d143 1
a143 1
plist-p/PLIST:
d148 1
a148 5
	@@echo "%%SHARED%%" >>$@@

plist-p/PFRAG.shared:
	@@mkdir -p ${@@D}
	@@echo '@@lib lib/libcoincoin.so.$${LIBcoincoin_VERSION}' >$@@
d161 1
a161 1
new/p-0.0.tgz: p/PLIST p/PFRAG.shared
d164 1
a164 1
	${PKG_CREATE} -B src13 -DSHARED_LIBS=1 -DLIBcoincoin_VERSION=0.0 -f p/PLIST $@@
@


1.18
log
@and check result
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.17 2009/12/02 11:21:42 espie Exp $
d143 2
a144 1
plist8:
d146 7
a152 1
	@@echo "@@pkgpath test/n" >>$@@
d163 6
a168 1
	${PKG_CREATE} -P'test/p:p-*:p-0.0' -f ${.CURDIR}/empty $@@
a169 2
new/p-0.0.tgz: plist8
	${PKG_CREATE} -f plist8 $@@
@


1.17
log
@splitted update: a -> a + b with inter-dependencies
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.16 2009/11/22 12:57:35 espie Exp $
d5 1
a5 1
	merge-update
d103 1
@


1.16
log
@and so, check the other case as well (this one does work by accident)
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.15 2009/11/22 12:44:06 espie Exp $
d14 1
a14 1
.for i in 1 2 3 4 5 6 7 8 9 10 11 12
d99 5
d142 4
d151 1
a151 1
old/n-0.0.tgz new/m-1.0.tgz:
d153 6
@


1.15
log
@new test, modeled after some old kde update.
When a file moves between packages, one new package will conflict with
two old packages, in which case pkg_add should update both (and it does not,
not yet).

We distinguish from the case where a new package is an update for two packages
by the absence of a @@pkgpath annotation.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.14 2009/11/22 11:32:17 espie Exp $
d4 2
a5 1
	collision-check3 partial-update-test conflict-update
d14 1
a14 1
.for i in 1 2 3 4 5 6 7 8 9 10 11
d93 6
d133 4
d140 3
a142 1
new/a-1.0.tgz old/b-0.0.tgz old/i-0.0.tgz old/j-0.0.tgz new/j-1.0.tgz new/i-1.0.tgz old/k-0.0.tgz old/l-0.0.tgz new/l-1.0.tgz:
d158 3
@


1.14
log
@partial updates ought to update only their dep tree
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.13 2009/11/16 15:15:15 espie Exp $
d4 1
a4 1
	collision-check3 partial-update-test
d13 1
a13 1
.for i in 1 2 3 4 5 6 7 8 9 10
a72 1

d86 5
d123 3
d129 1
a129 1
new/a-1.0.tgz old/b-0.0.tgz old/i-0.0.tgz old/j-0.0.tgz new/j-1.0.tgz new/i-1.0.tgz:
d143 3
d176 3
a178 3
.PHONY: pkgnames depends-check longnames \
	collision-check1 collision-check2 collision-check3 \
	collision-check4 collision-check5 partial-update-test
@


1.13
log
@verify that fuzzy list stuff works
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.12 2009/11/15 08:50:59 espie Exp $
d4 1
a4 1
	collision-check3
d13 1
a13 1
.for i in 1 2 3 4 5 6 7 8 9
d73 1
d80 6
a85 12
old/a-0.0.tgz:
	${PKG_CREATE} -P'test/b:b-*:b-0.0' -f ${.CURDIR}/empty $@@

new/a-1.0.tgz:
	${PKG_CREATE} -f ${.CURDIR}/empty $@@

old/b-0.0.tgz:
	${PKG_CREATE} -f ${.CURDIR}/empty $@@

new/b-1.0.tgz:
	${PKG_CREATE} -P'test/a:a-*:a-1.0' -f ${.CURDIR}/empty $@@

d119 9
d159 7
d168 1
a168 1
	collision-check4 collision-check5
@


1.12
log
@tweak
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.11 2009/11/15 08:46:07 espie Exp $
d72 6
@


1.11
log
@add check for always-update
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.10 2009/11/15 08:38:19 espie Exp $
d3 2
a4 1
REGRESS_TARGETS=pkgnames depends-check longnames always-update
d71 1
@


1.10
log
@repair things if dependencies exist
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.9 2009/11/14 21:04:24 espie Exp $
d3 1
a3 1
REGRESS_TARGETS=pkgnames depends-check longnames
d66 5
d108 8
d122 1
a122 1
	${PKG_CREATE} -B ${.OBJDIR}/src1 -f plist1 $@@
d129 1
a129 1
	${PKG_CREATE} -B ${.OBJDIR}/src2 -f ${.OBJDIR}/plist2 $@@
d136 1
a136 1
	${PKG_CREATE} -B ${.OBJDIR}/src3 -f ${.OBJDIR}/plist3 $@@
d140 6
@


1.9
log
@more tests
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.8 2009/11/14 20:48:14 espie Exp $
d47 1
a47 1
collision-check3: new/d-0.0.tgz new/e-0.0.tgz
d49 1
a49 1
	ROOT=${D5} ${PKG_ADD} new/d-0.0.tgz
d52 1
d124 3
@


1.8
log
@more half-baked regress-targets
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.7 2009/11/14 10:25:53 espie Exp $
d59 6
d125 2
a126 1
	collision-check1 collision-check2 collision-check3
@


1.7
log
@add a collision-check, don't activate yet, need to understand what
pkg_add should output, and fix it.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.6 2009/11/14 10:13:32 espie Exp $
d13 4
a16 2
SRC$i ?= ${.OBJDIR}/src$i/usr/local
DEST$i ?= ${.OBJDIR}/dest$i/usr/local
d23 35
a57 8
	-rm -rf ${.OBJDIR}/dest1
	ROOT=${.OBJDIR}/dest1 ${PKG_ADD} old/a-0.0.tgz old/b-0.0.tgz
	ROOT=${.OBJDIR}/dest1 PKG_PATH=${.OBJDIR}/new ${PKG_ADD} -u a b
	ROOT=${.OBJDIR}/dest1 PKG_PATH=${.OBJDIR}/old ${PKG_ADD} -F downgrade -u a b

collision-check: new/d-0.0.tgz new/e-0.0.tgz
	ROOT=${.OBJDIR}/dest3 ${PKG_ADD} new/d-0.0.tgz
	ROOT=${.OBJDIR}/dest3 ${PKG_ADD} new/e-0.0.tgz
a71 7
longnames: new/c-0.0.tgz
	-rm -rf ${.OBJDIR}/dest2
	ROOT=${.OBJDIR}/dest2 ${PKG_ADD} new/c-0.0.tgz
	@@test -f ${DEST2}/${LONG1}
	@@test -f ${DEST2}/${LONG2}
	@@cd ${DEST2} && test -h ${LONG3} && test `readlink ${LONG3}` = ${LONG2}
	@@cd ${DEST2} && test `stat -f '%i' ${LONG1}` = `stat -f '%i' ${LONG4}`
d118 2
a119 1
.PHONY: pkgnames depends-check longnames
@


1.6
log
@variables for concision
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.5 2009/11/14 10:09:24 espie Exp $
d12 4
a15 2
SRC1=${.OBJDIR}/src1/usr/local
DEST2=${.OBJDIR}/dest2/usr/local
d26 4
d58 16
d81 14
@


1.5
log
@add a somewhat icky test that will check that packages can represent fairly
long file (and link) names correctly.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.4 2009/11/14 09:34:56 espie Exp $
d12 3
d40 4
a43 4
	@@test -f ${.OBJDIR}/dest2/usr/local/${LONG1}
	@@test -f ${.OBJDIR}/dest2/usr/local/${LONG2}
	@@cd ${.OBJDIR}/dest2/usr/local && test -h ${LONG3} && test `readlink ${LONG3}` = ${LONG2}
	@@cd ${.OBJDIR}/dest2/usr/local && test `stat -f '%i' ${LONG1}` = `stat -f '%i' ${LONG4}`
d53 5
a57 5
	mkdir -p ${.OBJDIR}/src1/usr/local
	@@touch ${.OBJDIR}/src1/usr/local/${LONG1}
	@@touch ${.OBJDIR}/src1/usr/local/${LONG2}
	@@cd ${.OBJDIR}/src1/usr/local && ln -sf ${LONG2} ${LONG3}
	@@cd ${.OBJDIR}/src1/usr/local && ln -f ${LONG1} ${LONG4}
@


1.4
log
@fix regress test (needs -F downgrade to be able to go back)
Introduce two scripts to make it easier to write a "full" scaffolding for
further tests, to be used soonish...
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.3 2006/08/18 13:14:34 espie Exp $
d3 1
a3 1
REGRESS_TARGETS=pkgnames depends-check
d7 4
d16 4
a19 4
	-rm -rf ${.OBJDIR}/depends
	ROOT=${.OBJDIR}/depends ${PKG_ADD} old/a-0.0.tgz old/b-0.0.tgz
	ROOT=${.OBJDIR}/depends PKG_PATH=${.OBJDIR}/new ${PKG_ADD} -u a b
	ROOT=${.OBJDIR}/depends PKG_PATH=${.OBJDIR}/old ${PKG_ADD} -F downgrade -u a b
a32 1
.PHONY: pkgnames depends-check
d34 27
a60 1
CLEANFILES+=old/*.tgz new/*.tgz depends/*/*/*
@


1.3
log
@py-cairo/py-gtk2 deathlock of dependencies. Not fixed yet.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.2 2004/03/02 06:55:26 david Exp $
d5 3
d13 3
a15 4
	-mkdir -p ${.OBJDIR}/depends/pkgdb
	PKG_DBDIR=${.OBJDIR}/depends/pkgdb pkg_add -F nonroot -B${.OBJDIR}/depends old/a-0.0.tgz old/b-0.0.tgz
	PKG_DBDIR=${.OBJDIR}/depends/pkgdb PKG_PATH=${.OBJDIR}/new pkg_add -F nonroot -B${.OBJDIR}/depends -u a b
	PKG_DBDIR=${.OBJDIR}/depends/pkgdb PKG_PATH=${.OBJDIR}/old pkg_add -F nonroot -B${.OBJDIR}/depends -u a b
d18 1
a18 7
	-mkdir -p ${@@D}
	pkg_create -p /usr/local -A \* \
	    -DFULLPKGPATH=test/a \
	    -DPERMIT_PACKAGE_FTP=Yes \
	    -DPERMIT_PACKAGE_CDROM=Yes \
	    -P'test/b:b-*:b-0.0' \
	    -c '-comment' -d '-descr' -f ${.CURDIR}/empty $@@
d21 1
a21 6
	-mkdir -p ${@@D}
	pkg_create -p /usr/local -A \* \
	    -DFULLPKGPATH=test/a \
	    -DPERMIT_PACKAGE_FTP=Yes \
	    -DPERMIT_PACKAGE_CDROM=Yes \
	    -c '-comment' -d '-descr' -f ${.CURDIR}/empty $@@
d24 1
a24 6
	-mkdir -p ${@@D}
	pkg_create -p /usr/local -A \* \
	    -DFULLPKGPATH=test/a \
	    -DPERMIT_PACKAGE_FTP=Yes \
	    -DPERMIT_PACKAGE_CDROM=Yes \
	    -c '-comment' -d '-descr' -f ${.CURDIR}/empty $@@
d27 1
a27 7
	-mkdir -p ${@@D}
	pkg_create -p /usr/local -A \* \
	    -DFULLPKGPATH=test/a \
	    -DPERMIT_PACKAGE_FTP=Yes \
	    -DPERMIT_PACKAGE_CDROM=Yes \
	    -P'test/a:a-*:a-1.0' \
	    -c '-comment' -d '-descr' -f ${.CURDIR}/empty $@@
@


1.2
log
@fix path; ok espie@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.1 2004/02/21 19:07:29 espie Exp $
d3 1
a3 1
REGRESS_TARGETS=pkgnames
d8 44
a51 1
.PHONY: pkgnames 
@


1.1
log
@First regression test for pkg_add, checking packages-specs lists.
(the nice thing about having this as perl modules is that we CAN write
regression tests)
@
text
@d1 1
a1 1
# $OpenBSD$
d6 1
a6 1
	perl check-name
@

