head	1.4;
access;
symbols
	OPENBSD_6_2_BASE:1.4
	OPENBSD_6_1:1.4.0.4
	OPENBSD_6_1_BASE:1.4
	OPENBSD_6_0:1.1.0.2
	OPENBSD_6_0_BASE:1.1;
locks; strict;
comment	@# @;


1.4
date	2016.11.17.14.37.55;	author rzalamena;	state Exp;
branches;
next	1.3;
commitid	YOpoiKxev4CTbLu0;

1.3
date	2016.11.16.11.36.03;	author rzalamena;	state Exp;
branches;
next	1.2;
commitid	5ew1cnC8JO9gMFth;

1.2
date	2016.10.05.15.29.26;	author reyk;	state Exp;
branches;
next	1.1;
commitid	JHb6kPeFbC6FtRWB;

1.1
date	2016.07.19.17.04.19;	author reyk;	state Exp;
branches;
next	;
commitid	NW612ITUogzMeheS;


desc
@@


1.4
log
@Add support for OpenFlow 1.3.5 tests and make jumbo test use the new
version.

ok reyk@@
@
text
@# $OpenBSD: args-packet-jumbo.pm,v 1.3 2016/11/16 11:36:03 rzalamena Exp $

# Copyright (c) 2016 Reyk Floeter <reyk@@openbsd.org>
#
# Permission to use, copy, modify, and distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

package args_packet_jumbo;

use strict;
use warnings;
use base qw(Exporter);
our @@EXPORT = qw(init next);

my $topology = {
	buffers => {},
	hosts => {
		"a00000000001" => {
			"port" => 1
		},
		"a00000000002" => {
			"port" => 2
		},
		"a00000000003" => {
			"port" => 3
		}
	},
	packets => [
		{
			"src_mac" => "a00000000001",
			"dest_mac" => "a00000000002",
			"src_ip" => "10.0.0.1",
			"src_port" => 12345,
			"dest_ip" => "10.0.0.2",
			"dest_port" => 80,
			"length" => 2048,
			"count" => 3,
			"ofp_response" => main::OFP_T_PACKET_OUT()
		},
		{
			"src_mac" => "a00000000002",
			"dest_mac" => "a00000000001",
			"src_ip" => "10.0.0.2",
			"src_port" => 80,
			"dest_ip" => "10.0.0.1",
			"dest_port" => 12345,
			"length" => 17000,
			"count" => 3,
			"ofp_response" => main::OFP_T_FLOW_MOD()

		},
		{
			"src_mac" => "a00000000001",
			"dest_mac" => "ffffffffffff",
			"src_ip" => "10.0.0.1",
			"dest_ip" => "10.255.255.255",
			"length" => 65451,
			"count" => 3,
			"ofp_response" => main::OFP_T_PACKET_OUT()
		}
	]
};

sub init {
	my $class = shift;
	my $sock = shift;
	my $self = { "count" => 0,
	    "sock" => $sock, "version" => main::OFP_V_1_3() };

	bless($self, $class);
	main::ofp_hello($self);

	for (my $i = 0; $i < @@{$topology->{packets}}; $i++) {
		my $packet = $topology->{packets}[$i];
		my $src = $topology->{hosts}->{$packet->{src_mac}};

		$self->{port} = $src->{port} if ($src);

		for (my $j = 0; $j < $packet->{count}; $j++) {
			my $ofp;
			$self->{count}++;
			$ofp = main::packet_send($self, $packet);

			if (not defined($packet->{ofp_response})) {
				continue;
			}

			if ($ofp->{type} != $packet->{ofp_response}) {
				main::fatal($class,
				    "invalid ofp response type " .
				    $ofp->{type});
			}

			# Flow-mod also expects an packet-out.
			if ($packet->{ofp_response} == main::OFP_T_FLOW_MOD()) {
				$ofp = main::ofp_input($self);
				if ($ofp->{type} != main::OFP_T_PACKET_OUT()) {
					main::fatal($class,
					    "invalid ofp response type " .
					    $ofp->{type});
				}
			}
		}
	}

	return ($self);
}

sub next {
	# Not used
}

1;
@


1.3
log
@Add support for big reads in perl and fix the jumbo test, also remove
message type specific code from OFP encode.

ok reyk@@
@
text
@d1 1
a1 1
# $OpenBSD: args-packet-jumbo.pm,v 1.2 2016/10/05 15:29:26 reyk Exp $
d66 1
a66 1
			"length" => 65469,
d77 1
a77 1
	    "sock" => $sock, "version" => main::OFP_V_1_0() };
d93 14
a106 2
			if (defined($packet->{ofp_response})) {
				if ($ofp->{type} != $packet->{ofp_response}) {
d108 1
a108 1
					    "invalid ofp response type ".
@


1.2
log
@Bump the sizes of generated jumbo frames up to the max.
@
text
@d1 1
a1 1
# $OpenBSD: args-packet-jumbo.pm,v 1.1 2016/07/19 17:04:19 reyk Exp $
d66 1
a66 1
			"length" => 65475,
@


1.1
log
@Add simple OpenFlow tests for switchd.
@
text
@d1 1
a1 1
# $OpenBSD$
d45 1
a45 1
			"length" => 1000,
d56 1
a56 1
			"length" => 1000,
d66 1
a66 1
			"length" => 5000,
@

