head	1.8;
access;
symbols
	OPENBSD_6_1:1.8.0.8
	OPENBSD_6_1_BASE:1.8
	OPENBSD_6_0:1.8.0.4
	OPENBSD_6_0_BASE:1.8
	OPENBSD_5_9:1.8.0.2
	OPENBSD_5_9_BASE:1.8
	OPENBSD_5_8:1.1.0.10
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.2
	OPENBSD_5_7_BASE:1.1
	OPENBSD_5_6:1.1.0.6
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.4
	OPENBSD_5_5_BASE:1.1;
locks; strict;
comment	@ * @;


1.8
date	2016.01.15.22.19.29;	author tobiasu;	state Exp;
branches;
next	1.7;
commitid	oY0buPDixkz30OZB;

1.7
date	2015.11.30.17.34.57;	author jsing;	state Exp;
branches;
next	1.6;
commitid	E65fbNPRxq1kisMY;

1.6
date	2015.11.26.19.03.10;	author deraadt;	state Exp;
branches;
next	1.5;
commitid	l08CzgnpmHFvutrT;

1.5
date	2015.10.15.19.27.30;	author miod;	state Exp;
branches;
next	1.4;
commitid	R07mNNZ6Dolm5xg5;

1.4
date	2015.10.11.15.36.58;	author deraadt;	state Exp;
branches;
next	1.3;
commitid	2MeWXoHo5UNawwes;

1.3
date	2015.10.08.14.50.38;	author krw;	state Exp;
branches;
next	1.2;
commitid	xtMQpAxwl7GHdojH;

1.2
date	2015.10.05.04.30.35;	author miod;	state Exp;
branches;
next	1.1;
commitid	ucwoQEGvFyqr9gZM;

1.1
date	2014.01.19.02.58.50;	author jsing;	state Exp;
branches;
next	;


desc
@@


1.8
log
@sync() needs unistd.h
@
text
@/*	$OpenBSD: landisk_installboot.c,v 1.7 2015/11/30 17:34:57 jsing Exp $	*/

/*
 * Copyright (c) 2013 Joel Sing <jsing@@openbsd.org>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#include <stdlib.h>
#include <unistd.h>

#include "installboot.h"

char	*bootldr;

void
md_init(void)
{
	stages = 2;
	stage1 = "/usr/mdec/xxboot";
	stage2 = "/usr/mdec/boot";

	bootldr = "/boot";
}

void
md_loadboot(void)
{
}

void
md_installboot(int devfd, char *dev)
{
	/* XXX - is this necessary? */
	sync();

	bootldr = fileprefix(root, bootldr);
	if (bootldr == NULL)
		exit(1);
	if (!nowrite)
		if (filecopy(stage2, bootldr) == -1)
			exit(1);

	/* Write bootblock into the superblock. */
	bootstrap(devfd, dev, stage1, 0);
}
@


1.7
log
@Revert the sync -> fsync conversion (at least for the time being) - there
is a good chance that this is causing the 'No blocks to load' errors that
various people have encountered.
@
text
@d1 1
a1 1
/*	$OpenBSD: landisk_installboot.c,v 1.6 2015/11/26 19:03:10 deraadt Exp $	*/
d20 1
@


1.6
log
@Apply pledge.
The people I asked to review this did not get back to me, so
we will test this a different way.
@
text
@d1 1
a1 1
/*	$OpenBSD: landisk_installboot.c,v 1.5 2015/10/15 19:27:30 miod Exp $	*/
d43 2
a44 1
	fsync(devfd);
@


1.5
log
@Add an extra argument to bootstrap() to allow for a limited overlap between an
existing partition and the boot blocks span, and update all callers to require
an overlap limit of zero sectors (thus not changing their behaviour).

Then, add proper support for vax: copy the 2nd-stage boot block to /boot and
install the 1st-stage boot block at the beginning of the disk, retaining the
disklabel; allow for an overlap of up to 16 sectors, which is perfectly fine
as long as your `a' partition is FFS.

Note that regular installs will not even have such an overlap, because the
default OpenBSD span on a disk on vax starts at sector 16, but installation
media use sperific layout which require this.

ok krw@@
@
text
@d1 1
a1 1
/*	$OpenBSD: landisk_installboot.c,v 1.4 2015/10/11 15:36:58 deraadt Exp $	*/
d43 1
a43 2
	/* XXX - is this necessary? */
	sync();
@


1.4
log
@needs at least some include love; choosing <stdlib.h>
@
text
@d1 1
a1 1
/*	$OpenBSD: landisk_installboot.c,v 1.3 2015/10/08 14:50:38 krw Exp $	*/
d54 1
a54 1
	bootstrap(devfd, dev, stage1);
@


1.3
log
@Refactor fileprefix() and filecopy() to use warn() instead of err()
to display error message, and to return error indications (NULL and
-1 respectively).  Use the error indications in write_efisystem()
to unwind in the face of more error conditions. In other cases just
exit(1) to emulation current behaviour.

ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: landisk_installboot.c,v 1.2 2015/10/05 04:30:35 miod Exp $	*/
d18 2
@


1.2
log
@Copy the stage2 file to / in md_installboot().
@
text
@d1 1
a1 1
/*	$OpenBSD: landisk_installboot.c,v 1.1 2014/01/19 02:58:50 jsing Exp $	*/
d45 2
d48 2
a49 1
		filecopy(stage2, bootldr);
@


1.1
log
@Rework installboot and use a single directory with a single makefile. The
directory per machine model is arguably cleaner, however it does not play
well with distrib/special and instbin.

Discussed with deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: landisk_installboot.c,v 1.1 2013/12/28 13:58:15 jsing Exp $	*/
d21 2
d28 3
a30 1
	stage2 = "/boot";
d41 8
@

