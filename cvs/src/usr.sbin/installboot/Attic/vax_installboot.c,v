head	1.6;
access;
symbols
	OPENBSD_5_9:1.5.0.2
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.1.0.10
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.2
	OPENBSD_5_7_BASE:1.1
	OPENBSD_5_6:1.1.0.6
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.4
	OPENBSD_5_5_BASE:1.1;
locks; strict;
comment	@ * @;


1.6
date	2016.03.09.16.28.50;	author deraadt;	state dead;
branches;
next	1.5;
commitid	OSDG2O3Cgeifnf1W;

1.5
date	2016.02.18.23.38.18;	author tobiasu;	state Exp;
branches;
next	1.4;
commitid	5b7vEXrWsB5CdaQU;

1.4
date	2015.11.30.17.34.57;	author jsing;	state Exp;
branches;
next	1.3;
commitid	E65fbNPRxq1kisMY;

1.3
date	2015.11.26.19.03.10;	author deraadt;	state Exp;
branches;
next	1.2;
commitid	l08CzgnpmHFvutrT;

1.2
date	2015.10.15.19.27.30;	author miod;	state Exp;
branches;
next	1.1;
commitid	R07mNNZ6Dolm5xg5;

1.1
date	2014.01.19.02.58.50;	author jsing;	state Exp;
branches;
next	;


desc
@@


1.6
log
@We are done providing support for the vax.
lots of agreement.
@
text
@/*	$OpenBSD: vax_installboot.c,v 1.5 2016/02/18 23:38:18 tobiasu Exp $	*/

/*
 * Copyright (c) 2013 Joel Sing <jsing@@openbsd.org>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#include <stdlib.h>
#include <unistd.h>

#include "installboot.h"

char	*bootldr;

void
md_init(void)
{
	stages = 2;
	stage1 = "/usr/mdec/xxboot";
	stage2 = "/usr/mdec/boot";

	bootldr = "/boot";
}

void
md_loadboot(void)
{
}

void
md_installboot(int devfd, char *dev)
{
	/* XXX - is this necessary? */
	sync();

	bootldr = fileprefix(root, bootldr);
	if (bootldr == NULL)
		exit(1);
	if (!nowrite)
		if (filecopy(stage2, bootldr) == -1)
			exit(1);

	/* Write bootblock into the superblock. */
	bootstrap(devfd, dev, stage1, 16);
}
@


1.5
log
@sync() requires unistd.h

Reported by Sigi Rudzio. Thanks!

"go for it" deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: vax_installboot.c,v 1.4 2015/11/30 17:34:57 jsing Exp $	*/
@


1.4
log
@Revert the sync -> fsync conversion (at least for the time being) - there
is a good chance that this is causing the 'No blocks to load' errors that
various people have encountered.
@
text
@d1 1
a1 1
/*	$OpenBSD: vax_installboot.c,v 1.3 2015/11/26 19:03:10 deraadt Exp $	*/
d20 1
@


1.3
log
@Apply pledge.
The people I asked to review this did not get back to me, so
we will test this a different way.
@
text
@d1 1
a1 1
/*	$OpenBSD: vax_installboot.c,v 1.2 2015/10/15 19:27:30 miod Exp $	*/
d43 2
a44 1
	fsync(devfd);
@


1.2
log
@Add an extra argument to bootstrap() to allow for a limited overlap between an
existing partition and the boot blocks span, and update all callers to require
an overlap limit of zero sectors (thus not changing their behaviour).

Then, add proper support for vax: copy the 2nd-stage boot block to /boot and
install the 1st-stage boot block at the beginning of the disk, retaining the
disklabel; allow for an overlap of up to 16 sectors, which is perfectly fine
as long as your `a' partition is FFS.

Note that regular installs will not even have such an overlap, because the
default OpenBSD span on a disk on vax starts at sector 16, but installation
media use sperific layout which require this.

ok krw@@
@
text
@d1 1
a1 1
/*	$OpenBSD: vax_installboot.c,v 1.1 2014/01/19 02:58:50 jsing Exp $	*/
d43 1
a43 2
	/* XXX - is this necessary? */
	sync();
@


1.1
log
@Rework installboot and use a single directory with a single makefile. The
directory per machine model is arguably cleaner, however it does not play
well with distrib/special and instbin.

Discussed with deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: vax_installboot.c,v 1.1 2013/12/28 12:03:57 jsing Exp $	*/
d19 2
d23 2
d30 3
a32 1
	stage2 = "/boot";
d43 12
a54 1
	bootstrap(devfd, dev, stage1);
@

