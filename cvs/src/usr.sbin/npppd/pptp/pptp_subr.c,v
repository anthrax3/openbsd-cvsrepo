head	1.4;
access;
symbols
	OPENBSD_6_1:1.4.0.22
	OPENBSD_6_1_BASE:1.4
	OPENBSD_6_0:1.4.0.18
	OPENBSD_6_0_BASE:1.4
	OPENBSD_5_9:1.4.0.14
	OPENBSD_5_9_BASE:1.4
	OPENBSD_5_8:1.4.0.16
	OPENBSD_5_8_BASE:1.4
	OPENBSD_5_7:1.4.0.8
	OPENBSD_5_7_BASE:1.4
	OPENBSD_5_6:1.4.0.12
	OPENBSD_5_6_BASE:1.4
	OPENBSD_5_5:1.4.0.10
	OPENBSD_5_5_BASE:1.4
	OPENBSD_5_4:1.4.0.6
	OPENBSD_5_4_BASE:1.4
	OPENBSD_5_3:1.4.0.4
	OPENBSD_5_3_BASE:1.4
	OPENBSD_5_2:1.4.0.2
	OPENBSD_5_2_BASE:1.4
	OPENBSD_5_1_BASE:1.3
	OPENBSD_5_1:1.3.0.8
	OPENBSD_5_0:1.3.0.6
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_9:1.3.0.4
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.3.0.2
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.1.0.2
	OPENBSD_4_7_BASE:1.1;
locks; strict;
comment	@ * @;


1.4
date	2012.05.08.13.15.12;	author yasuoka;	state Exp;
branches;
next	1.3;

1.3
date	2010.07.02.21.20.57;	author yasuoka;	state Exp;
branches;
next	1.2;

1.2
date	2010.07.01.03.38.17;	author yasuoka;	state Exp;
branches;
next	1.1;

1.1
date	2010.01.11.04.20.57;	author yasuoka;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Fix comments and styles.  Delete unused variables and labels.
No binary changes.

ok mcbride henning
@
text
@/*	$OpenBSD: pptp_subr.c,v 1.3 2010/07/02 21:20:57 yasuoka Exp $ */

/*-
 * Copyright (c) 2009 Internet Initiative Japan Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */

/* utility functions for the pptp.c */

#include <sys/types.h>
#include <sys/socket.h>
#include <sys/time.h>
#include <netinet/in.h>
#include <stdio.h>
#include <string.h>
#include <event.h>

#include "bytebuf.h"
#include "hash.h"
#include "slist.h"

#include "pptp.h"
#include "pptp_local.h"
#include "pptp_subr.h"

/* convert the Faming Capability bit as CSV strings */
const char *
pptp_framing_string(uint32_t bits)
{
	static char framing_cap_buf[40];

	snprintf(framing_cap_buf, sizeof(framing_cap_buf), "%s%s",
	    (bits & PPTP_CTRL_FRAMING_ASYNC)? ",async" : "",
	    (bits & PPTP_CTRL_FRAMING_SYNC)? ",sync" : "");

	if (strlen(framing_cap_buf) > 0)
		return &framing_cap_buf[1];

	return "";
}


/* convert the Bearer Capability bit as CSV strings */
const char *
pptp_bearer_string(uint32_t bits)
{
	static char bearer_cap_buf[40];

	snprintf(bearer_cap_buf, sizeof(bearer_cap_buf), "%s%s",
	    (bits &PPTP_CTRL_BEARER_ANALOG)? ",analog" : "",
	    (bits &PPTP_CTRL_BEARER_DIGITAL)? ",digital" : "");

	if (strlen(bearer_cap_buf) > 0)
		return &bearer_cap_buf[1];

	return "";
}

/* build common header part of a control packet */
void
pptp_init_header(struct pptp_ctrl_header *header, int length, int ctrl_mes_type)
{
	header->length = htons(length);
	header->pptp_message_type = htons(PPTP_MES_TYPE_CTRL);
	header->magic_cookie = htonl(PPTP_MAGIC_COOKIE);
	header->control_message_type = htons(ctrl_mes_type);
	header->reserved0 = 0;
}

#define	NAME_VAL(x)	{ x, #x }
static struct _label_name {
	int		label;
	const char	*name;
} pptp_StopCCRQ_reason_labels[] = {
	NAME_VAL(PPTP_StopCCRQ_REASON_NONE),
	NAME_VAL(PPTP_StopCCRQ_REASON_STOP_PROTOCOL),
	NAME_VAL(PPTP_StopCCRQ_REASON_STOP_LOCAL_SHUTDOWN),
}, pptp_StopCCRP_result_labels[] = {
	NAME_VAL(PPTP_StopCCRP_RESULT_OK),
	NAME_VAL(PPTP_StopCCRP_RESULT_GENERIC_ERROR),
}, pptp_general_error_labels[] = {
	NAME_VAL(PPTP_ERROR_NONE),
	NAME_VAL(PPTP_ERROR_NOT_CONNECTED),
	NAME_VAL(PPTP_ERROR_BAD_FORMAT),
	NAME_VAL(PPTP_ERROR_NO_RESOURCE),
	NAME_VAL(PPTP_ERROR_BAD_CALL),
}, pptp_ctrl_mes_type_labels[] = {
	NAME_VAL(PPTP_CTRL_MES_CODE_SCCRQ),
	NAME_VAL(PPTP_CTRL_MES_CODE_SCCRP),
	NAME_VAL(PPTP_CTRL_MES_CODE_StopCCRQ),
	NAME_VAL(PPTP_CTRL_MES_CODE_StopCCRP),
	NAME_VAL(PPTP_CTRL_MES_CODE_ECHO_RQ),
	NAME_VAL(PPTP_CTRL_MES_CODE_ECHO_RP),
	NAME_VAL(PPTP_CTRL_MES_CODE_OCRQ),
	NAME_VAL(PPTP_CTRL_MES_CODE_OCRP),
	NAME_VAL(PPTP_CTRL_MES_CODE_ICRQ),
	NAME_VAL(PPTP_CTRL_MES_CODE_ICRP),
	NAME_VAL(PPTP_CTRL_MES_CODE_ICCN),
	NAME_VAL(PPTP_CTRL_MES_CODE_CCR),
	NAME_VAL(PPTP_CTRL_MES_CODE_CDN),
	NAME_VAL(PPTP_CTRL_MES_CODE_SLI),
}, pptp_CDN_result_labels[] = {
	NAME_VAL(PPTP_CDN_RESULT_LOST_CARRIER),
	NAME_VAL(PPTP_CDN_RESULT_GENRIC_ERROR),
	NAME_VAL(PPTP_CDN_RESULT_ADMIN_SHUTDOWN),
	NAME_VAL(PPTP_CDN_RESULT_REQUEST),
};


/* value to strings convert macros */
#define LABEL_TO_STRING(func_name, label_names, prefix_len)		\
	const char *							\
	func_name(int code)						\
	{								\
		int i;							\
									\
		for (i = 0; i < countof(label_names); i++) {		\
			if (label_names[i].label == code)		\
				return label_names[i].name + prefix_len;\
		}							\
									\
		return "UNKNOWN";					\
	}
LABEL_TO_STRING(pptp_StopCCRQ_reason_string, pptp_StopCCRQ_reason_labels, 21)
LABEL_TO_STRING(pptp_StopCCRP_result_string, pptp_StopCCRP_result_labels, 21)
LABEL_TO_STRING(pptp_general_error_string, pptp_general_error_labels, 11)
LABEL_TO_STRING(pptp_ctrl_mes_type_string, pptp_ctrl_mes_type_labels, 19)
LABEL_TO_STRING(pptp_CDN_result_string, pptp_CDN_result_labels, 16)
@


1.3
log
@add $OpenBSD$ and remove trailing space.  no functional change.
@
text
@d1 1
a1 1
/* $OpenBSD: pptp_subr.c,v 1.2 2010/07/01 03:38:17 yasuoka Exp $ */
@


1.2
log
@Translate Japanese comments or labels into English.  Translation was
done by IIJ people (MATSUI Yoshihiro, SAITOH Masanobu, Tomoyuki Sahara),
yuo@@ and myself.

This diff also includes
 - delete part of useless comments, correct spelling.
 - add man page of npppdctl.

There is no functional change.
@
text
@d1 2
a2 1
/*	$OpenBSD:$ */
@


1.1
log
@Initial import npppd(8).  npppd is a new PPP daemon that handles many
ppp sessions as a server.  It supports L2TP, PPTP and PPPoE as
tunneling.

ok mcbride@@ dlg@@ deraadt@@ reyk@@.
@
text
@d1 1
d27 3
a29 3
/**@@file
 * PPTPの補助的な関数
 */
d46 1
a46 1
/** Faming Capability ビットをカンマ区切りの文字列で返す */
d62 2
a63 1
/** Bearer Capability ビットをカンマ区切りの文字列で返す */
d79 1
a79 1
/** コントロールパケットのヘッダ(共通部分)を作成する */
d128 3
a130 1
// _label_name を使ったマクロ。値を渡すと文字列で返す。
@

