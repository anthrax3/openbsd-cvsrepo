head	1.13;
access;
symbols
	OPENBSD_3_2:1.11.0.18
	OPENBSD_3_2_BASE:1.11
	OPENBSD_3_1:1.11.0.16
	OPENBSD_3_1_BASE:1.11
	OPENBSD_3_0:1.11.0.14
	OPENBSD_3_0_BASE:1.11
	OPENBSD_2_9_BASE:1.11
	OPENBSD_2_9:1.11.0.12
	OPENBSD_2_8:1.11.0.10
	OPENBSD_2_8_BASE:1.11
	OPENBSD_2_7:1.11.0.8
	OPENBSD_2_7_BASE:1.11
	OPENBSD_2_6:1.11.0.6
	OPENBSD_2_6_BASE:1.11
	OPENBSD_2_5:1.11.0.4
	OPENBSD_2_5_BASE:1.11
	OPENBSD_2_4:1.11.0.2
	OPENBSD_2_4_BASE:1.11
	OPENBSD_2_3:1.5.0.6
	OPENBSD_2_3_BASE:1.5
	OPENBSD_2_2:1.5.0.4
	OPENBSD_2_2_BASE:1.5
	OPENBSD_2_1:1.5.0.2
	OPENBSD_2_1_BASE:1.5
	OPENBSD_2_0:1.1.0.2
	OPENBSD_2_0_BASE:1.1;
locks; strict;
comment	@# @;


1.13
date	2003.02.21.08.59.45;	author jakob;	state dead;
branches;
next	1.12;

1.12
date	2003.01.24.15.56.18;	author mpech;	state Exp;
branches;
next	1.11;

1.11
date	98.07.07.22.05.15;	author millert;	state Exp;
branches;
next	1.10;

1.10
date	98.06.20.01.49.03;	author downsj;	state Exp;
branches;
next	1.9;

1.9
date	98.06.03.17.15.59;	author millert;	state Exp;
branches;
next	1.8;

1.8
date	98.05.23.19.24.56;	author millert;	state Exp;
branches;
next	1.7;

1.7
date	98.05.23.18.51.27;	author millert;	state Exp;
branches;
next	1.6;

1.6
date	98.05.22.19.34.46;	author millert;	state Exp;
branches;
next	1.5;

1.5
date	97.03.12.14.51.57;	author downsj;	state Exp;
branches;
next	1.4;

1.4
date	97.03.12.10.42.44;	author downsj;	state Exp;
branches;
next	1.3;

1.3
date	97.02.27.18.36.50;	author kstailey;	state Exp;
branches;
next	1.2;

1.2
date	97.02.27.18.29.46;	author kstailey;	state Exp;
branches;
next	1.1;

1.1
date	96.02.19.19.54.32;	author dm;	state Exp;
branches;
next	;


desc
@@


1.13
log
@remove bind4; ok deraadt@@
@
text
@#!/bin/sh
#	$OpenBSD: ndc.sh,v 1.12 2003/01/24 15:56:18 mpech Exp $

USAGE='echo \
	"usage: $0 \
 (status|dumpdb|reload|stats|trace|notrace|querylog|start|stop|restart) \
	 ... \
	"; exit 1'

PATH=%DESTSBIN%:/bin:/usr/bin:/usr/ucb:$PATH

NAMED_CMD=named
RUNNING=0
if [ -r /etc/rc.conf ]; then
	CHROOTDIR=`. /etc/rc.conf ; echo "$named_chroot"`
	if [ "X${CHROOTDIR}" != "X" ]; then
		NAMED_CMD="${NAMED_CMD} -t ${CHROOTDIR}"
	else
		# Need a default
		CHROOTDIR=/var/named
	fi

	NAMED_USER=`. /etc/rc.conf ; echo "$named_user"`
	if [ "X${NAMED_USER}" != "X" ]; then
		NAMED_CMD="${NAMED_CMD} -u ${NAMED_USER}"
	fi

	NAMED_FLAGS=`. /etc/rc.conf ; echo "$named_flags"`
	if [ "X${NAMED_FLAGS}" != X"NO" ]; then
		NAMED_CMD="${NAMED_CMD} ${NAMED_FLAGS}"
	fi
else
	CHROOTDIR=%CHROOTDIR%
fi
PIDFILE=${CHROOTDIR}/named.pid

#
# Pid file may live in chroot dir, check there first.
#
if [ -f $PIDFILE ]; then
	PID=`sed 1q $PIDFILE`
	NAMED_CMD=`tail -1 $PIDFILE`
	case "`kill -0 $PID 2>&1`" in
		""|*"not permitted"*)	RUNNING=1;;
	esac
fi
if [ ${RUNNING} -eq 0 -a -f %PIDDIR%/named.pid ]; then
	PIDFILE=%PIDDIR%/named.pid
	PID=`sed 1q $PIDFILE`
	NAMED_CMD=`tail -1 $PIDFILE`
	case "`kill -0 $PID 2>&1`" in
		""|*"not permitted"*)	RUNNING=1;;
	esac
fi

if [ ${RUNNING} -eq 1 ]; then
	PS=`%PS% $PID | tail -1 | grep $PID`
	[ `echo $PS | wc -w` -ne 0 ] || {
		PS="named (pid $PID) can't get name list"
	}
else
	PS="named not running"
fi

for ARG
do
	case $ARG in
	start|stop|restart)
		;;
	*)
		[ $RUNNING -eq 0 ] && {
			echo $PS
			exit 1
		}
	esac

	case $ARG in
	status)	echo "$PS";;
	dumpdb)	kill -INT $PID && echo Dumping Database;;
	reload)	kill -HUP $PID && echo Reloading Database;;
	stats)	kill -%IOT% $PID && echo Dumping Statistics;;
	trace)	kill -USR1 $PID && echo Trace Level Incremented;;
	notrace) kill -USR2 $PID && echo Tracing Cleared;;
	querylog|qrylog) kill -WINCH $PID && echo Query Logging Toggled;;
	start)
		[ $RUNNING -eq 1 ] && {
			echo "$0: start: named (pid $PID) already running"
			continue
		}
		rm -f $PIDFILE
		$NAMED_CMD && {
			sleep 5
			echo Name Server Started
		}
		;;
	stop)
		[ $RUNNING -eq 0 ] && {
			echo "$0: stop: named not running"
			continue
		}
		kill $PID && {
			sleep 5
			rm -f $PIDFILE
			echo Name Server Stopped
		}
		;;
	restart)
		[ $RUNNING -eq 1 ] && {
			kill $PID && sleep 5
		}
		rm -f $PIDFILE
		$NAMED_CMD && {
			sleep 5
			echo Name Server Restarted
		}
		;;
	*)	eval "$USAGE";;
	esac
done
test -z "$ARG" && eval "$USAGE"

exit 0
@


1.12
log
@ndc doesn't start named if named_flags=NO in /etc/rc.conf
Fix it.

millert@@ ok
@
text
@d2 1
a2 1
#	$OpenBSD: ndc.sh,v 1.11 1998/07/07 22:05:15 millert Exp $
@


1.11
log
@make 'ndc start' use the values of named_flags, named_user, and named_chroot from /etc/rc.conf; based on a patch from ibo@@ragnarok.val-axs.net
@
text
@d2 1
a2 1
#	$OpenBSD: ndc.sh,v 1.10 1998/06/20 01:49:03 downsj Exp $
d29 1
a29 1
	if [ "X${NAMED_FLAGS}" != "X" ]; then
@


1.10
log
@Handle case where rc.conf exists but has no named_chroot.
@
text
@d2 1
a2 1
#	$OpenBSD: ndc.sh,v 1.9 1998/06/03 17:15:59 millert Exp $
d12 2
d16 4
a19 2
	# In case rc.conf exists but does not specify $named_chroot.
	if [ "X${CHROOTDIR}" == "X" ]; then
d22 10
a35 2
NAMED_CMD=named
RUNNING=0
@


1.9
log
@snarf named_chroot out of rc.conf instead of using hard-coded chroot dir
@
text
@d2 1
a2 1
#	$OpenBSD: ndc.sh,v 1.8 1998/05/23 19:24:56 millert Exp $
d14 4
@


1.8
log
@support for easy chroot'ing to /var/named and install named-xfer in /var/named as a static binary
@
text
@d2 1
a2 1
#	$OpenBSD: ndc.sh,v 1.7 1998/05/23 18:51:27 millert Exp $
d11 6
a16 1
CHROOTDIR=%CHROOTDIR%
@


1.7
log
@make 'ndc status' work for non-root
@
text
@d2 1
a2 1
#	$OpenBSD: ndc.sh,v 1.6 1998/05/22 19:34:46 millert Exp $
d11 2
a12 1
PIDFILE=%PIDDIR%/named.pid
d16 4
a19 2
if [ -f $PIDFILE ]
then
d25 11
d38 1
a38 5
		if [ $RUNNING -eq 1 ]; then
			PS="named (pid $PID) can't get name list"
		else
			PS="named (pid $PID?) not running"
		fi
d41 1
a41 1
	PS="named (no pid file) not running"
@


1.6
log
@stash argv in pid file like sendmail does so we can restart w/ args.  also make ndc work even if ps does not.
@
text
@d2 1
a2 1
#	$OpenBSD: ndc.sh,v 1.5 1997/03/12 14:51:57 downsj Exp $
d13 1
d19 3
a21 5
	if kill -0 $PID >/dev/null 2>&1; then
		RUNNING=1
	else
		RUNNING=0
	fi
a31 1
	RUNNING=0
@


1.5
log
@Remove %INDOT%.
@
text
@d2 1
a2 1
#	$OpenBSD: ndc.sh,v 1.4 1997/03/12 10:42:44 downsj Exp $
d12 1
d16 7
a22 1
	PID=`cat $PIDFILE`
a23 1
	RUNNING=1
d25 5
a29 2
		PS="named (pid $PID?) not running"
		RUNNING=0
d62 1
a62 1
		named && {
d83 1
a83 1
		named && {
@


1.4
log
@BIND 4.9.5-P1.

libresolv and include are required until the new resolver gets integrated
into libc.
@
text
@d2 1
a2 1
#	$OpenBSD$
d53 1
a53 1
		%INDOT%named && {
d74 1
a74 1
		%INDOT%named && {
@


1.3
log
@Fix IOT bug via Makefile.inc, not ndc.sh.
@
text
@d2 1
a2 2
#
#	$NetBSD: ndc.sh,v 1.1 1996/02/02 15:29:52 mrg Exp $
d53 1
a53 1
		named && {
d74 1
a74 1
		named && {
@


1.2
log
@hermes# ndc stats
/usr/sbin/ndc: /usr/sbin/ndc[82]: kill: bad signal `IOT'
@
text
@d44 1
a44 1
	stats)	kill -%ABRT% $PID && echo Dumping Statistics;;
@


1.1
log
@netbsd: bind 4.9.3
@
text
@d44 1
a44 1
	stats)	kill -%IOT% $PID && echo Dumping Statistics;;
@
