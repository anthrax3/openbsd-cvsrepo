head	1.18;
access;
symbols
	OPENBSD_6_1:1.18.0.10
	OPENBSD_6_1_BASE:1.18
	OPENBSD_6_0:1.18.0.8
	OPENBSD_6_0_BASE:1.18
	OPENBSD_5_9:1.18.0.4
	OPENBSD_5_9_BASE:1.18
	OPENBSD_5_8:1.18.0.6
	OPENBSD_5_8_BASE:1.18
	OPENBSD_5_7:1.18.0.2
	OPENBSD_5_7_BASE:1.18
	OPENBSD_5_6:1.16.0.8
	OPENBSD_5_6_BASE:1.16
	OPENBSD_5_5:1.16.0.6
	OPENBSD_5_5_BASE:1.16
	OPENBSD_5_4:1.16.0.2
	OPENBSD_5_4_BASE:1.16
	OPENBSD_5_3:1.15.0.12
	OPENBSD_5_3_BASE:1.15
	OPENBSD_5_2:1.15.0.10
	OPENBSD_5_2_BASE:1.15
	OPENBSD_5_1_BASE:1.15
	OPENBSD_5_1:1.15.0.8
	OPENBSD_5_0:1.15.0.6
	OPENBSD_5_0_BASE:1.15
	OPENBSD_4_9:1.15.0.4
	OPENBSD_4_9_BASE:1.15
	OPENBSD_4_8:1.15.0.2
	OPENBSD_4_8_BASE:1.15
	OPENBSD_4_7:1.14.0.2
	OPENBSD_4_7_BASE:1.14
	OPENBSD_4_6:1.12.0.16
	OPENBSD_4_6_BASE:1.12
	OPENBSD_4_5:1.12.0.12
	OPENBSD_4_5_BASE:1.12
	OPENBSD_4_4:1.12.0.10
	OPENBSD_4_4_BASE:1.12
	OPENBSD_4_3:1.12.0.8
	OPENBSD_4_3_BASE:1.12
	OPENBSD_4_2:1.12.0.6
	OPENBSD_4_2_BASE:1.12
	OPENBSD_4_1:1.12.0.4
	OPENBSD_4_1_BASE:1.12
	OPENBSD_4_0:1.12.0.2
	OPENBSD_4_0_BASE:1.12
	OPENBSD_3_9:1.10.0.10
	OPENBSD_3_9_BASE:1.10
	OPENBSD_3_8:1.10.0.8
	OPENBSD_3_8_BASE:1.10
	OPENBSD_3_7:1.10.0.6
	OPENBSD_3_7_BASE:1.10
	OPENBSD_3_6:1.10.0.4
	OPENBSD_3_6_BASE:1.10
	OPENBSD_3_5:1.10.0.2
	OPENBSD_3_5_BASE:1.10
	OPENBSD_3_4:1.9.0.2
	OPENBSD_3_4_BASE:1.9
	OPENBSD_3_3:1.7.0.4
	OPENBSD_3_3_BASE:1.7
	OPENBSD_3_2:1.7.0.2
	OPENBSD_3_2_BASE:1.7
	OPENBSD_3_1:1.6.0.2
	OPENBSD_3_1_BASE:1.6
	OPENBSD_3_0:1.4.0.16
	OPENBSD_3_0_BASE:1.4
	OPENBSD_2_9_BASE:1.4
	OPENBSD_2_9:1.4.0.14
	OPENBSD_2_8:1.4.0.12
	OPENBSD_2_8_BASE:1.4
	OPENBSD_2_7:1.4.0.10
	OPENBSD_2_7_BASE:1.4
	OPENBSD_2_6:1.4.0.8
	OPENBSD_2_6_BASE:1.4
	OPENBSD_2_5:1.4.0.6
	OPENBSD_2_5_BASE:1.4
	MOPD254:1.4
	OPENBSD_2_4:1.4.0.4
	OPENBSD_2_4_BASE:1.4
	OPENBSD_2_3:1.4.0.2
	OPENBSD_2_3_BASE:1.4
	OPENBSD_2_2:1.3.0.4
	OPENBSD_2_2_BASE:1.3
	OPENBSD_2_1:1.3.0.2
	OPENBSD_2_1_BASE:1.3
	OPENBSD_2_0:1.2.0.2
	OPENBSD_2_0_BASE:1.2
	MOPD253:1.1.1.1
	MAJA:1.1.1;
locks; strict;
comment	@ * @;


1.18
date	2015.02.09.23.00.14;	author deraadt;	state Exp;
branches;
next	1.17;
commitid	822YD61EeG0Xl9Na;

1.17
date	2014.12.13.14.44.59;	author miod;	state Exp;
branches;
next	1.16;
commitid	KfI83DTUbjunQXXj;

1.16
date	2013.07.05.21.02.07;	author miod;	state Exp;
branches;
next	1.15;

1.15
date	2010.05.01.08.14.26;	author mk;	state Exp;
branches;
next	1.14;

1.14
date	2009.10.27.23.59.52;	author deraadt;	state Exp;
branches;
next	1.13;

1.13
date	2009.07.11.13.42.32;	author sobrado;	state Exp;
branches;
next	1.12;

1.12
date	2006.04.29.16.26.56;	author maja;	state Exp;
branches;
next	1.11;

1.11
date	2006.04.17.10.30.31;	author maja;	state Exp;
branches;
next	1.10;

1.10
date	2003.12.01.00.56.51;	author avsm;	state Exp;
branches;
next	1.9;

1.9
date	2003.06.02.21.38.39;	author maja;	state Exp;
branches;
next	1.8;

1.8
date	2003.04.19.17.42.57;	author avsm;	state Exp;
branches;
next	1.7;

1.7
date	2002.06.10.21.05.25;	author maja;	state Exp;
branches;
next	1.6;

1.6
date	2002.02.16.21.28.04;	author millert;	state Exp;
branches;
next	1.5;

1.5
date	2001.11.16.21.18.06;	author miod;	state Exp;
branches;
next	1.4;

1.4
date	98.03.04.20.21.54;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	97.01.15.23.44.27;	author millert;	state Exp;
branches;
next	1.2;

1.2
date	96.09.21.19.12.18;	author maja;	state Exp;
branches;
next	1.1;

1.1
date	96.09.21.13.49.17;	author maja;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	96.09.21.13.49.17;	author maja;	state Exp;
branches;
next	;


desc
@@


1.18
log
@clean up flags++ instances around getopt()
ok florian
@
text
@/*	$OpenBSD: mopchk.c,v 1.17 2014/12/13 14:44:59 miod Exp $	*/

/*
 * Copyright (c) 1995-96 Mats O Jansson.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * mopchk - MOP Check Utility
 *
 * Usage:	mopchk [-av] [file ...]
 */

#include "os.h"
#include "common/common.h"
#include "common/mopdef.h"
#include "common/device.h"
#include "common/pf.h"
#include "common/file.h"

/*
 * The list of all interfaces that are being listened to.
 */
struct if_info *iflist;

void   Usage(void);
void   mopProcess(struct if_info *, u_char *);

int     AllFlag = 0;		/* listen on "all" interfaces  */
int	VersionFlag = 0;	/* Show version */
int	promisc = 0;		/* promisc mode not needed */
extern char *__progname;
extern char version[];

int
main(argc, argv)
	int     argc;
	char  **argv;
{
	struct dllist dl;
	int     op, i;
	char   *filename, *p;
	struct if_info *ii;
	int	error;

	/* All error reporting is done through syslogs. */
	openlog(__progname, LOG_PID | LOG_CONS, LOG_DAEMON);

	opterr = 0;
	while ((op = getopt(argc, argv, "av")) != -1) {
		switch (op) {
		case 'a':
			AllFlag = 1;
			break;
		case 'v':
			VersionFlag = 1;
			break;
		default:
			Usage();
			/* NOTREACHED */
		}
	}
	
	if (VersionFlag)
		printf("%s: Version %s\n", __progname, version);

	if (AllFlag) {
		if (VersionFlag)
			printf("\n");
		iflist = NULL;
		deviceInitAll();
		if (iflist == NULL) {
			printf("No interface\n");
		} else {
			printf("Interface Address\n");
			p = NULL;
			for (ii = iflist; ii; ii = ii->next) {
				if (p != NULL) {
					if (strcmp(p,ii->if_name) == 0)
						continue;
				}	
				printf("%-9s %x:%x:%x:%x:%x:%x\n",
				       ii->if_name,
				       ii->eaddr[0],ii->eaddr[1],ii->eaddr[2],
				       ii->eaddr[3],ii->eaddr[4],ii->eaddr[5]);
				p = ii->if_name;
			}
		}
	}
	
	if (VersionFlag || AllFlag)
		i = 1;
	else
		i = 0;

	while (argc > optind) {
		if (i)	printf("\n");
		i++;
		filename = argv[optind++];
		printf("Checking: %s\n",filename);
		dl.ldfd = open(filename, O_RDONLY, 0);
		if (dl.ldfd == -1) {
			printf("Unknown file.\n");
		} else {
			if ((error = CheckElfFile(dl.ldfd)) == 0) {
				if (GetElf32FileInfo(&dl, INFO_PRINT) < 0 &&
				    GetElf64FileInfo(&dl, INFO_PRINT) < 0) {
					printf("Some failure in GetElfXXFileInfo\n");
				}
			} else if ((error = CheckAOutFile(dl.ldfd)) == 0) {
				if (GetAOutFileInfo(&dl, INFO_PRINT) < 0) {
					printf("Some failure in GetAOutFileInfo\n");
				}
			} else if ((error = CheckMopFile(dl.ldfd)) == 0) {
				if (GetMopFileInfo(&dl, INFO_PRINT) < 0) {
					printf("Some failure in GetMopFileInfo\n");
				}
			};
		}
		(void)close(dl.ldfd);
	}
	return 0;
}

void
Usage()
{
	fprintf(stderr, "usage: %s [-av] [file ...]\n", __progname);
	exit(1);
}

/*
 * Process incoming packages, NOT. 
 */
/* ARGSUSED */
void
mopProcess(ii, pkt)
	struct if_info *ii;
	u_char *pkt;
{
}

@


1.17
log
@Give the mop suite the ability to process alpha Elf64 files and create mop
alpha images of them.
@
text
@d1 1
a1 1
/*	$OpenBSD: mopchk.c,v 1.16 2013/07/05 21:02:07 miod Exp $	*/
d72 1
a72 1
			AllFlag++;
d75 1
a75 1
			VersionFlag++;
@


1.16
log
@Teach mopd and mopa.out about ELF files, and allow forthcoming VAX ELF boot
blocks to be converted to working mop binaries. From NetBSD.
@
text
@d1 1
a1 1
/*	$OpenBSD: mopchk.c,v 1.15 2010/05/01 08:14:26 mk Exp $	*/
d125 3
a127 2
				if (GetElfFileInfo(&dl, INFO_PRINT) < 0) {
					printf("Some failure in GetElfFileInfo\n");
@


1.15
log
@incomming -> incoming

The ones found in gnu/ left out by intention.

ok jmc
@
text
@d1 1
a1 1
/*	$OpenBSD: mopchk.c,v 1.14 2009/10/27 23:59:52 deraadt Exp $	*/
d59 2
a60 1
	int     op, i, fd;
d63 1
a63 1
	int	err, aout;
d120 2
a121 2
		fd = open(filename, O_RDONLY, 0);
		if (fd == -1) {
d124 6
a129 4
			err = CheckAOutFile(fd);
			if (err == 0) {
				if (GetAOutFileInfo(fd, 0, 0, 0, 0, 0, 0, 0, 0,
						    &aout, INFO_PRINT) < 0) {
a130 1
					aout = -1;
d132 2
a133 7
			} else {
				aout = -1;
			}
			if (aout == -1)
				err = CheckMopFile(fd);
			if (aout == -1 && err == 0) {
				if (GetMopFileInfo(fd, 0, 0, INFO_PRINT) < 0) {
d138 1
@


1.14
log
@rcsid[] and sccsid[] and copyright[] are essentially unmaintained (and
unmaintainable).  these days, people use source.  these id's do not provide
any benefit, and do hurt the small install media
(the 33,000 line diff is essentially mechanical)
ok with the idea millert, ok dms
@
text
@d1 1
a1 1
/*	$OpenBSD: mopchk.c,v 1.13 2009/07/11 13:42:32 sobrado Exp $	*/
d153 1
a153 1
 * Process incomming packages, NOT. 
@


1.13
log
@synchronize the synopsis and usage of mopa.out(1); mopchk(1) can handle
more than one filename at a time; add a description for -3 and -4
in mopd(8), and document -v; remove a duplicate flag in mopprobe(1);
use a better style for synopses; sort flags and arguments.

written with help by jmc@@

ok jmc@@
@
text
@d1 1
a1 1
/*	$OpenBSD: mopchk.c,v 1.12 2006/04/29 16:26:56 maja Exp $	*/
a25 4

#ifndef lint
static const char rcsid[] = "$OpenBSD: mopchk.c,v 1.12 2006/04/29 16:26:56 maja Exp $";
#endif
@


1.12
log
@Change the compile time option -DINFO into a runtime option to get ride
of some lint warnings. -moj
@
text
@d1 1
a1 1
/*	$OpenBSD: mopchk.c,v 1.11 2006/04/17 10:30:31 maja Exp $	*/
d28 1
a28 1
static const char rcsid[] = "$OpenBSD: mopchk.c,v 1.11 2006/04/17 10:30:31 maja Exp $";
d34 1
a34 1
 * Usage:	mopchk [-a] [-v] [filename...]
d152 1
a152 1
	fprintf(stderr, "usage: %s [-a] [-v] [filename...]\n", __progname);
@


1.11
log
@Only show a interface once. Some cleanup and silence lint. -moj
@
text
@d1 1
a1 1
/*	$OpenBSD: mopchk.c,v 1.10 2003/12/01 00:56:51 avsm Exp $	*/
d28 1
a28 1
static const char rcsid[] = "$OpenBSD: mopchk.c,v 1.10 2003/12/01 00:56:51 avsm Exp $";
d45 1
a45 2
 * The list of all interfaces that are being listened to.  rarp_loop()
 * "selects" on the descriptors in this list.
d129 2
a130 2
				if (GetAOutFileInfo(fd, 0, 0, 0, 0,
						    0, 0, 0, 0, &aout) < 0) {
d140 1
a140 1
				if (GetMopFileInfo(fd, 0, 0) < 0) {
@


1.10
log
@-Wall cleanup: trim unused vars, right format strings, constify rcsids,
braces where needed, add missing prototypes.

tested and ok maja@@
@
text
@d1 1
a1 1
/*	$OpenBSD: mopchk.c,v 1.9 2003/06/02 21:38:39 maja Exp $	*/
d27 2
a28 2
#ifndef LINT
static const char rcsid[] = "$OpenBSD: mopchk.c,v 1.9 2003/06/02 21:38:39 maja Exp $";
d56 1
a56 1
char	*Program;
d65 1
a65 1
	char   *filename;
a68 9
	extern int optind, opterr;

	if ((Program = strrchr(argv[0], '/')))
		Program++;
	else
		Program = argv[0];
	if (*Program == '-')
		Program++;

d70 1
a70 1
	openlog(Program, LOG_PID | LOG_CONS, LOG_DAEMON);
d88 1
a88 1
		printf("%s: Version %s\n",Program,version);
d99 1
d101 4
d109 1
d153 1
a153 1
	(void) fprintf(stderr, "usage: %s [-a] [-v] [filename...]\n",Program);
d160 1
@


1.9
log
@remove clause 3 and 4. -moj
@
text
@d1 1
a1 1
/*	$OpenBSD: mopchk.c,v 1.8 2003/04/19 17:42:57 avsm Exp $	*/
d28 1
a28 1
static char rcsid[] = "$OpenBSD: mopchk.c,v 1.8 2003/04/19 17:42:57 avsm Exp $";
@


1.8
log
@format string typo in usage (%d -> %s for program name)
@
text
@d1 1
a1 1
/*	$OpenBSD: mopchk.c,v 1.7 2002/06/10 21:05:25 maja Exp $	*/
a13 5
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by Mats O Jansson.
 * 4. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
d28 1
a28 1
static char rcsid[] = "$OpenBSD: mopchk.c,v 1.7 2002/06/10 21:05:25 maja Exp $";
@


1.7
log
@Remove NO__P since __P has been removed. Found by hin@@ -moj
@
text
@d1 1
a1 1
/*	$OpenBSD: mopchk.c,v 1.6 2002/02/16 21:28:04 millert Exp $	*/
d33 1
a33 1
static char rcsid[] = "$OpenBSD: mopchk.c,v 1.6 2002/02/16 21:28:04 millert Exp $";
d161 1
a161 1
	(void) fprintf(stderr, "usage: %d [-a] [-v] [filename...]\n",Program);
@


1.6
log
@Part one of userland __P removal.  Done with a simple regexp with some minor hand editing to make comments line up correctly.  Another pass is forthcoming that handles the cases that could not be done automatically.
@
text
@d1 1
a1 1
/*	$OpenBSD: mopchk.c,v 1.5 2001/11/16 21:18:06 miod Exp $	*/
d33 1
a33 1
static char rcsid[] = "$OpenBSD: mopchk.c,v 1.5 2001/11/16 21:18:06 miod Exp $";
a54 4
#ifdef NO__P
void   Usage         (/* void */);
void   mopProcess    (/* struct if_info *, u_char * */);
#else
a56 1
#endif
@


1.5
log
@Close comment.
@
text
@d1 1
a1 1
/*	$OpenBSD: mopchk.c,v 1.4 1998/03/04 20:21:54 deraadt Exp $	*/
d33 1
a33 1
static char rcsid[] = "$OpenBSD: mopchk.c,v 1.4 1998/03/04 20:21:54 deraadt Exp $";
d59 2
a60 2
void   Usage         __P((void));
void   mopProcess    __P((struct if_info *, u_char *));
@


1.4
log
@Wall
@
text
@d1 1
a1 1
/*	$OpenBSD: mopchk.c,v 1.3 1997/01/15 23:44:27 millert Exp $
d33 1
a33 1
static char rcsid[] = "$OpenBSD: mopchk.c,v 1.3 1997/01/15 23:44:27 millert Exp $";
@


1.3
log
@getopt(3) returns -1 when out of args, not EOF, whee!
@
text
@d1 1
a1 1
/*	$OpenBSD: mopchk.c,v 1.2 1996/09/21 19:12:18 maja Exp $
d33 1
a33 1
static char rcsid[] = "$OpenBSD: mopchk.c,v 1.2 1996/09/21 19:12:18 maja Exp $";
d67 1
a67 1
char	version[];
d69 1
a69 1
void
d160 1
a160 1

@


1.2
log
@Replace $Id with $OpenBSD, 3:rd try. -moj
@
text
@d1 1
a1 1
/*	$OpenBSD$
d33 1
a33 1
static char rcsid[] = "$OpenBSD: mopchk.c,v 1.1.1.1 1996/09/21 13:49:17 maja Exp $";
d92 1
a92 1
	while ((op = getopt(argc, argv, "av")) != EOF) {
@


1.1
log
@Initial revision
@
text
@d1 2
d33 1
a33 1
static char rcsid[] = "$Id: mopchk.c,v 1.5 1996/08/16 22:46:55 moj Exp $";
@


1.1.1.1
log
@Initial import of mopd-2.5.3. -moj
@
text
@@

