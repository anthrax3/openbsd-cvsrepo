head	1.70;
access;
symbols
	OPENBSD_4_2:1.46.0.2
	OPENBSD_4_2_BASE:1.46
	OPENBSD_4_1:1.37.0.2
	OPENBSD_4_1_BASE:1.37;
locks; strict;
comment	@.\" @;


1.70
date	2007.12.07.17.27.07;	author deraadt;	state dead;
branches;
next	1.69;

1.69
date	2007.11.26.09.38.25;	author reyk;	state Exp;
branches;
next	1.68;

1.68
date	2007.11.25.20.02.02;	author reyk;	state Exp;
branches;
next	1.67;

1.67
date	2007.11.24.19.00.44;	author jmc;	state Exp;
branches;
next	1.66;

1.66
date	2007.11.24.16.13.50;	author reyk;	state Exp;
branches;
next	1.65;

1.65
date	2007.11.23.09.45.33;	author reyk;	state Exp;
branches;
next	1.64;

1.64
date	2007.11.23.09.39.42;	author reyk;	state Exp;
branches;
next	1.63;

1.63
date	2007.11.22.10.09.53;	author reyk;	state Exp;
branches;
next	1.62;

1.62
date	2007.11.21.20.24.28;	author reyk;	state Exp;
branches;
next	1.61;

1.61
date	2007.11.21.14.25.44;	author jmc;	state Exp;
branches;
next	1.60;

1.60
date	2007.11.21.14.12.04;	author reyk;	state Exp;
branches;
next	1.59;

1.59
date	2007.11.21.13.04.42;	author reyk;	state Exp;
branches;
next	1.58;

1.58
date	2007.11.21.10.19.34;	author pyr;	state Exp;
branches;
next	1.57;

1.57
date	2007.11.20.18.24.32;	author jmc;	state Exp;
branches;
next	1.56;

1.56
date	2007.11.20.15.54.55;	author reyk;	state Exp;
branches;
next	1.55;

1.55
date	2007.11.20.15.44.21;	author pyr;	state Exp;
branches;
next	1.54;

1.54
date	2007.10.22.15.45.40;	author jmc;	state Exp;
branches;
next	1.53;

1.53
date	2007.10.22.12.18.15;	author reyk;	state Exp;
branches;
next	1.52;

1.52
date	2007.09.28.13.29.56;	author pyr;	state Exp;
branches;
next	1.51;

1.51
date	2007.09.28.07.20.46;	author jmc;	state Exp;
branches;
next	1.50;

1.50
date	2007.09.28.01.11.58;	author pascoe;	state Exp;
branches;
next	1.49;

1.49
date	2007.09.10.11.59.22;	author reyk;	state Exp;
branches;
next	1.48;

1.48
date	2007.09.05.09.15.10;	author reyk;	state Exp;
branches;
next	1.47;

1.47
date	2007.09.04.14.15.05;	author pyr;	state Exp;
branches;
next	1.46;

1.46
date	2007.07.24.17.51.33;	author pyr;	state Exp;
branches;
next	1.45;

1.45
date	2007.05.31.19.20.24;	author jmc;	state Exp;
branches;
next	1.44;

1.44
date	2007.05.29.17.12.04;	author reyk;	state Exp;
branches;
next	1.43;

1.43
date	2007.05.27.19.21.15;	author reyk;	state Exp;
branches;
next	1.42;

1.42
date	2007.04.12.14.45.45;	author reyk;	state Exp;
branches;
next	1.41;

1.41
date	2007.04.10.21.45.11;	author reyk;	state Exp;
branches;
next	1.40;

1.40
date	2007.03.21.00.08.08;	author reyk;	state Exp;
branches;
next	1.39;

1.39
date	2007.03.13.12.04.52;	author reyk;	state Exp;
branches;
next	1.38;

1.38
date	2007.03.12.12.21.09;	author reyk;	state Exp;
branches;
next	1.37;

1.37
date	2007.03.06.19.26.46;	author reyk;	state Exp;
branches;
next	1.36;

1.36
date	2007.02.27.18.04.51;	author jmc;	state Exp;
branches;
next	1.35;

1.35
date	2007.02.27.13.38.58;	author reyk;	state Exp;
branches;
next	1.34;

1.34
date	2007.02.27.08.39.00;	author reyk;	state Exp;
branches;
next	1.33;

1.33
date	2007.02.27.08.02.33;	author jmc;	state Exp;
branches;
next	1.32;

1.32
date	2007.02.26.20.48.48;	author pyr;	state Exp;
branches;
next	1.31;

1.31
date	2007.02.26.19.25.25;	author reyk;	state Exp;
branches;
next	1.30;

1.30
date	2007.02.26.13.41.52;	author jmc;	state Exp;
branches;
next	1.29;

1.29
date	2007.02.26.13.03.30;	author pyr;	state Exp;
branches;
next	1.28;

1.28
date	2007.02.26.11.59.48;	author reyk;	state Exp;
branches;
next	1.27;

1.27
date	2007.02.25.09.04.59;	author jmc;	state Exp;
branches;
next	1.26;

1.26
date	2007.02.24.16.14.02;	author reyk;	state Exp;
branches;
next	1.25;

1.25
date	2007.02.24.15.48.54;	author reyk;	state Exp;
branches;
next	1.24;

1.24
date	2007.02.24.00.22.32;	author reyk;	state Exp;
branches;
next	1.23;

1.23
date	2007.02.23.14.54.44;	author jmc;	state Exp;
branches;
next	1.22;

1.22
date	2007.02.22.09.34.06;	author jmc;	state Exp;
branches;
next	1.21;

1.21
date	2007.02.22.09.20.01;	author jmc;	state Exp;
branches;
next	1.20;

1.20
date	2007.02.22.04.13.06;	author reyk;	state Exp;
branches;
next	1.19;

1.19
date	2007.02.22.04.06.18;	author reyk;	state Exp;
branches;
next	1.18;

1.18
date	2007.02.22.03.32.39;	author reyk;	state Exp;
branches;
next	1.17;

1.17
date	2007.02.07.15.17.46;	author reyk;	state Exp;
branches;
next	1.16;

1.16
date	2007.01.29.18.38.15;	author pyr;	state Exp;
branches;
next	1.15;

1.15
date	2007.01.29.14.23.31;	author pyr;	state Exp;
branches;
next	1.14;

1.14
date	2007.01.10.13.42.19;	author jmc;	state Exp;
branches;
next	1.13;

1.13
date	2007.01.09.13.50.11;	author pyr;	state Exp;
branches;
next	1.12;

1.12
date	2007.01.08.20.46.18;	author reyk;	state Exp;
branches;
next	1.11;

1.11
date	2007.01.08.17.52.27;	author reyk;	state Exp;
branches;
next	1.10;

1.10
date	2007.01.08.17.05.48;	author reyk;	state Exp;
branches;
next	1.9;

1.9
date	2007.01.08.13.37.26;	author reyk;	state Exp;
branches;
next	1.8;

1.8
date	2007.01.03.09.42.30;	author reyk;	state Exp;
branches;
next	1.7;

1.7
date	2006.12.25.19.07.34;	author reyk;	state Exp;
branches;
next	1.6;

1.6
date	2006.12.25.18.12.14;	author reyk;	state Exp;
branches;
next	1.5;

1.5
date	2006.12.19.14.39.30;	author jmc;	state Exp;
branches;
next	1.4;

1.4
date	2006.12.18.19.48.04;	author jmc;	state Exp;
branches;
next	1.3;

1.3
date	2006.12.16.12.42.14;	author reyk;	state Exp;
branches;
next	1.2;

1.2
date	2006.12.16.11.52.51;	author reyk;	state Exp;
branches;
next	1.1;

1.1
date	2006.12.16.11.45.07;	author reyk;	state Exp;
branches;
next	;


desc
@@


1.70
log
@hoststated/hoststatectl get repository copied (and de-tagged) into
relayd/relayctl.  This is a more suitable place for a daemon that has
grown out of it's initial roots of "monitoring and redirecting services
at various layers", into one that is "a full featured proxy, which
happens to know what is up/down"
@
text
@.\"	$OpenBSD: hoststated.conf.5,v 1.69 2007/11/26 09:38:25 reyk Exp $
.\"
.\" Copyright (c) 2006, 2007 Reyk Floeter <reyk@@openbsd.org>
.\" Copyright (c) 2006, 2007 Pierre-Yves Ritschard <pyr@@openbsd.org>
.\"
.\" Permission to use, copy, modify, and distribute this software for any
.\" purpose with or without fee is hereby granted, provided that the above
.\" copyright notice and this permission notice appear in all copies.
.\"
.\" THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
.\" WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
.\" MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
.\" ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
.\" WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
.\" ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
.\" OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
.\"
.Dd $Mdocdate: November 26 2007 $
.Dt HOSTSTATED.CONF 5
.Os
.Sh NAME
.Nm hoststated.conf
.Nd Host Status daemon configuration file
.Sh DESCRIPTION
.Nm
is the configuration file for the Host Status Daemon,
.Xr hoststated 8 .
.Sh SECTIONS
.Nm
is divided into six main sections:
.Bl -tag -width xxxx
.It Sy Macros
User-defined variables may be defined and used later, simplifying the
configuration file.
.It Sy Global Configuration
Global settings for
.Xr hoststated 8 .
.It Sy Tables
Table definitions describe the content of a
.Xr pf 4
table and the method used for checking the health of the hosts
they contain.
.It Sy Services
Services will be translated to
.Xr pf 4
rdr rules if their table or backup table have content.
.It Sy Relays
Relays allow layer 7 load balancing, SSL acceleration, and
general purpose TCP proxying.
.It Sy Protocols
Protocols are predefined protocol handlers and settings for relays.
.El
.Pp
Within the sections,
a host
.Ar address
can be either specified by IPv4 address, IPv6 address, or DNS hostname.
A
.Ar port
can be either specified by number or by name.
The port name to number mappings are found in the file
.Pa /etc/services ;
see
.Xr services 5
for details.
.Pp
Comments can be put anywhere in the file using a hash mark
.Pq Sq # ,
and extend to the end of the current line.
.Pp
Additional configuration files can be included with the
.Ic include
keyword, for example:
.Bd -literal -offset indent
include "/etc/hoststated.conf.local"
.Ed
.Sh MACROS
Macros can be defined that will later be expanded in context.
Macro names must start with a letter, and may contain letters, digits,
and underscores.
Macro names may not be reserved words (for example,
.Ic table ,
.Ic service ,
or
.Ic timeout ) .
Macros are not expanded inside quotes.
.Pp
For example:
.Bd -literal -offset indent
www1="10.0.0.1"
www2="10.0.0.2"
table webhosts {
	check tcp
	timeout 300
	real port 80
	host $www1
	host $www2
}
.Ed
.Sh GLOBAL CONFIGURATION
Here are the settings that can be set globally:
.Pp
.Bl -tag -width Ds -compact
.It Ic demote Ar group
Enable the global
.Xr carp 4
demotion option, this will reset the carp demotion counter for the
specified interface group to zero on startup and to 128 on shutdown of
the daemon.
For more information on interface groups,
see the
.Ic group
keyword in
.Xr ifconfig 8 .
.Pp
.It Xo
.Ic interval Ar number
.Xc
Set the interval in seconds at which the hosts will be checked.
The default interval is 10 seconds.
.Pp
.It Xo
.Ic log
.Pq Ic updates Ns \&| Ns Ic all
.Xc
Log state notifications after completed host checks.
Either only log the
.Ic updates
to new states or log
.Ic all
state notifications, even if the state didn't change.
The host state can be
.Ar up
(the health check completed successfully),
.Ar down
(the host is down or didn't match the check criteria),
or
.Ar unknown
(the host is disabled or has not been checked yet).
.Pp
.It Ic prefork Ar number
When using relays, run the specified number of processes to handle
relayed connections.
This will increase the performance and prevents delays when connecting
to a relay.
.Xr hoststated 8
will run 5 relay processes by default and every process will handle
all configured relays.
.Pp
.It Xo
.Ic timeout Ar number
.Xc
Set the global timeout in milliseconds for checks.
This can be overriden by the timeout value in the table definitions.
The default interval is 200 milliseconds and it must not exceed the
global interval.
.El
.Sh TABLES
Tables are used to group a set of hosts that can be checked using the same
method.
Only one health-checking method can be used per table.
Table specific configuration directives are described below.
.Bl -tag -width Ds
.It Xo
.Ic check http Ar path
.Op Ic host Ar hostname
.Ic code Ar number
.Xc
For each host in the table, verify that retrieving the URL
.Ar path
gives the HTTP return code
.Ar number .
If
.Ar hostname
is specified, it is used as the
.Dq Host:
header to query a specific hostname at target host.
.It Xo
.Ic check https Ar path
.Op Ic host Ar hostname
.Ic code Ar number
.Xc
This has the same effect as above but wraps the HTTP request in SSL.
.It Xo
.Ic check http Ar path
.Op Ic host Ar hostname
.Ic digest Ar string
.Xc
For each host in the table, verify that retrieving the URL
.Ar path
produces content whose message digest matches the defined string.
The algorithm used is determined by the string length of the
.Ar digest
argument, either SHA1 (40 characters) or MD5 (32 characters).
If
.Ar hostname
is specified, it is used as the
.Dq Host:
header to query a specific hostname at target host.
The digest does not take the HTTP headers into account.
To compute the digest, use this simple command:
.Bd -literal -offset indent
ftp -o - http://host[:port]/path | sha1
.Ed
.Pp
This gives a digest
that can be used as is in a digest statement:
.Bd -literal -offset indent
a9993e36476816aba3e25717850c26c9cd0d89d
.Ed
.It Xo
.Ic check https Ar path
.Op Ic host Ar hostname
.Ic digest Ar string
.Xc
This has the same effect as above but wraps the HTTP request in SSL.
.It Ic check icmp
Ping hosts in this table to determine whether they are up or not.
This method will automatically use ICMP or ICMPV6 depending on the
address family of each host.
.It Xo
.Ic check send
.Ar data
.Ic expect
.Ar pattern
.Op Ic ssl
.Xc
For each host in the table, a TCP connection is established on the
port specified, then
.Ar data
is sent.
Incoming data is then read and is expected to match against
.Ar pattern
using shell globbing rules.
If
.Ar data
is an empty string or
.Ic nothing
then nothing is sent on the connection and data is immediately
read.
This can be useful with protocols that output a banner like
SMTP, NNTP and FTP.
If the
.Ic ssl
keyword is present,
the transaction will occur in an SSL tunnel.
.It Ic check script Ar path
Execute an external program to check the host state.
The program will be executed for each host by specifing the hostname
on the command line:
.Bd -literal -offset indent
/usr/local/bin/checkload.pl front-www1.private.example.com
.Ed
.Pp
.Xr hoststated 8
expects a positive return value on success and zero on failure.
Note that the script will be executed with the privileges of the
.Qq _hoststated
user and terminated after
.Ar timeout
milliseconds.
.It Ic check ssl
Perform a complete SSL handshake with each host to check their availability.
.It Ic check tcp
Use a simple TCP connect to check that hosts are up.
.It Ic demote Ar group
Enable the per-table
.Xr carp 4
demotion option.
This will increment the carp demotion counter for the
specified interface group if all hosts in the table are down.
For more information on interface groups,
see the
.Ic group
keyword in
.Xr ifconfig 8 .
.It Ic disable
Start the table disabled \(en no hosts will be checked in this table.
The table can be later enabled through
.Xr hoststatectl 8 .
.It Xo
.Ic host Ar address
.Op Ic retry Ar number
.Xc
Add the host whose address is
.Ar address
to the list of hosts to be checked in this table.
Each table needs at least one host.
The optional retry option adds a tolerance for failed host checks,
the check will be retried for
.Ar number
more times before setting the host state to down.
.It Ic interval Ar number
Override the global interval and specify one for this table.
It must be a multiple of the global interval.
.It Ic real port Ar port
When using the TCP or HTTP checking methods, use this
.Ar port
to connect to hosts.
If this parameter is not specified,
.Xr hoststated 8
will create a template table which inherits the port from the
referencing service or relay.
Main and backup tables need to have the same real port.
.It Ic timeout Ar number
Set the timeout in milliseconds for each host that is checked using
TCP as the transport.
This will override the global timeout, which is 200 milliseconds by default.
.El
.Sh SERVICES
Services represent a
.Xr pf 4
rdr rule.
They are used to specify which addresses will be redirected
to the hosts in the specified tables.
The configuration directives that are valid in this context are described
below.
.Bl -tag -width Ds
.It Ic backup table Ar name
Specify the table to switch to when all hosts in the main table
are seen as down or disabled.
.It Ic disable
Set the service initially disabled.
It can be later enabled through
.Xr hoststatectl 8 .
.It Ic sticky-address
This has the same effect than specifying sticky-address
for a rdr rule in
.Xr pf.conf 5 .
It will ensure that multiple connections from the same source are
mapped to the same redirection address.
.It Xo
.Ic table Ar name Op Ic port Ar port
.Xc
Specify the main table to be used.
Optionally supply a port which will
override the real port specification in the table.
This is mandatory.
.It Ic tag Ar name
Automatically tag packets passing through the
.Xr pf 4
rdr rule with the name supplied.
This allows simpler filter rules.
.It Ic virtual host Ar address Ic port Ar port
Specify an
.Ar address
and a
.Ar port
that will be used to redirect requests
to the hosts in the main or backup table.
Optionally an interface name can be given as follows,
to specify which interface the rdr rule will be enabled on:
.Bd -literal -offset indent
interface ``ifname''
.Ed
.El
.Sh RELAYS
Relays will forward TCP traffic between a client and a target server.
In contrast to IP forwarding and redirection in the network stack, a
relay will accept incoming TCP connections from remote clients as a
server, open an outgoing connection to a target host, and forward
any traffic between the target host and the remote client.
A relay is also called an application layer or layer 7 proxy.
.Pp
The main purpose of a relay is to provide advanced load balancing
functionality based on specified protocol characteristics, such as
HTTP headers, to provide SSL acceleration functionality and to allow
basic handling of the underlying application protocol.
.Pp
The relay configuration directives are described below.
.Bl -tag -width Ds
.It Xo
.Ic listen on Ar address Ic port Ar port
.Op Ic ssl
.Xc
Specify the address and port for the relay to listen on.
The relay will accept incoming connections to the specified address.
.Pp
If the
.Ic ssl
keyword is present, the relay will accept connections using the
encrypted SSL protocol.
The relay will look up a private key in
.Pa /etc/ssl/private/address.key
and a public certificate in
.Pa /etc/ssl/address.crt ,
where
.Ar address
is the specified IP address of the relay to listen on.
See
.Xr ssl 8
for details about SSL server certificates.
.It Xo
.Ic forward to Ar address Ic port Ar port
.Op Ic retry Ar number
.Xc
Specify the address and port of the target host to connect to.
.It Xo
.Ic service Ar name
.Op Ic retry Ar number
.Xc
Use the first virtual IP address and port from the specified service
as the target host to connect to.
This is exclusive to the
.Ic forward to
and
.Ic table
directives.
.It Xo
.Ic table Ar name Ar mode
.Op Ic no check
.Xc
Get the target host from the specified table.
The following modes are available to select a host from the specified
table:
.Pp
.Bl -tag -width loadbalance -offset indent -compact
.It Ic roundrobin
Distributes the outgoing connections using a round-robin scheduler
through all active hosts.
.It Ic loadbalance
Balances the outgoing connections across the active hosts based on the
hashed name of the table, the source and destination addresses,
and the corresponding ports.
.It Ic hash
Like the
.Ic loadbalance
mode, but without including the source and destination addresses and
ports.
Additional input can be fed into the hash by looking at HTTP
headers and GET variables; see the
.Sx PROTOCOLS
section below.
.El
.Pp
The optional host retry option will be used as a tolerance for failed
host connections; the connection will be retried for
.Ar number
more times.
See the
.Sx TABLES
section for details about host entries.
.It Xo
.Ic nat lookup
.Op Ic retry Ar number
.Xc
When redirecting connections with an
.Ar rdr
rule in
.Xr pf.conf 5
to a relay listening on localhost, this directive will
look up the real destination address of the intended target host,
allowing the relay to be run as a transparent proxy.
If either the
.Ic forward to ,
.Ic service ,
or
.Ic table
directive is present, it will be used as a backup if the NAT lookup
failed.
.It Ic timeout Ar seconds
Specify the timeout in seconds for accepted sessions.
The default timeout is 600 seconds (10 minutes).
.It Ic disable
Start the relay but immediately close any accepted connections.
.It Ic protocol Ar name
Use the specified protocol definition for the relay.
The generic TCP protocol options will be used by default;
see the
.Sx PROTOCOLS
section below.
.El
.Sh PROTOCOLS
Protocols are templates defining actions and settings for relays.
They allow setting generic TCP options, SSL settings, and actions
specific to the selected application layer protocol.
.Pp
The protocol configuration directives are described below.
.Bl -tag -width Ds
.It Ic protocol Ar type
Enable special handling of the specified application layer protocol.
The supported TCP protocols are:
.Pp
.Bl -tag -width http -offset indent -compact
.It Ic http
Handle the Hypertext Transfer Protocol
(HTTP or "HTTPS" if encapsulated in a SSL tunnel).
.It Ic tcp
Generic handler for TCP-based protocols.
.El
.Pp
.Xr hoststated 8
also supports relaying of UDP protocols.
There is no generic handler for UDP-based protocols because it is a
stateless datagram-based protocol which has to look into the
application layer protocol to find any possible state information.
The supported UDP protocols are:
.Pp
.Bl -tag -width http -offset indent -compact
.It Ic dns
Domain Name System (DNS) protocol.
The request IDs in the DNS header will be used to match the state.
.Xr hoststated 8
will replace these IDs with random values to compensate for
predictable values generated by some hosts.
.El
.It Xo
.Op Ar direction
.Op Ar type
.Ar action
.Op Ic marked Ar id
.Op Ic log
.Xc
Define an action for the selected entity.
The optional
.Ic log
keyword will log the entity name and the value and
the optional
.Ic marked
keyword requires that the session has been marked with a given
identifier in order to execute the action.
The actions are depending on the underlying application
.Ic protocol .
.Pp
The following directions are allowed for the specified action:
.Bl -tag -width Ds
.It Ic request
Handle the data stream from the client to the relay, like HTTP
requests.
This is the default if the direction directive is omitted.
.It Ic response
Handle the data stream from the target host to the relay, like
HTTP server replies.
.El
.Pp
The following entity types for the actions are available:
.Bl -tag -width Ds
.It Ic cookie
Look up the entity as a value in the Cookie header when using the
.Ic http
protocol.
This type is only available with the direction
.Ic request .
.It Ic header
Look up the entity in the application protocol headers, like HTTP
headers in
.Ic http
mode.
.It Ic path
Look up the entity as a value in the URL path when using the
.Ic http
protocol.
This type is only available with the direction
.Ic request .
The
.Ar key
will match the path of the requested URL without the hostname
and query and the value will match the complete query,
for example:
.Bd -literal -offset indent
request path filter "/index.html"
request path filter "foo=bar*" from "/cgi-bin/t.cgi"
.Ed
.It Ic query
Look up the entity as a query variable in the URL when using the
.Ic http
protocol.
This type is only available with the direction
.Ic request ,
for example:
.Bd -literal -offset indent
# Will match /cgi-bin/example.pl?foo=bar&ok=yes
request query expect "bar" from "foo"
.Ed
.It Ic url
Look up the entity as a URL suffix/prefix expression consisting of a
canonicalized hostname without port or suffix and a path name or
prefix when using the
.Ic http
protocol.
This type is only available with the direction
.Ic request ,
for example:
.Bd -literal -offset indent
request url filter "example.com/index.html"
request url filter "example.com/test.cgi?val=1"
.Ed
.Pp
.Xr hoststated 8
will match the full URL and different possible suffix/prefix
combinations by stripping subdomains and path components (up to 5
levels), and the query string.
For example, the following
lookups will be done for
.Ar http://www.example.com:81/1/2/3/4/5.html?query=yes :
.Bd -literal -offset indent
www.example.com/1/2/3/4/5.html?query=yes
www.example.com/1/2/3/4/5.html
www.example.com/
www.example.com/1/
www.example.com/1/2/
www.example.com/1/2/3/
example.com/1/2/3/4/5.html?query=yes
example.com/1/2/3/4/5.html
example.com/
example.com/1/
example.com/1/2/
example.com/1/2/3/
.Ed
.El
.Pp
The following actions are available:
.Bl -tag -width Ds
.It Ic append Ar value Ic to Ar key
Append the specified value to a protocol entity with the selected name.
When using the
.Ic http
protocol,
.Ic key
will indicate a specified HTTP header.
If
.Ar key
does not exist in the request, it will be created with the value
set to
.Ar value .
.It Ic change Ar key Ic to Ar value
Like the
.Ic append
directive above, but change the contents of the specified entity.
If
.Ar key
does not exist in the request, it will be created with the value
set to
.Ar value .
.It Ic remove Ar key
Remove the entity with the selected name.
.It Ic expect Ar value Ic from Ar key
Expect an entity
.Ar key
and match against
.Ar value
using shell globbing rules.
If the entity is not present or the value doesn't match, the connection
will be dropped.
.It Xo
.Ic expect
.Op Ic digest
.Ar key
.Xc
Expect an entity
.Ar key
with any possible value.
This is the short form of
.Ic expect Ar * Ic from Ar key .
.Pp
If the
.Ic digest
keyword is specified,
compare the message digest of the entity against the defined string.
The algorithm used is determined by the string length of the
.Ar key
argument, either SHA1 (40 characters) or MD5 (32 characters).
To compute the digest, use this simple command:
.Bd -literal -offset indent
echo -n "example.com/path/?args" | sha1
.Ed
.It Ic filter Ar value Ic from Ar key
Like the
.Ic expect Ar .. Ic from
directive above, but drop any connections with the specified entity
.Ar key
and a matching
.Ar value .
.It Xo
.Ic filter
.Op Ic digest
.Ar key
.Xc
Like the
.Ic expect
directive above, but drop any connections with the specified entity
.Ar key
and any possible value.
This is the short form of
.Ic filter Ar * Ic from Ar key .
.It Ic hash Ar key
Feed the value of the selected entity into the load balancing hash to
select the target host.
See the
.Ic table
keyword in the
.Sx RELAYS
section above.
.It Ic log Ar key
Log the name and the value of the entity.
.It Xo
.Ic mark
.Op Ar value Ic from
.Ar key Ic with Ar id
.Xc
Mark the session with the specified identifier (a positive number
between 1 and 65535) if the specified condition matches.
Note that the
.Ic mark
action does not accept the
.Ic marked
option (see above).
.El
.It Ic label Ar string
Add a label to subsequently added actions.
The label will be printed as part of the error message if the
.Ic return error
option is set and may contain HTML tags, for example:
.Bd -literal -offset indent
label "<a href='http://example.com/advisory.pl?id=7359'>\e
	Advisory provided by example.com</a>"
url filter digest 5c1e03f58f8ce0b457474ffb371fd1ef
url filter digest 80c1a7b8337462093ef8359c57b4d56a
no label
.Ed
.It Ic no label
Do not set a label for subsequently added actions, this is the default.
.It Ic return error Op Ar option
Return an error reponse to the client if an internal operation or the
forward connection to the client failed.
By default, the connection will be silently dropped.
The effect of this option depends on the protocol: HTTP will send an
error header and page to the client before closing the connection.
Additional valid options are:
.Bl -tag -width Ds
.It Ic style Ar string
Specify a Cascading Style Sheet (CSS) to be used for the returned
HTTP error pages, for example:
.Bd -literal -offset indent
body { background: #a00000; color: white; }
.Ed
.El
.It Ic tcp Ar option
Enable or disable the specified TCP/IP options; see
.Xr tcp 4
and
.Xr ip 4
for more information about the options.
Valid options are:
.Bl -tag -width Ds
.It Ic backlog Ar number
Set the maximum length the queue of pending connections may grow to.
The backlog option is 10 by default and is limited by the
.Ic kern.somaxconn
.Xr sysctl 8
variable.
.It Ic ip minttl Ar number
This option for the underlying IP connection may be used to discard packets
with a TTL lower than the specified value.
This can be used to implement the
.Ar Generalized TTL Security Mechanism (GTSM)
according to RFC 3682.
.It Ic ip ttl
Change the default time-to-live value in the IP headers.
.It Xo
.Op Ic no
.Ic nodelay
.Xc
Enable the TCP NODELAY option for this connection.
This is recommended to avoid delays in the relayed data stream,
e.g. for SSH connections.
.It Xo
.Op Ic no
.Ic sack
.Xc
Use selective acknowledgements for this connection.
.It Ic socket buffer Ar number
Set the socket-level buffer size for input and output for this
connection.
This will affect the TCP window size.
.El
.It Ic ssl Ar option
Set the SSL options and session settings.
This is only used if SSL is enabled in the relay.
Valid options are:
.Bl -tag -width Ds
.It Ic ciphers Ar string
Set the string defining the SSL cipher suite.
If not specified, the default value
.Ar HIGH:!ADH
will be used (strong crypto cipher suites without anonymous DH).
See the
.Sx CIPHERS
section of
.Xr openssl 1
for information about SSL cipher suites and preference lists.
.It Ic session cache Ar value
Set the maximum size of the SSL session cache.
If the
.Ar value
is zero, the default size defined by the SSL library will be used.
A positive number will set the maximum size in bytes and the keyword
.Ic disable
will disable the SSL session cache.
.It Xo
.Op Ic no
.Ic sslv2
.Xc
Enable the SSLv2 protocol;
disabled by default.
.It Xo
.Op Ic no
.Ic sslv3
.Xc
Disable the SSLv3 protocol;
enabled by default.
.It Xo
.Op Ic no
.Ic tlsv1
.Xc
Disable the TLSv1/SSLv3.1 protocol;
enabled by default.
.El
.El
.Pp
The
.Ar value
strings of the
.Ic append
and
.Ic change
directives may contain predefined macros that will be expanded at runtime:
.Pp
.Bl -tag -width $SERVER_ADDR -offset indent -compact
.It Ic $REMOTE_ADDR
The IP address of the connected client.
.It Ic $REMOTE_PORT
The TCP source port of the connected client.
.It Ic $SERVER_ADDR
The configured IP address of the relay.
.It Ic $SERVER_PORT
The configured TCP server port of the relay.
.It Ic $TIMEOUT
The configured session timeout of the relay.
.El
.Sh FILES
.Bl -tag -width "/etc/ssl/private/address.keyXX" -compact
.It Pa /etc/hoststated.conf
.Xr hoststated 8
configuration file.
.Pp
.It Pa /etc/services
Service name database.
.Pp
.It Pa /etc/ssl/address.crt
.It Pa /etc/ssl/private/address.key
Location of the relay SSL server certificates, where
.Ar address
is the configured IP address of the relay.
.El
.Sh EXAMPLES
This configuration file would create a service
.Dq www
which load balances four hosts
and falls back to one host containing a
.Dq sorry page :
.Bd -literal -offset indent
www1=front-www1.private.example.com
www2=front-www2.private.example.com
www3=front-www3.private.example.com
www4=front-www4.private.example.com

interval 5

table phphosts {
	timeout 300
	real port 8080
	check http "/" digest "630aa3c2f..."
	host $www1
	host $www2
	host $www3
	host $www4
}

table sorryhost {
	check icmp
	disable
	timeout 300
	real port 8080
	host sorryhost.private.example.com
}

service www {
	virtual host www.example.com port 8080 interface trunk0
	virtual host www6.example.com port 80 interface trunk0

	tag HOSTSTATED
	table phphosts
	backup table sorryhost
}
.Ed
.Pp
The following configuration would add a relay to forward
secure HTTPS connections to a pool of HTTP webservers
using the
.Ic loadbalance
protocol (SSL acceleration and layer 7 load balancing).
The HTTP protocol definition will add two HTTP headers containing
address information of the client and the server, set the
.Dq Keep-Alive
header value to the configured session timeout,
and include the
.Dq sessid
variable in the hash to calculate the target host:
.Bd -literal -offset indent
protocol http_ssl {
	protocol http
	header append "$REMOTE_ADDR" to "X-Forwarded-For"
	header append "$SERVER_ADDR:$SERVER_PORT" to "X-Forwarded-By"
	header change "Keep-Alive" to "$TIMEOUT"
	query hash "sessid"
	cookie hash "sessid"
	path filter "*command=*" from "/cgi-bin/index.cgi"

	ssl { sslv2, ciphers "MEDIUM:HIGH" }
}

relay sslaccel {
        listen on www.example.com port 443 ssl
        protocol http_ssl
        table phphosts loadbalance
}
.Ed
.Pp
The second relay example will accept incoming connections to port
2222 and forward them to a remote SSH server.
The TCP
.Ic nodelay
option will allow a
.Dq smooth
SSH session without delays between keystrokes or displayed output on
the terminal:
.Bd -literal -offset indent
protocol myssh {
        tcp { nodelay, socket buffer 65536 }
}

relay sshforward {
	protocol myssh
        listen on www.example.com port 2222
	forward to shell.example.com port 22
}
.Ed
.Sh SEE ALSO
.Xr hoststatectl 8 ,
.Xr hoststated 8 ,
.Xr ssl 8
.Sh HISTORY
The
.Nm
file format first appeared in
.Ox 4.1 .
.Sh AUTHORS
.An -nosplit
The
.Xr hoststated 8
program was written by
.An Pierre-Yves Ritschard Aq pyr@@openbsd.org
and
.An Reyk Floeter Aq reyk@@openbsd.org .
@


1.69
log
@allow to add labels to protocol actions, they will be printed in http
error pages and can be used to refer to additional information.

ok pyr@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.68 2007/11/25 20:02:02 reyk Exp $
d18 1
a18 1
.Dd $Mdocdate: November 25 2007 $
@


1.68
log
@"canonicalized hostname" instead of just "hostname" for the url action
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.67 2007/11/24 19:00:44 jmc Exp $
d18 1
a18 1
.Dd $Mdocdate: November 24 2007 $
d709 14
@


1.67
log
@new sentence, new line;
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.66 2007/11/24 16:13:50 reyk Exp $
d577 2
a578 1
hostname without port or suffix and a path name or prefix when using the
@


1.66
log
@extend the url lookup algorithm to match the full URL and different
possible suffix/prefix combinations by stripping subdomains, path
components, and the query args.

ok and tested by gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.65 2007/11/23 09:45:33 reyk Exp $
d18 1
a18 1
.Dd $Mdocdate: November 23 2007 $
d591 2
a592 1
levels), and the query string. For example, the following
@


1.65
log
@- use either "host name" or "hostname", i decided to use "hostname" everywhere
- a URL instead of an URL (a "you-are-el")

suggested by jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.64 2007/11/23 09:39:42 reyk Exp $
d577 1
a577 1
hostname or suffix and a path name or prefix when using the
d586 21
@


1.64
log
@re-implement the "mark" action and document it in the manpage:
it is possible to attach a mark to a session based on matching an
entity (header, url, cookie, ...) and add conditional action for this
mark. it works a bit like the tag/tagged keywords in pf, but i decided
to pick a different name to avoid confusion.

ok pyr@@ gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.63 2007/11/22 10:09:53 reyk Exp $
d18 1
a18 1
.Dd $Mdocdate: November 22 2007 $
d57 1
a57 1
can be either specified by IPv4 address, IPv6 address, or DNS host name.
d249 1
a249 1
The program will be executed for each host by specifing the host name
d576 2
a577 2
Look up the entity as an URL suffix/prefix expression consisting of a
host name or suffix and a path name or prefix when using the
@


1.63
log
@add (new) "url" protocol action, this can be used to match/filter URL
suffix/prefix expressions like "example.com/index.html?args". a digest
mode allows to match against anonymized SHA1/MD5 digests of
suffix/prefix expressions.
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.62 2007/11/21 20:24:28 reyk Exp $
d18 1
a18 1
.Dd $Mdocdate: November 21 2007 $
d511 1
d517 5
a521 1
keyword will log the entity name and the value.
d673 12
@


1.62
log
@extend action grammar with "filter value" and "expect value" as a
short form for "filter * from value" or "expect * from value".
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.61 2007/11/21 14:25:44 jmc Exp $
d556 1
a556 1
request path filter "*" from "/index.html"
d570 12
d619 1
d627 12
d648 1
@


1.61
log
@tweak previous;
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.60 2007/11/21 14:12:04 reyk Exp $
d598 5
a602 1
Expect an entity with the specified value.
d605 9
d616 10
d628 4
a631 1
and value.
d836 1
a836 1
	url hash "sessid"
@


1.60
log
@rename the "url" filter action to "query" to use the correct term.
please update your hoststated.conf configurations. also add more
examples to the manpage.

alright pyr@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.59 2007/11/21 13:04:42 reyk Exp $
d191 2
a192 2
produces a content whose message digest matches the defined string.
The used algorithm is determined by the string length of the
d194 1
a194 1
argument, it is either SHA1 (40 characters) or MD5 (32 characters).
@


1.59
log
@allow the http digest type to be either SHA1 or MD5 determined by the
digest string length; it is compatible to any existing SHA1-only
configurations.

ok pyr@@ gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.58 2007/11/21 10:19:34 pyr Exp $
d550 11
a560 2
.It Ic url
Look up the entity as a GET variable in the URL when using the
d564 6
a569 1
.Ic request .
@


1.58
log
@document the fact that port can be specified in table statements inside
service sections.
ok reyk@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.57 2007/11/20 18:24:32 jmc Exp $
d18 1
a18 1
.Dd $Mdocdate: November 20 2007 $
d191 4
a194 2
produces a content whose SHA1 digest is
.Ar digest .
@


1.57
log
@tweak previous;
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.56 2007/11/20 15:54:55 reyk Exp $
d330 3
a332 1
.It Ic table Ar name
d334 2
@


1.56
log
@it may be desirable to send a HTTP error page with error code and a
meaningful message if a HTTP/HTTPS relay closes the connection for
some reason. for example, a "403 Forbidden" if the request was
rejected by a filter. this will be enabled with the "return error"
option and is disabled by default, the standard behaviour is to
silently drop the connection; the browser may display an empty page in
this case. the look+feel of the HTTP error page can be customized with
a CSS style sheet, but we do not intend to allow customization of the
error page contents (hoststated is not a webserver!).

ok pyr@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.55 2007/11/20 15:44:21 pyr Exp $
d601 1
a601 1
The effect of this option depends on the protocol, HTTP will send a
@


1.55
log
@Allow overriding the global interval in a table.
Table specific intervals must be multiples of the global interval.
help and ok reyk@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.54 2007/10/22 15:45:40 jmc Exp $
d18 1
a18 1
.Dd $Mdocdate: October 22 2007 $
d596 15
@


1.54
log
@add missing .Ed;
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.53 2007/10/22 12:18:15 reyk Exp $
d291 3
@


1.53
log
@add support for the include directive to the configuration file parser,
based on the existing hostapd/pfctl code.

ok pyr@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.52 2007/09/28 13:29:56 pyr Exp $
d18 1
a18 1
.Dd $Mdocdate: September 28 2007 $
d76 1
@


1.52
log
@Correct my mail address.
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.51 2007/09/28 07:20:46 jmc Exp $
d66 10
@


1.51
log
@"require to +inf." is not a good verb pattern, so reword;
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.50 2007/09/28 01:11:58 pascoe Exp $
d4 1
a4 1
.\" Copyright (c) 2006, 2007 Pierre-Yves Ritschard <pyr@@spootnik.org>
d18 1
a18 1
.Dd $Mdocdate: September 5 2007 $
@


1.50
log
@Add missing "s" to https check description.

ok pyr@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.48 2007/09/05 09:15:10 reyk Exp $
d475 1
a475 1
stateless datagram-based protocol which requires to look into the
@


1.49
log
@add support for relaying DNS traffic (with a little bit of packet
header randomization). this adds an infrastructure to support
UDP-based protocols.

ok gilles@@, tested by some
@
text
@d199 1
a199 1
.Ic check http Ar path
@


1.48
log
@add my copyright because i added a lot.

ok pyr@@ (who is the first copyright holder)
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.47 2007/09/04 14:15:05 pyr Exp $
d18 1
a18 1
.Dd $Mdocdate: September 4 2007 $
d462 1
a462 1
The supported protocols are:
d470 16
@


1.47
log
@Add the ability to specify a host header when using http(s) check methods.
Prodded by me, done by Gille Chehade <veins@@evilkittens.org>

ok reyk, jmc for the manpage bits.
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.46 2007/07/24 17:51:33 pyr Exp $
d3 2
a4 1
.\" Copyright (c) 2006 Pierre-Yves Ritschard <pyr@@spootnik.org>
d18 1
a18 1
.Dd $Mdocdate$
@


1.46
log
@Quote digest otherwise it won't be parsed as a string.
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.45 2007/05/31 19:20:24 jmc Exp $
d152 5
a156 1
.It Ic check http Ar path Ic code Ar number
d161 10
a170 1
.It Ic check https Ar path Ic code Ar number
d172 5
a176 1
.It Ic check http Ar path Ic digest Ar string
d181 5
d197 5
a201 1
.It Ic check https Ar path Ic digest Ar string
@


1.45
log
@convert to new .Dd format;
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.44 2007/05/29 17:12:04 reyk Exp $
d675 1
a675 1
	check http "/" digest 630aa3c2f...
@


1.44
log
@add a new check method which allows to run external scripts/programs
for custom evaluations.

pyr agrees to put it in now but to do some improvements of the timeout
handling later.
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.43 2007/05/27 19:21:15 reyk Exp $
d17 1
a17 1
.Dd November 1, 2006
@


1.43
log
@allow to specify table templates in the configuration file and to
inherit them from multiple services or relays. this is useful if you
want to use a table with the same list of hosts but different ports as
specified in the relay or service section.

this makes mcbride more happy
ok pyr@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.42 2007/04/12 14:45:45 reyk Exp $
d207 15
@


1.42
log
@add a new relay 'path' action to filter the URL path and arguments.

ok pyr@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.41 2007/04/10 21:45:11 reyk Exp $
d242 4
a245 1
This parameter is mandatory.
@


1.41
log
@sort entity types
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.40 2007/03/21 00:08:08 reyk Exp $
d463 6
d702 1
@


1.40
log
@in addition to the host retry option in tables, add support for the
optional connection "retry" to the forward to, service, and nat lookup
options. for example, "nat lookup retry 3" is useful when running
hoststated as a transparent proxy when connecting to unreliable
frontend/backend servers.

ok pyr@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.39 2007/03/13 12:04:52 reyk Exp $
d452 6
a464 6
.Ic http
protocol.
This type is only available with the direction
.Ic request .
.It Ic cookie
Look up the entity as a value in the Cookie header when using the
@


1.39
log
@allow to specify the IP_TTL and IP_MINTTL options for the relays to
support the Generalized TTL Security Mechanism (GTSM) according to RFC
3682. this is especially useful with inbound connections and a fixed
distance to the backend servers.

ok pyr@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.38 2007/03/12 12:21:09 reyk Exp $
d328 4
a331 1
.It Ic forward to Ar address Ic port Ar port
d333 4
a336 1
.It Ic service Ar name
d378 4
a381 1
.It Ic nat lookup
@


1.38
log
@hoststated.conf is not a program.

thanks to Sebastian Reitenbach, closes pr 5409
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.37 2007/03/06 19:26:46 reyk Exp $
d508 1
a508 1
Enable or disable the specified TCP option; see
d510 3
a512 1
for details about TCP options.
d521 8
@


1.37
log
@add support for handling simple HTTP cookies (no per-path/domain
cookies yet), for example: cookie hash "JSESSIONID"

tested by some people
ok pyr@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.36 2007/02/27 18:04:51 jmc Exp $
d714 1
a714 1
program first appeared in
d719 1
a719 1
.Nm
@


1.36
log
@replys -> replies;
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.35 2007/02/27 13:38:58 reyk Exp $
d454 6
d676 1
@


1.35
log
@in addition to actions on request headers, allow to define relay
actions on response headers (the reply sent by backend HTTP servers).
the default and slightly faster relay streaming mode will be used if
no actions are defined.

for example:
response change "Server" to "OpenBSD-hoststated/4.1"

ok pyr@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.34 2007/02/27 08:39:00 reyk Exp $
d438 1
a438 1
HTTP server replys.
@


1.34
log
@manpage clarification for the "change" and "append" relay actions.

from Tamas TEVESZ
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.33 2007/02/27 08:02:33 jmc Exp $
d418 1
d430 11
d452 2
@


1.33
log
@tweaks;
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.32 2007/02/26 20:48:48 pyr Exp $
d451 5
d460 5
@


1.32
log
@kill the ``use ssl'' directive for consistency across parser directives.
another heads up for testers: you need to change configuration files.
ok reyk@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.31 2007/02/26 19:25:25 reyk Exp $
a174 1
If
d203 1
a203 1
If this directive is postpended with
d205 1
d214 2
a215 1
demotion option, this will increment the carp demotion counter for the
@


1.31
log
@sync the documentation with the latest change to require a 'header'
keyword for default relay actions.

ok pyr@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.30 2007/02/26 13:41:52 jmc Exp $
a156 3
If
.Ic use ssl
is specified, HTTPS will be used to contact the host.
d158 1
a158 2
This has the same effect as above but also implies
.Ic use ssl .
a175 2
.Ic use ssl
is specified, HTTPS will be used to contact the host.
d177 1
a177 2
This has the same effect as above but also implies
.Ic use ssl .
d182 7
a188 1
.It Ic check send Ar data Ic expect Ar pattern
d204 3
a206 3
If
.Ic use ssl
is specified, the data will be sent and/or received inside an SSL tunnel.
d208 1
a208 4
This has the same effect as
.Ic check tcp
but also implies
.Ic use ssl .
a210 3
If
.Ic use ssl
is specified, a complete SSL handshake will also be performed.
a246 2
.It Ic use ssl
If the table uses a TCP check, wrap it in SSL.
@


1.30
log
@grammar;
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.29 2007/02/26 13:03:30 pyr Exp $
d426 1
d431 1
a431 1
The
d434 12
a445 4
The optional
.Ic url
keyword will look up the entity as a GET variable in the URL instead
of an HTTP header value when using the
d448 3
d465 1
a465 4
.It Xo
.Op Ic url
.Ic expect Ar value Ic from Ar key
.Xc
d469 1
a469 10
The
.Ic url
keyword will expect the value as a GET variable in the URL instead
of an HTTP header value when using the
.Ic http
protocol.
.It Xo
.Op Ic url
.Ic filter Ar value Ic from Ar key
.Xc
d474 1
a474 4
.It Xo
.Op Ic url
.Ic hash Ar key
.Xc
d482 1
a482 4
.It Xo
.Op Ic url
.Ic log Ar key
.Xc
d649 4
a652 4
        protocol http
        append "$REMOTE_ADDR" to "X-Forwarded-For"
        append "$SERVER_ADDR:$SERVER_PORT" to "X-Forwarded-By"
        change "Keep-Alive" to "$TIMEOUT"
@


1.29
log
@Change the ``virtual ip'' directive to ``virtual host''.
You will need to update your configuration files accordingly.
"just do it", reyk@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.28 2007/02/26 11:59:48 reyk Exp $
d374 1
a374 1
host connections, the connection will be retried for
d376 2
a377 2
more times,
see the
@


1.28
log
@re-use the retry value from table host entries for inbound relay
connections. the relay will retry to connect to the hosts for the
specified number of times. this sounds bad, but is a useful
"workaround" for unreliable backend servers...
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.27 2007/02/25 09:04:59 jmc Exp $
d287 1
a287 1
.It Ic virtual ip Ar address Ic port Ar port
d632 2
a633 2
	virtual ip www.example.com port 8080 interface trunk0
	virtual ip www6.example.com port 80 interface trunk0
@


1.27
log
@tweaks;
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.26 2007/02/24 16:14:02 reyk Exp $
d372 8
@


1.26
log
@disable anonymous DH by default (cipher suite HIGH:!ADH instead of HIGH).
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.25 2007/02/24 15:48:54 reyk Exp $
a430 1
.Pp
d519 1
a519 1
If not specified, the default value 
d539 1
a539 1
Enable the SSLv2 protocol,
d545 1
a545 1
Disable the SSLv3 protocol,
d551 1
a551 1
Disable the TLSv1/SSLv3.1 protocol,
@


1.25
log
@disable SSLv2 and use "HIGH" crypto cipher suites by default.

suggested by dlg@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.24 2007/02/24 00:22:32 reyk Exp $
d521 2
a522 2
.Ar HIGH
to force strong crypto cipher suites will be used.
@


1.24
log
@- allow to specify the SSL cipher suite and the SSL protocols
  (as required by the PCI DSS)
- increase the default listen backlog to 10, allow to modify the
  backlog as a per-protocol tcp option to improve the performance
  on busy systems (to get less connection failures on heavy load)
- close the connection if SSL_accept returned an error
- instead of logging _new_ relay sessions to syslog, log the
  sessions in relay_close() after they have been _finished_.
  this will allow to collect some additional information
- add a new log keyword to log specified header/url entities (useful
  to track "bad guys" using many session ids or multiple user agents)
- some minor fixes, manpage bits, and bump the copyright (by some
  reason, i didn't realize that we already have 2007...).
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.23 2007/02/23 14:54:44 jmc Exp $
d520 3
a522 2
If not specified, the default suite defined by the SSL library will be
used.
d540 2
a541 1
Enable the SSLv2 protocol.
d546 2
a547 1
Enable the SSLv3 protocol.
d552 2
a553 1
Enable the TLSv1/SSLv3.1 protocol.
d654 1
a654 1
	ssl { no sslv2, ciphers "HIGH" }
@


1.23
log
@i.e. -> e.g.; ok reyk
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.22 2007/02/22 09:34:06 jmc Exp $
d417 16
d478 6
a483 6
The
.Ic url
keyword will look up the entity as a GET variable in the URL instead
of an HTTP header value when using the
.Ic http
protocol.
d490 6
d513 15
a527 1
.It Ic ssl session cache Ar value
d535 16
d649 2
d669 1
a669 1
protocol http_ssl {
d674 1
@


1.22
log
@put `check ssl' in the right place;
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.21 2007/02/22 09:20:01 jmc Exp $
d480 1
a480 1
i.e. for SSH connections.
@


1.21
log
@various language/macro fixes;
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.20 2007/02/22 04:13:06 reyk Exp $
d208 5
a217 3
.It Ic check ssl
This has the same effect as above but also implies
.Ic use ssl .
@


1.20
log
@document the retry option before setting the state to down for hosts
in tables.
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.19 2007/02/22 04:06:18 reyk Exp $
d47 2
a48 2
Relays allow layer 7 loadbalancing, SSL acceleration, and
general-purpose TCP proxying.
d306 1
a306 1
The main purpose of a relay is to provide advanced loadbalancing
d320 1
a320 1
If the 
d324 1
a324 1
The relay will lookup a private key in
d327 1
a327 2
.Pa /etc/ssl/address.crt
in this case, 
d354 1
a354 1
distributes the outgoing connections using a round-robin scheduler
d365 3
a367 3
Additional input can be feeded into the hash by looking at HTTP
headers and GET variables, see the
.Sx Protocols
d371 1
a371 1
When redirecting connections with a
d375 3
a377 3
to a relay listening on localhost, this directive will allow to
lookup the real destination address of the intended target host.
This allows to run the relay as a transparent proxy.
d392 1
a392 1
The generic TCP protocol options will be used by default,
d394 1
a394 1
.Sx Protocols
d399 1
a399 1
They allow to set generic TCP options, SSL settings, and actions
d438 1
a438 1
of a HTTP header value when using the
d453 1
a453 1
Feed the value of the selected entity into the loadbalancing hash to
d458 1
a458 1
.Sx Relays
d462 2
a463 2
keyword will lookup the entity as a GET variable in the URL instead
of a HTTP header value when using the
d467 1
a467 1
Enable or disable the specified TCP option, see
a470 1
.Pp
d478 1
a478 1
ie. for SSH connections.
d493 2
a494 3
is zero, the default size defined by the SSL library will be
used, a positive number will set the maximun size in bytes and the
keyword
d505 1
a505 1
directives may contain predefined macros that will be expanded on runtime:
d519 15
d580 1
a580 1
protocol (SSL acceleration and layer 7 loadbalancing).
d621 1
a621 13
.Sh FILES
.Bl -tag -width "/etc/hoststated.conf" -compact
.It Pa /etc/hoststated.conf
.Xr hoststated 8
configuration file
.It Pa /etc/services
Service name database
.It Pa /etc/ssl/private/address.key
.It Pa /etc/ssl/address.crt
Location of the relay SSL server certificates, where
.Ar address
is the configured IP address of the relay.
.El
d632 1
@


1.19
log
@document the new options to manipulate carp demotion counters.
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.18 2007/02/22 03:32:39 reyk Exp $
d230 4
a233 1
.It Ic host Ar address
d238 4
@


1.18
log
@Add layer 7 functionality to hoststated used for layer 7
loadbalancing, SSL acceleration, general-purpose TCP relaying, and
transparent proxying.

see hoststated.conf(5) and my upcoming article on undeadly.org for
details.

ok to commit deraadt@@ pyr@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.17 2007/02/07 15:17:46 reyk Exp $
d92 12
d216 10
@


1.17
log
@add new "log (updates|all)" configuration option to log state
notifications after completed host checks.  either only log the
"updates" to new states or log "all" state notifications, even if the
state didn't change. the log messages will be reported to syslog or to
stderr if the daemon is running in foreground mode.

ok claudio@@ pyr@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.16 2007/01/29 18:38:15 pyr Exp $
d29 1
a29 1
is divided into four main sections:
d46 5
d117 9
d269 225
a493 1
.Sh EXAMPLE
d534 46
d587 5
d595 14
a608 1
.Xr hoststated 8
@


1.16
log
@manpage tweaks.
advised by and ok jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.15 2007/01/29 14:23:31 pyr Exp $
d92 19
@


1.15
log
@Add SSL support to hoststated.
with help and OK reyk@@
with help and advice by claudio@@ and Srebrenko Sehic
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.14 2007/01/10 13:42:19 jmc Exp $
d116 1
a116 1
This has the same effect than above but also implies 
d138 1
a138 1
This has the same effect than above but also implies 
d162 1
a162 1
is specified, the data will be sent and/or received inside a SSL tunnel.
d169 1
a169 1
This has the same effect than above but also implies 
d191 1
a191 1
When the table uses a TCP check, wrap it into SSL.
@


1.14
log
@tweaks;
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.13 2007/01/09 13:50:11 pyr Exp $
d112 6
d134 6
d160 3
d165 6
d190 2
@


1.13
log
@Finish renaming hostated to hoststated.
Note to testers: the user the daemon changes its id to is now _hoststated,
don't forget to update master.passwd.
ok reyk@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: hoststated.conf.5,v 1.12 2007/01/08 20:46:18 reyk Exp $
d56 1
a56 1
.Pa /etc/services,
d134 1
a134 1
port specified, then 
d137 1
a137 1
Incoming data is then read and is expected to match against 
@


1.12
log
@do NOT use the regexp interface. it is way to complicated, error-prone
and we don't know about all the possible security problems.

change the check send/expect code to use the fnmatch(3) interface
using shell globbing rules instead. this allows simple patterns like
"220 * ESMTP*" or "SSH-[12].??-*".

suggested by deraadt@@ and otto@@
ok Pierre-Yves Ritschard (pyr at spootnik dot org)
@
text
@d1 1
a1 1
.\"	$OpenBSD: hostated.conf.5,v 1.11 2007/01/08 17:52:27 reyk Exp $
d18 1
a18 1
.Dt HOSTATED.CONF 5
d21 1
a21 1
.Nm hostated.conf
d26 1
a26 1
.Xr hostated 8 .
d36 1
a36 1
.Xr hostated 8 .
d153 1
a153 1
.Xr hostatectl 8 .
d185 1
a185 1
.Xr hostatectl 8 .
d249 1
a249 1
	tag HOSTATED
d255 3
a257 3
.Bl -tag -width "/etc/hostated.conf" -compact
.It Pa /etc/hostated.conf
.Xr hostated 8
d263 2
a264 2
.Xr hostatectl 8 ,
.Xr hostated 8
@


1.11
log
@ports can be specified by number or by name
@
text
@d1 1
a1 1
.\"	$OpenBSD: hostated.conf.5,v 1.10 2007/01/08 17:05:48 reyk Exp $
d132 1
a132 1
.It Ic check send Ar data Ic expect Ar regexp
d138 2
a139 1
.Ar regexp.
a219 2
##
##
@


1.10
log
@timeouts must not exceed the global interval
@
text
@d1 1
a1 1
.\"	$OpenBSD: hostated.conf.5,v 1.9 2007/01/08 13:37:26 reyk Exp $
d47 13
d158 4
a161 3
.It Ic real port Ar number
When using the TCP or HTTP checking methods, use this port to connect
to hosts.
d199 6
a204 2
.It Ic virtual ip Ar address Ic port Ar number
Specify an address and a port that will be used to redirect requests
d260 2
@


1.9
log
@add a generic send/expect check using regular expression (see
regex(3)).  this allows to define additional checks for other TCP
protocols.

From Pierre-Yves Ritschard (pyr at spootnik dot org)
@
text
@d1 1
a1 1
.\"	$OpenBSD: hostated.conf.5,v 1.8 2007/01/03 09:42:30 reyk Exp $
d75 1
a75 1
.Ic timeout Ar number
d77 2
a78 3
Set the global timeout in milliseconds for checks.
This can be overriden by the timeout value in the table definitions
and is 200 milliseconds by default.
d81 1
a81 1
.Ic interval Ar number
d83 4
a86 2
Set the interval in seconds at which the hosts will be checked.
The default interval is 10 seconds.
@


1.8
log
@allow the sticky-address option for round-robin pools.

From Pierre-Yves Ritschard (pyr at spootnik dot org)
@
text
@d1 1
a1 1
.\"	$OpenBSD: hostated.conf.5,v 1.7 2006/12/25 19:07:34 reyk Exp $
d118 15
@


1.7
log
@the global timeout for checks is specified in milliseconds
@
text
@d1 1
a1 1
.\"	$OpenBSD: hostated.conf.5,v 1.6 2006/12/25 18:12:14 reyk Exp $
d155 6
@


1.6
log
@partial rewrite of the check_* routines to use libevent everywhere
instead of nested select() calls and to handle the non-blocking
sockets properly.

From Pierre-Yves Ritschard (pyr at spootnik dot org)
(with a little help by me)
@
text
@d1 1
a1 1
.\"	$OpenBSD: hostated.conf.5,v 1.5 2006/12/19 14:39:30 jmc Exp $
d77 1
a77 1
Set the global timeout for checks.
@


1.5
log
@sort the various commands; discussed w/ pyr
@
text
@d1 1
a1 1
.\"	$OpenBSD: hostated.conf.5,v 1.4 2006/12/18 19:48:04 jmc Exp $
d71 1
a71 1
Only one global setting can be set.
d75 7
d135 3
a137 2
Set the timeout in milliseconds for each host that is checked.
The default timeout is 200 milliseconds.
@


1.4
log
@some initial improvements for the hostated pages;
@
text
@d1 1
a1 1
.\"	$OpenBSD: hostated.conf.5,v 1.3 2006/12/16 12:42:14 reyk Exp $
a85 6
.It Ic check tcp
Use a simple TCP connect to check that hosts are up.
.It Ic check icmp
Ping hosts in this table to determine whether they are up or not.
This method will automatically use ICMP or ICMPV6 depending on the
address family of each host.
d107 15
a121 3
.It Ic timeout Ar number
Set the timeout in milliseconds for each host that is checked.
The default timeout is 200 milliseconds.
d127 3
a129 9
.It Ic host Ar address
Add the host whose address is
.Ar address
to the list of hosts to be checked in this table.
Each table needs at least one host.
.It Ic disable
Start the table disabled \(en no hosts will be checked in this table.
The table can be later enabled through
.Xr hostatectl 8 .
a139 11
.It Ic virtual ip Ar address Ic port Ar number
Specify an address and a port that will be used to redirect requests
to the hosts in the main or backup table.
Optionally an interface name can be given as follows,
to specify which interface the rdr rule will be enabled on:
.Bd -literal -offset indent
interface ``ifname''
.Ed
.It Ic table Ar name
Specify the main table to be used.
This is mandatory.
d147 3
d155 8
@


1.3
log
@knf, spacing

please note that some editors will replace tabs with multiple spaces
if you cut & paste code from other sections.  please try to keep the
tabs ;).
@
text
@d1 1
a1 1
.\"	$OpenBSD: hostated.conf.5,v 1.2 2006/12/16 11:52:51 reyk Exp $
d22 1
a22 1
.Nd Host Status daemon configuration file.
d24 3
a26 5
The
.Xr hostated 8
daemon maintains
.Xr pf 4
tables up to date.
a27 1
The
d29 1
a29 1
configuration file is divided into four main sections.
d87 1
a87 1
Use a simple tcp connect to check that hosts are up.
d89 2
a90 2
Ping hosts in this table to determine wether they are up or not.
This method will automatically use icmp or icmpv6 depending on the
d96 1
a96 1
.Ar number
d103 2
a104 2
To compute the digest you can use this simple command:
.Bd -literal -offset 2n
d108 3
a110 2
This will give you a digest of the form
.Bd -literal -offset 2n
a112 2
.Pp
that you can use as-is in your digest statement.
d117 1
a117 1
When using the tcp or http checking methods, use this port to connect
d127 1
a127 1
Start the table disabled, no hosts will be checked in this table.
d134 2
a135 1
rdr rule, they are used to specify which addresses will be redirected
d143 2
a144 1
Optionally an interface name can be specified like this.
a147 2
.Pp
to specify which interface the rdr rule will be enabled on.
d157 1
d162 1
a162 4
This allows for easier filter rules in your main
.Xr pf 4
configuration.
.Xr hostatectl 5 .
d165 5
a169 2
This configuration file would create a service 'www' which load-balances
4 hosts and falls back to 1 host containing a ``sorry page'':
d214 2
a215 2
.Xr hostated 8 ,
.Xr hostatectl 8 .
@


1.2
log
@new sentence, new line
@
text
@d1 1
a1 1
.\"	$OpenBSD: hostated.conf.5,v 1.1 2006/12/16 11:45:07 reyk Exp $
d26 1
a26 1
daemon maintains 
d41 1
a41 1
Table definitions describe the content of a 
d138 1
a138 1
rdr rule, they are used to specify which addresses will be redirected 
d201 1
a201 1
service www { 
@


1.1
log
@Import hostated, the host status daemon.  This daemon will monitor
remote hosts and dynamically alter pf(4) tables and redirection rules
for active server load balancing.  The daemon has been written by
Pierre-Yves Ritschard (pyr at spootnik.org) and was formerly known as
"slbd".

The daemon is fully functional but it still needs some work and
cleanup so we don't link it to the build yet.  Some TODOs are a
partial rewrite of the check_* routines (use libevent whenever we
can), improvement of the manpages, and general knf and cleanup.

ok deraadt@@ claudio@@
@
text
@d1 1
a1 1
.\"	$OpenBSD$
d85 2
a86 1
method. Only one health-checking method can be used per table.
d104 3
a106 3
.Ar digest
. The digest does not take the HTTP headers into account. To compute the
digest you can use this simple command:
a108 1

d110 1
a113 1

d115 1
d122 3
a124 2
to hosts. This parameter is mandatory. Main and backup tables need
to have the same real port.
d145 2
a146 2
to the hosts in the main or backup table. 
Optionally an interface name can be specified like this
a148 1

d150 1
d153 2
a154 1
Specify the main table to be used. This is mandatory.
d159 2
a160 1
Set the service initially disabled. It can be later enabled through
d164 2
a165 2
rdr rule with the name supplied. This allows for easier filter rules
in your main
@

