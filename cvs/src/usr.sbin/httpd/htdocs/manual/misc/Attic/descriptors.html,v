head	1.6;
access;
symbols
	OPENBSD_5_5:1.5.0.46
	OPENBSD_5_5_BASE:1.5
	OPENBSD_5_4:1.5.0.42
	OPENBSD_5_4_BASE:1.5
	OPENBSD_5_3:1.5.0.40
	OPENBSD_5_3_BASE:1.5
	OPENBSD_5_2:1.5.0.38
	OPENBSD_5_2_BASE:1.5
	OPENBSD_5_1_BASE:1.5
	OPENBSD_5_1:1.5.0.36
	OPENBSD_5_0:1.5.0.34
	OPENBSD_5_0_BASE:1.5
	OPENBSD_4_9:1.5.0.32
	OPENBSD_4_9_BASE:1.5
	OPENBSD_4_8:1.5.0.30
	OPENBSD_4_8_BASE:1.5
	OPENBSD_4_7:1.5.0.26
	OPENBSD_4_7_BASE:1.5
	OPENBSD_4_6:1.5.0.28
	OPENBSD_4_6_BASE:1.5
	OPENBSD_4_5:1.5.0.24
	OPENBSD_4_5_BASE:1.5
	OPENBSD_4_4:1.5.0.22
	OPENBSD_4_4_BASE:1.5
	OPENBSD_4_3:1.5.0.20
	OPENBSD_4_3_BASE:1.5
	OPENBSD_4_2:1.5.0.18
	OPENBSD_4_2_BASE:1.5
	OPENBSD_4_1:1.5.0.16
	OPENBSD_4_1_BASE:1.5
	OPENBSD_4_0:1.5.0.14
	OPENBSD_4_0_BASE:1.5
	OPENBSD_3_9:1.5.0.12
	OPENBSD_3_9_BASE:1.5
	OPENBSD_3_8:1.5.0.10
	OPENBSD_3_8_BASE:1.5
	OPENBSD_3_7:1.5.0.8
	OPENBSD_3_7_BASE:1.5
	OPENBSD_3_6:1.5.0.6
	OPENBSD_3_6_BASE:1.5
	OPENBSD_3_5:1.5.0.4
	OPENBSD_3_5_BASE:1.5
	apache_1_3_29-mod_ssl_2_8_16:1.1.1.4
	OPENBSD_3_4:1.5.0.2
	OPENBSD_3_4_BASE:1.5
	apache_1_3_28-mod_ssl_2_8_15:1.1.1.4
	OPENBSD_3_3:1.4.0.6
	OPENBSD_3_3_BASE:1.4
	apache_1_3_27-mod_ssl_2_8_12:1.1.1.3
	apache_1_3_27:1.1.1.3
	OPENBSD_3_2:1.4.0.4
	OPENBSD_3_2_BASE:1.4
	apache_1_3_26:1.1.1.3
	OPENBSD_3_1:1.4.0.2
	OPENBSD_3_1_BASE:1.4
	OPENBSD_3_0:1.3.0.4
	OPENBSD_3_0_BASE:1.3
	OPENBSD_2_9_BASE:1.3
	OPENBSD_2_9:1.3.0.2
	OPENBSD_2_8:1.1.1.2.0.10
	OPENBSD_2_8_BASE:1.1.1.2
	OPENBSD_2_7:1.1.1.2.0.8
	OPENBSD_2_7_BASE:1.1.1.2
	OPENBSD_2_6:1.1.1.2.0.6
	OPENBSD_2_6_BASE:1.1.1.2
	OPENBSD_2_5:1.1.1.2.0.4
	OPENBSD_2_5_BASE:1.1.1.2
	OPENBSD_2_4:1.1.1.2.0.2
	OPENBSD_2_4_BASE:1.1.1.2
	apache_1_3_2:1.1.1.2
	OPENBSD_2_3:1.1.1.1.0.2
	OPENBSD_2_3_BASE:1.1.1.1
	apache:1.1.1
	apache_1_2_6:1.1.1;
locks; strict;
comment	@# @;


1.6
date	2014.04.22.14.47.24;	author henning;	state dead;
branches;
next	1.5;

1.5
date	2003.08.21.13.11.32;	author henning;	state Exp;
branches;
next	1.4;

1.4
date	2002.02.12.07.56.47;	author beck;	state Exp;
branches;
next	1.3;

1.3
date	2001.03.29.10.21.30;	author beck;	state Exp;
branches;
next	1.2;

1.2
date	2000.12.15.22.17.29;	author beck;	state Exp;
branches;
next	1.1;

1.1
date	98.03.25.07.08.36;	author beck;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	98.03.25.07.08.36;	author beck;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	98.10.01.17.20.12;	author beck;	state Exp;
branches;
next	1.1.1.3;

1.1.1.3
date	2002.07.19.21.28.07;	author henning;	state Exp;
branches;
next	1.1.1.4;

1.1.1.4
date	2003.08.21.12.53.31;	author henning;	state Exp;
branches;
next	;


desc
@@


1.6
log
@this commit is really florian@@'s, since he's the one who made removal
of our forked apache possible by his work on nginx and slowcgi, but he
doesn't want it - so it is my pleasure to tedu it. I spent so much work
on chroot in it 10 years ago - and am very happy to see it go now, nginx
is a far better choice today.
Bye bye, Apache, won't miss you.
@
text
@<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta name="generator" content="HTML Tidy, see www.w3.org" />

    <title>Descriptors and Apache</title>
  </head>
  <!-- Background white, links blue (unvisited), navy (visited), red (active) -->

  <body bgcolor="#FFFFFF" text="#000000" link="#0000FF"
  vlink="#000080" alink="#FF0000">
        <div align="CENTER">
      <img src="../images/sub.gif" alt="[APACHE DOCUMENTATION]" /> 

      <h3>Apache HTTP Server Version 1.3</h3>
    </div>


    <h1 align="CENTER">Descriptors and Apache</h1>

    <p>A <em>descriptor</em>, also commonly called a <em>file
    handle</em> is an object that a program uses to read or write
    an open file, or open network socket, or a variety of other
    devices. It is represented by an integer, and you may be
    familiar with <code>stdin</code>, <code>stdout</code>, and
    <code>stderr</code> which are descriptors 0, 1, and 2
    respectively. Apache needs a descriptor for each log file, plus
    one for each network socket that it listens on, plus a handful
    of others. Libraries that Apache uses may also require
    descriptors. Normal programs don't open up many descriptors at
    all, and so there are some latent problems that you may
    experience should you start running Apache with many
    descriptors (<em>i.e.</em>, with many virtual hosts).</p>

    <p>The operating system enforces a limit on the number of
    descriptors that a program can have open at a time. There are
    typically three limits involved here. One is a kernel
    limitation, depending on your operating system you will either
    be able to tune the number of descriptors available to higher
    numbers (this is frequently called <em>FD_SETSIZE</em>). Or you
    may be stuck with a (relatively) low amount. The second limit
    is called the <em>hard resource</em> limit, and it is sometimes
    set by root in an obscure operating system file, but frequently
    is the same as the kernel limit. The third limit is called the
    <em>soft resource</em> limit. The soft limit is always less
    than or equal to the hard limit. For example, the hard limit
    may be 1024, but the soft limit only 64. Any user can raise
    their soft limit up to the hard limit. Root can raise the hard
    limit up to the system maximum limit. The soft limit is the
    actual limit that is used when enforcing the maximum number of
    files a process can have open.</p>

    <p>To summarize:</p>

    <center>
<pre>
  #open files  &lt;=  soft limit  &lt;=  hard limit  &lt;=  kernel limit
</pre>
    </center>

    <p>You control the hard and soft limits using the
    <code>limit</code> (csh) or <code>ulimit</code> (sh)
    directives. See the respective man pages for more information.
    For example you can probably use <code>ulimit -n
    unlimited</code> to raise your soft limit up to the hard limit.
    You should include this command in a shell script which starts
    your webserver.</p>

    <p>Unfortunately, it's not always this simple. As mentioned
    above, you will probably run into some system limitations that
    will need to be worked around somehow. Work was done in version
    1.2.1 to improve the situation somewhat. Here is a partial list
    of systems and workarounds (assuming you are using 1.2.1 or
    later):</p>

    <dl>
      <dt><strong>BSDI 2.0</strong></dt>

      <dd>Under BSDI 2.0 you can build Apache to support more
      descriptors by adding <code>-DFD_SETSIZE=nnn</code> to
      <code>EXTRA_CFLAGS</code> (where nnn is the number of
      descriptors you wish to support, keep it less than the hard
      limit). But it will run into trouble if more than
      approximately 240 Listen directives are used. This may be
      cured by rebuilding your kernel with a higher
      FD_SETSIZE.</dd>

      <dt><strong>FreeBSD 2.2, BSDI 2.1+</strong></dt>

      <dd>Similar to the BSDI 2.0 case, you should define
      <code>FD_SETSIZE</code> and rebuild. But the extra Listen
      limitation doesn't exist.</dd>

      <dt><strong>Linux</strong></dt>

      <dd>By default Linux has a kernel maximum of 256 open
      descriptors per process. There are several patches available
      for the 2.0.x series which raise this to 1024 and beyond, and
      you can find them in the "unofficial patches" section of <a
      href="http://www.linuxhq.com/">the Linux Information HQ</a>.
      None of these patches are perfect, and an entirely different
      approach is likely to be taken during the 2.1.x development.
      Applying these patches will raise the FD_SETSIZE used to
      compile all programs, and unless you rebuild all your
      libraries you should avoid running any other program with a
      soft descriptor limit above 256. As of this writing the
      patches available for increasing the number of descriptors do
      not take this into account. On a dedicated webserver you
      probably won't run into trouble.</dd>

      <dt><strong>Solaris through 2.5.1</strong></dt>

      <dd>Solaris has a kernel hard limit of 1024 (may be lower in
      earlier versions). But it has a limitation that files using
      the stdio library cannot have a descriptor above 255. Apache
      uses the stdio library for the ErrorLog directive. When you
      have more than approximately 110 virtual hosts (with an error
      log and an access log each) you will need to build Apache
      with <code>-DHIGH_SLACK_LINE=256</code> added to
      <code>EXTRA_CFLAGS</code>. You will be limited to
      approximately 240 error logs if you do this.</dd>

      <dt><strong>AIX</strong></dt>

      <dd>AIX version 3.2?? appears to have a hard limit of 128
      descriptors. End of story. Version 4.1.5 has a hard limit of
      2000.  Version 4.3.3 and 5.1 say
      <pre>
/*
 * Select uses bit masks of file descriptors.
 * These macros manipulate such bit fields.
 * FD_SETSIZE may be defined by the user to the maximum valued file
 * descriptor to be selected; the default here should be == OPEN_MAX
 */
#ifndef FD_SETSIZE
#define FD_SETSIZE     32767    /* must be == OPEN_MAX in <limits.h> */
#endif
</pre></dd>

      <dt><strong>SCO OpenServer</strong></dt>

      <dd>Edit the <code>/etc/conf/cf.d/stune</code> file or use
      <code>/etc/conf/cf.d/configure</code> choice 7 (User and
      Group configuration) and modify the <code>NOFILES</code>
      kernel parameter to a suitably higher value. SCO recommends a
      number between 60 and 11000, the default is 110. Relink and
      reboot, and the new number of descriptors will be
      available.</dd>

      <dt><strong>Compaq Tru64 UNIX/Digital UNIX/OSF</strong></dt>

      <dd>
        <ol>
          <li>Raise <code>open_max_soft</code> and
          <code>open_max_hard</code> to 4096 in the proc subsystem.
          Do a man on sysconfig, sysconfigdb, and
          sysconfigtab.</li>

          <li>Raise <code>max-vnodes</code> to a large number which
          is greater than the number of apache processes * 4096
          (Setting it to 250,000 should be good for most people).
          Do a man on sysconfig, sysconfigdb, and
          sysconfigtab.</li>

          <li>If you are using Tru64 5.0, 5.0A, or 5.1, define
          <code>NO_SLACK</code> to work around a bug in the OS.
          <code>CFLAGS="-DNO_SLACK" ./configure</code></li>
        </ol>
      </dd>

      <dt><strong>Others</strong></dt>

      <dd>If you have details on another operating system, please
      submit it through our <a
      href="http://httpd.apache.org/bug_report.html">Bug Report
      Page</a>.</dd>
    </dl>

    <p>In addition to the problems described above there are
    problems with many libraries that Apache uses. The most common
    example is the bind DNS resolver library that is used by pretty
    much every unix, which fails if it ends up with a descriptor
    above 256. We suspect there are other libraries that similar
    limitations. So the code as of 1.2.1 takes a defensive stance
    and tries to save descriptors less than 16 for use while
    processing each request. This is called the <em>low slack
    line</em>.</p>

    <p>Note that this shouldn't waste descriptors. If you really
    are pushing the limits and Apache can't get a descriptor above
    16 when it wants it, it will settle for one below 16.</p>

    <p>In extreme situations you may want to lower the low slack
    line, but you shouldn't ever need to. For example, lowering it
    can increase the limits 240 described above under Solaris and
    BSDI 2.0. But you'll play a delicate balancing game with the
    descriptors needed to serve a request. Should you want to play
    this game, the compile time parameter is
    <code>LOW_SLACK_LINE</code> and there's a tiny bit of
    documentation in the header file <code>httpd.h</code>.</p>

    <p>Finally, if you suspect that all this slack stuff is causing
    you problems, you can disable it. Add <code>-DNO_SLACK</code>
    to <code>EXTRA_CFLAGS</code> and rebuild. But please report it
    to our <a href="http://httpd.apache.org/bug_report.html">Bug
    Report Page</a> so that we can investigate. 
        <hr />

    <h3 align="CENTER">Apache HTTP Server Version 1.3</h3>
    <a href="./"><img src="../images/index.gif" alt="Index" /></a>
    <a href="../"><img src="../images/home.gif" alt="Home" /></a>

    </p>
  </body>
</html>

@


1.5
log
@merge
@
text
@@


1.4
log
@Apache 1.3.23+mod_ssl-2.8.6-1.3.23 merge
@
text
@d129 12
a140 1
      2000.</dd>
@


1.3
log
@Apache 1.3.19+mod_ssl 2.8.1 merge - also adds shared build of mod_headers
and mod_expire
@
text
@d1 2
a2 51
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<TITLE>Descriptors and Apache</TITLE>
</HEAD>

<!-- Background white, links blue (unvisited), navy (visited), red (active) -->
<BODY
 BGCOLOR="#FFFFFF"
 TEXT="#000000"
 LINK="#0000FF"
 VLINK="#000080"
 ALINK="#FF0000"
>
<DIV ALIGN="CENTER">
 <IMG SRC="../images/sub.gif" ALT="[APACHE DOCUMENTATION]">
 <H3>
  Apache HTTP Server Version 1.3
 </H3>
</DIV>

<H1 ALIGN="CENTER">Descriptors and Apache</H1>

<P>A <EM>descriptor</EM>, also commonly called a <EM>file handle</EM> is
an object that a program uses to read or write an open file, or open
network socket, or a variety of other devices.  It is represented
by an integer, and you may be familiar with <CODE>stdin</CODE>,
<CODE>stdout</CODE>, and <CODE>stderr</CODE> which are descriptors 0,
1, and 2 respectively.
Apache needs a descriptor for each log file, plus one for each
network socket that it listens on, plus a handful of others.  Libraries
that Apache uses may also require descriptors.  Normal programs don't
open up many descriptors at all, and so there are some latent problems
that you may experience should you start running Apache with many
descriptors (<EM>i.e.</EM>, with many virtual hosts).

<P>The operating system enforces a limit on the number of descriptors
that a program can have open at a time.  There are typically three limits
involved here.  One is a kernel limitation, depending on your operating
system you will either be able to tune the number of descriptors available
to higher numbers (this is frequently called <EM>FD_SETSIZE</EM>).  Or you
may be stuck with a (relatively) low amount.  The second limit is called
the <EM>hard resource</EM> limit, and it is sometimes set by root in an
obscure operating system file, but frequently is the same as the kernel
limit.  The third limit is called the <EM>soft
resource</EM> limit.  The soft limit is always less than or equal to
the hard limit.  For example, the hard limit may be 1024, but the soft
limit only 64.  Any user can raise their soft limit up to the hard limit.
Root can raise the hard limit up to the system maximum limit.  The soft
limit is the actual limit that is used when enforcing the maximum number
of files a process can have open.
d4 50
a53 1
<P>To summarize:
d55 4
a58 1
<CENTER><PRE>
d60 2
a61 134
</PRE></CENTER>

<P>You control the hard and soft limits using the <CODE>limit</CODE> (csh)
or <CODE>ulimit</CODE> (sh) directives.  See the respective man pages
for more information.  For example you can probably use
<CODE>ulimit -n unlimited</CODE> to raise your soft limit up to the
hard limit.  You should include this command in a shell script which
starts your webserver.

<P>Unfortunately, it's not always this simple.  As mentioned above,
you will probably run into some system limitations that will need to be
worked around somehow.  Work was done in version 1.2.1 to improve the
situation somewhat.  Here is a partial list of systems and workarounds
(assuming you are using 1.2.1 or later):

<DL>

    <DT><STRONG>BSDI 2.0</STRONG>
    <DD>Under BSDI 2.0 you can build Apache to support more descriptors
        by adding <CODE>-DFD_SETSIZE=nnn</CODE> to
        <CODE>EXTRA_CFLAGS</CODE> (where nnn is the number of descriptors
        you wish to support, keep it less than the hard limit).  But it
        will run into trouble if more than approximately 240 Listen
        directives are used.  This may be cured by rebuilding your kernel
        with a higher FD_SETSIZE.
    <P>

    <DT><STRONG>FreeBSD 2.2, BSDI 2.1+</STRONG>
    <DD>Similar to the BSDI 2.0 case, you should define
        <CODE>FD_SETSIZE</CODE> and rebuild.  But the extra
        Listen limitation doesn't exist.
    <P>

    <DT><STRONG>Linux</STRONG>
    <DD>By default Linux has a kernel maximum of 256 open descriptors
        per process.  There are several patches available for the
        2.0.x series which raise this to 1024 and beyond, and you
        can find them in the "unofficial patches" section of <A
        HREF="http://www.linuxhq.com/">the Linux Information HQ</A>.
        None of these patches are perfect, and an entirely different
        approach is likely to be taken during the 2.1.x development.
        Applying these patches will raise the FD_SETSIZE used to compile
        all programs, and unless you rebuild all your libraries you should
        avoid running any other program with a soft descriptor limit above
        256.  As of this writing the patches available for increasing
        the number of descriptors do not take this into account.  On a
        dedicated webserver you probably won't run into trouble.
    <P>

    <DT><STRONG>Solaris through 2.5.1</STRONG>
    <DD>Solaris has a kernel hard limit of 1024 (may be lower in earlier
        versions).  But it has a limitation that files using
        the stdio library cannot have a descriptor above 255.
        Apache uses the stdio library for the ErrorLog directive.
        When you have more than approximately 110 virtual hosts
        (with an error log and an access log each) you will need to
        build Apache with <CODE>-DHIGH_SLACK_LINE=256</CODE> added to
        <CODE>EXTRA_CFLAGS</CODE>.  You will be limited to approximately
        240 error logs if you do this.
    <P>

    <DT><STRONG>AIX</STRONG>
    <DD>AIX version 3.2?? appears to have a hard limit of 128 descriptors.
	End of story.  Version 4.1.5 has a hard limit of 2000.
    <P>

    <DT><STRONG>SCO OpenServer</STRONG> 
    <DD>Edit the
    <CODE>/etc/conf/cf.d/stune</CODE> file or use 
    <CODE>/etc/conf/cf.d/configure</CODE> choice 7
    (User and Group configuration) and modify the <CODE>NOFILES</CODE> kernel
    parameter to a suitably higher value.  SCO recommends a number
    between 60 and 11000, the default is 110.  Relink and reboot, 
    and the new number of descriptors will be available.

    <P>

    <DT><STRONG>Compaq Tru64 UNIX/Digital UNIX/OSF</STRONG>
    <DD><OL>
    <LI>Raise <code>open_max_soft</code> and <code>open_max_hard</code>
        to 4096 in the proc subsystem.
        Do a man on sysconfig, sysconfigdb, and sysconfigtab.
    <LI>Raise <code>max-vnodes</code> to a large number which is greater 
        than the number of apache processes * 4096
        (Setting it to 250,000 should be good for most people).
        Do a man on sysconfig, sysconfigdb, and sysconfigtab.
    <LI>If you are using Tru64 5.0, 5.0A, or 5.1, define 
        <code>NO_SLACK</code> to work around a bug in the OS.
        <code>CFLAGS="-DNO_SLACK" ./configure</code>
    </OL>

    <P>

    <DT><STRONG>Others</STRONG>
    <DD>If you have details on another operating system, please submit
        it through our <A HREF="http://www.apache.org/bug_report.html">Bug
        Report Page</A>.
    <P>

</DL>

<P>In addition to the problems described above there are problems with
many libraries that Apache uses.  The most common example is the bind
DNS resolver library that is used by pretty much every unix, which
fails if it ends up with a descriptor above 256.  We suspect there
are other libraries that similar limitations.  So the code as of 1.2.1
takes a defensive stance and tries to save descriptors less than 16
for use while processing each request.  This is called the <EM>low
slack line</EM>.

<P>Note that this shouldn't waste descriptors.  If you really are pushing
the limits and Apache can't get a descriptor above 16 when it wants
it, it will settle for one below 16.

<P>In extreme situations you may want to lower the low slack line,
but you shouldn't ever need to.  For example, lowering it can
increase the limits 240 described above under Solaris and BSDI 2.0.
But you'll play a delicate balancing game with the descriptors needed
to serve a request.  Should you want to play this game, the compile
time parameter is <CODE>LOW_SLACK_LINE</CODE> and there's a tiny
bit of documentation in the header file <CODE>httpd.h</CODE>.

<P>Finally, if you suspect that all this slack stuff is causing you
problems, you can disable it.  Add <CODE>-DNO_SLACK</CODE> to
<CODE>EXTRA_CFLAGS</CODE> and rebuild.  But please report it to
our <A HREF="http://www.apache.org/bug_report.html">Bug
Report Page</A> so that
we can investigate.

<HR>

<H3 ALIGN="CENTER">
 Apache HTTP Server Version 1.3
</H3>
d63 144
a206 2
<A HREF="./"><IMG SRC="../images/index.gif" ALT="Index"></A>
<A HREF="../"><IMG SRC="../images/home.gif" ALT="Home"></A>
a207 2
</BODY>
</HTML>
@


1.2
log
@apache 1.3.14 + mod_ssl 2.7.1 merge
@
text
@d132 17
@


1.1
log
@Initial revision
@
text
@d18 1
a18 1
  Apache HTTP Server Version 1.2
d24 1
a24 1
<p>A <EM>descriptor</EM>, also commonly called a <EM>file handle</EM> is
d27 2
a28 2
by an integer, and you may be familiar with <code>stdin</code>,
<code>stdout</code>, and <code>stderr</code> which are descriptors 0,
d35 1
a35 1
descriptors (i.e. with many virtual hosts).
d37 1
a37 1
<p>The operating system enforces a limit on the number of descriptors
d53 1
a53 1
<p>To summarize:
d55 1
a55 1
<center><pre>
d57 1
a57 1
</pre></center>
d59 2
a60 2
<p>You control the hard and soft limits using the <code>limit</code> (csh)
or <code>ulimit</code> (sh) directives.  See the respective man pages
d62 1
a62 1
<code>ulimit -n unlimited</code> to raise your soft limit up to the
d66 1
a66 1
<p>Unfortunately, it's not always this simple.  As mentioned above,
d72 1
a72 1
<dl>
d74 4
a77 4
    <dt><STRONG>BSDI 2.0</STRONG>
    <dd>Under BSDI 2.0 you can build Apache to support more descriptors
        by adding <code>-DFD_SETSIZE=nnn</code> to
        <code>EXTRA_CFLAGS</code> (where nnn is the number of descriptors
d82 1
a82 1
    <p>
d84 3
a86 3
    <dt><STRONG>FreeBSD 2.2, BSDI 2.1+</STRONG>
    <dd>Similar to the BSDI 2.0 case, you should define
        <code>FD_SETSIZE</code> and rebuild.  But the extra
d88 1
a88 1
    <p>
d90 2
a91 2
    <dt><STRONG>Linux</STRONG>
    <dd>By default Linux has a kernel maximum of 256 open descriptors
d94 2
a95 2
        can find them in the "unofficial patches" section of <a
        href="http://www.linuxhq.com/">the Linux Information HQ</a>.
d104 1
a104 1
    <p>
d106 2
a107 2
    <dt><STRONG>Solaris through 2.5.1</STRONG>
    <dd>Solaris has a kernel hard limit of 1024 (may be lower in earlier
d113 2
a114 2
        build Apache with <code>-DHIGH_SLACK_LINE=256</code> added to
        <code>EXTRA_CFLAGS</code>.  You will be limited to approximately
d116 1
a116 1
    <p>
d118 2
a119 2
    <dt><STRONG>AIX</STRONG>
    <dd>AIX version 3.2?? appears to have a hard limit of 128 descriptors.
d121 1
a121 1
    <p>
d123 15
a137 5
    <dt><STRONG>Others</STRONG>
    <dd>If you have details on another operating system, please submit
        it through our <a href="http://www.apache.org/bug_report.html">Bug
        Report Page</a>.
    <p>
d139 1
a139 1
</dl>
d141 1
a141 1
<p>In addition to the problems described above there are problems with
d150 1
a150 1
<p>Note that this shouldn't waste descriptors.  If you really are pushing
d154 1
a154 1
<p>In extreme situations you may want to lower the low slack line,
d159 2
a160 2
time parameter is <code>LOW_SLACK_LINE</code> and there's a tiny
bit of documentation in the header file <code>httpd.h</code>.
d162 5
a166 5
<p>Finally, if you suspect that all this slack stuff is causing you
problems, you can disable it.  Add <code>-DNO_SLACK</code> to
<code>EXTRA_CFLAGS</code> and rebuild.  But please report it to
our <a href="http://www.apache.org/bug_report.html">Bug
Report Page</a> so that
d170 1
d172 1
a172 1
 Apache HTTP Server Version 1.2
@


1.1.1.1
log
@Initial import from apache 1.2.6
@
text
@@


1.1.1.2
log
@Apache 1.3.2
@
text
@d18 1
a18 1
  Apache HTTP Server Version 1.3
d24 1
a24 1
<P>A <EM>descriptor</EM>, also commonly called a <EM>file handle</EM> is
d27 2
a28 2
by an integer, and you may be familiar with <CODE>stdin</CODE>,
<CODE>stdout</CODE>, and <CODE>stderr</CODE> which are descriptors 0,
d35 1
a35 1
descriptors (<EM>i.e.</EM>, with many virtual hosts).
d37 1
a37 1
<P>The operating system enforces a limit on the number of descriptors
d53 1
a53 1
<P>To summarize:
d55 1
a55 1
<CENTER><PRE>
d57 1
a57 1
</PRE></CENTER>
d59 2
a60 2
<P>You control the hard and soft limits using the <CODE>limit</CODE> (csh)
or <CODE>ulimit</CODE> (sh) directives.  See the respective man pages
d62 1
a62 1
<CODE>ulimit -n unlimited</CODE> to raise your soft limit up to the
d66 1
a66 1
<P>Unfortunately, it's not always this simple.  As mentioned above,
d72 1
a72 1
<DL>
d74 4
a77 4
    <DT><STRONG>BSDI 2.0</STRONG>
    <DD>Under BSDI 2.0 you can build Apache to support more descriptors
        by adding <CODE>-DFD_SETSIZE=nnn</CODE> to
        <CODE>EXTRA_CFLAGS</CODE> (where nnn is the number of descriptors
d82 1
a82 1
    <P>
d84 3
a86 3
    <DT><STRONG>FreeBSD 2.2, BSDI 2.1+</STRONG>
    <DD>Similar to the BSDI 2.0 case, you should define
        <CODE>FD_SETSIZE</CODE> and rebuild.  But the extra
d88 1
a88 1
    <P>
d90 2
a91 2
    <DT><STRONG>Linux</STRONG>
    <DD>By default Linux has a kernel maximum of 256 open descriptors
d94 2
a95 2
        can find them in the "unofficial patches" section of <A
        HREF="http://www.linuxhq.com/">the Linux Information HQ</A>.
d104 1
a104 1
    <P>
d106 2
a107 2
    <DT><STRONG>Solaris through 2.5.1</STRONG>
    <DD>Solaris has a kernel hard limit of 1024 (may be lower in earlier
d113 2
a114 2
        build Apache with <CODE>-DHIGH_SLACK_LINE=256</CODE> added to
        <CODE>EXTRA_CFLAGS</CODE>.  You will be limited to approximately
d116 1
a116 1
    <P>
d118 2
a119 2
    <DT><STRONG>AIX</STRONG>
    <DD>AIX version 3.2?? appears to have a hard limit of 128 descriptors.
d121 1
a121 1
    <P>
d123 5
a127 5
    <DT><STRONG>Others</STRONG>
    <DD>If you have details on another operating system, please submit
        it through our <A HREF="http://www.apache.org/bug_report.html">Bug
        Report Page</A>.
    <P>
d129 1
a129 1
</DL>
d131 1
a131 1
<P>In addition to the problems described above there are problems with
d140 1
a140 1
<P>Note that this shouldn't waste descriptors.  If you really are pushing
d144 1
a144 1
<P>In extreme situations you may want to lower the low slack line,
d149 2
a150 2
time parameter is <CODE>LOW_SLACK_LINE</CODE> and there's a tiny
bit of documentation in the header file <CODE>httpd.h</CODE>.
d152 5
a156 5
<P>Finally, if you suspect that all this slack stuff is causing you
problems, you can disable it.  Add <CODE>-DNO_SLACK</CODE> to
<CODE>EXTRA_CFLAGS</CODE> and rebuild.  But please report it to
our <A HREF="http://www.apache.org/bug_report.html">Bug
Report Page</A> so that
a159 1

d161 1
a161 1
 Apache HTTP Server Version 1.3
@


1.1.1.3
log
@import apache 1.3.26 + mod_ssl 2.8.10
@
text
@d1 51
a51 2
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
d53 1
a53 50
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta name="generator" content="HTML Tidy, see www.w3.org" />

    <title>Descriptors and Apache</title>
  </head>
  <!-- Background white, links blue (unvisited), navy (visited), red (active) -->

  <body bgcolor="#FFFFFF" text="#000000" link="#0000FF"
  vlink="#000080" alink="#FF0000">
        <div align="CENTER">
      <img src="../images/sub.gif" alt="[APACHE DOCUMENTATION]" /> 

      <h3>Apache HTTP Server Version 1.3</h3>
    </div>


    <h1 align="CENTER">Descriptors and Apache</h1>

    <p>A <em>descriptor</em>, also commonly called a <em>file
    handle</em> is an object that a program uses to read or write
    an open file, or open network socket, or a variety of other
    devices. It is represented by an integer, and you may be
    familiar with <code>stdin</code>, <code>stdout</code>, and
    <code>stderr</code> which are descriptors 0, 1, and 2
    respectively. Apache needs a descriptor for each log file, plus
    one for each network socket that it listens on, plus a handful
    of others. Libraries that Apache uses may also require
    descriptors. Normal programs don't open up many descriptors at
    all, and so there are some latent problems that you may
    experience should you start running Apache with many
    descriptors (<em>i.e.</em>, with many virtual hosts).</p>

    <p>The operating system enforces a limit on the number of
    descriptors that a program can have open at a time. There are
    typically three limits involved here. One is a kernel
    limitation, depending on your operating system you will either
    be able to tune the number of descriptors available to higher
    numbers (this is frequently called <em>FD_SETSIZE</em>). Or you
    may be stuck with a (relatively) low amount. The second limit
    is called the <em>hard resource</em> limit, and it is sometimes
    set by root in an obscure operating system file, but frequently
    is the same as the kernel limit. The third limit is called the
    <em>soft resource</em> limit. The soft limit is always less
    than or equal to the hard limit. For example, the hard limit
    may be 1024, but the soft limit only 64. Any user can raise
    their soft limit up to the hard limit. Root can raise the hard
    limit up to the system maximum limit. The soft limit is the
    actual limit that is used when enforcing the maximum number of
    files a process can have open.</p>
d55 3
a57 1
    <p>To summarize:</p>
d59 105
a163 5
    <center>
<pre>
  #open files  &lt;=  soft limit  &lt;=  hard limit  &lt;=  kernel limit
</pre>
    </center>
d165 2
a166 144
    <p>You control the hard and soft limits using the
    <code>limit</code> (csh) or <code>ulimit</code> (sh)
    directives. See the respective man pages for more information.
    For example you can probably use <code>ulimit -n
    unlimited</code> to raise your soft limit up to the hard limit.
    You should include this command in a shell script which starts
    your webserver.</p>

    <p>Unfortunately, it's not always this simple. As mentioned
    above, you will probably run into some system limitations that
    will need to be worked around somehow. Work was done in version
    1.2.1 to improve the situation somewhat. Here is a partial list
    of systems and workarounds (assuming you are using 1.2.1 or
    later):</p>

    <dl>
      <dt><strong>BSDI 2.0</strong></dt>

      <dd>Under BSDI 2.0 you can build Apache to support more
      descriptors by adding <code>-DFD_SETSIZE=nnn</code> to
      <code>EXTRA_CFLAGS</code> (where nnn is the number of
      descriptors you wish to support, keep it less than the hard
      limit). But it will run into trouble if more than
      approximately 240 Listen directives are used. This may be
      cured by rebuilding your kernel with a higher
      FD_SETSIZE.</dd>

      <dt><strong>FreeBSD 2.2, BSDI 2.1+</strong></dt>

      <dd>Similar to the BSDI 2.0 case, you should define
      <code>FD_SETSIZE</code> and rebuild. But the extra Listen
      limitation doesn't exist.</dd>

      <dt><strong>Linux</strong></dt>

      <dd>By default Linux has a kernel maximum of 256 open
      descriptors per process. There are several patches available
      for the 2.0.x series which raise this to 1024 and beyond, and
      you can find them in the "unofficial patches" section of <a
      href="http://www.linuxhq.com/">the Linux Information HQ</a>.
      None of these patches are perfect, and an entirely different
      approach is likely to be taken during the 2.1.x development.
      Applying these patches will raise the FD_SETSIZE used to
      compile all programs, and unless you rebuild all your
      libraries you should avoid running any other program with a
      soft descriptor limit above 256. As of this writing the
      patches available for increasing the number of descriptors do
      not take this into account. On a dedicated webserver you
      probably won't run into trouble.</dd>

      <dt><strong>Solaris through 2.5.1</strong></dt>

      <dd>Solaris has a kernel hard limit of 1024 (may be lower in
      earlier versions). But it has a limitation that files using
      the stdio library cannot have a descriptor above 255. Apache
      uses the stdio library for the ErrorLog directive. When you
      have more than approximately 110 virtual hosts (with an error
      log and an access log each) you will need to build Apache
      with <code>-DHIGH_SLACK_LINE=256</code> added to
      <code>EXTRA_CFLAGS</code>. You will be limited to
      approximately 240 error logs if you do this.</dd>

      <dt><strong>AIX</strong></dt>

      <dd>AIX version 3.2?? appears to have a hard limit of 128
      descriptors. End of story. Version 4.1.5 has a hard limit of
      2000.</dd>

      <dt><strong>SCO OpenServer</strong></dt>

      <dd>Edit the <code>/etc/conf/cf.d/stune</code> file or use
      <code>/etc/conf/cf.d/configure</code> choice 7 (User and
      Group configuration) and modify the <code>NOFILES</code>
      kernel parameter to a suitably higher value. SCO recommends a
      number between 60 and 11000, the default is 110. Relink and
      reboot, and the new number of descriptors will be
      available.</dd>

      <dt><strong>Compaq Tru64 UNIX/Digital UNIX/OSF</strong></dt>

      <dd>
        <ol>
          <li>Raise <code>open_max_soft</code> and
          <code>open_max_hard</code> to 4096 in the proc subsystem.
          Do a man on sysconfig, sysconfigdb, and
          sysconfigtab.</li>

          <li>Raise <code>max-vnodes</code> to a large number which
          is greater than the number of apache processes * 4096
          (Setting it to 250,000 should be good for most people).
          Do a man on sysconfig, sysconfigdb, and
          sysconfigtab.</li>

          <li>If you are using Tru64 5.0, 5.0A, or 5.1, define
          <code>NO_SLACK</code> to work around a bug in the OS.
          <code>CFLAGS="-DNO_SLACK" ./configure</code></li>
        </ol>
      </dd>

      <dt><strong>Others</strong></dt>

      <dd>If you have details on another operating system, please
      submit it through our <a
      href="http://httpd.apache.org/bug_report.html">Bug Report
      Page</a>.</dd>
    </dl>

    <p>In addition to the problems described above there are
    problems with many libraries that Apache uses. The most common
    example is the bind DNS resolver library that is used by pretty
    much every unix, which fails if it ends up with a descriptor
    above 256. We suspect there are other libraries that similar
    limitations. So the code as of 1.2.1 takes a defensive stance
    and tries to save descriptors less than 16 for use while
    processing each request. This is called the <em>low slack
    line</em>.</p>

    <p>Note that this shouldn't waste descriptors. If you really
    are pushing the limits and Apache can't get a descriptor above
    16 when it wants it, it will settle for one below 16.</p>

    <p>In extreme situations you may want to lower the low slack
    line, but you shouldn't ever need to. For example, lowering it
    can increase the limits 240 described above under Solaris and
    BSDI 2.0. But you'll play a delicate balancing game with the
    descriptors needed to serve a request. Should you want to play
    this game, the compile time parameter is
    <code>LOW_SLACK_LINE</code> and there's a tiny bit of
    documentation in the header file <code>httpd.h</code>.</p>

    <p>Finally, if you suspect that all this slack stuff is causing
    you problems, you can disable it. Add <code>-DNO_SLACK</code>
    to <code>EXTRA_CFLAGS</code> and rebuild. But please report it
    to our <a href="http://httpd.apache.org/bug_report.html">Bug
    Report Page</a> so that we can investigate. 
        <hr />

    <h3 align="CENTER">Apache HTTP Server Version 1.3</h3>
    <a href="./"><img src="../images/index.gif" alt="Index" /></a>
    <a href="../"><img src="../images/home.gif" alt="Home" /></a>

    </p>
  </body>
</html>
d168 2
@


1.1.1.4
log
@import apache 1.3.28 and mod_ssl 2.8.15
@
text
@d129 1
a129 12
      2000.  Version 4.3.3 and 5.1 say
      <pre>
/*
 * Select uses bit masks of file descriptors.
 * These macros manipulate such bit fields.
 * FD_SETSIZE may be defined by the user to the maximum valued file
 * descriptor to be selected; the default here should be == OPEN_MAX
 */
#ifndef FD_SETSIZE
#define FD_SETSIZE     32767    /* must be == OPEN_MAX in <limits.h> */
#endif
</pre></dd>
@


