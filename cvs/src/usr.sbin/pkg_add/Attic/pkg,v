head	1.20;
access;
symbols
	OPENBSD_5_1_BASE:1.19
	OPENBSD_5_1:1.19.0.6
	OPENBSD_5_0:1.19.0.4
	OPENBSD_5_0_BASE:1.19
	OPENBSD_4_9:1.19.0.2
	OPENBSD_4_9_BASE:1.19
	OPENBSD_4_8:1.18.0.2
	OPENBSD_4_8_BASE:1.18
	OPENBSD_4_7:1.11.0.2
	OPENBSD_4_7_BASE:1.11
	OPENBSD_4_6:1.10.0.4
	OPENBSD_4_6_BASE:1.10
	OPENBSD_4_5:1.9.0.8
	OPENBSD_4_5_BASE:1.9
	OPENBSD_4_4:1.9.0.6
	OPENBSD_4_4_BASE:1.9
	OPENBSD_4_3:1.9.0.4
	OPENBSD_4_3_BASE:1.9
	OPENBSD_4_2:1.9.0.2
	OPENBSD_4_2_BASE:1.9
	OPENBSD_4_1:1.3.0.10
	OPENBSD_4_1_BASE:1.3
	OPENBSD_4_0:1.3.0.8
	OPENBSD_4_0_BASE:1.3
	OPENBSD_3_9:1.3.0.6
	OPENBSD_3_9_BASE:1.3
	OPENBSD_3_8:1.3.0.4
	OPENBSD_3_8_BASE:1.3
	OPENBSD_3_7:1.3.0.2
	OPENBSD_3_7_BASE:1.3
	OPENBSD_3_6:1.2.0.2
	OPENBSD_3_6_BASE:1.2
	OPENBSD_3_5:1.1.1.1.0.2
	OPENBSD_3_5_BASE:1.1.1.1
	pkgtools:1.1.1.1
	espie:1.1.1;
locks; strict;
comment	@# @;


1.20
date	2012.07.13.16.45.10;	author deraadt;	state dead;
branches;
next	1.19;

1.19
date	2010.12.05.09.41.55;	author espie;	state Exp;
branches;
next	1.18;

1.18
date	2010.06.10.23.39.50;	author espie;	state Exp;
branches;
next	1.17;

1.17
date	2010.06.09.07.26.01;	author espie;	state Exp;
branches;
next	1.16;

1.16
date	2010.06.05.17.15.32;	author espie;	state Exp;
branches;
next	1.15;

1.15
date	2010.06.05.13.56.06;	author espie;	state Exp;
branches;
next	1.14;

1.14
date	2010.06.05.12.30.36;	author espie;	state Exp;
branches;
next	1.13;

1.13
date	2010.06.04.13.19.39;	author espie;	state Exp;
branches;
next	1.12;

1.12
date	2010.05.10.09.17.54;	author espie;	state Exp;
branches;
next	1.11;

1.11
date	2009.11.10.11.36.56;	author espie;	state Exp;
branches;
next	1.10;

1.10
date	2009.04.19.14.58.32;	author espie;	state Exp;
branches;
next	1.9;

1.9
date	2007.06.12.09.53.36;	author espie;	state Exp;
branches;
next	1.8;

1.8
date	2007.05.14.11.02.14;	author espie;	state Exp;
branches;
next	1.7;

1.7
date	2007.05.14.10.53.31;	author espie;	state Exp;
branches;
next	1.6;

1.6
date	2007.05.14.10.43.45;	author espie;	state Exp;
branches;
next	1.5;

1.5
date	2007.05.14.10.27.46;	author espie;	state Exp;
branches;
next	1.4;

1.4
date	2007.05.12.14.48.45;	author espie;	state Exp;
branches;
next	1.3;

1.3
date	2004.10.11.09.44.06;	author espie;	state Exp;
branches;
next	1.2;

1.2
date	2004.08.06.07.51.17;	author espie;	state Exp;
branches;
next	1.1;

1.1
date	2003.10.16.17.43.34;	author espie;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2003.10.16.17.43.34;	author espie;	state Exp;
branches;
next	;


desc
@@


1.20
log
@do not install the pkg(1) front-end stub in /usr/sbin anymore, everyone
uses the '_' variants
ok espie
@
text
@#! /usr/bin/perl
# ex:ts=8 sw=4:
# $OpenBSD: pkg,v 1.19 2010/12/05 09:41:55 espie Exp $
#
# Copyright (c) 2010 Marc Espie <espie@@openbsd.org>
#
# Permission to use, copy, modify, and distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

use strict;
use warnings;

sub run
{
	my ($cmd, $name) = @@_;
	my $module = "OpenBSD::Pkg\u$cmd";
	eval "require $module;";
	if ($@@) {
		die $@@;
	}
	exit($module->parse_and_run($name));
}
my @@l = qw(add check create delete info);

for my $i (@@l) {
	if ($0 =~ m/\/?pkg_$i$/) {
		run($i, "pkg_$i");
	}
}

if (@@ARGV) {
	for my $i (@@l) {
		if ($ARGV[0] eq $i) {
			shift;
			run($i, "pkg $i");
		}
	}
}
print STDERR "Usage: pkg [",join("|", @@l),"] [args]\n";
exit(1);
@


1.19
log
@tweak the framework so that individual modules don't exist and return
the exit code upstream instead.
this simplifies the task of people who want to reuse it, as noted by
landry@@
@
text
@d3 1
a3 1
# $OpenBSD: pkg,v 1.18 2010/06/10 23:39:50 espie Exp $
@


1.18
log
@remove warning, adapted from Vadim Zhukov
@
text
@d3 1
a3 1
# $OpenBSD: pkg,v 1.17 2010/06/09 07:26:01 espie Exp $
d30 1
a30 2
	$module->parse_and_run($name);
	exit(0);
@


1.17
log
@ui changes: go thru a state object for most printouts
@
text
@d3 1
a3 1
# $OpenBSD: pkg,v 1.16 2010/06/05 17:15:32 espie Exp $
d41 6
a46 4
for my $i (@@l) {
	if ($ARGV[0] eq $i) {
		shift;
		run($i, "pkg $i");
@


1.16
log
@move files after a discussion with Theo.
@
text
@d3 1
a3 1
# $OpenBSD: pkg,v 1.15 2010/06/05 13:56:06 espie Exp $
d24 1
a24 1
	my $cmd = shift;
d30 1
a30 1
	$module->parse_and_run;
d37 1
a37 1
		run($i);
d44 1
a44 1
		run($i);
@


1.15
log
@usage line and error out if pkg foo.
@
text
@d3 1
a3 1
# $OpenBSD: pkg,v 1.14 2010/06/05 12:30:36 espie Exp $
d33 1
a33 1
my @@l = qw(add create delete fsck info);
@


1.14
log
@new command pkg_fsck, very incomplete for now. Runs only very basic checks.
@
text
@d3 1
a3 1
# $OpenBSD: pkg,v 1.13 2010/06/04 13:19:39 espie Exp $
d47 2
@


1.13
log
@move code around, so that commands can be used as modules.
pkg becomes the start hub, which does nothing except require the
correct module.
Saner code wrt Add/Delete, and more sharing.
@
text
@d3 1
a3 1
# $OpenBSD$
d31 1
d33 1
a33 1
my @@l = qw(add create delete info);
@


1.12
log
@whitespace fixes
@
text
@d5 1
a5 1
# Copyright (c) 2003-2007 Marc Espie <espie@@openbsd.org>
d22 1
a22 3
use Getopt::Std;

sub check_dependencies($)
d24 7
a30 6
	require OpenBSD::Search;
	require OpenBSD::PackageRepository::Installed;
	my $dependency = shift;
	my $m = OpenBSD::PackageRepository::Installed->new
	    ->match_locations(OpenBSD::Search::PkgSpec->new($dependency));
	return (@@$m != 0) ? 1 : 0;
d32 1
d34 4
a37 5
# Pass this off to the old package commands
my %opts;
my %legacy = map +($_, 1), qw{add info delete create};
if (@@ARGV == 0) {
	die "needs arguments";
d40 4
a43 17
getopts('v', \%opts);

my $cmd = shift;

if (defined $legacy{$cmd}) {
	if (defined $opts{'v'}) {
		unshift(@@ARGV, '-v');
	}
	exec { "pkg_$cmd"} ("pkg_$cmd", @@ARGV);
} elsif ($cmd eq 'dependencies') {
	my $sub = shift;
	if ($sub eq 'check') {
		if (check_dependencies(shift)) {
			exit(0);
		} else {
			exit(1);
		}
a45 1
die "Bad command $cmd";
@


1.11
log
@bad espie: use strict/warnings consistently, and fix two nits and two
actual errors !
@
text
@@


1.10
log
@synch with my new style search/location changes
It's likely there will be some fallout, but it's getting a bit too large
to keep around.
This does kill a few very old oddities as well.
@
text
@d21 1
@


1.9
log
@tidy error messages: uses $! more consistently, do not append \n on die,
do append \n on warn.

Fix the two cases where the temp dir vanished too soon: not copying +DESC
should have been apparent. Not finding a +DISPLAY file is not a reason for
burping all over the place.
@
text
@d3 1
a3 1
# $OpenBSD: pkg,v 1.8 2007/05/14 11:02:14 espie Exp $
d28 3
a30 3
	my @@m = OpenBSD::PackageRepository::Installed->new
	    ->match(OpenBSD::Search::PkgSpec->new($dependency));
	return (@@m != 0) ? 1 : 0;
@


1.8
log
@put Search objects into their own file, finally
@
text
@d3 1
a3 1
# $OpenBSD: pkg,v 1.7 2007/05/14 10:53:31 espie Exp $
d37 1
a37 1
	die "needs arguments\n";
d59 1
a59 1
die "Bad command $cmd\n";
@


1.7
log
@put search objects into a search class.
@
text
@d3 1
a3 1
# $OpenBSD: pkg,v 1.6 2007/05/14 10:43:45 espie Exp $
d25 1
a25 1
	require OpenBSD::PkgSpec;
@


1.6
log
@name tweaks: match -> match_list, match_repo -> match
@
text
@d3 1
a3 1
# $OpenBSD: pkg,v 1.5 2007/05/14 10:27:46 espie Exp $
d29 1
a29 1
	    ->match(OpenBSD::PkgSpec->new($dependency));
@


1.5
log
@use Repository::Installed a bit more
@
text
@d3 1
a3 1
# $OpenBSD: pkg,v 1.4 2007/05/12 14:48:45 espie Exp $
d28 2
a29 2
	my @@m = OpenBSD::PkgSpec->new($dependency)
	    ->match_repo(OpenBSD::PackageRepository::Installed->new);
@


1.4
log
@use PkgSpec objects most of the time
@
text
@d3 1
a3 1
# $OpenBSD: pkg,v 1.3 2004/10/11 09:44:06 espie Exp $
d26 1
a26 1
	require OpenBSD::PackageInfo;
d28 2
a29 1
	my @@m = OpenBSD::PkgSpec->new($dependency)->match(OpenBSD::PackageInfo::installed_packages());
@


1.3
log
@split PackageName handling into PackageName stuff/PkgSpec matching.
Kill new method that isn't really used.

Name explicit splitstem() to get the stem of a packagename.

Adjust calls to the interface.
@
text
@d3 1
a3 1
# $OpenBSD: pkg,v 1.2 2004/08/06 07:51:17 espie Exp $
d5 1
a5 1
# Copyright (c) 2003-2004 Marc Espie <espie@@openbsd.org>
d25 2
a26 4
	eval { 
		require OpenBSD::PkgSpec;
		require OpenBSD::PackageInfo;
	};
d28 1
a28 2
	my @@m = OpenBSD::PkgSpec::match($dependency, 
	    OpenBSD::PackageInfo::installed_packages());
@


1.2
log
@unified headers, switch to smaller copyright notice.
@
text
@d3 1
a3 1
# $OpenBSD: pkg,v 1.1.1.1 2003/10/16 17:43:34 espie Exp $
d26 1
a26 1
		require OpenBSD::PackageName;
d30 1
a30 1
	my @@m = OpenBSD::PackageName::pkgspec_match($dependency, 
@


1.1
log
@Initial revision
@
text
@d3 1
a3 1
# $OpenBSD: pkg,v 1.1.1.1 2003/10/16 17:16:30 espie Exp $
d5 13
a17 22
# Copyright (c) 2003 Marc Espie.
# 
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 
# THIS SOFTWARE IS PROVIDED BY THE OPENBSD PROJECT AND CONTRIBUTORS
# ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
# A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OPENBSD
# PROJECT OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
# SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
# LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
@


1.1.1.1
log
@new import of my pkgtools, after a slight naming disagreement with the
Upper Management...
@
text
@@
