head	1.13;
access;
symbols
	OPENBSD_6_1:1.13.0.32
	OPENBSD_6_1_BASE:1.13
	OPENBSD_6_0:1.13.0.30
	OPENBSD_6_0_BASE:1.13
	OPENBSD_5_9:1.13.0.26
	OPENBSD_5_9_BASE:1.13
	OPENBSD_5_8:1.13.0.28
	OPENBSD_5_8_BASE:1.13
	OPENBSD_5_7:1.13.0.20
	OPENBSD_5_7_BASE:1.13
	OPENBSD_5_6:1.13.0.24
	OPENBSD_5_6_BASE:1.13
	OPENBSD_5_5:1.13.0.22
	OPENBSD_5_5_BASE:1.13
	OPENBSD_5_4:1.13.0.18
	OPENBSD_5_4_BASE:1.13
	OPENBSD_5_3:1.13.0.16
	OPENBSD_5_3_BASE:1.13
	OPENBSD_5_2:1.13.0.14
	OPENBSD_5_2_BASE:1.13
	OPENBSD_5_1_BASE:1.13
	OPENBSD_5_1:1.13.0.12
	OPENBSD_5_0:1.13.0.10
	OPENBSD_5_0_BASE:1.13
	OPENBSD_4_9:1.13.0.8
	OPENBSD_4_9_BASE:1.13
	OPENBSD_4_8:1.13.0.6
	OPENBSD_4_8_BASE:1.13
	OPENBSD_4_7:1.13.0.2
	OPENBSD_4_7_BASE:1.13
	OPENBSD_4_6:1.13.0.4
	OPENBSD_4_6_BASE:1.13
	OPENBSD_4_5:1.12.0.8
	OPENBSD_4_5_BASE:1.12
	OPENBSD_4_4:1.12.0.6
	OPENBSD_4_4_BASE:1.12
	OPENBSD_4_3:1.12.0.4
	OPENBSD_4_3_BASE:1.12
	OPENBSD_4_2:1.12.0.2
	OPENBSD_4_2_BASE:1.12
	OPENBSD_4_1:1.11.0.10
	OPENBSD_4_1_BASE:1.11
	OPENBSD_4_0:1.11.0.8
	OPENBSD_4_0_BASE:1.11
	OPENBSD_3_9:1.11.0.6
	OPENBSD_3_9_BASE:1.11
	OPENBSD_3_8:1.11.0.4
	OPENBSD_3_8_BASE:1.11
	OPENBSD_3_7:1.11.0.2
	OPENBSD_3_7_BASE:1.11
	OPENBSD_3_6:1.8.0.2
	OPENBSD_3_6_BASE:1.8;
locks; strict;
comment	@ * @;


1.13
date	2009.04.22.07.42.17;	author henning;	state Exp;
branches;
next	1.12;

1.12
date	2007.05.26.21.20.35;	author henning;	state Exp;
branches;
next	1.11;

1.11
date	2004.12.13.12.22.52;	author dtucker;	state Exp;
branches;
next	1.10;

1.10
date	2004.12.08.15.47.38;	author mickey;	state Exp;
branches;
next	1.9;

1.9
date	2004.10.13.13.35.19;	author henning;	state Exp;
branches;
next	1.8;

1.8
date	2004.07.10.22.04.22;	author alexander;	state Exp;
branches;
next	1.7;

1.7
date	2004.07.04.22.24.20;	author henning;	state Exp;
branches;
next	1.6;

1.6
date	2004.07.04.11.01.49;	author alexander;	state Exp;
branches;
next	1.5;

1.5
date	2004.06.17.19.17.48;	author henning;	state Exp;
branches;
next	1.4;

1.4
date	2004.06.05.12.29.15;	author alexander;	state Exp;
branches;
next	1.3;

1.3
date	2004.06.02.10.08.59;	author henning;	state Exp;
branches;
next	1.2;

1.2
date	2004.06.01.22.02.32;	author henning;	state Exp;
branches;
next	1.1;

1.1
date	2004.05.31.13.46.16;	author henning;	state Exp;
branches;
next	;


desc
@@


1.13
log
@ignore replies with timestamps after 2030 to prevent time_t / tv_sec wraps
input & ok theo
@
text
@/*	$OpenBSD: ntp.h,v 1.12 2007/05/26 21:20:35 henning Exp $ */

/*
 * Copyright (c) 2004 Henning Brauer <henning@@openbsd.org>
 * Copyright (c) 2004 Alexander Guy <alexander.guy@@andern.org>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#ifndef _NTP_H_
#define _NTP_H_

/* Style borrowed from NTP ref/tcpdump and updated for SNTPv4 (RFC2030). */

/*
 * RFC Section 3
 *
 *    0			  1		      2			  3
 *    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 *   |			       Integer Part			     |
 *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 *   |			       Fraction Part			     |
 *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 *
 *    0			  1		      2			  3
 *    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 *   |		  Integer Part	     |	   Fraction Part	     |
 *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
*/
struct l_fixedpt {
	u_int32_t int_partl;
	u_int32_t fractionl;
};

struct s_fixedpt {
	u_int16_t int_parts;
	u_int16_t fractions;
};

/* RFC Section 4
 *
 *    0			  1		      2			  3
 *    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 *   |LI | VN  | Mode|	  Stratum    |	    Poll     |	 Precision   |
 *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 *   |			   Synchronizing Distance		     |
 *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 *   |			  Synchronizing Dispersion		     |
 *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 *   |			Reference Clock Identifier		     |
 *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 *   |								     |
 *   |		       Reference Timestamp (64 bits)		     |
 *   |								     |
 *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 *   |								     |
 *   |		       Originate Timestamp (64 bits)		     |
 *   |								     |
 *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 *   |								     |
 *   |			Receive Timestamp (64 bits)		     |
 *   |								     |
 *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 *   |								     |
 *   |			Transmit Timestamp (64 bits)		     |
 *   |								     |
 *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 *   |                 Key Identifier (optional) (32)                |
 *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 *   |                                                               |
 *   |                                                               |
 *   |                 Message Digest (optional) (128)               |
 *   |                                                               |
 *   |                                                               |
 *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 *
 */

#define	NTP_DIGESTSIZE		16
#define	NTP_MSGSIZE_NOAUTH	48
#define	NTP_MSGSIZE		(NTP_MSGSIZE_NOAUTH + 4 + NTP_DIGESTSIZE)

struct ntp_msg {
	u_int8_t status;	/* status of local clock and leap info */
	u_int8_t stratum;	/* Stratum level */
	u_int8_t ppoll;		/* poll value */
	int8_t precision;
	struct s_fixedpt rootdelay;
	struct s_fixedpt dispersion;
	u_int32_t refid;
	struct l_fixedpt reftime;
	struct l_fixedpt orgtime;
	struct l_fixedpt rectime;
	struct l_fixedpt xmttime;
} __packed;

struct ntp_query {
	int			fd;
	struct ntp_msg		msg;
	double			xmttime;
};

/*
 *	Leap Second Codes (high order two bits)
 */
#define	LI_NOWARNING	(0 << 6)	/* no warning */
#define	LI_PLUSSEC	(1 << 6)	/* add a second (61 seconds) */
#define	LI_MINUSSEC	(2 << 6)	/* minus a second (59 seconds) */
#define	LI_ALARM	(3 << 6)	/* alarm condition */

/*
 *	Status Masks
 */
#define	MODEMASK	(7 << 0)
#define	VERSIONMASK	(7 << 3)
#define LIMASK		(3 << 6)

/*
 *	Mode values
 */
#define	MODE_RES0	0	/* reserved */
#define	MODE_SYM_ACT	1	/* symmetric active */
#define	MODE_SYM_PAS	2	/* symmetric passive */
#define	MODE_CLIENT	3	/* client */
#define	MODE_SERVER	4	/* server */
#define	MODE_BROADCAST	5	/* broadcast */
#define	MODE_RES1	6	/* reserved for NTP control message */
#define	MODE_RES2	7	/* reserved for private use */

#define	JAN_1970	2208988800UL	/* 1970 - 1900 in seconds */
#define	JAN_2030	1893456000UL + JAN_1970	/* 1. 1. 2030 00:00:00 */

#define	NTP_VERSION	4
#define	NTP_MAXSTRATUM	15

#endif	/* _NTP_H_ */
@


1.12
log
@use __packed structs for the on-the-wire packets and just memcpy at once
instead of kind-of manual copyin/out. increases accuracy in server mode.
collecting dust in my tree for some time, result of a conversation with
somebody i really want to give credit to, but I can't find the mails now :(
okey dokey sez theo
@
text
@d1 1
a1 1
/*	$OpenBSD: ntp.h,v 1.11 2004/12/13 12:22:52 dtucker Exp $ */
d144 1
@


1.11
log
@Discard replies with alarm flag set or invalid stratum; ok henning@@
@
text
@d1 1
a1 1
/*	$OpenBSD: ntp.h,v 1.10 2004/12/08 15:47:38 mickey Exp $ */
d108 1
a108 3
	u_int32_t keyid;
	u_int8_t digest[NTP_DIGESTSIZE];
};
@


1.10
log
@uniquely name members of s_fixedpt and l_fixedpt; henning@@ ok
@
text
@d1 1
a1 1
/*	$OpenBSD: ntp.h,v 1.9 2004/10/13 13:35:19 henning Exp $ */
d148 1
@


1.9
log
@in struct ntp_msg, rename "distance" to "rootdelay" to closer match RFCs
and such
@
text
@d1 1
a1 1
/*	$OpenBSD: ntp.h,v 1.8 2004/07/10 22:04:22 alexander Exp $ */
d43 2
a44 2
	u_int32_t int_part;
	u_int32_t fraction;
d48 2
a49 2
	u_int16_t int_part;
	u_int16_t fraction;
@


1.8
log
@correct leap indicator mask; ok henning@@
@
text
@d1 1
a1 1
/*	$OpenBSD: ntp.h,v 1.7 2004/07/04 22:24:20 henning Exp $ */
d101 1
a101 1
	struct s_fixedpt distance;
@


1.7
log
@put interval defines in ntpd.h and name them consistently
@
text
@d1 1
a1 1
/*	$OpenBSD: ntp.h,v 1.6 2004/07/04 11:01:49 alexander Exp $ */
d131 1
a131 1
#define LIMASK		(2 << 6)
@


1.6
log
@Compute the local clock offset from the server's response.
ok henning@@
@
text
@d1 1
a1 1
/*	$OpenBSD: ntp.h,v 1.5 2004/06/17 19:17:48 henning Exp $ */
a147 2
#define	MAX_QUERYTIME	30	/* max seconds a single query might take */
#define	QUERY_INTERVAL	60	/* sync with peers every n seconds */
@


1.5
log
@provide most of the client functionality.
hook the descriptors into the main poll and such.
we're not doing anything with the reply we recive yet, tho.

mostly hacked on the Frankfurt->Montreal flight, as batteries and those
horrible air canada seats permitted...
@
text
@d1 1
a1 1
/*	$OpenBSD: ntp.h,v 1.4 2004/06/05 12:29:15 alexander Exp $ */
d115 1
a115 1
	struct l_fixedpt	xmttime;
@


1.4
log
@Move prototype definitions.  Add multi-include protection to header.

ok henning@@
@
text
@d1 1
a1 1
/*	$OpenBSD: ntp.h,v 1.3 2004/06/02 10:08:59 henning Exp $ */
d112 6
d147 5
a151 1
#endif /* _NTP_H_ */
@


1.3
log
@prepare for client functionality
@
text
@d1 1
a1 1
/*	$OpenBSD: ntp.h,v 1.2 2004/06/01 22:02:32 henning Exp $ */
d20 3
d141 1
a141 10
/* prototypes */

/* ntp_msg.c */
void	get_ts(struct l_fixedpt *);
int	ntp_getmsg(char *, ssize_t, struct ntp_msg *);
int	ntp_sendmsg(int, struct sockaddr *, struct ntp_msg *, ssize_t, int);

/* server.c */
int	setup_listeners(struct servent *, struct ntpd_conf *);
int	ntp_reply(int, struct sockaddr *, struct ntp_msg *, int);
@


1.2
log
@$OpenBSD$
@
text
@d1 1
a1 1
/*	$OpenBSD$ */
d137 11
@


1.1
log
@initial cut at ntpd.
it is just capable of answering (s)ntp4 requests with the local time
for now.
imsg/buffer and logging framework from bgpd, ntp protocol hackery
with Alexander Guy
@
text
@d1 2
@

