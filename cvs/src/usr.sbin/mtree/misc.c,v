head	1.19;
access;
symbols
	OPENBSD_6_1:1.19.0.22
	OPENBSD_6_1_BASE:1.19
	OPENBSD_6_0:1.19.0.18
	OPENBSD_6_0_BASE:1.19
	OPENBSD_5_9:1.19.0.14
	OPENBSD_5_9_BASE:1.19
	OPENBSD_5_8:1.19.0.16
	OPENBSD_5_8_BASE:1.19
	OPENBSD_5_7:1.19.0.8
	OPENBSD_5_7_BASE:1.19
	OPENBSD_5_6:1.19.0.12
	OPENBSD_5_6_BASE:1.19
	OPENBSD_5_5:1.19.0.10
	OPENBSD_5_5_BASE:1.19
	OPENBSD_5_4:1.19.0.6
	OPENBSD_5_4_BASE:1.19
	OPENBSD_5_3:1.19.0.4
	OPENBSD_5_3_BASE:1.19
	OPENBSD_5_2:1.19.0.2
	OPENBSD_5_2_BASE:1.19
	OPENBSD_5_1_BASE:1.18
	OPENBSD_5_1:1.18.0.32
	OPENBSD_5_0:1.18.0.30
	OPENBSD_5_0_BASE:1.18
	OPENBSD_4_9:1.18.0.28
	OPENBSD_4_9_BASE:1.18
	OPENBSD_4_8:1.18.0.26
	OPENBSD_4_8_BASE:1.18
	OPENBSD_4_7:1.18.0.22
	OPENBSD_4_7_BASE:1.18
	OPENBSD_4_6:1.18.0.24
	OPENBSD_4_6_BASE:1.18
	OPENBSD_4_5:1.18.0.20
	OPENBSD_4_5_BASE:1.18
	OPENBSD_4_4:1.18.0.18
	OPENBSD_4_4_BASE:1.18
	OPENBSD_4_3:1.18.0.16
	OPENBSD_4_3_BASE:1.18
	OPENBSD_4_2:1.18.0.14
	OPENBSD_4_2_BASE:1.18
	OPENBSD_4_1:1.18.0.12
	OPENBSD_4_1_BASE:1.18
	OPENBSD_4_0:1.18.0.10
	OPENBSD_4_0_BASE:1.18
	OPENBSD_3_9:1.18.0.8
	OPENBSD_3_9_BASE:1.18
	OPENBSD_3_8:1.18.0.6
	OPENBSD_3_8_BASE:1.18
	OPENBSD_3_7:1.18.0.4
	OPENBSD_3_7_BASE:1.18
	OPENBSD_3_6:1.18.0.2
	OPENBSD_3_6_BASE:1.18
	OPENBSD_3_5:1.16.0.4
	OPENBSD_3_5_BASE:1.16
	OPENBSD_3_4:1.16.0.2
	OPENBSD_3_4_BASE:1.16
	OPENBSD_3_3:1.14.0.6
	OPENBSD_3_3_BASE:1.14
	OPENBSD_3_2:1.14.0.4
	OPENBSD_3_2_BASE:1.14
	OPENBSD_3_1:1.14.0.2
	OPENBSD_3_1_BASE:1.14
	OPENBSD_3_0:1.9.0.2
	OPENBSD_3_0_BASE:1.9
	OPENBSD_2_9_BASE:1.8
	OPENBSD_2_9:1.8.0.16
	OPENBSD_2_8:1.8.0.14
	OPENBSD_2_8_BASE:1.8
	OPENBSD_2_7:1.8.0.12
	OPENBSD_2_7_BASE:1.8
	OPENBSD_2_6:1.8.0.10
	OPENBSD_2_6_BASE:1.8
	OPENBSD_2_5:1.8.0.8
	OPENBSD_2_5_BASE:1.8
	OPENBSD_2_4:1.8.0.6
	OPENBSD_2_4_BASE:1.8
	OPENBSD_2_3:1.8.0.4
	OPENBSD_2_3_BASE:1.8
	OPENBSD_2_2:1.8.0.2
	OPENBSD_2_2_BASE:1.8
	OPENBSD_2_1:1.4.0.2
	OPENBSD_2_1_BASE:1.4
	OPENBSD_2_0:1.1.1.1.0.2
	OPENBSD_2_0_BASE:1.1.1.1
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@ * @;


1.19
date	2012.07.08.21.19.42;	author naddy;	state Exp;
branches;
next	1.18;

1.18
date	2004.08.01.18.32.20;	author deraadt;	state Exp;
branches;
next	1.17;

1.17
date	2004.05.02.17.55.53;	author millert;	state Exp;
branches;
next	1.16;

1.16
date	2003.06.26.19.47.09;	author deraadt;	state Exp;
branches;
next	1.15;

1.15
date	2003.06.02.23.36.54;	author millert;	state Exp;
branches;
next	1.14;

1.14
date	2002.04.04.07.33.23;	author millert;	state Exp;
branches;
next	1.13;

1.13
date	2002.03.09.18.54.19;	author millert;	state Exp;
branches;
next	1.12;

1.12
date	2002.03.04.19.56.39;	author millert;	state Exp;
branches;
next	1.11;

1.11
date	2002.02.19.19.39.40;	author millert;	state Exp;
branches;
next	1.10;

1.10
date	2002.02.16.21.28.05;	author millert;	state Exp;
branches;
next	1.9;

1.9
date	2001.08.10.02.33.46;	author millert;	state Exp;
branches;
next	1.8;

1.8
date	97.07.25.20.12.14;	author mickey;	state Exp;
branches;
next	1.7;

1.7
date	97.07.18.05.49.03;	author millert;	state Exp;
branches;
next	1.6;

1.6
date	97.07.18.05.46.12;	author millert;	state Exp;
branches;
next	1.5;

1.5
date	97.07.12.23.05.35;	author millert;	state Exp;
branches;
next	1.4;

1.4
date	96.12.20.18.13.42;	author millert;	state Exp;
branches;
next	1.3;

1.3
date	96.12.10.08.26.08;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	96.12.08.01.13.40;	author niklas;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.47.49;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.47.49;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.19
log
@Add support for the "sha256digest" keyword to create/compare
SHA-256 digests of files.  In the man page, also replace SHA-1
with SHA-256 in the examples section.

Man page formatting tweak and ok schwarze@@
@
text
@/*	$OpenBSD: misc.c,v 1.18 2004/08/01 18:32:20 deraadt Exp $	*/
/*	$NetBSD: misc.c,v 1.4 1995/03/07 21:26:23 cgd Exp $	*/

/*-
 * Copyright (c) 1991, 1993
 *	The Regents of the University of California.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 *	@@(#)misc.c	8.1 (Berkeley) 6/6/93
 */

#include <sys/types.h>
#include <sys/stat.h>
#include <stdio.h>
#include <stdarg.h>
#include "mtree.h"
#include "extern.h"

extern int lineno;

typedef struct _key {
	char *name;			/* key name */
	u_int val;			/* value */

#define	NEEDVALUE	0x01
	u_int flags;
} KEY;

/* NB: the following table must be sorted lexically. */
static KEY keylist[] = {
	{"cksum",	F_CKSUM,	NEEDVALUE},
	{"flags",	F_FLAGS,	NEEDVALUE},
	{"gid",		F_GID,		NEEDVALUE},
	{"gname",	F_GNAME,	NEEDVALUE},
	{"ignore",	F_IGN,		0},
	{"link",	F_SLINK,	NEEDVALUE},
	{"md5digest",	F_MD5,		NEEDVALUE},
	{"mode",	F_MODE,		NEEDVALUE},
	{"nlink",	F_NLINK,	NEEDVALUE},
	{"nochange",	F_NOCHANGE,	0},
	{"optional",	F_OPT,		0},
	{"rmd160digest",F_RMD160,	NEEDVALUE},
	{"sha1digest",	F_SHA1,		NEEDVALUE},
	{"sha256digest",F_SHA256,	NEEDVALUE},
	{"size",	F_SIZE,		NEEDVALUE},
	{"time",	F_TIME,		NEEDVALUE},
	{"type",	F_TYPE,		NEEDVALUE},
	{"uid",		F_UID,		NEEDVALUE},
	{"uname",	F_UNAME,	NEEDVALUE},
};

u_int
parsekey(char *name, int *needvaluep)
{
	KEY *k, tmp;
	int keycompare(const void *, const void *);

	tmp.name = name;
	k = (KEY *)bsearch(&tmp, keylist, sizeof(keylist) / sizeof(KEY),
	    sizeof(KEY), keycompare);
	if (k == NULL)
		error("unknown keyword %s", name);

	if (needvaluep)
		*needvaluep = k->flags & NEEDVALUE ? 1 : 0;
	return (k->val);
}

int
keycompare(const void *a, const void *b)
{
	return (strcmp(((KEY *)a)->name, ((KEY *)b)->name));
}

void
error(const char *fmt, ...)
{
	va_list ap;

	va_start(ap, fmt);
	(void)fflush(NULL);
	(void)fprintf(stderr, "\nmtree: ");
	(void)vfprintf(stderr, fmt, ap);
	va_end(ap);
	(void)fprintf(stderr, "\n");
	if (lineno)
		(void)fprintf(stderr,
		    "mtree: failed at line %d of the specification\n", lineno);
	exit(1);
	/* NOTREACHED */
}
@


1.18
log
@ansi cleanup; khalek@@linuxgamers.net
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.17 2004/05/02 17:55:53 millert Exp $	*/
d67 1
@


1.17
log
@Mtree needs the old crc routines; remove some extraneous includes while
I am at it.
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.16 2003/06/26 19:47:09 deraadt Exp $	*/
d75 1
a75 3
parsekey(name, needvaluep)
	char *name;
	int *needvaluep;
@


1.16
log
@strict proto cleanups
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.15 2003/06/02 23:36:54 millert Exp $	*/
a36 1
#include <fts.h>
@


1.15
log
@Remove the advertising clause in the UCB license which Berkeley
rescinded 22 July 1999.  Proofed by myself and Theo.
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.14 2002/04/04 07:33:23 millert Exp $	*/
d95 1
a95 2
keycompare(a, b)
	const void *a, *b;
@


1.14
log
@Remove short-lived 'preserve' option that was replaced with 'nochange'.
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.13 2002/03/09 18:54:19 millert Exp $	*/
d16 1
a16 5
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by the University of
 *	California, Berkeley and its contributors.
 * 4. Neither the name of the University nor the names of its contributors
@


1.13
log
@Rename the new 'preserve' flag to 'nochange' for consistency with FreeBSD.
The old 'preserve' name is still accepted but is not documented and will
be removed in the future.
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.12 2002/03/04 19:56:39 millert Exp $	*/
a69 1
	{"preserve",	F_NOCHANGE,	0},
@


1.12
log
@Add a 'preserve' flag to tell mtree not to change the attributes of
a file/directory.  This is useful when you want to update children
of a directory but not the parent.
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.11 2002/02/19 19:39:40 millert Exp $	*/
d68 1
d70 1
a70 1
	{"preserve",	F_PRESERVE,	0},
@


1.11
log
@We live in an ANSI C world.  Remove lots of gratuitous #ifdef __STDC__ cruft.
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.10 2002/02/16 21:28:05 millert Exp $	*/
d69 1
@


1.10
log
@Part one of userland __P removal.  Done with a simple regexp with some minor hand editing to make comments line up correctly.  Another pass is forthcoming that handles the cases that could not be done automatically.
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.9 2001/08/10 02:33:46 millert Exp $	*/
d43 1
a103 6
#ifdef __STDC__
#include <stdarg.h>
#else
#include <varargs.h>
#endif

a104 1
#ifdef __STDC__
a105 5
#else
error(fmt, va_alist)
	char *fmt;
        va_dcl
#endif
d108 1
a108 1
#ifdef __STDC__
a109 3
#else
	va_start(ap);
#endif
@


1.9
log
@Add file flag support to mtree from henning@@crackinghacking.de
with man page update and minor tweaks by me.
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.8 1997/07/25 20:12:14 mickey Exp $	*/
d83 1
a83 1
	int keycompare __P((const void *, const void *));
@


1.8
log
@#if __STDC__ --> #ifdef __STDC__
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.7 1997/07/18 05:49:03 millert Exp $	*/
d59 1
@


1.7
log
@err() -> error() so we don't conflict with err(3).
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.6 1997/07/18 05:46:12 millert Exp $	*/
d102 1
a102 1
#if __STDC__
d109 1
a109 1
#if __STDC__
d118 1
a118 1
#if __STDC__
@


1.6
log
@Add rmd160 support.  Sheesh, you'd think this was tripwire.
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.5 1997/07/12 23:05:35 millert Exp $	*/
d88 1
a88 1
		err("unknown keyword %s", name);
d110 1
a110 1
err(const char *fmt, ...)
d112 1
a112 1
err(fmt, va_alist)
@


1.5
log
@Add sha1 digest support.
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.4 1996/12/20 18:13:42 millert Exp $	*/
d67 1
@


1.4
log
@Add back "optional" keyword that got nuked in merge of FreeBSD mods.
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.3 1996/12/10 08:26:08 deraadt Exp $	*/
d67 1
@


1.3
log
@merge freebsd mtree diffs, plus -Wall cleanup
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.2 1996/12/08 01:13:40 niklas Exp $	*/
d66 1
@


1.2
log
@64-bit clean + RCS tags
@
text
@d1 1
a1 1
/*	$OpenBSD: misc.c,v 1.4 1995/03/07 21:26:23 cgd Exp $	*/
d58 13
a70 13
	"cksum",	F_CKSUM,	NEEDVALUE,
	"gid",		F_GID,		NEEDVALUE,
	"gname",	F_GNAME,	NEEDVALUE,
	"ignore",	F_IGN,		0,
	"link",		F_SLINK,	NEEDVALUE,
	"mode",		F_MODE,		NEEDVALUE,
	"nlink",	F_NLINK,	NEEDVALUE,
	"optional",	F_OPT,		0,
	"size",		F_SIZE,		NEEDVALUE,
	"time",		F_TIME,		NEEDVALUE,
	"type",		F_TYPE,		NEEDVALUE,
	"uid",		F_UID,		NEEDVALUE,
	"uname",	F_UNAME,	NEEDVALUE,
d120 2
a121 1
	(void)fprintf(stderr, "mtree: ");
@


1.1
log
@Initial revision
@
text
@d1 1
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
