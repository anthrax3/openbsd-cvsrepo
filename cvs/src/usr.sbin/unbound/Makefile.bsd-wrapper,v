head	1.15;
access;
symbols
	OPENBSD_6_0:1.12.0.4
	OPENBSD_6_0_BASE:1.12
	OPENBSD_5_9:1.12.0.2
	OPENBSD_5_9_BASE:1.12
	OPENBSD_5_8:1.11.0.6
	OPENBSD_5_8_BASE:1.11
	OPENBSD_5_7:1.11.0.4
	OPENBSD_5_7_BASE:1.11
	OPENBSD_5_6:1.9.0.4
	OPENBSD_5_6_BASE:1.9
	OPENBSD_5_5:1.4.0.10
	OPENBSD_5_5_BASE:1.4
	OPENBSD_5_4:1.4.0.6
	OPENBSD_5_4_BASE:1.4
	OPENBSD_5_3:1.4.0.4
	OPENBSD_5_3_BASE:1.4
	OPENBSD_5_2:1.4.0.2
	OPENBSD_5_2_BASE:1.4;
locks; strict;
comment	@# @;


1.15
date	2017.01.28.12.38.42;	author tb;	state Exp;
branches;
next	1.14;
commitid	0XyRY9v9pGV2ViuU;

1.14
date	2017.01.24.09.57.29;	author tb;	state Exp;
branches;
next	1.13;
commitid	RoJP5D0lNhljbAws;

1.13
date	2016.10.05.20.08.36;	author natano;	state Exp;
branches;
next	1.12;
commitid	zgWzrCLJd5e59XUg;

1.12
date	2015.10.27.14.45.52;	author sthen;	state Exp;
branches;
next	1.11;
commitid	f0MaWQjvoyHLNg7d;

1.11
date	2014.11.30.05.54.38;	author brad;	state Exp;
branches;
next	1.10;
commitid	1DjeIVVanO4pvZLw;

1.10
date	2014.11.20.04.48.06;	author brad;	state Exp;
branches;
next	1.9;
commitid	YvO1oqdDzvZdFTvz;

1.9
date	2014.03.26.21.36.40;	author sthen;	state Exp;
branches;
next	1.8;

1.8
date	2014.03.21.00.23.15;	author sthen;	state Exp;
branches;
next	1.7;

1.7
date	2014.03.16.11.43.28;	author sthen;	state Exp;
branches;
next	1.6;

1.6
date	2014.03.15.01.08.05;	author sthen;	state Exp;
branches;
next	1.5;

1.5
date	2014.03.14.23.47.28;	author sthen;	state Exp;
branches;
next	1.4;

1.4
date	2012.03.26.20.32.17;	author sthen;	state Exp;
branches;
next	1.3;

1.3
date	2012.03.26.19.09.30;	author sthen;	state Exp;
branches;
next	1.2;

1.2
date	2012.03.26.18.44.18;	author sthen;	state Exp;
branches;
next	1.1;

1.1
date	2012.03.26.18.14.59;	author sthen;	state Exp;
branches;
next	;


desc
@@


1.15
log
@Back out make(obj) hack: it doesn't solve the problem entirely and may
interfere with read-only src tree setups.
@
text
@#	$OpenBSD: Makefile.bsd-wrapper,v 1.14 2017/01/24 09:57:29 tb Exp $

.include <bsd.own.mk>

BINDIR=		/usr/sbin
CHROOTDIR=	/var/unbound

XCFLAGS=	CC="${CC}" CFLAGS="${CFLAGS} ${COPTS}" LDFLAGS="${LDFLAGS}"

CONFIGURE_OPTS_UNBOUND=	--enable-allsymbols \
			--with-ssl=/usr \
			--with-libevent=/usr \
			--with-libexpat=/usr \
			--without-pthreads \
			--without-pythonmodule \
			--with-chroot-dir=${CHROOTDIR} \
			--with-pidfile="" \
			--with-rootkey-file=/var/unbound/db/root.key \
			--with-conf-file=${CHROOTDIR}/etc/unbound.conf \
			--with-username=_unbound \
			--disable-shared

PROG=	unbound \
	unbound-anchor \
	unbound-checkconf \
	unbound-control \
	unbound-host

SCRIPT=	unbound-control-setup

MAN=	doc/unbound.8 \
	doc/unbound.conf.5 \
	doc/unbound-anchor.8 \
	doc/unbound-checkconf.8	\
	doc/unbound-control.8 \
	doc/unbound-host.1

all:	gnu

.ifndef NOMAN
${MANALL} ${PSALL}: ${MAN}

${MAN}:	gnu
.endif

gnu: ${.OBJDIR}/config.status
	${MAKE}

.FORCE: .IGNORE

config: .FORCE
	-rm -f ${.OBJDIR}/config.cache
	cd ${.OBJDIR} && \
		PATH="/bin:/usr/bin:/sbin:/usr/sbin" \
		${XCFLAGS} \
		sh ${.CURDIR}/configure ${CONFIGURE_OPTS_UNBOUND}

${.OBJDIR}/config.status:
	cd ${.OBJDIR} && \
		PATH="/bin:/usr/bin:/sbin:/usr/sbin" \
		${XCFLAGS} \
		sh ${.CURDIR}/configure ${CONFIGURE_OPTS_UNBOUND}

.ifdef NOMAN
maninstall:
	@@echo NOMAN is set
.endif

install: maninstall
.for file in ${PROG}
	${INSTALL} ${INSTALL_COPY} ${INSTALL_STRIP} \
		-o ${BINOWN} -g ${BINGRP} -m ${BINMODE} \
		${file} ${DESTDIR}${BINDIR}
.endfor

.for file in ${SCRIPT}
	${INSTALL} ${INSTALL_COPY} \
		-o ${BINOWN} -g ${BINGRP} -m ${BINMODE} \
		${file} ${DESTDIR}${BINDIR}
.endfor

BEFOREMAN= ${.OBJDIR}/config.status
CLEANFILES+= ${MAN} dnstap/dnstap_config.h doc/example.conf doc/libunbound.3 \
		smallapp/unbound-control-setup.sh

clean cleandir:
	-@@if [ -e Makefile ]; then ${MAKE} realclean; fi
	rm -f ${CLEANFILES}

depend:
	# Nothing here so far...

tags:
	# Nothing here so far...

.include <bsd.obj.mk>
.include <bsd.subdir.mk>
.ifndef NOMAN
.include <bsd.man.mk>
.endif
@


1.14
log
@Add a workaround for the fact that 'install -d' without explicit mode
defaults to 755, which is incompatible with WOBJUMASK. Make sure that
obj/util has permissions :wobj 770, as all other directories in obj/.
Issue also found by jmc, actual reason tracked down by ajacoutot.

ok ajacoutot
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.bsd-wrapper,v 1.13 2016/10/05 20:08:36 natano Exp $
a91 10

# install-sh creates obj/util using 'install -d' without setting the mode
# explicitly. Make sure it has the right owner and permissions.
.if make(obj)
.END:
	@@umask ${WOBJUMASK}; \
	[[ `id -u` -eq 0 ]] && SETOWNER="chown -h ${BUILDUSER}" || SETOWNER=:; \
	mkdir -p util; \
	$$SETOWNER util;
.endif
@


1.13
log
@Rewriting USER gets in the way of the de-escalation mechanism as it
shadows the real user's identity.
ok deraadt
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.bsd-wrapper,v 1.12 2015/10/27 14:45:52 sthen Exp $
d93 9
a101 2
lint:
	# Nothing here so far...
@


1.12
log
@Don't use a pidfile in unbound by default. Retain the ability in unbound.conf
to set one if needed.  ok millert@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.bsd-wrapper,v 1.11 2014/11/30 05:54:38 brad Exp $
a6 1
USER=		_unbound
d20 1
a20 1
			--with-username=${USER} \
@


1.11
log
@Remove passing an override of INSTALL_PROGRAM to the
autoconf script. It doesn't seem to serve any purpose.

ok sthen@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.bsd-wrapper,v 1.10 2014/11/20 04:48:06 brad Exp $
d18 1
a18 1
			--with-pidfile=/var/run/unbound.pid \
@


1.10
log
@clean up some files generated during the build.

noticed by deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.bsd-wrapper,v 1.9 2014/03/26 21:36:40 sthen Exp $
a56 1
		INSTALL_PROGRAM="${INSTALL} ${INSTALL_COPY} ${INSTALL_STRIP}" \
a62 1
		INSTALL_PROGRAM="${INSTALL} ${INSTALL_COPY} ${INSTALL_STRIP}" \
@


1.9
log
@Remove bsd-wrapper pieces to handle pulling unbound-host.1 from src,
no longer needed now that this file is handled the same in Unbound's build
infrastructure as the other manpages.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.bsd-wrapper,v 1.8 2014/03/21 00:23:15 sthen Exp $
d86 2
a87 1
CLEANFILES+= ${MAN} doc/example.conf doc/libunbound.3
@


1.8
log
@Install a /var/unbound/db directory, writable by the _unbound daemon,
and use it as the default location for the DNSSEC root key. Update default
config for this location.

With this, the only step required to enable DNSSEC validation is to
uncomment these default config entries and restart:

	#module-config: "validator iterator"
	#auto-trust-anchor-file: "/var/unbound/db/root.key"

There is no longer a requirement to run unbound-anchor manually to
update the root key. The rc.d script will take care of updates at boot,
and Unbound will manage the file itself at runtime.

Test with "dig test.dnssec-or-not.net txt @@127.0.0.1" or similar.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.bsd-wrapper,v 1.7 2014/03/16 11:43:28 sthen Exp $
a58 4
	if [ ! -e ${.OBJDIR}/doc/unbound-host.1 ]; then \
		cp ${.CURDIR}/doc/unbound-host.1 \
			${.OBJDIR}/doc/unbound-host.1; \
	fi
a65 4
	if [ ! -e ${.OBJDIR}/doc/unbound-host.1 ]; then \
		cp ${.CURDIR}/doc/unbound-host.1 \
			${.OBJDIR}/doc/unbound-host.1; \
	fi
@


1.7
log
@merge conflicts, remove old libldns files
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.bsd-wrapper,v 1.6 2014/03/15 01:08:05 sthen Exp $
d19 1
@


1.6
log
@change pidfile location again; actually this is written before chroot, so
it can go straight in /var/run
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.bsd-wrapper,v 1.5 2014/03/14 23:47:28 sthen Exp $
a10 3
CONFIGURE_OPTS_LDNS=	--with-drill \
			--disable-shared

a14 1
			--with-ldns=ldns \
d23 1
a23 2
PROG=	ldns/drill/drill \
	unbound \
d31 1
a31 2
MAN=	ldns/drill/drill.1 \
	doc/unbound.8 \
a51 1
	-rm -f ${.OBJDIR}/ldns/config.cache
a52 6
	cd ${.OBJDIR} && mkdir -p ldns && cd ldns && \
		PATH="/bin:/usr/bin:/sbin:/usr/sbin" \
		${XCFLAGS} \
		INSTALL_PROGRAM="${INSTALL} ${INSTALL_COPY} ${INSTALL_STRIP}" \
		sh ${.CURDIR}/ldns/configure ${CONFIGURE_OPTS_LDNS} && \
		${MAKE} 
a57 4
	if [ ! -e ${.OBJDIR}/ldns/drill/drill.1 ]; then \
		cp ${.CURDIR}/ldns/drill/drill.1 \
			${.OBJDIR}/ldns/drill/drill.1;\
	fi
a63 6
	cd ${.OBJDIR} && mkdir -p ldns && cd ldns && \
		PATH="/bin:/usr/bin:/sbin:/usr/sbin" \
		${XCFLAGS} \
		INSTALL_PROGRAM="${INSTALL} ${INSTALL_COPY} ${INSTALL_STRIP}" \
		sh ${.CURDIR}/ldns/configure ${CONFIGURE_OPTS_LDNS} && \
		${MAKE}
a68 4
	if [ ! -e ${.OBJDIR}/ldns/drill/drill.1 ]; then \
		cp ${.CURDIR}/ldns/drill/drill.1 \
			 ${.OBJDIR}/ldns/drill/drill.1;\
	fi
a96 1
	-@@if [ -e ldns/Makefile ]; then cd ldns; ${MAKE} realclean; fi
@


1.5
log
@use $chrootdir/run for pid file, like nsd.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.bsd-wrapper,v 1.4 2012/03/26 20:32:17 sthen Exp $
d22 1
a22 1
			--with-pidfile=${CHROOTDIR}/run/unbound.pid \
@


1.4
log
@Add a few missing files for 'make clean'.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.bsd-wrapper,v 1.3 2012/03/26 19:09:30 sthen Exp $
d22 1
a22 1
			--with-pidfile=${CHROOTDIR}/var/run/unbound.pid \
@


1.3
log
@When clenaing, run "make realclean" in the ldns subdirectory, not just unbound.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.bsd-wrapper,v 1.2 2012/03/26 18:44:18 sthen Exp $
d120 1
@


1.2
log
@set --without-pythonmodule (this is the default anyway, but better to be explicit).
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.bsd-wrapper,v 1.1 2012/03/26 18:14:59 sthen Exp $
d123 1
@


1.1
log
@Add Makefile wrapper for Unbound. From Bjorn Ketelaars <bjorn.ketelaars
at hydroxide.nl>.
@
text
@d1 1
a1 1
#	$OpenBSD$
d20 1
@

