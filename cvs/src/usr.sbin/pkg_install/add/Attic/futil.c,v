head	1.8;
access;
symbols
	OPENBSD_3_5:1.7.0.4
	OPENBSD_3_5_BASE:1.7
	OPENBSD_3_4:1.7.0.2
	OPENBSD_3_4_BASE:1.7
	OPENBSD_3_3:1.6.0.10
	OPENBSD_3_3_BASE:1.6
	OPENBSD_3_2:1.6.0.8
	OPENBSD_3_2_BASE:1.6
	OPENBSD_3_1:1.6.0.6
	OPENBSD_3_1_BASE:1.6
	OPENBSD_3_0:1.6.0.4
	OPENBSD_3_0_BASE:1.6
	OPENBSD_2_9_BASE:1.6
	OPENBSD_2_9:1.6.0.2
	OPENBSD_2_8:1.5.0.6
	OPENBSD_2_8_BASE:1.5
	OPENBSD_2_7:1.5.0.4
	OPENBSD_2_7_BASE:1.5
	OPENBSD_2_6:1.5.0.2
	OPENBSD_2_6_BASE:1.5
	OPENBSD_2_5:1.4.0.4
	OPENBSD_2_5_BASE:1.4
	OPENBSD_2_4:1.4.0.2
	OPENBSD_2_4_BASE:1.4
	OPENBSD_2_3:1.3.0.6
	OPENBSD_2_3_BASE:1.3
	OPENBSD_2_2:1.3.0.4
	OPENBSD_2_2_BASE:1.3
	OPENBSD_2_1:1.3.0.2
	OPENBSD_2_1_BASE:1.3
	OPENBSD_2_0:1.2.0.2
	OPENBSD_2_0_BASE:1.2;
locks; strict;
comment	@ * @;


1.8
date	2004.05.28.20.15.48;	author brad;	state dead;
branches;
next	1.7;

1.7
date	2003.07.04.17.31.19;	author avsm;	state Exp;
branches;
next	1.6;

1.6
date	2001.04.08.16.45.46;	author espie;	state Exp;
branches;
next	1.5;

1.5
date	99.06.24.17.27.11;	author espie;	state Exp;
branches;
next	1.4;

1.4
date	98.09.07.22.30.13;	author marc;	state Exp;
branches;
next	1.3;

1.3
date	97.01.17.07.14.11;	author millert;	state Exp;
branches;
next	1.2;

1.2
date	96.06.04.08.43.33;	author niklas;	state Exp;
branches;
next	1.1;

1.1
date	96.06.04.07.56.03;	author niklas;	state Exp;
branches;
next	;


desc
@@


1.8
log
@bye bye old package tools.

ok deraadt@@
@
text
@/*	$OpenBSD: futil.c,v 1.7 2003/07/04 17:31:19 avsm Exp $	*/

#ifndef lint
static const char rcsid[] = "$OpenBSD: futil.c,v 1.7 2003/07/04 17:31:19 avsm Exp $";
#endif

/*
 * FreeBSD install - a package for the installation and maintainance
 * of non-core utilities.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * Jordan K. Hubbard
 * 18 July 1993
 *
 * Miscellaneous file access utilities.
 *
 */

#include <err.h>
#include "lib.h"
#include "add.h"

/*
 * Assuming dir is a desired directory name, make it and all intervening
 * directories necessary.
 */

int
make_hierarchy(char *dir)
{
    char *cp1, *cp2;

    if (dir[0] == '/')
	cp1 = cp2 = dir + 1;
    else
	cp1 = cp2 = dir;
    while (cp2) {
	if ((cp2 = strchr(cp1, '/')) !=NULL )
	    *cp2 = '\0';
	if (fexists(dir)) {
	    if (!(isdir(dir) || islinktodir(dir)))
		return FAIL;
	}
	else {
	    if (vsystem("mkdir %s", dir))
		return FAIL;
	    apply_perms(NULL, dir);
	}
	/* Put it back */
	if (cp2) {
	    *cp2 = '/';
	    cp1 = cp2 + 1;
	}
    }
    return SUCCESS;
}

/* Using permission defaults, apply them as necessary */
void
apply_perms(char *dir, char *arg)
{
    char *cd_to;

    if (!dir || *arg == '/')	/* absolute path? */
	cd_to = "/";
    else
	cd_to = dir;

    if (Owner || Group) {
	char *real_owner = Owner ? Owner : "";
	char *real_group = Group ? Group : "";

	if (vsystem("cd %s && chown -R %s:%s %s", cd_to, real_owner , 
		real_group, arg))
	    pwarnx("couldn't change owner/group of '%s' to '%s:%s'",
		   arg, real_owner, real_group);
    }  
    if (Mode)
	if (vsystem("cd %s && chmod -R %s %s", cd_to, Mode, arg))
	    pwarnx("couldn't change modes of '%s' to '%s'", arg, Mode);
}

@


1.7
log
@'static const char rcsid[]' to make it -Wall clean
@
text
@d1 1
a1 1
/*	$OpenBSD: futil.c,v 1.6 2001/04/08 16:45:46 espie Exp $	*/
d4 1
a4 1
static const char rcsid[] = "$OpenBSD: futil.c,v 1.6 2001/04/08 16:45:46 espie Exp $";
@


1.6
log
@Better error messages: pwarnx function, which works like pwarn, except
it shows a current package name along with the program name, e.g.,
pkg_add(foo-3.0): some error occurred.

A few messages now bear redundant pkgnames, which is much better than
doing pkg_add * and being informed that something went slightly wrong
somewhere...
@
text
@d1 1
a1 1
/*	$OpenBSD: futil.c,v 1.5 1999/06/24 17:27:11 espie Exp $	*/
d4 1
a4 1
static const char *rcsid = "$OpenBSD: futil.c,v 1.5 1999/06/24 17:27:11 espie Exp $";
@


1.5
log
@- let chmod work for suid (move it in front of chown).
- use the new form of chown, with user:group instead of user.group.
@
text
@d1 1
a1 1
/*	$OpenBSD: futil.c,v 1.4 1998/09/07 22:30:13 marc Exp $	*/
d4 1
a4 1
static const char *rcsid = "$OpenBSD: futil.c,v 1.4 1998/09/07 22:30:13 marc Exp $";
d83 1
a83 1
	    warnx("couldn't change owner/group of '%s' to '%s:%s'",
d88 1
a88 1
	    warnx("couldn't change modes of '%s' to '%s'", arg, Mode);
@


1.4
log
@updated pkg_* tools.  Merged in many changes/improvements from NetBSD.
New features include md5 hash so pkg_delete won't remove files that have
changed and the ability to define conflicting packages, e.g. you can't
install both mh and nmh.  The ports tree will have to be updated to take
advantage of this.

Let me know of any problems, real or imagined :-)
@
text
@d1 1
a1 1
/*	$OpenBSD: futil.c,v 1.3 1997/01/17 07:14:11 millert Exp $	*/
d4 1
a4 1
static const char *rcsid = "$OpenBSD: futil.c,v 1.3 1997/01/17 07:14:11 millert Exp $";
d77 9
a88 13
    if (Owner && Group) {
	if (vsystem("cd %s && chown -R %s.%s %s", cd_to, Owner, Group, arg))
	    warnx("couldn't change owner/group of '%s' to '%s.%s'",
		   arg, Owner, Group);
	return;
    }
    if (Owner) {
	if (vsystem("cd %s && chown -R %s %s", cd_to, Owner, arg))
	    warnx("couldn't change owner of '%s' to '%s'", arg, Owner);
	return;
    } else if (Group)
	if (vsystem("cd %s && chgrp -R %s %s", cd_to, Group, arg))
	    warnx("couldn't change group of '%s' to '%s'", arg, Group);
@


1.3
log
@r?index -> strr?chr
@
text
@d1 1
a1 1
/*	$OpenBSD: futil.c,v 1.2 1996/06/04 08:43:33 niklas Exp $	*/
d4 1
a4 1
static const char *rcsid = "$OpenBSD: futil.c,v 1.2 1996/06/04 08:43:33 niklas Exp $";
d27 1
d49 1
a49 1
	    if (!isdir(dir))
d79 1
a79 2
	    whinge("Couldn't change modes of '%s' to '%s'.",
		   arg, Mode);
d82 1
a82 1
	    whinge("Couldn't change owner/group of '%s' to '%s.%s'.",
d88 1
a88 2
	    whinge("Couldn't change owner of '%s' to '%s'.",
		   arg, Owner);
d92 1
a92 2
	    whinge("Couldn't change group of '%s' to '%s'.",
		   arg, Group);
@


1.2
log
@Oops, screwed up the $OpenBSD$ IDs
@
text
@d1 1
a1 1
/*	$OpenBSD: futil.c,v 1.1 1996/06/04 07:56:03 niklas Exp $	*/
d4 1
a4 1
static const char *rcsid = "$OpenBSD: futil.c,v 1.1 1996/06/04 07:56:03 niklas Exp $";
d45 1
a45 1
	if ((cp2 = index(cp1, '/')) !=NULL )
@


1.1
log
@add package tools from FreeBSD
@
text
@d1 2
a2 1
#	$OpenBSD$
d4 1
a4 1
static const char *rcsid = "$OpenBSD: futil.c,v 1.4 1995/05/30 03:49:52 rgrimes Exp $";
@
