head	1.14;
access;
symbols
	OPENBSD_3_5:1.13.0.4
	OPENBSD_3_5_BASE:1.13
	OPENBSD_3_4:1.13.0.2
	OPENBSD_3_4_BASE:1.13
	OPENBSD_3_3:1.10.0.6
	OPENBSD_3_3_BASE:1.10
	OPENBSD_3_2:1.10.0.4
	OPENBSD_3_2_BASE:1.10
	OPENBSD_3_1:1.10.0.2
	OPENBSD_3_1_BASE:1.10
	OPENBSD_3_0:1.9.0.4
	OPENBSD_3_0_BASE:1.9
	OPENBSD_2_9_BASE:1.9
	OPENBSD_2_9:1.9.0.2
	OPENBSD_2_8:1.8.0.10
	OPENBSD_2_8_BASE:1.8
	OPENBSD_2_7:1.8.0.8
	OPENBSD_2_7_BASE:1.8
	OPENBSD_2_6:1.8.0.6
	OPENBSD_2_6_BASE:1.8
	OPENBSD_2_5:1.8.0.4
	OPENBSD_2_5_BASE:1.8
	OPENBSD_2_4:1.8.0.2
	OPENBSD_2_4_BASE:1.8
	OPENBSD_2_3:1.6.0.2
	OPENBSD_2_3_BASE:1.6
	OPENBSD_2_2:1.4.0.4
	OPENBSD_2_2_BASE:1.4
	OPENBSD_2_1:1.4.0.2
	OPENBSD_2_1_BASE:1.4
	OPENBSD_2_0:1.2.0.2
	OPENBSD_2_0_BASE:1.2;
locks; strict;
comment	@ * @;


1.14
date	2004.05.28.20.15.48;	author brad;	state dead;
branches;
next	1.13;

1.13
date	2003.08.15.00.03.22;	author espie;	state Exp;
branches;
next	1.12;

1.12
date	2003.07.04.17.31.19;	author avsm;	state Exp;
branches;
next	1.11;

1.11
date	2003.04.04.08.56.01;	author avsm;	state Exp;
branches;
next	1.10;

1.10
date	2002.02.16.21.28.06;	author millert;	state Exp;
branches;
next	1.9;

1.9
date	2001.04.08.16.45.46;	author espie;	state Exp;
branches;
next	1.8;

1.8
date	98.10.13.23.09.50;	author marc;	state Exp;
branches;
next	1.7;

1.7
date	98.09.07.22.30.14;	author marc;	state Exp;
branches;
next	1.6;

1.6
date	98.04.07.04.17.49;	author deraadt;	state Exp;
branches;
next	1.5;

1.5
date	98.04.04.22.44.16;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	97.01.15.23.44.10;	author millert;	state Exp;
branches;
next	1.3;

1.3
date	96.12.29.12.18.27;	author graichen;	state Exp;
branches;
next	1.2;

1.2
date	96.06.04.08.43.35;	author niklas;	state Exp;
branches;
next	1.1;

1.1
date	96.06.04.07.56.05;	author niklas;	state Exp;
branches;
next	;


desc
@@


1.14
log
@bye bye old package tools.

ok deraadt@@
@
text
@/*	$OpenBSD: main.c,v 1.13 2003/08/15 00:03:22 espie Exp $	*/

#ifndef lint
static const char rcsid[] = "$OpenBSD: main.c,v 1.13 2003/08/15 00:03:22 espie Exp $";
#endif

/*
 * FreeBSD install - a package for the installation and maintainance
 * of non-core utilities.
 *
 * Jordan K. Hubbard
 * 18 July 1993
 *
 * This is the create module.
 *
 */

#include <err.h>
#include "lib.h"
#include "create.h"

static char Options[] = "Ohvf:p:P:C:c:d:i:k:r:t:X:D:m:s:S:";

char	*Prefix		= NULL;
char	*Comment	= NULL;
char	*Desc		= NULL;
char	*SrcDir		= NULL;
char	*Display	= NULL;
char	*Install	= NULL;
char	*DeInstall	= NULL;
char	*Contents	= NULL;
char	*Require	= NULL;
char	*ExcludeFrom	= NULL;
char	*Mtree		= NULL;
char	*Pkgdeps	= NULL;
char	*Pkgcfl		= NULL;
char	*BaseDir	= NULL;
char	PlayPen[FILENAME_MAX];
size_t	PlayPenSize	= sizeof(PlayPen);
int	Dereference	= 0;
int	PlistOnly	= 0;

static void usage(void);

int
main(int argc, char **argv)
{
    int ch;
    char **pkgs, **start;

    pkgs = start = argv;
    while ((ch = getopt(argc, argv, Options)) != -1)
	switch(ch) {
	case 'v':
	    Verbose = TRUE;
	    break;

	case 'O':
	    PlistOnly = YES;
	    break;

	case 'p':
	    Prefix = optarg;
	    break;

	case 's':
	    SrcDir = optarg;
	    break;

	case 'S':
	    BaseDir = optarg;
	    break;

	case 'f':
	    Contents = optarg;
	    break;

	case 'c':
	    Comment = optarg;
	    break;

	case 'd':
	    Desc = optarg;
	    break;

	case 'i':
	    Install = optarg;
	    break;

	case 'k':
	    DeInstall = optarg;
	    break;

	case 'r':
	    Require = optarg;
	    break;

	case 't':
	    strlcpy(PlayPen, optarg, PlayPenSize);
	    break;

	case 'X':
	  /* XXX this won't work until someone adds the gtar -X option
	     (--exclude-from-file) to paxtar - so long it is disabled
	     in perform.c */
	    printf("WARNING: the -X option is not supported in OpenBSD\n");
	    ExcludeFrom = optarg;
	    break;

	case 'h':
	    Dereference = 1;
	    break;

	case 'D':
	    Display = optarg;
	    break;

	case 'm':
	    Mtree = optarg;
	    break;

	case 'P':
	    Pkgdeps = optarg;
	    break;

	case 'C':
		Pkgcfl = optarg;
		break;

	case '?':
	default:
	    usage();
	    break;
	}

    argc -= optind;
    argv += optind;

    /* Get all the remaining package names, if any */
    while (*argv)
	*pkgs++ = *argv++;

    /* If no packages, yelp */
    if (pkgs == start)
	pwarnx("missing package name"), usage();
    *pkgs = NULL;
    if (start[1])
	pwarnx("only one package name allowed ('%s' extraneous)", start[1]),
	usage();
    if (!pkg_perform(start)) {
	if (Verbose)
	    pwarnx("package creation failed");
	return 1;
    }
    else
	return 0;
}

static void
usage()
{
    fprintf(stderr, "%s\n%s\n%s\n%s\n",
"usage: pkg_create [-Ohv] [-P dpkgs] [-C cpkgs] [-p prefix] [-f contents]",
"                  [-i iscript] [-k dscript] [-r rscript] [-t template]",
"                  [-X excludefile] [-D displayfile] [-m mtreefile]",
"                  -c comment -d description -f packlist -S basedir pkg-name");
    exit(1);
}
@


1.13
log
@-S basedir, simpler to use than -s.

Sets prefix logic better, so that it doesn't interfere with existing @@cwd
in packing lists.

tests by naddy@@
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.12 2003/07/04 17:31:19 avsm Exp $	*/
d4 1
a4 1
static const char rcsid[] = "$OpenBSD: main.c,v 1.12 2003/07/04 17:31:19 avsm Exp $";
@


1.12
log
@'static const char rcsid[]' to make it -Wall clean
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.11 2003/04/04 08:56:01 avsm Exp $	*/
d4 1
a4 1
static const char rcsid[] = "$OpenBSD: main.c,v 1.11 2003/04/04 08:56:01 avsm Exp $";
d22 1
a22 1
static char Options[] = "Ohvf:p:P:C:c:d:i:k:r:t:X:D:m:s:";
d37 1
d70 4
d166 1
a166 1
"                  -c comment -d description -f packlist pkg-name");
@


1.11
log
@some more strcpy/strcat -> strlcpy/strlcat conversions
ok and tweaks by ho@@
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.10 2002/02/16 21:28:06 millert Exp $	*/
d4 1
a4 1
static const char *rcsid = "$OpenBSD: main.c,v 1.10 2002/02/16 21:28:06 millert Exp $";
@


1.10
log
@Part one of userland __P removal.  Done with a simple regexp with some minor hand editing to make comments line up correctly.  Another pass is forthcoming that handles the cases that could not be done automatically.
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.9 2001/04/08 16:45:46 espie Exp $	*/
d4 1
a4 1
static const char *rcsid = "$OpenBSD: main.c,v 1.9 2001/04/08 16:45:46 espie Exp $";
d94 1
a94 1
	    strcpy(PlayPen, optarg);
@


1.9
log
@Better error messages: pwarnx function, which works like pwarn, except
it shows a current package name along with the program name, e.g.,
pkg_add(foo-3.0): some error occurred.

A few messages now bear redundant pkgnames, which is much better than
doing pkg_add * and being informed that something went slightly wrong
somewhere...
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.8 1998/10/13 23:09:50 marc Exp $	*/
d4 1
a4 1
static const char *rcsid = "$OpenBSD: main.c,v 1.8 1998/10/13 23:09:50 marc Exp $";
d42 1
a42 1
static void usage __P((void));
@


1.8
log
@Sync with recent NetBSD changes:
- use snprintf in place of sprintf
- code cleanup
- Package -> package_t, PackingList -> plist_t
Also: remove files that haven't been linked in a while
Pass -q to mtree so it is quiet in the presence of symlinks
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.7 1998/09/07 22:30:14 marc Exp $	*/
d4 1
a4 1
static const char *rcsid = "$OpenBSD: main.c,v 1.7 1998/09/07 22:30:14 marc Exp $";
d140 1
a140 1
	warnx("missing package name"), usage();
d143 1
a143 1
	warnx("only one package name allowed ('%s' extraneous)", start[1]),
d147 1
a147 1
	    warnx("package creation failed");
@


1.7
log
@updated pkg_* tools.  Merged in many changes/improvements from NetBSD.
New features include md5 hash so pkg_delete won't remove files that have
changed and the ability to define conflicting packages, e.g. you can't
install both mh and nmh.  The ports tree will have to be updated to take
advantage of this.

Let me know of any problems, real or imagined :-)
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.6 1998/04/07 04:17:49 deraadt Exp $	*/
d4 1
a4 1
static const char *rcsid = "$OpenBSD: main.c,v 1.6 1998/04/07 04:17:49 deraadt Exp $";
d22 1
a22 1
static char Options[] = "YNOhvf:p:P:C:c:d:i:k:r:t:X:D:m:s:";
d25 1
a25 1
char	*Comment        = NULL;
d38 1
a56 8
	case 'N':
	    AutoAnswer = NO;
	    break;

	case 'Y':
	    AutoAnswer = YES;
	    break;

d158 1
a158 1
"usage: pkg_create [-YNOhv] [-P dpkgs] [-C cpkgs] [-p prefix] [-f contents]",
@


1.6
log
@cleanup usage even more; very annoying
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.5 1998/04/04 22:44:16 deraadt Exp $	*/
d4 1
a4 1
static const char *rcsid = "$OpenBSD: main.c,v 1.5 1998/04/04 22:44:16 deraadt Exp $";
d18 1
d22 1
a22 1
static char Options[] = "YNOhvf:p:P:c:d:i:k:r:t:X:D:m:";
d27 1
a32 1
char	PlayPen[FILENAME_MAX];
d36 2
d41 2
a47 1
    char *prog_name = argv[0];
d72 4
d128 4
d134 1
a134 1
	    usage(prog_name, NULL);
d147 1
a147 1
	usage(prog_name, "Missing package name");
d150 2
a151 2
	usage(prog_name, "Only one package name allowed\n\t('%s' extraneous)",
	      start[1]);
d154 1
a154 1
	    fprintf(stderr, "Package creation failed.\n");
d161 2
a162 2
void
usage(const char *name, const char *fmt, ...)
d164 5
a168 14
    va_list args;

    va_start(args, fmt);
    if (fmt) {
	fprintf(stderr, "%s: ", name);
	vfprintf(stderr, fmt, args);
	fprintf(stderr, "\n");
    }
    va_end(args);
    fprintf(stderr,
	"usage: %s [-YNOhv] [-P pkgs] [-p prefix] [-f contents] [-i iscript]\n"
	"       [-k dscript] [-r rscript] [-t template] [-X excludefile]\n"
	"       [-D displayfile] [-m mtreefile] -d description -f packlist] pkg\n",
	name);
@


1.5
log
@fix usage
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.4 1997/01/15 23:44:10 millert Exp $	*/
d4 1
a4 1
static const char *rcsid = "$OpenBSD: main.c,v 1.4 1997/01/15 23:44:10 millert Exp $";
d158 1
a158 1
	fprintf(stderr, "\n\n");
d161 5
a165 18
    fprintf(stderr, "Usage: %s [args] pkg\n\n", name);
    fprintf(stderr, "\t-c [-]file Get one-line comment from file (-or arg)\n");
    fprintf(stderr, "\t-d [-]file Get description from file (-or arg)\n");
    fprintf(stderr, "\t-f file    get list of files from file (- for stdin)\n");
    fprintf(stderr, "\t-h         follow symbolic links\n");
    fprintf(stderr, "\t-i script  install script\n");
    fprintf(stderr, "\t-k script  de-install script\n");
    fprintf(stderr, "\t-D file    install notice\n");
    fprintf(stderr, "\t-m file    mtree spec for directories\n");
    fprintf(stderr, "\t-P pkgs    set package dependency list to pkgs\n");
    fprintf(stderr, "\t-p prefix  install prefix will be arg\n");
    fprintf(stderr, "\t-r script  pre/post requirements script\n");
    fprintf(stderr, "\t-t temp    use temp as template for mktemp()\n");
    fprintf(stderr, "\t-X file    exclude files listed in file\n");
    fprintf(stderr, "\t-v         verbose\n");
    fprintf(stderr, "\t-Y         assume `yes' answer to all questions\n");
    fprintf(stderr, "\t-N         assume `no' answer to all questions\n");
    fprintf(stderr, "\t-O         print a revised packing list and exit\n");
@


1.4
log
@getopt(3) returns -1 when out of args, not EOF, whee!
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.3 1996/12/29 12:18:27 graichen Exp $	*/
d4 1
a4 1
static const char *rcsid = "$OpenBSD: main.c,v 1.3 1996/12/29 12:18:27 graichen Exp $";
d162 17
a178 19
    fprintf(stderr, "Where args are one or more of:\n\n");

    fprintf(stderr, "-c [-]file Get one-line comment from file (-or arg)\n");
    fprintf(stderr, "-d [-]file Get description from file (-or arg)\n");
    fprintf(stderr, "-f file    get list of files from file (- for stdin)\n");
    fprintf(stderr, "-h         follow symbolic links\n");
    fprintf(stderr, "-i script  install script\n");
    fprintf(stderr, "-k script  de-install script\n");
    fprintf(stderr, "-D file    install notice\n");
    fprintf(stderr, "-m file    mtree spec for directories\n");
    fprintf(stderr, "-P pkgs    set package dependency list to pkgs\n");
    fprintf(stderr, "-p prefix  install prefix will be arg\n");
    fprintf(stderr, "-r script  pre/post requirements script\n");
    fprintf(stderr, "-t temp    use temp as template for mktemp()\n");
    fprintf(stderr, "-X file    exclude files listed in file\n");
    fprintf(stderr, "-v         verbose\n");
    fprintf(stderr, "-Y         assume `yes' answer to all questions\n");
    fprintf(stderr, "-N         assume `no' answer to all questions\n");
    fprintf(stderr, "-O         print a revised packing list and exit\n");
@


1.3
log
@work around the missing (gtar) -T (--files-from) option of our paxtar
in pkg_create so that it should work now with paxtar (the -X option is
still missing due to missing -X - in the gtar meaning --exclude-from-file
option)

i did it by changing the FreeBSD way of doing it (open a pipe to tar with
-T - (read filenames from stdin) and give all the filenames to the pipe)
to constructing a big :-) argumentlist for tar and executing it without
the pipe (not the best solution but it works :-)
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.2 1996/06/04 08:43:35 niklas Exp $	*/
d4 1
a4 1
static const char *rcsid = "$OpenBSD: main.c,v 1.2 1996/06/04 08:43:35 niklas Exp $";
d46 1
a46 1
    while ((ch = getopt(argc, argv, Options)) != EOF)
@


1.2
log
@Oops, screwed up the $OpenBSD$ IDs
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.1 1996/06/04 07:56:05 niklas Exp $	*/
d4 1
a4 1
static const char *rcsid = "$OpenBSD: main.c,v 1.1 1996/06/04 07:56:05 niklas Exp $";
d97 4
@


1.1
log
@add package tools from FreeBSD
@
text
@d1 2
a2 1
#	$OpenBSD$
d4 1
a4 1
static const char *rcsid = "$OpenBSD: main.c,v 1.12 1995/10/25 15:37:59 jkh Exp $";
@
