head	1.10;
access;
symbols
	OPENBSD_6_2_BASE:1.10
	OPENBSD_6_1:1.10.0.4
	OPENBSD_6_1_BASE:1.10
	OPENBSD_6_0:1.2.0.2
	OPENBSD_6_0_BASE:1.2;
locks; strict;
comment	@ * @;


1.10
date	2016.11.18.16.49.35;	author reyk;	state Exp;
branches;
next	1.9;
commitid	wenNEobVmwJZjDoJ;

1.9
date	2016.11.18.16.34.04;	author reyk;	state Exp;
branches;
next	1.8;
commitid	2iF9xGHOrAI2qEQz;

1.8
date	2016.11.17.12.40.56;	author reyk;	state Exp;
branches;
next	1.7;
commitid	w9Wbt6hfN4dz1Tsn;

1.7
date	2016.10.12.19.07.42;	author reyk;	state Exp;
branches;
next	1.6;
commitid	3O0CWeyo2kl0zVpd;

1.6
date	2016.10.06.20.27.44;	author reyk;	state Exp;
branches;
next	1.5;
commitid	JJP067TfhT8qvgdD;

1.5
date	2016.09.30.12.32.31;	author reyk;	state Exp;
branches;
next	1.4;
commitid	6eToJOmsTHI5FaWk;

1.4
date	2016.09.30.11.57.57;	author reyk;	state Exp;
branches;
next	1.3;
commitid	Bk6N1Zmhuj3ewIdN;

1.3
date	2016.09.14.13.46.51;	author rzalamena;	state Exp;
branches;
next	1.2;
commitid	JePtimnIRHuPUx14;

1.2
date	2016.07.19.18.14.08;	author reyk;	state Exp;
branches;
next	1.1;
commitid	QaXohszP3qByKnvb;

1.1
date	2016.07.19.16.54.26;	author reyk;	state Exp;
branches;
next	;
commitid	NvD0Bp0qm4zs28YJ;


desc
@@


1.10
log
@Define constmap in ofp_map.h to be shared along with ofp_map.c
@
text
@/*	$OpenBSD: types.h,v 1.9 2016/11/18 16:34:04 reyk Exp $	*/

/*
 * Copyright (c) 2013-2016 Reyk Floeter <reyk@@openbsd.org>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#ifndef SWITCHD_TYPES_H
#define SWITCHD_TYPES_H

#ifndef SWITCHD_USER
#define SWITCHD_USER	"_switchd"
#endif

#define SWITCHD_NAME	"switch"

#ifndef SWITCHD_CONFIG
#define SWITCHD_CONFIG	"/etc/" SWITCHD_NAME "d.conf"
#endif
#define SWITCHD_SOCKET	"/var/run/" SWITCHD_NAME "d.sock"

#define	SWITCHD_FD_RESERVE	5
#define SWITCHD_CYCLE_BUFFERS	8	/* # of static buffers for mapping */
#define SWITCHD_READ_BUFFER	0xffff
#define SWITCHD_MSGBUF_MAX	0xffff
#define SWITCHD_MAX_TAP		256
#define SWITCHD_MAX_SESSIONS	0xffff

#define SWITCHD_CTLR_PORT	6633	/* Previously used by OpenFlow */
#define SWITCHD_CTLR_IANA_PORT	6653	/* Assigned by IANA for OpenFlow */

#define SWITCHD_CACHE_MAX	4096	/* Default MAC address cache limit */
#define SWITCHD_CACHE_TIMEOUT	240	/* t/o in seconds for learned MACs */

#define SWITCHD_CONNECT_TIMEOUT	5

#ifndef ETHER_ADDR_LEN
#define ETHER_ADDR_LEN		6
#endif

enum imsg_type {
	IMSG_NONE	= 0,
	IMSG_CTL_VERBOSE,
	IMSG_CTL_PROCFD,
	IMSG_CTL_NOTIFY,
	IMSG_CTL_OK,
	IMSG_CTL_FAIL,
	IMSG_CTL_END,
	IMSG_CTL_RELOAD,
	IMSG_CTL_RESET,
	IMSG_CTL_SWITCH,
	IMSG_CTL_MAC,
	IMSG_CTL_SHOW_SUM,
	IMSG_CTL_CONNECT,
	IMSG_CTL_DISCONNECT,
	IMSG_TAPFD
};

enum privsep_procid {
	PROC_PARENT	= 0,
	PROC_OFP,
	PROC_CONTROL,
	PROC_OFCCONN,
	PROC_MAX
} privsep_process;

enum blockmodes {
	BM_NORMAL,
	BM_NONBLOCK
};

enum flushmode {
	RESET_RELOAD	= 0,
	RESET_ALL
};

enum switch_conn_type {
	SWITCH_CONN_LOCAL,
	SWITCH_CONN_TCP,
	SWITCH_CONN_TLS
};

enum oflowmod_state {
	OFMCTX_INIT,
	OFMCTX_OPEN,
	OFMCTX_MOPEN,
	OFMCTX_MCLOSE,
	OFMCTX_IOPEN,
	OFMCTX_ICLOSE,
	OFMCTX_CLOSE,
	OFMCTX_ERR
};

#ifndef nitems
#define nitems(_a)   (sizeof((_a)) / sizeof((_a)[0]))
#endif

#endif /* SWITCHD_TYPES_H */
@


1.9
log
@Remove leading _ from include guards as this violates the reserved space.
@
text
@d1 1
a1 1
/*	$OpenBSD: types.h,v 1.8 2016/11/17 12:40:56 reyk Exp $	*/
a50 6

struct constmap {
	unsigned int	 cm_type;
	const char	*cm_name;
	const char	*cm_descr;
};
@


1.8
log
@Add an abstraction layer / API to create flows including all matches
and instructions.  This makes it easier to integrate flow features in
switchd and switchctl later.

Written and committed during a long flight.

OK rzalamena@@
@
text
@d1 1
a1 1
/*	$OpenBSD: types.h,v 1.7 2016/10/12 19:07:42 reyk Exp $	*/
d19 2
a20 2
#ifndef _SWITCHD_TYPES_H
#define _SWITCHD_TYPES_H
d115 1
a115 1
#endif /* _SWITCHD_TYPES_H */
@


1.7
log
@Start reworking the "device" support in switchd: Once connected, a
device is just an fd that is connected to a switch, either via TCP or
via /dev/switch.  Change the switchctl from "device add" to "connect"
etc.  This change is an intermediate step towards other changes,
including the configuration grammar, so a few things will be left
undocumented for now.

switchctl(8) examples,
switchctl connect /dev/switch0
switchctl connect /dev/switch0 forward-to 10.1.1.1
switchctl connect 127.0.0.1
switchctl connect 127.0.0.1 forward-to 10.1.1.1
switchctl disconnect /dev/switch0

Discussed with rzalamena@@
@
text
@d1 1
a1 1
/*	$OpenBSD: types.h,v 1.6 2016/10/06 20:27:44 reyk Exp $	*/
d98 11
@


1.6
log
@Switch switchd to the _switchd user.
@
text
@d1 1
a1 1
/*	$OpenBSD: types.h,v 1.5 2016/09/30 12:32:31 reyk Exp $	*/
d46 1
a46 2
#define SWITCHD_OFCCONN_TIMEOUT	20	/* connect timeout for OpenFlow ch. */

d71 2
a72 2
	IMSG_CTL_DEVICE_CONNECT,
	IMSG_CTL_DEVICE_DISCONNECT,
@


1.5
log
@Open next available tap(4) device instead of just tap0
@
text
@d1 1
a1 1
/*	$OpenBSD: types.h,v 1.4 2016/09/30 11:57:57 reyk Exp $	*/
d23 1
a23 1
#define SWITCHD_USER	"_hostapd"
@


1.4
log
@Implement socket server code that properly handles async I/O, partial
messages, multiple messages per buffer and important things like
connection limits and file descriptor accounting.  It works with TCP
connections as well as switch(4).  The ofrelay.c part replaces
networking that was in ofp.c and will soon handle all socket
connections of switchd.  It is called "ofrelay" because it will be
used as client, server, and forwarder.

OK rzalamena@@
@
text
@d1 1
a1 1
/*	$OpenBSD: types.h,v 1.3 2016/09/14 13:46:51 rzalamena Exp $	*/
a32 1
#define SWITCHD_MAX_SESSIONS	0xffff
d37 2
@


1.3
log
@Teach switchd(8) how to fork+exec.

Note: this daemon has the -Wcast-qual compilation flag which trigger a
warning that wasn't enable in httpd(8) or relayd(8). This will be fixed
in a next diff and then synchronized with other daemons.

ok reyk@@
@
text
@d1 1
a1 1
/*	$OpenBSD: types.h,v 1.2 2016/07/19 18:14:08 reyk Exp $	*/
d33 2
d47 1
d72 2
a73 1
	IMSG_CTL_DEVICE_DISCONNECT
@


1.2
log
@The -DNAME=switch flag is an artifact from the PoC when I couldn't
decide on a name.  Remove it and fix the name to switchd now.
@
text
@d1 1
a1 1
/*	$OpenBSD: types.h,v 1.1 2016/07/19 16:54:26 reyk Exp $	*/
d58 1
@


1.1
log
@Import switchd(8), a basic WIP OpenFlow implementation for OpenBSD.

switchd consists of two parts:
1. switchd(8) and switchctl(8), an OpenFlow controller or "vswitch".
2. switch(4), an OpenFlow-aware kernel "bridge".

This the 1st part, the driver will be imported later.  The code will
remain disabled for a while, but it helps development to have it in
the tree.  switchd currently supports partial OpenFlow 1.0, but the
goal is to use OpenFlow 1.3.5 instead (switch(4) already does 1.3.5).

For more background information see:
http://www.openbsd.org/papers/bsdcan2016-switchd.pdf
https://youtu.be/Cuo0qT-lqig

With help from yasuoka@@ goda@@
Import discussed with deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
a25 1
#ifndef SWITCHD_NAME
a26 1
#endif
@

