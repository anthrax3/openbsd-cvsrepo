head	1.17;
access;
symbols
	OPENBSD_6_1:1.17.0.8
	OPENBSD_6_1_BASE:1.17
	OPENBSD_6_0:1.17.0.6
	OPENBSD_6_0_BASE:1.17
	OPENBSD_5_9:1.17.0.2
	OPENBSD_5_9_BASE:1.17
	OPENBSD_5_8:1.16.0.6
	OPENBSD_5_8_BASE:1.16
	OPENBSD_5_7:1.16.0.2
	OPENBSD_5_7_BASE:1.16
	OPENBSD_5_6:1.15.0.22
	OPENBSD_5_6_BASE:1.15
	OPENBSD_5_5:1.15.0.20
	OPENBSD_5_5_BASE:1.15
	OPENBSD_5_4:1.15.0.16
	OPENBSD_5_4_BASE:1.15
	OPENBSD_5_3:1.15.0.14
	OPENBSD_5_3_BASE:1.15
	OPENBSD_5_2:1.15.0.12
	OPENBSD_5_2_BASE:1.15
	OPENBSD_5_1_BASE:1.15
	OPENBSD_5_1:1.15.0.10
	OPENBSD_5_0:1.15.0.8
	OPENBSD_5_0_BASE:1.15
	OPENBSD_4_9:1.15.0.6
	OPENBSD_4_9_BASE:1.15
	OPENBSD_4_8:1.15.0.4
	OPENBSD_4_8_BASE:1.15
	OPENBSD_4_7:1.15.0.2
	OPENBSD_4_7_BASE:1.15
	OPENBSD_4_6:1.14.0.4
	OPENBSD_4_6_BASE:1.14
	OPENBSD_4_5:1.13.0.6
	OPENBSD_4_5_BASE:1.13
	OPENBSD_4_4:1.13.0.4
	OPENBSD_4_4_BASE:1.13
	OPENBSD_4_3:1.13.0.2
	OPENBSD_4_3_BASE:1.13
	OPENBSD_4_2:1.12.0.8
	OPENBSD_4_2_BASE:1.12
	OPENBSD_4_1:1.12.0.6
	OPENBSD_4_1_BASE:1.12
	OPENBSD_4_0:1.12.0.4
	OPENBSD_4_0_BASE:1.12
	OPENBSD_3_9:1.12.0.2
	OPENBSD_3_9_BASE:1.12
	OPENBSD_3_8:1.11.0.16
	OPENBSD_3_8_BASE:1.11
	OPENBSD_3_7:1.11.0.14
	OPENBSD_3_7_BASE:1.11
	OPENBSD_3_6:1.11.0.12
	OPENBSD_3_6_BASE:1.11
	OPENBSD_3_5:1.11.0.10
	OPENBSD_3_5_BASE:1.11
	OPENBSD_3_4:1.11.0.8
	OPENBSD_3_4_BASE:1.11
	OPENBSD_3_3:1.11.0.6
	OPENBSD_3_3_BASE:1.11
	OPENBSD_3_2:1.11.0.4
	OPENBSD_3_2_BASE:1.11
	OPENBSD_3_1:1.11.0.2
	OPENBSD_3_1_BASE:1.11
	OPENBSD_3_0:1.9.0.6
	OPENBSD_3_0_BASE:1.9
	OPENBSD_2_9_BASE:1.9
	OPENBSD_2_9:1.9.0.4
	OPENBSD_2_8:1.9.0.2
	OPENBSD_2_8_BASE:1.9
	OPENBSD_2_7:1.8.0.4
	OPENBSD_2_7_BASE:1.8
	OPENBSD_2_6:1.8.0.2
	OPENBSD_2_6_BASE:1.8
	OPENBSD_2_5:1.6.0.8
	OPENBSD_2_5_BASE:1.6
	OPENBSD_2_4:1.6.0.6
	OPENBSD_2_4_BASE:1.6
	OPENBSD_2_3:1.6.0.4
	OPENBSD_2_3_BASE:1.6
	OPENBSD_2_2:1.6.0.2
	OPENBSD_2_2_BASE:1.6
	OPENBSD_2_1:1.5.0.2
	OPENBSD_2_1_BASE:1.5
	OPENBSD_2_0:1.4.0.2
	OPENBSD_2_0_BASE:1.4
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@ * @;


1.17
date	2015.11.16.00.16.39;	author mmcc;	state Exp;
branches;
next	1.16;
commitid	enjTsnD5UO6xazKc;

1.16
date	2015.01.16.06.40.21;	author deraadt;	state Exp;
branches;
next	1.15;
commitid	Uu5nFG3wCl0LACBb;

1.15
date	2009.10.27.23.59.55;	author deraadt;	state Exp;
branches;
next	1.14;

1.14
date	2009.03.04.16.54.42;	author stevesk;	state Exp;
branches;
next	1.13;

1.13
date	2007.10.07.16.41.05;	author deraadt;	state Exp;
branches;
next	1.12;

1.12
date	2005.12.07.19.53.31;	author otto;	state Exp;
branches;
next	1.11;

1.11
date	2002.02.19.19.39.40;	author millert;	state Exp;
branches;
next	1.10;

1.10
date	2001.11.07.18.48.16;	author deraadt;	state Exp;
branches;
next	1.9;

1.9
date	2000.10.03.14.31.58;	author ho;	state Exp;
branches;
next	1.8;

1.8
date	99.09.16.20.58.47;	author brad;	state Exp;
branches;
next	1.7;

1.7
date	99.07.28.20.41.36;	author jakob;	state Exp;
branches;
next	1.6;

1.6
date	97.07.25.20.12.26;	author mickey;	state Exp;
branches;
next	1.5;

1.5
date	96.12.12.16.22.31;	author bitblt;	state Exp;
branches;
next	1.4;

1.4
date	96.07.13.11.01.26;	author mickey;	state Exp;
branches;
next	1.3;

1.3
date	96.06.10.07.47.43;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	96.03.04.15.59.31;	author mickey;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.48.25;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.48.25;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.17
log
@Remove remaining instances of the register keyword.

ok deraadt@@
@
text
@/*	$OpenBSD: print-ntp.c,v 1.16 2015/01/16 06:40:21 deraadt Exp $	*/

/*
 * Copyright (c) 1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997
 *	The Regents of the University of California.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that: (1) source code distributions
 * retain the above copyright notice and this paragraph in its entirety, (2)
 * distributions including binary code include the above copyright notice and
 * this paragraph in its entirety in the documentation or other materials
 * provided with the distribution, and (3) all advertising materials mentioning
 * features or use of this software display the following acknowledgement:
 * ``This product includes software developed by the University of California,
 * Lawrence Berkeley Laboratory and its contributors.'' Neither the name of
 * the University nor the names of its contributors may be used to endorse
 * or promote products derived from this software without specific prior
 * written permission.
 * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR IMPLIED
 * WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 *
 * Format and print ntp packets.
 *	By Jeffrey Mogul/DECWRL
 *	loosely based on print-bootp.c
 */

#include <sys/time.h>
#include <sys/socket.h>

struct mbuf;
struct rtentry;
#include <net/if.h>

#include <netinet/in.h>
#include <netinet/if_ether.h>

#include <ctype.h>
#include <stdio.h>
#include <string.h>

#include "interface.h"
#include "addrtoname.h"
#ifdef MODEMASK
#undef MODEMASK					/* Solaris sucks */
#endif
#include "ntp.h"

static void p_sfix(const struct s_fixedpt *);
static void p_ntp_time(const struct l_fixedpt *);
static void p_ntp_delta(const struct l_fixedpt *, const struct l_fixedpt *);

/*
 * Print ntp requests
 */
void
ntp_print(const u_char *cp, u_int length)
{
	const struct ntpdata *bp;
	int mode, version, leapind;

	bp = (struct ntpdata *)cp;
	/* Note funny sized packets */
	if (length != sizeof(struct ntpdata))
		(void)printf(" [len=%d]", length);

	TCHECK(bp->status);

	version = (int)(bp->status & VERSIONMASK) >> 3;
	printf(" v%d", version);

	leapind = bp->status & LEAPMASK;
	switch (leapind) {

	case NO_WARNING:
		break;

	case ALARM:
		fputs(" alarm", stdout);
		break;

	case PLUS_SEC:
		fputs(" +1s", stdout);
		break;

	case MINUS_SEC:
		fputs(" -1s", stdout);
		break;
	}

	mode = bp->status & MODEMASK;
	switch (mode) {

	case MODE_UNSPEC:	/* unspecified */
		fputs(" unspec", stdout);
		break;

	case MODE_SYM_ACT:	/* symmetric active */
		fputs(" sym_act", stdout);
		break;

	case MODE_SYM_PAS:	/* symmetric passive */
		fputs(" sym_pas", stdout);
		break;

	case MODE_CLIENT:	/* client */
		fputs(" client", stdout);
		break;

	case MODE_SERVER:	/* server */
		fputs(" server", stdout);
		break;

	case MODE_BROADCAST:	/* broadcast */
		fputs(" bcast", stdout);
		break;

	case MODE_RES1:		/* reserved */
		fputs(" res1", stdout);
		break;

	case MODE_RES2:		/* reserved */
		fputs(" res2", stdout);
		break;

	}

	TCHECK(bp->stratum);
	printf(" strat %d", bp->stratum);

	TCHECK(bp->ppoll);
	printf(" poll %d", bp->ppoll);

	/* Can't TCHECK bp->precision bitfield so bp->distance + 0 instead */
	TCHECK2(bp->distance, 0);
	printf(" prec %d", bp->precision);

	if (!vflag)
		return;

	TCHECK(bp->distance);
	fputs(" dist ", stdout);
	p_sfix(&bp->distance);

	TCHECK(bp->dispersion);
	fputs(" disp ", stdout);
	p_sfix(&bp->dispersion);

	TCHECK(bp->refid);
	fputs(" ref ", stdout);
	/* Interpretation depends on stratum */
	switch (bp->stratum) {

	case UNSPECIFIED:
		printf("(unspec)");
		break;

	case PRIM_REF:
		fn_printn((u_char *)&bp->refid, sizeof(bp->refid), NULL);
		break;

	case INFO_QUERY:
		printf("%s INFO_QUERY", ipaddr_string(&(bp->refid)));
		/* this doesn't have more content */
		return;

	case INFO_REPLY:
		printf("%s INFO_REPLY", ipaddr_string(&(bp->refid)));
		/* this is too complex to be worth printing */
		return;

	default:
		printf("%s", ipaddr_string(&(bp->refid)));
		break;
	}

	TCHECK(bp->reftime);
	putchar('@@');
	p_ntp_time(&(bp->reftime));

	TCHECK(bp->org);
	fputs(" orig ", stdout);
	p_ntp_time(&(bp->org));

	TCHECK(bp->rec);
	fputs(" rec ", stdout);
	p_ntp_delta(&(bp->org), &(bp->rec));

	TCHECK(bp->xmt);
	fputs(" xmt ", stdout);
	p_ntp_delta(&(bp->org), &(bp->xmt));

	return;

trunc:
	fputs(" [|ntp]", stdout);
}

static void
p_sfix(const struct s_fixedpt *sfp)
{
	int i;
	int f;
	float ff;

	i = ntohs(sfp->int_part);
	f = ntohs(sfp->fraction);
	ff = f / 65536.0;	/* shift radix point by 16 bits */
	f = ff * 1000000.0;	/* Treat fraction as parts per million */
	printf("%d.%06d", i, f);
}

#define	FMAXINT	(4294967296.0)	/* floating point rep. of MAXINT */

static void
p_ntp_time(const struct l_fixedpt *lfp)
{
	int32_t i;
	u_int32_t uf;
	u_int32_t f;
	float ff;

	i = ntohl(lfp->int_part);
	uf = ntohl(lfp->fraction);
	ff = uf;
	if (ff < 0.0)		/* some compilers are buggy */
		ff += FMAXINT;
	ff = ff / FMAXINT;	/* shift radix point by 32 bits */
	f = ff * 1000000000.0;	/* treat fraction as parts per billion */
	printf("%u.%09d", i, f);
}

/* Prints time difference between *lfp and *olfp */
static void
p_ntp_delta(const struct l_fixedpt *olfp, const struct l_fixedpt *lfp)
{
	int32_t i;
	u_int32_t uf;
	u_int32_t ouf;
	u_int32_t f;
	float ff;
	int signbit;

	i = ntohl(lfp->int_part) - ntohl(olfp->int_part);

	uf = ntohl(lfp->fraction);
	ouf = ntohl(olfp->fraction);

	if (i > 0) {		/* new is definitely greater than old */
		signbit = 0;
		f = uf - ouf;
		if (ouf > uf)	/* must borrow from high-order bits */
			i -= 1;
	} else if (i < 0) {	/* new is definitely less than old */
		signbit = 1;
		f = ouf - uf;
		if (uf > ouf)	/* must carry into the high-order bits */
			i += 1;
		i = -i;
	} else {		/* int_part is zero */
		if (uf > ouf) {
			signbit = 0;
			f = uf - ouf;
		} else {
			signbit = 1;
			f = ouf - uf;
		}
	}

	ff = f;
	if (ff < 0.0)		/* some compilers are buggy */
		ff += FMAXINT;
	ff = ff / FMAXINT;	/* shift radix point by 32 bits */
	f = ff * 1000000000.0;	/* treat fraction as parts per billion */
	if (signbit)
		putchar('-');
	else
		putchar('+');
	printf("%d.%09d", i, f);
}
@


1.16
log
@Replace <sys/param.h> with <limits.h> and other less dirty headers where
possible.  Annotate <sys/param.h> lines with their current reasons.  Switch
to PATH_MAX, NGROUPS_MAX, HOST_NAME_MAX+1, LOGIN_NAME_MAX, etc.  Change
MIN() and MAX() to local definitions of MINIMUM() and MAXIMUM() where
sensible to avoid pulling in the pollution.  These are the files confirmed
through binary verification.
ok guenther, millert, doug (helped with the verification protocol)
@
text
@d1 1
a1 1
/*	$OpenBSD: print-ntp.c,v 1.15 2009/10/27 23:59:55 deraadt Exp $	*/
d57 1
a57 1
ntp_print(register const u_char *cp, u_int length)
d59 1
a59 1
	register const struct ntpdata *bp;
d200 1
a200 1
p_sfix(register const struct s_fixedpt *sfp)
d202 3
a204 3
	register int i;
	register int f;
	register float ff;
d216 1
a216 1
p_ntp_time(register const struct l_fixedpt *lfp)
d218 4
a221 4
	register int32_t i;
	register u_int32_t uf;
	register u_int32_t f;
	register float ff;
d235 1
a235 2
p_ntp_delta(register const struct l_fixedpt *olfp,
	    register const struct l_fixedpt *lfp)
d237 5
a241 5
	register int32_t i;
	register u_int32_t uf;
	register u_int32_t ouf;
	register u_int32_t f;
	register float ff;
@


1.15
log
@rcsid[] and sccsid[] and copyright[] are essentially unmaintained (and
unmaintainable).  these days, people use source.  these id's do not provide
any benefit, and do hurt the small install media
(the 33,000 line diff is essentially mechanical)
ok with the idea millert, ok dms
@
text
@d1 1
a1 1
/*	$OpenBSD: print-ntp.c,v 1.14 2009/03/04 16:54:42 stevesk Exp $	*/
a27 1
#include <sys/param.h>
@


1.14
log
@print alarm condition from leap indicator; ok henning@@ otto@@
@
text
@d1 1
a1 1
/*	$OpenBSD: print-ntp.c,v 1.13 2007/10/07 16:41:05 deraadt Exp $	*/
a26 5

#ifndef lint
static const char rcsid[] =
    "@@(#) $Id: print-ntp.c,v 1.13 2007/10/07 16:41:05 deraadt Exp $ (LBL)";
#endif
@


1.13
log
@trash $Header goo which is just annoying; 5595
@
text
@d1 1
a1 1
/*	$OpenBSD: print-ntp.c,v 1.12 2005/12/07 19:53:31 otto Exp $	*/
d30 1
a30 1
    "@@(#) $Id$ (LBL)";
d82 4
@


1.12
log
@Do not use strlcpy if the source string is not NUL terminated and
avoid printing funny chars.  Problem spotted by naddy@@ whil tcpdumping
enc0 with malloc.conf AJ; ok canacar@@ on an earlier version.
@
text
@d1 1
a1 1
/*	$OpenBSD: print-ntp.c,v 1.11 2002/02/19 19:39:40 millert Exp $	*/
d30 1
a30 1
    "@@(#) $Header: /cvs/src/usr.sbin/tcpdump/print-ntp.c,v 1.11 2002/02/19 19:39:40 millert Exp $ (LBL)";
@


1.11
log
@We live in an ANSI C world.  Remove lots of gratuitous #ifdef __STDC__ cruft.
@
text
@d1 1
a1 1
/*	$OpenBSD: print-ntp.c,v 1.10 2001/11/07 18:48:16 deraadt Exp $	*/
d30 1
a30 1
    "@@(#) $Header: /cvs/src/usr.sbin/tcpdump/print-ntp.c,v 1.10 2001/11/07 18:48:16 deraadt Exp $ (LBL)";
a66 1
	static char rclock[5];
d161 1
a161 2
		strlcpy(rclock, (char *)&(bp->refid), sizeof(rclock));
		fputs(rclock, stdout);
@


1.10
log
@simplify buffer handling; ok ho
@
text
@d1 1
a1 1
/*	$OpenBSD: print-ntp.c,v 1.9 2000/10/03 14:31:58 ho Exp $	*/
d30 1
a30 1
    "@@(#) $Header: /cvs/src/usr.sbin/tcpdump/print-ntp.c,v 1.9 2000/10/03 14:31:58 ho Exp $ (LBL)";
a36 1
#ifdef __STDC__
a38 1
#endif
@


1.9
log
@Add $OpenBSD$. (jakob@@ ok)
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d30 1
a30 1
    "@@(#) $Header: /cvs/src/usr.sbin/tcpdump/print-ntp.c,v 1.8 1999/09/16 20:58:47 brad Exp $ (LBL)";
d164 1
a164 2
		strncpy(rclock, (char *)&(bp->refid), 4);
		rclock[4] = '\0';
@


1.8
log
@bring more inline with tcpdump 3.4
@
text
@d1 2
d30 1
a30 1
    "@@(#) $Header: /cvs/src/usr.sbin/tcpdump/print-ntp.c,v 1.7 1999/07/28 20:41:36 jakob Exp $ (LBL)";
@


1.7
log
@-  Merge some changes from tcpdump 3.4
   -a flag; attempt to convert network and broadcast addresses to names
   Improved signal handling
   Miscellaneous fixes and typos
   OSPF MD5 authentication support

-  -X flag; emacs-hexl print (including ascii)

-  Add ECN bits to TCP and IP headers

-  IKE & IPsec (ESP & AH) support

OK deraadt@@
@
text
@d2 1
a2 1
 * Copyright (c) 1990, 1991, 1992, 1993, 1994, 1995, 1996
d28 1
a28 1
    "@@(#) $Header: /cvs/src/usr.sbin/tcpdump/print-ntp.c,v 1.6 1997/07/25 20:12:26 mickey Exp $ (LBL)";
@


1.6
log
@#if __STDC__ --> #ifdef __STDC__
@
text
@d28 1
a28 1
    "@@(#) $Header: /cvs/src/usr.sbin/tcpdump/print-ntp.c,v 1.5 1996/12/12 16:22:31 bitblt Exp $ (LBL)";
d50 1
d52 1
@


1.5
log
@*** empty log message ***
@
text
@d28 1
a28 1
    "@@(#) $Header: print-ntp.c,v 1.25 96/11/05 13:30:37 leres Exp $ (LBL)";
d35 1
a35 1
#if __STDC__
@


1.4
log
@it is 3.2 now.
@
text
@a0 2
/*	$OpenBSD$	*/

d27 2
a28 2
static char rcsid[] =
    "@@(#) Header: print-ntp.c,v 1.20 96/06/23 02:11:46 leres Exp (LBL)";
a32 1
#include <sys/types.h>
d61 1
a61 1
ntp_print(register const u_char *cp, int length)
a63 1
	register const u_char *ep;
a66 2
#define TCHECK(var, l) if ((u_char *)&(var) > ep - l) goto trunc

d72 1
a72 4
	/* 'ep' points to the end of available data. */
	ep = snapend;

	TCHECK(bp->status, sizeof(bp->status));
d74 1
a74 1
	version = (bp->status & VERSIONMASK) >> 3;
d129 1
a129 1
	TCHECK(bp->stratum, sizeof(bp->stratum));
d132 1
a132 1
	TCHECK(bp->ppoll, sizeof(bp->ppoll));
d136 1
a136 1
	TCHECK(bp->distance, 0);
d142 1
a142 1
	TCHECK(bp->distance, sizeof(bp->distance));
d146 1
a146 1
	TCHECK(bp->dispersion, sizeof(bp->dispersion));
d150 1
a150 1
	TCHECK(bp->refid, sizeof(bp->refid));
d180 1
a180 1
	TCHECK(bp->reftime, sizeof(bp->reftime));
d184 1
a184 1
	TCHECK(bp->org, sizeof(bp->org));
d188 1
a188 1
	TCHECK(bp->rec, sizeof(bp->rec));
d192 1
a192 1
	TCHECK(bp->xmt, sizeof(bp->xmt));
a199 1
#undef TCHECK
@


1.3
log
@sync to latest
@
text
@d1 1
a1 2
/**//*	$OpenBSD: print-ntp.c,v 1.2 1995/03/06 19:11:22 mycroft Exp $	*/
/*	$NetBSD: print-ntp.c,v 1.2 1995/03/06 19:11:22 mycroft Exp $	*/
d4 1
a4 1
 * Copyright (c) 1990, 1991, 1992, 1993, 1994
d30 1
a30 1
    "@@(#) Header: print-ntp.c,v 1.14 94/06/14 20:18:46 leres Exp (LBL)";
d38 4
d78 1
a78 1
	/* 'ep' points to the end of avaible data. */
d165 3
d231 3
a233 3
	register int32 i;
	register u_int32 uf;
	register u_int32 f;
d243 1
a243 1
	printf("%lu.%09d", i, f);
d251 4
a254 4
	register int32 i;
	register u_int32 uf;
	register u_int32 ouf;
	register u_int32 f;
@


1.2
log
@Updating to the latest LBL release.
Sun's SKIP support added.
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
@


1.1
log
@Initial revision
@
text
@d1 1
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
