head	1.3;
access;
symbols
	OPENBSD_6_1:1.3.0.4
	OPENBSD_6_1_BASE:1.3
	OPENBSD_6_0:1.2.0.2
	OPENBSD_6_0_BASE:1.2
	OPENBSD_5_9:1.1.1.2.0.6
	OPENBSD_5_9_BASE:1.1.1.2
	NSD_4_1_6:1.1.1.2
	OPENBSD_5_8:1.1.1.2.0.8
	OPENBSD_5_8_BASE:1.1.1.2
	NSD_4_1_3:1.1.1.2
	OPENBSD_5_7:1.1.1.2.0.2
	OPENBSD_5_7_BASE:1.1.1.2
	NSD_4_1_1:1.1.1.2
	NSD_4_1_0:1.1.1.2
	OPENBSD_5_6:1.1.1.2.0.4
	OPENBSD_5_6_BASE:1.1.1.2
	NSD_4_0_3:1.1.1.2
	NSD_4_0_2:1.1.1.2
	OPENBSD_5_5:1.1.1.1.0.4
	OPENBSD_5_5_BASE:1.1.1.1
	NSD_4_0_1:1.1.1.1
	NSD_4_0_0:1.1.1.1
	NLNETLABS:1.1.1;
locks; strict;
comment	@ * @;


1.3
date	2017.02.17.20.04.45;	author florian;	state Exp;
branches;
next	1.2;
commitid	WmSuN5M3Jbe54113;

1.2
date	2016.06.24.08.34.03;	author florian;	state Exp;
branches;
next	1.1;
commitid	Z9jVKJJMPmC3zw2t;

1.1
date	2013.11.26.12.50.10;	author sthen;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2013.11.26.12.50.10;	author sthen;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2014.03.13.02.00.22;	author brad;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Update to 4.1.15.
This contains a local patch to query.c (missed _t conversion) that has
been submitted upstream.
OK sthen
@
text
@/*
 * udbzone -- store zone and rrset information in udb file.
 *
 * Copyright (c) 2011, NLnet Labs.  See LICENSE for license.
 */
#ifndef UDB_ZONE_H
#define UDB_ZONE_H
#include "udb.h"
#include "dns.h"
#include "udbradtree.h"

/**
 * Store the DNS information in udb file on disk.
 * udb_global
 *     |
 *     v
 * zonetree -> zone -- zone_name
 * radtree       |--> nsec3param
 *               |--> log_str
 *               |--> file_str
 *               |
 *               v
 *            domain --> rrset -> rr
 *            radtree    list     list
 *            |-- name
 */

/** zone information in the nsd.udb.  Name allocated after it. */
struct zone_d {
	/** radtree node in the zonetree for this zone */
	udb_rel_ptr node;
	/** the radtree for the domain names in the zone */
	udb_rel_ptr domains;
	/** the NSEC3PARAM rr used for hashing (or 0), rr_d pointer */
	udb_rel_ptr nsec3param;
	/** the log_str for the AXFR change, or 0 */
	udb_rel_ptr log_str;
	/** the file name when read from a file, or 0 */
	udb_rel_ptr file_str;
	/** modification time, time when the zone data was changed */
	uint64_t mtime;
	/** modification time, nsecs */
	uint64_t mtime_nsec;
	/** number of RRsets in the zone */
	uint64_t rrset_count;
	/** number of RRs in the zone */
	uint64_t rr_count;
	/** the length of the zone name */
	udb_radstrlen_type namelen;
	/** if the zone is expired */
	uint8_t expired;
	/** if the zone has been changed by AXFR */
	uint8_t is_changed;
	/** the zone (wire uncompressed) name in DNS format */
	uint8_t name[0];
};

/** domain name in the nametree. name allocated after it */
struct domain_d {
	/** radtree node in the nametree for this domain */
	udb_rel_ptr node;
	/** the list of rrsets for this name, single linked */
	udb_rel_ptr rrsets;
	/** length of the domain name */
	udb_radstrlen_type namelen;
	/** the domain (wire uncompressed) name in DNS format */
	uint8_t name[0];
};

/** rrset information. */
struct rrset_d {
	/** next in rrset list */
	udb_rel_ptr next;
	/** the singly linked list of rrs for this rrset */
	udb_rel_ptr rrs;
	/** type of the RRs in this rrset (host order) */
	uint16_t type;
};

/** rr information; wireformat data allocated after it */
struct rr_d {
	/** next in rr list */
	udb_rel_ptr next;
	/** type (host order) */
	uint16_t type;
	/** class (host order) */
	uint16_t klass;
	/** ttl (host order) */
	uint32_t ttl;
	/** length of wireformat */
	uint16_t len;
	/** wireformat of rdata (without rdatalen) */
	uint8_t wire[0];
};

/** init an udb for use as DNS store */
int udb_dns_init_file(udb_base* udb);
/** de-init an udb for use as DNS store */
void udb_dns_deinit_file(udb_base* udb);

/** create a zone */
int udb_zone_create(udb_base* udb, udb_ptr* result, const uint8_t* dname,
	size_t dlen);
/** clear all RRsets from a zone */
void udb_zone_clear(udb_base* udb, udb_ptr* zone);
/** delete a zone */
void udb_zone_delete(udb_base* udb, udb_ptr* zone);
/** find a zone by name (exact match) */
int udb_zone_search(udb_base* udb, udb_ptr* result, const uint8_t* dname,
	size_t dlen);
/** get modification time for zone or 0 */
void udb_zone_get_mtime(udb_base* udb, const uint8_t* dname, size_t dlen,
	struct timespec* mtime);
/** set log str in udb, or remove it */
void udb_zone_set_log_str(udb_base* udb, udb_ptr* zone, const char* str);
/** set file str in udb, or remove it */
void udb_zone_set_file_str(udb_base* udb, udb_ptr* zone, const char* str);
/** get file string for zone or NULL */
const char* udb_zone_get_file_str(udb_base* udb, const uint8_t* dname,
	size_t dlen);
/** find a domain name in the zone domain tree */
int udb_domain_find(udb_base* udb, udb_ptr* zone, const uint8_t* nm,
	size_t nmlen, udb_ptr* result);
/** find rrset in domain */
int udb_rrset_find(udb_base* udb, udb_ptr* domain, uint16_t t, udb_ptr* res);

/** add an RR to a zone */
int udb_zone_add_rr(udb_base* udb, udb_ptr* zone, const uint8_t* nm,
	size_t nmlen, uint16_t t, uint16_t k, uint32_t ttl, uint8_t* rdata,
	size_t rdatalen);
/** del an RR from a zone */
void udb_zone_del_rr(udb_base* udb, udb_ptr* zone, const uint8_t* nm,
	size_t nmlen, uint16_t t, uint16_t k, uint8_t* rdata, size_t rdatalen);

/** get pretty string for nsec3parameters (static buffer returned) */
const char* udb_nsec3param_string(udb_ptr* rr);

/** for use in udb-walkfunc, walks relptrs in udb_chunk_type_zone */
void udb_zone_walk_chunk(void* base, void* d, uint64_t s,
	udb_walk_relptr_cb* cb, void* arg);
/** for use in udb-walkfunc, walks relptrs in udb_chunk_type_domain */
void udb_domain_walk_chunk(void* base, void* d, uint64_t s,
	udb_walk_relptr_cb* cb, void* arg);
/** for use in udb-walkfunc, walks relptrs in udb_chunk_type_rrset */
void udb_rrset_walk_chunk(void* base, void* d, uint64_t s,
	udb_walk_relptr_cb* cb, void* arg);
/** for use in udb-walkfunc, walks relptrs in udb_chunk_type_rr */
void udb_rr_walk_chunk(void* base, void* d, uint64_t s,
	udb_walk_relptr_cb* cb, void* arg);

/** walk through relptrs in registered types */
void namedb_walkfunc(void* base, void* warg, uint8_t t, void* d, uint64_t s,
        udb_walk_relptr_cb* cb, void* arg);

#define ZONE(ptr) ((struct zone_d*)UDB_PTR(ptr))
#define DOMAIN(ptr) ((struct domain_d*)UDB_PTR(ptr))
#define RRSET(ptr) ((struct rrset_d*)UDB_PTR(ptr))
#define RR(ptr) ((struct rr_d*)UDB_PTR(ptr))

#endif /* UDB_ZONE_H */
@


1.2
log
@Update to 4.1.10
Testing by millert@@, sthen@@ and me.
came up with the same diff & OK sthen@@
@
text
@d49 1
a49 1
	udb_radstrlen_t namelen;
d65 1
a65 1
	udb_radstrlen_t namelen;
@


1.1
log
@Initial revision
@
text
@d18 4
a21 1
 * radtree       |
d38 2
d42 2
d112 2
a113 1
uint64_t udb_zone_get_mtime(udb_base* udb, const uint8_t* dname, size_t dlen);
d116 5
@


1.1.1.1
log
@import NSD 4.0.0, tests from Dorian BÃ¼ttner, Patrik Lundin, requested by brad@@
@
text
@@


1.1.1.2
log
@update to NSD 4.0.2, ok sthen@@
@
text
@d18 1
a18 4
 * radtree       |--> nsec3param
 *               |--> log_str
 *               |--> file_str
 *               |
a34 2
	/** the file name when read from a file, or 0 */
	udb_rel_ptr file_str;
a107 5
/** set file str in udb, or remove it */
void udb_zone_set_file_str(udb_base* udb, udb_ptr* zone, const char* str);
/** get file string for zone or NULL */
const char* udb_zone_get_file_str(udb_base* udb, const uint8_t* dname,
	size_t dlen);
@

