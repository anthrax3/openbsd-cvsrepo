head	1.13;
access;
symbols
	OPENBSD_6_2:1.13.0.10
	OPENBSD_6_2_BASE:1.13
	OPENBSD_6_1:1.13.0.8
	OPENBSD_6_1_BASE:1.13
	OPENBSD_6_0:1.13.0.4
	OPENBSD_6_0_BASE:1.13
	OPENBSD_5_9:1.13.0.2
	OPENBSD_5_9_BASE:1.13
	OPENBSD_5_8:1.11.0.6
	OPENBSD_5_8_BASE:1.11
	OPENBSD_5_7:1.11.0.2
	OPENBSD_5_7_BASE:1.11
	OPENBSD_5_6:1.8.0.22
	OPENBSD_5_6_BASE:1.8
	OPENBSD_5_5:1.8.0.20
	OPENBSD_5_5_BASE:1.8
	OPENBSD_5_4:1.8.0.16
	OPENBSD_5_4_BASE:1.8
	OPENBSD_5_3:1.8.0.14
	OPENBSD_5_3_BASE:1.8
	OPENBSD_5_2:1.8.0.12
	OPENBSD_5_2_BASE:1.8
	OPENBSD_5_1_BASE:1.8
	OPENBSD_5_1:1.8.0.10
	OPENBSD_5_0:1.8.0.8
	OPENBSD_5_0_BASE:1.8
	OPENBSD_4_9:1.8.0.6
	OPENBSD_4_9_BASE:1.8
	OPENBSD_4_8:1.8.0.4
	OPENBSD_4_8_BASE:1.8
	OPENBSD_4_7:1.8.0.2
	OPENBSD_4_7_BASE:1.8
	OPENBSD_4_6:1.7.0.24
	OPENBSD_4_6_BASE:1.7
	OPENBSD_4_5:1.7.0.20
	OPENBSD_4_5_BASE:1.7
	OPENBSD_4_4:1.7.0.18
	OPENBSD_4_4_BASE:1.7
	OPENBSD_4_3:1.7.0.16
	OPENBSD_4_3_BASE:1.7
	OPENBSD_4_2:1.7.0.14
	OPENBSD_4_2_BASE:1.7
	OPENBSD_4_1:1.7.0.12
	OPENBSD_4_1_BASE:1.7
	OPENBSD_4_0:1.7.0.10
	OPENBSD_4_0_BASE:1.7
	OPENBSD_3_9:1.7.0.8
	OPENBSD_3_9_BASE:1.7
	OPENBSD_3_8:1.7.0.6
	OPENBSD_3_8_BASE:1.7
	OPENBSD_3_7:1.7.0.4
	OPENBSD_3_7_BASE:1.7
	OPENBSD_3_6:1.7.0.2
	OPENBSD_3_6_BASE:1.7
	OPENBSD_3_5:1.6.0.6
	OPENBSD_3_5_BASE:1.6
	OPENBSD_3_4:1.6.0.4
	OPENBSD_3_4_BASE:1.6
	OPENBSD_3_3:1.6.0.2
	OPENBSD_3_3_BASE:1.6
	OPENBSD_3_2:1.5.0.2
	OPENBSD_3_2_BASE:1.5
	OPENBSD_3_1:1.3.0.6
	OPENBSD_3_1_BASE:1.3
	OPENBSD_3_0:1.3.0.4
	OPENBSD_3_0_BASE:1.3
	OPENBSD_2_9_BASE:1.3
	OPENBSD_2_9:1.3.0.2
	OPENBSD_2_8:1.2.0.16
	OPENBSD_2_8_BASE:1.2
	OPENBSD_2_7:1.2.0.14
	OPENBSD_2_7_BASE:1.2
	OPENBSD_2_6:1.2.0.12
	OPENBSD_2_6_BASE:1.2
	OPENBSD_2_5:1.2.0.10
	OPENBSD_2_5_BASE:1.2
	OPENBSD_2_4:1.2.0.8
	OPENBSD_2_4_BASE:1.2
	OPENBSD_2_3:1.2.0.6
	OPENBSD_2_3_BASE:1.2
	OPENBSD_2_2:1.2.0.4
	OPENBSD_2_2_BASE:1.2
	OPENBSD_2_1:1.2.0.2
	OPENBSD_2_1_BASE:1.2
	OPENBSD_2_0:1.1.1.1.0.2
	OPENBSD_2_0_BASE:1.1.1.1
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@ * @;


1.13
date	2015.11.09.01.12.27;	author millert;	state Exp;
branches;
next	1.12;
commitid	NbIbD3dCbvLEHSye;

1.12
date	2015.11.04.20.28.17;	author millert;	state Exp;
branches;
next	1.11;
commitid	6N0oXtYc5KM1a7DW;

1.11
date	2015.02.09.22.35.08;	author deraadt;	state Exp;
branches;
next	1.10;
commitid	eGq01x6bjr83TVho;

1.10
date	2015.01.23.19.07.27;	author tedu;	state Exp;
branches;
next	1.9;
commitid	YJA2vmvfLuMfGdwZ;

1.9
date	2015.01.22.22.38.55;	author tedu;	state Exp;
branches;
next	1.8;
commitid	F47ioXLOlSmeY3jW;

1.8
date	2009.10.27.23.59.51;	author deraadt;	state Exp;
branches;
next	1.7;

1.7
date	2004.06.17.22.11.55;	author millert;	state Exp;
branches;
next	1.6;

1.6
date	2003.02.20.20.38.08;	author millert;	state Exp;
branches;
next	1.5;

1.5
date	2002.07.11.20.15.40;	author millert;	state Exp;
branches;
next	1.4;

1.4
date	2002.07.08.18.11.02;	author millert;	state Exp;
branches;
next	1.3;

1.3
date	2001.02.18.19.48.35;	author millert;	state Exp;
branches;
next	1.2;

1.2
date	96.11.01.23.27.36;	author millert;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.47.30;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.47.30;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.13
log
@queue(3) instead of homegrown queues and lists.  This also fixes
some potential memory leaks in error paths.  OK guenther@@
@
text
@/*	$OpenBSD: job.c,v 1.12 2015/11/04 20:28:17 millert Exp $	*/

/* Copyright 1988,1990,1993,1994 by Paul Vixie
 * Copyright (c) 2004 by Internet Systems Consortium, Inc. ("ISC")
 * Copyright (c) 1997,2000 by Internet Software Consortium, Inc.
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT
 * OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#include <sys/types.h>

#include <bitstring.h>		/* for structs.h */
#include <stdio.h>
#include <stdlib.h>
#include <time.h>		/* for structs.h */

#include "macros.h"
#include "structs.h"
#include "funcs.h"

typedef	struct _job {
	SIMPLEQ_ENTRY(_job) entries;
	entry		*e;
	user		*u;
} job;


static SIMPLEQ_HEAD(job_queue, _job) jobs = SIMPLEQ_HEAD_INITIALIZER(jobs);

void
job_add(entry *e, user *u)
{
	job *j;

	/* if already on queue, keep going */
	SIMPLEQ_FOREACH(j, &jobs, entries)
		if (j->e == e && j->u == u)
			return;

	/* build a job queue element */
	if ((j = malloc(sizeof(job))) == NULL)
		return;
	j->e = e;
	j->u = u;

	/* add it to the tail */
	SIMPLEQ_INSERT_TAIL(&jobs, j, entries);
}

int
job_runqueue(void)
{
	job *j;
	int run = 0;

	while ((j = SIMPLEQ_FIRST(&jobs))) {
		SIMPLEQ_REMOVE_HEAD(&jobs, entries);
		do_command(j->e, j->u);
		free(j);
		run++;
	}
	return (run);
}
@


1.12
log
@Change cron from including all headers in every file to only including
what each .c file needs.  I have not removed cron.h since it will
be used in a future clean up of the cron's .h files.  OK nicm@@
@
text
@d1 1
a1 1
/*	$OpenBSD: job.c,v 1.11 2015/02/09 22:35:08 deraadt Exp $	*/
d32 1
a32 1
	struct _job	*next;
d37 2
a38 1
static job	*jhead = NULL, *jtail = NULL;
d46 1
a46 1
	for (j = jhead; j != NULL; j = j->next)
a52 1
	j->next = NULL;
d57 1
a57 5
	if (jhead == NULL)
		jhead = j;
	else
		jtail->next = j;
	jtail = j;
d63 1
a63 1
	job *j, *jn;
d66 2
a67 1
	for (j = jhead; j; j = jn) {
a68 1
		jn = j->next;
a71 1
	jhead = jtail = NULL;
@


1.11
log
@correct copyright, upon approval from paul vixie via todd miller.  the
head copyright assertion was seperated from the remaining ones.
@
text
@d1 1
a1 1
/*	$OpenBSD: job.c,v 1.10 2015/01/23 19:07:27 tedu Exp $	*/
d20 10
a29 1
#include "cron.h"
@


1.10
log
@braces to open a function go on their own line like god intended
@
text
@d1 1
a1 1
/*	$OpenBSD: job.c,v 1.9 2015/01/22 22:38:55 tedu Exp $	*/
a3 4
 * All rights reserved
 */

/*
@


1.9
log
@delete useless casts. ok deraadt guenther millert
@
text
@d1 1
a1 1
/*	$OpenBSD: job.c,v 1.8 2009/10/27 23:59:51 deraadt Exp $	*/
d35 2
a36 1
job_add(entry *e, user *u) {
d60 2
a61 1
job_runqueue(void) {
@


1.8
log
@rcsid[] and sccsid[] and copyright[] are essentially unmaintained (and
unmaintainable).  these days, people use source.  these id's do not provide
any benefit, and do hurt the small install media
(the 33,000 line diff is essentially mechanical)
ok with the idea millert, ok dms
@
text
@d1 1
a1 1
/*	$OpenBSD: job.c,v 1.7 2004/06/17 22:11:55 millert Exp $	*/
d44 1
a44 1
	if ((j = (job *)malloc(sizeof(job))) == NULL)
@


1.7
log
@UUpdate ISC copyright year to 2004
Remove unused macros Skip_Line and MkLower
Remove trailing whitespace
@
text
@d1 1
a1 1
/*	$OpenBSD: job.c,v 1.6 2003/02/20 20:38:08 millert Exp $	*/
a22 4

#if !defined(lint) && !defined(LINT)
static char const rcsid[] = "$OpenBSD: job.c,v 1.6 2003/02/20 20:38:08 millert Exp $";
#endif
@


1.6
log
@Sync with ISC cron-current + my at(1) integration.
The at(1) code is now more tightly integrated into the cron codebase.
@
text
@d1 1
a1 1
/*	$OpenBSD: job.c,v 1.5 2002/07/11 20:15:40 millert Exp $	*/
d8 1
d15 7
a21 8
 * THE SOFTWARE IS PROVIDED "AS IS" AND INTERNET SOFTWARE CONSORTIUM DISCLAIMS
 * ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL INTERNET SOFTWARE
 * CONSORTIUM BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
 * DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
 * PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS
 * ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS
 * SOFTWARE.
d25 1
a25 1
static char const rcsid[] = "$OpenBSD: job.c,v 1.5 2002/07/11 20:15:40 millert Exp $";
@


1.5
log
@More syncing with my cron 4.0 patch tree, basically cosmetic:
o change an instance of e_none to e_memory that I missed (forgot?)
o kill some whitespace
o modify malloc failure recovery a bit
@
text
@d1 2
a2 1
/*	$OpenBSD: job.c,v 1.4 2002/07/08 18:11:02 millert Exp $	*/
d25 1
a25 1
static char const rcsid[] = "$OpenBSD: job.c,v 1.4 2002/07/08 18:11:02 millert Exp $";
@


1.4
log
@Merge in some changes from Paul Vixie's tree; most are cosmetic
o ANSI function headers
o return (foo) not return foo
o add -oi to sendmail flags
o update email address in man pages
o make some strings const
o completely remove globbing cruft from popen.c
o whitespace changes
o add DOW_STAR to flags for "monthly", "weekly", and "daily" cron entries
@
text
@d1 1
a1 1
/*	$OpenBSD: job.c,v 1.3 2001/02/18 19:48:35 millert Exp $	*/
d24 1
a24 1
static char const rcsid[] = "$OpenBSD: job.c,v 1.3 2001/02/18 19:48:35 millert Exp $";
d47 1
a47 1
	if ((j = (job*)malloc(sizeof(job))) == NULL)
d49 1
a49 1
	j->next = (job*) NULL;
@


1.3
log
@Update to ISC cron 4.0b1 + our patches.  This is now under a BSD license.
I also fixed the signal handlers while I was at it.
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d24 1
a24 1
static char rcsid[] = "$OpenBSD: job.c,v 1.3 2000/01/02 20:53:43 vixie Exp $";
a26 1

a28 1

a34 1

a36 1

d38 1
a38 4
job_add(e, u)
	entry *e;
	user *u;
{
a60 1

d62 3
a64 4
job_runqueue()
{
	job	*j, *jn;
	int	run = 0;
@


1.2
log
@Check malloc/strdup ret val and deal.
@
text
@d1 1
d4 4
d9 3
a11 8
 * Distribute freely, except: don't remove my name from the source or
 * documentation (don't take credit for my work), mark your changes (don't
 * get me blamed for your possible bugs), don't alter or remove this
 * notice.  May be sold if buildable source is provided to buyer.  No
 * warrantee of any kind, express or implied, is included with this
 * software; use at your own risk, responsibility for damages (if any) to
 * anyone resulting from the use of this software rests entirely with the
 * user.
d13 8
a20 3
 * Send bug reports, bug fixes, enhancements, requests, flames, etc., and
 * I'll try to keep a version up to date.  I can be reached as follows:
 * Paul Vixie          <paul@@vix.com>          uunet!decwrl!vixie!paul
d24 1
a24 1
static char rcsid[] = "$Id: job.c,v 1.1.1.1 1995/10/18 08:47:30 deraadt Exp $";
d43 2
a44 2
	register entry *e;
	register user *u;
d46 1
a46 1
	register job *j;
d49 3
a51 2
	for (j=jhead; j; j=j->next)
		if (j->e == e && j->u == u) { return; }
d61 4
a64 2
	if (!jhead) { jhead=j; }
	else { jtail->next=j; }
d72 2
a73 2
	register job	*j, *jn;
	register int	run = 0;
d75 1
a75 1
	for (j=jhead; j; j=jn) {
d82 1
a82 1
	return run;
@


1.1
log
@Initial revision
@
text
@d19 1
a19 1
static char rcsid[] = "$Id: job.c,v 1.1.1.3 1994/01/20 02:47:28 jtc Exp $";
d48 2
a49 1
	j = (job*)malloc(sizeof(job));
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
