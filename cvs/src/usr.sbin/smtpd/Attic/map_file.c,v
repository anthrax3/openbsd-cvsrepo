head	1.3;
access;
symbols;
locks; strict;
comment	@ * @;


1.3
date	2013.01.26.09.42.46;	author gilles;	state dead;
branches;
next	1.2;

1.2
date	2012.11.12.14.58.53;	author eric;	state Exp;
branches;
next	1.1;

1.1
date	2012.10.14.11.58.23;	author gilles;	state Exp;
branches;
next	;


desc
@@


1.3
log
@these are no longer used, maps were replaced with something better
@
text
@/*	$OpenBSD: map_file.c,v 1.2 2012/11/12 14:58:53 eric Exp $	*/

/*
 * Copyright (c) 2012 Gilles Chehade <gilles@@openbsd.org>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#include <sys/types.h>
#include <sys/queue.h>
#include <sys/tree.h>
#include <sys/param.h>
#include <sys/socket.h>
#include <sys/stat.h>

#include <ctype.h>
#include <err.h>
#include <errno.h>
#include <event.h>
#include <fcntl.h>
#include <imsg.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#include "smtpd.h"
#include "log.h"

/* file backend */
static void *map_file_open(struct map *);
static void  map_file_update(struct map *);
static void *map_file_lookup(void *, const char *, enum map_kind);
static int   map_file_compare(void *, const char *, enum map_kind,
    int (*)(const char *, const char *));
static void  map_file_close(void *);

struct map_backend *map_backend_lookup(enum map_src);

struct map_backend map_backend_file = {
	map_file_open,
	map_file_update,
	map_file_close,
	map_file_lookup,
	map_file_compare
};

static void
file_load(struct map *m, FILE *fp)
{
	char *buf, *lbuf;
	size_t flen;
	char *keyp;
	char *valp;

	lbuf = NULL;
	while ((buf = fgetln(fp, &flen))) {
		if (buf[flen - 1] == '\n')
			buf[flen - 1] = '\0';
		else {
			lbuf = xmalloc(flen + 1, "map_stdio_get_entry");
			memcpy(lbuf, buf, flen);
			lbuf[flen] = '\0';
			buf = lbuf;
		}
		
		keyp = buf;
		while (isspace((int)*keyp))
			++keyp;
		if (*keyp == '\0' || *keyp == '#')
			continue;		
		valp = keyp;
		strsep(&valp, " \t:");
		if (valp) {
			while (*valp && isspace(*valp))
				++valp;
			if (*valp == '\0')
				valp = NULL;
		}
		map_add(m, keyp, valp == keyp ? NULL : valp);
	}
	free(lbuf);
}


static void *
map_file_open(struct map *map)
{
	FILE		*fp = NULL;
	struct map	*mp = NULL;

	if (map->m_handle)
		return map->m_handle;

	mp = map_create(S_NONE, NULL);

	fp = fopen(map->m_config, "r");
	if (fp == NULL)
		goto err;
	file_load(mp, fp);
	fclose(fp);

	map->m_handle = mp;

	log_debug("debug: map_file_open: initialized map \"%s\" from %s",
	    map->m_name, map->m_config);

	return mp;

err:
	if (mp)
		map_destroy(mp);

	if (fp)
		fclose(fp);

	return NULL;	
}

static void
map_file_update(struct map *map)
{
	FILE		*fp = NULL;
	struct map	*mp = NULL;

	fp = fopen(map->m_config, "r");
	if (fp == NULL) {
		log_warn("warn: Could not update map \"%s\" from %s",
		    map->m_name, map->m_config);
		return;
	}

	mp = map_create(S_NONE, NULL);
	file_load(mp, fp);
	fclose(fp);

	if (map->m_handle != NULL) {
		map_destroy(map->m_handle);
		map->m_handle = NULL;
	}

	map->m_handle = mp;
	log_info("info: Updated map \"%s\" from %s", map->m_name, map->m_config);
}

static void
map_file_close(void *hdl)
{
	/* ignore */
}

static void *
map_file_lookup(void *hdl, const char *key, enum map_kind kind)
{
	struct map		*mp = hdl;

	return map_lookup(mp->m_id, key, kind);
}

static int
map_file_compare(void *hdl, const char *key, enum map_kind kind,
    int (*func)(const char *, const char *))
{
	struct map		*mp = hdl;

	return map_compare(mp->m_id, key, kind, func);
}
@


1.2
log
@Cleanups and improvements:

* Log more events (especially client session) and use a better scheme
  for that: each messages is prefixed with a token to easily identify
  its class:
    - info/warn/debug: general server messages
    - smtp-in: smtp client connections
    - relay: status update for relayed messages
    - delivery: status update for local deliveries

* Implement "smtpctl monitor" to display updates of selected internal
  counters.

* When reloading the on-disk queue at startup do not commit a message
  if no envelope was submitted for that message.

* Remove unused stuff in the config parser.

ok gilles@@
@
text
@d1 1
a1 1
/*	$OpenBSD: map_file.c,v 1.1 2012/10/14 11:58:23 gilles Exp $	*/
@


1.1
log
@introduce map_file.c which will deprecate map_stdio.c

The idea is to have a file-backed map but to have smtpd(8) cache the maps
so that it cannot be partially read if edited while mail is received. The
file is read and converted to a static map (map_static.c), changes aren't
visible to smtpd until an explicit: smtpctl update map  which reads file,
builds a new static map and invalidates the former.

partial-read issue discussed with beck@@ and halex@@
idea to convert internally to a static map by eric@@

diff ok eric@@ and chl@@
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d115 1
a115 1
	log_info("map_file_open: initialized map \"%s\" from %s",
d138 2
a139 2
		log_info("map_file_update: could not update map \"%s\" from %s: %s",
		    map->m_name, map->m_config, strerror(errno));
d153 1
a153 2
	log_info("map_file_update: updated map \"%s\" from %s",
	    map->m_name, map->m_config);
@

