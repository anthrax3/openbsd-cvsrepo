head	1.3;
access;
symbols
	OPENBSD_4_5:1.2.0.2
	OPENBSD_4_5_BASE:1.2;
locks; strict;
comment	@# @;


1.3
date	2009.03.16.20.39.41;	author gilles;	state dead;
branches;
next	1.2;

1.2
date	2008.11.02.08.19.13;	author jmc;	state Exp;
branches;
next	1.1;

1.1
date	2008.11.01.21.35.28;	author gilles;	state Exp;
branches;
next	;


desc
@@


1.3
log
@this file has been deprecated for a while and will not be updated, so
lets just remove it as some people may believe it actually describes
the architecture ...
@
text
@+==============================+
|The SMTP Daemon Architecture  |
+==============================+

Introduction
------------

The SMTP daemon is a complete mail architecture designed to provide
an MTA and MDA for OpenBSD systems (and others!).

The SMTP daemon is configurable through a simple pf-like syntax to
select external or local delivery and the means to do so.

The SMTP Daemon relies on a fully asynchronous and event based data
transfer model. The IMSG pseudo-protocol is used throughout the daemon
to provide communication between separate privilege-separated
processes.

The following processes are currently implemented:

	* smtp:		The unprivileged SMTP server
	* mfa:		Mail filter agent
	* queue:	A queue scheduler
	* mda:		Local mail delivery agent
	* mta:		Remote mail delivery agent
	* lka:		Lookup agent: handles DNS, db, file and external maps
	* control:	External interaction gateway

The SMTP Server
---------------

The SMTP Server conforms to RFC 5321 and also provides interesting
extensions such as STARTTLS (RFC 2487).


The Mail Filter Agent
---------------------

The mail filter agent has two roles. First it decides if a mail is
allowed to be delivered by the daemon, and then performs resolution
to determine the delivery method that applies to the mail, either
local or remote. The second duty is to perform optional modifications
on the envelope content.


WorkFlow
--------

The base structure that traverses most of smtpd's architecture is a
struct msg. The typical workflow is as shown below from left to right:

+------+                                          +-----+
| SMTP |======+                               +===| MDA |
+------+      |     +-----+     +-------+     |   +-----+
              |=====| MFA |=====| Queue |=====|
                    +-----+     +-------+     |   +-----+
                      ||                      +===| MTA |
                    +-----+                       +-----+
                    | LKA |
                    +-----+


Client -> Server workflow:

1- The message is initially received from either the listening service or
   /usr/sbin/sendmail (for which smtpctl is a link).

2- As envelope is gathered, the information is handed out to MFA for
   validation.

3- MFA takes decision as to whether or not the message can be delivered
   locally or relayed out and notifies SMTP of its decision.

4- If message is not rejected, a file descriptor is requested from QUEUE
   by SMTP which will then write the message to the file descriptor.

5- Once content is written, SMTP notifies QUEUE that the content is
   fully written and provides a list of recipients.

6- QUEUE constructs batches of messages with same message ID and going
   to same destination, and registers them to the batch queue. It then
   writes the information on-disk so that it can recover from a crash
   or shutdown, and notifies SMTP that message is accepted.

7- SMTP notifies client that message was accepted.


Queue workflow:

1- A batch queue traversal is done. For each batch, QUEUE computes the
   retry time based on the number of times it was tried already and
   the time of last attempt. A batch may be in three states:

	a) It is either ready for processing, in which case it is
	   handed to MDA or MTA for delivery attempt.

	b) The delay before next retry has not yet expired, the
	   scheduler will simply ignore it.

	c) The batch age (currently 4 days) has expired. The
	   scheduler will eventually generate a mailer daemon batch
	   and remove the original batch from the queue.


XXX - needs to be completed/improved/updated
@


1.2
log
@various minor tweaks, including spelling fixes from Brian Keefer
and Jim Razmus;
@
text
@@


1.1
log
@smtpd is a smtp server implementation for OpenBSD. It is a work in progress
which still lacks many features. bringing it in tree will help working on it
more easily.

"at this stage it should go in" henning@@, "move ahead" deraadt@@
@
text
@d9 1
a9 1
an MTA and MDA for OpenBSD systems (and others !)
d16 1
a16 1
to provide communications between separate privilege-separated
d21 1
a21 1
	* smtp:		The unpriviledged SMTP server
d26 1
a26 1
	* lka:		Lookup agent, handles DNS, db, file and external maps
d32 1
a32 1
The SMTP Server conforms RFC 5321 and also provides interesting
d40 1
a40 1
allowed to be delivered by the daemon, it then performs resolution
d42 1
a42 1
local or remote. The second duty is to perform optionnal modifications
d50 1
a50 1
struct msg, the typical workflow is as show below from left to right:
d52 1
a52 1
+------+                                          +-----+  
d71 1
a71 1
3- MFA takes decision as to wether or not the message can be delivered
d80 1
a80 1
6- QUEUE constructs batches of messages with same message id and going
d82 1
a82 1
   writes the information on-disk so that it can recovert from a crash
d94 1
a94 1
	a) it is either ready for processing, in which case it is
d97 1
a97 1
	b) the delay before next retry has not yet expired, the
d100 1
a100 1
	c) the batch age (currently 4 days) has expired, the
@

