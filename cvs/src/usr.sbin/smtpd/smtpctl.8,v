head	1.58;
access;
symbols
	OPENBSD_6_1:1.58.0.4
	OPENBSD_6_1_BASE:1.58
	OPENBSD_6_0:1.57.0.4
	OPENBSD_6_0_BASE:1.57
	OPENBSD_5_9:1.54.0.2
	OPENBSD_5_9_BASE:1.54
	OPENBSD_5_8:1.50.0.4
	OPENBSD_5_8_BASE:1.50
	OPENBSD_5_7:1.49.0.2
	OPENBSD_5_7_BASE:1.49
	OPENBSD_5_6:1.48.0.4
	OPENBSD_5_6_BASE:1.48
	OPENBSD_5_5:1.47.0.2
	OPENBSD_5_5_BASE:1.47
	OPENBSD_5_4:1.44.0.2
	OPENBSD_5_4_BASE:1.44
	OPENBSD_5_3:1.40.0.2
	OPENBSD_5_3_BASE:1.40
	OPENBSD_5_2:1.27.0.2
	OPENBSD_5_2_BASE:1.27
	OPENBSD_5_1_BASE:1.26
	OPENBSD_5_1:1.26.0.2
	OPENBSD_5_0:1.20.0.2
	OPENBSD_5_0_BASE:1.20
	OPENBSD_4_9:1.18.0.2
	OPENBSD_4_9_BASE:1.18
	OPENBSD_4_8:1.16.0.2
	OPENBSD_4_8_BASE:1.16
	OPENBSD_4_7:1.13.0.2
	OPENBSD_4_7_BASE:1.13
	OPENBSD_4_6:1.8.0.4
	OPENBSD_4_6_BASE:1.8
	OPENBSD_4_5:1.6.0.2
	OPENBSD_4_5_BASE:1.6;
locks; strict;
comment	@.\" @;


1.58
date	2016.09.04.09.33.49;	author eric;	state Exp;
branches;
next	1.57;
commitid	k6ATrLH73tETES8n;

1.57
date	2016.06.14.22.40.48;	author millert;	state Exp;
branches;
next	1.56;
commitid	34YBJW86kihfJFV4;

1.56
date	2016.06.02.18.19.54;	author jung;	state Exp;
branches;
next	1.55;
commitid	yLm0oks0HONKBEQx;

1.55
date	2016.04.17.18.41.03;	author jung;	state Exp;
branches;
next	1.54;
commitid	ZPemplcVTSPNaFaJ;

1.54
date	2015.11.05.09.14.31;	author sunil;	state Exp;
branches;
next	1.53;
commitid	3vo6L6sIqhuEjLcD;

1.53
date	2015.10.29.10.25.36;	author sunil;	state Exp;
branches;
next	1.52;
commitid	TXZugvtal96cI6ec;

1.52
date	2015.10.15.08.18.23;	author sunil;	state Exp;
branches;
next	1.51;
commitid	1gy8qVoyriyUWv4d;

1.51
date	2015.08.16.22.26.11;	author jmc;	state Exp;
branches;
next	1.50;
commitid	E06cu153DpjcMb1i;

1.50
date	2015.07.27.18.48.05;	author sobrado;	state Exp;
branches;
next	1.49;
commitid	r9qI1nnshjT3yUk6;

1.49
date	2014.09.29.20.56.46;	author jmc;	state Exp;
branches;
next	1.48;
commitid	5PQJVhTJoS3UXxLR;

1.48
date	2014.07.08.07.58.01;	author sobrado;	state Exp;
branches;
next	1.47;
commitid	54wNPFiQQqpjs6WO;

1.47
date	2014.02.17.13.33.56;	author eric;	state Exp;
branches;
next	1.46;

1.46
date	2013.11.13.09.15.41;	author eric;	state Exp;
branches;
next	1.45;

1.45
date	2013.08.26.16.54.04;	author jmc;	state Exp;
branches;
next	1.44;

1.44
date	2013.07.20.06.45.12;	author jmc;	state Exp;
branches;
next	1.43;

1.43
date	2013.07.19.21.14.52;	author eric;	state Exp;
branches;
next	1.42;

1.42
date	2013.07.19.15.14.23;	author eric;	state Exp;
branches;
next	1.41;

1.41
date	2013.05.24.17.03.14;	author eric;	state Exp;
branches;
next	1.40;

1.40
date	2013.02.14.13.21.16;	author gilles;	state Exp;
branches;
next	1.39;

1.39
date	2013.01.28.11.09.53;	author gilles;	state Exp;
branches;
next	1.38;

1.38
date	2013.01.26.14.13.25;	author jmc;	state Exp;
branches;
next	1.37;

1.37
date	2013.01.26.09.37.23;	author gilles;	state Exp;
branches;
next	1.36;

1.36
date	2012.11.20.11.39.51;	author jmc;	state Exp;
branches;
next	1.35;

1.35
date	2012.11.20.09.47.46;	author eric;	state Exp;
branches;
next	1.34;

1.34
date	2012.10.17.08.38.48;	author eric;	state Exp;
branches;
next	1.33;

1.33
date	2012.10.15.22.47.20;	author jmc;	state Exp;
branches;
next	1.32;

1.32
date	2012.10.15.18.32.25;	author eric;	state Exp;
branches;
next	1.31;

1.31
date	2012.10.14.13.22.33;	author gilles;	state Exp;
branches;
next	1.30;

1.30
date	2012.10.14.11.58.23;	author gilles;	state Exp;
branches;
next	1.29;

1.29
date	2012.10.14.11.47.09;	author gilles;	state Exp;
branches;
next	1.28;

1.28
date	2012.10.10.19.39.11;	author gilles;	state Exp;
branches;
next	1.27;

1.27
date	2012.04.07.14.11.11;	author jmc;	state Exp;
branches;
next	1.26;

1.26
date	2012.02.09.07.47.43;	author jmc;	state Exp;
branches;
next	1.25;

1.25
date	2011.10.26.21.41.18;	author jmc;	state Exp;
branches;
next	1.24;

1.24
date	2011.10.26.20.47.31;	author gilles;	state Exp;
branches;
next	1.23;

1.23
date	2011.10.23.18.37.34;	author jmc;	state Exp;
branches;
next	1.22;

1.22
date	2011.10.23.17.12.41;	author gilles;	state Exp;
branches;
next	1.21;

1.21
date	2011.08.17.20.04.43;	author gilles;	state Exp;
branches;
next	1.20;

1.20
date	2011.07.22.06.33.54;	author jmc;	state Exp;
branches;
next	1.19;

1.19
date	2011.07.21.23.29.24;	author gilles;	state Exp;
branches;
next	1.18;

1.18
date	2010.10.18.13.28.25;	author sthen;	state Exp;
branches;
next	1.17;

1.17
date	2010.10.09.22.05.35;	author gilles;	state Exp;
branches;
next	1.16;

1.16
date	2010.06.01.23.06.25;	author jacekm;	state Exp;
branches;
next	1.15;

1.15
date	2010.06.01.19.47.09;	author jacekm;	state Exp;
branches;
next	1.14;

1.14
date	2010.05.31.23.38.56;	author jacekm;	state Exp;
branches;
next	1.13;

1.13
date	2010.02.23.22.09.55;	author stevesk;	state Exp;
branches;
next	1.12;

1.12
date	2010.02.23.21.12.14;	author stevesk;	state Exp;
branches;
next	1.11;

1.11
date	2010.01.03.14.37.37;	author chl;	state Exp;
branches;
next	1.10;

1.10
date	2009.10.22.15.02.12;	author sobrado;	state Exp;
branches;
next	1.9;

1.9
date	2009.10.22.12.35.53;	author sobrado;	state Exp;
branches;
next	1.8;

1.8
date	2009.03.23.21.48.40;	author jmc;	state Exp;
branches;
next	1.7;

1.7
date	2009.03.16.22.40.35;	author gilles;	state Exp;
branches;
next	1.6;

1.6
date	2008.12.27.17.58.02;	author jacekm;	state Exp;
branches;
next	1.5;

1.5
date	2008.12.11.22.19.39;	author gilles;	state Exp;
branches;
next	1.4;

1.4
date	2008.12.06.13.18.13;	author sobrado;	state Exp;
branches;
next	1.3;

1.3
date	2008.12.06.10.54.45;	author sobrado;	state Exp;
branches;
next	1.2;

1.2
date	2008.12.05.06.56.41;	author jmc;	state Exp;
branches;
next	1.1;

1.1
date	2008.12.05.03.28.37;	author gilles;	state Exp;
branches;
next	;


desc
@@


1.58
log
@Remove the "smtpctl stop" command.
The daemon is stopped with kill(1).

ok gilles@@
@
text
@.\" $OpenBSD: smtpctl.8,v 1.57 2016/06/14 22:40:48 millert Exp $
.\"
.\" Copyright (c) 2006 Pierre-Yves Ritschard <pyr@@openbsd.org>
.\" Copyright (c) 2012 Gilles Chehade <gilles@@poolp.org>
.\"
.\" Permission to use, copy, modify, and distribute this software for any
.\" purpose with or without fee is hereby granted, provided that the above
.\" copyright notice and this permission notice appear in all copies.
.\"
.\" THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
.\" WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
.\" MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
.\" ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
.\" WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
.\" ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
.\" OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
.\"
.Dd $Mdocdate: June 14 2016 $
.Dt SMTPCTL 8
.Os
.Sh NAME
.Nm smtpctl ,
.Nm mailq
.Nd control the Simple Mail Transfer Protocol daemon
.Sh SYNOPSIS
.Nm
.Ar command
.Op Ar argument ...
.Nm mailq
.Sh DESCRIPTION
The
.Nm
program controls
.Xr smtpd 8 .
Commands may be abbreviated to the minimum unambiguous prefix; for example,
.Cm sh ro
for
.Cm show routes .
.Pp
The
.Nm mailq
command is provided for compatibility with other MTAs
and is simply a shortcut for
.Cm show queue .
.Pp
The following commands are available:
.Bl -tag -width Ds
.It Cm discover Ar envelope-id | message-id
Schedule a single envelope, or all envelopes with the same message ID
that were manually moved to the queue.
.It Cm encrypt Op Ar string
Encrypt the password
.Ar string
to a representation suitable for user credentials and print it to the
standard output.
If
.Ar string
is not provided, cleartext passwords are read from standard input.
.Pp
It is advised to avoid providing the password as a parameter as it will be
visible from
.Xr top 1
and
.Xr ps 1
output.
.It Cm log brief
Disable verbose debug logging.
.It Cm log verbose
Enable verbose debug logging.
.It Cm monitor
Display updates of some
.Xr smtpd 8
internal counters in one second intervals.
Each line reports the increment of all counters since the last update,
except for some counters which are always absolute values.
The first line reports the current value of each counter.
The fields are:
.Pp
.Bl -bullet -compact
.It
Current number of active SMTP clients (absolute value).
.It
New SMTP clients.
.It
Disconnected clients.
.It
Current number of envelopes in the queue (absolute value).
.It
Newly enqueued envelopes.
.It
Dequeued envelopes.
.It
Successful deliveries.
.It
Temporary failures.
.It
Permanent failures.
.It
Message loops.
.It
Expired envelopes.
.It
Envelopes removed by the administrator.
.It
Generated bounces.
.El
.It Cm pause envelope Ar envelope-id | message-id
Temporarily suspend scheduling for the envelope with the given ID,
or all envelopes with the given message ID.
.It Cm pause envelope all
Temporarily suspend scheduling all the envelopes.
.It Cm pause mda
Temporarily stop deliveries to local users.
.It Cm pause mta
Temporarily stop relaying and deliveries to
remote users.
.It Cm pause smtp
Temporarily stop accepting incoming sessions.
.It Cm profile Ar subsystem
Enables real-time profiling of
.Ar subsystem .
Supported subsystems are:
.Pp
.Bl -bullet -compact
.It
queue, to profile cost of queue IO
.It
imsg, to profile cost of event handlers
.El
.It Cm remove Ar envelope-id | message-id
Remove a single envelope, or all envelopes with the same message ID.
.It Cm remove all
Remove all envelopes.
.It Cm resume envelope Ar envelope-id | message-id
Resume scheduling for the envelope with the given ID,
or all envelopes with the given message ID.
.It Cm resume envelope all
Resume scheduling all the envelopes.
.It Cm resume mda
Resume deliveries to local users.
.It Cm resume mta
Resume relaying and deliveries to remote users.
.It Cm resume route Ar route-id
Resume routing on disabled route
.Ar route-id .
.It Cm resume smtp
Resume accepting incoming sessions.
.It Cm schedule all
Mark all envelopes as ready for immediate delivery.
.It Cm schedule Ar envelope-id | message-id
Mark a single envelope, or all envelopes with the same message ID,
as ready for immediate delivery.
.It Cm show envelope Ar envelope-id
Display envelope content for the given ID.
.It Cm show hosts
Display the list of known remote MX hosts.
For each of them, it shows the IP address, the canonical hostname,
a reference count, the number of active connections to this host,
and the elapsed time since the last connection.
.It Cm show hoststats
Display status of last delivery for domains that have been active in the
last 4 hours.
It consists of the following fields, separated by a "|":
.Pp
.Bl -bullet -compact
.It
Domain.
.It
.Ux
timestamp of last delivery.
.It
Status of last delivery.
.El
.It Cm show message Ar envelope-id
Display message content for the given ID.
.It Cm show queue
Display information concerning envelopes that are currently in the queue.
Each line of output describes a single envelope.
It consists of the following fields, separated by a "|":
.Pp
.Bl -bullet -compact
.It
Envelope ID.
.It
Address family of the client which enqueued the mail.
.It
Type of delivery: one of "mta", "mda" or "bounce".
.It
Various flags on the envelope.
.It
Sender address (return path).
.It
The original recipient address.
.It
The destination address.
.It
Time of creation.
.It
Time of expiration.
.It
Time of last delivery or relaying attempt.
.It
Number of delivery or relaying attempts.
.It
Current runstate: either "pending" or "inflight" if
.Xr smtpd 8
is running, or "offline" otherwise.
.It
Delay in seconds before the next attempt if pending, or time ellapsed
if currently running.
This field is blank if
.Xr smtpd 8
is not running.
.It
Error string for the last failed delivery or relay attempt.
.El
.It Cm show relays
Display the list of currently active relays and associated connectors.
For each relay, it shows a number of counters and information on its
internal state on a single line.
Then comes the list of connectors
(source addresses to connect from for this relay).
.It Cm show routes
Display status of routes currently known by
.Xr smtpd 8 .
Each line consists of a route number, a source address, a destination
address, a set of flags, the number of connections on this
route, the current penalty level which determines the amount of time
the route is disabled if an error occurs, and the delay before it
gets reactivated.
The following flags are defined:
.Pp
.Bl -tag -width xx -compact
.It D
The route is currently disabled.
.It N
The route is new.
No SMTP session has been established yet.
.It Q
The route has a timeout registered to lower its penalty level and possibly
reactivate or discard it.
.El
.It Cm show stats
Displays runtime statistics concerning
.Xr smtpd 8 .
.It Cm show status
Shows if MTA, MDA and SMTP systems are currently running or paused.
.It Cm trace Ar subsystem
Enables real-time tracing of
.Ar subsystem .
Supported subsystems are:
.Pp
.Bl -bullet -compact
.It
imsg
.It
io
.It
smtp (incoming sessions)
.It
filters
.It
mta (outgoing sessions)
.It
bounce
.It
scheduler
.It
expand (aliases/virtual/forward expansion)
.It
lookup (user/credentials lookups)
.It
stat
.It
rules (matched by incoming sessions)
.It
mproc
.It
all
.El
.It Cm uncorrupt Ar message-id
Move all envelopes with the given message ID from corrupt bucket back to queue.
.It Cm unprofile Ar subsystem
Disables real-time profiling of
.Ar subsystem .
.It Cm untrace Ar subsystem
Disables real-time tracing of
.Ar subsystem .
.It Cm update table Ar name
For table backends that provide caching, causes
.Xr smtpd 8
to update the cache.
.El
.Pp
When
.Nm smtpd
receives a message, it generates a
.Ar message-id
for the message, and one
.Ar envelope-id
per recipient.
The
.Ar message-id
is a 32-bit random identifier that is guaranteed to be
unique on the host system.
The
.Ar envelope-id
is a 64-bit unique identifier that encodes the
.Ar message-id
in the 32 upper bits and a random envelope identifier
in the 32 lower bits.
.Pp
A command which specifies a
.Ar message-id
applies to all recipients of a message;
a command which specifies an
.Ar envelope-id
applies to a specific recipient of a message.
.Sh FILES
.Bl -tag -width "/var/run/smtpd.sockXXX" -compact
.It Pa /var/run/smtpd.sock
.Ux Ns -domain
socket used for communication with
.Xr smtpd 8 .
.El
.Sh SEE ALSO
.Xr smtpd 8
.Sh HISTORY
The
.Nm
program first appeared in
.Ox 4.6 .
@


1.57
log
@Fix typo; OK jung@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.56 2016/06/02 18:19:54 jung Exp $
d18 1
a18 1
.Dd $Mdocdate: June 2 2016 $
a247 2
.It Cm stop
Stop the server.
@


1.56
log
@transfer is not a smtpctl command, but mta is

ok gilles
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.55 2016/04/17 18:41:03 jung Exp $
d18 1
a18 1
.Dd $Mdocdate: April 17 2016 $
d240 1
a240 1
The route as a timeout registered to lower its penalty level and possibly
@


1.55
log
@fix typo, it is supposed to be smtpctl trace "filters" not "filter"

from Boudewijn Dijkstra
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.54 2015/11/05 09:14:31 sunil Exp $
d18 1
a18 1
.Dd $Mdocdate: November 5 2015 $
d265 1
a265 1
transfer (outgoing sessions)
@


1.54
log
@Implement smtpctl uncorrupt <msgid>

"uncorrupt" moves envelopes from corrupt bucket back to the queue
for further discovery by the daemon.

After correcting the corrupt envelopes, admin could now...

# smtpctl uncorrupt msgid
# smtpctl discover msgid

to schedule the messages.

Ok gilles@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.53 2015/10/29 10:25:36 sunil Exp $
d18 1
a18 1
.Dd $Mdocdate: October 29 2015 $
d263 1
a263 1
filter
@


1.53
log
@Implement smtpctl discover <evpid|msgid>.

discover subcommand schedules envelopes manually moved to the queue.
It triggers a queue walk searching for envelopes with the given id,
schedules them and informs the user number of envelopes scheduled.
Admins no longer would need to restart the daemon to discover
manually moved messages.

Ok gilles@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.52 2015/10/15 08:18:23 sunil Exp $
d18 1
a18 1
.Dd $Mdocdate: October 15 2015 $
d283 2
@


1.52
log
@Let "all" as an argument for "resume envelope", "pause envelope"
and "remove" subcommands.

seems potentially useful millert@@, Ok gilles@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.51 2015/08/16 22:26:11 jmc Exp $
d18 1
a18 1
.Dd $Mdocdate: August 16 2015 $
d48 3
@


1.51
log
@use a less ambiguous example; from larry hynes
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.50 2015/07/27 18:48:05 sobrado Exp $
d18 1
a18 1
.Dd $Mdocdate: July 27 2015 $
d107 2
d129 2
d134 2
@


1.50
log
@use file system path (.Pa) semantic markup macros where appropriate.
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.49 2014/09/29 20:56:46 jmc Exp $
d18 1
a18 1
.Dd $Mdocdate: September 29 2014 $
d36 1
a36 1
.Cm sh s
d38 1
a38 1
.Cm show stats .
@


1.49
log
@lightly document mailq; ok gilles
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.48 2014/07/08 07:58:01 sobrado Exp $
d18 1
a18 1
.Dd $Mdocdate: July 8 2014 $
d312 1
a312 1
.It /var/run/smtpd.sock
@


1.48
log
@improve indentation.

ok jmc@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.47 2014/02/17 13:33:56 eric Exp $
d18 1
a18 1
.Dd $Mdocdate: February 17 2014 $
d22 2
a23 1
.Nm smtpctl
d29 1
d39 6
@


1.47
log
@new "smtpctl show status" command to show if mta/mda/smtp are currently running or paused.
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.46 2013/11/13 09:15:41 eric Exp $
d18 1
a18 1
.Dd $Mdocdate: November 13 2013 $
d303 1
a303 1
.Bl -tag -width "/var/run/smtpd.sockXX" -compact
@


1.46
log
@document smtpctl "show hosts" and "show relays".
add an encrypt wrapper usable for auth tables.
@
text
@d1 1
a1 1
.\" $OpenBSD$
d18 1
a18 1
.Dd $Mdocdate: August 26 2013 $
d229 2
@


1.45
log
@"reactivate";
make.1 part From: Christian Schulte
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.44 2013/07/20 06:45:12 jmc Exp $
d18 1
a18 1
.Dd $Mdocdate: July 20 2013 $
d40 15
d138 5
d200 6
@


1.44
log
@tweak previous;
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.43 2013/07/19 21:14:52 eric Exp $
d18 1
a18 1
.Dd $Mdocdate: July 19 2013 $
d187 1
a187 1
gets re-activated.
d198 1
a198 1
re-activate or discard it.
@


1.43
log
@Many MTA improvements:

- Better transient error handling logic: failing destinations are
  automatically disabled for a while.  When a destination is active
  again, ask the scheduler to retry previous envelopes immediatly.
- More informative error report when all routes fail for a mail.
- Implement a "smtpctl show hoststats" command to get the latest stat
  message per MX domain.
- Implement a "smtpctl show routes" command to show the state the
  currently known routes to remote MXs.
- Implement a "smtpctl resume route" command to re-enable a route that
  has been disabled.
- Do not hardcode limits
- Minor code improvements
@
text
@d1 1
a1 1
.\" $OpenBSD$
d18 1
a18 1
.Dd $Mdocdate: May 24 2013 $
d130 1
a130 1
domain.
d132 2
a133 1
Unix timestamp of last delivery.
d183 1
a183 1
Each line consists in a route number, a source address, a destination
d187 2
a188 1
gets re-activated. The following flags are defined:
a190 2
.It N
The route is new. No SMTP session has been established yet.
d193 3
d197 1
a197 1
The route as a timeout registered to lower its penality level and possibly
@


1.42
log
@scheduler improvements:
- implement suspend/resume scheduling for individual envelopes or message,
  with the associated smtpctl commands.
- allow the mta to request immediate scheduling of an envelope.
- on temporary failures a penalty can be given to further delay the next try.
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.41 2013/05/24 17:03:14 eric Exp $
d82 1
a82 1
Temporarily suspend scheduling for the envelope with the given ID,   
d111 3
d123 13
d178 18
@


1.41
log
@sync with OpenSMTPD 5.3.2

ok gilles@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.40 2013/02/14 13:21:16 gilles Exp $
d18 1
a18 1
.Dd $Mdocdate: February 14 2013 $
d81 3
d104 3
@


1.40
log
@- document smtpctl trace expand
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.39 2013/01/28 11:09:53 gilles Exp $
d18 1
a18 1
.Dd $Mdocdate: January 28 2013 $
d191 1
a191 1
imsg-size
@


1.39
log
@- introduce 'smtpctl trace lookup' to trace lookup process
- improve logging of the transfer process

trace by me, logging by eric
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.38 2013/01/26 14:13:25 jmc Exp $
d18 1
a18 1
.Dd $Mdocdate: January 26 2013 $
d183 3
a185 1
lookup (aliases/virtual/forward expansion)
@


1.38
log
@tweak previous;
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.37 2013/01/26 09:37:23 gilles Exp $
d182 2
@


1.37
log
@Sync with our smtpd repo:

* first bricks of ldap and sqlite support (not finished but both working)
* new table API to replace map API, all lookups are done through tables
* improved handling of temporary errors throughout the daemon
* improved scheduler and mta logic: connection reuse, optimizes batches
* improved queue: more tolerant to admin errors, new layout, less disk-IO
* improved memory usage under high load
* SSL certs/keys isolated to lookup process to avoid facing network
* VIRTUAL support improved, fully virtual setups possible now
* runtime tracing of processes through smtpctl trace
* ssl_privsep.c sync-ed with relayd
* ssl.c no longer contains smtpd specific interfaces
* smtpd-specific ssl bits moved to ssl_smtpd.c
* update mail address in copyright

FLUSH YOUR QUEUE. FLUSH YOUR QUEUE. FLUSH YOUR QUEUE. FLUSH YOUR QUEUE.

smtpd.conf(5) simplified, it will require adaptations

ok eric@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.34 2012/10/17 08:38:48 eric Exp $
d18 1
a18 1
.Dd $Mdocdate: October 17 2012 $
d53 1
a53 1
.Bl -compact -bullet
d88 11
d121 1
a121 1
.Bl -compact -bullet
d123 1
a123 1
Envelope id.
d167 1
a167 1
.Bl -compact -bullet
d191 3
a195 14
.Ar subsystem .
.It Cm profile Ar subsystem
Enables real-time profiling of
.Ar subsystem .
Supported subsystems are:
.Pp
.Bl -compact -bullet
.It
queue, to profile cost of queue IO
.It
imsg, to profile cost of event handlers
.El
.It Cm unprofile Ar subsystem
Disables real-time profiling of
@


1.36
log
@- for lists, list type must come first
- uppercase "ID"
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.35 2012/11/20 09:47:46 eric Exp $
d4 1
d18 1
a18 1
.Dd $Mdocdate: November 20 2012 $
d53 1
a53 1
.Bl -bullet -compact
d96 1
a96 1
.It Cm schedule-all
d98 1
a98 1
.It Cm schedule-id Ar envelope-id | message-id
d110 1
a110 1
.Bl -bullet -compact
d112 1
a112 1
Envelope ID.
d151 46
@


1.35
log
@Allow "smtpctl show queue" to run in "online" mode if the smtpd server
is running.  The scheduler sends the runtime state of each envelope to
the queue process which loads the envelope, fills the runtime bits and
sends the envelope back to the client. Iteration over the envelope set
happens in small chunks to make the request interruptible and to allow
the server to keep doing its job in the meantime.

Adpat "smtpctl schedule-all" to schedule the messages one by one using
the same iteration mechanism.

Document "smtpctl monitor" and "smtpctl show queue".

ok gilles@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.34 2012/10/17 08:38:48 eric Exp $
d17 1
a17 1
.Dd $Mdocdate: October 17 2012 $
d52 1
a52 1
.Bl -compact -bullet
d109 1
a109 1
.Bl -compact -bullet
d111 1
a111 1
Envelope id.
@


1.34
log
@consistency fix: we use "envelope-id" everywhere.

ok gilles@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.33 2012/10/15 22:47:20 jmc Exp $
d17 1
a17 1
.Dd $Mdocdate: October 15 2012 $
d43 37
d88 1
a88 1
Removes a single envelope, or all envelopes with the same message ID.
d96 1
a96 1
Marks all envelopes as ready for immediate delivery.
d98 1
a98 1
Marks a single envelope, or all envelopes with the same message ID,
d101 1
a101 1
Displays envelope's content for the given ID.
d103 1
a103 1
Displays message content for the given ID.
d105 40
a144 2
Displays information concerning envelopes
that are currently in a queue.
d148 4
a151 2
.It Cm update map Ar name
For map backends that provide caching, causes
a153 2
.It Cm stop
Stop the server.
@


1.33
log
@tweak previous; ok eric
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.32 2012/10/15 18:32:25 eric Exp $
d103 1
a103 1
.Ar envelope-uid
@


1.32
log
@implement and document "smtpctl stop"

ok gilles@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.31 2012/10/14 13:22:33 gilles Exp $
d17 1
a17 1
.Dd $Mdocdate: October 14 2012 $
d78 1
a78 1
Shutdown the server.
@


1.31
log
@mistakenly removed an ".Xr smtpd 8"

spotted by jmc@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.30 2012/10/14 11:58:23 gilles Exp $
d77 2
@


1.30
log
@introduce map_file.c which will deprecate map_stdio.c

The idea is to have a file-backed map but to have smtpd(8) cache the maps
so that it cannot be partially read if edited while mail is received. The
file is read and converted to a static map (map_static.c), changes aren't
visible to smtpd until an explicit: smtpctl update map  which reads file,
builds a new static map and invalidates the former.

partial-read issue discussed with beck@@ and halex@@
idea to convert internally to a static map by eric@@

diff ok eric@@ and chl@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.29 2012/10/14 11:47:09 gilles Exp $
d72 1
@


1.29
log
@smtpctl show runqueue no longer exists, it's been that way for a while
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.28 2012/10/10 19:39:11 gilles Exp $
d17 1
a17 1
.Dd $Mdocdate: October 10 2012 $
d72 4
a75 1
.Xr smtpd 8 .
@


1.28
log
@teach smtpctl how to display envelopes and messages using their id.
this allows an admin to inspect the queue without having to manually
extract bucket and find the path to an envelope or message.

diff by Sunil Nimmagadda <sunil@@poolp.org>

ok eric@@, chl@@ and I
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.27 2012/04/07 14:11:11 jmc Exp $
d17 1
a17 1
.Dd $Mdocdate: April 7 2012 $
a69 3
.It Cm show runqueue
Displays information concerning envelopes
that are scheduled for delivery.
@


1.27
log
@grammar fix;
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.26 2012/02/09 07:47:43 jmc Exp $
d17 1
a17 1
.Dd $Mdocdate: February 9 2012 $
d63 4
@


1.26
log
@correct argument names for "resume"; from Jan Stary
ok gilles
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.25 2011/10/26 21:41:18 jmc Exp $
d17 1
a17 1
.Dd $Mdocdate: October 26 2011 $
d95 1
a95 1
a command which specifies a
@


1.25
log
@retain alphabetical order;
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.24 2011/10/26 20:47:31 gilles Exp $
d52 1
a52 3
.It Cm resume incoming
Resume accepting incoming sessions.
.It Cm resume local
d54 1
a54 1
.It Cm resume outgoing
d56 2
@


1.24
log
@- fix smtpctl pause/resume so the ramqueue scheduling is done correctly
- rename IMSG and smtpctl pause/resume parameters
- update man page

tested by me, ok chl@@, eric@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.23 2011/10/23 18:37:34 jmc Exp $
d17 1
a17 1
.Dd $Mdocdate: October 23 2011 $
a42 2
.It Cm pause smtp
Temporarily stop accepting incoming sessions.
d48 2
@


1.23
log
@retain alphabetical order;
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.22 2011/10/23 17:12:41 gilles Exp $
d43 1
a43 1
.It Cm pause incoming
d45 1
a45 1
.It Cm pause local
d47 1
a47 1
.It Cm pause outgoing
@


1.22
log
@- smtpctl schedule no longer works, instead, use 'smtpctl schedule-id <id>'
- introduce 'smtpctl schedule-all'

ok eric@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.21 2011/08/17 20:04:43 gilles Exp $
d17 1
a17 1
.Dd $Mdocdate: August 17 2011 $
d58 2
a62 2
.It Cm schedule-all
Marks all envelopes as ready for immediate delivery.
@


1.21
log
@- teach smtpctl remove about the new ramqueue structure
- bonus #1: O(log n) removal of envelopes
- bonus #2: removing all envelopes that have the same msgid works again
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.20 2011/07/22 06:33:54 jmc Exp $
d17 1
a17 1
.Dd $Mdocdate: July 22 2011 $
d58 1
a58 1
.It Cm schedule Ar envelope-id | message-id
d61 2
@


1.20
log
@tweak previous;
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.19 2011/07/21 23:29:24 gilles Exp $
d17 1
a17 1
.Dd $Mdocdate: July 21 2011 $
d50 2
a51 2
.It Cm remove Ar envelope-id
Removes a single envelope from queue.
@


1.19
log
@- update smtpctl.8 to reflect reality
- bring back 'smtpctl schedule' and 'smtpctl remove' to life

Things you should know:

The ramqueue data structure is not finished yet and lacks an envelope tree
for evpid lookups. I wanted to wait until I'm done but too many people are
affected by not being able to reschedule envelopes, this is a quick fix.

So right now there's an O(rrible) complexity as both commands will perform
a (possibly aborted) queue scan leading to O(n). I will make that O(log n)
soon.

Also, smtpctl remove no longer supports removing an entire message, I will
fix that very soon too.
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.18 2010/10/18 13:28:25 sthen Exp $
d17 1
a17 1
.Dd $Mdocdate: October 18 2010 $
d81 1
a81 1
is a 32 bits random identifier that is guaranteed to be
d85 1
a85 1
is a 64 bits unique identifier that encodes the
@


1.18
log
@Mention that commands may be abbreviated, as done in other *ctl manuals.
ok gilles@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.17 2010/10/09 22:05:35 gilles Exp $
d17 1
a17 1
.Dd $Mdocdate: October 9 2010 $
d50 2
a51 2
.It Cm remove Ar message-uid | message-id
Removes a single message, or all messages with the same message ID.
d58 2
a59 2
.It Cm schedule Ar message-uid | message-id
Marks a single message, or all messages with the same message ID,
d77 1
a77 1
.Ar message-uid
d81 2
a82 2
consists of a timestamp followed by a random identifier
that is guaranteed to be unique on the host system.
d84 2
a85 2
.Ar message-uid
consists of the
d87 2
a88 2
followed by a random identifier that is also guaranteed
to be unique between recipients of the same message.
d94 1
a94 1
.Ar message-uid
@


1.17
log
@backout the "new" queue code commited 4 months ago. it has many good ideas,
is way more optimized than what we had earlier and there's definitely stuff
we want to keep, however it is early optimization that doesn't account for
many features and makes them hard (if not impossible) to write without
ugly workarounds that ruin the purpose of the optimizations.

the backout goes to 30 May's right before the commit and catches up on all
the non-queue related commits that happened since then.

i'll work on reintroducing the ideas from this queue when the basic
features we expect from a MTA are implemented.

suggested on tech@@ about a week ago, no objections, several "please make
smtpd move forward" mails from hackers and tech readers.
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.13 2010/02/23 22:09:55 stevesk Exp $
d17 1
a17 1
.Dd $Mdocdate: February 23 2010 $
d32 4
@


1.16
log
@new queue, again; gcc2 compile tested by deraadt
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.14 2010/05/31 23:38:56 jacekm Exp $
d17 1
a17 1
.Dd $Mdocdate: May 31 2010 $
d46 2
a47 2
.It Cm remove Ar message-id | Cm all
Removes messages with the same message ID, or all messages.
d54 2
a55 2
.It Cm schedule Ar message-id | Cm all
Marks messages with the same message ID, or all messages,
d57 3
a59 2
.It Cm show queue Op Ic raw
Displays undelivered messages.
@


1.15
log
@New queue doesn't compile on gcc2, back out.  Spotted by deraadt@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.13 2010/02/23 22:09:55 stevesk Exp $
d17 1
a17 1
.Dd $Mdocdate: February 23 2010 $
d46 2
a47 2
.It Cm remove Ar message-uid | message-id
Removes a single message, or all messages with the same message ID.
d54 2
a55 2
.It Cm schedule Ar message-uid | message-id
Marks a single message, or all messages with the same message ID,
d57 2
a58 3
.It Cm show queue
Displays information concerning envelopes
that are currently in a queue.
@


1.14
log
@Rewrite entire queue code.

Major goals:

1) Fix bad performance caused by the runner process doing full queue
read in 1s intervals.  My Soekris can now happily accept >50 msg/s
while having multi-thousand queue; before, one hundred queue would
bring the system to its knees.

2) Introduce Qmail-like scheduler that doesn't write as much to the
disk so that it needs less code for servicing error conditions,
which in some places can be tricky to get right.

3) Introduce separation between the scheduler and the backend; these
two queue aspects shouldn't be too tied too each other.  This means
that eg. storing queue in SQL requires rewrite of just queue_backend.c.

4) Make on-disk queue format architecture independent, and more
easily extensible, to reduce number of flag days in the future.

Minor goals:

ENOSPC no longer prevents delivery attempts, fixed session limiting
for relayed mail, improved batching of "relay via" mails, human-readable
mailq output, "show queue raw" command, clearer logging, sending
of single bounce about multiple recipients, exact delay= computation,
zero delay between deliveries while within session limit (currently
1s delay between re-scheduling is enforced), mta no longer requests
content fd, corrected session limit for bounce submissions, tiny
<100B queue files instead of multi-KB, detect loops before accepting
mail, reduce traffic on imsg channels by killing enormous struct
submit_status.
@
text
@d46 2
a47 2
.It Cm remove Ar message-id | Cm all
Removes messages with the same message ID, or all messages.
d54 2
a55 2
.It Cm schedule Ar message-id | Cm all
Marks messages with the same message ID, or all messages,
d57 3
a59 2
.It Cm show queue Op Ic raw
Displays undelivered messages.
@


1.13
log
@add remove command; ok jmc@@ gilles@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.12 2010/02/23 21:12:14 stevesk Exp $
d46 2
a47 2
.It Cm remove Ar message-uid | message-id
Removes a single message, or all messages with the same message ID.
d54 2
a55 2
.It Cm schedule Ar message-uid | message-id
Marks a single message, or all messages with the same message ID,
d57 2
a58 3
.It Cm show queue
Displays information concerning envelopes
that are currently in a queue.
@


1.12
log
@Add a description for message-id and message-uid (text from gilles@@).
Also combine the two schedule commands with uid/id into one.  help and
ok jmc@@ and gilles@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.11 2010/01/03 14:37:37 chl Exp $
d17 1
a17 1
.Dd $Mdocdate: January 3 2010 $
d46 2
@


1.11
log
@Implement "log verbose" and "log brief" to enable or disable verbose debug
logging on runtime.

Based on claudio@@'s work on ripd, ospfd, ospf6d, dvmrpd, ldpd, bgpd.

With help/ideas/testing from gilles@@ jacekm@@ todd@@

ok jacekm@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.10 2009/10/22 15:02:12 sobrado Exp $
d17 1
a17 1
.Dd $Mdocdate: October 22 2009 $
d52 3
a54 5
.It Cm schedule message-id
Marks all messages with same message ID as ready
for immediate delivery.
.It Cm schedule message-uid
Marks a message as ready for immediate delivery.
d65 25
@


1.10
log
@write UNIX-domain in a more consistent way; while here, replace a
few remaining ".Tn UNIX" macros with ".Ux" ones.

pointed out by ratchov@@, thanks!

ok jmc@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.9 2009/10/22 12:35:53 sobrado Exp $
d35 4
@


1.9
log
@use the UNIX-related macros (.At and .Ux) where appropriate.

ok jmc@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.8 2009/03/23 21:48:40 jmc Exp $
d17 1
a17 1
.Dd $Mdocdate: March 23 2009 $
d66 2
a67 2
.Ux
domain socket used for communication with
@


1.8
log
@various minor improvements; ok jacekm gilles
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.7 2009/03/16 22:40:35 gilles Exp $
d17 1
a17 1
.Dd $Mdocdate: March 16 2009 $
d66 2
a67 1
Unix-domain socket used for communication with
@


1.7
log
@update smtpctl.8 with new smtpctl commands
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.6 2008/12/27 17:58:02 jacekm Exp $
d17 1
a17 1
.Dd $Mdocdate: December 27 2008 $
d35 18
d55 1
a55 1
that are currently in queue.
a61 18
.It Cm schedule message-uid
Marks a message as ready for immediate delivery.
.It Cm schedule message-id
Marks all messages with same message id as ready
for immediate delivery.
.It Cm pause local
Temporarily stop deliveries to local users.
.It Cm resume local
Resume deliveries to local users.
.It Cm pause outgoing
Temporarily stop relaying and deliveries to
remote users.
.It Cm resume outgoing
Resume relaying and deliveries to remote users.
.It Cm pause incoming
Temporarily stop accepting incoming sessions.
.It Cm resume incoming
Resume accepting incoming sessions.
d75 1
a75 1
.Ox 4.5 .
@


1.6
log
@Manpage bits for "showqueue" -> "show queue" change.
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.5 2008/12/11 22:19:39 gilles Exp $
d17 1
a17 1
.Dd $Mdocdate: December 11 2008 $
d41 21
@


1.5
log
@- document showqueue and showrunqueue
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.4 2008/12/06 13:18:13 sobrado Exp $
d17 1
a17 1
.Dd $Mdocdate: December 6 2008 $
d35 2
a36 2
.It Cm showqueue
displays informations concerning envelopes
d38 2
a39 2
.It Cm showrunqueue
displays informations concerning envelopes
@


1.4
log
@the ellipsis allows more than one argument being specified.

discussed with gilles@@

ok jmc@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.3 2008/12/06 10:54:45 sobrado Exp $
d35 6
@


1.3
log
@smtpctl(8) was committed after 4.4.

ok gilles@@
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.2 2008/12/05 06:56:41 jmc Exp $
d17 1
a17 1
.Dd $Mdocdate: December 5 2008 $
d26 1
a26 1
.Op Ar arguments ...
@


1.2
log
@tweaks;
@
text
@d1 1
a1 1
.\" $OpenBSD: smtpctl.8,v 1.1 2008/12/05 03:28:37 gilles Exp $
d48 1
a48 1
.Ox 4.4 .
@


1.1
log
@- smtpctl utility to control the smtpd, don't expect too much yet as it is
	just an empty clone of relayctl with the glue needed to have it
	exchange imsg with smtpd correctly. code mostly by pyr@@, reviewed
	by chl@@ and I a while ago.
@
text
@d1 1
a1 1
.\" $OpenBSD: relayctl.8,v 1.21 2007/12/20 20:22:11 reyk Exp $
d17 1
a17 1
.Dd $Mdocdate: March 6 2008 $
d22 1
a22 1
.Nd control the smtp daemon
d30 2
a31 3
program controls the
.Xr smtpd 8
daemon.
a48 1

@

