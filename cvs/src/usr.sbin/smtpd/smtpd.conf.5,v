head	1.172;
access;
symbols
	OPENBSD_6_1:1.168.0.4
	OPENBSD_6_1_BASE:1.168
	OPENBSD_6_0:1.161.0.4
	OPENBSD_6_0_BASE:1.161
	OPENBSD_5_9:1.155.0.2
	OPENBSD_5_9_BASE:1.155
	OPENBSD_5_8:1.126.0.4
	OPENBSD_5_8_BASE:1.126
	OPENBSD_5_7:1.125.0.2
	OPENBSD_5_7_BASE:1.125
	OPENBSD_5_6:1.121.0.4
	OPENBSD_5_6_BASE:1.121
	OPENBSD_5_5:1.117.0.2
	OPENBSD_5_5_BASE:1.117
	OPENBSD_5_4:1.103.0.2
	OPENBSD_5_4_BASE:1.103
	OPENBSD_5_3:1.92.0.2
	OPENBSD_5_3_BASE:1.92
	OPENBSD_5_2:1.57.0.2
	OPENBSD_5_2_BASE:1.57
	OPENBSD_5_1_BASE:1.47
	OPENBSD_5_1:1.47.0.2
	OPENBSD_5_0:1.44.0.2
	OPENBSD_5_0_BASE:1.44
	OPENBSD_4_9:1.37.0.2
	OPENBSD_4_9_BASE:1.37
	OPENBSD_4_8:1.33.0.2
	OPENBSD_4_8_BASE:1.33
	OPENBSD_4_7:1.26.0.2
	OPENBSD_4_7_BASE:1.26
	OPENBSD_4_6:1.13.0.4
	OPENBSD_4_6_BASE:1.13
	OPENBSD_4_5:1.6.0.2
	OPENBSD_4_5_BASE:1.6;
locks; strict;
comment	@.\" @;


1.172
date	2017.05.28.11.17.33;	author jmc;	state Exp;
branches;
next	1.171;
commitid	jivlnWwmZGuWifi1;

1.171
date	2017.05.28.09.00.24;	author jmc;	state Exp;
branches;
next	1.170;
commitid	PDlR0veLxMgntyy4;

1.170
date	2017.05.28.08.59.05;	author jmc;	state Exp;
branches;
next	1.169;
commitid	B4bspQ0XPBlr8Jc7;

1.169
date	2017.05.24.13.26.03;	author jmc;	state Exp;
branches;
next	1.168;
commitid	oOWxGfW8sqkAdaUR;

1.168
date	2017.02.13.12.23.47;	author gilles;	state Exp;
branches;
next	1.167;
commitid	YoNQfVbDQc2kwy0s;

1.167
date	2017.01.08.01.38.31;	author schwarze;	state Exp;
branches;
next	1.166;
commitid	5oyxy3xbVkyMFcxz;

1.166
date	2016.09.11.10.56.45;	author gilles;	state Exp;
branches;
next	1.165;
commitid	Kcvq04f5cRsSl4PJ;

1.165
date	2016.08.31.16.39.24;	author jmc;	state Exp;
branches;
next	1.164;
commitid	dTOgXPjFgtibmW9P;

1.164
date	2016.08.31.15.24.04;	author gilles;	state Exp;
branches;
next	1.163;
commitid	NECHGW1EDKL3apgc;

1.163
date	2016.08.31.13.55.32;	author jmc;	state Exp;
branches;
next	1.162;
commitid	vebfhUgvXcbeTB3m;

1.162
date	2016.08.31.10.18.08;	author gilles;	state Exp;
branches;
next	1.161;
commitid	jWkTljYAPNXFatSw;

1.161
date	2016.05.19.08.21.23;	author gilles;	state Exp;
branches;
next	1.160;
commitid	0ieeSEFfXl0hdSPy;

1.160
date	2016.05.11.18.34.44;	author jung;	state Exp;
branches;
next	1.159;
commitid	dW5ExizTAKW6Qz5Y;

1.159
date	2016.05.03.18.43.45;	author jung;	state Exp;
branches;
next	1.158;
commitid	gvlv4gzjODZygYCL;

1.158
date	2016.04.21.14.27.41;	author jsing;	state Exp;
branches;
next	1.157;
commitid	y261bjeJ4UOVSbjW;

1.157
date	2016.04.10.06.48.07;	author jmc;	state Exp;
branches;
next	1.156;
commitid	j0WTSzLtti7M8t32;

1.156
date	2016.03.07.16.21.48;	author gilles;	state Exp;
branches;
next	1.155;
commitid	3Mu2oGS1r04XJXs8;

1.155
date	2016.02.13.23.15.00;	author jmc;	state Exp;
branches;
next	1.154;
commitid	o6VC5BPLw6Qrylv6;

1.154
date	2016.02.13.20.56.39;	author gilles;	state Exp;
branches;
next	1.153;
commitid	uO2PMBiovEPqQ5OP;

1.153
date	2016.01.21.23.40.27;	author jung;	state Exp;
branches;
next	1.152;
commitid	4IknIYSIF99dVAK3;

1.152
date	2016.01.19.22.41.51;	author jung;	state Exp;
branches;
next	1.151;
commitid	1ep8JltHpMMlBnlY;

1.151
date	2016.01.18.22.08.28;	author jung;	state Exp;
branches;
next	1.150;
commitid	vCiUUrsdQ6FzleJh;

1.150
date	2016.01.18.08.58.10;	author jung;	state Exp;
branches;
next	1.149;
commitid	dh3RmsiHgJMTUM0r;

1.149
date	2016.01.03.17.07.36;	author gilles;	state Exp;
branches;
next	1.148;
commitid	54Dzb9YswAQkSWaJ;

1.148
date	2015.12.22.20.59.14;	author gilles;	state Exp;
branches;
next	1.147;
commitid	mBgg4EH8AZqAtO4j;

1.147
date	2015.12.15.23.16.13;	author jung;	state Exp;
branches;
next	1.146;
commitid	BvGcLYYle3KashrP;

1.146
date	2015.12.13.11.28.12;	author jmc;	state Exp;
branches;
next	1.145;
commitid	fvccZtlkuIFOpZLV;

1.145
date	2015.12.13.10.56.26;	author gilles;	state Exp;
branches;
next	1.144;
commitid	ckkMvcNwUsjU3abX;

1.144
date	2015.12.13.10.28.41;	author gilles;	state Exp;
branches;
next	1.143;
commitid	FLmHlEvs06oObGu4;

1.143
date	2015.12.12.21.13.39;	author jmc;	state Exp;
branches;
next	1.142;
commitid	u024G3RxAYnKiR2w;

1.142
date	2015.12.12.20.02.31;	author gilles;	state Exp;
branches;
next	1.141;
commitid	eO2zB2XyKCWqQLmz;

1.141
date	2015.12.12.18.49.38;	author gilles;	state Exp;
branches;
next	1.140;
commitid	wCM0D96m6r1a6i9q;

1.140
date	2015.12.12.17.16.56;	author gilles;	state Exp;
branches;
next	1.139;
commitid	O1qQ3TEBrjXRGaeN;

1.139
date	2015.12.12.11.54.42;	author jmc;	state Exp;
branches;
next	1.138;
commitid	SZjRvqw5sJy9IZ6q;

1.138
date	2015.12.12.11.31.29;	author sunil;	state Exp;
branches;
next	1.137;
commitid	xbftp8DyefrEq9pW;

1.137
date	2015.12.09.12.07.11;	author sunil;	state Exp;
branches;
next	1.136;
commitid	UWEwQOqP5uGjSGV3;

1.136
date	2015.12.03.22.15.54;	author jmc;	state Exp;
branches;
next	1.135;
commitid	CeYpd68imd217b0q;

1.135
date	2015.12.03.21.13.53;	author jung;	state Exp;
branches;
next	1.134;
commitid	PZg66PKYHekEbOLx;

1.134
date	2015.12.03.21.11.33;	author jung;	state Exp;
branches;
next	1.133;
commitid	KMDOdtoOlQlcNX1b;

1.133
date	2015.12.01.22.30.00;	author jmc;	state Exp;
branches;
next	1.132;
commitid	PLFvHmSr2nAaVmAr;

1.132
date	2015.12.01.18.22.30;	author gilles;	state Exp;
branches;
next	1.131;
commitid	qHxbKaYfo1Z7mM09;

1.131
date	2015.11.30.12.26.55;	author sunil;	state Exp;
branches;
next	1.130;
commitid	aGcPak9vEg5kOQ24;

1.130
date	2015.10.27.21.20.11;	author jung;	state Exp;
branches;
next	1.129;
commitid	YRcUZhsvrsRgoY3W;

1.129
date	2015.09.03.12.23.23;	author millert;	state Exp;
branches;
next	1.128;
commitid	jeh9d4kL79HmV0pi;

1.128
date	2015.08.15.16.09.25;	author gilles;	state Exp;
branches;
next	1.127;
commitid	9QW3QgyAHtAxL57y;

1.127
date	2015.08.11.21.57.24;	author jmc;	state Exp;
branches;
next	1.126;
commitid	VvATHQJ5ldYfNwVI;

1.126
date	2015.06.04.14.23.00;	author sobrado;	state Exp;
branches;
next	1.125;
commitid	LatYvZ5Fj37R2q09;

1.125
date	2015.03.06.17.36.47;	author millert;	state Exp;
branches;
next	1.124;
commitid	zAnVhatRZyH3BrCx;

1.124
date	2015.03.02.20.20.17;	author bentley;	state Exp;
branches;
next	1.123;
commitid	SrifJVmN05vsjTYO;

1.123
date	2014.12.13.13.36.03;	author millert;	state Exp;
branches;
next	1.122;
commitid	ISk3iOkbwCpuoz48;

1.122
date	2014.11.19.04.05.44;	author schwarze;	state Exp;
branches;
next	1.121;
commitid	qjDvSyPuZ3THJhuY;

1.121
date	2014.07.09.12.44.54;	author eric;	state Exp;
branches;
next	1.120;
commitid	4IcOkOZNwhQIYGGx;

1.120
date	2014.07.08.07.59.31;	author sobrado;	state Exp;
branches;
next	1.119;
commitid	QejPnWBk7nSpcYUN;

1.119
date	2014.06.07.07.53.32;	author jmc;	state Exp;
branches;
next	1.118;
commitid	7cABOfwciQJQAsQq;

1.118
date	2014.05.15.19.36.45;	author jmc;	state Exp;
branches;
next	1.117;

1.117
date	2014.02.16.21.59.34;	author schwarze;	state Exp;
branches;
next	1.116;

1.116
date	2014.02.04.16.32.36;	author eric;	state Exp;
branches;
next	1.115;

1.115
date	2013.12.13.21.48.28;	author jca;	state Exp;
branches;
next	1.114;

1.114
date	2013.12.13.21.45.27;	author jca;	state Exp;
branches;
next	1.113;

1.113
date	2013.12.06.10.42.15;	author eric;	state Exp;
branches;
next	1.112;

1.112
date	2013.12.05.10.27.30;	author jmc;	state Exp;
branches;
next	1.111;

1.111
date	2013.12.05.09.31.16;	author eric;	state Exp;
branches;
next	1.110;

1.110
date	2013.11.19.10.22.42;	author eric;	state Exp;
branches;
next	1.109;

1.109
date	2013.11.19.10.01.20;	author eric;	state Exp;
branches;
next	1.108;

1.108
date	2013.11.18.12.24.26;	author eric;	state Exp;
branches;
next	1.107;

1.107
date	2013.11.06.10.01.29;	author eric;	state Exp;
branches;
next	1.106;

1.106
date	2013.10.29.14.30.05;	author eric;	state Exp;
branches;
next	1.105;

1.105
date	2013.08.08.07.08.34;	author jmc;	state Exp;
branches;
next	1.104;

1.104
date	2013.08.05.07.01.45;	author jmc;	state Exp;
branches;
next	1.103;

1.103
date	2013.07.20.06.49.17;	author jmc;	state Exp;
branches;
next	1.102;

1.102
date	2013.07.19.21.14.52;	author eric;	state Exp;
branches;
next	1.101;

1.101
date	2013.07.19.20.37.07;	author eric;	state Exp;
branches;
next	1.100;

1.100
date	2013.07.19.19.10.22;	author eric;	state Exp;
branches;
next	1.99;

1.99
date	2013.07.19.13.11.18;	author eric;	state Exp;
branches;
next	1.98;

1.98
date	2013.07.19.08.12.19;	author eric;	state Exp;
branches;
next	1.97;

1.97
date	2013.06.26.07.22.20;	author gilles;	state Exp;
branches;
next	1.96;

1.96
date	2013.06.09.08.26.35;	author jmc;	state Exp;
branches;
next	1.95;

1.95
date	2013.06.09.08.22.50;	author jmc;	state Exp;
branches;
next	1.94;

1.94
date	2013.05.24.17.50.22;	author jmc;	state Exp;
branches;
next	1.93;

1.93
date	2013.05.24.17.03.14;	author eric;	state Exp;
branches;
next	1.92;

1.92
date	2013.02.17.17.45.01;	author jmc;	state Exp;
branches;
next	1.91;

1.91
date	2013.02.17.12.28.30;	author gilles;	state Exp;
branches;
next	1.90;

1.90
date	2013.02.15.22.43.21;	author eric;	state Exp;
branches;
next	1.89;

1.89
date	2013.02.14.12.32.19;	author gilles;	state Exp;
branches;
next	1.88;

1.88
date	2013.02.14.12.30.49;	author gilles;	state Exp;
branches;
next	1.87;

1.87
date	2013.02.14.07.42.49;	author jmc;	state Exp;
branches;
next	1.86;

1.86
date	2013.02.10.15.45.46;	author jmc;	state Exp;
branches;
next	1.85;

1.85
date	2013.02.10.15.23.13;	author jmc;	state Exp;
branches;
next	1.84;

1.84
date	2013.02.08.10.13.55;	author jmc;	state Exp;
branches;
next	1.83;

1.83
date	2013.02.08.08.41.10;	author jmc;	state Exp;
branches;
next	1.82;

1.82
date	2013.02.06.07.30.02;	author jmc;	state Exp;
branches;
next	1.81;

1.81
date	2013.02.05.09.49.38;	author gilles;	state Exp;
branches;
next	1.80;

1.80
date	2013.02.04.05.55.58;	author gilles;	state Exp;
branches;
next	1.79;

1.79
date	2013.01.26.17.02.52;	author jmc;	state Exp;
branches;
next	1.78;

1.78
date	2013.01.26.14.13.25;	author jmc;	state Exp;
branches;
next	1.77;

1.77
date	2013.01.26.09.37.23;	author gilles;	state Exp;
branches;
next	1.76;

1.76
date	2012.10.16.16.47.40;	author jmc;	state Exp;
branches;
next	1.75;

1.75
date	2012.10.14.12.05.14;	author gilles;	state Exp;
branches;
next	1.74;

1.74
date	2012.10.11.21.14.32;	author gilles;	state Exp;
branches;
next	1.73;

1.73
date	2012.10.10.06.02.26;	author jmc;	state Exp;
branches;
next	1.72;

1.72
date	2012.10.09.20.33.02;	author gilles;	state Exp;
branches;
next	1.71;

1.71
date	2012.10.09.18.28.09;	author gilles;	state Exp;
branches;
next	1.70;

1.70
date	2012.10.08.20.35.16;	author gilles;	state Exp;
branches;
next	1.69;

1.69
date	2012.10.05.07.00.47;	author jmc;	state Exp;
branches;
next	1.68;

1.68
date	2012.10.05.06.25.56;	author jmc;	state Exp;
branches;
next	1.67;

1.67
date	2012.10.04.19.49.53;	author gilles;	state Exp;
branches;
next	1.66;

1.66
date	2012.09.17.18.44.57;	author gilles;	state Exp;
branches;
next	1.65;

1.65
date	2012.09.01.16.09.14;	author gilles;	state Exp;
branches;
next	1.64;

1.64
date	2012.08.29.18.36.24;	author naddy;	state Exp;
branches;
next	1.63;

1.63
date	2012.08.29.18.10.28;	author jmc;	state Exp;
branches;
next	1.62;

1.62
date	2012.08.29.16.48.40;	author gilles;	state Exp;
branches;
next	1.61;

1.61
date	2012.08.29.16.26.17;	author gilles;	state Exp;
branches;
next	1.60;

1.60
date	2012.08.26.13.55.47;	author gilles;	state Exp;
branches;
next	1.59;

1.59
date	2012.08.21.22.22.00;	author jmc;	state Exp;
branches;
next	1.58;

1.58
date	2012.08.21.20.19.46;	author eric;	state Exp;
branches;
next	1.57;

1.57
date	2012.07.16.06.00.04;	author jmc;	state Exp;
branches;
next	1.56;

1.56
date	2012.07.16.05.56.16;	author jmc;	state Exp;
branches;
next	1.55;

1.55
date	2012.07.15.17.04.31;	author gilles;	state Exp;
branches;
next	1.54;

1.54
date	2012.07.08.17.17.48;	author jmc;	state Exp;
branches;
next	1.53;

1.53
date	2012.07.08.15.48.00;	author gilles;	state Exp;
branches;
next	1.52;

1.52
date	2012.05.13.13.58.31;	author jmc;	state Exp;
branches;
next	1.51;

1.51
date	2012.05.12.21.49.31;	author gilles;	state Exp;
branches;
next	1.50;

1.50
date	2012.05.12.18.41.10;	author gilles;	state Exp;
branches;
next	1.49;

1.49
date	2012.04.24.14.56.09;	author jmc;	state Exp;
branches;
next	1.48;

1.48
date	2012.04.13.07.03.02;	author jmc;	state Exp;
branches;
next	1.47;

1.47
date	2011.12.13.23.55.00;	author gilles;	state Exp;
branches;
next	1.46;

1.46
date	2011.12.13.21.47.09;	author gilles;	state Exp;
branches;
next	1.45;

1.45
date	2011.10.03.17.57.43;	author gilles;	state Exp;
branches;
next	1.44;

1.44
date	2011.06.23.20.35.22;	author sthen;	state Exp;
branches;
next	1.43;

1.43
date	2011.06.10.11.30.35;	author jmc;	state Exp;
branches;
next	1.42;

1.42
date	2011.06.09.17.41.52;	author gilles;	state Exp;
branches;
next	1.41;

1.41
date	2011.05.22.22.03.43;	author jmc;	state Exp;
branches;
next	1.40;

1.40
date	2011.05.22.21.03.14;	author gilles;	state Exp;
branches;
next	1.39;

1.39
date	2011.05.22.13.38.31;	author gilles;	state Exp;
branches;
next	1.38;

1.38
date	2011.03.15.19.24.55;	author gilles;	state Exp;
branches;
next	1.37;

1.37
date	2010.12.18.22.25.24;	author jmc;	state Exp;
branches;
next	1.36;

1.36
date	2010.10.29.09.16.08;	author gilles;	state Exp;
branches;
next	1.35;

1.35
date	2010.10.28.21.15.50;	author gilles;	state Exp;
branches;
next	1.34;

1.34
date	2010.09.08.21.40.43;	author gilles;	state Exp;
branches;
next	1.33;

1.33
date	2010.06.10.19.34.51;	author chl;	state Exp;
branches;
next	1.32;

1.32
date	2010.04.27.14.39.24;	author jmc;	state Exp;
branches;
next	1.31;

1.31
date	2010.04.27.10.17.53;	author gilles;	state Exp;
branches;
next	1.30;

1.30
date	2010.04.22.15.37.45;	author jmc;	state Exp;
branches;
next	1.29;

1.29
date	2010.04.20.20.22.29;	author jacekm;	state Exp;
branches;
next	1.28;

1.28
date	2010.04.20.20.09.40;	author jacekm;	state Exp;
branches;
next	1.27;

1.27
date	2010.04.20.19.35.28;	author jacekm;	state Exp;
branches;
next	1.26;

1.26
date	2010.02.25.14.53.37;	author stevesk;	state Exp;
branches;
next	1.25;

1.25
date	2009.10.25.22.58.51;	author gilles;	state Exp;
branches;
next	1.24;

1.24
date	2009.10.19.21.19.13;	author gilles;	state Exp;
branches;
next	1.23;

1.23
date	2009.10.16.22.29.46;	author gilles;	state Exp;
branches;
next	1.22;

1.22
date	2009.10.13.04.53.33;	author jmc;	state Exp;
branches;
next	1.21;

1.21
date	2009.10.12.22.49.10;	author gilles;	state Exp;
branches;
next	1.20;

1.20
date	2009.09.25.13.44.33;	author jmc;	state Exp;
branches;
next	1.19;

1.19
date	2009.09.23.10.26.01;	author jmc;	state Exp;
branches;
next	1.18;

1.18
date	2009.09.22.13.05.20;	author jmc;	state Exp;
branches;
next	1.17;

1.17
date	2009.09.21.10.02.50;	author jmc;	state Exp;
branches;
next	1.16;

1.16
date	2009.09.21.07.46.42;	author jmc;	state Exp;
branches;
next	1.15;

1.15
date	2009.09.19.15.51.58;	author jmc;	state Exp;
branches;
next	1.14;

1.14
date	2009.09.16.19.51.24;	author jmc;	state Exp;
branches;
next	1.13;

1.13
date	2009.06.05.23.04.51;	author jacekm;	state Exp;
branches;
next	1.12;

1.12
date	2009.05.30.23.53.41;	author gilles;	state Exp;
branches;
next	1.11;

1.11
date	2009.05.28.08.43.45;	author jacekm;	state Exp;
branches;
next	1.10;

1.10
date	2009.05.10.11.29.40;	author jacekm;	state Exp;
branches;
next	1.9;

1.9
date	2009.04.10.05.35.31;	author jmc;	state Exp;
branches;
next	1.8;

1.8
date	2009.04.09.20.32.45;	author jacekm;	state Exp;
branches;
next	1.7;

1.7
date	2009.03.17.00.18.39;	author gilles;	state Exp;
branches;
next	1.6;

1.6
date	2008.12.20.00.22.09;	author gilles;	state Exp;
branches;
next	1.5;

1.5
date	2008.12.12.17.24.51;	author jacekm;	state Exp;
branches;
next	1.4;

1.4
date	2008.12.06.02.04.56;	author gilles;	state Exp;
branches;
next	1.3;

1.3
date	2008.11.02.08.19.13;	author jmc;	state Exp;
branches;
next	1.2;

1.2
date	2008.11.02.00.01.53;	author sobrado;	state Exp;
branches;
next	1.1;

1.1
date	2008.11.01.21.35.28;	author gilles;	state Exp;
branches;
next	;


desc
@@


1.172
log
@reinstate the description of "mask-source" to "listen on socket": my changes
two revisions previous inadvertently removed it;

ok gilles
@
text
@.\"	$OpenBSD: smtpd.conf.5,v 1.171 2017/05/28 09:00:24 jmc Exp $
.\"
.\" Copyright (c) 2008 Janne Johansson <jj@@openbsd.org>
.\" Copyright (c) 2009 Jacek Masiulaniec <jacekm@@dobremiasto.net>
.\" Copyright (c) 2012 Gilles Chehade <gilles@@poolp.org>
.\"
.\" Permission to use, copy, modify, and distribute this software for any
.\" purpose with or without fee is hereby granted, provided that the above
.\" copyright notice and this permission notice appear in all copies.
.\"
.\" THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
.\" WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
.\" MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
.\" ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
.\" WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
.\" ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
.\" OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
.\"
.\"
.Dd $Mdocdate: May 28 2017 $
.Dt SMTPD.CONF 5
.Os
.Sh NAME
.Nm smtpd.conf
.Nd Simple Mail Transfer Protocol daemon configuration file
.Sh DESCRIPTION
.Nm
is the configuration file for the mail daemon
.Xr smtpd 8 .
.Pp
The current line can be extended over multiple lines using a backslash
.Pq Sq \e .
Comments can be put anywhere in the file using a hash mark
.Pq Sq # ,
and extend to the end of the current line.
Care should be taken when commenting out multi-line text:
the comment is effective until the end of the entire block.
.Pp
Argument names not beginning with a letter, digit, or underscore
must be quoted.
Arguments containing whitespace should be surrounded by double quotes
.Pq \&" .
.Pp
Macros can be defined that will later be expanded in context.
Macro names must start with a letter, digit, or underscore,
and may contain any of those characters.
Macro names may not be reserved words (for example
.Ar listen ,
.Ar accept ,
.Ar port ) .
Macros are not expanded inside quotes.
.Pp
For example:
.Bd -literal -offset indent
lan_addr = "192.168.0.1"
listen on $lan_addr
listen on $lan_addr tls auth
.Ed
.Pp
Additional configuration files can be included with the
.Ic include
keyword, for example:
.Bd -literal -offset indent
include "/etc/mail/smtpd.conf.local"
.Ed
.Pp
The syntax of
.Nm
is described below.
.Bl -tag -width Ds
.It Ic accept | reject
.Xr smtpd 8
accepts and rejects messages
based on information gathered during the SMTP session.
.Pp
For each message processed by the daemon,
the rules are evaluated in sequential order,
from first to last.
The first matching rule decides what action is taken.
If no rule matches the message,
the default action is to reject the message.
An exclamation mark may be specified to perform a reverse match.
.Pp
Following the accept/reject
decision comes the matching of optional session related properties:
.Bl -tag -width Ds
.It Xo
.Op Ic \&!
.Ic authenticated
.Xc
If specified, the rule will only be matched if the client session was
authenticated either by requesting authentication over the network or
because the message was submitted over the local enqueuer.
.It Xo
.Ic tagged
.Op Ic \&!
.Ar tag
.Xc
If specified, the rule will only be matched if the client session was tagged with
.Ar tag .
.El
.Pp
After that the client's IP address rule is specified:
.Bl -tag -width Ds
.It Ic from any
Make the rule match regardless of the IP of connecting client.
.It Xo
.Ic from
.Op Ic \&!
.Ic local
.Xc
The rule matches only locally originating connections.
This is the default,
and may be omitted.
.It Xo
.Ic from
.Op Ic \&!
.Ic source
.Pf < Ar table Ns >
.Xc
The rule matches if the connection is made from a client whose address
is declared in the table
.Ar table .
.El
.Pp
In addition, finer access control may be achieved on the sender if desired:
.Bl -tag -width Ds
.It Xo
.Ic sender
.Op Ic \&!
.Pf < Ar senders Ns >
.Xc
If specified, the rule will only be matched if the sender email address
is found in the table
.Ar senders .
The table may contain complete email addresses or apply to an entire
domain if prefixed with
.Sq @@ .
.El
.Pp
Next comes the selection based on the domain the message is sent to:
.Bl -tag -width Ds
.It Ic for any Op Ic alias No < Ns Ar aliases Ns >
Make the rule match regardless of the domain it is sent to.
If specified, the table
.Ar aliases
is used for looking up alternative destinations for all addresses.
.It Ic for any virtual No < Ns Ar vmap Ns >
Make the rule match regardless of the domain it is sent to.
The
.Ar vmap
table will be used as the virtual domain mapping.
.It Xo
.Ic for
.Op Ic \&!
.Ic domain
.Ar domain
.Op Ic alias No < Ns Ar aliases Ns >
.Xc
This rule applies to mail destined for the specified
.Ar domain .
This parameter supports the
.Sq *
wildcard,
so that a single rule for all sub-domains can be used, for example:
.Bd -literal -offset indent
accept for domain "*.example.com" deliver to mbox
.Ed
.Pp
If specified, the table
.Ar aliases
is used for looking up alternative destinations for addresses in this
.Ar domain .
.It Xo
.Ic for
.Op Ic \&!
.Ic domain
.Pf < Ar domains Ns >
.Op Ic alias No < Ns Ar aliases Ns >
.Xc
This rule applies to mail destined to domains which are part of the table
.Ar domains .
.Pp
If specified, the table
.Ar aliases
is used for looking up alternative destinations for addresses in these
.Ar domains .
.It Xo
.Ic for
.Op Ic \&!
.Ic domain
.Ar domain
.Ic virtual No < Ns Ar users Ns >
.Xc
This rule applies to mail destined for the specified virtual
.Ar domain .
This parameter supports the
.Sq *
wildcard,
so that a single rule for all sub-domains can be used, for example:
.Bd -literal -offset indent
accept for domain "*.example.com" \e
       virtual <users> deliver to mbox
.Ed
.Pp
The table
.Ar users
holds a key-value mapping of virtual to system users.
For an example of how to configure the
.Ar users
table, see
.Xr table 5 .
.It Xo
.Ic for
.Op Ic \&!
.Ic domain
.Pf < Ar domains Ns > Ic virtual No < Ns Ar users Ns >
.Xc
This rule applies to mail destined for the virtual domains specified
in the table
.Ar domains .
.Pp
The table
.Ar users
holds a key-value mapping of virtual to system users.
For an example of how to configure the
.Ar users
table, see
.Xr table 5 .
.It Xo
.Ic for
.Op Ic \&!
.Ic local
.Op Ic alias No < Ns Ar aliases Ns >
.Xc
This rule applies to mail destined to
.Dq localhost
and to the default server name
(the
.Sx FILES
entry for
.Pa /etc/mail/mailname
details how the server name is determined).
This is the default,
and may be omitted.
.Pp
If specified, the table
.Ar aliases
is used for looking up alternative destinations for addresses in these
.Ar domains .
.It Xo
.Ic for
.Op Ic \&!
.Ic local
.Ic virtual No < Ns Ar vmap Ns >
.Xc
This rule applies to mail destined to
.Dq localhost
and to the default server name.
The
.Ar vmap
table will be used as the virtual domain mapping.
.El
.Pp
Further access control may be achieved on specific recipients if desired:
.Bl -tag -width Ds
.It Xo
.Ic recipient
.Op Ic \&!
.Pf < Ar recipients Ns >
.Xc
If specified, the rule will only be matched if the recipient email address
is found in the table
.Ar recipients .
The table may contain complete email addresses or apply to an entire
domain if prefixed with
.Sq @@ .
.El
.Pp
If the method of delivery is local, a user database may be
specified to override the system database:
.Bl -tag -width Ds
.It Op Ic userbase No < Ns Ar table Ns >
Look up users in the table
.Ar table
instead of performing system lookups using the
.Xr getpwnam 3
function.
.El
.Pp
You can also accept mail just to have it forwarded elsewhere:
.Bl -tag -width Ds
.It Ic forward-only
Mail is accepted for local recipients ONLY if it is redirected to an
external address via an alias or a ~/.forward file.
.Pp
Example:
.Bd -literal -offset indent
accept for domain opensmtpd.org forward-only
.Ed
.El
.Pp
Finally, the method of delivery is specified:
.Bl -tag -width Ds
.It Xo
.Ic deliver to lmtp
.Op Ar host : Ns Ar port | socket
.Op Ic rcpt-to
.Op Ic as Ar user
.Xc
Mail is delivered to
.Ar host : Ns Ar port ,
or to the
.Ux
.Ar socket
over LMTP with the privileges of the specified
.Ar user .
.Pp
Optionally,
.Ic rcpt-to
might be specified to use the recipient email address (after expansion) instead
of the local user in the LMTP session as RCPT TO.
.It Ic deliver to maildir Op Ar path
Mail is added to a maildir.
Its location,
.Ar path ,
may contain format specifiers that are expanded before use
.Pq see Sx FORMAT SPECIFIERS .
If
.Ar path
is not provided, then
.Pa ~/Maildir
is assumed.
.It Ic deliver to mbox
Mail is delivered to the local user's system mailbox in
.Pa /var/mail .
.It Ic deliver to mda Ar program Op Ic as Ar user
Mail is piped to the specified
.Ar program ,
which is run with the privileges of the specified
.Ar user
or the user the message is destined to.
This parameter may use conversion specifiers that are expanded before use
.Pq see Sx FORMAT SPECIFIERS .
.It Xo
.Bk -words
.Ic relay
.Op Ic backup Op Ar mx
.Op Ic as Ar address
.Op Ic source No < Ns Ar source Ns >
.Op Ic hostname Ar name
.Op Ic hostnames No < Ns Ar names Ns >
.Op Ic pki Ar pkiname
.Op Ic tls Op Ic verify
.Ek
.Xc
.Pp
Mail is relayed.
The routing decision is based on the DNS system.
.Pp
If the
.Ic backup
parameter is specified, the current server will act as a backup server
for the target domain.
Accepted mails are only relayed through servers with a lower preference
value in the MX record for the domain than the one specified in
.Ar mx .
If
.Ar mx
is not specified, the default server name will be assumed.
.Pp
If the
.Ic as
parameter is specified,
.Xr smtpd 8
will rewrite the sender advertised
in the SMTP session.
.Ar address
may be a user, a domain prefixed with
.Sq @@ ,
or an email address, causing
.Xr smtpd 8
to rewrite the user-part, the domain-part, or the entire address, respectively.
.Pp
If the
.Ic source
parameter is specified,
.Xr smtpd 8
will explicitly bind to an address found in the table referenced by
.Ar source
when connecting to the relay.
If the table contains more than one address, they are picked in turn each
time a new connection is opened.
.Pp
By default, when connecting to a remote server,
.Xr smtpd 8
advertises its default server name.
A
.Ic hostname
parameter may be specified to advertise the alternate hostname
.Ar name .
If the
.Ic source
parameter is used, the
.Ic hostnames
parameter may be specified to advertise a hostname based on
the source address.
Table
.Ar names
contains a mapping of IP addresses to hostnames and
.Xr smtpd 8
will automatically select the name that matches its source address
when connected to the remote server.
The
.Ic hostname
and
.Ic hostnames
parameters are mutually exclusive.
.Pp
When relaying, STARTTLS is always attempted if available on remote host and
.Xr smtpd 8
will try to present a certificate matching the outgoing hostname if one is
registered in the pki.
If
.Ic pki
is specified, the certificate registered for
.Ar pkiname
is used instead.
.Pp
If
.Ic tls
is specified,
.Xr smtpd 8
will refuse to relay unless the remote host provides STARTTLS.
If
.Ic tls verify
is specified,
.Xr smtpd 8
will refuse to relay unless the remote host provides STARTTLS and the
certificate it presented has been verified.
.Pp
Note that the
.Ic tls
and
.Ic tls verify
options should only be used in private networks
as they will prevent proper relaying on the Internet.
.It Xo
.Ic relay via
.Ar host
.Op Ic auth No < Ns Ar auth Ns >
.Op Ic as Ar address
.Op Ic source No < Ns Ar source Ns >
.Op Ic hostname Ar name
.Op Ic hostnames No < Ns Ar names Ns >
.Op Ic pki Ar pkiname
.Op Ic verify
.Xc
.Pp
Mail is relayed through the specified
.Ar host
expressed as a URL.
For example:
.Bd -literal -offset indent
smtp://mx1.example.org		# use SMTP
smtp://mx1.example.org:4321	# use SMTP \e
				# with port 4321
lmtp://localhost:2026		# use LMTP \e
				# with port 2026
.Ed
.Pp
The communication channel may be secured using one of the secure
schemas.
For example:
.Bd -literal -offset indent
tls://mx1.example.org		# use TLS
smtps://mx1.example.org		# use SMTPS
secure://mx1.example.org	# try SMTPS and \e
				# fallback to TLS
.Ed
.Pp
In addition, credentials for authenticated relaying may be provided
when using a secure schema.
For example:
.Bd -literal -offset indent
tls+auth://label@@mx.example.org	    # over TLS
smtps+auth://label@@mx.example.org   # over SMTPS
secure+auth://label@@mx.example.org  # over either \e
				    # SMTPS or TLS
.Ed
.Pp
If a pki entry exists for the outgoing hostname, or one is provided
with
.Ar pkiname ,
the associated certificate will be sent to the remote server.
.Pp
If an SMTPAUTH session with
.Ar host
is desired, the
.Ic auth
parameter is used to specify the
.Ar auth
table that holds the credentials.
Credentials will be looked up using the label provided in the URL.
.Pp
If the
.Ic as
parameter is specified,
.Xr smtpd 8
will rewrite the sender advertised
in the SMTP session.
.Ar address
may be a user, a domain prefixed with
.Sq @@ ,
or an email address, causing
.Xr smtpd 8
to rewrite the user-part, the domain-part, or the entire address, respectively.
.Pp
If the
.Ic source
parameter is specified,
.Xr smtpd 8
will explicitly bind to an address found in the table referenced by
.Pf < Ar source Ns >
when connecting to the relay.
If the table contains more than one address, they are picked in turn each
time a new connection is opened.
.Pp
By default, when connecting to a remote server,
.Xr smtpd 8
advertises its default server name.
A
.Ic hostname
parameter may be specified to advertise the alternate hostname
.Ar name .
If the
.Ic source
parameter is used, the
.Ic hostnames
parameter may be specified to advertise a hostname based on
the source address.
Table
.Ar names
contains a mapping of IP addresses to hostnames and
.Xr smtpd 8
will automatically select the name that matches its source address
when connected to the remote server.
The
.Ic hostname
and
.Ic hostnames
parameters are mutually exclusive.
.Pp
If
.Ic verify
is specified,
.Xr smtpd 8
will refuse to relay unless the remote host provides STARTTLS and the
certificate it presented has been verified.
The relay URL must specify TLS for this option to be valid.
.El
.Pp
Additional per-rule adjustments are available:
.Bl -tag -width Ds
.It Xo
.Ic expire
.Sm off
.Ar n
.Brq Cm s | m | h | d
.Sm on
.Xc
Specify how long a message that matched this rule can stay in the queue.
.El
.It Xo
.Ic bounce-warn
.Sm off
.Ar n
.Brq Cm s | m | h | d
.Oo ,
.Sm on
.Ar ...
.Oc
.Xc
Specify the delays for which temporary failure reports must be generated
when messages are stuck in the queue.
For example:
.Bd -literal -offset indent
bounce-warn	1h, 6h, 2d
.Ed
.Pp
will generate a failure report when an envelope is in the queue for more
than one hour, six hours and two days.
The default is 4h.
.It Ic ca Ar hostname Ic certificate Ar cafile
Associate a custom CA certificate located in
.Ar cafile
with
.Ar hostname .
.It Ic ciphers Ar cipher-list
Specify an alternate list of ciphers to use when establishing TLS sessions.
It is highly recommended to avoid making use of this option unless there
is a good understanding of the implications.
.Pp
When not specified, only ciphers considered safe are chosen.
.It Xo
.Ic expire
.Sm off
.Ar n
.Brq Cm s | m | h | d
.Sm on
.Xc
Specify how long a message can stay in the queue.
The default value is 4d.
For example:
.Bd -literal -offset indent
expire 4d	# expire after 4 days
expire 10h	# expire after 10 hours
.Ed
.It Xo
.Ic limit session
.Brq Cm max-rcpt | max-mails
.Ar num
.Xc
Instruct
.Xr smtpd 8
to accept a maximum number of recipients or emails at once
in the receiving queue.
Defaults are 100 for
.Ic max-mails
and 1000 for
.Ic max-rcpt .
.It Xo
.Ic limit mta
.Op Ic for Ic domain Ar domain
.Ar family
.Xc
Instruct
.Xr smtpd 8
to only use the specified address
.Ar family
for outgoing connections.
Accepted values are
.Ic inet4
and
.Ic inet6 .
If a
.Ar domain
is specified, the restriction only applies when connecting
to MXs for this domain.
.It Ic limit scheduler max-inflight Ar num
Suspend the scheduling of envelopes for deliver/relay until the number
of inflight envelopes falls below
.Ar num .
Changing the default value might degrade performance.
.It Xo
.Ic listen on socket
.Op Ic mask-source
.Xc
Specify a
.Ic socket
to listen on for incoming connections.
This directive is used to modify the behavior of the listener handling
messages submitted through the local enqueuer, for example via the
.Xr mail 1
utility.
It is optional: if unspecified then
.Xr smtpd 8
will simply listen for connections on the
.Ic socket
as if it was configured with no option.
Clients connecting through the
.Ic socket
will always be tagged with the 'local'
.Ic tag .
.Pp
If the
.Ic mask-source
parameter is used, then the listener will skip the
.Ic from
part when prepending the
.Dq Received
header.
.It Xo
.Bk -words
.Ic listen on Ar interface
.Op Ar family
.Op Ic port Ar port
.Op Ic tls | tls-require | tls-require verify | smtps | secure
.Op Ic pki Ar pkiname
.Op Ic ca Ar caname
.Op Ic auth | auth-optional Op < Ns Ar authtable Ns >
.Op Ic tag Ar tag
.Op Ic hostname Ar hostname
.Op Ic hostnames No < Ns Ar names Ns >
.Op Ic senders No < Ns Ar users Ns > Op Cm masquerade
.Op Ic mask-source
.Op Ic received-auth
.Op Ic no-dsn
.Ek
.Xc
Specify an
.Ar interface
and optional
.Ar port
to listen on for incoming connections.
An interface group, an IP address or a domain name may
be used in place of
.Ar interface .
The
.Ar family
parameter can be used to listen only on specific address family.
Accepted values are
.Ic inet4
and
.Ic inet6 .
.Pp
Secured connections are provided either using STARTTLS
.Pq Ic tls ,
by default on port 25,
or SMTPS
.Pq Ic smtps ,
by default on port 465.
.Ic tls-require
may be used to force clients to establish a secure connection
before being allowed to start an SMTP transaction.
.Pp
If
.Ic tls-require verify
is specified, the client must provide a valid certificate to be
able to establish an SMTP session.
.Pp
.Ic secure
may be specified to provide both STARTTLS and SMTPS services.
Host certificates may be used for these connections,
and must be previously declared using the pki directive.
If
.Ic pki
is specified,
a certificate matching
.Ic name
is searched for.
Moreover, a previously declared
.Ic ca
directive may be specified to use a custom CA certificate.
.Pp
If the
.Ic auth
parameter is used,
then a client may only start an SMTP transaction after a
successful authentication.
Any remote sender that passed SMTPAUTH is treated as if
it was the server's local user that was sending the mail.
This means that filter rules using
.Ic from local
will be matched.
If
.Ic auth-optional
is specified, then SMTPAUTH is not required to establish an
SMTP transaction.
This is only useful to let a listener accept incoming mail from
untrusted senders and outgoing mail from authenticated users in
situations where it is not possible to listen on the submission
port.
.Pp
Both
.Ic auth
and
.Ic auth-optional
accept an optional table as a parameter.
When provided, credentials are looked up in this table.
The credentials format is described in
.Xr table 5 .
.Pp
If the
.Ic tag
parameter is used, then clients connecting to the listener will be
tagged
.Ar tag .
.Pp
If the
.Ic hostname
parameter is used, then it will be used in the greeting banner
instead of the default server name.
.Pp
The
.Ic hostnames
parameter overrides the server name for specific addresses.
Table
.Ar names
contains a mapping of IP addresses to hostnames and
.Xr smtpd 8
will use the hostname that matches the address on which the connection arrives
if it is found in the mapping.
.Pp
If the
.Ic senders
parameter is used, then
.Xr smtpd 8
will look up a mapping of username to email addresses to see whether
the authenticated user is allowed to submit mail
as the sender that was provided in the SMTP session.
In addition, if the
.Cm masquerade
option is provided,
the From header will be rewritten
to match the sender provided in the SMTP session.
.Pp
If the
.Ic mask-source
parameter is used, then the listener will skip the
.Ic from
part when prepending the
.Dq Received
header.
.Pp
If the
.Ic received-auth
parameter is used, the
.Dq Received
header will display if the session was authenticated and by which local user.
.Pp
If the
.Ic no-dsn
parameter is used, DSN (Delivery Status Notification) extension will not
be enabled.
.It Ic max-message-size Ar n
Specify a maximum message size of
.Ar n
bytes.
The argument may contain a multiplier, as documented in
.Xr scan_scaled 3 .
The default maximum message size is 35MB if none is specified.
.It Ic pki Ar hostname Ic certificate Ar certfile
Associate the certificate located in
.Ar certfile
with
.Ar hostname .
.Pp
If a fallback certificate or SNI is wanted, the
.Sq *
wildcard may be used as
.Ar hostname .
.Pp
A certificate chain may be created by appending one or many certificates,
including a Certificate Authority certificate,
to
.Ar certfile .
.Pp
Creation of certificates is documented in
.Xr starttls 8 .
.It Ic pki Ar hostname Ic key Ar keyfile
Associate the key located in
.Ar keyfile
with
.Ar hostname .
.It Ic pki Ar hostname Ic dhe Ar params
Specify the DHE parameters to use for DHE cipher suites with
.Ar hostname .
Valid parameter values are none, legacy and auto.
For legacy a fixed key length of 1024 bits is used, whereas for auto the key
length is determined automatically.
The default is none, which disables DHE cipher suites.
.It Ic queue compression
Enable transparent compression of envelopes and messages.
The only supported algorithm at the moment is gzip.
Envelopes and messages may be inspected using the
.Xr smtpctl 8
or
.Xr gzcat 1
utilities.
.It Ic queue encryption Op key Ar key
Enable transparent encryption of envelopes and messages.
.Ar key
must be a 16-byte random key in hexadecimal representation.
It can be obtained using the
.Xr openssl 1
utility as follow:
.Bd -literal -offset indent
$ openssl rand \-hex 16
.Ed
.Pp
If the
.Ar key
parameter is not specified, it is read with
.Xr getpass 3
at startup.
If
.Ar key
is
.Ic stdin ,
then it is read from the standard input at startup.
.Pp
The only supported algorithm is AES-256 in GCM mode.
Envelopes and messages may be inspected using the
.Xr smtpctl 8
utility.
.Pp
Queue encryption can be used with queue compression and will always
perform compression before encryption.
.It Ic subaddressing-delimiter Ar delimiter
Redefine the subaddressing delimiter from the default
.Sq +
to
.Ar delimiter .
.Pp
Any printable character valid in an email address is allowed,
except spaces and
.Sq @@ .
.Pp
The first character in the user-part of an email address that matches
.Ar delimiter
is considered to be the subaddressing delimiter.
.It Ic table Ar name Oo Ar type : Oc Ns Ar config
Tables are used to provide additional configuration information for
.Xr smtpd 8
in the form of lists or key-value mappings.
The format of the entries depends on what the table is used for.
Refer to
.Xr table 5
for the exhaustive documentation.
.Pp
The table is identified using table name
.Ar name ;
the name itself is arbitrarily chosen.
.Pp
.Ar type
specifies the table backend,
and should be one of the following:
.Pp
.Bl -tag -width "fileXXX" -compact
.It db
Information is stored in a file created using
.Xr makemap 8 .
.It file
Information is stored in a plain text file using the
same format as used to generate
.Xr makemap 8
mappings.
This is the default.
.El
.Pp
.Ar config
specifies a configuration file for the table data.
It must be an absolute path to a file for the
.Dq file
and
.Dq db
table types.
.It Ic table Ar name Brq Ar value Op , Ar ...
Tables containing list of static values may be declared
using an inlined notation.
.Pp
The table is identified using table name
.Ar name ;
the name itself is arbitrarily chosen.
.Pp
The table must contain at least one value and may declare many values as a
list of comma-separated strings.
.It Ic table Ar name Brq Ar key Ns = Ns Ar value Op , Ar ...
Tables containing static key-value mappings may be declared
using an inlined notation.
.Pp
The table is identified using table name
.Ar name ;
the name itself is arbitrarily chosen.
.Pp
The table must contain at least one key-value mapping and may declare
many mappings as a list of comma-separated
.Ar key Ns = Ns Ar value
descriptions.
.El
.Ss FORMAT SPECIFIERS
Some configuration directives support expansion of their parameters at runtime.
Such directives (for example
.Ic deliver to maildir ,
.Ic deliver to mda )
may use format specifiers which will be expanded before delivery or
relaying.
The following formats are currently supported:
.Bl -column %{user.directory} -offset indent
.It %{sender}         Ta sender email address
.It %{sender.user}    Ta user part of the sender email address
.It %{sender.domain}  Ta domain part of the sender email address
.It %{rcpt}           Ta recipient email address
.It %{rcpt.user}      Ta user part of the recipient email address
.It %{rcpt.domain}    Ta domain part of the recipient email address
.It %{dest}           Ta recipient email address after expansion
.It %{dest.user}      Ta user part after expansion
.It %{dest.domain}    Ta domain part after expansion
.It %{user.username}  Ta local user
.It %{user.directory} Ta home directory of the local user
.El
.Pp
Expansion formats also support partial expansion using the optional
bracket notations with substring offset.
For example, with recipient domain
.Dq example.org :
.Bl -column %{rcpt.domain[0:-4]} -offset indent
.It %{rcpt.domain[0]}    Ta expands to Dq e
.It %{rcpt.domain[1]}    Ta expands to Dq x
.It %{rcpt.domain[8:]}   Ta expands to Dq org
.It %{rcpt.domain[-3:]}  Ta expands to Dq org
.It %{rcpt.domain[0:6]}  Ta expands to Dq example
.It %{rcpt.domain[0:-4]} Ta expands to Dq example
.El
.Pp
In addition, modifiers may be applied to the token.
For example, with recipient
.Dq User+Tag@@Example.org :
.Bl -column %{rcpt:lowercase|strip} -offset indent
.It %{rcpt:lowercase}       Ta expands to Dq user+tag@@example.org
.It %{rcpt:uppercase}       Ta expands to Dq USER+TAG@@EXAMPLE.ORG
.It %{rcpt:strip}           Ta expands to Dq User@@Example.org
.It %{rcpt:lowercase|strip} Ta expands to Dq user@@example.org
.El
.Pp
For security concerns, expanded values are sanitized and potentially
dangerous characters are replaced with
.Sq \&: .
In situations where they are desirable, the
.Dq raw
modifier may be applied.
For example, with recipient
.Dq user+t?g@@example.org :
.Bl -column %{rcpt:raw} -offset indent
.It %{rcpt}     Ta expands to Dq user+t:g@@example.org
.It %{rcpt:raw} Ta expands to Dq user+t?g@@example.org
.El
.Sh FILES
.Bl -tag -width "/etc/mail/smtpd.confXXX" -compact
.It Pa /etc/mail/smtpd.conf
Default
.Xr smtpd 8
configuration file.
.It Pa /etc/mail/mailname
If this file exists,
the first line is used as the server name.
Otherwise, the server name is derived from the local hostname returned by
.Xr gethostname 3 ,
either directly if it is a fully qualified domain name,
or by retrieving the associated canonical name through
.Xr getaddrinfo 3 .
.It Pa /var/spool/smtpd/
Spool directories for mail during processing.
.El
.Sh EXAMPLES
The default
.Nm
file which ships with
.Ox
listens on the loopback network interface (lo0),
and allows for mail from users and daemons on the local machine,
as well as permitting email to remote servers.
Some more complex configurations are given below.
.Pp
This first example is the same as the default configuration,
but all outgoing mail is forwarded to a remote SMTP server.
A secrets file is needed to specify a username and password:
.Bd -literal -offset indent
# touch /etc/mail/secrets
# chmod 640 /etc/mail/secrets
# chown root:_smtpd /etc/mail/secrets
# echo "label username:password" > /etc/mail/secrets
.Ed
.Pp
.Nm
would look like this:
.Bd -literal -offset indent
table aliases file:/etc/mail/aliases
table secrets file:/etc/mail/secrets

listen on lo0

accept for local alias <aliases> deliver to mbox
accept for any relay via tls+auth://label@@smtp.example.com \e
	auth <secrets>
.Ed
.Pp
In this second example,
the aim is to permit mail relaying for any user that can authenticate
using their normal login credentials.
An RSA certificate must be provided to prove the server's identity.
The mail server listens on all interfaces the default route(s) point to.
Mail with a local destination should be sent to an external mda.
First, the RSA certificate is created:
.Bd -literal -offset indent
# openssl genrsa \-out /etc/ssl/private/mail.example.com.key 4096
# openssl req \-new \-x509 \-key /etc/ssl/private/mail.example.com.key \e
	\-out /etc/ssl/mail.example.com.crt \-days 365
# chmod 600 /etc/ssl/mail.example.com.crt
# chmod 600 /etc/ssl/private/mail.example.com.key
.Ed
.Pp
In the example above,
a certificate valid for one year was created.
The configuration file would look like this:
.Bd -literal -offset indent
pki mail.example.com certificate "/etc/ssl/mail.example.com.crt"
pki mail.example.com key "/etc/ssl/private/mail.example.com.key"

table aliases file:/etc/mail/aliases

listen on lo0
listen on egress tls pki mail.example.com auth

accept for local alias <aliases> deliver to mda "/path/to/mda \-f \-"
accept from any for domain example.com \e
	deliver to mda "/path/to/mda \-f \-"
accept for any relay
.Ed
.Pp
For sites that wish to sign messages using DKIM, the
.Em dkimproxy
package may be used as a filter.
The following example is the same as the default configuration,
but all outgoing mail is passed to dkimproxy_out on port 10027
for signing.
The signed messages are received on port 10028 and tagged for relaying.
.Bd -literal -offset indent
table aliases file:/etc/mail/aliases

listen on lo0
listen on lo0 port 10028 tag DKIM

accept for local alias <aliases> deliver to mbox
accept tagged DKIM for any relay
accept from local for any relay via smtp://127.0.0.1:10027
.Ed
.Pp
Sites that accept non-local messages may be able to cut down on the
volume of spam received by rejecting forged messages that claim
to be from the local domain.
The table
.Em other-relays
can be used to specify the IP addresses of relays that may legitimately
originate mail with your domain as the sender.
.Bd -literal -offset indent
table aliases file:/etc/mail/aliases
table other-relays file:/etc/mail/other-relays

listen on lo0
listen on egress

accept for local alias <aliases> deliver to mbox
accept from local for any relay
reject from ! source <other-relays> sender "@@example.com" for any
accept from any for domain example.com \e
	alias <aliases> deliver to mbox
.Ed
.Sh SEE ALSO
.Xr mailer.conf 5 ,
.Xr table 5 ,
.Xr makemap 8 ,
.Xr smtpd 8
.Sh HISTORY
.Xr smtpd 8
first appeared in
.Ox 4.6 .
@


1.171
log
@mark up "masquerade";
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.170 2017/05/28 08:59:05 jmc Exp $
d675 8
@


1.170
log
@split the two "listen on" directives into two separate items;
the markup that we were using wouldn;t have worked with groff anyway
but, more worringly, it didn;t work with mandoc either;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.169 2017/05/24 13:26:03 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: May 24 2017 $
d687 1
a687 1
.Op Ic senders No < Ns Ar users Ns > Op masquerade
d794 3
a796 1
In addition, if the masquerade option is provided,
@


1.169
log
@document that "for local" is the default; while here,
paste in the "table <aliases>" text;

ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.168 2017/02/13 12:23:47 gilles Exp $
d20 1
a20 1
.Dd $Mdocdate: February 13 2017 $
d658 18
a675 1
.br
d693 1
a693 4
.Pp
Specify a
.Ic socket
or an
d695 2
a697 20
The
.Ic listen on socket
directive is used to modify the behavior of the listener handling
messages submitted through the local enqueuer, for example via the
.Xr mail 1
utility.
This is an optional directive: if unspecified then
.Xr smtpd 8
will simply listen for connections on the
.Ic socket
as if it was configured with no option.
Clients connecting through the
.Ic socket
will always be tagged with the 'local'
.Ic tag .
.Pp
To listen on a specific network interface, specify an
.Ar interface
and an optional
.Ar port .
@


1.168
log
@allow negation of authenticated keyword:
	accept ! authenticated [...]

ok sunil@@, jung@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.167 2017/01/08 01:38:31 schwarze Exp $
d20 1
a20 1
.Dd $Mdocdate: January 8 2017 $
d238 2
a239 2
and to the default server name.
See the
d243 8
a250 1
below for details of how the server name is determined.
@


1.167
log
@delete three macro lines that have no effect, found with mandoc -Tlint
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.166 2016/09/11 10:56:45 gilles Exp $
d20 1
a20 1
.Dd $Mdocdate: September 11 2016 $
d87 4
a90 1
.It Ic authenticated
@


1.166
log
@remove documentation for filters, we'll document when it's ready
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.165 2016/08/31 16:39:24 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: August 31 2016 $
a90 3
.El
.Pp
.Bl -tag -width Ds
@


1.165
log
@no need for Xo/Xc here, plus minor tweak;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.164 2016/08/31 15:24:04 gilles Exp $
a611 14
.It Ic filter Ar name filter Op Ar arguments
Specify a filter with the given
.Ar name
and the program
.Ar filter
using the given filter
.Ar arguments .
Filters are used to hook into the SMTP dialog and provide additional filtering
options for
.Xr smtpd 8 .
.It Ic filter Ar name Ic chain Ar filter Ar ...
Specify a filter chain with the given
.Ar name
and filters.
a649 1
.Op Ic filter Ar name
a655 1
.Op Ic filter Ar name
a704 6
.Pp
A
.Ic filter
may be specified to use a filter or filter chain with the given
.Ar name
on SMTP transactions.
@


1.164
log
@introduce "authenticated" parameter so rules may apply to authenticated
sessions specifically

ok eric@@, sunil@@, jung@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.163 2016/08/31 13:55:32 jmc Exp $
d87 1
a87 3
.It Xo
.Ic authenticated
.Xc
d90 1
a90 1
because message was submitted over the local enqueuer.
@


1.163
log
@word fix;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.162 2016/08/31 10:18:08 gilles Exp $
d85 10
a94 1
decision comes the optional tag matching:
@


1.162
log
@allow overriding the subaddressing delimiter with subaddressing-delimiter
keyword, the default is still +

ok eric@@, sunil@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.161 2016/05/19 08:21:23 gilles Exp $
d20 1
a20 1
.Dd $Mdocdate: May 19 2016 $
d909 1
a909 1
but spaces and
@


1.161
log
@table formats are described in table(5) not makemap(8)
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.160 2016/05/11 18:34:44 jung Exp $
d20 1
a20 1
.Dd $Mdocdate: May 11 2016 $
d902 13
@


1.160
log
@mention ca option in listen directive

same spelling fix from jmc and gilles

ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.159 2016/05/03 18:43:45 jung Exp $
d20 1
a20 1
.Dd $Mdocdate: May 3 2016 $
d205 1
a205 1
.Xr makemap 8 .
d222 1
a222 1
.Xr makemap 8 .
@


1.159
log
@listen directive may use a table for authentication, to make this work the
table has to be defined BEFORE
consequently move all tables in the examples to the beginning and before the
listen directive to avoid tables not being found

no functional change

ran into this myself earlier, also reported by cjones via irc

ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.158 2016/04/21 14:27:41 jsing Exp $
d20 1
a20 1
.Dd $Mdocdate: April 21 2016 $
d667 1
d746 3
@


1.158
log
@Use automatic DH parameters, instead of fixed ones. Also disable DHE by
default since it is computationally expensive and a potential DoS vector.

ok gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.157 2016/04/10 06:48:07 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: April 10 2016 $
a1053 1
listen on lo0
d1056 3
d1086 2
a1090 2
table aliases file:/etc/mail/aliases

d1105 2
a1109 2
table aliases file:/etc/mail/aliases

d1123 3
a1127 3

table aliases file:/etc/mail/aliases
table other-relays file:/etc/mail/other-relays
@


1.157
log
@arguments to "chain" are space separated, not comma; verified by jung
diff from david+bsd

i also removed Op, since ... is enough/
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.156 2016/03/07 16:21:48 gilles Exp $
d20 1
a20 1
.Dd $Mdocdate: March 7 2016 $
d854 2
a855 4
.It Ic pki Ar hostname Ic dhparams Ar dhfile
Associate the Diffie-Hellman parameters located in
.Ar dhfile
with
d857 4
a860 8
.Pp
The parameters are used for ephemeral key exchange.
If not specified,
.Xr smtpd 8
will use safely generated built-in parameters.
.Pp
Creation of Diffie-Hellman parameters is documented in
.Xr openssl 1 .
@


1.156
log
@fix error in documentation of `ca' keyword

From: Sevan Janiyan <venture37@@geeklan.co.uk>
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.155 2016/02/13 23:15:00 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: February 13 2016 $
d615 1
a615 1
.It Ic filter Ar name Ic chain Ar filter Op , Ar ...
@


1.155
log
@tweak previous;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.154 2016/02/13 20:56:39 gilles Exp $
d580 1
a580 1
.It Ic ca Ar hostname Ic ca Ar cafile
@


1.154
log
@describe how 'listen on socket' works

original diff from Peter Bisroev <peter@@int19h.net>
rewording from me, linebreaks from jung@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.153 2016/01/21 23:40:27 jung Exp $
d20 1
a20 1
.Dd $Mdocdate: January 21 2016 $
a655 1
.Bk -words
a658 1
.Ek
d686 1
a686 1
messages submitted through the local enqueuer, for example, via the
d689 1
a689 1
This is an optional directive, if unspecified then
@


1.153
log
@another round of tiny wording tweaks and unifications

all from tj

ok millert
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.152 2016/01/19 22:41:51 jung Exp $
d20 1
a20 1
.Dd $Mdocdate: January 19 2016 $
d657 6
d680 3
a682 1
Specify an
d684 21
a704 3
and
.Ar port
to listen on.
@


1.152
log
@minor tweaks: remove comma, remove superflous plural s, add the word "file"
after ~/.forward, and change builtin to built-in

from tj

ok millert@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.151 2016/01/18 22:08:28 jung Exp $
d20 1
a20 1
.Dd $Mdocdate: January 18 2016 $
d586 1
a586 1
Specify an alternate ciphers list to use when establishing TLS sessions.
d599 1
a599 1
The default value is 4 days.
d747 1
a747 1
Credentials format is described in
d925 1
a925 1
list of comma separated strings.
d935 1
a935 1
many mappings as a list of comma separated
@


1.151
log
@minor tweaks: add single quote to @@ char, add .Ic markup to forward-only,
fix end of list marker, and add an 'are'

ok millert (to an earlier version without end of list fix and without 'are')
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.150 2016/01/18 08:58:10 jung Exp $
d281 1
a281 1
external address via an alias or a ~/.forward.
d654 1
a654 1
Changing the default value might degrade performances.
d692 1
a692 1
may be specified, to use a filter or filter chain with the given
d839 1
a839 1
will use safely generated builtin parameters.
@


1.150
log
@unify and add some more smtpd(8) references

ok sunil gilles eric
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.149 2016/01/03 17:07:36 gilles Exp $
d20 1
a20 1
.Dd $Mdocdate: January 3 2016 $
d130 2
a131 1
domain if prefixed with @@.
d279 1
a279 1
.It forward-only
a538 1
.El
d547 1
d549 1
a549 1
Additional per-rule adjustments available:
@


1.149
log
@fix wording which becomes confusing now that filters is a real thing
diff from Marcus MERIGHI <mcmer-openbsd@@tor.at>

ok jmc@@

while at it, fixed an example
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.148 2015/12/22 20:59:14 gilles Exp $
d20 1
a20 1
.Dd $Mdocdate: December 22 2015 $
d367 2
a368 2
smtpd to rewrite the user-part, the domain-part, or the entire address,
respectively.
d405 4
a408 3
When relaying, STARTTLS is always attempted if available on remote host
and OpenSMTPD will try to present a certificate matching the outgoing
hostname if one is registered in the pki.
d417 3
a419 2
is specified, OpenSMTPD will refuse to relay unless the remote host provides
STARTTLS.
d422 4
a425 2
is specified, OpenSMTPD will refuse to relay unless the remote host provides
STARTTLS and the certificate it presented has been verified.
d501 2
a502 2
smtpd to rewrite the user-part, the domain-part, or the entire address,
respectively.
d542 4
a545 2
is specified, OpenSMTPD will refuse to relay unless the remote host provides
STARTTLS and the certificate it presented has been verified.
d836 3
a838 1
If not specified, OpenSMTPD will use safely generated builtin parameters.
@


1.148
log
@update examples
diff from Serguey Parkhomovsky <sergueyparkhomovsky@@gmail.com>

ok sunil@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.147 2015/12/15 23:16:13 jung Exp $
d20 1
a20 1
.Dd $Mdocdate: December 15 2015 $
d77 1
a77 1
the filter rules are evaluated in sequential order,
d96 1
a96 1
After that the client's IP address filter is specified:
d119 1
a119 1
In addition, finer filtering may be achieved on the sender if desired:
d250 1
a250 1
Further filtering may be achieved on specific recipients if desired:
d1097 2
a1098 2
table aliases   db:/etc/mail/aliases.db
table other-relays "/etc/mail/other-relays"
@


1.147
log
@less macro and lines

ok millert
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.146 2015/12/13 11:28:12 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: December 13 2015 $
a1021 1
# makemap /etc/mail/secrets
d1028 2
a1029 2
table aliases db:/etc/mail/aliases.db
table secrets db:/etc/mail/secrets.db
d1060 1
a1060 1
table aliases db:/etc/mail/aliases.db
d1079 1
a1079 1
table aliases db:/etc/mail/aliases.db
@


1.146
log
@less macro;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.145 2015/12/13 10:56:26 gilles Exp $
d643 1
a643 4
.It Xo
.Ic limit scheduler max-inflight
.Ar num
.Xc
@


1.145
log
@document filter keyword
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.118 2014/05/15 19:36:45 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: May 15 2014 $
d598 1
a598 3
.It Xo
.Ic filter Ar name Ar filter Op Ar arguments
.Xc
d608 1
a608 3
.It Xo
.Ic filter Ar name Ic chain Ar filter Op , Ar ...
.Xc
@


1.144
log
@document wildcard pki/ca
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.143 2015/12/12 21:13:39 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: December 12 2015 $
d599 18
d660 1
d689 6
@


1.143
log
@tweaks;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.142 2015/12/12 20:02:31 gilles Exp $
d786 5
@


1.142
log
@remove CA from pki and no longer allow specifying a CA with 'pki' keyword.
introduce 'ca' keyword to allow specifying a custom CA.
making CA part of pki was a bad idea and several people hit use-cases that
plain couldn't work.

instead of:
    pki foobar.org ca "/etc/mail/CA.pem"

use now:
    ca foobar.org certificate "/etc/mail/CA.pem"


ok sunil@@, jung@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.141 2015/12/12 18:49:38 gilles Exp $
d578 1
a578 3
.It Xo
.Ic ciphers Ar cipher-list
.Xc
d580 1
a580 1
It is highly recommanded to avoid making use of this option unless there
d753 2
a754 1
In addition, if the masquerade option is provided, the From header will be rewritten
@


1.141
log
@when using senders map to restrict email address a user may use in SMTP
dialogue, if `masquerade' is used as a parameter then rewrite the email
address of the DATA From header to the email address in the map.
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.140 2015/12/12 17:16:56 gilles Exp $
d573 5
a798 5
with
.Ar hostname .
.It Ic pki Ar hostname Ic ca Ar cafile
Associate a custom CA certificate
.Ar cafile
@


1.140
log
@allow overriding the default cipher-suite

ok jung@@, sunil@@, millert@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.139 2015/12/12 11:54:42 jmc Exp $
d645 1
a645 1
.Op Ic senders No < Ns Ar users Ns >
d750 2
@


1.139
log
@tweak previous;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.138 2015/12/12 11:31:29 sunil Exp $
d573 8
@


1.138
log
@Implement senders map.

senders table allows to restrict the addresses that an authenticated
user can use in the SMTP dialogue.

Ok gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.137 2015/12/09 12:07:11 sunil Exp $
d20 1
a20 1
.Dd $Mdocdate: December 9 2015 $
d739 3
a741 2
will lookup in a mapping of username to email addresses if the authenticated
user is allowed to submit mail as the sender that was provided in the smtp session.
@


1.137
log
@Document forward-only keyword. From Jason Barbier <jabarb@@serversave.us>

Ok gilles@@ jung@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.136 2015/12/03 22:15:54 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: December 3 2015 $
d637 1
d734 7
@


1.136
log
@
new sentence, new line;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.135 2015/12/03 21:13:53 jung Exp $
d274 12
@


1.135
log
@remove trailing whitespace
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.134 2015/12/03 21:11:33 jung Exp $
d582 3
a584 1
to accept a maximum number of recipients or emails at once in the receiving queue. Defaults are 100 for
@


1.134
log
@introduce limit session keyword replacing fixed values

original diff from Renaud Allard

ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.133 2015/12/01 22:30:00 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: December 1 2015 $
d580 1
a580 1
Instruct   
d582 3
a584 3
to accept a maximum number of recipients or emails at once in the receiving queue. Defaults are 100 for 
.Ic max-mails 
and 1000 for 
@


1.133
log
@missing articles in previous;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.132 2015/12/01 18:22:30 gilles Exp $
d575 11
@


1.132
log
@add received-auth parameter to listener to identify authenticated sessions
in locally appended Received header when enabled

ok millert@@, jung@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.131 2015/11/30 12:26:55 sunil Exp $
d20 1
a20 1
.Dd $Mdocdate: November 30 2015 $
d719 1
a719 1
parameter is used,
d721 1
a721 1
header will display if session was authenticated and by which local user.
@


1.131
log
@While delivering to lmtp or mda, accept optional "as user" parameter
whose privileges would be used instead of the default.

Ok gilles@@ jung@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.130 2015/10/27 21:20:11 jung Exp $
d20 1
a20 1
.Dd $Mdocdate: October 27 2015 $
d613 1
d716 6
@


1.130
log
@add a rcpt-to parameter to be able to use the original (probably expanded)
RCPT TO within LMTP sessions

ok gilles eric
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.129 2015/09/03 12:23:23 millert Exp $
d20 1
a20 1
.Dd $Mdocdate: September 3 2015 $
d282 1
d289 2
a290 1
over LMTP.
d310 1
a310 1
.It Ic deliver to mda Ar program
d313 3
a315 1
which is run with the privileges of the user the message is destined to.
@


1.129
log
@Document spool dir in smtpd's FILES section and be consistent with
using compact lists for FILES in the other manual pages.  OK gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.128 2015/08/15 16:09:25 gilles Exp $
d20 1
a20 1
.Dd $Mdocdate: August 15 2015 $
d278 5
a282 1
.It Ic deliver to lmtp Op Ar host : Ns Ar port | socket
d289 5
@


1.128
log
@change "priorly" to "previously", it reads better
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.127 2015/08/11 21:57:24 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: August 11 2015 $
d902 1
a902 1
.Bl -tag -width "/etc/mail/smtpd.confXXX"
@


1.127
log
@tls and verify are not mutually exclusive;
pointed out by l?vai d?niel and david dahlberg

ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.126 2015/06/04 14:23:00 sobrado Exp $
d20 1
a20 1
.Dd $Mdocdate: June 4 2015 $
d638 1
a638 1
and must be priorly declared using the pki directive.
@


1.126
log
@spacing, makes example fit on display.

no objection from gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.125 2015/03/06 17:36:47 millert Exp $
d20 1
a20 1
.Dd $Mdocdate: March 6 2015 $
d314 1
a314 1
.Op Ic tls | verify
a392 1
.Pp
d394 1
a394 1
.Ic verify
d401 2
a402 2
.Ic verify
options are mutually exclusive and should only be used in private networks
@


1.125
log
@Document how to use anti-spoofing rules to reject spam.
OK deraadt@@ gilles@@ phessler@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.124 2015/03/02 20:20:17 bentley Exp $
d20 1
a20 1
.Dd $Mdocdate: March 2 2015 $
d443 4
a446 4
tls+auth://label@@mx.example.org		# over TLS
smtps+auth://label@@mx.example.org	# over SMTPS
secure+auth://label@@mx.example.org	# over either \e
					# SMTPS or TLS
@


1.124
log
@Cleanup smtpd.conf(5).

 - use literal <> around smtpd tables instead of Aq
 - mark up some directives as Ic (previously Ar or unmarked)
 - use Dq/Sq instead of " in a few appropriate places
 - use Bl -column instead of Bd -literal for tables

ok schwarze@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.123 2014/12/13 13:36:03 millert Exp $
d20 1
a20 1
.Dd $Mdocdate: December 13 2014 $
d979 1
a979 1
accept from any for domain example.org \e
d994 1
d996 1
d1000 21
@


1.123
log
@Add DKIM signing example based on eric@@'s asiabsdcon slides
OK gilles@@ jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.122 2014/11/19 04:05:44 schwarze Exp $
d20 1
a20 1
.Dd $Mdocdate: November 19 2014 $
d112 1
a112 1
.Aq Ar table
d124 1
a124 1
.Aq Ar senders
d135 1
a135 1
.It Ic for any Op Ic alias Aq Ar aliases
d140 1
a140 1
.It Ic for any virtual Aq Ar vmap
d150 1
a150 1
.Op Ic alias Aq Ar aliases
d170 2
a171 2
.Aq Ar domains
.Op Ic alias Aq Ar aliases
d185 1
a185 1
.Ic virtual Aq Ar users
d209 1
a209 2
.Ao Ar domains
.Ac Ic virtual Aq Ar users
d226 1
a226 1
.Op Ic alias Aq Ar aliases
d240 1
a240 1
.Ic virtual Aq Ar vmap
d255 1
a255 1
.Aq Ar recipients
d268 1
a268 1
.It Op Ic userbase Aq Ar table
d310 1
a310 1
.Op Ic source Aq Ar source
d312 1
a312 1
.Op Ic hostnames Aq Ar names
d408 1
a408 1
.Op Ic auth Aq Ar auth
d410 1
a410 1
.Op Ic source Aq Ar source
d412 1
a412 1
.Op Ic hostnames Aq Ar names
d481 1
a481 1
.Aq Ar source
d596 1
a596 1
.Op Ic auth | auth-optional Op Aq Ar authtable
d599 1
a599 1
.Op Ic hostnames Aq Ar names
d654 3
a656 1
This means that filter rules using "from local" will be matched.
d698 5
a702 2
parameter is used, then the listener will skip the "from" part
when prepending the "Received" header.
d775 3
a777 1
is "stdin", then it is read from the standard input at startup.
d848 2
a849 2
.Ar deliver to maildir ,
.Ar deliver to mda )
d853 13
a865 13
.Bd -literal -offset indent
%{sender}	     sender email address
%{sender.user}	     user part of the sender email address
%{sender.domain}     domain part of the sender email address
%{rcpt}              recipient email address
%{rcpt.user}	     user part of the recipient email address
%{rcpt.domain}	     domain part of the recipient email address
%{dest}              recipient email address after expansion
%{dest.user}	     user part after expansion
%{dest.domain}	     domain part after expansion
%{user.username}     local user
%{user.directory}    home directory of the local user
.Ed
d869 10
a878 9
For example, with recipient domain "example.org":
.Bd -literal -offset indent
%{rcpt.domain[0]}	expands to "e"
%{rcpt.domain[1]}	expands to "x"
%{rcpt.domain[8:]}	expands to "org"
%{rcpt.domain[-3:]}	expands to "org"
%{rcpt.domain[0:6]}	expands to "example"
%{rcpt.domain[0:-4]}	expands to "example"
.Ed
d881 8
a888 7
For example, with recipient "User+Tag@@Example.org":
.Bd -literal -offset indent
%{rcpt:lowercase}	expands to "user+tag@@example.org"
%{rcpt:uppercase}	expands to "USER+TAG@@EXAMPLE.ORG"
%{rcpt:strip}		expands to "User@@Example.org"
%{rcpt:lowercase|strip}	expands to "user@@example.org"
.Ed
d891 11
a901 7
dangerous characters are replaced with ":".
In situations where they are desirable, the "raw" modifier may be applied.
For example, with recipient "user+t?g@@example.org":
.Bd -literal -offset indent
%{rcpt}		expands to "user+t:g@@example.org"
%{rcpt:raw}	expands to "user+t?g@@example.org"
.Ed
@


1.122
log
@two obvious markup fixes; from frankgroeneveld dot nl
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.121 2014/07/09 12:44:54 eric Exp $
d20 1
a20 1
.Dd $Mdocdate: July 9 2014 $
d970 16
@


1.121
log
@add a "no-dsn" listener option to disable DSN extension.
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.118 2014/05/15 19:36:45 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: May 15 2014 $
d90 1
a90 1
.Ic tag
d286 1
a286 1
.It Ic deliver to maildir Ar path
@


1.120
log
@fix typos.

ok jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.119 2014/06/07 07:53:32 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: June 7 2014 $
d602 1
d699 5
@


1.119
log
@Clint Pachl points out "authtable" is optional;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.118 2014/05/15 19:36:45 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: May 15 2014 $
d896 1
a896 1
or by retreiving the associated canonical name through
@


1.118
log
@use <> for tables;
original report from creamy;
diff from Frank Brodbeck, tweaked
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.117 2014/02/16 21:59:34 schwarze Exp $
d20 1
a20 1
.Dd $Mdocdate: February 16 2014 $
d597 1
a597 1
.Op Ic auth | auth-optional Aq Ar authtable
@


1.117
log
@1) Fix the markup of the time specifications,
which is quite tricky (discussed with jmc@@).
2) Also fix the display of literal exclamation marks: Do not
use \! - in roff(7), that's an arcane thing called the "transparent
line indicator", which doesn't render as '!' with groff,
and which isn't implemented at all in mandoc.
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.116 2014/02/04 16:32:36 eric Exp $
d20 1
a20 1
.Dd $Mdocdate: February 4 2014 $
d112 1
a112 1
.Ic table
d124 1
a124 1
.Ic senders
d256 1
a256 1
.Ar recipients
d307 1
d311 1
a311 2
.Op Ic source Ar source
.Bk -words
d313 1
a313 2
.Op Ic hostnames Ar names
.Ek
d316 1
d318 1
d411 1
a411 1
.Op Ic source Ar source
d413 1
a413 1
.Op Ic hostnames Ar names
d417 1
d482 1
a482 1
.Ar table
d597 1
a597 1
.Op Ic auth | auth-optional | auth Ar authtable | Ic auth-optional Ar authtable
d600 1
a600 1
.Op Ic hostnames Ar names
d604 1
d668 1
a668 1
accept a table as parameter.
@


1.116
log
@update documentation
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.112 2013/12/05 10:27:30 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: December 5 2013 $
d89 1
a89 1
.Op Ic \!
d102 1
a102 1
.Op Ic \!
d110 1
a110 1
.Op Ic \!
d123 1
a123 1
.Op Ic \!
d147 1
a147 1
.Op Ic \!
d168 1
a168 1
.Op Ic \!
d182 1
a182 1
.Op Ic \!
d207 1
a207 1
.Op Ic \!
d225 1
a225 1
.Op Ic \!
d239 1
a239 1
.Op Ic \!
d519 7
a525 1
.It Ic expire Ar n Brq Ar s|m|h|d
d528 10
a537 1
.It Ic bounce-warn Ar n Bro Ar s|m|h|d Brc Bq , Ar ...
d548 7
a554 1
.It Ic expire Ar n Brq Ar s|m|h|d
@


1.115
log
@Give format specifiers their own subsection, so that we can reference it
from other places.  ok brett@@ jmc@@ gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.113 2013/12/06 10:42:15 eric Exp $
d20 1
a20 1
.Dd $Mdocdate: December 6 2013 $
d42 1
a42 1
.Pq \(dq .
d519 1
a519 1
.It Ic expire Ar n Brq Ar s\*(Bam\*(Bah\*(Bad
d522 1
a522 1
.It Ic bounce-warn Ar n Bro Ar s\*(Bam\*(Bah\*(Bad Brc Bq , Ar ...
d533 1
a533 1
.It Ic expire Ar n Brq Ar s\*(Bam\*(Bah\*(Bad
d731 1
a731 1
$ openssl rand -hex 16
d894 1
a894 1
# echo "label username:password" \*(Gt /etc/mail/secrets
d917 3
a919 3
# openssl genrsa -out /etc/ssl/private/mail.example.com.key 4096
# openssl req -new -x509 -key /etc/ssl/private/mail.example.com.key \e
	-out /etc/ssl/mail.example.com.crt -days 365
d936 1
a936 1
accept for local alias <aliases> deliver to mda "/path/to/mda -f -"
d938 1
a938 1
	deliver to mda "/path/to/mda -f -"
@


1.114
log
@Use \(dq instead of \&" to print a double quote on a macro line.
Documented by mandoc_char(7), and plays nicer with syntax hilighting
editors.  ok brett@@ jmc@@ gilles@@
@
text
@d291 1
a291 1
(see above).
d305 1
a305 1
(see above).
d809 1
a809 1
.Pp
@


1.113
log
@"verify" is already documented with "tls-require verify".
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.112 2013/12/05 10:27:30 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: December 5 2013 $
d42 1
a42 1
.Pq \&" .
@


1.112
log
@minor tweaks;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.111 2013/12/05 09:31:16 eric Exp $
a578 1
.Op Ic verify
a673 6
.Pp
If the listener is configured to provide SMTPS or STARTTLS and the
.Ic verify
parameter is used, then clients will be required to present a
certificate that can be verified before a SMTP session can be
initiated.
@


1.111
log
@document "verify" keyword and "authtable" option on "listen" rules
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.105 2013/08/08 07:08:34 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: August 8 2013 $
d391 1
a391 1
is specified, OpenSMTPD will refuse to relay unless remote host provides
d396 1
a396 1
is specified, OpenSMTPD will refuse to relay unless remote host provides
d513 1
a513 1
is specified, OpenSMTPD will refuse to relay unless remote host provides
d610 2
a611 2
is specified, the client mus provide a valid certificate to be
able to establish a SMTP session.
@


1.110
log
@Allow '*' in the user part of mailaddresses.  By default, potentially dangerous
characters are replaced when expanding for local deliveries, unless the "raw"
modifier is specified.
@
text
@d414 1
d511 6
d572 1
a572 1
.Op Ic tls | tls-require | smtps | secure
d574 1
a574 1
.Op Ic auth | auth-optional
d607 6
d640 9
@


1.109
log
@Add a limit on the number of inflight envelopes.  The scheduler suspends
scheduling of mta/mda envelopes until the number of inflight envelopes
falls below that line.
@
text
@d836 9
@


1.108
log
@Allow overriding the local ca
@
text
@d553 8
@


1.107
log
@Much much improved config parser and related changes.
Simplify code and do not impose an order on conditions and rule options.

Format changes that may require smtpd.conf update for some setups:

- SSL certificates are no longer automatically loaded, but must be
  explicitely declared using the "pki" keyword.
- "certificate" option becomes "pki" in listener and accept rules.
- "ssl://" becomes "secure://" in relay via rules.
- "helo" becomes "hostnames" in relay rules

New features:

- accept rules do not need an explicit action, in which case alias table
  or .forward must provide one.
- new "forward-only" action to force relaying and reject rcpts that expand
  as local delivery.
- "!" (negation) modifier on rule matching conditions.
- new "recipient" rule matching condition.
- new "verify" option on listeners and relay rules to reject invalid
  certificates.

Other changes:

- remember the helo name advertised on incoming mail and use it for sending
  bounces.
- bump envelope version (existing envelopes are updated on-the-fly).
@
text
@d676 5
@


1.106
log
@use "/etc/mail/mailname" instead of "/etc/mailname" and make it a define.
@
text
@d82 1
d85 12
a96 1
decision comes the client's IP address filter:
d100 5
a104 1
.It Ic from local
d108 6
a113 5
.It Ic from Ar network
The rule matches if the connection is made from the specified
.Ar network ,
specified in CIDR notation.
.It Ic from Aq Ar table
a116 3
.It Ic tagged Ar tag
If specified, the rule will only be matched if the client session was tagged
.Ar tag .
d121 5
a125 1
.It Ic sender Ar senders
d145 7
a151 1
.It Ic for domain Ar domain Op Ic alias Aq Ar aliases
d166 7
a172 1
.It Ic for domain Aq Ar domains Op Ic alias Aq Ar aliases
d180 7
a186 1
.It Ic for domain Ar domain Ic virtual Aq Ar users
d205 7
a211 1
.It Ic for domain Ao Ar domains Ac Ic virtual Aq Ar users
d223 6
a228 1
.It Ic for local Op Ic alias Aq Ar aliases
d237 6
a242 1
.It Ic for local virtual Aq Ar vmap
d251 15
d311 6
a316 1
.Op Ic helo Ar names
d350 1
a350 1
.Ar table
d359 9
a367 2
.Ic helo
parameter may be specified to advertise an alternate hostname.
d374 31
a407 1
.Op Ic certificate Ar name
d411 3
a413 1
.Op Ic helo Ar names
d433 1
a433 1
ssl://mx1.example.org		# try SMTPS and \e
d441 4
a444 4
tls+auth://label@@mx.example.org	  # over TLS
smtps+auth://label@@mx.example.org # over SMTPS
ssl+auth://label@@mx.example.org	  # over either \e
				  # SMTPS or TLS
d447 4
a450 8
If a certificate
.Ar name
is specified and exists in the
.Pa /etc/mail/certs
directory with a .crt extension, it will be used if the remote server
requests a client certificate.
Creation of certificates is documented in
.Xr starttls 8 .
d488 9
a496 2
.Ic helo
parameter may be specified to advertise an alternate hostname.
d503 5
d557 2
a558 2
.Op Ic tls | tls-require | smtps
.Op Ic certificate Ar name
d562 3
d592 2
d595 1
a595 3
and are searched for in the
.Pa /etc/mail/certs
directory.
d597 1
a597 1
.Ic certificate
d599 3
a601 23
a certificate
.Ao Ar name Ac Ns .crt ,
a key
.Ao Ar name Ac Ns .key
and Diffie-Hellman parameters
.Ao Ar name Ac Ns .dh
are searched for.
A certificate authority may be appended to the .crt
file to create a certificate chain.
If no
.Ic certificate
is specified,
the default interface name is instead used,
for example
.Pa fxp0.crt ,
.Pa fxp0.key ,
.Pa fxp0.ca ,
and
.Pa fxp0.dh .
If no DH parameters are provided, smtpd will use
built-in parameters.
Creation of certificates is documented in
.Xr starttls 8 .
d630 21
d658 29
d695 1
a695 1
.It Ic queue encryption key Ar key
d706 9
d726 4
d880 5
a884 4
# openssl genrsa -out /etc/mail/certs/mail.example.com.key 4096
# openssl req -new -x509 -key /etc/mail/certs/mail.example.com.key \e
	-out /etc/mail/certs/mail.example.com.crt -days 365
# chmod 600 /etc/mail/certs/mail.example.com.*
d891 3
d895 2
a896 1
listen on egress tls certificate mail.example.com auth
d898 1
d906 1
@


1.105
log
@move the parameter expansion text to after the config options text,
to avoid overwhelming the reader;

ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.104 2013/08/05 07:01:45 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: August 5 2013 $
d188 1
a188 1
.Pa /etc/mailname
d664 1
a664 1
.It Pa /etc/mailname
@


1.104
log
@better document /etc/mailname;
ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.103 2013/07/20 06:49:17 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: July 20 2013 $
a59 42
Some configuration directives support expansion of their parameters at runtime.
Such directives (for example
.Ar deliver to maildir ,
.Ar deliver to mda )
may use format specifiers which will be expanded before delivery or
relaying.
The following formats are currently supported:
.Bd -literal -offset indent
%{sender}	     sender email address
%{sender.user}	     user part of the sender email address
%{sender.domain}     domain part of the sender email address
%{rcpt}              recipient email address
%{rcpt.user}	     user part of the recipient email address
%{rcpt.domain}	     domain part of the recipient email address
%{dest}              recipient email address after expansion
%{dest.user}	     user part after expansion
%{dest.domain}	     domain part after expansion
%{user.username}     local user
%{user.directory}    home directory of the local user
.Ed
.Pp
Expansion formats also support partial expansion using the optional
bracket notations with substring offset.
For example, with recipient domain "example.org":
.Bd -literal -offset indent
%{rcpt.domain[0]}	expands to "e"
%{rcpt.domain[1]}	expands to "x"
%{rcpt.domain[8:]}	expands to "org"
%{rcpt.domain[-3:]}	expands to "org"
%{rcpt.domain[0:6]}	expands to "example"
%{rcpt.domain[0:-4]}	expands to "example"
.Ed
.Pp
In addition, modifiers may be applied to the token.
For example, with recipient "User+Tag@@Example.org":
.Bd -literal -offset indent
%{rcpt:lowercase}	expands to "user+tag@@example.org"
%{rcpt:uppercase}	expands to "USER+TAG@@EXAMPLE.ORG"
%{rcpt:strip}		expands to "User@@Example.org"
%{rcpt:lowercase|strip}	expands to "user@@example.org"
.Ed
.Pp
d616 42
@


1.103
log
@tweak previous;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.102 2013/07/19 21:14:52 eric Exp $
d20 1
a20 1
.Dd $Mdocdate: July 19 2013 $
d226 6
a231 1
and to the default server name (see below).
d235 1
a235 1
and to the default server name (see below).
d300 1
a300 1
is not specified, default server name (see below) will be assumed.
d327 1
a327 1
advertises its default server name (see below).
d421 1
a421 1
advertises its default server name (see below).
d569 1
a569 1
instead of the default server name (see below).
a657 14
.Sh DEFAULT SERVER NAME
The default server name is the hostname that
.Xr smtpd 8
operates as, which is used at various places.
It is determined at startup as follows.
.Pp
If a
.Pa /etc/mailname
file exists, then the first line is read and used as the server name.
Otherwise, the server name is derived from the local hostname returned by
.Xr gethostname 3 ,
either directly if it is a fully-qualified domain name,
or by retreiving the associated canonical name through
.Xr getaddrinfo 3 .
d659 1
a659 1
.Bl -tag -width "/etc/mail/smtpd.confXXX" -compact
d665 7
a671 1
Alternate server name to use.
@


1.102
log
@Many MTA improvements:

- Better transient error handling logic: failing destinations are
  automatically disabled for a while.  When a destination is active
  again, ask the scheduler to retry previous envelopes immediatly.
- More informative error report when all routes fail for a mail.
- Implement a "smtpctl show hoststats" command to get the latest stat
  message per MX domain.
- Implement a "smtpctl show routes" command to show the state the
  currently known routes to remote MXs.
- Implement a "smtpctl resume route" command to re-enable a route that
  has been disabled.
- Do not hardcode limits
- Minor code improvements
@
text
@d1 1
a1 1
.\"	$OpenBSD$
d20 1
a20 1
.Dd $Mdocdate: May 24 2013 $
a452 1
.Bk -words
a455 1
.Ek
d461 1
a461 1
for out-going connections.
d583 1
a583 1
must be a 16 bytes random key in hexadecimal representation.
d585 1
a585 1
.Xr openssl
@


1.101
log
@Assorted queue improvements:
- cleanup the internal queue backend API and get rid of the QOP_* thing.
- implement a queue_proc backend
- rename queue_fsqueue.c to queue_fs
- enable support for queue encryption
- add an envelope cache
- better logging and error reporting
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.100 2013/07/19 19:10:22 eric Exp $
d20 1
a20 1
.Dd $Mdocdate: July 19 2013 $
d315 1
a315 1
.Ar source
d409 1
a409 1
.Ar source
d452 20
@


1.100
log
@Allow to specify an address family on a listener
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.99 2013/07/19 13:11:18 eric Exp $
d562 18
@


1.99
log
@Improve and document the way the default server name is found.
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.98 2013/07/19 08:12:19 eric Exp $
d455 1
d472 7
@


1.98
log
@Introduce expand string modifiers
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.97 2013/06/26 07:22:20 gilles Exp $
d20 1
a20 1
.Dd $Mdocdate: June 26 2013 $
d226 1
a226 3
and to the server's fully qualified domain name,
as returned by
.Xr hostname 1 .
d230 1
a230 3
and to the server's fully qualified domain name,
as returned by
.Xr hostname 1 .
d295 1
a295 1
is not specified, local hostname will be assumed.
d320 1
a320 1
By default,
d322 1
a322 1
advertises its local hostname when connecting to a remote server.
d413 5
d537 2
a538 1
parameter is used, then it will be used in the greeting banner.
d609 14
d629 2
@


1.97
log
@paragraph still mentions an interface name when the example below no longer
does, reported by Tyler Morgan and Scott Vanderbilt

ok jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.96 2013/06/09 08:26:35 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: June 9 2013 $
d91 9
@


1.96
log
@oops! one more instance of previous...
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.95 2013/06/09 08:22:50 jmc Exp $
d643 1
a643 1
The mail server has an external interface bnx0.
@


1.95
log
@the argument name for "source" is "source", not "table";
from MrD
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.94 2013/05/24 17:50:22 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: May 24 2013 $
d404 1
a404 1
.Ar table
@


1.94
log
@tweak the "deliver to lmtp" text, and zap an extraneous space;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.93 2013/05/24 17:03:14 eric Exp $
d310 1
a310 1
.Ar table
@


1.93
log
@sync with OpenSMTPD 5.3.2

ok gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.92 2013/02/17 17:45:01 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: February 17 2013 $
d90 1
a90 1
%{rcpt.domain[0:-4]} 	expands to "example"
d244 1
a244 1
.It Ic deliver to lmtp Ar [host:port|socket]
d246 4
a249 3
.Pa host:port
or to the unix socket
.Pa socket
@


1.92
log
@zap the surrounding whitespace and mark up for "=";
ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.91 2013/02/17 12:28:30 gilles Exp $
d244 6
d534 8
@


1.91
log
@disable queue compression temporarily, we lack the smtpctl bits
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.90 2013/02/15 22:43:21 eric Exp $
d20 1
a20 1
.Dd $Mdocdate: February 15 2013 $
d570 1
a570 1
.It Ic table Ar name Brq Ar key = value Op , Ar ...
d580 1
a580 1
.Ar key = value
@


1.90
log
@add missing bits for lmtp support (from Ashish SHUKLA).

ok gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.89 2013/02/14 12:32:19 gilles Exp $
d20 1
a20 1
.Dd $Mdocdate: February 14 2013 $
a527 6
.It Ic queue compression Op Ar gzip
Enable transparent deflating and inflating of all envelopes
and messages.
The only supported algorithm at the moment is gzip.
Envelopes and messages may be inspected using
.Xr gzcat 1 .
@


1.89
log
@- change => to = in documentation
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.88 2013/02/14 12:30:49 gilles Exp $
d337 2
@


1.88
log
@- smtpctl trace expand, enables tracing of aliases expansion
- replace "users" keyword with "userbase" when providing alternate userbase
- disambiguise expansion nodes when expanding across domains and userbases
- allow use of '=' instead of '=>' when declaring a mapping

ok eric@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.87 2013/02/14 07:42:49 jmc Exp $
d574 1
a574 1
.It Ic table Ar name Brq Ar key => value Op , Ar ...
d584 1
a584 1
.Ar key => value
@


1.87
log
@simplify markup for the "table" keyword; ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.86 2013/02/10 15:45:46 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: February 10 2013 $
d234 1
a234 1
.It Op Ic users Aq Ar table
@


1.86
log
@remove some unneeded Xo/Xc.
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.85 2013/02/10 15:23:13 jmc Exp $
d564 1
a564 6
.It Xo
.Ic table Ar name
.Ic { Ar value
.Op , Ar value_n
.Ic }
.Xc
d574 1
a574 6
.It Xo
.Ic table Ar name
.Ic { Ar key => value
.Op , key_n => value_n
.Ic }
.Xc
@


1.85
log
@do not mark up punctuation; ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.84 2013/02/08 10:13:55 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: February 8 2013 $
d150 1
a150 4
.It Xo
.Ic for any
.Op Ic alias Aq Ar aliases
.Xc
d155 1
a155 4
.It Xo
.Ic for any
.Ic virtual Aq Ar vmap
.Xc
d160 1
a160 4
.It Xo
.Ic for domain Ar domain
.Op Ic alias Aq Ar aliases
.Xc
d175 1
a175 4
.It Xo
.Ic for domain Aq Ar domains
.Op Ic alias Aq Ar aliases
.Xc
d183 1
a183 3
.It Xo
.Ic for domain Ar domain Ic virtual Aq Ar users
.Xc
d214 1
a214 4
.It Xo
.Ic for local
.Op Ic alias Aq Ar aliases
.Xc
d220 1
a220 4
.It Xo
.Ic for local
.Ic virtual Aq Ar vmap
.Xc
d526 1
a526 4
.It Xo
.Ic queue
.Ic compression Op Ar gzip
.Xc
d532 1
a532 4
.It Xo
.Ic table Ar name
.Oo Ar type : Oc Ns Ar config
.Xc
@


1.84
log
@the per-rule "expire" does not really fit in its current section,
so move it into its own little bit;

ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.83 2013/02/08 08:41:10 jmc Exp $
d129 1
a129 1
.It Ic from Ar <table>
d152 1
a152 1
.Op Ic alias Ar <aliases>
d160 1
a160 1
.Ic virtual Ar <vmap>
d168 1
a168 1
.Op Ic alias Ar <aliases>
d185 2
a186 2
.Ic for domain Ar <domains>
.Op Ic alias Ar <aliases>
d196 1
a196 1
.Ic for domain Ar domain Ic virtual Ar <users>
d216 1
a216 1
.It Ic for domain Ar <domains> Ic virtual Ar <users>
d230 1
a230 1
.Op Ic alias Ar <aliases>
d239 1
a239 1
.Ic virtual Ar <vmap>
d254 1
a254 3
.It Xo
.Op Ic users Ar <table>
.Xc
d344 1
a344 1
.Op Ic auth Ar <auth>
d431 1
a431 1
.It Ic expire Ar n {s|m|h|d}
d434 1
a434 1
.It Ic bounce-warn Ar n {s|m|h|d} [, ...]
d445 1
a445 1
.It Ic expire Ar n {s|m|h|d}
d557 1
a557 1
.Ar [type:]config
@


1.83
log
@order the syntax alphabetically; ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.82 2013/02/06 07:30:02 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: February 6 2013 $
a285 2
.It Ic expire Ar n {s|m|h|d}
Specify how long a message that matched this rule can stay in the queue.
d429 6
@


1.82
log
@- for "listen on", use "keeps" to avoid bad formatting
- avoid line wrap in examples
- put "expire" back into the accept/reject block

ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.81 2013/02/05 09:49:38 gilles Exp $
d20 1
a20 1
.Dd $Mdocdate: February 5 2013 $
a103 177
.It Ic expire Ar n {s|m|h|d}
Specify how long a message can stay in the queue.
The default value is 4 days.
For example:
.Bd -literal -offset indent
expire 4d	# expire after 4 days
expire 10h	# expire after 10 hours
.Ed
.It Xo
.Bk -words
.Ic listen on Ar interface
.Op Ic port Ar port
.Op Ic tls | tls-require | smtps
.Op Ic certificate Ar name
.Op Ic auth | auth-optional
.Op Ic tag Ar tag
.Op Ic hostname Ar hostname
.Ek
.Xc
Specify an
.Ar interface
and
.Ar port
to listen on.
An interface group, an IP address or a domain name may
be used in place of
.Ar interface .
.Pp
Secured connections are provided either using STARTTLS
.Pq Ic tls ,
by default on port 25,
or SMTPS
.Pq Ic smtps ,
by default on port 465.
.Ic tls-require
may be used to force clients to establish a secure connection
before being allowed to start an SMTP transaction.
Host certificates may be used for these connections,
and are searched for in the
.Pa /etc/mail/certs
directory.
If
.Ic certificate
is specified,
a certificate
.Ao Ar name Ac Ns .crt ,
a key
.Ao Ar name Ac Ns .key
and Diffie-Hellman parameters
.Ao Ar name Ac Ns .dh
are searched for.
A certificate authority may be appended to the .crt
file to create a certificate chain.
If no
.Ic certificate
is specified,
the default interface name is instead used,
for example
.Pa fxp0.crt ,
.Pa fxp0.key ,
.Pa fxp0.ca ,
and
.Pa fxp0.dh .
If no DH parameters are provided, smtpd will use
built-in parameters.
Creation of certificates is documented in
.Xr starttls 8 .
.Pp
If the
.Ic auth
parameter is used,
then a client may only start an SMTP transaction after a
successful authentication.
Any remote sender that passed SMTPAUTH is treated as if
it was the server's local user that was sending the mail.
This means that filter rules using "from local" will be matched.
If
.Ic auth-optional
is specified, then SMTPAUTH is not required to establish an
SMTP transaction.
This is only useful to let a listener accept incoming mail from
untrusted senders and outgoing mail from authenticated users in
situations where it is not possible to listen on the submission
port.
.Pp
If the
.Ic tag
parameter is used, then clients connecting to the listener will be
tagged
.Ar tag .
.Pp
If the
.Ic hostname
parameter is used, then it will be used in the greeting banner.
.It Xo
.Ic table Ar name
.Ar [type:]config
.Xc
Tables are used to provide additional configuration information for
.Xr smtpd 8
in the form of lists or key-value mappings.
.Pp
The table is identified using table name
.Ar name ;
the name itself is arbitrarily chosen.
.Pp
.Ar type
specifies the table backend,
and should be one of the following:
.Pp
.Bl -tag -width "fileXXX" -compact
.It db
Information is stored in a file created using
.Xr makemap 8 .
.It file
Information is stored in a plain text file using the
same format as used to generate
.Xr makemap 8
mappings.
This is the default.
.El
.Pp
.Ar config
specifies a configuration file for the table data.
It must be an absolute path to a file for the
.Dq file
and
.Dq db
table types.
.It Xo
.Ic table Ar name
.Ic { Ar value
.Op , Ar value_n
.Ic }
.Xc
Tables containing list of static values may be declared
using an inlined notation.
.Pp
The table is identified using table name
.Ar name ;
the name itself is arbitrarily chosen.
.Pp
The table must contain at least one value and may declare many values as a
list of comma separated strings.
.It Xo
.Ic table Ar name
.Ic { Ar key => value
.Op , key_n => value_n
.Ic }
.Xc
Tables containing static key-value mappings may be declared
using an inlined notation.
.Pp
The table is identified using table name
.Ar name ;
the name itself is arbitrarily chosen.
.Pp
The table must contain at least one key-value mapping and may declare
many mappings as a list of comma separated
.Ar key => value
descriptions.
.It Ic max-message-size Ar n
Specify a maximum message size of
.Ar n
bytes.
The argument may contain a multiplier, as documented in
.Xr scan_scaled 3 .
The default maximum message size is 35MB if none is specified.
.It Xo
.Ic queue
.Ic compression Op Ar gzip
.Xc
Enable transparent deflating and inflating of all envelopes
and messages.
The only supported algorithm at the moment is gzip.
Envelopes and messages may be inspected using
.Xr gzcat 1 .
a118 3
.It Ic tagged Ar tag
If specified, the rule will only be matched if the client session was tagged
.Ar tag .
d133 3
d286 2
a430 2
.It Ic expire Ar n {s|m|h|d}
Specify how long a message that matched this rule can stay in the queue.
d443 177
@


1.81
log
@commit documentation for "helo" in relay rules
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.79 2013/01/26 17:02:52 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: January 26 2013 $
d113 1
d121 1
a605 1
.El
d608 1
d658 2
a659 1
accept for any relay via tls+auth://label@@smtp.example.com auth <secrets>
@


1.80
log
@fix authenticated relaying example
@
text
@d466 1
d504 13
d524 1
d596 8
@


1.79
log
@pesky quote!
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.78 2013/01/26 14:13:25 jmc Exp $
d622 1
a622 1
# echo "smtp.example.com  username:password" \*(Gt /etc/mail/secrets
d633 1
a633 1
accept for any relay via tls+auth://smtp.example.com auth <secrets>
@


1.78
log
@tweak previous;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.77 2013/01/26 09:37:23 gilles Exp $
d631 1
a631 1
table secrets db:/etc/mail/secrets.db"
@


1.77
log
@Sync with our smtpd repo:

* first bricks of ldap and sqlite support (not finished but both working)
* new table API to replace map API, all lookups are done through tables
* improved handling of temporary errors throughout the daemon
* improved scheduler and mta logic: connection reuse, optimizes batches
* improved queue: more tolerant to admin errors, new layout, less disk-IO
* improved memory usage under high load
* SSL certs/keys isolated to lookup process to avoid facing network
* VIRTUAL support improved, fully virtual setups possible now
* runtime tracing of processes through smtpctl trace
* ssl_privsep.c sync-ed with relayd
* ssl.c no longer contains smtpd specific interfaces
* smtpd-specific ssl bits moved to ssl_smtpd.c
* update mail address in copyright

FLUSH YOUR QUEUE. FLUSH YOUR QUEUE. FLUSH YOUR QUEUE. FLUSH YOUR QUEUE.

smtpd.conf(5) simplified, it will require adaptations

ok eric@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.76 2012/10/16 16:47:40 jmc Exp $
d20 1
a20 1
.Dd $Mdocdate: October 16 2012 $
d81 2
a82 2
Expansion formats also support partial expansion using the optional bracket notations
with substring offset.
d237 2
a238 1
Tables containing list of static values may be declared using an inlined notation.
d244 2
a245 2
The table must contain at least one value and may declare many values as a list of
comma separated strings.
d252 2
a253 1
Tables containing static key-value mappings may be declared using an inlined notation.
d259 2
a260 2
The table must contain at least one key-value mapping and may declare many mappings as
a list of comma separated
d432 1
a432 1
Lookup users in the table
d498 1
a498 1
will explicitely bind to an address found in the table referenced by
d576 1
a576 1
will explicitely bind to an address found in the table referenced by
@


1.76
log
@consistent macros; Tim van der Molen
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.75 2012/10/14 12:05:14 gilles Exp $
d5 1
d20 1
a20 1
.Dd $Mdocdate: October 14 2012 $
d60 1
a60 1
Some configuration directives expect expansion of their parameters at runtime.
d63 1
a63 2
.Ar deliver to mda ,
.Ar relay via )
d67 25
a91 7
%a expands to the user part of the email address prior to the
resolution of aliases;
%u expands to the user part after aliases
resolution and will typically be the system account;
%d expands to the domain part of the email address;
%A expands to the user part of the sender email address;
%D expands to the domain part of the sender email address.
a111 5
.It Ic hostname Ar name
Specify the fully qualified domain name (FQDN) of the server.
By default the current host name is used,
as returned by
.Xr hostname 1 .
d118 2
d149 1
a149 3
.Ao Ar name Ac Ns .key ,
a certificate authority
.Ao Ar name Ac Ns .ca
d153 2
d186 10
d197 2
a198 2
.Ic map Ar map
.Ic source Ar type Ar source
d200 3
a202 2
Maps are used to provide additional configuration information for
.Xr smtpd 8 .
d204 2
a205 2
The map is identified using map name
.Ar map ;
d209 1
a209 1
specifies the file format,
d214 1
a214 1
Mappings are stored in a file created using
d216 2
a217 3
This is the default type if none is specified.
.It plain
Mappings are stored in a plain text file using the
d224 2
a225 2
.Ar source
specifies the source of the map data.
d230 32
a261 2
map types.
.It Ic size Ar n
d292 3
d305 14
d325 1
a325 1
.Op Ic alias Ar aliases
d328 1
a328 1
If specified,
d332 8
d341 1
a341 1
.Op Ic alias Ar aliases
d353 1
a353 1
If specified,
d358 2
a359 2
.Ic for domain map Ar domains
.Op Ic alias Ar aliases
d361 1
a361 1
This rule applies to mail destined to domains which are part of the map
d364 1
a364 1
If specified,
d369 33
d403 1
a403 1
.Op Ic alias Ar map
d410 25
a434 6
.It Ic for virtual map Ar vmap
This rule applies to mail destined for the virtual domains specified
in the map
.Ar vmap .
For an example of how to configure a virtual map, see
.Xr makemap 8 .
d461 1
a461 1
.Op Ic backup Ar mx
d463 1
d475 3
d491 10
d505 1
a505 1
.Op Ic auth Ar map
d507 1
d533 4
a536 4
tls+auth://mx1.example.org	# AUTH over TLS
smtps+auth://mx1.example.org	# AUTH over SMTPS
ssl+auth://mx1.example.org	# AUTH over either \e
				# SMTPS or TLS
d553 3
a555 2
.Ar map
that holds the credentials.
d569 11
d582 11
a592 1
.El
d628 4
a631 4
map aliases source db "/etc/mail/aliases.db"
map secrets source db "/etc/mail/secrets.db"
accept for local alias aliases deliver to mbox
accept for any relay via tls+auth://smtp.example.com auth secrets
d654 2
a655 2
map aliases source db "/etc/mail/aliases.db"
accept for local deliver to mda "/path/to/mda -f -"
@


1.75
log
@replace 'plain' with 'file' as the backend source name for map_file.c
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.74 2012/10/11 21:14:32 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: October 11 2012 $
d121 1
a121 1
.Ar tls-require
@


1.74
log
@- replace "from all" and "for all" with "from any" and "for any"

ok eric@@, chl@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.73 2012/10/10 06:02:26 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: October 10 2012 $
d202 1
a202 1
.Dq plain
@


1.73
log
@a SMTP -> an SMTP;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.72 2012/10/09 20:33:02 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: October 9 2012 $
d237 1
a237 1
.It Ic from all
d252 1
a252 1
.Ic for all
d462 1
a462 1
accept for all relay via tls+auth://smtp.example.com auth secrets
d487 1
a487 1
accept from all for domain example.org \e
d489 1
a489 1
accept for all relay
@


1.72
log
@- allow a listen statement to impose tls on its clients;
- make listen statements impose authentication if 'auth' is specified and
	to make it optional if 'auth-optional' is specified;
- sync documentation accordingly

with ideas and input from beck@@ and halex@@, ok eric@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.71 2012/10/09 18:28:09 gilles Exp $
d123 1
a123 1
before being allowed to start a SMTP transaction.
d158 1
a158 1
then a client may only start a SMTP transaction after a
d165 1
a165 1
is specified, then SMTPAUTH is not required to establish a
@


1.71
log
@fix listen examples to not use an interface
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.70 2012/10/08 20:35:16 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: October 8 2012 $
d56 1
a56 1
listen on $lan_addr tls enable auth
d102 1
a102 1
.Op Ic tls | smtps
d104 1
a104 1
.Op Ic enable auth
d121 3
d156 1
a156 1
.Ic enable auth
d158 3
a160 1
any remote sender that passed SMTPAUTH is treated as if
d163 8
d484 1
a484 1
listen on egress tls certificate mail.example.com enable auth
@


1.70
log
@disk space is cheap but we still want to limit the default size of a body
to a sane default for everyone.
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.69 2012/10/05 07:00:47 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: October 5 2012 $
d54 3
a56 3
wan_if = "fxp0"
listen on $wan_if
listen on $wan_if tls enable auth
d471 1
a471 1
listen on bnx0 tls certificate mail.example.com enable auth
@


1.69
log
@further tweak the maps description; ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.68 2012/10/05 06:25:56 jmc Exp $
d199 1
@


1.68
log
@tweak previous; ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.67 2012/10/04 19:49:53 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: October 4 2012 $
d165 3
a167 2
.Ar map
may be named freely.
d170 2
a171 1
may be one of the following:
@


1.67
log
@default map source to S_PLAIN, this allows us to simplify smtpd.conf:
	map aliases source plain "/etc/mail/aliases"
can be reduced to:
	map aliases "/etc/mail/aliases"
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.66 2012/09/17 18:44:57 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: September 17 2012 $
d181 1
a181 4
If not specified,
.Ar type
defaults to
.It plain .
@


1.66
log
@Fix format expansion in smtpd.conf, it has confused a lot of people and it
turns out documentation got it wrong. This commit changes formats and doc,
it makes situation saner:

   %A = user part of sender address
   %D = domain part of sender address

   %a = user part of recipient address
   %d = domain part of recipient address
   %u = unix account of recipient

ok eric@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.65 2012/09/01 16:09:14 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: September 1 2012 $
d181 4
@


1.65
log
@- remove crypto_backend
- remove support for encrypted queue, it will be reintroduced later after
  pouring more thinking into it

if you had it enabled, flush your queue before updating
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.64 2012/08/29 18:36:24 naddy Exp $
d19 1
a19 1
.Dd $Mdocdate: August 29 2012 $
d72 1
a72 1
%U expands to the user part of the sender email address;
@


1.64
log
@switch the default queue encryption to AES-128
I'm committing this on behalf of gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.63 2012/08/29 18:10:28 jmc Exp $
a204 30
.It Xo
.Ic queue encryption
.Ic key Ar key
.Op Ic cipher Ar algorithm
.Op Ic digest Ar digest
.Xc
Enable transparent encryption of all envelopes and messages
using cipher
.Ar algorithm ,
by default AES-128 in CBC mode.
.Ar key
is expanded internally using the
.Ar digest
hash algorithm, by default SHA256.
See
.Xr crypto 3
for supported ciphers and digests.
.Pp
This option is compatible with compression and will perform
both in the appropriate order.
.Pp
.Xr smtpd 8
prepends an encrypted random IV before encryption and strips
it before decryption to ensure identical envelopes and messages
produce different output.
.Pp
Note that the encryption parameters cannot be changed
without making sure that the queue has been emptied, as
.Xr smtpd 8
would be unable to decrypt older envelopes and messages with the new key.
@


1.63
log
@tweak previous;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.62 2012/08/29 16:48:40 gilles Exp $
d214 1
a214 1
by default Blowfish in CBC mode.
@


1.62
log
@obvious, but document that change of any encryption parameter *requires*
queue to be emptied first.
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.61 2012/08/29 16:26:17 gilles Exp $
d202 1
a202 1
Only supported algorithm at the moment is gzip.
d208 2
a209 2
.Ic Op cipher Ar algorithm
.Ic Op digest Ar digest
d227 1
a227 1
will prepend an encrypted random IV before encryption and will strip
d231 2
a232 2
Note that you cannot change any of the encryption parameters
without making sure that queue has been emptied as
d234 1
a234 1
would be unable to decrypt older envelopes and messages with new key.
@


1.61
log
@Introduce the crypto_backend API and provide support for... encrypted queue
using the new API. By default, OpenSMTPD does not provide queue encryption,
but it can be enabled with "queue encryption [args]" and will transparently
encrypt/decrypt envelopes/messages as they hit the queue.

By default, it will use Blowfish in CBC mode with a different random IV for
each envelope and message. User provided key is expanded using sha256 but a
different cipher and digest may be specified in smtpd.conf

Queue encryption is compatible with compression and if both options are set
it will do them in correct order and transparently.

tested by chl@@, a few users and myself
ok chl@@ and I
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.60 2012/08/26 13:55:47 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: August 26 2012 $
d230 5
@


1.60
log
@- document queue compression
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.59 2012/08/21 22:22:00 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: August 21 2012 $
d196 7
a202 2
.It Ic queue Ar compress
Enable gzip compression for the queue.
d205 25
@


1.59
log
@tweak previous;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.58 2012/08/21 20:19:46 eric Exp $
d196 4
@


1.58
log
@Allow smtpd to work as a backup MX, relaying only to MXs with higher
priority in the DNS record. For example:

   accept for domain "foo.org" relay backup "mx3.foo.org"

will relay mails for "foo.org" using only hosts with higher priority
(i.e. lower value) than "mx3.foo.org", which is supposed to be the
current server.

If the specified backup MX is not found in the DNS record, relaying
works as normal.

ok gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.57 2012/07/16 06:00:04 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: July 16 2012 $
d312 3
a314 3
for the target domain.  Accepted mails are only relayed through
servers with lower preference value in the MX record for the
domain than the one specified in
@


1.57
log
@sync the first example with the default conf file; ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.56 2012/07/16 05:56:16 jmc Exp $
d303 1
d308 8
@


1.56
log
@don;t quote things unneccessarily; ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.55 2012/07/15 17:04:31 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: July 15 2012 $
d426 1
a426 1
accept for local deliver to mbox
@


1.55
log
@fix example

submitted by Marcus Merighi <mcmer-openbsd@@tor.at>
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.54 2012/07/08 17:17:48 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: July 8 2012 $
d427 1
a427 1
accept for all relay via "tls+auth://smtp.example.com" auth "secrets"
d449 1
a449 1
listen on bnx0 tls certificate "mail.example.com" enable auth
@


1.54
log
@avoid line splitting; also, one an -> a
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.53 2012/07/08 15:48:00 gilles Exp $
d427 1
a427 1
accept for all relay via smtp.example.com tls auth "secrets"
@


1.53
log
@- plug text_to_relayhost() in parse.y to support relay URLs.
- document the new URL syntax in smtpd.conf.5
- replace starttls:// schema with tls://

Beware, "relay via" rules should now be expressed with a relay URL:

	accept [...] relay via "mx1.example.org" smtps port 465
becomes accept [...] relay via "smtps://mx1.example.org"

This will allow using mappings of relays with different protocols and
options.

Make sure to update your smtpd.conf if you relay via !

ok eric, ok chl
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.52 2012/05/13 13:58:31 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: May 13 2012 $
d329 1
a329 1
expressed as an URL.
d333 2
a334 1
smtp://mx1.example.org:4321	# use SMTP with port 4321
d343 2
a344 1
ssl://mx1.example.org		# try SMTPS and fallback to TLS
d353 2
a354 1
ssl+auth://mx1.example.org	# AUTH over either SMTPS or TLS
d452 2
a453 1
accept from all for domain example.org deliver to mda "/path/to/mda -f -"
@


1.52
log
@tweak previous; ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.51 2012/05/12 21:49:31 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: May 12 2012 $
a322 2
.Op Ic port Ar port
.Op Ic tls | smtps | ssl
d329 24
a352 2
and
.Ar port .
a353 9
The communication channel may be secured using the
.Ic tls
or
.Ic smtps
options.
The special keyword
.Ic ssl
means that any of the two is acceptable:
SMTPS is tried first, STARTTLS second.
d365 1
a365 1
is desired, use the
d367 1
a367 1
parameter to specify the
@


1.51
log
@- remove unused sources S_EXT, S_DYN and S_EXT from enum map_src
- continue simplification of parse.y
- remove "for network", if we ever need it we can reimport, probably no
  one knows of that undocumented strange feature ;-)
- change syntax for virtual domains configuration:

	  accept for virtual vmap	[...] <- wrong
	  accept for virtual map vmap	[...] <- right

  the reason for this change is that we will soon implement relay rules
  through maps and that keeping that syntax would make it inconsistent
  with the other rules.

- update man pages for makemap and smtpd.conf to reflect changes

ok eric@@, looks ok chl@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.50 2012/05/12 18:41:10 gilles Exp $
d226 1
a226 1
.Ic for all 
d255 1
a255 1
This rule applies to mail destined to domains part of the map
@


1.50
log
@- simplify a bit maps by removing fields which are still unused years
  after the initial ambitious implementation: byebye map type & map flags

- simplify a bit parse.y by removing assignations to these otherwise unused
  fields

- remove the DNS map source, it may be a good idea, but we can just add it
  when we plan to implement it (if we do)

- make the { } options in map declaration, it's been annoying me for a long
  time now, this allows the following to work:

       map "foobar" source plain "/etc/mail/foobar"

- update smtpd.conf.5 accordingly ;-)
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.49 2012/04/24 14:56:09 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: April 24 2012 $
d225 4
a228 1
.It Ic for all
d230 3
d235 1
a235 1
.Op Ic alias Ar map
d248 1
a248 1
.Ar map
d252 11
d271 1
a271 1
.It Ic for virtual Ar map
d274 1
a274 1
.Ar map .
@


1.49
log
@take a stab at documenting when arguments need quoted, and valid macro
characters;

prompted by a diff from robert peichaer org

thanks gilles and henning for feedback
ok deraadt zinke
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.48 2012/04/13 07:03:02 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: April 13 2012 $
a159 1
.No {
a160 1
.No }
a175 2
.It dns
Not implemented yet.
d186 1
a186 1
.Dq file
d189 1
a189 4
map types,
or a domain name for the
.Dq dns
map type.
d393 2
a394 2
map aliases { source db "/etc/mail/aliases.db" }
map secrets { source db "/etc/mail/secrets.db" }
d419 1
a419 1
map aliases { source db "/etc/mail/aliases.db" }
@


1.48
log
@clarify "hostname"; from robert peichaer org
ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.47 2011/12/13 23:55:00 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: December 13 2011 $
d38 2
d44 2
a45 2
Macro names must start with a letter, and may contain letters, digits
and underscores.
@


1.47
log
@*finally* make use of certificate authority file if available !

bits from relayd, ok chl@@, ok eric@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.46 2011/12/13 21:47:09 gilles Exp $
d93 1
a93 1
Specify the domain name of the server.
@


1.46
log
@- man page had an example wrong

spotted and diff by Ptter J. Philipp <php@@centroid.eu> a while ago, thanks
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.45 2011/10/03 17:57:43 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: October 3 2011 $
d129 3
a131 1
.Ao Ar name Ac Ns .key
d142 1
@


1.45
log
@clarify that network sources are to be specified in CIDR notation

by David Walker, ok jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.44 2011/06/23 20:35:22 sthen Exp $
d19 1
a19 1
.Dd $Mdocdate: June 23 2011 $
d420 1
a420 1
listen on bnx0 tls certificate "mail.example.com.crt" enable auth
@


1.44
log
@Use a common text explaining how the various configuration parsers using
the standard OpenBSD-style parse.y handle continuing lines with backslashes,
paying particular attention to how comments are handled (which can cause
nasty side-effects if you're not expecting it).

Most wording from jmc@@, with suggestions from fgsch@@, marc@@, Richard Toohey,
patrick keshishian and Florian Obser, ok jmc@@.
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.43 2011/06/10 11:30:35 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: June 10 2011 $
d221 2
a222 1
.Ar network .
@


1.43
log
@tweak previous;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.42 2011/06/09 17:41:52 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: June 9 2011 $
d30 2
d33 1
a33 1
.Pq # ,
d35 3
@


1.42
log
@'relay as' and 'relay via as' rules allow smtpd to rewrite the user part,
the domain part or the entire address of the sender at the SMTP sesssion
level. this is not masquerade but allows smtpd to communicate with hosts
that do a check of SMTP sender fqdn.

sent to tech@@, a couple 'no regression' feedbacks
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.41 2011/05/22 22:03:43 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: May 22 2011 $
d287 1
a287 1
If
d289 3
a291 1
parameter is specified, then smtpd will rewrite the sender advertised
d294 4
a297 2
may be a user, a domain prefixed with @@ or an email address, causing
smtpd to rewrite the user-part, the domain-part or the entire address
d339 1
a339 1
If
d341 3
a343 1
parameter is specified, then smtpd will rewrite the sender advertised
d346 4
a349 2
may be a user, a domain prefixed with @@ or an email address, causing
smtpd to rewrite the user-part, the domain-part or the entire address
@


1.41
log
@tweak previous;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.40 2011/05/22 21:03:14 gilles Exp $
d280 4
a283 1
.It Ic relay
d286 9
d302 1
d334 9
@


1.40
log
@teach smtpd how to listen on an interface group so that we can do:
	listen on egress
	listen on wlan

idea unvoluntarily suggested by Mikolaj Kucharski a few weeks ago,
unslacked after theo suggested it again.
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.39 2011/05/22 13:38:31 gilles Exp $
d104 1
a104 1
An interface group, an IP address or adomain name may
@


1.39
log
@fix examples so they stay do not use external utilities and do not refer
to external domains

prompted by deraadt@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.38 2011/03/15 19:24:55 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: March 15 2011 $
d104 2
a105 1
An IP address or domain name may be used in place of
@


1.38
log
@let smtpd use user-provided Diffie-Hellman parameters for ephemeral key
exchange. if no DH parameters are found, fallback to builtin parameters
as was done until now.

since we now accept user-provided DH parameters, make smtpd more strict
and fatal() if the parameters are bogus.

bump the key size of the DH parameters from 512bits to 1024bits, it might
be bumped further after some more research.

thanks to mikeb@@ for his suggestions

diff ok mikeb@@ , man ok jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.37 2010/12/18 22:25:24 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: December 18 2010 $
d344 1
a344 1
but all outgoing mail is forwarded to a gmail SMTP server.
d350 1
a350 1
# echo "smtp.gmail.com  username:password" \*(Gt /etc/mail/secrets
d361 1
a361 1
accept for all relay via smtp.gmail.com tls auth "secrets"
d368 2
a369 2
The mail server has an external interface pppoe0.
Mail with a local destination should be sent to procmail.
d372 4
a375 4
# openssl genrsa -out /etc/mail/certs/pppoe0.key 4096
# openssl req -new -x509 -key /etc/mail/certs/pppoe0.key \e
	-out /etc/mail/certs/pppoe0.crt -days 365
# chmod 600 /etc/mail/certs/pppoe0.*
d383 1
a383 1
listen on pppoe0 tls enable auth
d385 2
a386 2
accept for local deliver to mda "procmail -f -"
accept from all for domain example.org deliver to mda "procmail -f -"
@


1.37
log
@document "certificate" a little better;
based on a diff from Sunil Nimmagadda

ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.36 2010/10/29 09:16:08 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: October 29 2010 $
d121 2
a122 2
.Ao Ar name Ac Ns .crt
and key
d124 2
d132 2
a133 1
.Pa fxp0.crt
d135 3
a137 1
.Pa fxp0.key .
@


1.36
log
@smtpd no longer knows a map called "secrets" which holds credentials for
authenticated relaying. one can create many maps holding credentials and
name them however he/she wants, just like any other map.

teach smtpd how to select a credentials map at the rule-level allowing a
setup to relay through the same MX with different credentials depending
on the source.

smtpd.conf.5 updated to reflect changes with help from jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.35 2010/10/28 21:15:50 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: October 28 2010 $
d113 20
a134 7
If no certificate
.Ar name
is specified, the
.Pa /etc/mail/certs
directory is searched for a file named by joining
the interface name with a .crt extension, e.g.\&
.Pa /etc/mail/certs/fxp0.crt .
@


1.35
log
@teach smtpd how to handle per-rule delays for message expiry, this allows
some rules to have a longer expiry delay than the default:

	accept for [...] relay expire 8d  # will stay 8 days in queue

I added the man page bits so I don't forget but I need to reword it a bit
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.34 2010/09/08 21:40:43 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: September 8 2010 $
d79 95
d270 1
a270 1
.Op Ic enable auth
d298 4
a301 2
.Ic enable auth
parameter.
a304 102
.It Ic expire Ar n {s|m|h|d}
Specify how long a message can stay in the queue.
The default value is 4 days.
For example:
.Bd -literal -offset indent
expire 4d	# expire after 4 days
expire 10h	# expire after 10 hours
.Ed
.It Ic hostname Ar name
Specify the domain name of the server.
By default the current host name is used,
as returned by
.Xr hostname 1 .
.It Xo
.Ic listen on Ar interface
.Op Ic port Ar port
.Op Ic tls | smtps
.Op Ic certificate Ar name
.Op Ic enable auth
.Xc
Specify an
.Ar interface
and
.Ar port
to listen on.
An IP address or domain name may be used in place of
.Ar interface .
.Pp
Secured connections are provided either using STARTTLS
.Pq Ic tls ,
by default on port 25,
or SMTPS
.Pq Ic smtps ,
by default on port 465.
Creation of certificates is documented in
.Xr starttls 8 .
If no certificate
.Ar name
is specified, the
.Pa /etc/mail/certs
directory is searched for a file named by joining
the interface name with a .crt extension, e.g.\&
.Pa /etc/mail/certs/fxp0.crt .
.Pp
If the
.Ic enable auth
parameter is used,
any remote sender that passed SMTPAUTH is treated as if
it was the server's local user that was sending the mail.
This means that filter rules using "from local" will be matched.
.It Xo
.Ic map Ar map
.No {
.Ic source Ar type Ar source
.No }
.Xc
Maps are used to provide additional configuration information for
.Xr smtpd 8 .
.Pp
.Ar map
may be named freely except for the following:
.Pp
.Bl -tag -width "virtualXXX" -compact
.It secrets
Map queried for remote host credentials.
See
.Xr makemap 8 .
.El
.Pp
.Ar type
may be one of the following:
.Pp
.Bl -tag -width "fileXXX" -compact
.It db
Mappings are stored in a file created using
.Xr makemap 8 .
This is the default type if none is specified.
.It dns
Not implemented yet.
.It plain
Mappings are stored in a plain text file using the
same format as used to generate
.Xr makemap 8
mappings.
.El
.Pp
.Ar source
specifies the source of the map data.
It must be an absolute path to a file for the
.Dq file
and
.Dq db
map types,
or a domain name for the
.Dq dns
map type.
.It Ic size Ar n
Specify a maximum message size of
.Ar n
bytes.
The argument may contain a multiplier, as documented in
.Xr scan_scaled 3 .
d343 1
a343 1
accept for all relay via smtp.gmail.com tls enable auth
@


1.34
log
@had planned to commit the change after oga@@ and I are done with little
changes to lka_expand() but it looks like a bit more work :-)
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.33 2010/06/10 19:34:51 chl Exp $
d19 1
a19 1
.Dd $Mdocdate: June 10 2010 $
d205 2
@


1.33
log
@allow configure queue expiry

with help from jacekm@@

ok gilles@@ jacekm@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.32 2010/04/27 14:39:24 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: April 27 2010 $
d64 3
a66 1
%d expands to the domain part of the email address.
@


1.32
log
@sort the map types;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.31 2010/04/27 10:17:53 gilles Exp $
d204 8
@


1.31
log
@this commit enables "plain" as a backend for maps (that means aliases,
virtual AND secrets), adds a description in smtpd.conf.5 and removes a
mention to special map "aliases" which was removed a while ago.

to use plain maps:  map "myaliases" { source plain "/etc/mail/aliases" }

code diff was okayd a while ago by jacekm@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.30 2010/04/22 15:37:45 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: April 22 2010 $
d273 2
a279 2
.It dns
Not implemented yet.
@


1.30
log
@- sort the keyword list
- rewrite the description of "size"

ok gilles jacekm
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.29 2010/04/20 20:22:29 jacekm Exp $
d19 1
a19 1
.Dd $Mdocdate: April 20 2010 $
d256 1
a256 1
may be one of the following:
a258 6
.It aliases
Map queried for mail aliases.
See
.Xr aliases 5
and
.Xr newaliases 8 .
d273 5
a278 2
Not implemented yet.
.It file
@


1.29
log
@Correct map definition syntax.  Reported by Rene Maroufi <info@@maroufi.net>.
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.28 2010/04/20 20:09:40 jacekm Exp $
a76 98
.It Ic hostname Ar name
Specify the domain name of the server.
By default the current host name is used,
as returned by
.Xr hostname 1 .
.It Xo
.Ic listen on Ar interface
.Op Ic port Ar port
.Op Ic tls | smtps
.Op Ic certificate Ar name
.Op Ic enable auth
.Xc
Specify an
.Ar interface
and
.Ar port
to listen on.
An IP address or domain name may be used in place of
.Ar interface .
.Pp
Secured connections are provided either using STARTTLS
.Pq Ic tls ,
by default on port 25,
or SMTPS
.Pq Ic smtps ,
by default on port 465.
Creation of certificates is documented in
.Xr starttls 8 .
If no certificate
.Ar name
is specified, the
.Pa /etc/mail/certs
directory is searched for a file named by joining
the interface name with a .crt extension, e.g.\&
.Pa /etc/mail/certs/fxp0.crt .
.Pp
If the
.Ic enable auth
parameter is used,
any remote sender that passed SMTPAUTH is treated as if
it was the server's local user that was sending the mail.
This means that filter rules using "from local" will be matched.
.It Xo
.Ic map Ar map
.No {
.Ic source Ar type Ar source
.No }
.Xc
Maps are used to provide additional configuration information for
.Xr smtpd 8 .
.Pp
.Ar map
may be one of the following:
.Pp
.Bl -tag -width "virtualXXX" -compact
.It aliases
Map queried for mail aliases.
See
.Xr aliases 5
and
.Xr newaliases 8 .
.It secrets
Map queried for remote host credentials.
See
.Xr makemap 8 .
.El
.Pp
.Ar type
may be one of the following:
.Pp
.Bl -tag -width "fileXXX" -compact
.It db
Mappings are stored in a file created using
.Xr makemap 8 .
This is the default type if none is specified.
.It dns
Not implemented yet.
.It file
Not implemented yet.
.El
.Pp
.Ar source
specifies the source of the map data.
It must be an absolute path to a file for the
.Dq file
and
.Dq db
map types,
or a domain name for the
.Dq dns
map type.
.It Ic size Ar bytes
Specify the size above which a message is rejected by the server.
The
.Ar bytes
argument can be expressed with quantifiers described in
.Xr scan_scaled 3 ,
or as bytes if no quantifier is provided.
d204 97
@


1.28
log
@Document the ``alias <map>'' parameter.
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.27 2010/04/20 19:35:28 jacekm Exp $
d122 1
a122 2
.Op Ic type Ar maptype
.Ic source Ar mapsource
d144 1
a144 1
.Ar maptype
d158 1
a158 1
.Ar mapsource
d164 1
a164 1
maptypes,
d167 1
a167 1
maptype.
@


1.27
log
@Document ``size'' setting; OK gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.26 2010/02/25 14:53:37 stevesk Exp $
d19 1
a19 1
.Dd $Mdocdate: February 25 2010 $
d206 4
a209 1
.It Ic for domain Ar domain
d219 9
a227 1
.It Ic for local
@


1.26
log
@fix incorrect reference; ok jmc@@ gilles@@ jacekm@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.25 2009/10/25 22:58:51 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: October 25 2009 $
d169 7
@


1.25
log
@fix aliases map name in man page
reported by Emmanuel Vadot and David Hill
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.24 2009/10/19 21:19:13 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: October 19 2009 $
d151 1
a151 1
.Nm .
@


1.24
log
@update man pages
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.23 2009/10/16 22:29:46 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: October 16 2009 $
d133 1
a133 1
.It alias
@


1.23
log
@after recent change in virtual maps support smtpd.conf.5 was not fully
updated and still referenced the "virtual" map which no longer exists.

issue spotted by Alexander Hall <alexander@@beard.se>
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.22 2009/10/13 04:53:33 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: October 13 2009 $
d215 1
a215 1
.It Ic for virtual map Ar map
@


1.22
log
@sort;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.21 2009/10/12 22:49:10 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: October 12 2009 $
a140 4
See
.Xr makemap 8 .
.It virtual
Map queried for virtual domains.
@


1.21
log
@document the new "for virtual map [...]" syntax
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.20 2009/09/25 13:44:33 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: September 25 2009 $
d213 6
a224 6
.It Ic for local
This rule applies to mail destined to
.Dq localhost
and to the server's fully qualified domain name,
as returned by
.Xr hostname 1 .
@


1.20
log
@move the smtpd.conf-specific map bits back from makemap to smtpd.conf,
along with some tweakage;

ok jacekm gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.19 2009/09/23 10:26:01 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: September 23 2009 $
d213 6
@


1.19
log
@minor tweaks for the filter section; ok jacekm
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.18 2009/09/22 13:05:20 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: September 22 2009 $
d127 15
a141 2
.Xr smtpd 8 ,
and are described fully in
d143 30
@


1.18
log
@- move the map stuff to makemap.8
- use a single list for smtpd.conf keywords

ok jacekm gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.17 2009/09/21 10:02:50 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: September 21 2009 $
d145 6
d152 1
a152 1
The rule will match if connection is made from the specified
a153 4
If missing,
rule will apply to locally originated connections only.
.It Ic from all
Make the rule match regardless of the IP of connecting client.
d158 2
d161 1
a161 1
This rule applies to mail destined for specified
d163 1
a163 1
This parameter supports
d166 1
a166 1
so that one can have single rule for all sub-domains, for example:
a175 2
.It Ic for all
Make the rule match regardless of the domain it is sent to.
d178 1
a178 1
Finally, method of delivery is specified:
a179 3
.It Ic deliver to mbox
Message is delivered to local user's system mailbox in
.Pa /var/mail .
d181 1
a181 1
Message is added to a maildir.
d191 3
d195 1
a195 1
Message is piped to the specified
d197 1
a197 1
which is run with privileges of the user the message is destined to.
d201 1
a201 1
Message is relayed.
d211 1
a211 1
Message is relayed through the specified
d216 1
a216 1
Security of the communication channel may be enforced using the
d220 4
a223 4
option.
Special keyword,
.Ic ssl ,
means any of the two is acceptable:
d234 1
a234 1
If SMTPAUTH session with
@


1.17
log
@- some tweaks for the global section
- syntax fix from gilles

ok gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.16 2009/09/21 07:46:42 jmc Exp $
d72 4
a75 3
.Sh GLOBAL CONFIGURATION
The following settings apply globally to
.Xr smtpd 8 :
d119 10
a128 31
.El
.Sh MAPS
Maps provide generic interface for associating textual key to a value.
Such associations may be accessed through a flat file, database, or DNS.
There are three maps known to smtpd:
.Bl -tag -width Ds
.It alias
Map queried when resolving mail aliases.
Query key is the user part of mail address.
.It virtual
Map used for creating virtual domains.
See the
.Sx VIRTUAL DOMAINS
section below.
.It secrets
Map queried for credentials
when relaying mail via server that requires SMTPAUTH
before accepting mail for relaying.
Query key is the domain name of the server acting as relay.
.El
.Pp
The configuration directives that are valid in the
.Ic map
context are described below:
.Bl -tag -width Ds
.It Ic type Ar maptype
Specifies method of accessing data.
The following map types are supported:
.Bl -tag -width Ds
.It db
Mappings are stored in a file created using
d130 1
a130 17
This is the default type if none is specified.
.It dns
Not implemented yet.
.It file
Not implemented yet.
.El
.It Ic source Ar mapsource
Specifies the source of mapping data.
It must be absolute path to a file in case of
.Dq file
and
.Dq db
.Ar maptype ,
and a domain name in case of
.Dq dns .
.El
.Sh FILTER RULES
d132 2
a133 5
has the ability to
.Ar accept
and
.Ar reject
messages based on information gathered during SMTP session.
d142 2
a143 5
Following the
.Ic accept
/
.Ic reject
decision comes client's IP address filter:
d238 10
a247 15
.Sh VIRTUAL DOMAINS
Virtual domains are kept in the virtual map.
To create single virtual address, add
.Dq user@@example.com
to the virtual map.
To handle all mail destined to any user at example.com, add
.Dq @@example.com
to the virtual map.
.Pp
In addition to adding an entry to the virtual map,
one must add a filter rule that accepts mail for the virtual domain,
for example:
.Bd -literal -offset indent
accept for domain "example.com" deliver to mbox
.Ed
a303 9
.Sh FILES
.Bl -tag -width "/etc/mail/smtpd.confXXX" -compact
.It Pa /etc/mail/smtpd.conf
Default
.Xr smtpd 8
configuration file.
.It Pa /var/spool/smtpd/
Spool directories for mail during processing.
.El
d306 1
a306 1
.Xr smtpctl 8 ,
@


1.16
log
@merge EXPANSION into DESCRIPTION, since it is really part of
describing the file format;

ok jacekm
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.15 2009/09/19 15:51:58 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: September 19 2009 $
d73 2
a74 1
Here are the settings that can be set globally:
d77 2
a78 2
Specify primary domain name of the server.
By default, current host name is used,
d93 1
a93 1
Address or domain name may be used in place of
d96 2
a97 1
Secured connections are provided either with STARTTLS,
d99 2
a100 1
or SMTPS,
d102 2
d109 2
a110 5
.Ar interface
name with a .crt extension, eg.
.Sq /etc/mail/certs/fxp0.crt .
Creation of certificates is documented in
.Xr starttls 8 .
d117 1
a117 2
This means that filter rules using "from local" source specification
will be matched.
d321 1
a321 1
map secrets { file "/etc/mail/secrets.db" }
@


1.15
log
@some minor improvements for this page, as well as an expanded examples
section to get things running;

help/ok jacekm gilles
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.14 2009/09/16 19:51:24 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: September 16 2009 $
d52 14
d226 2
a227 4
may contain format specifiers that are expanded before use,
see the
.Sx EXPANSION
section below.
d237 2
a238 4
This parameter may use conversion specifiers that are expanded before use,
see the
.Sx EXPANSION
section below.
a293 14
.Sh EXPANSION
Some configuration directives expect expansion of their parameters at runtime.
Such directives (for example
.Ar deliver to maildir ,
.Ar deliver to mda ,
.Ar relay via )
may use format specifiers which will be expanded before delivery or
relaying.
The following formats are currently supported:
%a expands to the user part of the email address prior to the
resolution of aliases;
%u expands to the user part after aliases
resolution and will typically be the system account;
%d expands to the domain part of the email address.
@


1.14
log
@+.Xr mailer.conf 5 ,
ok jacekm
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.13 2009/06/05 23:04:51 jacekm Exp $
d19 1
a19 1
.Dd $Mdocdate: June 5 2009 $
a28 18
.Sh SECTIONS
.Nm
is divided into four main sections:
.Bl -tag -width xxx
.It Sy Macros
User-defined variables may be defined and used later,
simplifying the configuration file.
.It Sy Global Configuration
Global settings for
.Xr smtpd 8 .
.It Sy Maps
Mail aliases,
virtual domains,
and authentication secrets
are stored in maps defined in this section.
.It Sy Filter Rules
Mail filter provides rule-based accepting, relaying, or refusing of messages.
.El
d31 1
a31 1
.Pq Sq # ,
d33 2
a35 7
Additional configuration files can be included with the
.Ic include
keyword, for example:
.Bd -literal -offset indent
include "/etc/mail/smtpd.conf.local"
.Ed
.Sh MACROS
d51 7
d298 56
a362 12
.Sh EXAMPLES
The following example configures a machine to accept local delivery
for both localhost and example.com, as well as the relaying of mail
destined for example.org through the mx1.example.org server and mail
destined for example.net through regular MX record lookup:
.Bd -literal -offset indent
listen on lo0
accept for local deliver to mbox
accept for domain "example.com" deliver to mbox
accept for domain "example.org" relay via "mx1.example.org"
accept for domain "example.net" relay
.Ed
@


1.13
log
@if path in "deliver to maildir path" is omitted, use ~/Maildir by
default; from gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.12 2009/05/30 23:53:41 gilles Exp $
d19 1
a19 1
.Dd $Mdocdate: May 30 2009 $
d336 1
@


1.12
log
@It is now possible to specify a certificate to use when relaying to another
host which requests client certificates:

	accept [...] relay via [...] ssl certificate "mycert"

diff from Josh Elsasser <josh@@elsasser.org>, tested and okayed by me with
no change but the addition of status 554 to the state machine to deal with
remote host telling us it doesn't like our certificate.
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.11 2009/05/28 08:43:45 jacekm Exp $
d19 1
a19 1
.Dd $Mdocdate: May 28 2009 $
d232 5
@


1.11
log
@Match SMTPAUTH documentation with reality; ok gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.10 2009/05/10 11:29:40 jacekm Exp $
d19 1
a19 1
.Dd $Mdocdate: May 10 2009 $
d248 1
d265 8
@


1.10
log
@assert copyright; ok gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.9 2009/04/10 05:35:31 jmc Exp $
d19 1
a19 1
.Dd $Mdocdate: April 10 2009 $
d115 4
a118 3
sender that passed SMTPAUTH is allowed to relay mail using
standard DNS-based routing,
unless a filter rule was matched that dictated different action.
@


1.9
log
@tweaks;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.8 2009/04/09 20:32:45 jacekm Exp $
d4 1
d19 1
a19 1
.Dd $Mdocdate: April 9 2009 $
@


1.8
log
@make the manpage fairly complete, contains bits from jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.7 2009/03/17 00:18:39 gilles Exp $
d18 1
a18 1
.Dd $Mdocdate: March 17 2009 $
d75 1
a75 2
.Pp
.Bl -tag -width Ds -compact
a80 1
.Pp
d114 2
a115 1
sender that passed SMTPAUTH is allowed to relay mail using standard DNS-based routing,
d117 1
d223 2
a224 1
Message is added to a maildir. Its location,
@


1.7
log
@update a bit, but more work is needed on this man page, working on it and
will commit an up to date version tomorrow
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.6 2008/12/20 00:22:09 gilles Exp $
d18 1
a18 1
.Dd $Mdocdate: December 20 2008 $
d26 24
a49 11
is used to configure
.Xr smtpd 8 ,
a small SMTP daemon.
.Pp
Lines beginning with
.Sq #
and empty lines are regarded as comments,
and ignored.
Lines may be split using the
.Sq \e
character.
d55 1
a55 1
include "/etc/mail/sub.smtpd.conf"
d67 1
a67 1
For example,
d69 213
a281 4
smtpport = 25
listen on 127.0.0.1 port $smtpport
listen on fxp0 port $smtp_port
ssmtp listen on fxp0 port $smtp_port enable auth
d284 1
a284 2
Some configuration directives expect expansion of their parameter at
runtime.
a285 1
.Ar deliver to mbox ,
d310 1
a310 1
destined for example.net through regular MX records lookup:
d324 1
a324 1
.Ox 4.5 .
@


1.6
log
@- update smtpd.conf to provide an example of an auth enabled listener
- update smtpd.conf.5 just to provide an example, a better description of
	"enable auth" will come when im done implementing it ;)
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.5 2008/12/12 17:24:51 jacekm Exp $
d18 1
a18 1
.Dd $Mdocdate: December 12 2008 $
d56 2
a57 2
smtp_port = 25
listen on 127.0.0.1 port $smtp_port
d92 3
a94 3
listen on 0.0.0.0 port 25
accept for domain "localhost" deliver to mbox "/var/mail/%u"
accept for domain "example.com" deliver to maildir "/home/%u/Maildir"
@


1.5
log
@Kill references to smtpdb(8).

ok gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.4 2008/12/06 02:04:56 gilles Exp $
d18 1
a18 1
.Dd $Mdocdate: December 6 2008 $
d59 1
@


1.4
log
@- it is now possible to specify an interface instead of an address or a
	hostname in a listen statement (ie: listen on lo0)
	request by deraadt@@ a while ago, ok jacekm@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.3 2008/11/02 08:19:13 jmc Exp $
d18 1
a18 1
.Dd $Mdocdate: November 2 2008 $
d99 1
a99 2
.Xr smtpd 8 ,
.Xr smtpdb 8
@


1.3
log
@various minor tweaks, including spelling fixes from Brian Keefer
and Jim Razmus;
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.2 2008/11/02 00:01:53 sobrado Exp $
d58 1
@


1.2
log
@write the command description (the .Nd macro) in a more usual way;
improve spacing in the FILES section.

ok gilles@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: smtpd.conf.5,v 1.1 2008/11/01 21:35:28 gilles Exp $
d18 1
a18 1
.Dd $Mdocdate: November 1 2008 $
d26 1
a26 1
is used to configure the
a29 1
.Sh SMTPD.CONF FILE FORMAT
d61 2
a62 1
runtime. Such directives (for example
d68 2
a69 1
relaying. The following formats are currently supported:
d71 13
a83 3
resolution of aliases, %u expands to the user part after aliases
resolution and will typically be the system account, %d expands to
the domain part of the email address.
d89 1
a89 3
.Pp
.Bd -literal -offset listen
.Pp
a95 7
.Sh FILES
.Bl -tag -width "/etc/mail/smtpd.conf" -compact
.It Pa /var/spool/smtpd/
Spool directories for mail during processing.
.It Pa /etc/mail/smtpd.conf
Default location for this file.
.El
d97 1
a98 1
.Xr smtpctl 8 ,
d103 1
a103 1
.Ox 4.4 .
@


1.1
log
@smtpd is a smtp server implementation for OpenBSD. It is a work in progress
which still lacks many features. bringing it in tree will help working on it
more easily.

"at this stage it should go in" henning@@, "move ahead" deraadt@@
@
text
@d1 1
a1 1
.\"	$OpenBSD$
d18 1
a18 1
.Dd $Mdocdate: October 2 2008 $
d23 1
a23 1
.Nd Configuration for smtpd
d88 1
a88 1
.Bl -tag -width "/var/mail" -compact
@

