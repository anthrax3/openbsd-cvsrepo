head	1.23;
access;
symbols
	OPENBSD_6_2:1.23.0.2
	OPENBSD_6_2_BASE:1.23
	OPENBSD_6_1:1.23.0.4
	OPENBSD_6_1_BASE:1.23
	OPENBSD_6_0:1.22.0.4
	OPENBSD_6_0_BASE:1.22
	OPENBSD_5_9:1.22.0.2
	OPENBSD_5_9_BASE:1.22
	OPENBSD_5_8:1.20.0.6
	OPENBSD_5_8_BASE:1.20
	OPENBSD_5_7:1.20.0.2
	OPENBSD_5_7_BASE:1.20
	OPENBSD_5_6:1.19.0.12
	OPENBSD_5_6_BASE:1.19
	OPENBSD_5_5:1.19.0.10
	OPENBSD_5_5_BASE:1.19
	OPENBSD_5_4:1.19.0.6
	OPENBSD_5_4_BASE:1.19
	OPENBSD_5_3:1.19.0.4
	OPENBSD_5_3_BASE:1.19
	OPENBSD_5_2:1.19.0.2
	OPENBSD_5_2_BASE:1.19
	OPENBSD_5_1_BASE:1.18
	OPENBSD_5_1:1.18.0.4
	OPENBSD_5_0:1.18.0.2
	OPENBSD_5_0_BASE:1.18
	OPENBSD_4_9:1.14.0.6
	OPENBSD_4_9_BASE:1.14
	OPENBSD_4_8:1.14.0.4
	OPENBSD_4_8_BASE:1.14
	OPENBSD_4_7:1.14.0.2
	OPENBSD_4_7_BASE:1.14
	OPENBSD_4_6:1.11.0.10
	OPENBSD_4_6_BASE:1.11
	OPENBSD_4_5:1.11.0.6
	OPENBSD_4_5_BASE:1.11
	OPENBSD_4_4:1.11.0.4
	OPENBSD_4_4_BASE:1.11
	OPENBSD_4_3:1.11.0.2
	OPENBSD_4_3_BASE:1.11
	OPENBSD_4_2:1.10.0.2
	OPENBSD_4_2_BASE:1.10
	OPENBSD_4_1:1.7.0.2
	OPENBSD_4_1_BASE:1.7
	OPENBSD_4_0:1.5.0.2
	OPENBSD_4_0_BASE:1.5
	OPENBSD_3_9:1.4.0.2
	OPENBSD_3_9_BASE:1.4
	OPENBSD_3_8:1.3.0.2
	OPENBSD_3_8_BASE:1.3;
locks; strict;
comment	@.\" @;


1.23
date	2017.01.15.06.16.05;	author deraadt;	state Exp;
branches;
next	1.22;
commitid	jULZlcSeCUOWhNLd;

1.22
date	2016.01.04.18.03.09;	author jmc;	state Exp;
branches;
next	1.21;
commitid	YWrRwoI9mUaUQmmI;

1.21
date	2015.12.01.07.32.37;	author deraadt;	state Exp;
branches;
next	1.20;
commitid	jEohs636eIVa2Oc1;

1.20
date	2015.01.09.11.19.12;	author stsp;	state Exp;
branches;
next	1.19;
commitid	bffZ6gV3bujgk3hF;

1.19
date	2012.06.25.11.49.19;	author jmc;	state Exp;
branches;
next	1.18;

1.18
date	2011.05.16.16.38.51;	author jmc;	state Exp;
branches;
next	1.17;

1.17
date	2011.05.12.18.36.07;	author mcbride;	state Exp;
branches;
next	1.16;

1.16
date	2011.04.28.00.21.33;	author mikeb;	state Exp;
branches;
next	1.15;

1.15
date	2011.04.28.00.17.28;	author mikeb;	state Exp;
branches;
next	1.14;

1.14
date	2009.11.21.13.59.31;	author claudio;	state Exp;
branches;
next	1.13;

1.13
date	2009.09.07.09.41.02;	author jmc;	state Exp;
branches;
next	1.12;

1.12
date	2009.09.01.14.03.59;	author claudio;	state Exp;
branches;
next	1.11;

1.11
date	2008.02.26.18.52.53;	author henning;	state Exp;
branches;
next	1.10;

1.10
date	2007.08.01.15.45.41;	author jmc;	state Exp;
branches;
next	1.9;

1.9
date	2007.08.01.09.31.41;	author henning;	state Exp;
branches;
next	1.8;

1.8
date	2007.05.31.19.20.23;	author jmc;	state Exp;
branches;
next	1.7;

1.7
date	2006.12.30.13.01.54;	author camield;	state Exp;
branches;
next	1.6;

1.6
date	2006.10.23.07.05.49;	author jmc;	state Exp;
branches;
next	1.5;

1.5
date	2006.08.30.06.30.00;	author camield;	state Exp;
branches;
next	1.4;

1.4
date	2005.11.20.10.01.30;	author jmc;	state Exp;
branches;
next	1.3;

1.3
date	2005.06.07.04.37.32;	author camield;	state Exp;
branches;
next	1.2;

1.2
date	2005.05.31.21.47.20;	author jmc;	state Exp;
branches;
next	1.1;

1.1
date	2005.05.26.04.38.35;	author camield;	state Exp;
branches;
next	;


desc
@@


1.23
log
@fix typo; from semarie
@
text
@.\"	$OpenBSD: ftp-proxy.8,v 1.22 2016/01/04 18:03:09 jmc Exp $
.\"
.\" Copyright (c) 2004, 2005 Camiel Dobbelaar, <cd@@sentia.nl>
.\"
.\" Permission to use, copy, modify, and distribute this software for any
.\" purpose with or without fee is hereby granted, provided that the above
.\" copyright notice and this permission notice appear in all copies.
.\"
.\" THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
.\" WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
.\" MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
.\" ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
.\" WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
.\" ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
.\" OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
.\"
.Dd $Mdocdate: January 4 2016 $
.Dt FTP-PROXY 8
.Os
.Sh NAME
.Nm ftp-proxy
.Nd Internet File Transfer Protocol proxy daemon
.Sh SYNOPSIS
.Nm
.Bk -words
.Op Fl 6Adrv
.Op Fl a Ar address
.Op Fl b Ar address
.Op Fl D Ar level
.Op Fl m Ar maxsessions
.Op Fl P Ar port
.Op Fl p Ar port
.Op Fl q Ar queue
.Op Fl R Ar address
.Op Fl T Ar tag
.Op Fl t Ar timeout
.Ek
.Sh DESCRIPTION
.Nm
is a proxy for the Internet File Transfer Protocol.
FTP control connections should be redirected into the proxy using the
.Xr pf 4
.Ar divert-to
command, after which the proxy connects to the server on behalf of
the client.
.Pp
The proxy allows data connections to pass, rewriting and redirecting
them so that the right addresses are used.
All connections from the client to the server have their source
address rewritten so they appear to come from the proxy.
Consequently, all connections from the server to the proxy have
their destination address rewritten, so they are redirected to the
client.
The proxy uses the
.Xr pf 4
.Ar anchor
facility for this.
.Pp
Assuming the FTP control connection is from $client to $server, the
proxy connected to the server using the $proxy source address, and
$port is negotiated, then
.Nm
adds the following rules to the anchor.
$server and $orig_server are the same unless
.Fl R
is used to force a different $server address for all connections.
(These example rules use inet, but the proxy also supports inet6.)
.Pp
In case of active mode (PORT or EPRT):
.Bd -literal -offset 2n
pass in from $server to $proxy port $proxy_port \e
    rdr-to $client port $port
pass out from $server to $client port $port \e
    nat-to $orig_server port $natport
.Ed
.Pp
In case of passive mode (PASV or EPSV):
.Bd -literal -offset 2n
pass in from $client to $orig_server port $proxy_port \e
    rdr-to $server port $port
pass out from $client to $server port $port nat-to $proxy
.Ed
.Pp
.Nm
chroots to "/var/empty" and changes to user "_ftp_proxy" to drop privileges.
.Pp
The options are as follows:
.Bl -tag -width Ds
.It Fl 6
IPv6 mode.
The proxy will expect and use IPv6 addresses for all communication.
Only the extended FTP modes EPSV and EPRT are allowed with IPv6.
The proxy is in IPv4 mode by default.
.It Fl A
Only permit anonymous FTP connections.
Either user "ftp" or user "anonymous" is allowed.
.It Fl a Ar address
The proxy will use this as the source address for the control
connection to a server.
.It Fl b Ar address
Address where the proxy will listen for redirected control connections.
The default is 127.0.0.1, or ::1 in IPv6 mode.
.It Fl D Ar level
Debug level, ranging from 0 to 7.
Higher is more verbose.
The default is 5.
(These levels correspond to the
.Xr syslog 3
levels.)
.It Fl d
Do not daemonize.
The process will stay in the foreground, logging to standard error.
.It Fl m Ar maxsessions
Maximum number of concurrent FTP sessions.
When the proxy reaches this limit, new connections are denied.
The default is 100 sessions.
The limit can be lowered to a minimum of 1, or raised to a maximum of 500.
.It Fl P Ar port
Fixed server port.
Only used in combination with
.Fl R .
The default is port 21.
.It Fl p Ar port
Port where the proxy will listen for redirected connections.
The default is port 8021.
.It Fl q Ar queue
Create rules with queue
.Ar queue
appended, so that data connections can be queued.
.It Fl R Ar address
Fixed server address, also known as reverse mode.
The proxy will always connect to the same server, regardless of
where the client wanted to connect to (before it was redirected).
Use this option to proxy for a server behind NAT, or to forward all
connections to another proxy.
.It Fl r
Rewrite sourceport to 20 in active mode to suit ancient clients that insist
on this RFC property.
.It Fl T Ar tag
The filter rules will add tag
.Ar tag
to data connections, and will use match rules instead of pass ones.
This way alternative rules that use the
.Ar tagged
keyword can be implemented following the
.Nm
anchor.
These rules can use special
.Xr pf 4
features like route-to, reply-to, label, rtable, overload, etc. that
.Nm
does not implement itself.
There must be a matching pass rule after the
.Nm
anchor or the data connections will be blocked.
.It Fl t Ar timeout
Number of seconds that the control connection can be idle, before the
proxy will disconnect.
The maximum is 86400 seconds, which is also the default.
Do not set this too low, because the control connection is usually
idle when large data transfers are taking place.
.It Fl v
Set the 'log' flag on pf rules committed by
.Nm .
Use twice to set the 'log all' flag.
The pf rules do not log by default.
.El
.Sh CONFIGURATION
To make use of the proxy,
.Xr pf.conf 5
needs the following rules.
Adjust the rules as needed; depending on the rest of the ruleset, the
last rule explicitly allowing FTP sessions from the proxy may not be
necessary.
.Bd -literal -offset 2n
anchor "ftp-proxy/*"
pass in quick proto tcp to port ftp divert-to 127.0.0.1 port 8021
pass out inet proto tcp from (self) to any port ftp
.Ed
.Sh SEE ALSO
.Xr ftp 1 ,
.Xr pf 4 ,
.Xr pf.conf 5
.Sh CAVEATS
.Xr pf 4
does not allow the ruleset to be modified if the system is running at a
.Xr securelevel 7
higher than 1.
At that level
.Nm
cannot add rules to the anchors and FTP data connections may get blocked.
.Pp
Negotiated data connection ports below 1024 are not allowed.
.Pp
The negotiated IP address for active modes is ignored for security
reasons.
This makes third party file transfers impossible.
.Pp
Since
.Nm
acts as a man-in-the-middle it breaks explicit FTP TLS connections (RFC 4217).
@


1.22
log
@no need for af on divert-to rule; from/ok mikeb
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.21 2015/12/01 07:32:37 deraadt Exp $
d17 1
a17 1
.Dd $Mdocdate: December 1 2015 $
d85 1
a85 1
chroots to "/var/empty" and changes to user "_ftp-proxy" to drop privileges.
@


1.21
log
@switch to new _ftp_proxy user; ok dlg
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.20 2015/01/09 11:19:12 stsp Exp $
d17 1
a17 1
.Dd $Mdocdate: January 9 2015 $
d177 1
a177 1
pass in quick inet proto tcp to port ftp divert-to 127.0.0.1 port 8021
@


1.20
log
@Document that ftp-proxy breaks explicit RFC4217 FTP TLS. While here,
chroot and privdrop is a feature, not a bug, so move it out of CAVEATS.
ok sthen
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.19 2012/06/25 11:49:19 jmc Exp $
d17 1
a17 1
.Dd $Mdocdate: June 25 2012 $
d85 1
a85 1
chroots to "/var/empty" and changes to user "proxy" to drop privileges.
@


1.19
log
@log all, not log-all; ok henning
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.18 2011/05/16 16:38:51 jmc Exp $
d17 1
a17 1
.Dd $Mdocdate: May 16 2011 $
d84 3
d199 1
d201 1
a201 1
chroots to "/var/empty" and changes to user "proxy" to drop privileges.
@


1.18
log
@tweak previous;
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.17 2011/05/12 18:36:07 mcbride Exp $
d17 1
a17 1
.Dd $Mdocdate: May 12 2011 $
d162 1
a162 1
Use twice to set the 'log-all' flag.
@


1.17
log
@Make it clear that ftp-proxy needs to make outbound connections.

ok claudio
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.16 2011/04/28 00:21:33 mikeb Exp $
d17 1
a17 1
.Dd $Mdocdate: April 28 2011 $
d169 2
a170 2
Adjust the rules as needed; depending on the rest of your ruleset the
last rule explicitly allowing ftp sessions from the proxy may not be
@


1.16
log
@divert-to is picky about the address family so adjust the rule
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.15 2011/04/28 00:17:28 mikeb Exp $
d169 3
a171 1
Adjust the rules as needed.
d175 1
@


1.15
log
@switch ftp-proxy over to divert-to instead of rdr-to.  this avoids
an expensive state lookup (via natlook ioctl) and shrinks the code.
tested by me and sthen, ok reyk sthen
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.14 2009/11/21 13:59:31 claudio Exp $
d17 1
a17 1
.Dd $Mdocdate: November 21 2009 $
d172 1
a172 1
pass in quick proto tcp to port ftp divert-to 127.0.0.1 port 8021
@


1.14
log
@If tagging is used use match rules instead of pass rules. This is needed
so that later pass rules will not overwrite the nat-to/rdr-to settings.
Because of this there must be an expilicit "pass .. tagged proxytag .."
rule after the ftp-proxy anchor. OK henning@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.13 2009/09/07 09:41:02 jmc Exp $
d17 1
a17 1
.Dd $Mdocdate: September 7 2009 $
d43 1
a43 1
.Ar rdr-to
d172 1
a172 1
pass in quick proto tcp to port ftp rdr-to 127.0.0.1 port 8021
@


1.13
log
@rdr -> rdr-to
from Karl-Heinz Wild
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.12 2009/09/01 14:03:59 claudio Exp $
d17 1
a17 1
.Dd $Mdocdate: September 1 2009 $
d139 1
a139 1
to data connections, and not match quick.
d150 3
@


1.12
log
@Bring manpage up to speed with the changes that just happend or at least
try to.
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.11 2008/02/26 18:52:53 henning Exp $
d17 1
a17 1
.Dd $Mdocdate: February 26 2008 $
d43 1
a43 1
.Ar rdr
d169 1
a169 1
pass in quick proto tcp to port ftp rdr to 127.0.0.1 port 8021
@


1.11
log
@Don't pass quick when tagging, so the tag can be used outside
the ftp-proxy anchor.  Exotic setups with route-to etc.
can be implemented this way.
from camield, ok reyk beck canacar and manpage polished by jmc
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.10 2007/08/01 15:45:41 jmc Exp $
d17 1
a17 1
.Dd $Mdocdate$
d63 4
a66 1
adds the following rules to the various anchors.
d71 4
a74 3
rdr from $server to $proxy port $port -> $client
pass quick inet proto tcp \e
    from $server to $client port $port
d79 3
a81 5
nat from $client to $server port $port -> $proxy
pass in quick inet proto tcp \e
    from $client to $server port $port
pass out quick inet proto tcp \e
    from $proxy to $server port $port
a165 1
All anchors are mandatory.
a166 10
.Pp
In the NAT section:
.Bd -literal -offset 2n
nat-anchor "ftp-proxy/*"
rdr-anchor "ftp-proxy/*"
rdr pass on $int_if proto tcp from $lan to any port 21 -> \e
    127.0.0.1 port 8021
.Ed
.Pp
In the rule section:
d169 1
a169 1
pass out proto tcp from $proxy to any port 21
@


1.10
log
@- -T before -t
- use .Bk/.Ek
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.9 2007/08/01 09:31:41 henning Exp $
d24 1
a24 1
.Nm ftp-proxy
d62 1
a62 1
.Nm ftp-proxy
d135 9
a143 1
Automatically tag packets passing through the
d145 3
a147 1
rule with the name supplied.
d190 1
a190 1
.Nm ftp-proxy
d199 1
a199 1
.Nm ftp-proxy
@


1.9
log
@allow ftp-proxy to add tag statements to teh rules it inserts
clever, nice and easy diff from bsd@@openbsd.rutgers.edu, ok pyr reyk
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.8 2007/05/31 19:20:23 jmc Exp $
d25 1
d35 1
d37 1
a37 1
.Op Fl T Ar tag
d134 4
a143 4
.It Fl T Ar tag
Automatically tag packets passing through the
.Xr pf 4
rule with the name supplied.
@


1.8
log
@convert to new .Dd format;
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.7 2006/12/30 13:01:54 camield Exp $
d35 1
d138 4
@


1.7
log
@Convert three instances of atoi() to strtonum() and apply sane upper bounds.

Triggered by Rik/harry Bobbaers on bugs@@.

ok mbalmer@@ ray@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.6 2006/10/23 07:05:49 jmc Exp $
d17 1
a17 1
.Dd November 28, 2004
@


1.6
log
@no need to use "keep state" and "flags S/SA" in pf rules,
now that it is the default;

ok henning mcbride camield (ftp-proxy bits) deraadt
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.5 2006/08/30 06:30:00 camield Exp $
d108 2
a109 1
The default is 100.
d134 1
a134 1
The default is 24 hours.
@


1.5
log
@document that ftp-proxy cannot function at a raised securelevel

ok jmc marco
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.4 2005/11/20 10:01:30 jmc Exp $
d67 1
a67 1
    from $server to $client port $port flags S/SAFR keep state
d74 1
a74 1
    from $client to $server port $port flags S/SAFR keep state
d76 1
a76 1
    from $proxy to $server port $port flags S/SAFR keep state
d160 1
a160 1
pass out proto tcp from $proxy to any port 21 keep state
@


1.4
log
@.Sh SECURITY -> .Sh CAVEATS
ok camield@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.3 2005/06/07 04:37:32 camield Exp $
d167 8
@


1.3
log
@Introduce verbose option to control the logging of the pf rules.

ok beck mpf
@
text
@d1 1
a1 1
.\"	$OpenBSD: ftp-proxy.8,v 1.2 2005/05/31 21:47:20 jmc Exp $
d162 5
a166 1
.Sh SECURITY
a174 4
.Sh SEE ALSO
.Xr ftp 1 ,
.Xr pf 4 ,
.Xr pf.conf 5
@


1.2
log
@tweaks;
@
text
@d1 1
a1 1
.\"	$OpenBSD$
d25 1
a25 1
.Op Fl 6Adr
d66 1
a66 1
pass log quick inet proto tcp \e
d73 1
a73 1
pass in log quick inet proto tcp \e
d75 1
a75 1
pass out log quick inet proto tcp \e
d136 5
@


1.1
log
@Import new FTP proxy.  Handles IPv6 and all FTP modes.  It was
previously known as pftpx.

Not connected to the builds yet.

ok beck
@
text
@d1 1
d82 2
a83 2
IPv6 mode.  The proxy will expect and use IPv6 addresses for all
communication.
d111 2
a112 1
Only used in combination with -R.
d128 1
a128 1
Rewrite sourceport to 20 in active mode to suit antique clients that insist
d169 1
a169 1
.Xr pf.conf 5 ,
@

