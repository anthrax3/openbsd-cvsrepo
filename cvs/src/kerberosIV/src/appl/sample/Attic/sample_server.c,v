head	1.7;
access;
symbols
	OPENBSD_3_3:1.6.0.4
	OPENBSD_3_3_BASE:1.6
	OPENBSD_3_2:1.6.0.2
	OPENBSD_3_2_BASE:1.6
	KRB4_1_1_1:1.1.1.3
	OPENBSD_3_1:1.3.0.8
	OPENBSD_3_1_BASE:1.3
	OPENBSD_3_0:1.3.0.6
	OPENBSD_3_0_BASE:1.3
	KRB4_1_0_8:1.1.1.2
	OPENBSD_2_9:1.3.0.4
	OPENBSD_2_9_BASE:1.3
	KRB4_1_0_4:1.1.1.2
	OPENBSD_2_8:1.3.0.2
	OPENBSD_2_8_BASE:1.3
	KRB4_1_0_2:1.1.1.2
	OPENBSD_2_7:1.1.1.1.0.2
	OPENBSD_2_7_BASE:1.1.1.1
	KRB4_1_0:1.1.1.1
	KTH:1.1.1;
locks; strict;
comment	@ * @;


1.7
date	2003.05.16.18.45.35;	author mho;	state dead;
branches;
next	1.6;

1.6
date	2002.06.08.22.13.18;	author hin;	state Exp;
branches;
next	1.5;

1.5
date	2002.06.08.21.49.00;	author hin;	state Exp;
branches;
next	1.4;

1.4
date	2002.06.07.03.10.17;	author hin;	state Exp;
branches;
next	1.3;

1.3
date	2000.07.11.09.19.27;	author hin;	state Exp;
branches;
next	1.2;

1.2
date	2000.06.29.00.41.13;	author millert;	state Exp;
branches;
next	1.1;

1.1
date	2000.02.25.15.32.48;	author hin;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2000.02.25.15.32.48;	author hin;	state Exp;
branches
	1.1.1.1.2.1;
next	1.1.1.2;

1.1.1.2
date	2000.07.11.09.06.01;	author hin;	state Exp;
branches;
next	1.1.1.3;

1.1.1.3
date	2002.06.08.21.07.19;	author hin;	state Exp;
branches;
next	;

1.1.1.1.2.1
date	2000.10.07.04.57.54;	author jason;	state Exp;
branches;
next	;


desc
@@


1.7
log
@Bye, bye, kerberosIV; ok hin@@
@
text
@/*
 *
 * Copyright 1987, 1988 by the Massachusetts Institute of Technology.
 *
 * For copying and distribution information,
 * please see the file <mit-copyright.h>.
 *
 * sample_server:
 * A sample Kerberos server, which reads a ticket from a TCP socket,
 * decodes it, and writes back the results (in ASCII) to the client.
 *
 * Usage:
 * sample_server
 *
 * file descriptor 0 (zero) should be a socket connected to the requesting
 * client (this will be correct if this server is started by inetd).
 */

#include "sample.h"

RCSID("$KTH: sample_server.c,v 1.17 2001/09/17 04:42:50 assar Exp $");

static void
usage (void)
{
    fprintf (stderr, "Usage: %s [-i] [-s service] [-t srvtab]\n",
	     __progname);
    exit (1);
}

int
main(int argc, char **argv)
{
    struct sockaddr_in peername, myname;
    socklen_t namelen = sizeof(peername);
    int status, count, len;
    long authopts;
    AUTH_DAT auth_data;
    KTEXT_ST clt_ticket;
    des_key_schedule sched;
    char instance[INST_SZ];
    char service[ANAME_SZ];
    char version[KRB_SENDAUTH_VLEN+1];
    char retbuf[512];
    char lname[ANAME_SZ];
    char srvtab[MaxPathLen];
    int c;
    int no_inetd = 0;

    /* open a log connection */

    roken_openlog(__progname, LOG_ODELAY, LOG_DAEMON);

    strlcpy (service, SAMPLE_SERVICE, sizeof(service));
    *srvtab = '\0';

    while ((c = getopt (argc, argv, "s:t:i")) != -1)
	switch (c) {
	case 's' :
	    strlcpy (service, optarg, sizeof(service));
	    break;
	case 't' :
	    strlcpy (srvtab, optarg, sizeof(srvtab));
	    break;
	case 'i':
	    no_inetd = 1;
	    break;
	case '?' :
	default :
	    usage ();
	}

    if (no_inetd)
	mini_inetd (htons(SAMPLE_PORT));

    /*
     * To verify authenticity, we need to know the address of the
     * client.
     */
    if (getpeername(STDIN_FILENO,
		    (struct sockaddr *)&peername,
		    &namelen) < 0) {
	syslog(LOG_ERR, "getpeername: %m");
	return 1;
    }

    /* for mutual authentication, we need to know our address */
    namelen = sizeof(myname);
    if (getsockname(STDIN_FILENO, (struct sockaddr *)&myname, &namelen) < 0) {
	syslog(LOG_ERR, "getsocknamename: %m");
	return 1;
    }

    /* read the authenticator and decode it.  Using `k_getsockinst' we
     * always get the right instance on a multi-homed host.
     */
    k_getsockinst (STDIN_FILENO, instance, sizeof(instance));

    /* we want mutual authentication */
    authopts = KOPT_DO_MUTUAL;
    status = krb_recvauth(authopts, STDIN_FILENO, &clt_ticket,
			  service, instance, &peername, &myname,
			  &auth_data, srvtab,
			  sched, version);
    if (status != KSUCCESS) {
	snprintf(retbuf, sizeof(retbuf),
		 "Kerberos error: %s\n",
		 krb_get_err_text(status));
	syslog(LOG_ERR, "%s", retbuf);
    } else {
	/* Check the version string (KRB_SENDAUTH_VLEN chars) */
	if (strncmp(version, SAMPLE_VERSION, KRB_SENDAUTH_VLEN)) {
	    /* didn't match the expected version */
	    /* could do something different, but we just log an error
	       and continue */
	    version[8] = '\0';		/* make sure null term */
	    syslog(LOG_ERR, "Version mismatch: '%s' isn't '%s'",
		   version, SAMPLE_VERSION);
	}
	/* now that we have decoded the authenticator, translate
	   the kerberos principal.instance@@realm into a local name */
	if (krb_kntoln(&auth_data, lname) != KSUCCESS)
	    strlcpy(lname,
			    "*No local name returned by krb_kntoln*",
			    sizeof(lname));
	/* compose the reply */
	snprintf(retbuf, sizeof(retbuf),
		"You are %s.%s@@%s (local name %s),\n at address %s, version %s, cksum %ld\n",
		auth_data.pname,
		auth_data.pinst,
		auth_data.prealm,
		lname,
		inet_ntoa(peername.sin_addr),
		version,
		(long)auth_data.checksum);
    }

    /* write back the response */
    if ((count = write(0, retbuf, (len = strlen(retbuf) + 1))) < 0) {
	syslog(LOG_ERR,"write: %m");
	return 1;
    } else if (count != len) {
	syslog(LOG_ERR, "write count incorrect: %d != %d\n",
		count, len);
	return 1;
    }

    /* close up and exit */
    close(0);
    return 0;
}
@


1.6
log
@cvs put set/getprogname() stuff back. remove it once again.
@
text
@@


1.5
log
@Merge krb4-1.1.1
@
text
@d27 1
a27 1
	     getprogname());
@


1.4
log
@set_progname/get_progname cleanup
@
text
@d21 1
a21 1
RCSID("$KTH: sample_server.c,v 1.14.2.1 2000/06/28 19:08:00 assar Exp $");
d27 1
a27 1
	     __progname);
d35 1
a35 1
    int namelen = sizeof(peername);
@


1.3
log
@Merge in KTH Kerberos4 1.0.2
@
text
@a51 2
    set_progname (argv[0]);

@


1.2
log
@use %s with syslog, probably just paranoia but it is good form
@
text
@d21 1
a21 1
RCSID("$KTH: sample_server.c,v 1.14 1999/11/13 06:28:49 assar Exp $");
@


1.1
log
@Initial revision
@
text
@d111 1
a111 1
	syslog(LOG_ERR, retbuf);
@


1.1.1.1
log
@Importing KTH Kerberos4 version 1.0
(art@@ ok)
@
text
@@


1.1.1.1.2.1
log
@Pull in patch from current:
Fix (millert):
use %s with syslog, probably just paranoia but it is good form
@
text
@d111 1
a111 1
	syslog(LOG_ERR, "%s", retbuf);
@


1.1.1.2
log
@Import of KTH Kerberos4 1.0.2
@
text
@d21 1
a21 1
RCSID("$KTH: sample_server.c,v 1.14.2.1 2000/06/28 19:08:00 assar Exp $");
d111 1
a111 1
	syslog(LOG_ERR, "%s", retbuf);
@


1.1.1.3
log
@Import of krb4-1.1.1
@
text
@d21 1
a21 1
RCSID("$KTH: sample_server.c,v 1.17 2001/09/17 04:42:50 assar Exp $");
d27 1
a27 1
	     getprogname());
d35 1
a35 1
    socklen_t namelen = sizeof(peername);
d52 1
a52 1
    setprogname (argv[0]);
d54 1
a54 1
    roken_openlog(getprogname(), LOG_ODELAY, LOG_DAEMON);
@


