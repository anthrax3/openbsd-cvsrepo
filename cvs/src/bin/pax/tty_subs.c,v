head	1.17;
access;
symbols
	OPENBSD_6_0:1.16.0.8
	OPENBSD_6_0_BASE:1.16
	OPENBSD_5_9:1.16.0.4
	OPENBSD_5_9_BASE:1.16
	OPENBSD_5_8:1.16.0.6
	OPENBSD_5_8_BASE:1.16
	OPENBSD_5_7:1.16.0.2
	OPENBSD_5_7_BASE:1.16
	OPENBSD_5_6:1.15.0.10
	OPENBSD_5_6_BASE:1.15
	OPENBSD_5_5:1.15.0.8
	OPENBSD_5_5_BASE:1.15
	OPENBSD_5_4:1.15.0.4
	OPENBSD_5_4_BASE:1.15
	OPENBSD_5_3:1.15.0.2
	OPENBSD_5_3_BASE:1.15
	OPENBSD_5_2:1.14.0.12
	OPENBSD_5_2_BASE:1.14
	OPENBSD_5_1_BASE:1.14
	OPENBSD_5_1:1.14.0.10
	OPENBSD_5_0:1.14.0.8
	OPENBSD_5_0_BASE:1.14
	OPENBSD_4_9:1.14.0.6
	OPENBSD_4_9_BASE:1.14
	OPENBSD_4_8:1.14.0.4
	OPENBSD_4_8_BASE:1.14
	OPENBSD_4_7:1.14.0.2
	OPENBSD_4_7_BASE:1.14
	OPENBSD_4_6:1.13.0.4
	OPENBSD_4_6_BASE:1.13
	OPENBSD_4_5:1.12.0.24
	OPENBSD_4_5_BASE:1.12
	OPENBSD_4_4:1.12.0.22
	OPENBSD_4_4_BASE:1.12
	OPENBSD_4_3:1.12.0.20
	OPENBSD_4_3_BASE:1.12
	OPENBSD_4_2:1.12.0.18
	OPENBSD_4_2_BASE:1.12
	OPENBSD_4_1:1.12.0.16
	OPENBSD_4_1_BASE:1.12
	OPENBSD_4_0:1.12.0.14
	OPENBSD_4_0_BASE:1.12
	OPENBSD_3_9:1.12.0.12
	OPENBSD_3_9_BASE:1.12
	OPENBSD_3_8:1.12.0.10
	OPENBSD_3_8_BASE:1.12
	OPENBSD_3_7:1.12.0.8
	OPENBSD_3_7_BASE:1.12
	OPENBSD_3_6:1.12.0.6
	OPENBSD_3_6_BASE:1.12
	OPENBSD_3_5:1.12.0.4
	OPENBSD_3_5_BASE:1.12
	OPENBSD_3_4:1.12.0.2
	OPENBSD_3_4_BASE:1.12
	OPENBSD_3_3:1.11.0.2
	OPENBSD_3_3_BASE:1.11
	OPENBSD_3_2:1.8.0.4
	OPENBSD_3_2_BASE:1.8
	OPENBSD_3_1:1.8.0.2
	OPENBSD_3_1_BASE:1.8
	OPENBSD_3_0:1.7.0.2
	OPENBSD_3_0_BASE:1.7
	OPENBSD_2_9:1.6.0.8
	OPENBSD_2_9_BASE:1.6
	OPENBSD_2_8:1.6.0.6
	OPENBSD_2_8_BASE:1.6
	OPENBSD_2_7:1.6.0.4
	OPENBSD_2_7_BASE:1.6
	OPENBSD_2_6:1.6.0.2
	OPENBSD_2_6_BASE:1.6
	OPENBSD_2_5:1.5.0.8
	OPENBSD_2_5_BASE:1.5
	OPENBSD_2_4:1.5.0.6
	OPENBSD_2_4_BASE:1.5
	OPENBSD_2_3:1.5.0.4
	OPENBSD_2_3_BASE:1.5
	OPENBSD_2_2:1.5.0.2
	OPENBSD_2_2_BASE:1.5
	OPENBSD_2_1:1.3.0.4
	OPENBSD_2_1_BASE:1.3
	OPENBSD_2_0:1.3.0.2
	OPENBSD_2_0_BASE:1.3
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@ * @;


1.17
date	2016.08.26.04.22.13;	author guenther;	state Exp;
branches;
next	1.16;
commitid	ez44v6TDoBWWWlPi;

1.16
date	2014.11.23.05.28.12;	author guenther;	state Exp;
branches;
next	1.15;
commitid	GoH40iniQ6KqwYGS;

1.15
date	2012.12.04.02.24.45;	author deraadt;	state Exp;
branches;
next	1.14;

1.14
date	2009.10.27.23.59.22;	author deraadt;	state Exp;
branches;
next	1.13;

1.13
date	2009.06.01.13.02.46;	author ray;	state Exp;
branches;
next	1.12;

1.12
date	2003.06.02.23.32.09;	author millert;	state Exp;
branches;
next	1.11;

1.11
date	2003.03.04.20.27.58;	author deraadt;	state Exp;
branches;
next	1.10;

1.10
date	2002.10.16.19.20.02;	author millert;	state Exp;
branches;
next	1.9;

1.9
date	2002.10.16.17.43.10;	author millert;	state Exp;
branches;
next	1.8;

1.8
date	2002.02.19.19.39.35;	author millert;	state Exp;
branches;
next	1.7;

1.7
date	2001.09.05.22.32.27;	author deraadt;	state Exp;
branches;
next	1.6;

1.6
date	99.08.09.22.22.52;	author pjanzen;	state Exp;
branches;
next	1.5;

1.5
date	97.07.25.18.58.39;	author mickey;	state Exp;
branches;
next	1.4;

1.4
date	97.07.23.19.16.00;	author kstailey;	state Exp;
branches;
next	1.3;

1.3
date	96.06.23.14.20.44;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	96.06.11.06.41.55;	author tholo;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.37.18;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.37.18;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.17
log
@<sys/time.h>, <errno.h>, and <stdlib.h> are unnecessary; sort #includes
@
text
@/*	$OpenBSD: tty_subs.c,v 1.16 2014/11/23 05:28:12 guenther Exp $	*/
/*	$NetBSD: tty_subs.c,v 1.5 1995/03/21 09:07:52 cgd Exp $	*/

/*-
 * Copyright (c) 1992 Keith Muller.
 * Copyright (c) 1992, 1993
 *	The Regents of the University of California.  All rights reserved.
 *
 * This code is derived from software contributed to Berkeley by
 * Keith Muller of the University of California, San Diego.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */

#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdarg.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

#include "pax.h"
#include "extern.h"

/*
 * routines that deal with I/O to and from the user
 */

#define DEVTTY		"/dev/tty"	/* device for interactive i/o */
static FILE *ttyoutf = NULL;		/* output pointing at control tty */
static FILE *ttyinf = NULL;		/* input pointing at control tty */

/*
 * tty_init()
 *	try to open the controlling terminal (if any) for this process. if the
 *	open fails, future ops that require user input will get an EOF
 */

int
tty_init(void)
{
	int ttyfd;

	if ((ttyfd = open(DEVTTY, O_RDWR | O_CLOEXEC)) >= 0) {
		if ((ttyoutf = fdopen(ttyfd, "w")) != NULL) {
			if ((ttyinf = fdopen(ttyfd, "r")) != NULL)
				return(0);
			(void)fclose(ttyoutf);
		}
		(void)close(ttyfd);
	}

	if (iflag) {
		paxwarn(1, "Fatal error, cannot open %s", DEVTTY);
		return(-1);
	}
	return(0);
}

/*
 * tty_prnt()
 *	print a message using the specified format to the controlling tty
 *	if there is no controlling terminal, just return.
 */

void
tty_prnt(const char *fmt, ...)
{
	va_list ap;

	va_start(ap, fmt);
	if (ttyoutf == NULL) {
		va_end(ap);
		return;
	}
	(void)vfprintf(ttyoutf, fmt, ap);
	va_end(ap);
	(void)fflush(ttyoutf);
}

/*
 * tty_read()
 *	read a string from the controlling terminal if it is open into the
 *	supplied buffer
 * Return:
 *	0 if data was read, -1 otherwise.
 */

int
tty_read(char *str, int len)
{
	if (ttyinf == NULL || fgets(str, len, ttyinf) == NULL)
		return(-1);

	/*
	 * strip off that trailing newline
	 */
	str[strcspn(str, "\n")] = '\0';
	return(0);
}

/*
 * paxwarn()
 *	write a warning message to stderr. if "set" the exit value of pax
 *	will be non-zero.
 */

void
paxwarn(int set, const char *fmt, ...)
{
	va_list ap;

	va_start(ap, fmt);
	if (set)
		exit_val = 1;
	/*
	 * when vflag we better ship out an extra \n to get this message on a
	 * line by itself
	 */
	if (vflag && vfpart) {
		(void)fflush(listf);
		(void)fputc('\n', stderr);
		vfpart = 0;
	}
	(void)fprintf(stderr, "%s: ", argv0);
	(void)vfprintf(stderr, fmt, ap);
	va_end(ap);
	(void)fputc('\n', stderr);
}

/*
 * syswarn()
 *	write a warning message to stderr. if "set" the exit value of pax
 *	will be non-zero.
 */

void
syswarn(int set, int errnum, const char *fmt, ...)
{
	va_list ap;

	va_start(ap, fmt);
	if (set)
		exit_val = 1;
	/*
	 * when vflag we better ship out an extra \n to get this message on a
	 * line by itself
	 */
	if (vflag && vfpart) {
		(void)fflush(listf);
		(void)fputc('\n', stderr);
		vfpart = 0;
	}
	(void)fprintf(stderr, "%s: ", argv0);
	(void)vfprintf(stderr, fmt, ap);
	va_end(ap);

	/*
	 * format and print the errno
	 */
	if (errnum > 0)
		(void)fprintf(stderr, ": %s", strerror(errnum));
	(void)fputc('\n', stderr);
}
@


1.16
log
@Don't leak the fds for "." and the tty to the compression process
@
text
@d1 1
a1 1
/*	$OpenBSD: tty_subs.c,v 1.15 2012/12/04 02:24:45 deraadt Exp $	*/
a37 1
#include <sys/time.h>
d40 1
d42 1
a42 1
#include <errno.h>
d44 1
a44 2
#include <stdlib.h>
#include <string.h>
a46 1
#include <stdarg.h>
@


1.15
log
@remove some unnecessary sys/param.h inclusions
@
text
@d1 1
a1 1
/*	$OpenBSD: tty_subs.c,v 1.14 2009/10/27 23:59:22 deraadt Exp $	*/
d69 1
a69 1
	if ((ttyfd = open(DEVTTY, O_RDWR)) >= 0) {
@


1.14
log
@rcsid[] and sccsid[] and copyright[] are essentially unmaintained (and
unmaintainable).  these days, people use source.  these id's do not provide
any benefit, and do hurt the small install media
(the 33,000 line diff is essentially mechanical)
ok with the idea millert, ok dms
@
text
@d1 1
a1 1
/*	$OpenBSD: tty_subs.c,v 1.13 2009/06/01 13:02:46 ray Exp $	*/
a39 1
#include <sys/param.h>
@


1.13
log
@Simplify newline stripping after fgets.

OK millert
@
text
@d1 1
a1 1
/*	$OpenBSD: tty_subs.c,v 1.12 2003/06/02 23:32:09 millert Exp $	*/
a35 8

#ifndef lint
#if 0
static const char sccsid[] = "@@(#)tty_subs.c	8.2 (Berkeley) 4/18/94";
#else
static const char rcsid[] = "$OpenBSD: tty_subs.c,v 1.12 2003/06/02 23:32:09 millert Exp $";
#endif
#endif /* not lint */
@


1.12
log
@Remove the advertising clause in the UCB license which Berkeley
rescinded 22 July 1999.  Proofed by myself and Theo.
@
text
@d1 1
a1 1
/*	$OpenBSD: tty_subs.c,v 1.11 2003/03/04 20:27:58 deraadt Exp $	*/
d41 1
a41 1
static const char rcsid[] = "$OpenBSD: tty_subs.c,v 1.11 2003/03/04 20:27:58 deraadt Exp $";
d126 1
a126 3
	char *pt;

	if ((--len <= 0) || (ttyinf == NULL) || (fgets(str,len,ttyinf) == NULL))
a127 1
	*(str + len) = '\0';
d132 1
a132 2
	if ((pt = strchr(str, '\n')) != NULL)
		*pt = '\0';
@


1.11
log
@do not use angle brackets for error indication; christos
@
text
@d1 1
a1 1
/*	$OpenBSD: tty_subs.c,v 1.10 2002/10/16 19:20:02 millert Exp $	*/
d20 1
a20 5
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by the University of
 *	California, Berkeley and its contributors.
 * 4. Neither the name of the University nor the names of its contributors
d41 1
a41 1
static const char rcsid[] = "$OpenBSD: tty_subs.c,v 1.10 2002/10/16 19:20:02 millert Exp $";
@


1.10
log
@sprinkle const; mostly from NetBSD
@
text
@d1 1
a1 1
/*	$OpenBSD: tty_subs.c,v 1.9 2002/10/16 17:43:10 millert Exp $	*/
d45 1
a45 1
static const char rcsid[] = "$OpenBSD: tty_subs.c,v 1.9 2002/10/16 17:43:10 millert Exp $";
d204 1
a204 1
		(void)fprintf(stderr, " <%s>", strerror(errnum));
@


1.9
log
@kill register
@
text
@d1 1
a1 1
/*	$OpenBSD: tty_subs.c,v 1.8 2002/02/19 19:39:35 millert Exp $	*/
d43 1
a43 1
static char sccsid[] = "@@(#)tty_subs.c	8.2 (Berkeley) 4/18/94";
d45 1
a45 1
static char rcsid[] = "$OpenBSD: tty_subs.c,v 1.8 2002/02/19 19:39:35 millert Exp $";
d105 1
a105 1
tty_prnt(char *fmt, ...)
d151 1
a151 1
paxwarn(int set, char *fmt, ...)
d180 1
a180 1
syswarn(int set, int errnum, char *fmt, ...)
@


1.8
log
@We live in an ANSI C world.  Remove lots of gratuitous #ifdef __STDC__ cruft.
@
text
@d1 1
a1 1
/*	$OpenBSD: tty_subs.c,v 1.7 2001/09/05 22:32:27 deraadt Exp $	*/
d45 1
a45 1
static char rcsid[] = "$OpenBSD: tty_subs.c,v 1.7 2001/09/05 22:32:27 deraadt Exp $";
d130 1
a130 1
	register char *pt;
@


1.7
log
@make sure that va_start() has matching va_end()
@
text
@d1 1
a1 1
/*	$OpenBSD: tty_subs.c,v 1.6 1999/08/09 22:22:52 pjanzen Exp $	*/
d45 1
a45 1
static char rcsid[] = "$OpenBSD: tty_subs.c,v 1.6 1999/08/09 22:22:52 pjanzen Exp $";
a60 1
#ifdef __STDC__
a61 3
#else
#include <varargs.h>
#endif
a76 1
#ifdef __STDC__
a78 4
#else
int
tty_init()
#endif
a103 1
#ifdef __STDC__
a105 6
#else
void
tty_prnt(fmt, va_alist)
	char *fmt;
	va_dcl
#endif
d108 1
a108 1
#	ifdef __STDC__
a109 3
#	else
	va_start(ap);
#	endif
a126 1
#ifdef __STDC__
a128 6
#else
int
tty_read(str, len)
	char *str;
	int len;
#endif
a149 1
#ifdef __STDC__
a151 7
#else
void
paxwarn(set, fmt, va_alist)
	int set;
	char *fmt;
	va_dcl
#endif
d154 1
a154 1
#	ifdef __STDC__
a155 3
#	else
	va_start(ap);
#	endif
a178 1
#ifdef __STDC__
a180 8
#else
void
syswarn(set, errnum, fmt, va_alist)
	int set;
	int errnum;
	char *fmt;
	va_dcl
#endif
d183 1
a183 1
#	ifdef __STDC__
a184 3
#	else
	va_start(ap);
#	endif
@


1.6
log
@if verbose, fflush() appropriately before printing warnings to stderr
@
text
@d1 1
a1 1
/*	$OpenBSD: tty_subs.c,v 1.5 1997/07/25 18:58:39 mickey Exp $	*/
d45 1
a45 1
static char rcsid[] = "$OpenBSD: tty_subs.c,v 1.5 1997/07/25 18:58:39 mickey Exp $";
d129 2
a130 1
	if (ttyoutf == NULL)
d132 1
@


1.5
log
@#if __STDC__ --> #ifdef __STDC__
@
text
@d1 1
a1 1
/*	$OpenBSD: tty_subs.c,v 1.4 1997/07/23 19:16:00 kstailey Exp $	*/
d45 1
a45 1
static char rcsid[] = "$OpenBSD: tty_subs.c,v 1.4 1997/07/23 19:16:00 kstailey Exp $";
d77 1
a77 1
 *	try to open the controlling termina (if any) for this process. if the
d198 1
d239 1
@


1.4
log
@tabify
@
text
@d1 1
a1 1
/*	$OpenBSD: tty_subs.c,v 1.3 1996/06/23 14:20:44 deraadt Exp $	*/
d45 1
a45 1
static char rcsid[] = "$OpenBSD: tty_subs.c,v 1.3 1996/06/23 14:20:44 deraadt Exp $";
d61 1
a61 1
#if __STDC__
d81 1
a81 1
#if __STDC__
d113 1
a113 1
#if __STDC__
d124 1
a124 1
#	if __STDC__
d144 1
a144 1
#if __STDC__
d174 1
a174 1
#if __STDC__
d186 1
a186 1
#	if __STDC__
d213 1
a213 1
#if __STDC__
d226 1
a226 1
#	if __STDC__
@


1.3
log
@update rcsid
@
text
@d1 1
a1 1
/*	$OpenBSD: tty_subs.c,v 1.5 1995/03/21 09:07:52 cgd Exp $	*/
d45 1
a45 1
static char rcsid[] = "$OpenBSD: tty_subs.c,v 1.5 1995/03/21 09:07:52 cgd Exp $";
d71 1
a71 1
#define DEVTTY          "/dev/tty"      /* device for interactive i/o */
d91 1
a91 1
        if ((ttyfd = open(DEVTTY, O_RDWR)) >= 0) {
@


1.2
log
@Correct compile warnings
Rename warn() to paxwarn() so <err.h> can be included

Remove #include <ctype.h> when not needed; from FreeBSD
@
text
@d1 1
d45 1
a45 1
static char rcsid[] = "$NetBSD: tty_subs.c,v 1.5 1995/03/21 09:07:52 cgd Exp $";
@


1.1
log
@Initial revision
@
text
@a53 1
#include <ctype.h>
d100 1
a100 1
		warn(1, "Fatal error, cannot open %s", DEVTTY);
d168 1
a168 1
 * warn()
d175 1
a175 1
warn(int set, char *fmt, ...)
d178 1
a178 1
warn(set, fmt, va_alist)
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
