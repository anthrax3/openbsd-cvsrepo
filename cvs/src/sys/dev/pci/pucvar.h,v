head	1.13;
access;
symbols
	OPENBSD_6_2:1.13.0.26
	OPENBSD_6_2_BASE:1.13
	OPENBSD_6_1:1.13.0.24
	OPENBSD_6_1_BASE:1.13
	OPENBSD_6_0:1.13.0.22
	OPENBSD_6_0_BASE:1.13
	OPENBSD_5_9:1.13.0.10
	OPENBSD_5_9_BASE:1.13
	OPENBSD_5_8:1.13.0.18
	OPENBSD_5_8_BASE:1.13
	OPENBSD_5_7:1.13.0.16
	OPENBSD_5_7_BASE:1.13
	OPENBSD_5_6:1.13.0.14
	OPENBSD_5_6_BASE:1.13
	OPENBSD_5_5:1.13.0.12
	OPENBSD_5_5_BASE:1.13
	OPENBSD_5_4:1.13.0.8
	OPENBSD_5_4_BASE:1.13
	OPENBSD_5_3:1.13.0.6
	OPENBSD_5_3_BASE:1.13
	OPENBSD_5_2:1.13.0.4
	OPENBSD_5_2_BASE:1.13
	OPENBSD_5_1_BASE:1.13
	OPENBSD_5_1:1.13.0.2
	OPENBSD_5_0:1.10.0.6
	OPENBSD_5_0_BASE:1.10
	OPENBSD_4_9:1.10.0.4
	OPENBSD_4_9_BASE:1.10
	OPENBSD_4_8:1.10.0.2
	OPENBSD_4_8_BASE:1.10
	OPENBSD_4_7:1.7.0.2
	OPENBSD_4_7_BASE:1.7
	OPENBSD_4_6:1.7.0.4
	OPENBSD_4_6_BASE:1.7
	OPENBSD_4_5:1.6.0.6
	OPENBSD_4_5_BASE:1.6
	OPENBSD_4_4:1.6.0.4
	OPENBSD_4_4_BASE:1.6
	OPENBSD_4_3:1.6.0.2
	OPENBSD_4_3_BASE:1.6
	OPENBSD_4_2:1.5.0.6
	OPENBSD_4_2_BASE:1.5
	OPENBSD_4_1:1.5.0.4
	OPENBSD_4_1_BASE:1.5
	OPENBSD_4_0:1.5.0.2
	OPENBSD_4_0_BASE:1.5
	OPENBSD_3_9:1.4.0.18
	OPENBSD_3_9_BASE:1.4
	OPENBSD_3_8:1.4.0.16
	OPENBSD_3_8_BASE:1.4
	OPENBSD_3_7:1.4.0.14
	OPENBSD_3_7_BASE:1.4
	OPENBSD_3_6:1.4.0.12
	OPENBSD_3_6_BASE:1.4
	SMP_SYNC_A:1.4
	SMP_SYNC_B:1.4
	OPENBSD_3_5:1.4.0.10
	OPENBSD_3_5_BASE:1.4
	OPENBSD_3_4:1.4.0.8
	OPENBSD_3_4_BASE:1.4
	UBC_SYNC_A:1.4
	OPENBSD_3_3:1.4.0.6
	OPENBSD_3_3_BASE:1.4
	OPENBSD_3_2:1.4.0.4
	OPENBSD_3_2_BASE:1.4
	OPENBSD_3_1:1.4.0.2
	OPENBSD_3_1_BASE:1.4
	UBC_SYNC_B:1.4
	UBC:1.3.0.6
	UBC_BASE:1.3
	OPENBSD_3_0:1.3.0.4
	OPENBSD_3_0_BASE:1.3
	OPENBSD_2_9_BASE:1.3
	OPENBSD_2_9:1.3.0.2
	OPENBSD_2_8:1.2.0.6
	OPENBSD_2_8_BASE:1.2
	OPENBSD_2_7:1.2.0.4
	OPENBSD_2_7_BASE:1.2
	SMP:1.2.0.2
	SMP_BASE:1.2
	kame_19991208:1.2;
locks; strict;
comment	@ * @;


1.13
date	2011.11.15.22.27.53;	author deraadt;	state Exp;
branches;
next	1.12;

1.12
date	2011.10.25.20.02.21;	author deraadt;	state Exp;
branches;
next	1.11;

1.11
date	2011.10.22.19.06.21;	author camield;	state Exp;
branches;
next	1.10;

1.10
date	2010.07.22.17.16.10;	author pirofti;	state Exp;
branches;
next	1.9;

1.9
date	2010.07.07.21.32.50;	author sthen;	state Exp;
branches;
next	1.8;

1.8
date	2010.07.02.01.07.20;	author pirofti;	state Exp;
branches;
next	1.7;

1.7
date	2009.03.03.16.52.25;	author deraadt;	state Exp;
branches;
next	1.6;

1.6
date	2007.12.04.21.49.35;	author kettenis;	state Exp;
branches;
next	1.5;

1.5
date	2006.07.31.11.06.33;	author mickey;	state Exp;
branches;
next	1.4;

1.4
date	2002.02.17.19.24.38;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	2001.03.15.17.52.20;	author deraadt;	state Exp;
branches
	1.3.6.1;
next	1.2;

1.2
date	99.11.14.01.27.57;	author downsj;	state Exp;
branches
	1.2.2.1;
next	1.1;

1.1
date	99.10.26.13.06.14;	author downsj;	state Exp;
branches;
next	;

1.2.2.1
date	2001.05.14.22.25.57;	author niklas;	state Exp;
branches;
next	1.2.2.2;

1.2.2.2
date	2002.03.06.02.11.47;	author niklas;	state Exp;
branches;
next	;

1.3.6.1
date	2002.06.11.03.42.27;	author art;	state Exp;
branches;
next	;


desc
@@


1.13
log
@Simplify various parts of the puc(4) attachment code.  Tested lightly
by krw and myself.
@
text
@/*	$OpenBSD: pucvar.h,v 1.12 2011/10/25 20:02:21 deraadt Exp $	*/
/*	$NetBSD: pucvar.h,v 1.2 1999/02/06 06:29:54 cgd Exp $	*/

/*
 * Copyright (c) 1998, 1999 Christopher G. Demetriou.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *      This product includes software developed by Christopher G. Demetriou
 *	for the NetBSD Project.
 * 4. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * Exported (or conveniently located) PCI "universal" communications card
 * software structures.
 *
 * Author: Christopher G. Demetriou, May 14, 1998.
 */

#define	PUC_MAX_PORTS		16

struct puc_device_description {
	u_int16_t	rval[4];
	u_int16_t	rmask[4];
	struct {
		u_char	type;
		u_char	bar;
		u_short	offset;
	}			ports[PUC_MAX_PORTS];
};

/*
 * For serial ports, the type field also encodes a multiplier
 * of the speed.
 */
#define PUC_LPT			(0x00 | 0x40)
#define PUC_COM_MUL(mul)	(0x80 | 0x40 | (mul))
#define PUC_COM_POW2(pow2)	(0x80 |        (pow2))

#define PUC_IS_LPT(type)	(((type) & 0xc0) == 0x40)
#define PUC_IS_COM(type)	(((type) & 0x80) == 0x80)

#define PUC_IS_COM_MUL(type)	((type) & 0x40)
#define PUC_COM_GET_MUL(type)	((type) & 0x3f)
#define PUC_COM_GET_POW2(type)	((type) & 0x3f)

#define PUC_PORT_BAR_INDEX(bar)	(((bar) - PCI_MAPREG_START) / 4)

struct puc_attach_args {
	int			port;
	int			type;
	void			*puc;

	bus_addr_t		a;
	bus_space_tag_t		t;
	bus_space_handle_t	h;

	const char *(*intr_string)(struct puc_attach_args *);
	void *(*intr_establish)(struct puc_attach_args *, int, int (*)(void *),
	    void *, char *);
};

extern const struct puc_device_description puc_devs[];
extern int puc_ndevs;

#define	PUC_NBARS	6
struct puc_softc {
	struct device		sc_dev;

	/* static configuration data */
	const struct puc_device_description *sc_desc;

	/* card-global dynamic data */
	struct {
		int		mapped;
		bus_addr_t	a;
		bus_size_t	s;
		bus_space_tag_t	t;
		bus_space_handle_t h;
	} sc_bar_mappings[PUC_NBARS];

	/* per-port dynamic data */
	struct {
		struct device   *dev;
		/* filled in by port attachments */
		void	*intrhand;
	} sc_ports[PUC_MAX_PORTS];
};

const struct puc_device_description *
    puc_find_description(u_int16_t, u_int16_t, u_int16_t, u_int16_t);
void	puc_print_ports(const struct puc_device_description *);
void	puc_common_attach(struct puc_softc *, struct puc_attach_args *);
int	puc_print(void *, const char *);
int	puc_submatch(struct device *, void *, void *);
@


1.12
log
@Use a new encoding for the entries in the pucdata table, the result is
that the .o file is half the size.  Tested by camield (who just doubled
the table size recently for a 16-port device).  Hopefully no regressions,
since this is a pretty large change of a very large table.
@
text
@d1 1
a1 1
/*	$OpenBSD: pucvar.h,v 1.11 2011/10/22 19:06:21 camield Exp $	*/
a72 1
	int			hwtype;
a81 1
	void (*intr_disestablish)(struct puc_attach_args *, void *);
@


1.11
log
@Sunix 50xx serial/parallel cards

Bump PUC_MAX_PORTS, the resulting growth of pucdata will be dealt with later.

ok deraadt
@
text
@d1 1
a1 1
/*	$OpenBSD: pucvar.h,v 1.10 2010/07/22 17:16:10 pirofti Exp $	*/
a49 1
		int	flags;
d53 14
a66 3
#define	PUC_PORT_TYPE_NONE	0
#define	PUC_PORT_TYPE_COM	1
#define	PUC_PORT_TYPE_LPT	2
a67 2
#define	PUC_PORT_VALID(desc, port) \
  ((port) < PUC_MAX_PORTS && (desc)->ports[(port)].type != PUC_PORT_TYPE_NONE)
a69 4
/* Flags for PUC_PORT_TYPE_COM */
/* * assume all clock rates have 8 lower bits to 0 - this leaves us 8 flags */
#define PUC_COM_CLOCKMASK 0xffffff00

a78 1
	int			flags;
d87 1
@


1.10
log
@Clean the macros from puc(4). Now with correct logic.

Tested and okay sthen@@.
@
text
@d1 1
a1 1
/*	$OpenBSD: pucvar.h,v 1.9 2010/07/07 21:32:50 sthen Exp $	*/
d41 1
a41 1
#define	PUC_MAX_PORTS		8
@


1.9
log
@revert last commit, it made my puc(4) disappear. ok pirofti@@
@
text
@d1 1
a1 1
/*	$OpenBSD: pucvar.h,v 1.7 2009/03/03 16:52:25 deraadt Exp $	*/
a53 5
#define	PUC_REG_VEND		0
#define	PUC_REG_PROD		1
#define	PUC_REG_SVEND		2
#define	PUC_REG_SPROD		3

d83 1
a83 1
extern const struct puc_device_description puc_devices[];
@


1.8
log
@Abstraction clean-up. `I like it' deraadt@@.
@
text
@d54 5
d88 1
a88 1
extern const struct puc_device_description puc_devs[];
@


1.7
log
@shorten sizes of variables to the required number of bits, and remove
unused variables, tested by todd
ok kettenis
@
text
@d1 1
a1 1
/*	$OpenBSD: pucvar.h,v 1.6 2007/12/04 21:49:35 kettenis Exp $	*/
a53 5
#define	PUC_REG_VEND		0
#define	PUC_REG_PROD		1
#define	PUC_REG_SVEND		2
#define	PUC_REG_SPROD		3

d83 1
a83 1
extern const struct puc_device_description puc_devices[];
@


1.6
log
@Make puc(4) detachable.

Tested by millert@@
@
text
@d1 1
a1 1
/*	$OpenBSD: pucvar.h,v 1.5 2006/07/31 11:06:33 mickey Exp $	*/
d44 2
a45 2
	u_long	rval[4];
	u_long	rmask[4];
a99 1
		u_long		type;
d115 1
a115 1
    puc_find_description(u_long, u_long, u_long, u_long);
@


1.5
log
@puc@@cardbus (only added (commented out) to whom has puc@@pci enabled)
tested on puc@@pci by fkr and meself on the cardbus.
still needs a bit more work but generally works.
deraadt@@ ok and some input from miod@@
@
text
@d1 1
a1 1
/*	$OpenBSD: pucvar.h,v 1.4 2002/02/17 19:24:38 deraadt Exp $	*/
d85 1
d111 1
a111 2
		int	(*ihand)(void *);
		void	*ihandarg;
@


1.4
log
@permit > 8 bit offsets
@
text
@d1 1
a1 1
/*	$OpenBSD: pucvar.h,v 1.3 2001/03/15 17:52:20 deraadt Exp $	*/
d44 2
a45 2
	pcireg_t		rval[4];
	pcireg_t		rmask[4];
d74 2
a75 3

	pci_chipset_tag_t	pc;
	pci_intr_handle_t	intrhandle;
d81 4
d88 33
@


1.3
log
@support puc devices with higher speeds (not tested yet)
@
text
@d1 1
a1 1
/*	$OpenBSD: pucvar.h,v 1.2 1999/11/14 01:27:57 downsj Exp $	*/
d47 1
a47 1
		u_short	type;
d49 1
a49 1
		u_char	offset;
@


1.3.6.1
log
@Sync UBC branch to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: pucvar.h,v 1.3 2001/03/15 17:52:20 deraadt Exp $	*/
d47 1
a47 1
		u_char	type;
d49 1
a49 1
		u_short	offset;
@


1.2
log
@Kill the overly verbose description strings, add another device.
@
text
@d1 1
a1 1
/*	$OpenBSD: pucvar.h,v 1.1 1999/10/26 13:06:14 downsj Exp $	*/
d47 4
a50 3
		int	type;
		int	bar;
		int	offset;
d67 4
d81 1
@


1.2.2.1
log
@merge in approximately 2.9 into SMP branch
@
text
@d1 1
a1 1
/*	$OpenBSD: pucvar.h,v 1.3 2001/03/15 17:52:20 deraadt Exp $	*/
d47 3
a49 4
		u_short	type;
		u_char	bar;
		u_char	offset;
		int	flags;
a65 4
/* Flags for PUC_PORT_TYPE_COM */
/* * assume all clock rates have 8 lower bits to 0 - this leaves us 8 flags */
#define PUC_COM_CLOCKMASK 0xffffff00

a75 1
	int			flags;
@


1.2.2.2
log
@Merge in trunk
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d47 1
a47 1
		u_char	type;
d49 1
a49 1
		u_short	offset;
@


1.1
log
@PCI "universal" communication device driver, by cgd@@netbsd.org.
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
a43 1
	const char		*name;
@

