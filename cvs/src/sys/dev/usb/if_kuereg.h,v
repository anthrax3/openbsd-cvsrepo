head	1.11;
access;
symbols
	OPENBSD_6_1:1.11.0.12
	OPENBSD_6_1_BASE:1.11
	OPENBSD_6_0:1.11.0.14
	OPENBSD_6_0_BASE:1.11
	OPENBSD_5_9:1.11.0.8
	OPENBSD_5_9_BASE:1.11
	OPENBSD_5_8:1.11.0.10
	OPENBSD_5_8_BASE:1.11
	OPENBSD_5_7:1.11.0.2
	OPENBSD_5_7_BASE:1.11
	OPENBSD_5_6:1.11.0.6
	OPENBSD_5_6_BASE:1.11
	OPENBSD_5_5:1.11.0.4
	OPENBSD_5_5_BASE:1.11
	OPENBSD_5_4:1.10.0.2
	OPENBSD_5_4_BASE:1.10
	OPENBSD_5_3:1.9.0.24
	OPENBSD_5_3_BASE:1.9
	OPENBSD_5_2:1.9.0.22
	OPENBSD_5_2_BASE:1.9
	OPENBSD_5_1_BASE:1.9
	OPENBSD_5_1:1.9.0.20
	OPENBSD_5_0:1.9.0.18
	OPENBSD_5_0_BASE:1.9
	OPENBSD_4_9:1.9.0.16
	OPENBSD_4_9_BASE:1.9
	OPENBSD_4_8:1.9.0.14
	OPENBSD_4_8_BASE:1.9
	OPENBSD_4_7:1.9.0.10
	OPENBSD_4_7_BASE:1.9
	OPENBSD_4_6:1.9.0.12
	OPENBSD_4_6_BASE:1.9
	OPENBSD_4_5:1.9.0.8
	OPENBSD_4_5_BASE:1.9
	OPENBSD_4_4:1.9.0.6
	OPENBSD_4_4_BASE:1.9
	OPENBSD_4_3:1.9.0.4
	OPENBSD_4_3_BASE:1.9
	OPENBSD_4_2:1.9.0.2
	OPENBSD_4_2_BASE:1.9
	OPENBSD_4_1:1.6.0.2
	OPENBSD_4_1_BASE:1.6
	OPENBSD_4_0:1.6.0.4
	OPENBSD_4_0_BASE:1.6
	OPENBSD_3_9:1.5.0.8
	OPENBSD_3_9_BASE:1.5
	OPENBSD_3_8:1.5.0.6
	OPENBSD_3_8_BASE:1.5
	OPENBSD_3_7:1.5.0.2
	OPENBSD_3_7_BASE:1.5
	OPENBSD_3_6:1.5.0.4
	OPENBSD_3_6_BASE:1.5
	SMP_SYNC_A:1.5
	SMP_SYNC_B:1.5
	OPENBSD_3_5:1.4.0.12
	OPENBSD_3_5_BASE:1.4
	OPENBSD_3_4:1.4.0.10
	OPENBSD_3_4_BASE:1.4
	UBC_SYNC_A:1.4
	OPENBSD_3_3:1.4.0.8
	OPENBSD_3_3_BASE:1.4
	OPENBSD_3_2:1.4.0.6
	OPENBSD_3_2_BASE:1.4
	OPENBSD_3_1:1.4.0.4
	OPENBSD_3_1_BASE:1.4
	UBC_SYNC_B:1.4
	UBC:1.4.0.2
	UBC_BASE:1.4
	OPENBSD_3_0:1.3.0.4
	OPENBSD_3_0_BASE:1.3
	SMP:1.3.0.2
	OPENBSD_2_9_BASE:1.2
	OPENBSD_2_9:1.2.0.6
	OPENBSD_2_8:1.2.0.4
	OPENBSD_2_8_BASE:1.2
	OPENBSD_2_7:1.2.0.2
	OPENBSD_2_7_BASE:1.2;
locks; strict;
comment	@ * @;


1.11
date	2013.11.11.12.38.39;	author pirofti;	state Exp;
branches;
next	1.10;

1.10
date	2013.04.15.09.23.01;	author mglocker;	state Exp;
branches;
next	1.9;

1.9
date	2007.06.26.06.33.17;	author jsg;	state Exp;
branches;
next	1.8;

1.8
date	2007.06.06.19.25.49;	author mk;	state Exp;
branches;
next	1.7;

1.7
date	2007.06.04.10.34.04;	author mbalmer;	state Exp;
branches;
next	1.6;

1.6
date	2006.03.07.04.41.19;	author krw;	state Exp;
branches;
next	1.5;

1.5
date	2004.05.19.11.37.00;	author brad;	state Exp;
branches;
next	1.4;

1.4
date	2001.10.31.04.24.44;	author nate;	state Exp;
branches;
next	1.3;

1.3
date	2001.05.03.02.20.32;	author aaron;	state Exp;
branches
	1.3.2.1;
next	1.2;

1.2
date	2000.03.28.19.37.48;	author aaron;	state Exp;
branches;
next	1.1;

1.1
date	2000.03.26.18.49.44;	author aaron;	state Exp;
branches;
next	;

1.3.2.1
date	2001.05.14.22.26.19;	author niklas;	state Exp;
branches;
next	1.3.2.2;

1.3.2.2
date	2001.07.04.10.43.44;	author niklas;	state Exp;
branches;
next	1.3.2.3;

1.3.2.3
date	2001.11.13.21.10.04;	author niklas;	state Exp;
branches;
next	1.3.2.4;

1.3.2.4
date	2004.06.05.23.12.58;	author niklas;	state Exp;
branches;
next	;


desc
@@


1.11
log
@Replace sc_dying in favour of usbd_is_dying() and usbd_deactivate().

Okay mpi@@
@
text
@/*	$OpenBSD: if_kuereg.h,v 1.10 2013/04/15 09:23:01 mglocker Exp $ */
/*	$NetBSD: if_kuereg.h,v 1.11 2001/01/21 02:35:31 augustss Exp $	*/
/*
 * Copyright (c) 1997, 1998, 1999, 2000
 *	Bill Paul <wpaul@@ee.columbia.edu>.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by Bill Paul.
 * 4. Neither the name of the author nor the names of any co-contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY Bill Paul AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL Bill Paul OR THE VOICES IN HIS HEAD
 * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 * THE POSSIBILITY OF SUCH DAMAGE.
 *
 * $FreeBSD: src/sys/dev/usb/if_kuereg.h,v 1.2 2000/01/06 07:39:07 wpaul Exp $
 */

/*
 * Definitions for the KLSI KL5KUSB101B USB to ethernet controller.
 * The KLSI part is controlled via vendor control requests, the structure
 * of which depend a bit on the firmware running on the internal
 * microcontroller. The one exception is the 'send scan data' command,
 * which is used to load the firmware.
 */

#define KUE_CONFIG_NO		1
#define KUE_IFACE_IDX		0

#define KUE_CMD_GET_ETHER_DESCRIPTOR		0x00
#define KUE_CMD_SET_MCAST_FILTERS		0x01
#define KUE_CMD_SET_PKT_FILTER			0x02
#define KUE_CMD_GET_ETHERSTATS			0x03
#define KUE_CMD_GET_GPIO			0x04
#define KUE_CMD_SET_GPIO			0x05
#define KUE_CMD_SET_MAC				0x06
#define KUE_CMD_GET_MAC				0x07
#define KUE_CMD_SET_URB_SIZE			0x08
#define KUE_CMD_SET_SOFS			0x09
#define KUE_CMD_SET_EVEN_PKTS			0x0A
#define KUE_CMD_SEND_SCAN			0xFF

struct kue_ether_desc {
	u_int8_t		kue_len;
	u_int8_t		kue_rsvd0;
	u_int8_t		kue_rsvd1;
	u_int8_t		kue_macaddr[ETHER_ADDR_LEN];
	u_int8_t		kue_etherstats[4];
	u_int8_t		kue_maxseg[2];
	u_int8_t		kue_mcastfilt[2];
	u_int8_t		kue_rsvd2;
} __packed;

#define KUE_ETHERSTATS(x)	\
	(((x)->kue_desc.kue_etherstats[3] << 24) | \
	 ((x)->kue_desc.kue_etherstats[2] << 16) | \
	 ((x)->kue_desc.kue_etherstats[1] << 8) | \
	  (x)->kue_desc.kue_etherstats[0])
#define KUE_MAXSEG(x)		\
	(((x)->kue_desc.kue_maxseg[1] << 8) | (x)->kue_desc.kue_maxseg[0])
#define KUE_MCFILTCNT(x)	\
	((((x)->kue_desc.kue_mcastfilt[1] << 8) | \
	   (x)->kue_desc.kue_mcastfilt[0]) & 0x7FFF)
#define KUE_MCFILT(x, y)	\
	(char *)&(sc->kue_mcfilters[y * ETHER_ADDR_LEN])

#define KUE_STAT_TX_OK			0x00000001
#define KUE_STAT_RX_OK			0x00000002
#define KUE_STAT_TX_ERR			0x00000004
#define KUE_STAT_RX_ERR			0x00000008
#define KUE_STAT_RX_NOBUF		0x00000010
#define KUE_STAT_TX_UCAST_BYTES		0x00000020
#define KUE_STAT_TX_UCAST_FRAMES	0x00000040
#define KUE_STAT_TX_MCAST_BYTES		0x00000080
#define KUE_STAT_TX_MCAST_FRAMES	0x00000100
#define KUE_STAT_TX_BCAST_BYTES		0x00000200
#define KUE_STAT_TX_BCAST_FRAMES	0x00000400
#define KUE_STAT_RX_UCAST_BYTES		0x00000800
#define KUE_STAT_RX_UCAST_FRAMES	0x00001000
#define KUE_STAT_RX_MCAST_BYTES		0x00002000
#define KUE_STAT_RX_MCAST_FRAMES	0x00004000
#define KUE_STAT_RX_BCAST_BYTES		0x00008000
#define KUE_STAT_RX_BCAST_FRAMES	0x00010000
#define KUE_STAT_RX_CRCERR		0x00020000
#define KUE_STAT_TX_QUEUE_LENGTH	0x00040000
#define KUE_STAT_RX_ALIGNERR		0x00080000
#define KUE_STAT_TX_SINGLECOLL		0x00100000
#define KUE_STAT_TX_MULTICOLL		0x00200000
#define KUE_STAT_TX_DEFERRED		0x00400000
#define KUE_STAT_TX_MAXCOLLS		0x00800000
#define KUE_STAT_RX_OVERRUN		0x01000000
#define KUE_STAT_TX_UNDERRUN		0x02000000
#define KUE_STAT_TX_SQE_ERR		0x04000000
#define KUE_STAT_TX_CARRLOSS		0x08000000
#define KUE_STAT_RX_LATECOLL		0x10000000

#define KUE_RXFILT_PROMISC		0x0001
#define KUE_RXFILT_ALLMULTI		0x0002
#define KUE_RXFILT_UNICAST		0x0004
#define KUE_RXFILT_BROADCAST		0x0008
#define KUE_RXFILT_MULTICAST		0x0010

#define KUE_TIMEOUT		1000
#define KUE_BUFSZ		1536
#define KUE_MIN_FRAMELEN	60

#define KUE_RX_LIST_CNT		1
#define KUE_TX_LIST_CNT		1

#define KUE_CTL_READ		0x01
#define KUE_CTL_WRITE		0x02

#define KUE_WARM_REV		0x0202

/*
 * The interrupt endpoint is currently unused
 * by the KLSI part.
 */
#define KUE_ENDPT_RX		0x0
#define KUE_ENDPT_TX		0x1
#define KUE_ENDPT_INTR		0x2
#define KUE_ENDPT_MAX		0x3

struct kue_type {
	u_int16_t		kue_vid;
	u_int16_t		kue_did;
};

struct kue_softc;

struct kue_chain {
	struct kue_softc	*kue_sc;
	struct usbd_xfer	*kue_xfer;
	char			*kue_buf;
	struct mbuf		*kue_mbuf;
	int			kue_idx;
};

struct kue_cdata {
	struct kue_chain	kue_tx_chain[KUE_TX_LIST_CNT];
	struct kue_chain	kue_rx_chain[KUE_RX_LIST_CNT];
	int			kue_tx_prod;
	int			kue_tx_cons;
	int			kue_tx_cnt;
	int			kue_rx_prod;
};

struct kue_softc {
	struct device		kue_dev;

	struct arpcom		arpcom;
#define GET_IFP(sc) (&(sc)->arpcom.ac_if)

	struct usbd_device	*kue_udev;
	struct usbd_interface	*kue_iface;
	u_int16_t		kue_vendor;
	u_int16_t		kue_product;
	struct kue_ether_desc	kue_desc;
	int			kue_ed[KUE_ENDPT_MAX];
	struct usbd_pipe	*kue_ep[KUE_ENDPT_MAX];
	int			kue_if_flags;
	u_int16_t		kue_rxfilt;
	u_int8_t		*kue_mcfilters;
	struct kue_cdata	kue_cdata;

	char			kue_attached;
	u_int			kue_rx_errs;
	struct timeval		kue_rx_notice;
};
@


1.10
log
@Get rid of various 'typedef struct' definitions and use plain structure
definitions instead.  We don't change usb.h for now to stay compatible
with userland.

Tested by mpi@@ on macppc and myself on i386.

ok mpi@@
@
text
@d1 1
a1 1
/*	$OpenBSD: if_kuereg.h,v 1.9 2007/06/26 06:33:17 jsg Exp $ */
a183 1
	char			kue_dying;
@


1.9
log
@Alignment fixes from mickey.
@
text
@d1 1
a1 1
/*	$OpenBSD: if_kuereg.h,v 1.8 2007/06/06 19:25:49 mk Exp $ */
d151 1
a151 1
	usbd_xfer_handle	kue_xfer;
d172 2
a173 2
	usbd_device_handle	kue_udev;
	usbd_interface_handle	kue_iface;
d178 1
a178 1
	usbd_pipe_handle	kue_ep[KUE_ENDPT_MAX];
@


1.8
log
@Mechanical removal of USBBASEDEVICE.  No binary change.

Tested by thib and myself.

ok mbalmer jsg
@
text
@d1 1
a1 1
/*	$OpenBSD: if_kuereg.h,v 1.7 2007/06/04 10:34:04 mbalmer Exp $ */
d70 1
a70 1
};
d73 4
a76 1
	(*(u_int32_t *)&(x)->kue_desc.kue_etherstats)
d78 1
a78 1
	(*(u_int16_t *)&(x)->kue_desc.kue_maxseg)
d80 2
a81 1
	((*(u_int16_t *)&(x)->kue_desc.kue_mcastfilt) & 0x7FFF)
@


1.7
log
@Last part of FreeBSD/NetBSD sepcific code removal.

ok jsg@@
@
text
@d1 1
a1 1
/*	$OpenBSD: if_kuereg.h,v 1.6 2006/03/07 04:41:19 krw Exp $ */
d163 1
a163 1
	USBBASEDEVICE		kue_dev;
@


1.6
log
@Remove last NRND NetBSDisms from tree.

ok deraadt@@ brad@@
@
text
@d1 1
a1 1
/*	$OpenBSD: if_kuereg.h,v 1.5 2004/05/19 11:37:00 brad Exp $ */
a164 1
#if defined(__FreeBSD__) || defined(__OpenBSD__)
a166 4
#elif defined(__NetBSD__)
	struct ethercom		kue_ec;
#define GET_IFP(sc) (&(sc)->kue_ec.ec_if)
#endif
@


1.5
log
@remove duplication, use ETHER_ALIGN from if_ether.h
@
text
@d1 1
a1 1
/*	$OpenBSD: if_kuereg.h,v 1.4 2001/10/31 04:24:44 nate Exp $ */
a169 3
#if NRND > 0
	rndsource_element_t	rnd_source;
#endif
@


1.4
log
@Synchronize usb code with NetBSD.
@
text
@d1 1
a1 1
/*	$OpenBSD: if_kuereg.h,v 1.3 2001/05/03 02:20:32 aaron Exp $ */
a117 1
#define ETHER_ALIGN		2
@


1.3
log
@Sync with NetBSD. Tested with a USB keyboard, USB mouse, and three different
kue(4) Ethernet devices.
@
text
@d1 2
a2 2
/*	$OpenBSD: if_kuereg.h,v 1.2 2000/03/28 19:37:48 aaron Exp $ */
/*	$NetBSD: if_kuereg.h,v 1.9 2000/03/24 22:13:24 augustss Exp $	*/
@


1.3.2.1
log
@merge in approximately 2.9 into SMP branch
@
text
@d128 2
@


1.3.2.2
log
@Merge in -current from two days ago in the SMP branch.
As usual with merges, they do not indicate progress, so do not hold
your breath for working SMP, and do not mail me and ask about the
state of it.  It has not changed.  There is work ongoing, but very, very
slowly.  The commit is done in parts as to not lock up the tree in too
big chunks at a time.
@
text
@d1 1
a1 1
/*	$OpenBSD: if_kuereg.h,v 1.3.2.1 2001/05/14 22:26:19 niklas Exp $ */
a126 2

#define KUE_WARM_REV		0x0202
@


1.3.2.3
log
@Merge in -current
@
text
@d1 2
a2 2
/*	$OpenBSD$ */
/*	$NetBSD: if_kuereg.h,v 1.11 2001/01/21 02:35:31 augustss Exp $	*/
@


1.3.2.4
log
@Merge with the trunk
@
text
@d118 1
@


1.2
log
@Much cleaner sync with NetBSD. Some #if defined() magic has been sent in the
form of a diff to augustss@@netbsd.org so that future syncs will be very easy.
This commit also adds support for ADMtek AN986 "Pegasus" based USB Ethernet,
CATC USB-EL1210A based USB Ethernet, and USB Printers (all untested).
@
text
@d1 1
a1 1
/*	$OpenBSD$ */
d127 2
@


1.1
log
@Driver for USB Ethernet adapters based on the Kawasaki LSI KL5KUSB101B.
@
text
@d164 1
d166 9
@

