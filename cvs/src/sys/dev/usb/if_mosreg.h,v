head	1.7;
access;
symbols
	OPENBSD_6_2_BASE:1.7
	OPENBSD_6_1:1.7.0.18
	OPENBSD_6_1_BASE:1.7
	OPENBSD_6_0:1.7.0.16
	OPENBSD_6_0_BASE:1.7
	OPENBSD_5_9:1.7.0.10
	OPENBSD_5_9_BASE:1.7
	OPENBSD_5_8:1.7.0.12
	OPENBSD_5_8_BASE:1.7
	OPENBSD_5_7:1.7.0.4
	OPENBSD_5_7_BASE:1.7
	OPENBSD_5_6:1.7.0.8
	OPENBSD_5_6_BASE:1.7
	OPENBSD_5_5:1.7.0.6
	OPENBSD_5_5_BASE:1.7
	OPENBSD_5_4:1.7.0.2
	OPENBSD_5_4_BASE:1.7
	OPENBSD_5_3:1.6.0.2
	OPENBSD_5_3_BASE:1.6
	OPENBSD_5_2:1.5.0.2
	OPENBSD_5_2_BASE:1.5
	OPENBSD_5_1_BASE:1.4
	OPENBSD_5_1:1.4.0.6
	OPENBSD_5_0:1.4.0.4
	OPENBSD_5_0_BASE:1.4
	OPENBSD_4_9:1.4.0.2
	OPENBSD_4_9_BASE:1.4
	OPENBSD_4_8:1.3.0.8
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.3.0.4
	OPENBSD_4_7_BASE:1.3
	OPENBSD_4_6:1.3.0.6
	OPENBSD_4_6_BASE:1.3
	OPENBSD_4_5:1.3.0.2
	OPENBSD_4_5_BASE:1.3;
locks; strict;
comment	@ * @;


1.7
date	2013.04.15.09.23.01;	author mglocker;	state Exp;
branches;
next	1.6;

1.6
date	2012.10.22.03.23.19;	author brad;	state Exp;
branches;
next	1.5;

1.5
date	2012.02.28.08.58.30;	author jsg;	state Exp;
branches;
next	1.4;

1.4
date	2010.12.06.04.41.39;	author jakemsr;	state Exp;
branches;
next	1.3;

1.3
date	2008.11.22.09.46.12;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	2008.11.02.23.50.48;	author jsg;	state Exp;
branches;
next	1.1;

1.1
date	2008.10.23.17.21.22;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.7
log
@Get rid of various 'typedef struct' definitions and use plain structure
definitions instead.  We don't change usb.h for now to stay compatible
with userland.

Tested by mpi@@ on macppc and myself on i386.

ok mpi@@
@
text
@/*	$OpenBSD: if_mosreg.h,v 1.6 2012/10/22 03:23:19 brad Exp $	*/

/*
 * Copyright (c) 2008 Johann Christian Rode <jcrode@@gmx.net>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

/*
 * Copyright (c) 1997, 1998, 1999, 2000-2003
 *	Bill Paul <wpaul@@windriver.com>.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by Ravikanth.
 * 4. Neither the name of the author nor the names of any co-contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY Bill Paul AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL Bill Paul, THE VOICES IN HIS HEAD OR
 * THE CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
 * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 */

/*
 * Register definitions for the Moschip MCS7x30 ethernet controller.
 */
#define MOS_MCAST_TABLE 	0x00
#define MOS_IPG0		0x08
#define MOS_IPG1		0x09
#define MOS_PHY_DATA0		0x0a
#define MOS_PHY_DATA1		0x0b
#define MOS_PHY_CTL		0x0c
#define MOS_PHY_STS		0x0d
#define MOS_PHY_DATA		MOS_PHY_DATA0
#define MOS_CTL			0x0e
#define MOS_MAC0		0x0f
#define MOS_MAC1		0x10
#define MOS_MAC2		0x11
#define MOS_MAC3		0x12
#define MOS_MAC4		0x13
#define MOS_MAC5		0x14
#define MOS_MAC			MOS_MAC0
/* apparently only available on hardware rev. C */
#define MOS_FRAME_DROP_CNT	0x15
#define MOS_PAUSE_TRHD		0x16

#define MOS_PHYCTL_PHYADDR	0x1f
#define MOS_PHYCTL_WRITE	0x20
#define MOS_PHYCTL_READ		0x40

#define MOS_PHYSTS_PHYREG	0x1f
#define MOS_PHYSTS_READY	0x40
#define MOS_PHYSTS_PENDING	0x80

#define MOS_CTL_RX_PROMISC	0x01
#define MOS_CTL_ALLMULTI	0x02
#define MOS_CTL_SLEEP		0x04
#define MOS_CTL_TX_ENB		0x08
/* 
 * The documentation calls this bit 'reserved', but in the FreeBSD driver 
 * provided by the vendor, this enables the receiver.
 */
#define MOS_CTL_RX_ENB		0x10
#define MOS_CTL_FDX_ENB		0x20
/* 0 = 10 Mbps, 1 = 100 Mbps */
#define MOS_CTL_SPEEDSEL	0x40
/* 0 = PHY controls speed/duplex mode, 1 = bridge controls speed/duplex mode */
#define MOS_CTL_BS_ENB		0x80

#define MOS_RXSTS_SHORT_FRAME	0x01
#define MOS_RXSTS_LENGTH_ERROR	0x02
#define MOS_RXSTS_ALIGN_ERROR	0x04
#define MOS_RXSTS_CRC_ERROR	0x08
#define MOS_RXSTS_LARGE_FRAME	0x10
#define MOS_RXSTS_VALID		0x20
/*
 * The EtherType field of an Ethernet frame can contain values other than
 * the frame length, hence length errors are ignored.
 */
#define MOS_RXSTS_MASK		0x3d

#define MOS_PAUSE_TRHD_DEFAULT	0
#define MOS_PAUSE_REWRITES	3

#define MOS_TIMEOUT		1000

#define MOS_RX_LIST_CNT		1
#define MOS_TX_LIST_CNT		1

/* Maximum size of a fast ethernet frame plus one byte for the status */
#define MOS_BUFSZ	 	(ETHER_MAX_LEN+1)

/*
 * USB endpoints.
 */
#define MOS_ENDPT_RX		0
#define MOS_ENDPT_TX		1
#define MOS_ENDPT_INTR		2
#define MOS_ENDPT_MAX		3

/*
 * USB vendor requests.
 */
#define MOS_UR_READREG		0x0e
#define MOS_UR_WRITEREG		0x0d

#define MOS_CONFIG_NO		1
#define MOS_IFACE_IDX		0

struct mos_type {
	struct usb_devno	mos_dev;
	u_int16_t		mos_flags;
#define MCS7730	0x0001		/* MCS7730 */
#define MCS7830	0x0002		/* MCS7830 */
#define MCS7832	0x0004		/* MCS7832 */
};

#define MOS_INC(x, y)           (x) = (x + 1) % y

struct mos_softc;

struct mos_chain {
	struct mos_softc	*mos_sc;
	struct usbd_xfer	*mos_xfer;
	char			*mos_buf;
	struct mbuf		*mos_mbuf;
	int			mos_accum;
	int			mos_idx;
};

struct mos_cdata {
	struct mos_chain	mos_tx_chain[MOS_TX_LIST_CNT];
	struct mos_chain	mos_rx_chain[MOS_RX_LIST_CNT];
	int			mos_tx_prod;
	int			mos_tx_cons;
	int			mos_tx_cnt;
	int			mos_rx_prod;
};

struct mos_softc {
	struct device		mos_dev;
#define GET_MII(sc) (&(sc)->mos_mii)
	struct arpcom		arpcom;
#define GET_IFP(sc) (&(sc)->arpcom.ac_if)
	struct mii_data		mos_mii;
	struct usbd_device	*mos_udev;
	struct usbd_interface	*mos_iface;

	u_int16_t		mos_flags;

	int			mos_ed[MOS_ENDPT_MAX];
	struct usbd_pipe	*mos_ep[MOS_ENDPT_MAX];
	int			mos_unit;
	struct mos_cdata	mos_cdata;
	struct timeout		mos_stat_ch;

	int			mos_refcnt;

	int			mos_link;
	unsigned char		mos_ipgs[2];
	unsigned char 		mos_phyaddrs[2];
	struct timeval		mos_rx_notice;

	u_int16_t		mos_tspeed;
	u_int16_t		mos_maxpacket;

	struct ifmedia		mos_ifmedia;

	struct usb_task		mos_tick_task;
	struct usb_task		mos_stop_task;

	struct rwlock		mos_mii_lock;

	u_int			mos_bufsz;
};

@


1.6
log
@Rewrite the receive filter handling code and cleanup the ioctl bits.

Tested by and ok stsp@@
@
text
@d1 1
a1 1
/*	$OpenBSD: if_mosreg.h,v 1.5 2012/02/28 08:58:30 jsg Exp $	*/
d152 1
a152 1
	usbd_xfer_handle	mos_xfer;
d174 2
a175 2
	usbd_device_handle	mos_udev;
	usbd_interface_handle	mos_iface;
d180 1
a180 1
	usbd_pipe_handle	mos_ep[MOS_ENDPT_MAX];
@


1.5
log
@add support for the MCS7832 which is apparently a low pin count
version of the MCS7830 with no software visible changes besides
a new product id.

from brad
@
text
@d1 1
a1 1
/*	$OpenBSD: if_mosreg.h,v 1.4 2010/12/06 04:41:39 jakemsr Exp $	*/
a181 1
	int			mos_if_flags;
@


1.4
log
@* replace per-driver dying and/or other state variables with use of
  usbd_deactivete() and usbd_is_dying()
* use usbd_deactivate() in activate()/DEACTIVATE
* convert a few more direct checks of the associated bus' dying flag
  with usbd_is_dying()
@
text
@d1 1
a1 1
/*	$OpenBSD: if_mosreg.h,v 1.3 2008/11/22 09:46:12 deraadt Exp $	*/
d143 1
@


1.3
log
@some cosmetics and changes based on reading newer docs, from the original
author Johann Christian Rode
@
text
@d1 1
a1 1
/*	$OpenBSD: if_mosreg.h,v 1.2 2008/11/02 23:50:48 jsg Exp $	*/
a185 2
	char			mos_dying;
	char			mos_attached;
@


1.2
log
@rcs tags
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d72 1
d98 12
d118 2
a119 2
#define MOS_MIN_BUFSZ		2048
#define MOS_MAX_BUFSZ		16384
@


1.1
log
@Driver for MOSCHIP MCS7x30 usb ethernet chips by Johann Christian Rode
@
text
@d1 2
@

