head	1.18;
access;
symbols
	OPENBSD_5_4:1.17.0.12
	OPENBSD_5_4_BASE:1.17
	OPENBSD_5_3:1.17.0.10
	OPENBSD_5_3_BASE:1.17
	OPENBSD_5_2:1.17.0.8
	OPENBSD_5_2_BASE:1.17
	OPENBSD_5_1_BASE:1.17
	OPENBSD_5_1:1.17.0.6
	OPENBSD_5_0:1.17.0.4
	OPENBSD_5_0_BASE:1.17
	OPENBSD_4_9:1.17.0.2
	OPENBSD_4_9_BASE:1.17
	OPENBSD_4_8:1.16.0.4
	OPENBSD_4_8_BASE:1.16
	OPENBSD_4_7:1.16.0.2
	OPENBSD_4_7_BASE:1.16
	OPENBSD_4_6:1.15.0.6
	OPENBSD_4_6_BASE:1.15
	OPENBSD_4_5:1.15.0.2
	OPENBSD_4_5_BASE:1.15
	OPENBSD_4_4:1.14.0.4
	OPENBSD_4_4_BASE:1.14
	OPENBSD_4_3:1.14.0.2
	OPENBSD_4_3_BASE:1.14
	OPENBSD_4_2:1.13.0.2
	OPENBSD_4_2_BASE:1.13
	OPENBSD_4_1:1.12.0.20
	OPENBSD_4_1_BASE:1.12
	OPENBSD_4_0:1.12.0.18
	OPENBSD_4_0_BASE:1.12
	OPENBSD_3_9:1.12.0.16
	OPENBSD_3_9_BASE:1.12
	OPENBSD_3_8:1.12.0.14
	OPENBSD_3_8_BASE:1.12
	OPENBSD_3_7:1.12.0.12
	OPENBSD_3_7_BASE:1.12
	OPENBSD_3_6:1.12.0.10
	OPENBSD_3_6_BASE:1.12
	SMP_SYNC_A:1.12
	SMP_SYNC_B:1.12
	OPENBSD_3_5:1.12.0.8
	OPENBSD_3_5_BASE:1.12
	OPENBSD_3_4:1.12.0.6
	OPENBSD_3_4_BASE:1.12
	UBC_SYNC_A:1.12
	OPENBSD_3_3:1.12.0.4
	OPENBSD_3_3_BASE:1.12
	OPENBSD_3_2:1.12.0.2
	OPENBSD_3_2_BASE:1.12
	OPENBSD_3_1:1.10.0.2
	OPENBSD_3_1_BASE:1.10
	UBC_SYNC_B:1.12
	UBC:1.9.0.2
	UBC_BASE:1.9
	OPENBSD_3_0:1.8.0.2
	OPENBSD_3_0_BASE:1.8
	OPENBSD_2_9_BASE:1.6
	OPENBSD_2_9:1.6.0.8
	OPENBSD_2_8:1.6.0.6
	OPENBSD_2_8_BASE:1.6
	OPENBSD_2_7:1.6.0.4
	OPENBSD_2_7_BASE:1.6
	SMP:1.6.0.2
	SMP_BASE:1.6
	kame_19991208:1.6
	OPENBSD_2_6:1.3.0.8
	OPENBSD_2_6_BASE:1.3
	OPENBSD_2_5:1.3.0.6
	OPENBSD_2_5_BASE:1.3
	OPENBSD_2_4:1.3.0.4
	OPENBSD_2_4_BASE:1.3
	OPENBSD_2_3:1.3.0.2
	OPENBSD_2_3_BASE:1.3
	OPENBSD_2_2:1.2.0.4
	OPENBSD_2_2_BASE:1.2
	OPENBSD_2_1:1.2.0.2
	OPENBSD_2_1_BASE:1.2
	OPENBSD_2_0:1.1.0.2
	OPENBSD_2_0_BASE:1.1;
locks; strict;
comment	@ * @;


1.18
date	2013.10.28.12.33.32;	author mpi;	state dead;
branches;
next	1.17;

1.17
date	2010.09.20.07.40.42;	author deraadt;	state Exp;
branches;
next	1.16;

1.16
date	2009.08.13.14.24.47;	author jasper;	state Exp;
branches;
next	1.15;

1.15
date	2008.08.09.16.42.30;	author miod;	state Exp;
branches;
next	1.14;

1.14
date	2007.11.06.18.20.07;	author miod;	state Exp;
branches;
next	1.13;

1.13
date	2007.04.12.17.05.20;	author miod;	state Exp;
branches;
next	1.12;

1.12
date	2002.06.09.21.25.40;	author art;	state Exp;
branches;
next	1.11;

1.11
date	2002.06.02.22.50.00;	author deraadt;	state Exp;
branches;
next	1.10;

1.10
date	2002.03.14.01.27.03;	author millert;	state Exp;
branches;
next	1.9;

1.9
date	2001.11.06.19.53.20;	author miod;	state Exp;
branches
	1.9.2.1;
next	1.8;

1.8
date	2001.09.11.20.05.25;	author miod;	state Exp;
branches;
next	1.7;

1.7
date	2001.08.12.20.33.50;	author mickey;	state Exp;
branches;
next	1.6;

1.6
date	99.12.03.16.01.59;	author jason;	state Exp;
branches
	1.6.2.1;
next	1.5;

1.5
date	99.11.30.04.00.44;	author jason;	state Exp;
branches;
next	1.4;

1.4
date	99.11.23.04.49.30;	author jason;	state Exp;
branches;
next	1.3;

1.3
date	97.11.07.08.07.46;	author niklas;	state Exp;
branches;
next	1.2;

1.2
date	96.12.08.01.03.04;	author niklas;	state Exp;
branches;
next	1.1;

1.1
date	96.05.26.00.27.53;	author deraadt;	state Exp;
branches;
next	;

1.6.2.1
date	2001.10.31.03.22.49;	author nate;	state Exp;
branches;
next	1.6.2.2;

1.6.2.2
date	2001.11.13.21.10.04;	author niklas;	state Exp;
branches;
next	1.6.2.3;

1.6.2.3
date	2002.03.28.15.09.09;	author niklas;	state Exp;
branches;
next	1.6.2.4;

1.6.2.4
date	2003.03.28.00.38.30;	author niklas;	state Exp;
branches;
next	;

1.9.2.1
date	2002.06.11.03.42.29;	author art;	state Exp;
branches;
next	1.9.2.2;

1.9.2.2
date	2002.10.29.00.33.31;	author art;	state Exp;
branches;
next	;


desc
@@


1.18
log
@tedu FDDI support and the 3 flavors the driver for DEC devices, even
miod@@ cannot find two boards using the same media.

With precious punctuation review from guenther@@, thanks!

ok deraadt@@, henning@@
@
text
@/*	$OpenBSD: if_fta.c,v 1.17 2010/09/20 07:40:42 deraadt Exp $	*/
/*	$NetBSD: if_fta.c,v 1.7 1996/10/22 21:37:26 cgd Exp $	*/

/*-
 * Copyright (c) 1996 Matt Thomas <matt@@3am-software.com>
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Id: if_fta.c,v 1.3 1996/05/17 01:15:18 thomas Exp
 *
 */

/*
 * DEC TurboChannel FDDI Controller; code for BSD derived operating systems
 *
 * Written by Matt Thomas
 *
 *   This module supports the DEC DEFTA TurboChannel FDDI Controller
 */


#include <sys/param.h>
#include <sys/kernel.h>
#include <sys/mbuf.h>
#include <sys/protosw.h>
#include <sys/socket.h>
#include <sys/ioctl.h>
#include <sys/errno.h>
#include <sys/malloc.h>
#include <sys/device.h>

#include <net/if.h>
#include <net/if_types.h>

#ifdef INET
#include <netinet/in.h>
#include <netinet/if_ether.h>
#endif
#include <net/if_fddi.h>

#include <uvm/uvm_extern.h>

#include <dev/tc/tcvar.h>
#include <dev/ic/pdqvar.h>
#include <dev/ic/pdqreg.h>

int	pdq_tc_match(struct device *, void *, void *);
void	pdq_tc_attach(struct device *, struct device *, void *);

int
pdq_tc_match(parent, match, aux)
	struct device *parent;
	void *match;
	void *aux;
{
	struct tc_attach_args *ta = (struct tc_attach_args *) aux;

	if (strncmp("PMAF-F", ta->ta_modname, 6) == 0)
		return (1);
	return (0);
}

void
pdq_tc_attach(parent, self, aux)
	struct device *parent;
	struct device *self;
	void *aux;
{
	pdq_softc_t * const sc = (pdq_softc_t *) self;
	struct tc_attach_args * const ta = (struct tc_attach_args *) aux;

	/*
	 * NOTE: sc_bc is an alias for sc_csrtag and sc_membase is an
	 * alias for sc_csrhandle.  sc_iobase is not used in this front-end.
	 */
	sc->sc_csrtag = ta->ta_memt;
	bcopy(sc->sc_dev.dv_xname, sc->sc_if.if_xname, IFNAMSIZ);
	sc->sc_if.if_flags = 0;
	sc->sc_if.if_softc = sc;

	if (bus_space_map(sc->sc_csrtag, ta->ta_addr + PDQ_TC_CSR_OFFSET,
		    PDQ_TC_CSR_SPACE, 0, &sc->sc_csrhandle)) {
		printf("\n%s: can't map card memory!\n", sc->sc_dev.dv_xname);
		return;
	}

	printf("\n");
	sc->sc_pdq = pdq_initialize(sc->sc_csrtag, sc->sc_csrhandle,
	    sc->sc_if.if_xname, 0, (void *) sc, PDQ_DEFTA);
	if (sc->sc_pdq == NULL) {
		printf("%s: initialization failed\n", sc->sc_dev.dv_xname);
		return;
	}
	bcopy((caddr_t) sc->sc_pdq->pdq_hwaddr.lanaddr_bytes,
	    sc->sc_arpcom.ac_enaddr, 6);
	pdq_ifattach(sc, NULL);

	tc_intr_establish(parent, ta->ta_cookie, IPL_NET,
	    (int (*)(void *)) pdq_interrupt, sc->sc_pdq, self->dv_xname);
}

struct cfattach fta_ca = {
	sizeof(pdq_softc_t), pdq_tc_match, pdq_tc_attach
};

struct cfdriver fta_cd = {
	NULL, "fta", DV_IFNET
};
@


1.17
log
@Stop doing shutdown hooks in network drivers where possible.  We already
take all interfaces down, via their xxstop routines.  Claudio and I have
verified that none of the shutdown hooks do much extra beyond what xxstop
was already doing; it is largely a pile of junk.
ok claudio, some early comments by sthen; also read by matthew, jsg
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.16 2009/08/13 14:24:47 jasper Exp $	*/
@


1.16
log
@- consistify cfdriver for the ethernet drivers (0 -> NULL)

ok dlg@@
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.15 2008/08/09 16:42:30 miod Exp $	*/
a117 6

	sc->sc_ats = shutdownhook_establish((void (*)(void *)) pdq_hwreset,
	    sc->sc_pdq);
	if (sc->sc_ats == NULL)
		printf("%s: warning: couldn't establish shutdown hook\n",
		    self->dv_xname);
@


1.15
log
@Pass a device name to {tc,tcds,ioasic}_intr_establish in order to get
meaningful names associated to the interrupt counters.
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.14 2007/11/06 18:20:07 miod Exp $	*/
d131 1
a131 1
	0, "fta", DV_IFNET
@


1.14
log
@Get rid of TC_IPL_xxx values and tc_intrlevel_t, and use IPL_xxx and int.
No functional change.
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.13 2007/04/12 17:05:20 miod Exp $	*/
d117 1
a117 1
	    (int (*)(void *)) pdq_interrupt, sc->sc_pdq);
@


1.13
log
@Fix newlines in dmesg.
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.12 2002/06/09 21:25:40 art Exp $	*/
d116 1
a116 1
	tc_intr_establish(parent, ta->ta_cookie, TC_IPL_NET,
@


1.12
log
@More sc_arpcom fallout.
Not tested because all alphas in my reach are dead right now.
From Dries Schellekens.
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.11 2002/06/02 22:50:00 deraadt Exp $	*/
d105 1
a113 1
	printf("\n");
@


1.11
log
@withough -> without
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.10 2002/03/14 01:27:03 millert Exp $	*/
d112 1
a112 1
	    sc->sc_ac.ac_enaddr, 6);
@


1.10
log
@First round of __P removal in sys
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.9 2001/11/06 19:53:20 miod Exp $	*/
d14 1
a14 1
 *    derived from this software withough specific prior written permission
@


1.9
log
@Replace inclusion of <vm/foo.h> with the correct <uvm/bar.h> when necessary.
(Look ma, I might have broken the tree)
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.8 2001/09/11 20:05:25 miod Exp $	*/
d65 2
a66 2
int	pdq_tc_match __P((struct device *, void *, void *));
void	pdq_tc_attach __P((struct device *, struct device *, void *));
@


1.9.2.1
log
@Sync UBC branch to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.9 2001/11/06 19:53:20 miod Exp $	*/
d14 1
a14 1
 *    derived from this software without specific prior written permission
d65 2
a66 2
int	pdq_tc_match(struct device *, void *, void *);
void	pdq_tc_attach(struct device *, struct device *, void *);
@


1.9.2.2
log
@sync to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.9.2.1 2002/06/11 03:42:29 art Exp $	*/
d112 1
a112 1
	    sc->sc_arpcom.ac_enaddr, 6);
@


1.8
log
@Don't include <vm/vm_kern.h> if you don't need foo_map.
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.7 2001/08/12 20:33:50 mickey Exp $	*/
d59 1
a59 1
#include <vm/vm.h>
@


1.7
log
@absolutely no need to include vm_parm.h after vm.h
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.6 1999/12/03 16:01:59 jason Exp $	*/
a59 1
#include <vm/vm_kern.h>
@


1.6
log
@make this compile again; millert.
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.5 1999/11/30 04:00:44 jason Exp $	*/
a60 1
#include <vm/vm_param.h>
@


1.6.2.1
log
@Sync the SMP branch to something just after 3.0
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.6 1999/12/03 16:01:59 jason Exp $	*/
d60 2
@


1.6.2.2
log
@Merge in -current
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d59 1
a59 1
#include <uvm/uvm_extern.h>
@


1.6.2.3
log
@Merge in -current from roughly a week ago
@
text
@d65 2
a66 2
int	pdq_tc_match(struct device *, void *, void *);
void	pdq_tc_attach(struct device *, struct device *, void *);
@


1.6.2.4
log
@Sync the SMP branch with 3.3
@
text
@d14 1
a14 1
 *    derived from this software without specific prior written permission
d112 1
a112 1
	    sc->sc_arpcom.ac_enaddr, 6);
@


1.5
log
@more KNF and cleanup
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.4 1999/11/23 04:49:30 jason Exp $	*/
d66 3
@


1.4
log
@pretty up kernel printf's
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.3 1997/11/07 08:07:46 niklas Exp $	*/
d67 5
a71 5
static int
pdq_tc_match(
    struct device *parent,
    void *match,
    void *aux)
d73 1
a73 1
    struct tc_attach_args *ta = (struct tc_attach_args *) aux;
d75 3
a77 4
    if (strncmp("PMAF-F", ta->ta_modname, 6) == 0)
	return 1;

    return 0;
d80 5
a84 5
static void
pdq_tc_attach(
    struct device * const parent,
    struct device * const self,
    void * const aux)
d86 2
a87 2
    pdq_softc_t * const sc = (pdq_softc_t *) self;
    struct tc_attach_args * const ta = (struct tc_attach_args *) aux;
d89 8
a96 8
    /*
     * NOTE: sc_bc is an alias for sc_csrtag and sc_membase is an
     * alias for sc_csrhandle.  sc_iobase is not used in this front-end.
     */
    sc->sc_csrtag = ta->ta_memt;
    bcopy(sc->sc_dev.dv_xname, sc->sc_if.if_xname, IFNAMSIZ);
    sc->sc_if.if_flags = 0;
    sc->sc_if.if_softc = sc;
d98 1
a98 1
    if (bus_space_map(sc->sc_csrtag, ta->ta_addr + PDQ_TC_CSR_OFFSET,
d100 23
a122 21
        printf("\n%s: can't map card memory!\n", sc->sc_dev.dv_xname);
	return;
    }

    sc->sc_pdq = pdq_initialize(sc->sc_csrtag, sc->sc_csrhandle,
				sc->sc_if.if_xname, 0,
				(void *) sc, PDQ_DEFTA);
    if (sc->sc_pdq == NULL) {
	printf("%s: initialization failed\n", sc->sc_dev.dv_xname);
	return;
    }
    bcopy((caddr_t) sc->sc_pdq->pdq_hwaddr.lanaddr_bytes, sc->sc_ac.ac_enaddr, 6);
    printf("\n");
    pdq_ifattach(sc, NULL);

    tc_intr_establish(parent, ta->ta_cookie, TC_IPL_NET,
		      (int (*)(void *)) pdq_interrupt, sc->sc_pdq);

    sc->sc_ats = shutdownhook_establish((void (*)(void *)) pdq_hwreset, sc->sc_pdq);
    if (sc->sc_ats == NULL)
	printf("%s: warning: couldn't establish shutdown hook\n", self->dv_xname);
d125 7
a131 2
struct cfattach fta_ca = { sizeof(pdq_softc_t), pdq_tc_match, pdq_tc_attach };
struct cfdriver fta_cd = { 0, "fta", DV_IFNET };
@


1.3
log
@$OpenBSD$
@
text
@d1 1
a1 1
/*	$OpenBSD: if_fta.c,v 1.7 1996/10/22 21:37:26 cgd Exp $	*/
d113 1
@


1.2
log
@Merge to NetBSD 961107, i.e. mostly new bus.h
@
text
@d1 1
@


1.1
log
@sync 0521
@
text
@d1 1
a1 1
/*	$NetBSD: if_fta.c,v 1.4 1996/05/20 15:53:09 thorpej Exp $	*/
d89 5
a93 1
    sc->sc_bc = ta->ta_bc;
d98 2
a99 2
    if (bus_mem_map(sc->sc_bc, ta->ta_addr + PDQ_TC_CSR_OFFSET,
		    PDQ_TC_CSR_SPACE, 0, &sc->sc_membase)) {
d104 1
a104 1
    sc->sc_pdq = pdq_initialize(sc->sc_bc, sc->sc_membase,
@
