head	1.12;
access;
symbols
	OPENBSD_6_2_BASE:1.12
	OPENBSD_6_1:1.12.0.12
	OPENBSD_6_1_BASE:1.12
	OPENBSD_6_0:1.12.0.8
	OPENBSD_6_0_BASE:1.12
	OPENBSD_5_9:1.12.0.2
	OPENBSD_5_9_BASE:1.12
	OPENBSD_5_8:1.12.0.6
	OPENBSD_5_8_BASE:1.12
	OPENBSD_5_7:1.12.0.4
	OPENBSD_5_7_BASE:1.12
	OPENBSD_5_6:1.11.0.6
	OPENBSD_5_6_BASE:1.11
	OPENBSD_5_5:1.11.0.4
	OPENBSD_5_5_BASE:1.11
	OPENBSD_5_4:1.10.0.20
	OPENBSD_5_4_BASE:1.10
	OPENBSD_5_3:1.10.0.18
	OPENBSD_5_3_BASE:1.10
	OPENBSD_5_2:1.10.0.16
	OPENBSD_5_2_BASE:1.10
	OPENBSD_5_1_BASE:1.10
	OPENBSD_5_1:1.10.0.14
	OPENBSD_5_0:1.10.0.12
	OPENBSD_5_0_BASE:1.10
	OPENBSD_4_9:1.10.0.10
	OPENBSD_4_9_BASE:1.10
	OPENBSD_4_8:1.10.0.8
	OPENBSD_4_8_BASE:1.10
	OPENBSD_4_7:1.10.0.4
	OPENBSD_4_7_BASE:1.10
	OPENBSD_4_6:1.10.0.6
	OPENBSD_4_6_BASE:1.10
	OPENBSD_4_5:1.10.0.2
	OPENBSD_4_5_BASE:1.10
	OPENBSD_4_4:1.9.0.4
	OPENBSD_4_4_BASE:1.9
	OPENBSD_4_3:1.9.0.2
	OPENBSD_4_3_BASE:1.9
	OPENBSD_4_2:1.8.0.2
	OPENBSD_4_2_BASE:1.8
	OPENBSD_4_1:1.7.0.6
	OPENBSD_4_1_BASE:1.7
	OPENBSD_4_0:1.7.0.4
	OPENBSD_4_0_BASE:1.7
	OPENBSD_3_9:1.7.0.2
	OPENBSD_3_9_BASE:1.7
	OPENBSD_3_8:1.6.0.14
	OPENBSD_3_8_BASE:1.6
	OPENBSD_3_7:1.6.0.12
	OPENBSD_3_7_BASE:1.6
	OPENBSD_3_6:1.6.0.10
	OPENBSD_3_6_BASE:1.6
	SMP_SYNC_A:1.6
	SMP_SYNC_B:1.6
	OPENBSD_3_5:1.6.0.8
	OPENBSD_3_5_BASE:1.6
	OPENBSD_3_4:1.6.0.6
	OPENBSD_3_4_BASE:1.6
	UBC_SYNC_A:1.6
	OPENBSD_3_3:1.6.0.4
	OPENBSD_3_3_BASE:1.6
	OPENBSD_3_2:1.6.0.2
	OPENBSD_3_2_BASE:1.6
	OPENBSD_3_1:1.5.0.2
	OPENBSD_3_1_BASE:1.5
	UBC_SYNC_B:1.6
	UBC:1.4.0.18
	UBC_BASE:1.4
	OPENBSD_3_0:1.4.0.16
	OPENBSD_3_0_BASE:1.4
	OPENBSD_2_9_BASE:1.4
	OPENBSD_2_9:1.4.0.14
	OPENBSD_2_8:1.4.0.12
	OPENBSD_2_8_BASE:1.4
	OPENBSD_2_7:1.4.0.10
	OPENBSD_2_7_BASE:1.4
	SMP:1.4.0.8
	SMP_BASE:1.4
	kame_19991208:1.4
	OPENBSD_2_6:1.4.0.6
	OPENBSD_2_6_BASE:1.4
	OPENBSD_2_5:1.4.0.4
	OPENBSD_2_5_BASE:1.4
	OPENBSD_2_4:1.4.0.2
	OPENBSD_2_4_BASE:1.4
	OPENBSD_2_3:1.3.0.2
	OPENBSD_2_3_BASE:1.3
	OPENBSD_2_2:1.2.0.6
	OPENBSD_2_2_BASE:1.2
	OPENBSD_2_1:1.2.0.4
	OPENBSD_2_1_BASE:1.2
	OPENBSD_2_0:1.2.0.2
	OPENBSD_2_0_BASE:1.2;
locks; strict;
comment	@ * @;


1.12
date	2014.12.22.02.28.52;	author tedu;	state Exp;
branches;
next	1.11;
commitid	yM2VFFhpDTeFQlve;

1.11
date	2013.09.24.20.11.05;	author miod;	state Exp;
branches;
next	1.10;

1.10
date	2008.08.09.16.42.30;	author miod;	state Exp;
branches;
next	1.9;

1.9
date	2007.11.06.18.20.07;	author miod;	state Exp;
branches;
next	1.8;

1.8
date	2007.06.17.21.20.47;	author jasper;	state Exp;
branches;
next	1.7;

1.7
date	2005.10.11.06.03.18;	author martin;	state Exp;
branches;
next	1.6;

1.6
date	2002.05.02.22.56.06;	author miod;	state Exp;
branches;
next	1.5;

1.5
date	2002.03.14.01.27.03;	author millert;	state Exp;
branches;
next	1.4;

1.4
date	98.09.16.22.41.22;	author jason;	state Exp;
branches
	1.4.8.1
	1.4.18.1;
next	1.3;

1.3
date	97.11.07.08.07.50;	author niklas;	state Exp;
branches;
next	1.2;

1.2
date	96.05.10.12.41.30;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	96.05.02.13.51.49;	author deraadt;	state Exp;
branches;
next	;

1.4.8.1
date	2002.03.28.15.09.09;	author niklas;	state Exp;
branches;
next	1.4.8.2;

1.4.8.2
date	2003.03.28.00.38.30;	author niklas;	state Exp;
branches;
next	;

1.4.18.1
date	2002.06.11.03.42.29;	author art;	state Exp;
branches;
next	;


desc
@@


1.12
log
@unifdef INET
@
text
@/*	$OpenBSD: if_le_tc.c,v 1.11 2013/09/24 20:11:05 miod Exp $	*/
/*	$NetBSD: if_le_tc.c,v 1.12 2001/11/13 06:26:10 lukem Exp $	*/

/*
 * Copyright (c) 1996 Carnegie-Mellon University.
 * All rights reserved.
 *
 * Author: Chris G. Demetriou
 *
 * Permission to use, copy, modify and distribute this software and
 * its documentation is hereby granted, provided that both the copyright
 * notice and this permission notice appear in all copies of the
 * software, derivative works or modified versions, and any portions
 * thereof, and that both notices appear in supporting documentation.
 *
 * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS "AS IS"
 * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND
 * FOR ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.
 *
 * Carnegie Mellon requests users of this software to return to
 *
 *  Software Distribution Coordinator  or  Software.Distribution@@CS.CMU.EDU
 *  School of Computer Science
 *  Carnegie Mellon University
 *  Pittsburgh PA 15213-3890
 *
 * any improvements or extensions that they make and grant Carnegie the
 * rights to redistribute these changes.
 */

/*
 * LANCE on TurboChannel.
 */

#include <sys/param.h>
#include <sys/systm.h>
#include <sys/mbuf.h>
#include <sys/syslog.h>
#include <sys/socket.h>
#include <sys/device.h>

#include <net/if.h>
#include <net/if_media.h>

#include <netinet/in.h>
#include <netinet/if_ether.h>

#include <dev/ic/lancereg.h>
#include <dev/ic/lancevar.h>
#include <dev/ic/am7990reg.h>
#include <dev/ic/am7990var.h>

#include <dev/tc/if_levar.h>
#include <dev/tc/tcvar.h>

int	le_tc_match(struct device *, void *, void *);
void	le_tc_attach(struct device *, struct device *, void *);

struct cfattach le_tc_ca = {
	sizeof(struct le_softc), le_tc_match, le_tc_attach
};

#define	LE_OFFSET_RAM		0x0
#define	LE_OFFSET_LANCE		0x100000
#define	LE_OFFSET_ROM		0x1c0000

int
le_tc_match(struct device *parent, void *match, void *aux)
{
	struct tc_attach_args *d = aux;

	if (strncmp("PMAD-AA ", d->ta_modname, TC_ROM_LLEN) != 0)
		return (0);

	return (1);
}

void
le_tc_attach(struct device *parent, struct device *self, void *aux)
{
	struct le_softc *lesc = (void *)self;
	struct lance_softc *sc = &lesc->sc_am7990.lsc;
	struct tc_attach_args *d = aux;

	/*
	 * It's on the turbochannel proper, or a kn02
	 * baseboard implementation of a TC option card.
	 */
	lesc->sc_r1 = (struct lereg1 *)
           TC_DENSE_TO_SPARSE(TC_PHYS_TO_UNCACHED(d->ta_addr + LE_OFFSET_LANCE)); 
	sc->sc_mem = (void *)(d->ta_addr + LE_OFFSET_RAM);

	sc->sc_copytodesc = lance_copytobuf_contig;
	sc->sc_copyfromdesc = lance_copyfrombuf_contig;
	sc->sc_copytobuf = lance_copytobuf_contig;
	sc->sc_copyfrombuf = lance_copyfrombuf_contig;
	sc->sc_zerobuf = lance_zerobuf_contig;

	/*
	 * TC lance boards have onboard SRAM buffers.  DMA
	 * between the onbard RAM and main memory is not possible,
	 * so  DMA setup is not required.
	 */

	dec_le_common_attach(&lesc->sc_am7990,
	    (u_char *)(d->ta_addr + LE_OFFSET_ROM + 2));

	tc_intr_establish(parent, d->ta_cookie, IPL_NET, am7990_intr, sc,
	    self->dv_xname);
}
@


1.11
log
@Sync the MI LANCE code ( le(4) ) with NetBSD, except for the following:
- the am7990_get() - now lance_get() - is unchanged.
- the interrupt acknowledge logic is unchanged, and will disable interrupts,
  then acknowledge all interrupt conditions.

Add ILACC (79900) support (from NetBSD).

Both LANCE (am7990.c) and ILACC (am79900.c) code share as much common code
(lance.c) as possible. This affects all le(4) attachments, but the changes
are mostly mechanical, to split am7990-specific parts from lance-agnostic
parts.

Compile tested on all affected platforms. Tested on alpha, hp300, luna88k,
mvme88k, sparc, sparc64 and vax.
@
text
@d1 1
a1 1
/*	$OpenBSD: if_le_tc.c,v 1.10 2008/08/09 16:42:30 miod Exp $	*/
a44 1
#ifdef INET
a46 1
#endif
@


1.10
log
@Pass a device name to {tc,tcds,ioasic}_intr_establish in order to get
meaningful names associated to the interrupt counters.
@
text
@d1 1
a1 1
/*	$OpenBSD: if_le_tc.c,v 1.9 2007/11/06 18:20:07 miod Exp $	*/
d50 2
d84 1
a84 1
	struct am7990_softc *sc = &lesc->sc_am7990;
d95 5
a99 5
	sc->sc_copytodesc = am7990_copytobuf_contig;
	sc->sc_copyfromdesc = am7990_copyfrombuf_contig;
	sc->sc_copytobuf = am7990_copytobuf_contig;
	sc->sc_copyfrombuf = am7990_copyfrombuf_contig;
	sc->sc_zerobuf = am7990_zerobuf_contig;
d108 1
a108 1
			     (u_char *)(d->ta_addr + LE_OFFSET_ROM + 2));
@


1.9
log
@Get rid of TC_IPL_xxx values and tc_intrlevel_t, and use IPL_xxx and int.
No functional change.
@
text
@d1 1
a1 1
/*	$OpenBSD: if_le_tc.c,v 1.8 2007/06/17 21:20:47 jasper Exp $	*/
d108 2
a109 1
	tc_intr_establish(parent, d->ta_cookie, IPL_NET, am7990_intr, sc);
@


1.8
log
@ansify/de-register

ok miod@@
@
text
@d1 1
a1 1
/*	$OpenBSD: if_le_tc.c,v 1.7 2005/10/11 06:03:18 martin Exp $	*/
d108 1
a108 1
	tc_intr_establish(parent, d->ta_cookie, TC_IPL_NET, am7990_intr, sc);
@


1.7
log
@TC le(4) needs to be accessed in sparse address space for alpha.
Should fix TC ethernet cards as noted by some people.

from NetBSD

ok miod@@
@
text
@d1 1
a1 1
/*	$OpenBSD: if_le_tc.c,v 1.6 2002/05/02 22:56:06 miod Exp $	*/
d68 1
a68 3
le_tc_match(parent, match, aux)
	struct device *parent;
	void *match, *aux;
d79 1
a79 3
le_tc_attach(parent, self, aux)
	struct device *parent, *self;
	void *aux;
@


1.6
log
@Big TURBOchannel support catchup from NetBSD, part 1.
A few local changes and tweaks remain.

This bring DEC 3000 machines back in the game, but framebuffers are still
not supported at the moment.

Thanks to ericj@@ and nate@@ for supplying me a DEC 3000 for testing.
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d93 2
a94 1
	lesc->sc_r1 = (struct lereg1 *)(d->ta_addr + LE_OFFSET_LANCE);
@


1.5
log
@First round of __P removal in sys
@
text
@d1 2
a2 2
/*	$OpenBSD: if_le_tc.c,v 1.4 1998/09/16 22:41:22 jason Exp $	*/
/*	$NetBSD: if_le_tc.c,v 1.2 1996/05/07 02:24:57 thorpej Exp $	*/
d74 1
a74 2
	if (strncmp("PMAD-AA ", d->ta_modname, TC_ROM_LLEN) &&
	    strncmp("PMAD-BA ", d->ta_modname, TC_ROM_LLEN))
d85 2
a86 2
	register struct le_softc *lesc = (void *)self;
	register struct am7990_softc *sc = &lesc->sc_am7990;
d108 2
a109 1
	dec_le_common_attach(sc, (u_char *)(d->ta_addr + LE_OFFSET_ROM + 2));
@


1.4
log
@o if_media'fied am7990
o if_media'fied sun4m le.
@
text
@d1 1
a1 1
/*	$OpenBSD: if_le_tc.c,v 1.3 1997/11/07 08:07:50 niklas Exp $	*/
d56 2
a57 2
int	le_tc_match __P((struct device *, void *, void *));
void	le_tc_attach __P((struct device *, struct device *, void *));
@


1.4.18.1
log
@Sync UBC branch to -current
@
text
@d1 2
a2 2
/*	$OpenBSD$	*/
/*	$NetBSD: if_le_tc.c,v 1.12 2001/11/13 06:26:10 lukem Exp $	*/
d56 2
a57 2
int	le_tc_match(struct device *, void *, void *);
void	le_tc_attach(struct device *, struct device *, void *);
d74 2
a75 1
	if (strncmp("PMAD-AA ", d->ta_modname, TC_ROM_LLEN) != 0)
d86 2
a87 2
	struct le_softc *lesc = (void *)self;
	struct am7990_softc *sc = &lesc->sc_am7990;
d109 1
a109 2
	dec_le_common_attach(&lesc->sc_am7990,
			     (u_char *)(d->ta_addr + LE_OFFSET_ROM + 2));
@


1.4.8.1
log
@Merge in -current from roughly a week ago
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d56 2
a57 2
int	le_tc_match(struct device *, void *, void *);
void	le_tc_attach(struct device *, struct device *, void *);
@


1.4.8.2
log
@Sync the SMP branch with 3.3
@
text
@d2 1
a2 1
/*	$NetBSD: if_le_tc.c,v 1.12 2001/11/13 06:26:10 lukem Exp $	*/
d74 2
a75 1
	if (strncmp("PMAD-AA ", d->ta_modname, TC_ROM_LLEN) != 0)
d86 2
a87 2
	struct le_softc *lesc = (void *)self;
	struct am7990_softc *sc = &lesc->sc_am7990;
d109 1
a109 2
	dec_le_common_attach(&lesc->sc_am7990,
			     (u_char *)(d->ta_addr + LE_OFFSET_ROM + 2));
@


1.3
log
@$OpenBSD$
@
text
@d1 1
a1 1
/*	$OpenBSD: if_le_tc.c,v 1.2 1996/05/07 02:24:57 thorpej Exp $	*/
d43 1
@


1.2
log
@if_name/if_unit -> if_xname/if_softc
@
text
@d1 1
@


1.1
log
@make these work together
@
text
@d1 1
a1 1
/*	$NetBSD: if_le_tc.c,v 1.1 1996/04/18 00:50:14 cgd Exp $	*/
a47 1
#include <dev/tc/if_levar.h>
a48 1
#define LE_NEED_BUF_CONTIG
d51 1
d84 2
a85 1
	register struct le_softc *sc = (void *)self;
d92 1
a92 1
	sc->sc_r1 = (struct lereg1 *)(d->ta_addr + LE_OFFSET_LANCE);
d109 1
a109 1
	tc_intr_establish(parent, d->ta_cookie, TC_IPL_NET, leintr, sc);
@
