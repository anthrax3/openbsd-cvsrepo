head	1.18;
access;
symbols
	OPENBSD_6_2_BASE:1.18
	OPENBSD_6_1:1.18.0.6
	OPENBSD_6_1_BASE:1.18
	OPENBSD_6_0:1.18.0.4
	OPENBSD_6_0_BASE:1.18
	OPENBSD_5_9:1.17.0.16
	OPENBSD_5_9_BASE:1.17
	OPENBSD_5_8:1.17.0.18
	OPENBSD_5_8_BASE:1.17
	OPENBSD_5_7:1.17.0.10
	OPENBSD_5_7_BASE:1.17
	OPENBSD_5_6:1.17.0.14
	OPENBSD_5_6_BASE:1.17
	OPENBSD_5_5:1.17.0.12
	OPENBSD_5_5_BASE:1.17
	OPENBSD_5_4:1.17.0.8
	OPENBSD_5_4_BASE:1.17
	OPENBSD_5_3:1.17.0.6
	OPENBSD_5_3_BASE:1.17
	OPENBSD_5_2:1.17.0.2
	OPENBSD_5_2_BASE:1.17
	OPENBSD_5_1_BASE:1.17
	OPENBSD_5_1:1.17.0.4
	OPENBSD_5_0:1.15.0.2
	OPENBSD_5_0_BASE:1.15
	OPENBSD_4_9:1.14.0.16
	OPENBSD_4_9_BASE:1.14
	OPENBSD_4_8:1.14.0.14
	OPENBSD_4_8_BASE:1.14
	OPENBSD_4_7:1.14.0.10
	OPENBSD_4_7_BASE:1.14
	OPENBSD_4_6:1.14.0.12
	OPENBSD_4_6_BASE:1.14
	OPENBSD_4_5:1.14.0.8
	OPENBSD_4_5_BASE:1.14
	OPENBSD_4_4:1.14.0.6
	OPENBSD_4_4_BASE:1.14
	OPENBSD_4_3:1.14.0.4
	OPENBSD_4_3_BASE:1.14
	OPENBSD_4_2:1.14.0.2
	OPENBSD_4_2_BASE:1.14
	OPENBSD_4_1:1.10.0.2
	OPENBSD_4_1_BASE:1.10
	OPENBSD_4_0:1.6.0.2
	OPENBSD_4_0_BASE:1.6
	OPENBSD_3_9:1.5.0.2
	OPENBSD_3_9_BASE:1.5;
locks; strict;
comment	@ * @;


1.18
date	2016.03.15.20.50.22;	author krw;	state Exp;
branches;
next	1.17;
commitid	JZR2bOwahEjnBJaG;

1.17
date	2011.12.06.16.06.07;	author mpf;	state Exp;
branches;
next	1.16;

1.16
date	2011.10.05.15.05.47;	author deraadt;	state Exp;
branches;
next	1.15;

1.15
date	2011.07.26.18.43.35;	author deraadt;	state Exp;
branches;
next	1.14;

1.14
date	2007.06.25.22.50.18;	author cnst;	state Exp;
branches;
next	1.13;

1.13
date	2007.06.24.05.34.35;	author dlg;	state Exp;
branches;
next	1.12;

1.12
date	2007.05.25.02.26.43;	author cnst;	state Exp;
branches;
next	1.11;

1.11
date	2007.03.22.16.55.31;	author deraadt;	state Exp;
branches;
next	1.10;

1.10
date	2007.02.22.20.44.51;	author kettenis;	state Exp;
branches;
next	1.9;

1.9
date	2007.01.08.22.18.50;	author kettenis;	state Exp;
branches;
next	1.8;

1.8
date	2007.01.07.21.24.29;	author kettenis;	state Exp;
branches;
next	1.7;

1.7
date	2006.12.23.17.46.39;	author deraadt;	state Exp;
branches;
next	1.6;

1.6
date	2006.05.07.17.45.16;	author kettenis;	state Exp;
branches;
next	1.5;

1.5
date	2006.01.26.22.07.14;	author kettenis;	state Exp;
branches;
next	1.4;

1.4
date	2006.01.17.22.01.48;	author kettenis;	state Exp;
branches;
next	1.3;

1.3
date	2006.01.15.22.03.17;	author kettenis;	state Exp;
branches;
next	1.2;

1.2
date	2006.01.14.20.05.06;	author kettenis;	state Exp;
branches;
next	1.1;

1.1
date	2006.01.14.15.14.33;	author kettenis;	state Exp;
branches;
next	;


desc
@@


1.18
log
@'accomodate' -> 'accommodate' in comments.

Started by diff from Mical Mazurek.
@
text
@/*	$OpenBSD: lm78var.h,v 1.17 2011/12/06 16:06:07 mpf Exp $	*/

/*
 * Copyright (c) 2005, 2006 Mark Kettenis
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

/*
 * National Semiconductor LM78/79/81 registers
 */

#define LM_POST_RAM	0x00	/* POST RAM occupies 0x00 -- 0x1f */
#define LM_VALUE_RAM	0x20	/* Value RAM occupies 0x20 -- 0x3f */
#define LM_FAN1		0x28	/* FAN1 reading */
#define LM_FAN2		0x29	/* FAN2 reading */
#define LM_FAN3		0x2a	/* FAN3 reading */

#define LM_CONFIG	0x40	/* Configuration */ 
#define LM_ISR1		0x41	/* Interrupt Status 1 */
#define LM_ISR2		0x42	/* Interrupt Status 2 */
#define LM_SMI1		0x43	/* SMI# Mask 1 */
#define LM_SMI2		0x44	/* SMI# Mask 2 */
#define LM_NMI1		0x45	/* NMI Mask 1 */
#define LM_NMI2		0x46	/* NMI Mask 2 */
#define LM_VIDFAN	0x47	/* VID/Fan Divisor */
#define LM_SBUSADDR	0x48	/* Serial Bus Address */
#define LM_CHIPID	0x49	/* Chip Reset/ID */

/* Chip IDs */

#define LM_CHIPID_LM78	0x00
#define LM_CHIPID_LM78J	0x40
#define LM_CHIPID_LM79	0xC0
#define LM_CHIPID_LM81	0x80
#define LM_CHIPID_MASK	0xfe

/*
 * Winbond registers
 *
 * Several models exists.  The W83781D is mostly compatible with the
 * LM78, but has two extra temperatures.  Later models add extra
 * voltage sensors, fans and bigger fan divisors to accommodate slow
 * running fans.  To accommodate the extra sensors some models have
 * different memory banks.
 */

#define WB_T23ADDR	0x4a	/* Temperature 2 and 3 Serial Bus Address */
#define WB_PIN		0x4b	/* Pin Control */
#define WB_BANKSEL	0x4e	/* Bank Select */
#define WB_VENDID	0x4f	/* Vendor ID */

/* Bank 0 regs */
#define WB_BANK0_CHIPID	0x58	/* Chip ID */
#define WB_BANK0_FAN45	0x5c	/* Fan 4/5 Divisor Control (W83791D only) */
#define WB_BANK0_VBAT	0x5d	/* VBAT Monitor Control */
#define WB_BANK0_FAN4	0xba	/* Fan 4 reading (W83791D only) */
#define WB_BANK0_FAN5	0xbb	/* Fan 5 reading (W83791D only) */

#define WB_BANK0_CONFIG	0x18	/* VRM & OVT Config (W83627THF/W83637HF) */

/* Bank 1 registers */
#define WB_BANK1_T2H	0x50	/* Temperature 2 High Byte */
#define WB_BANK1_T2L	0x51	/* Temperature 2 Low Byte */

/* Bank 2 registers */
#define WB_BANK2_T3H	0x50	/* Temperature 3 High Byte */
#define WB_BANK2_T3L	0x51	/* Temperature 3 Low Byte */

/* Bank 4 registers (W83782D/W83627HF and later models only) */
#define WB_BANK4_T1OFF	0x54	/* Temperature 1 Offset */
#define WB_BANK4_T2OFF	0x55	/* Temperature 2 Offset */
#define WB_BANK4_T3OFF	0x56	/* Temperature 3 Offset */

/* Bank 5 registers (W83782D/W83627HF and later models only) */
#define WB_BANK5_5VSB	0x50	/* 5VSB reading */
#define WB_BANK5_VBAT	0x51	/* VBAT reading */

/* Bank selection */
#define WB_BANKSEL_B0	0x00	/* Bank 0 */
#define WB_BANKSEL_B1	0x01	/* Bank 1 */
#define WB_BANKSEL_B2	0x02	/* Bank 2 */
#define WB_BANKSEL_B3	0x03	/* Bank 3 */
#define WB_BANKSEL_B4	0x04	/* Bank 4 */
#define WB_BANKSEL_B5	0x05	/* Bank 5 */
#define WB_BANKSEL_HBAC	0x80	/* Register 0x4f High Byte Access */

/* Vendor IDs */
#define WB_VENDID_WINBOND	0x5ca3	/* Winbond */
#define WB_VENDID_ASUS		0x12c3	/* ASUS */

/* Chip IDs */
#define WB_CHIPID_W83781D	0x10
#define WB_CHIPID_W83781D_2	0x11
#define WB_CHIPID_W83627HF	0x21
#define WB_CHIPID_AS99127F	0x31 /* Asus W83781D clone */
#define WB_CHIPID_W83782D	0x30
#define WB_CHIPID_W83783S	0x40
#define WB_CHIPID_W83697HF	0x60
#define WB_CHIPID_W83791D	0x71
#define WB_CHIPID_W83791SD	0x72
#define WB_CHIPID_W83792D	0x7a
#define WB_CHIPID_W83637HF	0x80
#define WB_CHIPID_W83627EHF_A	0x88 /* early version, only for ASUS MBs */
#define WB_CHIPID_W83627THF	0x90
#define WB_CHIPID_W83627EHF	0xa1
#define WB_CHIPID_W83627DHG	0xc1 /* also used in WBSIO_ID_NCT6776F */

/* Config bits */
#define WB_CONFIG_VMR9		0x01

/* Reference voltage (mV) */
#define WB_VREF			3600
#define WB_W83627EHF_VREF	2048

#define WB_MAX_SENSORS  19

struct lm_softc;

struct lm_sensor {
	char *desc;
	enum sensor_type type;
	u_int8_t bank;
	u_int8_t reg;
	void (*refresh)(struct lm_softc *, int);
	int rfact;
};

struct lm_softc {
	struct device sc_dev;

	struct ksensor sensors[WB_MAX_SENSORS];
	struct ksensordev sensordev;
	struct sensor_task *sensortask;
	struct lm_sensor *lm_sensors;
	u_int numsensors;
	void (*refresh_sensor_data) (struct lm_softc *);

	u_int8_t (*lm_readreg)(struct lm_softc *, int);
	void (*lm_writereg)(struct lm_softc *, int, int);

	u_int8_t sbusaddr;
	u_int8_t chipid;
	u_int8_t sioid;
	u_int8_t vrm9;
};

void lm_attach(struct lm_softc *);
@


1.17
log
@Add support for Nuvoton NCT6776F fan, voltage and temperature sensors.
Tested on a Supermicro X9SCL/X9SCM board.
With help from kettenis to make the part that works around a
chip ID collision less ugly.
OK kettenis
@
text
@d1 1
a1 1
/*	$OpenBSD: lm78var.h,v 1.16 2011/10/05 15:05:47 deraadt Exp $	*/
d53 2
a54 2
 * voltage sensors, fans and bigger fan divisors to accomodate slow
 * running fans.  To accomodate the extra sensors some models have
@


1.16
log
@It is not safe to call sensor_task_unregister() from inside the
refresh function.  sensor_task_work() is incomprehensively complex.
Work around this by using a workq to deactive the i2c alias when the
isa interface is preffered.
Problem of dead sensors reported by henning, fix tested by Nigel Taylor
ok kettenis
@
text
@d1 1
a1 1
/*	$OpenBSD: lm78var.h,v 1.15 2011/07/26 18:43:35 deraadt Exp $	*/
d117 1
a117 1
#define WB_CHIPID_W83627DHG	0xc1
d154 1
@


1.15
log
@Calling a detach function from an attach function is no longer legal (
see a recent subr_autoconf.c commit).  To resolve this problem, mark the
other attachment dead, and clean it up when the first servicing timeout
gets run.
ok kettenis
@
text
@d1 1
a1 1
/*	$OpenBSD: lm78var.h,v 1.14 2007/06/25 22:50:18 cnst Exp $	*/
a154 3

#define LM78_DEAD	1
	int flags;
@


1.14
log
@support early W83627EHF-A; tested by Sam Fourman Jr; discussed with Gong Jun; ok kettenis@@
@
text
@d1 1
a1 1
/*	$OpenBSD: lm78var.h,v 1.13 2007/06/24 05:34:35 dlg Exp $	*/
d155 3
a160 1
int lm_detach(struct lm_softc *);
@


1.13
log
@rework sensor tasks to use the kernels generic workq rather than a special
kernel thread of its own. the api has changed (which will be fixed in the
manpage shortly) so all the users of sensor tasks that i can find have
been fixed too.

noone tested, so its going in to force people to run with it.
"put it in" deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: lm78var.h,v 1.12 2007/05/25 02:26:43 cnst Exp $	*/
d114 1
@


1.12
log
@add support for W83627DHG; ok kettenis
@
text
@d1 1
a1 1
/*	$OpenBSD: lm78var.h,v 1.11 2007/03/22 16:55:31 deraadt Exp $	*/
d143 1
@


1.11
log
@split userland & kernel struct sensor/sensordev so that the addition
of new fields in the future is less disruptive.  This is done similar
to how struct proc is handled for ps(1).  ok jmc (man page changes)
tested fkr simon, and more suggestions from millert
@
text
@d1 1
a1 1
/*	$OpenBSD: lm78var.h,v 1.10 2007/02/22 20:44:51 kettenis Exp $	*/
d116 1
@


1.10
log
@Add support for Winbond W83627EHF chips.
@
text
@d1 1
a1 1
/*	$OpenBSD: lm78var.h,v 1.9 2007/01/08 22:18:50 kettenis Exp $	*/
d140 2
a141 2
	struct sensor sensors[WB_MAX_SENSORS];
	struct sensordev sensordev;
@


1.9
log
@Fix comment.  From Constantine A. Murenin.
@
text
@d1 1
a1 1
/*	$OpenBSD: lm78var.h,v 1.8 2007/01/07 21:24:29 kettenis Exp $	*/
d115 1
d121 2
a122 1
#define WB_VREF		3600
@


1.8
log
@Fix VCore voltage detection on w83637hf.

Based on a diff from Constantine A. Murenin
@
text
@d1 1
a1 1
/*	$OpenBSD: lm78var.h,v 1.7 2006/12/23 17:46:39 deraadt Exp $	*/
d70 1
a70 1
#define WB_BANK0_CONFIG	0x18	/* VRM & OVT Configuration (W83637HF only) */
@


1.7
log
@adapt to new two-level sensor api; Constantine A. Murenin
@
text
@d1 1
a1 1
/*	$OpenBSD: lm78var.h,v 1.6 2006/05/07 17:45:16 kettenis Exp $	*/
d70 2
d96 1
a96 1
#define WB_BANKSEL_HBAC	0x80	/* Register 0x4f Hight Byte Access */
d116 3
d149 1
@


1.6
log
@Add abstraction for resistor factor; makes it easier to compare them to
the datasheets.  Fix a few typos too.
From Constantine Murenin <mureninc@@gmail.org>.
@
text
@d1 1
a1 1
/*	$OpenBSD: lm78var.h,v 1.5 2006/01/26 22:07:14 kettenis Exp $	*/
d134 1
@


1.5
log
@Make lm at iic detach properly, and use config_detach(9) to fully detach
lm at iic if we attach lm at isa for the same chip.
tested by robert@@, krw@@
@
text
@d1 1
a1 1
/*	$OpenBSD: lm78var.h,v 1.4 2006/01/17 22:01:48 kettenis Exp $	*/
d127 1
a127 1
	u_int rfact;
@


1.4
log
@Support W83791SD as an lm(4) without sensors.
@
text
@d1 1
a1 1
/*	$OpenBSD: lm78var.h,v 1.3 2006/01/15 22:03:17 kettenis Exp $	*/
d146 1
@


1.3
log
@Commit missing bits too:

If we attach an lm(4) to isa(4) that is already attached to iic(4), disable
the one attached to iic(4).
idea from deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: lm78var.h,v 1.2 2006/01/14 20:05:06 kettenis Exp $	*/
d109 1
a109 1
#define WB_CHIPID_W83791D_2	0x72
@


1.2
log
@Move isa-specific members of struct lm_softc into lm_isa.c.
@
text
@d1 1
a1 1
/*	$OpenBSD: lm78var.h,v 1.1 2006/01/14 15:14:33 kettenis Exp $	*/
d131 1
a131 1
	struct	device sc_dev;
d140 3
@


1.1
log
@Rename nslm7x.c into lm78.c and nslm7xvar.h into lm78var.h, and clean up
lm78var.h.
Now that I've completely rewritten the driver, replace copyright with my own.
suggested by deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: nslm7xvar.h,v 1.11 2006/01/12 22:45:46 kettenis Exp $	*/
a132 4
	bus_space_tag_t lm_iot;
	bus_space_handle_t lm_ioh;

	int	sc_flags;
@

