head	1.6;
access;
symbols
	SMP_SYNC_A:1.6
	SMP_SYNC_B:1.6
	UBC_SYNC_A:1.6
	UBC_SYNC_B:1.6
	UBC:1.5.0.4
	UBC_BASE:1.5
	OPENBSD_3_0:1.5.0.2
	OPENBSD_3_0_BASE:1.5
	OPENBSD_2_9_BASE:1.4
	OPENBSD_2_9:1.4.0.8
	OPENBSD_2_8:1.4.0.6
	OPENBSD_2_8_BASE:1.4
	OPENBSD_2_7:1.4.0.4
	OPENBSD_2_7_BASE:1.4
	SMP:1.4.0.2
	SMP_BASE:1.4
	kame_19991208:1.3
	OPENBSD_2_6:1.3.0.10
	OPENBSD_2_6_BASE:1.3
	OPENBSD_2_5:1.3.0.8
	OPENBSD_2_5_BASE:1.3
	OPENBSD_2_4:1.3.0.6
	OPENBSD_2_4_BASE:1.3
	OPENBSD_2_3:1.3.0.4
	OPENBSD_2_3_BASE:1.3
	OPENBSD_2_2:1.3.0.2
	OPENBSD_2_2_BASE:1.3
	OPENBSD_2_1:1.2.0.2
	OPENBSD_2_1_BASE:1.2
	powerpc_1:1.1.1.1;
locks; strict;
comment	@ * @;


1.6
date	2002.03.13.18.27.36;	author drahn;	state dead;
branches;
next	1.5;

1.5
date	2001.06.24.05.01.36;	author drahn;	state Exp;
branches
	1.5.4.1;
next	1.4;

1.4
date	2000.01.14.05.42.17;	author rahnds;	state Exp;
branches
	1.4.2.1;
next	1.3;

1.3
date	97.10.13.13.42.55;	author pefo;	state Exp;
branches;
next	1.2;

1.2
date	96.12.28.06.21.43;	author rahnds;	state Exp;
branches;
next	1.1;

1.1
date	96.12.21.20.35.56;	author rahnds;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	96.12.21.20.35.56;	author rahnds;	state Exp;
branches;
next	;

1.4.2.1
date	2001.07.04.10.22.49;	author niklas;	state Exp;
branches;
next	1.4.2.2;

1.4.2.2
date	2001.11.13.22.14.34;	author niklas;	state dead;
branches;
next	;

1.5.4.1
date	2002.06.11.03.37.28;	author art;	state dead;
branches;
next	;


desc
@@


1.6
log
@Complete rewrite of the powerpc pmap handling, Instead of keeping
the spill list for each PTEG, the V->P translations are stored in
trees for each pmap. All valid kernel mappings are preallocated
in 1-1 memory so that tlb spill/loads for kernel accesses can be
looked up while physical, user mappings are not guaranteed to
be 1-1 mapped, thus the kernel must go virtual to look up user
mappings. While this is more expensive, the tree search is much
lower cost than the long linked list search. Also on each pmap_remove()
it was necessary to search the linked lists for each possible mapping,
now it just looks up the entry in the tree.
This change gives a 25-36% speedup in 'make build' time. What was
around 2:50 is now around 1:55 on a 733MHz G4.

This change causes a likely existing bug to appear quite often,
it deals with the segment register invalidation in kernel mode.
Because of that problem, currently this change limits the physical
memory used to 256MB. This limitation will be fixed soon, it is not
an error in the pmap code.

 * Effort sponsored in part by the Defense Advanced Research Projects
 * Agency (DARPA) and Air Force Research Laboratory, Air Force
 * Materiel Command, USAF, under agreement number F30602-01-2-0537.
@
text
@/*	$OpenBSD: copyinstr.c,v 1.5 2001/06/24 05:01:36 drahn Exp $	*/

/*-
 * Copyright (C) 1995 Wolfgang Solfrank.
 * Copyright (C) 1995 TooLs GmbH.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by TooLs GmbH.
 * 4. The name of TooLs GmbH may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY TOOLS GMBH ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL TOOLS GMBH BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
 * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
#include <sys/param.h>
#include <sys/errno.h>
#include <sys/systm.h>

/*
 * Emulate copyinstr.
 */
int
copyinstr(udaddr, kaddr, len, done)
	const void *udaddr;
	void *kaddr;
	size_t len;
	size_t *done;
{
	int c;
	void *uaddr = (void *)udaddr;
	u_char *kp = kaddr;
	int l;
	
	for (l = 0; len-- > 0; l++) {
		if ((c = fubyte(uaddr++)) < 0) {
			*done = l;
			return EFAULT;
		}
		if (!(*kp++ = c)) {
			*done = l + 1;
			return 0;
		}
	}
	*done = l;
	return ENAMETOOLONG;
}
@


1.5
log
@prototype cleanup, use local variable for const input arg.
@
text
@d1 1
a1 1
/*	$OpenBSD: copyinstr.c,v 1.4 2000/01/14 05:42:17 rahnds Exp $	*/
@


1.5.4.1
log
@Sync UBC branch to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: copyinstr.c,v 1.5 2001/06/24 05:01:36 drahn Exp $	*/
@


1.4
log
@

UVM changes mainly. As of this checkin UVM is still not working for powerpc
it has a copyin bug after device configuration. However to get these diffs
out of my tree.

All of the UVM code is currently inside ifdef UVM the kernel works fine
without option UVM. Config files have been left without UVM for now.

Prelimiary changes for busdma, (what UVM was wanted for).
@
text
@d1 1
a1 1
/*	$OpenBSD: copyinstr.c,v 1.3 1997/10/13 13:42:55 pefo Exp $	*/
d35 1
d42 1
a42 1
	void *udaddr;
d48 1
d53 1
a53 1
		if ((c = fubyte(udaddr++)) < 0) {
@


1.4.2.1
log
@Merge in -current from two days ago in the SMP branch.
As usual with merges, they do not indicate progress, so do not hold
your breath for working SMP, and do not mail me and ask about the
state of it.  It has not changed.  There is work ongoing, but very, very
slowly.  The commit is done in parts as to not lock up the tree in too
big chunks at a time.
@
text
@d1 1
a1 1
/*	$OpenBSD: copyinstr.c,v 1.4 2000/01/14 05:42:17 rahnds Exp $	*/
a34 1
#include <sys/systm.h>
d41 1
a41 1
	const void *udaddr;
a46 1
	void *uaddr = (void *)udaddr;
d51 1
a51 1
		if ((c = fubyte(uaddr++)) < 0) {
@


1.4.2.2
log
@repair
@
text
@d1 1
a1 1
/*	$OpenBSD: copyinstr.c,v 1.4.2.1 2001/07/04 10:22:49 niklas Exp $	*/
@


1.3
log
@Monolithic (No OpenFirmware driver crap...) PowerPC kernel. This is the
first release based on Wolfgang Solfrank, TooLs GmbH, work. Most OFW stuff
has been ripped out. Only a few functions for memory probing and halt/reboot
functionality has been kept. The kernel currently works with V.I's power.4e
PowerPC604 board, but more will come.
@
text
@d1 1
a1 1
/*	$OpenBSD: copyinstr.c,v 1.2 1996/12/28 06:21:43 rahnds Exp $	*/
d53 1
a53 1
			return EACCES;
@


1.2
log
@Adding OpenBSD tags to files.
@
text
@d1 1
a1 2
/*	$OpenBSD:$	*/
/*	$NetBSD: copyinstr.c,v 1.1 1996/09/30 16:34:42 ws Exp $	*/
@


1.1
log
@Initial revision
@
text
@d1 1
@


1.1.1.1
log
@Check-in of powerpc kernel support.
NOTE: This will not work until the other pieces are checked in.
This is primarily the NetBSD powerpc port, with modifications
to support ELF. 
@
text
@@
