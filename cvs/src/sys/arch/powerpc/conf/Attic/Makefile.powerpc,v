head	1.13;
access;
symbols
	SMP_SYNC_A:1.13
	SMP_SYNC_B:1.13
	UBC_SYNC_A:1.13
	UBC_SYNC_B:1.13
	OPENBSD_2_9:1.9.0.4
	OPENBSD_2_9_BASE:1.9
	OPENBSD_2_8:1.9.0.2
	OPENBSD_2_8_BASE:1.9
	OPENBSD_2_7:1.8.0.10
	OPENBSD_2_7_BASE:1.8
	SMP:1.8.0.8
	SMP_BASE:1.8
	kame_19991208:1.8
	OPENBSD_2_6:1.8.0.6
	OPENBSD_2_6_BASE:1.8
	OPENBSD_2_5:1.8.0.4
	OPENBSD_2_5_BASE:1.8
	OPENBSD_2_4:1.8.0.2
	OPENBSD_2_4_BASE:1.8
	OPENBSD_2_3:1.7.0.2
	OPENBSD_2_3_BASE:1.7
	OPENBSD_2_2:1.6.0.2
	OPENBSD_2_2_BASE:1.6
	OPENBSD_2_1:1.3.0.2
	OPENBSD_2_1_BASE:1.3
	powerpc_1:1.1.1.1;
locks; strict;
comment	@# @;


1.13
date	2001.09.01.15.59.31;	author drahn;	state dead;
branches;
next	1.12;

1.12
date	2001.07.18.23.56.32;	author mickey;	state Exp;
branches;
next	1.11;

1.11
date	2001.07.15.13.10.49;	author assar;	state Exp;
branches;
next	1.10;

1.10
date	2001.07.10.01.56.50;	author drahn;	state Exp;
branches;
next	1.9;

1.9
date	2000.10.20.20.54.26;	author deraadt;	state Exp;
branches;
next	1.8;

1.8
date	98.05.29.04.15.27;	author rahnds;	state Exp;
branches
	1.8.8.1;
next	1.7;

1.7
date	98.04.06.17.29.25;	author pefo;	state Exp;
branches;
next	1.6;

1.6
date	97.10.13.13.49.56;	author pefo;	state Exp;
branches;
next	1.5;

1.5
date	97.10.13.09.39.32;	author pefo;	state Exp;
branches;
next	1.4;

1.4
date	97.09.15.02.40.34;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	97.05.20.21.51.49;	author rahnds;	state Exp;
branches;
next	1.2;

1.2
date	97.04.18.20.33.08;	author rahnds;	state Exp;
branches;
next	1.1;

1.1
date	96.12.21.20.35.52;	author rahnds;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	96.12.21.20.35.52;	author rahnds;	state Exp;
branches;
next	;

1.8.8.1
date	2001.04.18.16.12.54;	author niklas;	state Exp;
branches;
next	1.8.8.2;

1.8.8.2
date	2001.10.31.03.07.54;	author nate;	state dead;
branches;
next	1.8.8.3;

1.8.8.3
date	2001.11.13.21.04.16;	author niklas;	state Exp;
branches;
next	1.8.8.4;

1.8.8.4
date	2001.11.13.22.14.33;	author niklas;	state dead;
branches;
next	;


desc
@@


1.13
log
@The "powerpc" port which has supported the newer Apple Macintosh powerpc based
is being renamed to macppc. This is to allow sharing of common code
between different powerpc base platforms.

Most of the work involved in the renaming process was performed by miod@@

Files moved from powerpc/conf to macppc/conf

files.powerpc was modified to keep powerpc common files.
@
text
@#	$OpenBSD: Makefile.powerpc,v 1.12 2001/07/18 23:56:32 mickey Exp $
#
# Makefile for OpenBSD PowerPC
#
# This makefile is constructed from a machine description:
#	config machineid
# Most changes should be made in the machine description
#	/sys/arch/powerpc/conf/``machineid''
# after which you should do
#	config machineid
# Machine generic makefile changes should be made in
#	/sys/arch/powerpc/conf/Makefile.powerpc
# after which config should be rerun for all machines of that type.
#
# N.B.: NO DEPENDENCIES ON FOLLOWING FLAGS ARE VISIBLE TO MAKEFILE
#	IF YOU CHANGE THE DEFINITION OF ANY OF THESE RECOMPILE EVERYTHING
#
# -DTRACE	compile in kernel tracing hooks
# -DQUOTA	compile in file system quotas
#
.SUFFIXES:	.S .c .o

# DEBUG is set to -g if debugging.
# PROF is set to -pg if profiling.

.include <bsd.own.mk>

AS?=	as
CC?=	cc
CPP?=	cpp
LD?=	ld
MKDEP?=	mkdep
STRIP?=	strip
SIZE?=	size

# source tree is located via $S relative to the compilation directory
.ifndef	S
S!=	cd ../../../..; pwd
.endif
PPC=	$S/arch/powerpc

INCLUDES=	-I. -I$S/arch -I$S -nostdinc -L${DESTDIR}/usr/include
CPPFLAGS=	${INCLUDES} ${IDENT} -D_KERNEL \
		-Dpowerpc
CWARNFLAGS=	-Werror -Wall -Wstrict-prototypes -Wmissing-prototypes \
		-Wno-uninitialized -Wno-format -Wno-main
CFLAGS=		${DEBUG} ${CWARNFLAGS} -O2 -msoft-float
AFLAGS=		-D_LOCORE
LINKFLAGS=	-N -Ttext 100074 -e start
STRIPFLAGS=	-d

HOSTCC?=	${CC}
HOSTED_CPPFLAGS=${CPPFLAGS:S/^-nostdinc$//}
HOSTED_CFLAGS=	${CFLAGS}

### find out what to use for libkern
.include "$S/lib/libkern/Makefile.inc"
.ifndef PROF
LIBKERN=	${KERNLIB}
.else
LIBKERN=	${KERNLIB_PROF}
.endif

### find out what to use for libcompat
.include "$S/compat/common/Makefile.inc"
.ifndef PROF
LIBCOMPAT=	${COMPATLIB}
.else
LIBCOMPAT=	${COMPATLIB_PROF}
.endif

# compile rules: rules are named ${TYPE}_${SUFFIX}${CONFIG_DEP}
# where TYPE is NORMAL, DRIVER, or PROFILE}; SUFFIX is the file suffix,
# capitalized (e.g. C for a .c file), and CONFIG_DEP is _C if the file
# is marked as config-dependent.

USRLAND_C=	${CC} ${CFLAGS} ${CPPFLAGS} ${PROF} -c $<
USRLAND_C_C=	${CC} ${CFLAGS} ${CPPFLAGS} ${PROF} ${PARAM} -c $<

NORMAL_C=	${CC} ${CFLAGS} ${CPPFLAGS} ${PROF} -c $<
NORMAL_C_C=	${CC} ${CFLAGS} ${CPPFLAGS} ${PROF} ${PARAM} -c $<

DRIVER_C=	${CC} ${CFLAGS} ${CPPFLAGS} ${PROF} -c $<
DRIVER_C_C=	${CC} ${CFLAGS} ${CPPFLAGS} ${PROF} ${PARAM} -c $<

NORMAL_S=	${CC} ${AFLAGS} ${CPPFLAGS} -c $<
NORMAL_S_C=	${AS}  ${COPTS} ${PARAM} $< -o $@@


%OBJS

%CFILES

%SFILES

# load lines for config "xxx" will be emitted as:
# xxx: ${SYSTEM_DEP} swapxxx.o
#	${SYSTEM_LD_HEAD}
#	${SYSTEM_LD} swapxxx.o
#	${SYSTEM_LD_TAIL}
SYSTEM_OBJ=	locore.o param.o ioconf.o ${OBJS} ${LIBKERN} ${LIBCOMPAT}
SYSTEM_DEP=	Makefile ${SYSTEM_OBJ}
SYSTEM_LD_HEAD=	rm -f $@@
SYSTEM_LD=	@@echo ${LD} ${LINKFLAGS} -o $@@ '$${SYSTEM_OBJ}' vers.o; \
		${LD} ${LINKFLAGS} -o $@@ ${SYSTEM_OBJ} vers.o
SYSTEM_LD_TAIL=	@@${SIZE} $@@; chmod 755 $@@

DEBUG?=
.if ${DEBUG} == "-g"
LINKFLAGS+=	-X
SYSTEM_LD_TAIL+=; \
		echo cp $@@ $@@.gdb; rm -f $@@.gdb; cp $@@ $@@.gdb; \
		echo ${STRIP} ${STRIPFLAGS} $@@; ${STRIP} ${STRIPFLAGS} $@@
.else
LINKFLAGS+=	-S
.endif

%LOAD

assym.h: $S/kern/genassym.sh ${PPC}/powerpc/genassym.cf
	sh $S/kern/genassym.sh ${CC} ${CFLAGS} ${CPPFLAGS} \
	    < ${PPC}/powerpc/genassym.cf > assym.h.tmp && \
	    mv -f assym.h.tmp assym.h

param.c: $S/conf/param.c
	rm -f param.c
	cp $S/conf/param.c .

param.o: param.c Makefile
	${NORMAL_C_C}

ioconf.o: ioconf.c
	${NORMAL_C}

newvers: ${SYSTEM_DEP} ${SYSTEM_SWAP_DEP}
	sh $S/conf/newvers.sh
	${CC} ${CFLAGS} ${CPPFLAGS} ${PROF} -c vers.c

clean::
	rm -f eddep *bsd bsd.gdb tags *.[io] [a-z]*.s \
		[Ee]rrs linterrs makelinks genassym genassym.o assym.h

lint:
	@@lint -hbxncez -DGENERIC -Dvolatile= ${CPPFLAGS} -UKGDB \
		${PPC}/powerpc/Locore.c ${CFILES} ${PPC}/powerpc/swapgeneric.c \
		ioconf.c param.c | \
		grep -v 'static function .* unused'

tags:
	@@echo "see $S/kern/Makefile for tags"

links:
	egrep '#if' ${CFILES} | sed -f $S/conf/defines | \
	  sed -e 's/:.*//' -e 's/\.c/.o/' | sort -u > dontlink
	echo ${CFILES} | tr -s ' ' '\12' | sed 's/\.c/.o/' | \
	  sort -u | comm -23 - dontlink | \
	  sed 's,../.*/\(.*.o\),rm -f \1; ln -s ../GENERIC/\1 \1,' > makelinks
	sh makelinks && rm -f dontlink

SRCS=	${PPC}/powerpc/locore.S \
	param.c ioconf.c ${CFILES} ${SFILES}
depend:: .depend
.depend: ${SRCS} assym.h param.c
	${MKDEP} ${AFLAGS} ${CPPFLAGS} ${PPC}/powerpc/locore.S
	${MKDEP} -a ${CFLAGS} ${CPPFLAGS} param.c ioconf.c ${CFILES}
.if ${SFILES} != ""
	${MKDEP} -a ${AFLAGS} ${CPPFLAGS} ${SFILES}
.endif

# depend on root or device configuration
autoconf.o conf.o: Makefile

# depend on network or filesystem configuration
uipc_proto.o vfs_conf.o: Makefile

# depend on maxusers
genassym.o machdep.o: Makefile

# depend on CPU configuration
locore.o machdep.o: Makefile


locore.o: ${PPC}/powerpc/locore.S assym.h
	${NORMAL_S}

# The install target can be redefined by putting a
# install-kernel-${MACHINE_NAME} target into /etc/mk.conf
MACHINE_NAME!=  uname -n
install: install-kernel-${MACHINE_NAME}
.if !target(install-kernel-${MACHINE_NAME}})
install-kernel-${MACHINE_NAME}:
	rm -f /obsd
	ln /bsd /obsd
	cp bsd /nbsd
	mv /nbsd /bsd
.endif

%RULES
@


1.12
log
@build the kernel w/ all the warnings enabled; drahn@@ ok
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.powerpc,v 1.11 2001/07/15 13:10:49 assar Exp $
@


1.11
log
@add install target
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.powerpc,v 1.10 2001/07/10 01:56:50 drahn Exp $
d45 2
a46 1
CWARNFLAGS=	-Werror -Wreturn-type
@


1.10
log
@Unbreak commit to use memset.c instead of bzero.c
Suspect that this is really broken code in libkern/arch/powerpc/Makefile.inc
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.powerpc,v 1.9 2000/10/20 20:54:26 deraadt Exp $
d26 2
d184 12
@


1.9
log
@fix clean target
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.powerpc,v 1.8 1998/05/29 04:15:27 rahnds Exp $
d35 4
a38 5
#.ifndef	S
#S!=	cd ../../../..; pwd
#.endif
S=	../../../..
PPC=	../..
@


1.8
log
@Major changes here and there, tweaks elsewhere.
Support for Openfirmware drivers was reintroduced so that more systems
were supported. This should work with the real driver configurations
as well.

Bootloader files were deleted/replaced with the newer versions in the
subdirectory. Some effort has been made to be closer to support booting
(at least the bootloader) on the Mac.

Config files that end with OFW are the openfirmware versions of the kernels
without have native drivers.

Native driver support has not been changed, presumably it still works.
I couldn't test that.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.powerpc,v 1.7 1998/04/06 17:29:25 pefo Exp $
d138 1
a138 1
	rm -f eddep *netbsd netbsd.gdb tags *.[io] [a-z]*.s \
@


1.8.8.1
log
@Update the SMP branch to -current, this breaks the SMP branch though.
But it will be fixed soonish.  Note, nothing new has happened, this is just
a merge of the trunk into this branch.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.powerpc,v 1.9 2000/10/20 20:54:26 deraadt Exp $
d138 1
a138 1
	rm -f eddep *bsd bsd.gdb tags *.[io] [a-z]*.s \
@


1.8.8.2
log
@Sync the SMP branch to something just after 3.0
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.powerpc,v 1.8.8.1 2001/04/18 16:12:54 niklas Exp $
@


1.8.8.3
log
@Merge in -current
@
text
@d1 1
a1 1
#	$OpenBSD$
@


1.8.8.4
log
@repair
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.powerpc,v 1.8.8.3 2001/11/13 21:04:16 niklas Exp $
@


1.7
log
@New config stuff + Makefile fix to make gcc 2.8.1 work. Thanks to Dale Rahn!
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.powerpc,v 1.6 1997/10/13 13:49:56 pefo Exp $
d43 1
a43 1
		-Dpowerpc -Dpower4e
@


1.6
log
@A few adjustments.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.powerpc,v 1.5 1997/10/13 09:39:32 pefo Exp $
d47 1
a47 1
LINKFLAGS=	-N -Ttext 100000 -e start
@


1.5
log
@Monolithic PowerPC kernel configuration files
@
text
@d1 1
a1 1
#	$OpenBSD:$
d26 1
d28 1
d39 1
a39 1
PPC=	$S/arch/powerpc
d70 7
a76 2
# compile rules: rules are named ${TYPE}_${SUFFIX} where TYPE is NORMAL or
# HOSTED}, and SUFFIX is the file suffix, capitalized (e.g. C for a .c file).
d79 4
d85 1
a86 7
HOSTED_C=	${HOSTCC} ${HOSTED_CFLAGS} ${HOSTED_CPPFLAGS} -c $<

#.c.o:
#	${NORMAL_C}
#
#.S.o:
#	${NORMAL_S}
d99 1
a99 2
SYSTEM_OBJ=	locore.o \
		param.o ioconf.o ${OBJS} ${LIBKERN} ${LIBCOMPAT}
d128 1
a128 1
	${NORMAL_C}
@


1.4
log
@kill Locore.c
@
text
@d1 1
a1 1
#	$NetBSD: Makefile.powerpc,v 1.1 1996/09/30 16:34:18 ws Exp $
d3 1
a3 1
# Makefile for NetBSD
d41 1
a41 1
		-Dpowerpc
d139 2
a140 1
		${CFILES} ${PPC}/powerpc/swapgeneric.c ioconf.c param.c | \
@


1.3
log
@powerpc port does not use genassym.c anymore, do not attempt to
create dependancies on it.
@
text
@d139 1
a139 2
		${PPC}/powerpc/Locore.c ${CFILES} ${PPC}/powerpc/swapgeneric.c \
		ioconf.c param.c | \
@


1.2
log
@Use the new genassym.cf method of generating the assym.h file.
@
text
@a162 2
	${MKDEP} -a ${HOSTED_CFLAGS} ${HOSTED_CPPFLAGS} \
	    ${PPC}/powerpc/genassym.c
@


1.1
log
@Initial revision
@
text
@d114 4
a117 8
assym.h: genassym
	./genassym > assym.h

genassym: genassym.o
	${HOSTCC} -o $@@ genassym.o

genassym.o: ${PPC}/powerpc/genassym.c
	${HOSTED_C}
@


1.1.1.1
log
@Check-in of powerpc kernel support.
NOTE: This will not work until the other pieces are checked in.
This is primarily the NetBSD powerpc port, with modifications
to support ELF. 
@
text
@@
