head	1.10;
access;
symbols
	OPENBSD_6_0:1.10.0.8
	OPENBSD_6_0_BASE:1.10
	OPENBSD_5_9:1.10.0.4
	OPENBSD_5_9_BASE:1.10
	OPENBSD_5_8:1.10.0.6
	OPENBSD_5_8_BASE:1.10
	OPENBSD_5_7:1.10.0.2
	OPENBSD_5_7_BASE:1.10
	OPENBSD_5_6:1.9.0.38
	OPENBSD_5_6_BASE:1.9
	OPENBSD_5_5:1.9.0.36
	OPENBSD_5_5_BASE:1.9
	OPENBSD_5_4:1.9.0.32
	OPENBSD_5_4_BASE:1.9
	OPENBSD_5_3:1.9.0.30
	OPENBSD_5_3_BASE:1.9
	OPENBSD_5_2:1.9.0.28
	OPENBSD_5_2_BASE:1.9
	OPENBSD_5_1_BASE:1.9
	OPENBSD_5_1:1.9.0.26
	OPENBSD_5_0:1.9.0.24
	OPENBSD_5_0_BASE:1.9
	OPENBSD_4_9:1.9.0.22
	OPENBSD_4_9_BASE:1.9
	OPENBSD_4_8:1.9.0.20
	OPENBSD_4_8_BASE:1.9
	OPENBSD_4_7:1.9.0.16
	OPENBSD_4_7_BASE:1.9
	OPENBSD_4_6:1.9.0.18
	OPENBSD_4_6_BASE:1.9
	OPENBSD_4_5:1.9.0.14
	OPENBSD_4_5_BASE:1.9
	OPENBSD_4_4:1.9.0.12
	OPENBSD_4_4_BASE:1.9
	OPENBSD_4_3:1.9.0.10
	OPENBSD_4_3_BASE:1.9
	OPENBSD_4_2:1.9.0.8
	OPENBSD_4_2_BASE:1.9
	OPENBSD_4_1:1.9.0.6
	OPENBSD_4_1_BASE:1.9
	OPENBSD_4_0:1.9.0.4
	OPENBSD_4_0_BASE:1.9
	OPENBSD_3_9:1.9.0.2
	OPENBSD_3_9_BASE:1.9
	OPENBSD_3_8:1.7.0.12
	OPENBSD_3_8_BASE:1.7
	OPENBSD_3_7:1.7.0.10
	OPENBSD_3_7_BASE:1.7
	OPENBSD_3_6:1.7.0.8
	OPENBSD_3_6_BASE:1.7
	SMP_SYNC_A:1.7
	SMP_SYNC_B:1.7
	OPENBSD_3_5:1.7.0.6
	OPENBSD_3_5_BASE:1.7
	OPENBSD_3_4:1.7.0.4
	OPENBSD_3_4_BASE:1.7
	UBC_SYNC_A:1.7
	OPENBSD_3_3:1.7.0.2
	OPENBSD_3_3_BASE:1.7
	OPENBSD_3_2:1.6.0.2
	OPENBSD_3_2_BASE:1.6
	OPENBSD_3_1:1.5.0.2
	OPENBSD_3_1_BASE:1.5
	UBC_SYNC_B:1.6
	UBC:1.3.0.4
	UBC_BASE:1.3
	OPENBSD_3_0:1.3.0.2
	OPENBSD_3_0_BASE:1.3
	OPENBSD_2_9:1.2.0.20
	OPENBSD_2_9_BASE:1.2
	OPENBSD_2_8:1.2.0.18
	OPENBSD_2_8_BASE:1.2
	OPENBSD_2_7:1.2.0.16
	OPENBSD_2_7_BASE:1.2
	SMP:1.2.0.14
	SMP_BASE:1.2
	kame_19991208:1.2
	OPENBSD_2_6:1.2.0.12
	OPENBSD_2_6_BASE:1.2
	OPENBSD_2_5:1.2.0.10
	OPENBSD_2_5_BASE:1.2
	OPENBSD_2_4:1.2.0.8
	OPENBSD_2_4_BASE:1.2
	OPENBSD_2_3:1.2.0.6
	OPENBSD_2_3_BASE:1.2
	OPENBSD_2_2:1.2.0.4
	OPENBSD_2_2_BASE:1.2
	OPENBSD_2_1:1.2.0.2
	OPENBSD_2_1_BASE:1.2
	powerpc_1:1.1.1.1;
locks; strict;
comment	@ * @;


1.10
date	2015.01.20.18.14.39;	author mpi;	state Exp;
branches;
next	1.9;
commitid	8WnzYhXBMG31iMGG;

1.9
date	2005.12.17.07.31.26;	author miod;	state Exp;
branches;
next	1.8;

1.8
date	2005.10.03.02.18.50;	author drahn;	state Exp;
branches;
next	1.7;

1.7
date	2003.01.30.15.38.09;	author drahn;	state Exp;
branches;
next	1.6;

1.6
date	2002.07.12.20.28.55;	author drahn;	state Exp;
branches;
next	1.5;

1.5
date	2002.03.14.01.26.42;	author millert;	state Exp;
branches;
next	1.4;

1.4
date	2002.03.13.18.27.36;	author drahn;	state Exp;
branches;
next	1.3;

1.3
date	2001.09.01.15.49.05;	author drahn;	state Exp;
branches
	1.3.4.1;
next	1.2;

1.2
date	96.12.28.06.25.25;	author rahnds;	state Exp;
branches
	1.2.14.1;
next	1.1;

1.1
date	96.12.21.20.35.55;	author rahnds;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	96.12.21.20.35.55;	author rahnds;	state Exp;
branches;
next	;

1.2.14.1
date	2001.10.31.03.07.55;	author nate;	state Exp;
branches;
next	1.2.14.2;

1.2.14.2
date	2001.11.13.22.14.34;	author niklas;	state dead;
branches;
next	1.2.14.3;

1.2.14.3
date	2002.03.29.16.11.59;	author niklas;	state Exp;
branches;
next	1.2.14.4;

1.2.14.4
date	2003.03.27.23.42.35;	author niklas;	state Exp;
branches;
next	;

1.3.4.1
date	2002.06.11.03.37.28;	author art;	state Exp;
branches;
next	1.3.4.2;

1.3.4.2
date	2002.10.29.00.28.08;	author art;	state Exp;
branches;
next	1.3.4.3;

1.3.4.3
date	2003.05.19.21.49.44;	author tedu;	state Exp;
branches;
next	;


desc
@@


1.10
log
@Nothing in this file requires <sys/queue.h>.  While here remove old and
unused typedef & external definitions.
@
text
@/*	$OpenBSD: pte.h,v 1.9 2005/12/17 07:31:26 miod Exp $	*/
/*	$NetBSD: pte.h,v 1.1 1996/09/30 16:34:32 ws Exp $	*/

/*-
 * Copyright (C) 1995, 1996 Wolfgang Solfrank.
 * Copyright (C) 1995, 1996 TooLs GmbH.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by TooLs GmbH.
 * 4. The name of TooLs GmbH may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY TOOLS GMBH ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL TOOLS GMBH BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
 * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

#ifndef	_POWERPC_PTE_H_
#define	_POWERPC_PTE_H_

/*
 * Page Table Entries
 */
#ifndef	_LOCORE
struct pte_32 {
	u_int32_t pte_hi;
	u_int32_t pte_lo;
};
struct pte_64 {
	u_int64_t pte_hi;
	u_int64_t pte_lo;
};
#endif	/* _LOCORE */

/* 32 bit */
/* High word: */
#define	PTE_VALID_32	0x80000000
#define	PTE_VSID_SHIFT_32	7
#define	PTE_HID_32	0x00000040
#define	PTE_API_32	0x0000003f
 /* Low word: */
#define	PTE_RPGN_32	0xfffff000
#define	PTE_REF_32	0x00000100
#define	PTE_CHG_32	0x00000080
#define	PTE_WIM_32	0x00000078
#define	PTE_W_32	0x00000040
#define	PTE_EXE_32	0x00000040 /* only used in pmap_attr, same as PTE_W */
#define	PTE_I_32	0x00000020
#define	PTE_M_32	0x00000010
#define	PTE_G_32	0x00000008
#define	PTE_PP_32	0x00000003
#define	PTE_RO_32	0x00000003
#define	PTE_RW_32	0x00000002


/* 64 bit */
/* High doubleword: */
#define	PTE_VALID_64		0x0000000000000001ULL
#define	PTE_AVPN_SHIFT_64	7
#define PTE_AVPN_64		0xffffffffffffff80ULL
#define PTE_API_SHIFT_64	7
#define PTE_API_64		0x0000000000000f80ULL
#define PTE_VSID_SHIFT_64  12
#define PTE_VSID_64		0xfffffffffffff000ULL
#define	PTE_HID_64		0x0000000000000002ULL
/* Low word: */
#define	PTE_RPGN_64		0x3ffffffffffff000ULL
#define	PTE_REF_64		0x0000000000000100ULL
#define	PTE_CHG_64		0x0000000000000080ULL
#define	PTE_WIMG_64		0x0000000000000078ULL
#define	PTE_W_64		0x0000000000000040ULL
#define PTE_EXE_64		PTE_W
#define	PTE_I_64		0x0000000000000020ULL
#define	PTE_M_64		0x0000000000000010ULL
#define	PTE_G_64		0x0000000000000008ULL
#define PTE_N_64		0x0000000000000004ULL
#define	PTE_PP_64		0x0000000000000003ULL
#define	PTE_RO_64		0x0000000000000003ULL
#define	PTE_RW_64		0x0000000000000002ULL

/*
 * Extract bits from address
 */
#define	ADDR_SR_SHIFT		28
#define	ADDR_PIDX		0x0ffff000
#define	ADDR_PIDX_SHIFT		12
#define	ADDR_API_SHIFT_32	22
#define	ADDR_API_SHIFT_64	16
#define	ADDR_POFF		0x00000fff

/*
 * Bits in DSISR:
 */
#define	DSISR_DIRECT	0x80000000
#define	DSISR_NOTFOUND	0x40000000
#define	DSISR_PROTECT	0x08000000
#define	DSISR_INVRX	0x04000000
#define	DSISR_STORE	0x02000000
#define	DSISR_DABR	0x00400000
#define	DSISR_SEGMENT	0x00200000
#define	DSISR_EAR	0x00100000

/*
 * Bits in SRR1 on ISI:
 */
#define	ISSRR1_NOTFOUND	0x40000000
#define	ISSRR1_DIRECT	0x10000000
#define	ISSRR1_PROTECT	0x08000000
#define	ISSRR1_SEGMENT	0x00200000

#endif	/* _POWERPC_PTE_H_ */
@


1.9
log
@Get rid of deprecated vm_{offset,size}_t types for good, use {p,v}{addr,size}_t
instead; looked at millert@@
@
text
@d1 1
a1 1
/*	$OpenBSD: pte.h,v 1.8 2005/10/03 02:18:50 drahn Exp $	*/
a37 2
#include <sys/queue.h>

a97 5
#ifndef	_LOCORE
typedef	struct pte_32 pte32_t;
typedef	struct pte_64 pte64_t;
#endif	/* _LOCORE */

a107 7
#ifndef	_LOCORE
#ifdef	_KERNEL
extern struct pte *ptable;
extern int ptab_cnt;
#endif	/* _KERNEL */
#endif	/* _LOCORE */

a127 6
#ifdef	_KERNEL
#ifndef	_LOCORE
extern u_int dsisr(void);
extern vaddr_t dar(void);
#endif	/* _KERNEL */
#endif	/* _LOCORE */
@


1.8
log
@G5 pmap support, most of this G5 work has been done by kettenis@@
without his forging ahead, it would barely be started.
Again this is one step of many, but needs to be tested, this is
independant of the locore change just committed which kettenis@@ and
deraadt@@ significantly wrote.
@
text
@d1 1
a1 1
/*	$OpenBSD: pte.h,v 1.7 2003/01/30 15:38:09 drahn Exp $	*/
d145 1
a145 1
extern vm_offset_t dar(void);
@


1.7
log
@Track if a physical page has been previously mapped executable. If it
has not been previously mapped EXE, flush it. If a writeable mapping
which is not executable occurs for the page, clear this bit.
Solves a problem where an executable page is double mapped, first without
EXE then accessed for execute at a different physical page, the cache
will behave properly.
@
text
@d1 1
a1 1
/*	$OpenBSD: pte.h,v 1.6 2002/07/12 20:28:55 drahn Exp $	*/
d44 7
a50 3
struct pte {
	u_int pte_hi;
	u_int pte_lo;
d53 2
d56 29
a84 4
#define	PTE_VALID	0x80000000
#define	PTE_VSID_SHIFT	7
#define	PTE_HID		0x00000040
#define	PTE_API		0x0000003f
d86 13
a98 12
#define	PTE_RPGN	0xfffff000
#define	PTE_REF		0x00000100
#define	PTE_CHG		0x00000080
#define	PTE_WIMG	0x00000078
#define	PTE_W		0x00000040
#define	PTE_EXE		0x00000040 /* only used in pmap_attr, same as PTE_W */
#define	PTE_I		0x00000020
#define	PTE_M		0x00000010
#define	PTE_G		0x00000008
#define	PTE_PP		0x00000003
#define	PTE_RO		0x00000003
#define	PTE_RW		0x00000002
d101 2
a102 1
typedef	struct pte pte_t;
d108 6
a113 5
#define	ADDR_SR_SHIFT	28
#define	ADDR_PIDX	0x0ffff000
#define	ADDR_PIDX_SHIFT	12
#define	ADDR_API_SHIFT	22
#define	ADDR_POFF	0x00000fff
@


1.6
log
@Cleanup: use less _t typedefs, use the structure itself.

pmap_t is the exception, it is required by the MI code so pmap_t will
be used instead of using 'struct pmap *' in the code.  (consistency)
@
text
@d1 1
a1 1
/*	$OpenBSD: pte.h,v 1.6 2002/07/12 20:26:10 drahn Exp $	*/
d60 1
@


1.5
log
@First round of __P removal in sys
@
text
@d1 1
a1 1
/*	$OpenBSD: pte.h,v 1.4 2002/03/13 18:27:36 drahn Exp $	*/
d82 1
a82 1
extern pte_t *ptable;
@


1.4
log
@Complete rewrite of the powerpc pmap handling, Instead of keeping
the spill list for each PTEG, the V->P translations are stored in
trees for each pmap. All valid kernel mappings are preallocated
in 1-1 memory so that tlb spill/loads for kernel accesses can be
looked up while physical, user mappings are not guaranteed to
be 1-1 mapped, thus the kernel must go virtual to look up user
mappings. While this is more expensive, the tree search is much
lower cost than the long linked list search. Also on each pmap_remove()
it was necessary to search the linked lists for each possible mapping,
now it just looks up the entry in the tree.
This change gives a 25-36% speedup in 'make build' time. What was
around 2:50 is now around 1:55 on a 733MHz G4.

This change causes a likely existing bug to appear quite often,
it deals with the segment register invalidation in kernel mode.
Because of that problem, currently this change limits the physical
memory used to 256MB. This limitation will be fixed soon, it is not
an error in the pmap code.

 * Effort sponsored in part by the Defense Advanced Research Projects
 * Agency (DARPA) and Air Force Research Laboratory, Air Force
 * Materiel Command, USAF, under agreement number F30602-01-2-0537.
@
text
@d1 1
a1 1
/*	$OpenBSD: pte.h,v 1.3 2001/09/01 15:49:05 drahn Exp $	*/
d109 2
a110 2
extern u_int dsisr __P((void));
extern vm_offset_t dar __P((void));
@


1.3
log
@The "powerpc" port which has supported the newer Apple Macintosh powerpc based
is being renamed to macppc. This is to allow sharing of common code
between different powerpc base platforms.

Most of the work involved in the renaming process was performed by miod@@

Files moved from powerpc/include to macppc/include
Some files were not "moved" but wrapper files were created which include
the powerpc/include version.

Several of the powerpc/include files where changed to reflect that they
are POWERPC_* not MACHINE_*.
@
text
@d1 1
a1 1
/*	$OpenBSD: pte.h,v 1.2 1996/12/28 06:25:25 rahnds Exp $	*/
d51 1
a51 1
#define	PTE_VSID_SHFT	7
d74 1
a74 1
#define	ADDR_SR_SHFT	28
d76 2
a77 2
#define	ADDR_PIDX_SHFT	12
#define	ADDR_API_SHFT	22
@


1.3.4.1
log
@Sync UBC branch to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: pte.h,v 1.3 2001/09/01 15:49:05 drahn Exp $	*/
d51 1
a51 1
#define	PTE_VSID_SHIFT	7
d74 1
a74 1
#define	ADDR_SR_SHIFT	28
d76 2
a77 2
#define	ADDR_PIDX_SHIFT	12
#define	ADDR_API_SHIFT	22
d109 2
a110 2
extern u_int dsisr(void);
extern vm_offset_t dar(void);
@


1.3.4.2
log
@sync to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: pte.h,v 1.3.4.1 2002/06/11 03:37:28 art Exp $	*/
d82 1
a82 1
extern struct pte *ptable;
@


1.3.4.3
log
@sync
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
a59 1
#define	PTE_EXE		0x00000040 /* only used in pmap_attr, same as PTE_W */
@


1.2
log
@adding OpenBSD tag to files.
@
text
@d1 1
a1 1
/*	$OpenBSD:$	*/
d35 2
a36 2
#ifndef	_MACHINE_PTE_H_
#define	_MACHINE_PTE_H_
d113 1
a113 1
#endif	/* _MACHINE_PTE_H_ */
@


1.2.14.1
log
@Sync the SMP branch to something just after 3.0
@
text
@d1 1
a1 1
/*	$OpenBSD: pte.h,v 1.2 1996/12/28 06:25:25 rahnds Exp $	*/
d35 2
a36 2
#ifndef	_POWERPC_PTE_H_
#define	_POWERPC_PTE_H_
d113 1
a113 1
#endif	/* _POWERPC_PTE_H_ */
@


1.2.14.2
log
@repair
@
text
@d1 1
a1 1
/*	$OpenBSD: pte.h,v 1.2.14.1 2001/10/31 03:07:55 nate Exp $	*/
@


1.2.14.3
log
@Re-add missing pieces
@
text
@d1 1
a1 1
/*	$OpenBSD: pte.h,v 1.5 2002/03/14 01:26:42 millert Exp $	*/
d51 1
a51 1
#define	PTE_VSID_SHIFT	7
d74 1
a74 1
#define	ADDR_SR_SHIFT	28
d76 2
a77 2
#define	ADDR_PIDX_SHIFT	12
#define	ADDR_API_SHIFT	22
d109 2
a110 2
extern u_int dsisr(void);
extern vm_offset_t dar(void);
@


1.2.14.4
log
@Sync the SMP branch with 3.3
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
a59 1
#define	PTE_EXE		0x00000040 /* only used in pmap_attr, same as PTE_W */
d82 1
a82 1
extern struct pte *ptable;
@


1.1
log
@Initial revision
@
text
@d1 1
@


1.1.1.1
log
@Check-in of powerpc kernel support.
NOTE: This will not work until the other pieces are checked in.
This is primarily the NetBSD powerpc port, with modifications
to support ELF. 
@
text
@@
