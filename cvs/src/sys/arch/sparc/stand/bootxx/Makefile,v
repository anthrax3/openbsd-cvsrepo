head	1.14;
access;
symbols
	OPENBSD_6_0:1.13.0.6
	OPENBSD_6_0_BASE:1.13
	OPENBSD_5_9:1.13.0.2
	OPENBSD_5_9_BASE:1.13
	OPENBSD_5_8:1.13.0.4
	OPENBSD_5_8_BASE:1.13
	OPENBSD_5_7:1.12.0.2
	OPENBSD_5_7_BASE:1.12
	OPENBSD_5_6:1.12.0.6
	OPENBSD_5_6_BASE:1.12
	OPENBSD_5_5:1.12.0.4
	OPENBSD_5_5_BASE:1.12
	OPENBSD_5_4:1.11.0.4
	OPENBSD_5_4_BASE:1.11
	OPENBSD_5_3:1.11.0.2
	OPENBSD_5_3_BASE:1.11
	OPENBSD_5_2:1.9.0.20
	OPENBSD_5_2_BASE:1.9
	OPENBSD_5_1_BASE:1.9
	OPENBSD_5_1:1.9.0.18
	OPENBSD_5_0:1.9.0.16
	OPENBSD_5_0_BASE:1.9
	OPENBSD_4_9:1.9.0.14
	OPENBSD_4_9_BASE:1.9
	OPENBSD_4_8:1.9.0.12
	OPENBSD_4_8_BASE:1.9
	OPENBSD_4_7:1.9.0.8
	OPENBSD_4_7_BASE:1.9
	OPENBSD_4_6:1.9.0.10
	OPENBSD_4_6_BASE:1.9
	OPENBSD_4_5:1.9.0.6
	OPENBSD_4_5_BASE:1.9
	OPENBSD_4_4:1.9.0.4
	OPENBSD_4_4_BASE:1.9
	OPENBSD_4_3:1.9.0.2
	OPENBSD_4_3_BASE:1.9
	OPENBSD_4_2:1.7.0.18
	OPENBSD_4_2_BASE:1.7
	OPENBSD_4_1:1.7.0.16
	OPENBSD_4_1_BASE:1.7
	OPENBSD_4_0:1.7.0.14
	OPENBSD_4_0_BASE:1.7
	OPENBSD_3_9:1.7.0.12
	OPENBSD_3_9_BASE:1.7
	OPENBSD_3_8:1.7.0.10
	OPENBSD_3_8_BASE:1.7
	OPENBSD_3_7:1.7.0.8
	OPENBSD_3_7_BASE:1.7
	OPENBSD_3_6:1.7.0.6
	OPENBSD_3_6_BASE:1.7
	SMP_SYNC_A:1.7
	SMP_SYNC_B:1.7
	OPENBSD_3_5:1.7.0.4
	OPENBSD_3_5_BASE:1.7
	OPENBSD_3_4:1.7.0.2
	OPENBSD_3_4_BASE:1.7
	UBC_SYNC_A:1.6
	OPENBSD_3_3:1.6.0.4
	OPENBSD_3_3_BASE:1.6
	OPENBSD_3_2:1.6.0.2
	OPENBSD_3_2_BASE:1.6
	OPENBSD_3_1:1.5.0.24
	OPENBSD_3_1_BASE:1.5
	UBC_SYNC_B:1.6
	UBC:1.5.0.22
	UBC_BASE:1.5
	OPENBSD_3_0:1.5.0.20
	OPENBSD_3_0_BASE:1.5
	OPENBSD_2_9_BASE:1.5
	OPENBSD_2_9:1.5.0.18
	OPENBSD_2_8:1.5.0.16
	OPENBSD_2_8_BASE:1.5
	OPENBSD_2_7:1.5.0.14
	OPENBSD_2_7_BASE:1.5
	SMP:1.5.0.12
	SMP_BASE:1.5
	kame_19991208:1.5
	OPENBSD_2_6:1.5.0.10
	OPENBSD_2_6_BASE:1.5
	OPENBSD_2_5:1.5.0.8
	OPENBSD_2_5_BASE:1.5
	OPENBSD_2_4:1.5.0.6
	OPENBSD_2_4_BASE:1.5
	OPENBSD_2_3:1.5.0.4
	OPENBSD_2_3_BASE:1.5
	OPENBSD_2_2:1.5.0.2
	OPENBSD_2_2_BASE:1.5
	OPENBSD_2_1:1.4.0.2
	OPENBSD_2_1_BASE:1.4
	OPENBSD_2_0:1.3.0.2
	OPENBSD_2_0_BASE:1.3
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@# @;


1.14
date	2016.07.30.03.25.49;	author guenther;	state Exp;
branches;
next	1.13;
commitid	HVbAtwruDlJazNH2;

1.13
date	2015.03.17.19.59.39;	author miod;	state Exp;
branches;
next	1.12;
commitid	bnQfW6TFiNm5GvW1;

1.12
date	2013.11.03.21.36.44;	author deraadt;	state Exp;
branches;
next	1.11;

1.11
date	2012.09.02.23.23.51;	author pascal;	state Exp;
branches;
next	1.10;

1.10
date	2012.08.21.14.46.19;	author pascal;	state Exp;
branches;
next	1.9;

1.9
date	2007.11.25.18.25.33;	author deraadt;	state Exp;
branches;
next	1.8;

1.8
date	2007.10.30.06.03.16;	author deraadt;	state Exp;
branches;
next	1.7;

1.7
date	2003.08.11.06.35.45;	author deraadt;	state Exp;
branches;
next	1.6;

1.6
date	2002.08.11.23.11.22;	author art;	state Exp;
branches;
next	1.5;

1.5
date	97.09.17.10.46.16;	author downsj;	state Exp;
branches
	1.5.12.1
	1.5.22.1;
next	1.4;

1.4
date	97.04.27.20.56.38;	author millert;	state Exp;
branches;
next	1.3;

1.3
date	96.09.29.10.29.52;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	96.08.11.05.35.36;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.51.49;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.51.49;	author deraadt;	state Exp;
branches;
next	;

1.5.12.1
date	2003.03.27.23.49.26;	author niklas;	state Exp;
branches;
next	1.5.12.2;

1.5.12.2
date	2004.02.19.10.49.59;	author niklas;	state Exp;
branches;
next	;

1.5.22.1
date	2002.10.29.00.28.11;	author art;	state Exp;
branches;
next	;


desc
@@


1.14
log
@Prep for relro: make sure it's off for any non-PIE stand/ program

ok millert@@ kettenis@@
@
text
@#	$OpenBSD: Makefile,v 1.13 2015/03/17 19:59:39 miod Exp $
#	$NetBSD: Makefile,v 1.2 1995/09/30 21:43:38 pk Exp $

.PATH:	${.CURDIR}/../common

PROG=	bootxx

NOMAN=	noman
INSTALL_STRIP=
S=	${.CURDIR}/../../../..

SRCS=	srt0.S bootxx.c closeall.c dvma.c promdev.c
CLEANFILES+=${PROG}.aout ${PROG}.elf elfclean

.PATH:	${S}/lib/libkern/arch/sparc ${S}/lib/libkern
SRCS+=	__main.o bzero.o urem.o udiv.o

.PATH:	${S}/lib/libsa
SRCS+=	printf.c

# pre-built bits of libsa
SOBJS=	alloc.o exit.o memcpy.o memset.o
_SOBJS=${SOBJS:S,^,${LIBSAOBJDIR}/,g}

CFLAGS= -fno-pie -O2 -I${.CURDIR}/../common -I${.CURDIR}/../../../../arch \
	-I${.CURDIR}/../../../.. -I${.CURDIR}/../../../../lib/libsa -DBOOTXX \
	${DEFS}
AFLAGS+=-fno-pie

elfclean: clean-elf.c
	${HOSTCC} -o elfclean ${.ALLSRC}

${PROG}: ${OBJS} elfclean
	${LD} -nopie -znorelro -N -Ttext ${RELOC} -e start ${OBJS} ${_SOBJS} \
	    -o ${.TARGET}.elf
	./elfclean ${.TARGET}.elf
	objcopy -j .text -j .data -j .bss -O a.out-sparc-netbsd \
	    ${.TARGET}.elf ${.TARGET}.aout
	(echo -n 01 | tr 01 '\01\03'; tail +3c ${.TARGET}.aout) > ${.TARGET}
	@@rm ${.TARGET}.aout ${.TARGET}.elf

srt0.o: srt0.S
	${CC} ${CFLAGS} -D_LOCORE -c ${.IMPSRC}

.include <bsd.prog.mk>
# for libsa printf
DEFS+=	-DSTRIPPED
@


1.13
log
@The innocuous change to libsa printf.c (1.26) causes printf.o to be 240 bytes
of text larger, and puts bootxx past the 7680 bytes limit.

Since bootxx only needs printf for very simple panic() message involving %s
and %d format specifiers only, compile a -DSTRIPPED version of printf.c for
the use of bootxx. This makes bootxx return to a manageable size (it is even
8 bytes shorter now).
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.12 2013/11/03 21:36:44 deraadt Exp $
d34 1
a34 1
	${LD} -nopie -N -Ttext ${RELOC} -e start ${OBJS} ${_SOBJS} \
@


1.12
log
@size no longer has a.out knowledge, so .. skip it
found by tobiasu
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.11 2012/09/02 23:23:51 pascal Exp $
d18 3
d22 1
a22 1
SOBJS=	alloc.o exit.o printf.o memcpy.o memset.o
d46 2
@


1.11
log
@sparc -nopie conversion, tested by and ok deraadt@@.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.10 2012/08/21 14:46:19 pascal Exp $
a35 1
	@@size ${.TARGET}.aout
@


1.10
log
@Add NOPIE= bits for sys/arch/*/stand to ensure that bootblocks will always be
built with -fno-pie.  This gets the hairiest part of PIE out of the way ...

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.9 2007/11/25 18:25:33 deraadt Exp $
a8 1
NOPIE=
d22 1
a22 1
CFLAGS= -O2 -I${.CURDIR}/../common -I${.CURDIR}/../../../../arch \
d25 1
d31 2
a32 1
	${LD} -N -Ttext ${RELOC} -e start ${OBJS} ${_SOBJS} -o ${.TARGET}.elf
@


1.9
log
@libkern, begone.  Move to a new mechanism where config(8)'s "file"
directive can select between MI and MD versions of these files.  At
the same time, adjust the boot programs to pick exactly what they need,
instead of the 7 or 8 mechanisms previously used.

There will be some fallout from this, but testing it all by myself is a
ridiculously slow process; it will be finished in-tree.

Various developers were very nice and avoided making fun of me when I
was gibbering in the corner..
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.8 2007/10/30 06:03:16 deraadt Exp $
d9 1
@


1.8
log
@avoid intermediate files with same name (ie. a.out) for parallel make
ok miod
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.7 2003/08/11 06:35:45 deraadt Exp $
d10 1
d15 3
a17 3
# pre-built bits of libkern
KOBJS=	__main.o bzero.o urem.o udiv.o
_KOBJS=${KOBJS:S,^,${LIBKERNOBJDIR}/,g}
d30 1
a30 1
	${LD} -N -Ttext ${RELOC} -e start ${OBJS} ${_SOBJS} ${_KOBJS} -o ${.TARGET}.elf
@


1.7
log
@better cleaning
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.6 2002/08/11 23:11:22 art Exp $
d12 1
a12 1
CLEANFILES+=${PROG}.aout ${PROG}.elf elfclean elf
d29 7
a35 6
	${LD} -N -Ttext ${RELOC} -e start ${OBJS} ${_SOBJS} ${_KOBJS} -o elf
	./elfclean elf
	objcopy -j .text -j .data -j .bss -O a.out-sparc-netbsd elf a.out
	@@size a.out
	(echo -n 01 | tr 01 '\01\03'; tail +3c a.out) > ${.TARGET}
	@@rm a.out
@


1.6
log
@ELF support in sparc bootblocks.
Loadfile is from alpha, but heaviliy hacked here.
The build is done by building elf versions of boot and bootxx, then
merging the .rodata and .text sections into .text with a horrible hack
and then using objcopy to convert that into a.out.

Maybe someone will want to fix installboot to deal with ELF instead, but
I won't be that someone in the nearest future.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.5 1997/09/17 10:46:16 downsj Exp $
d12 1
a12 1
CLEANFILES+=${PROG}.aout ${PROG}.elf
@


1.5
log
@Reorganizaed bootblocks.  Builds like hp300 now.
@
text
@d1 1
a1 1
#	$OpenBSD$
d12 1
d25 7
a31 3
${PROG}: ${OBJS}
	${LD} -N -T ${RELOC} -e start ${OBJS} ${_SOBJS} ${_KOBJS}
	# convert to Sun magic
@


1.5.12.1
log
@Sync the SMP branch with 3.3
@
text
@a11 1
CLEANFILES+=${PROG}.aout ${PROG}.elf
d24 3
a26 7
elfclean: clean-elf.c
	${HOSTCC} -o elfclean ${.ALLSRC}

${PROG}: ${OBJS} elfclean
	${LD} -N -Ttext ${RELOC} -e start ${OBJS} ${_SOBJS} ${_KOBJS} -o elf
	./elfclean elf
	objcopy -j .text -j .data -j .bss -O a.out-sparc-netbsd elf a.out
@


1.5.12.2
log
@Merge of current from two weeks agointo the SMP branch
@
text
@d12 1
a12 1
CLEANFILES+=${PROG}.aout ${PROG}.elf elfclean elf
@


1.5.22.1
log
@sync to -current
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.5 1997/09/17 10:46:16 downsj Exp $
a11 1
CLEANFILES+=${PROG}.aout ${PROG}.elf
d24 3
a26 7
elfclean: clean-elf.c
	${HOSTCC} -o elfclean ${.ALLSRC}

${PROG}: ${OBJS} elfclean
	${LD} -N -Ttext ${RELOC} -e start ${OBJS} ${_SOBJS} ${_KOBJS} -o elf
	./elfclean elf
	objcopy -j .text -j .data -j .bss -O a.out-sparc-netbsd elf a.out
@


1.4
log
@COPY -> INSTALL_COPY and STRIP -> INSTALL_STRIP
This fixes namespace problems where STRIP is sometimes used as
the name of the strip(1) to use and other times used as
the flag to send install(1) when stripping (or not).
COPY doesn't have this problem (yet) but was poorly named.
@
text
@d1 4
a4 1
#	$NetBSD: Makefile,v 1.5 1995/10/10 20:07:54 pk Exp $
a5 2
R=	..
.PATH:	${.CURDIR}/${R}
d7 7
a13 1
SRCS=	srt0.S bootxx.c promdev.c dvma.c
d15 4
a18 4
NOMAN=	1
INSTALL_STRIP=
BINDIR=	/usr/mdec
CFLAGS= -DBOOTXX
d20 3
a22 3
LIBS!=	cd ${.CURDIR}/${R}; ${MAKE} sadep
KOBJDIR!= cd ${.CURDIR}/${R}; ${MAKE} kernlibdir
_KOBJS=${KOBJS:S,^,${KOBJDIR}/,g}
d24 2
a25 2
${PROG}:${OBJS} ${_KOBJS} ${LIBS}
	${LD} -N -T ${RELOC} -e start ${OBJS} ${_KOBJS} ${LIBS}
d30 3
@


1.3
log
@size correct thing
@
text
@d9 1
a9 1
STRIP=
@


1.2
log
@netbsd port, now we merge our changes back in
@
text
@d20 1
a22 1
	@@size ${.TARGET}
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
#	$NetBSD: Makefile,v 1.4.2.1 1995/10/13 19:55:36 pk Exp $
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
