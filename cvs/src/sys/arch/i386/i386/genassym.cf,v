head	1.39;
access;
symbols
	OPENBSD_6_2:1.39.0.4
	OPENBSD_6_2_BASE:1.39
	OPENBSD_6_1:1.39.0.6
	OPENBSD_6_1_BASE:1.39
	OPENBSD_6_0:1.39.0.2
	OPENBSD_6_0_BASE:1.39
	OPENBSD_5_9:1.37.0.2
	OPENBSD_5_9_BASE:1.37
	OPENBSD_5_8:1.37.0.4
	OPENBSD_5_8_BASE:1.37
	OPENBSD_5_7:1.36.0.2
	OPENBSD_5_7_BASE:1.36
	OPENBSD_5_6:1.35.0.4
	OPENBSD_5_6_BASE:1.35
	OPENBSD_5_5:1.34.0.14
	OPENBSD_5_5_BASE:1.34
	OPENBSD_5_4:1.34.0.10
	OPENBSD_5_4_BASE:1.34
	OPENBSD_5_3:1.34.0.8
	OPENBSD_5_3_BASE:1.34
	OPENBSD_5_2:1.34.0.6
	OPENBSD_5_2_BASE:1.34
	OPENBSD_5_1_BASE:1.34
	OPENBSD_5_1:1.34.0.4
	OPENBSD_5_0:1.34.0.2
	OPENBSD_5_0_BASE:1.34
	OPENBSD_4_9:1.32.0.2
	OPENBSD_4_9_BASE:1.32
	OPENBSD_4_8:1.31.0.2
	OPENBSD_4_8_BASE:1.31
	OPENBSD_4_7:1.29.0.2
	OPENBSD_4_7_BASE:1.29
	OPENBSD_4_6:1.29.0.4
	OPENBSD_4_6_BASE:1.29
	OPENBSD_4_5:1.28.0.6
	OPENBSD_4_5_BASE:1.28
	OPENBSD_4_4:1.28.0.4
	OPENBSD_4_4_BASE:1.28
	OPENBSD_4_3:1.28.0.2
	OPENBSD_4_3_BASE:1.28
	OPENBSD_4_2:1.26.0.2
	OPENBSD_4_2_BASE:1.26
	OPENBSD_4_1:1.25.0.2
	OPENBSD_4_1_BASE:1.25
	OPENBSD_4_0:1.24.0.2
	OPENBSD_4_0_BASE:1.24
	OPENBSD_3_9:1.23.0.2
	OPENBSD_3_9_BASE:1.23
	OPENBSD_3_8:1.21.0.2
	OPENBSD_3_8_BASE:1.21
	OPENBSD_3_7:1.19.0.2
	OPENBSD_3_7_BASE:1.19
	OPENBSD_3_6:1.18.0.2
	OPENBSD_3_6_BASE:1.18
	SMP_SYNC_A:1.13
	SMP_SYNC_B:1.13
	OPENBSD_3_5:1.13.0.4
	OPENBSD_3_5_BASE:1.13
	OPENBSD_3_4:1.13.0.2
	OPENBSD_3_4_BASE:1.13
	UBC_SYNC_A:1.12
	OPENBSD_3_3:1.12.0.8
	OPENBSD_3_3_BASE:1.12
	OPENBSD_3_2:1.12.0.6
	OPENBSD_3_2_BASE:1.12
	OPENBSD_3_1:1.12.0.4
	OPENBSD_3_1_BASE:1.12
	UBC_SYNC_B:1.12
	UBC:1.12.0.2
	UBC_BASE:1.12
	OPENBSD_3_0:1.10.0.2
	OPENBSD_3_0_BASE:1.10
	OPENBSD_2_9:1.8.0.2
	OPENBSD_2_9_BASE:1.8
	OPENBSD_2_8:1.7.0.10
	OPENBSD_2_8_BASE:1.7
	OPENBSD_2_7:1.7.0.8
	OPENBSD_2_7_BASE:1.7
	SMP:1.7.0.6
	SMP_BASE:1.7
	kame_19991208:1.7
	OPENBSD_2_6:1.7.0.4
	OPENBSD_2_6_BASE:1.7
	OPENBSD_2_5:1.7.0.2
	OPENBSD_2_5_BASE:1.7
	OPENBSD_2_4:1.6.0.4
	OPENBSD_2_4_BASE:1.6
	OPENBSD_2_3:1.6.0.2
	OPENBSD_2_3_BASE:1.6
	OPENBSD_2_2:1.5.0.2
	OPENBSD_2_2_BASE:1.5
	OPENBSD_2_1:1.1.0.2
	OPENBSD_2_1_BASE:1.1;
locks; strict;
comment	@# @;


1.39
date	2016.03.15.03.17.51;	author guenther;	state Exp;
branches;
next	1.38;
commitid	hTA8iQcFPhTNwQXL;

1.38
date	2016.02.28.15.46.18;	author naddy;	state Exp;
branches;
next	1.37;
commitid	iOuZImHZRAr7Hvd6;

1.37
date	2015.04.12.18.37.53;	author mlarkin;	state Exp;
branches;
next	1.36;
commitid	5ST94uMTezmXYdhY;

1.36
date	2014.12.22.02.26.53;	author tedu;	state Exp;
branches;
next	1.35;
commitid	2Ez9mHW0jDzojG4V;

1.35
date	2014.07.22.10.35.34;	author mpi;	state Exp;
branches;
next	1.34;
commitid	EXpEDqO4x724IPl8;

1.34
date	2011.07.04.22.53.53;	author tedu;	state Exp;
branches;
next	1.33;

1.33
date	2011.04.05.12.50.15;	author guenther;	state Exp;
branches;
next	1.32;

1.32
date	2010.09.24.13.21.30;	author matthew;	state Exp;
branches;
next	1.31;

1.31
date	2010.07.03.04.54.32;	author kettenis;	state Exp;
branches;
next	1.30;

1.30
date	2010.04.01.19.48.50;	author kettenis;	state Exp;
branches;
next	1.29;

1.29
date	2009.06.03.00.49.12;	author art;	state Exp;
branches;
next	1.28;

1.28
date	2007.10.10.15.53.51;	author art;	state Exp;
branches;
next	1.27;

1.27
date	2007.10.03.07.51.26;	author kettenis;	state Exp;
branches;
next	1.26;

1.26
date	2007.04.03.10.14.47;	author art;	state Exp;
branches;
next	1.25;

1.25
date	2007.02.20.21.15.01;	author tom;	state Exp;
branches;
next	1.24;

1.24
date	2006.04.27.15.37.50;	author mickey;	state Exp;
branches;
next	1.23;

1.23
date	2006.01.12.22.39.20;	author weingart;	state Exp;
branches;
next	1.22;

1.22
date	2005.11.23.16.51.28;	author mickey;	state Exp;
branches;
next	1.21;

1.21
date	2005.07.18.14.55.49;	author mickey;	state Exp;
branches
	1.21.2.1;
next	1.20;

1.20
date	2005.05.21.19.13.55;	author brad;	state Exp;
branches;
next	1.19;

1.19
date	2004.12.24.21.22.00;	author pvalchev;	state Exp;
branches
	1.19.2.1;
next	1.18;

1.18
date	2004.07.20.20.16.44;	author art;	state Exp;
branches;
next	1.17;

1.17
date	2004.07.02.16.29.55;	author niklas;	state Exp;
branches;
next	1.16;

1.16
date	2004.06.28.02.00.20;	author deraadt;	state Exp;
branches;
next	1.15;

1.15
date	2004.06.28.01.41.52;	author aaron;	state Exp;
branches;
next	1.14;

1.14
date	2004.06.13.21.49.15;	author niklas;	state Exp;
branches;
next	1.13;

1.13
date	2003.06.02.23.27.47;	author millert;	state Exp;
branches;
next	1.12;

1.12
date	2001.12.01.13.07.24;	author ho;	state Exp;
branches;
next	1.11;

1.11
date	2001.11.06.19.53.14;	author miod;	state Exp;
branches;
next	1.10;

1.10
date	2001.09.16.14.28.04;	author miod;	state Exp;
branches;
next	1.9;

1.9
date	2001.05.05.23.25.36;	author art;	state Exp;
branches;
next	1.8;

1.8
date	2001.03.22.23.36.51;	author niklas;	state Exp;
branches;
next	1.7;

1.7
date	99.02.26.04.28.50;	author art;	state Exp;
branches
	1.7.6.1;
next	1.6;

1.6
date	97.12.09.03.36.39;	author deraadt;	state Exp;
branches;
next	1.5;

1.5
date	97.10.19.06.34.23;	author mickey;	state Exp;
branches;
next	1.4;

1.4
date	97.10.18.00.33.12;	author weingart;	state Exp;
branches;
next	1.3;

1.3
date	97.09.29.03.42.26;	author mickey;	state Exp;
branches;
next	1.2;

1.2
date	97.09.21.04.27.54;	author mickey;	state Exp;
branches;
next	1.1;

1.1
date	97.03.29.07.12.07;	author tholo;	state Exp;
branches;
next	;

1.7.6.1
date	2001.04.18.16.07.18;	author niklas;	state Exp;
branches;
next	1.7.6.2;

1.7.6.2
date	2001.07.04.10.16.34;	author niklas;	state Exp;
branches;
next	1.7.6.3;

1.7.6.3
date	2001.07.14.10.02.24;	author ho;	state Exp;
branches;
next	1.7.6.4;

1.7.6.4
date	2001.10.31.03.01.12;	author nate;	state Exp;
branches;
next	1.7.6.5;

1.7.6.5
date	2001.11.13.21.00.51;	author niklas;	state Exp;
branches;
next	1.7.6.6;

1.7.6.6
date	2001.11.14.14.45.07;	author ho;	state Exp;
branches;
next	1.7.6.7;

1.7.6.7
date	2001.12.05.00.39.10;	author niklas;	state Exp;
branches;
next	1.7.6.8;

1.7.6.8
date	2003.04.11.16.12.56;	author niklas;	state Exp;
branches;
next	1.7.6.9;

1.7.6.9
date	2003.05.15.04.08.01;	author niklas;	state Exp;
branches;
next	1.7.6.10;

1.7.6.10
date	2003.06.07.11.11.37;	author ho;	state Exp;
branches;
next	1.7.6.11;

1.7.6.11
date	2004.03.23.08.01.17;	author niklas;	state Exp;
branches;
next	1.7.6.12;

1.7.6.12
date	2004.04.06.13.31.05;	author niklas;	state Exp;
branches;
next	;

1.19.2.1
date	2006.01.13.00.49.21;	author brad;	state Exp;
branches;
next	;

1.21.2.1
date	2006.01.13.01.56.54;	author brad;	state Exp;
branches;
next	;


desc
@@


1.39
log
@Burn more LDT deadwood: stop allocating one for each idle thread,
load the ldt register with the null selector (disabling use of it),
stop reloading it on every context switch, and blow away the table
itself, as well as the pcb and pmap bits that were used to track
it (making sure to keep pcb_savefpu correctly aligned).

testing naddy@@
ok kettenis@@ mpi@@ mlarkin@@
@
text
@#	$OpenBSD: genassym.cf,v 1.38 2016/02/28 15:46:18 naddy Exp $
#
# Copyright (c) 1982, 1990 The Regents of the University of California.
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. Neither the name of the University nor the names of its contributors
#    may be used to endorse or promote products derived from this software
#    without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.
#
#	@@(#)genassym.c	7.8 (Berkeley) 5/7/91
#

include <sys/param.h>
include <sys/proc.h>
include <sys/resourcevar.h>
include <sys/device.h>
include <sys/user.h>
include <sys/mbuf.h>
include <sys/socketvar.h>
include <netinet/in.h>
include <netinet/ip.h>
include <netinet/ip_var.h>

include <uvm/uvm_extern.h>

include <machine/trap.h>
include <machine/pmap.h>
include <machine/vmparam.h>
include <machine/mutex.h>

if MULTIPROCESSOR
include <machine/cpu.h>
endif

include "isa.h"
if NISA > 0
include <i386/isa/isa_machdep.h>
endif

export	SRUN
export	SONPROC

# values for page tables
export	PDSLOT_KERN
export	PDSLOT_PTE
export	PDSLOT_APTE
export	NKPTP_MIN

# values for virtual memory
export	VM_MAXUSER_ADDRESS

# proc fields and values
struct	proc
member	p_addr
member	p_priority
member	p_stat
member	p_wchan
member	p_vmspace
member	p_flag
member	p_cpu
member	P_MD_ASTPENDING	p_md.md_astpending

export	P_SYSTEM

# interrupt/fault metering
struct	uvmexp		V_
member	TRAP		traps
member	INTR		intrs

# pcb fields
struct	pcb
member	pcb_cr3
member	pcb_ebp
member	pcb_esp
member	pcb_cr0
member	pcb_onfault
member	pcb_fpcpu
member	pcb_flags
member	pcb_pmap
export	PCB_SAVECTX

# frame definitions
struct	trapframe
member	tf_cs
member	tf_trapno
member	tf_eflags
member	tf_eip
member	tf_err
member	tf_eax
member	tf_esp
define	FRAMESIZE	sizeof(struct trapframe)

# interrupt frame definitions
struct intrframe
member if_ppl

# signal handling
struct	sigframe	SIGF_
member	HANDLER		sf_handler
member	SC		sf_sc
struct	sigcontext

# mbuf fields
struct	mbuf
member	m_next
member	m_data
member	m_len

# Interrupt metering
if NISA > 0
struct	intrhand
member	ih_fun
member	ih_arg
member	IH_COUNT		ih_count.ec_count
member	ih_next
endif

struct mutex
member	mtx_lock
member	mtx_wantipl
member	mtx_oldipl
member	mtx_owner

define	IP_SRC			offsetof(struct ip, ip_src)
define	IP_DST			offsetof(struct ip, ip_dst)

define	P_MD_TSS_SEL		offsetof(struct proc, p_md.md_tss_sel)

define	CPU_INFO_SELF		offsetof(struct cpu_info, ci_self)
define	CPU_INFO_APICID		offsetof(struct cpu_info, ci_apicid)
define	CPU_INFO_CURPROC	offsetof(struct cpu_info, ci_curproc)
define	CPU_INFO_CURPCB		offsetof(struct cpu_info, ci_curpcb)
define	CPU_INFO_NAME		offsetof(struct cpu_info, ci_dev.dv_xname)
define	CPU_INFO_IDLE_PCB	offsetof(struct cpu_info, ci_idle_pcb)
define	CPU_INFO_IDLE_TSS_SEL	offsetof(struct cpu_info, ci_idle_tss_sel)
define	CPU_INFO_LEVEL		offsetof(struct cpu_info, ci_level)
define	CPU_INFO_VENDOR		offsetof(struct cpu_info, ci_vendor[0])
define	CPU_INFO_SIGNATURE	offsetof(struct cpu_info, ci_signature)
define	CPU_INFO_RESCHED	offsetof(struct cpu_info, ci_want_resched)
define	CPU_INFO_GDT		offsetof(struct cpu_info, ci_gdt)
define	CPU_INFO_IPENDING	offsetof(struct cpu_info, ci_ipending)
define	CPU_INFO_IMASK		offsetof(struct cpu_info, ci_imask)
define	CPU_INFO_IUNMASK	offsetof(struct cpu_info, ci_iunmask)
define	CPU_INFO_ILEVEL		offsetof(struct cpu_info, ci_ilevel)
define	CPU_INFO_IDEPTH		offsetof(struct cpu_info, ci_idepth)
define	CPU_INFO_ISOURCES	offsetof(struct cpu_info, ci_isources)
ifdef DIAGNOSTIC
define	CPU_INFO_MUTEX_LEVEL	offsetof(struct cpu_info, ci_mutex_level)
endif
define	CPU_INFO_CURPMAP	offsetof(struct cpu_info, ci_curpmap)

struct pmap
member pm_pdirpa

define	SIZEOF_CPU_INFO		sizeof(struct cpu_info)

@


1.38
log
@Support for running Linux binaries under emulation is going away.

Remove "option COMPAT_LINUX" and everything directly tied to it from the
kernel and the corresponding man page documentation.

ok visa@@ guenther@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.37 2015/04/12 18:37:53 mlarkin Exp $
a95 2
member	pcb_ldt
member	pcb_ldt_sel
@


1.37
log
@
Bring PAE code back to life, in a different form. This diff (via bluhm then
to deraadt, then myself) brings the PAE pmap on i386 (not touched in any
significant way for years) closer to the current non-PAE pmap and allows
us to take a big next step toward better i386 W^X in the kernel (similar to
what we did a few months ago on amd64). Unlike the original PAE pmap, this
diff will not be supporting > 4GB physical memory on i386 - this effort is
specifically geared toward providing W^X (via NX) only.

There still seems to be a bug removing certain pmap entries when PAE is
enabled, so I'm leaving PAE mode disabled for the moment until we can
figure out what is going on, but with this diff in the tree hopefully
others can help.

The pmap functions now operate through function pointers, due to the need
to support both non-PAE and PAE forms. My unscientific testing showed
less than 0.3% (a third of a percent) slowdown with this approach during
a base build.

Discussed for months with guenther, kettenis, and deraadt.

ok kettenis@@, deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.36 2014/12/22 02:26:53 tedu Exp $
a50 4
if COMPAT_LINUX > 0
include <machine/linux_machdep.h>
endif

a129 8

# Linux frame offsets
ifdef COMPAT_LINUX
struct	linux_sigframe		LINUX_SIGF_
member	HANDLER			sf_handler
member	SC			sf_sc
struct	linux_sigcontext	LINUX_
endif
@


1.36
log
@unifdef INET
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.35 2014/07/22 10:35:34 mpi Exp $
a71 1
export	NKPTP_MAX
@


1.35
log
@<netinet/in_systm.h> is no longer needed.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.34 2011/07/04 22:53:53 tedu Exp $
a37 1
ifdef INET
a42 1
endif
a130 1
ifdef INET
a134 1
endif
@


1.34
log
@remove compat_svr4 support.  ok deraadt
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.33 2011/04/05 12:50:15 guenther Exp $
a41 1
include <netinet/in_systm.h>
@


1.33
log
@Push COMPAT_FREEBSD in front of a whale.  Buggy, out of date, no
one has been weeding it, and it makes life harder.

Toasts of Brennivin for its passing from many; diff ok henning@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.32 2010/09/24 13:21:30 matthew Exp $
a53 4
if COMPAT_SVR4 > 0
include <compat/svr4/svr4_ucontext.h>
endif

a138 8
endif

# SVR4 frame offsets
ifdef COMPAT_SVR4
struct	svr4_sigframe	SVR4_SIGF_
member	HANDLER		sf_handler
member	UC		sf_uc
struct	svr4_ucontext	SVR4_UC_
@


1.32
log
@Add stricter asserts to DIAGNOSTIC kernels to help catch mutex and
rwlock misuse.  In particular, this commit makes the following
changes:

  1. i386 and amd64 now count the number of active mutexes so that
assertwaitok(9) can detect attempts to sleep while holding a mutex.

  2. i386 and amd64 check that we actually hold mutexes when passed to
mtx_leave().

  3. Calls to rw_exit*() now call rw_assert_{rd,wr}lock() as
appropriate.

ok krw@@, oga@@; "sounds good to me" deraadt@@; assembly bits double
checked by pirofti@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.31 2010/07/03 04:54:32 kettenis Exp $
a61 4
if COMPAT_FREEBSD > 0
include <machine/freebsd_machdep.h>
endif

a158 7
endif

# FreeBSD frame offsets
ifdef COMPAT_FREEBSD
struct	freebsd_sigframe	FREEBSD_SIGF_
member	HANDLER			sf_handler
member	SC			sf_sc
@


1.31
log
@Make the kernel responsible for saving the FPU state before running
signal handlers.  Breaks ABI for applications that copy around struct
sigcontext to implement cooperative threading.  Other applications
shoouldn't notice the difference.

ok guenther@@, deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.30 2010/04/01 19:48:50 kettenis Exp $
d210 3
@


1.30
log
@Don't index cpu_info by apic id, but by device unit number instead.  Recent
Intel CPUs come up with apic id's >= 32, even on systems with less than 32
logical CPUs.

ok krw@@, marco@@; tested by deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.29 2009/06/03 00:49:12 art Exp $
a138 1
member	FPSTATE		sf_fpstate
@


1.29
log
@Just like on amd64. Instead of keeping a bitmap of which cpus a pmap
is active on, save a curpmap pointer in cpu_info. This lets us simplify
a few things and do lazy context switching from a user process to a
kernel thread. There's a new IPI introduced for forcing a cr3 reload
when we're tearing down a dead pmap.

kettenis@@ ok (after I polished a few minor things)
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.28 2007/10/10 15:53:51 art Exp $
d194 1
@


1.28
log
@Make context switching much more MI:
 - Move the functionality of choosing a process from cpu_switch into
   a much simpler function: cpu_switchto. Instead of having the locore
   code walk the run queues, let the MI code choose the process we
   want to run and only implement the context switching itself in MD
   code.
 - Let MD context switching run without worrying about spls or locks.
 - Instead of having the idle loop implemented with special contexts
   in MD code, implement one idle proc for each cpu. make the idle
   loop MI with MD hooks.
 - Change the proc lists from the old style vax queues to TAILQs.
 - Change the sleep queue from vax queues to TAILQs. This makes
   wakeup() go from O(n^2) to O(n)

there will be some MD fallout, but it will be fixed shortly.
There's also a few cleanups to be done after this.

deraadt@@, kettenis@@ ok
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.27 2007/10/03 07:51:26 kettenis Exp $
d117 1
d210 4
@


1.27
log
@Add pcb_flags member to 'struct pcb', and set PCB_SAVECTX on contexts saved
by savectx().

ok art@@, miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.26 2007/04/03 10:14:47 art Exp $
a90 2
member	p_back
member	p_forw
@


1.26
log
@Make the ast on i386 per-process instead of per-cpu. This makes
signal delivery more reliable in some cases when a process switches
cpu.

kettenis@@ ok
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.25 2007/02/20 21:15:01 tom Exp $
d118 2
@


1.25
log
@Revert PAE pmap for now, until the strange bug is found.  This stops
the freezes many of us are seeing (especially on amd64 machines running
OpenBSD/i386).

Much testing by nick@@ (as always - thanks!), hugh@@, ian@@, kettenis@@
and Sam Smith (s (at) msmith (dot) net).

Requested by, input from, and ok deraadt@@  ok art@@, kettenis@@, miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.24 2006/04/27 15:37:50 mickey Exp $
d99 1
a201 1
define	CPU_INFO_ASTPENDING	offsetof(struct cpu_info, ci_astpending)
@


1.24
log
@implement separate PAE pmap that allows access to 64g of physmem
if supported by the cpu(s). currently not enabled by default and
not compiled into ramdisks. this grows paddr_t to 64bit but yet
leaves bus_addr_t at 32bits. measures are taken to favour dmaable
memory allocation from below 4g line such that buffer cache is
already allocated form below, pool backend allocator prefers lower
memory and then finally bounce buffers are used as last resort.
PAE is engaged only if global variable cpu_pae is manually set
to non-zero and there is physical memory present above 4g.
simplify pcibios address math to use u_long as we always will
be in the 32bit space.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.23 2006/01/12 22:39:20 weingart Exp $
d83 1
@


1.23
log
@Move to using gdt only (no more ldt in general case) but with a variable
limit selector, so that the w^x line can float much more dynamically.
Much work done by tom.  Tested by various people.  Addresses concerns of
(Julien Tinnes) <julien ATHOST cr0.org>
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.22 2005/11/23 16:51:28 mickey Exp $
a82 1
export	NKPTP_MAX
@


1.22
log
@finnish the PTDPTDI and APTDPTDI conversion to PDSLOT_PTE and PDSLOT_APTE thus reducing confusion; remove compatibility defines and comments
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.21 2005/07/18 14:55:49 mickey Exp $
d113 1
@


1.21
log
@save/restore fpu for the signal handler call in the trampoline.
modeled after sparc together w/ deraadt@@; deraadt@@ ok
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.20 2005/05/21 19:13:55 brad Exp $
d81 1
a83 1
export	APTDPTDI
@


1.21.2.1
log
@MFC:
Fix by weingart@@

Move to using gdt only (no more ldt in general case) but with a variable
limit selector, so that the w^x line can float much more dynamically.
Much work done by tom.  Tested by various people.  Addresses concerns of
(Julien Tinnes) <julien ATHOST cr0.org>

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.21 2005/07/18 14:55:49 mickey Exp $
a112 1
member	pcb_ldt
@


1.20
log
@add i386 optimized in4_cksum

From NetBSD

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.19 2004/12/24 21:22:00 pvalchev Exp $
d136 1
@


1.19
log
@Rewrite intlock/intunlock not to pass around interrupt frame directly
without copying which is against C conventions and broke GENERIC.MP
with a gcc3 optimization
From niklas, tested by many
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.18 2004/07/20 20:16:44 art Exp $
d40 5
d183 3
@


1.19.2.1
log
@MFC:
Fix by weingart@@

Move to using gdt only (no more ldt in general case) but with a variable
limit selector, so that the w^x line can float much more dynamically.
Much work done by tom.  Tested by various people.  Addresses concerns of
(Julien Tinnes) <julien ATHOST cr0.org>

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.19 2004/12/24 21:22:00 pvalchev Exp $
a107 1
member	pcb_ldt
@


1.18
log
@MD mutex implementation for i386.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.17 2004/07/02 16:29:55 niklas Exp $
d122 4
@


1.17
log
@Maintain %f and %gs over traps.  Mostly from NetBSD.  Preparation for SMP
speedups.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.16 2004/06/28 02:00:20 deraadt Exp $
d47 1
d169 6
d197 1
@


1.16
log
@move from unsafe ev_count32 to safe ev_count; aaron ok
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.15 2004/06/28 01:41:52 aaron Exp $
a105 2
member	pcb_fs
member	pcb_gs
a126 3
member	sc_fs
member	sc_gs
member	sc_eflags
a141 3
member	FS		uc_mcontext.greg[SVR4_X86_FS]
member	GS		uc_mcontext.greg[SVR4_X86_GS]
member	EFLAGS		uc_mcontext.greg[SVR4_X86_EFL]
a149 3
member	sc_fs			
member	sc_gs
member	sc_eflags
@


1.15
log
@Use new event counter API for interrupt counting on i386.  deraadt@@ tholo@@
drahn@@ millert@@ ok
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.14 2004/06/13 21:49:15 niklas Exp $
d175 1
a175 1
member	IH_COUNT		ih_count.ec_count32
@


1.14
log
@debranch SMP, have fun
@
text
@d1 1
a1 1
#	$OpenBSD$
d175 1
a175 1
member	ih_count
@


1.13
log
@Remove the advertising clause in the UCB license which Berkeley
rescinded 22 July 1999.  Proofed by myself and Theo.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.12 2001/12/01 13:07:24 ho Exp $
d60 4
d70 1
d92 1
a109 1
member	pcb_tss_sel
d111 1
d178 23
@


1.12
log
@Add TF_EAX and TF_ESP for trapframe struct. niklas@@ ok
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.11 2001/11/06 19:53:14 miod Exp $
d14 1
a14 5
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#	This product includes software developed by the University of
#	California, Berkeley and its contributors.
# 4. Neither the name of the University nor the names of its contributors
@


1.11
log
@Replace inclusion of <vm/foo.h> with the correct <uvm/bar.h> when necessary.
(Look ma, I might have broken the tree)
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.10 2001/09/16 14:28:04 miod Exp $
d118 2
@


1.10
log
@Make use of "export", "struct" and "member" keywords to be easier to read
and simpler.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.9 2001/05/05 23:25:36 art Exp $
a44 2

include <vm/vm.h>
@


1.9
log
@PMAP_NEW and UVM are no longer optional on i386.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.8 2001/03/22 23:36:51 niklas Exp $
d71 1
a71 1
define	SRUN		SRUN
d74 5
a78 5
define	PDSLOT_KERN	PDSLOT_KERN
define	PDSLOT_PTE	PDSLOT_PTE
define	NKPTP_MIN	NKPTP_MIN
define	NKPTP_MAX	NKPTP_MAX
define	APTDPTDI	APTDPTDI
d81 1
a81 1
define	VM_MAXUSER_ADDRESS VM_MAXUSER_ADDRESS
d84 9
a92 8
define	P_ADDR		offsetof(struct proc, p_addr)
define	P_BACK		offsetof(struct proc, p_back)
define	P_FORW		offsetof(struct proc, p_forw)
define	P_PRIORITY	offsetof(struct proc, p_priority)
define	P_STAT		offsetof(struct proc, p_stat)
define	P_WCHAN		offsetof(struct proc, p_wchan)
define	P_VMSPACE	offsetof(struct proc, p_vmspace)
define	P_FLAG		offsetof(struct proc, p_flag)
d94 1
a94 1
define	P_SYSTEM	P_SYSTEM
d97 3
a99 2
define	V_TRAP			offsetof(struct uvmexp, traps)
define	V_INTR			offsetof(struct uvmexp, intrs)
d102 10
a111 9
define	PCB_CR3		offsetof(struct pcb, pcb_cr3)
define	PCB_EBP		offsetof(struct pcb, pcb_ebp)
define	PCB_ESP		offsetof(struct pcb, pcb_esp)
define	PCB_FS		offsetof(struct pcb, pcb_fs)
define	PCB_GS		offsetof(struct pcb, pcb_gs)
define	PCB_CR0		offsetof(struct pcb, pcb_cr0)
define	PCB_LDT_SEL	offsetof(struct pcb, pcb_ldt_sel)
define	PCB_TSS_SEL	offsetof(struct pcb, pcb_tss_sel)
define	PCB_ONFAULT	offsetof(struct pcb, pcb_onfault)
d114 6
a119 6
define	TF_CS		offsetof(struct trapframe, tf_cs)
define	TF_TRAPNO	offsetof(struct trapframe, tf_trapno)
define	TF_EFLAGS	offsetof(struct trapframe, tf_eflags)
define	TF_EIP		offsetof(struct trapframe, tf_eip)
define	TF_ERR		offsetof(struct trapframe, tf_err)

d123 7
a129 5
define	SIGF_HANDLER	offsetof(struct sigframe, sf_handler)
define	SIGF_SC		offsetof(struct sigframe, sf_sc)
define	SC_FS		offsetof(struct sigcontext, sc_fs)
define	SC_GS		offsetof(struct sigcontext, sc_gs)
define	SC_EFLAGS	offsetof(struct sigcontext, sc_eflags)
d133 4
a136 3
define	M_NEXT		offsetof(struct mbuf, m_next)
define	M_DATA		offsetof(struct mbuf, m_data)
define	M_LEN		offsetof(struct mbuf, m_len)
d141 7
a147 5
define	SVR4_SIGF_HANDLER	offsetof(struct svr4_sigframe, sf_handler)
define	SVR4_SIGF_UC	offsetof(struct svr4_sigframe, sf_uc)
define	SVR4_UC_FS	offsetof(struct svr4_ucontext, uc_mcontext.greg[SVR4_X86_FS])
define	SVR4_UC_GS	offsetof(struct svr4_ucontext, uc_mcontext.greg[SVR4_X86_GS])
define	SVR4_UC_EFLAGS	offsetof(struct svr4_ucontext, uc_mcontext.greg[SVR4_X86_EFL])
d152 7
a158 5
define	LINUX_SIGF_HANDLER	offsetof(struct linux_sigframe, sf_handler)
define	LINUX_SIGF_SC	offsetof(struct linux_sigframe, sf_sc)
define	LINUX_SC_FS	offsetof(struct linux_sigcontext, sc_fs)
define	LINUX_SC_GS	offsetof(struct linux_sigcontext, sc_gs)
define	LINUX_SC_EFLAGS	offsetof(struct linux_sigcontext, sc_eflags)
d163 3
a165 2
define	FREEBSD_SIGF_HANDLER	offsetof(struct freebsd_sigframe, sf_handler)
define	FREEBSD_SIGF_SC	offsetof(struct freebsd_sigframe, sf_sc)
d170 5
a174 4
define	IH_FUN		offsetof(struct intrhand, ih_fun)
define	IH_ARG		offsetof(struct intrhand, ih_arg)
define	IH_COUNT	offsetof(struct intrhand, ih_count)
define	IH_NEXT		offsetof(struct intrhand, ih_next)
@


1.8
log
@Merge in NetBSD's PMAP_NEW, still disabled
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.7 1999/02/26 04:28:50 art Exp $
a47 1
ifdef UVM
a48 1
endif
a73 1
ifdef PMAP_NEW
a77 5
else
define	PTDPTDI		PTDPTDI
define	KPTDI		KPTDI
define	NKPDE		NKPDE
endif
a95 1
ifdef UVM
a97 4
else
define	V_TRAP		offsetof(struct vmmeter, v_trap)
define	V_INTR		offsetof(struct vmmeter, v_intr)
endif
@


1.7
log
@some uvm constants
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.6 1997/12/09 03:36:39 deraadt Exp $
d76 6
d85 1
@


1.7.6.1
log
@Update the SMP branch to -current, this breaks the SMP branch though.
But it will be fixed soonish.  Note, nothing new has happened, this is just
a merge of the trunk into this branch.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.8 2001/03/22 23:36:51 niklas Exp $
a75 6
ifdef PMAP_NEW
define	PDSLOT_KERN	PDSLOT_KERN
define	PDSLOT_PTE	PDSLOT_PTE
define	NKPTP_MIN	NKPTP_MIN
define	NKPTP_MAX	NKPTP_MAX
else
a78 1
endif
@


1.7.6.2
log
@Merge in -current from two days ago in the SMP branch.
As usual with merges, they do not indicate progress, so do not hold
your breath for working SMP, and do not mail me and ask about the
state of it.  It has not changed.  There is work ongoing, but very, very
slowly.  The commit is done in parts as to not lock up the tree in too
big chunks at a time.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.7.6.1 2001/04/18 16:07:18 niklas Exp $
d48 1
d50 1
d76 1
d81 5
d104 1
d107 4
@


1.7.6.3
log
@Initial import of some SMP code from NetBSD.
Not really working here yet, but there is some work in progress.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.7.6.2 2001/07/04 10:16:34 niklas Exp $
a65 4
if MULTIPROCESSOR
include <machine/cpu.h>
endif

a91 1
define	P_CPU		offsetof(struct proc, p_cpu)
a162 14
endif

ifdef MULTIPROCESSOR
define	CPU_INFO_CURPROC	offsetof(struct cpu_info, ci_curproc)
define	CPU_INFO_CURPCB		offsetof(struct cpu_info, ci_curpcb)
define	CPU_INFO_IDLE_PCB	offsetof(struct cpu_info, ci_idle_pcb)
define	CPU_INFO_LEVEL		offsetof(struct cpu_info, ci_level)
define	CPU_INFO_VENDOR		offsetof(struct cpu_info, ci_vendor[0])
define	CPU_INFO_SIGNATURE	offsetof(struct cpu_info, ci_signature)
define	CPU_INFO_FEATURES	offsetof(struct cpu_info, ci_features)
define	CPU_INFO_RESCHED	offsetof(struct cpu_info, ci_want_resched)
define	CPU_INFO_ASTPENDING	offsetof(struct cpu_info, ci_astpending)

define	SIZEOF_CPU_INFO		sizeof(struct cpu_info)
@


1.7.6.4
log
@Sync the SMP branch to something just after 3.0
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.7.6.3 2001/07/14 10:02:24 ho Exp $
d75 1
a75 1
export	SRUN
d78 5
a82 5
export	PDSLOT_KERN
export	PDSLOT_PTE
export	NKPTP_MIN
export	NKPTP_MAX
export	APTDPTDI
d85 1
a85 1
export	VM_MAXUSER_ADDRESS
d88 9
a96 10
struct	proc
member	p_addr
member	p_back
member	p_forw
member	p_priority
member	p_stat
member	p_wchan
member	p_vmspace
member	p_flag
member	p_cpu
d98 1
a98 1
export	P_SYSTEM
d101 2
a102 3
struct	uvmexp		V_
member	TRAP		traps
member	INTR		intrs
d105 9
a113 10
struct	pcb
member	pcb_cr3
member	pcb_ebp
member	pcb_esp
member	pcb_fs
member	pcb_gs
member	pcb_cr0
member	pcb_ldt_sel
member	pcb_tss_sel
member	pcb_onfault
d116 6
a121 6
struct	trapframe
member	tf_cs
member	tf_trapno
member	tf_eflags
member	tf_eip
member	tf_err
d125 5
a129 7
struct	sigframe	SIGF_
member	HANDLER		sf_handler
member	SC		sf_sc
struct	sigcontext
member	sc_fs
member	sc_gs
member	sc_eflags
d133 3
a135 4
struct	mbuf
member	m_next
member	m_data
member	m_len
d140 5
a144 7
struct	svr4_sigframe	SVR4_SIGF_
member	HANDLER		sf_handler
member	UC		sf_uc
struct	svr4_ucontext	SVR4_UC_
member	FS		uc_mcontext.greg[SVR4_X86_FS]
member	GS		uc_mcontext.greg[SVR4_X86_GS]
member	EFLAGS		uc_mcontext.greg[SVR4_X86_EFL]
d149 5
a153 7
struct	linux_sigframe		LINUX_SIGF_
member	HANDLER			sf_handler
member	SC			sf_sc
struct	linux_sigcontext	LINUX_
member	sc_fs			
member	sc_gs
member	sc_eflags
d158 2
a159 3
struct	freebsd_sigframe	FREEBSD_SIGF_
member	HANDLER			sf_handler
member	SC			sf_sc
d164 4
a167 5
struct	intrhand
member	ih_fun
member	ih_arg
member	ih_count
member	ih_next
@


1.7.6.5
log
@Merge in -current
@
text
@d1 1
a1 1
#	$OpenBSD$
d45 2
@


1.7.6.6
log
@No more ci_features
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.7.6.5 2001/11/13 21:00:51 niklas Exp $
d187 1
@


1.7.6.7
log
@Merge in -current
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.7.6.6 2001/11/14 14:45:07 ho Exp $
a122 2
member	tf_eax
member	tf_esp
@


1.7.6.8
log
@Move TSS selector from the PCB to MD part of proc and to cpu_info.
Maintain a list of CPUs and provide an iterator for it.
Ifdef out IPI debugging.  Call pmap_{de,}activate as part of context switching.
Mostly from NetBSD.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.7.6.7 2001/12/05 00:39:10 niklas Exp $
d113 1
a181 2
define	P_MD_TSS_SEL		offsetof(struct proc, p_md.md_tss_sel)

a185 1
define	CPU_INFO_IDLE_TSS_SEL	offsetof(struct cpu_info, ci_idle_tss_sel)
@


1.7.6.9
log
@Biglock!  Most of the logic
comes from NetBSD.
Also a lot of fixes, enough to get a dual cpu machine actually run MP for a
very short while (we are just talking about seconds) before starving out one
of the cpus.  More coming very soon.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.7.6.8 2003/04/11 16:12:56 niklas Exp $
a73 1
export	SONPROC
a185 1
define	CPU_INFO_NAME		offsetof(struct cpu_info, ci_dev.dv_xname)
a192 1
define	CPU_INFO_GDT		offsetof(struct cpu_info, ci_gdt)
@


1.7.6.10
log
@Sync SMP branch to -current
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.7.6.9 2003/05/15 04:08:01 niklas Exp $
d14 5
a18 1
# 3. Neither the name of the University nor the names of its contributors
@


1.7.6.11
log
@reflect cpu.h changes
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.7.6.10 2003/06/07 11:11:37 ho Exp $
d180 1
a180 1
define	CPU_INFO_SELF		offsetof(struct cpu_info, ci_self)
a191 6
define	CPU_INFO_IPENDING	offsetof(struct cpu_info, ci_ipending)
define	CPU_INFO_IMASK		offsetof(struct cpu_info, ci_imask)
define	CPU_INFO_IUNMASK	offsetof(struct cpu_info, ci_iunmask)
define	CPU_INFO_ILEVEL		offsetof(struct cpu_info, ci_ilevel)
define	CPU_INFO_IDEPTH		offsetof(struct cpu_info, ci_idepth)
define	CPU_INFO_ISOURCES	offsetof(struct cpu_info, ci_isources)
d194 1
@


1.7.6.12
log
@oops, need to set trap on FP ops bit if FP context on other cpu (NetBSD)
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.7.6.11 2004/03/23 08:01:17 niklas Exp $
a110 1
member	pcb_fpcpu
@


1.6
log
@Intel P5 f00f workaround; weingart & who knows who else
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.5 1997/10/19 06:34:23 mickey Exp $
d48 4
d97 4
d103 1
@


1.5
log
@no, not good. will be fixed soon
xyu te6e B poT, teo
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.4 1997/10/18 00:33:12 weingart Exp $
d111 2
@


1.4
log
@Copy in bios_diskinfo array from /boot space.
Add length field for checksum to same.
Start of making /boot deduce bsd dev_t for
all BIOS drives.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.3 1997/09/29 03:42:26 mickey Exp $
a158 8

include "bios.h"
ifdef NBIOS
include <machine/biosvar.h>
define	BOOT_DATA	offsetof(struct BIOS_vars, boot_data)
define	BOOT_SIZE	sizeof(bios_diskinfo_t)
endif

@


1.3
log
@apm0 at bios0
configs will be updated
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.2 1997/09/21 04:27:54 mickey Exp $
d158 7
@


1.2
log
@support new boots
add to your config:
bios0 at mainbus0
apm0 at mainbus0	# (if you are using APM)
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.1 1997/03/29 07:12:07 tholo Exp $
a51 10
include "apm.h"
if NAPM > 0
include <machine/apmvar.h>
endif

include "bios.h"
if NBIOS > 0
include <machine/biosvar.h>
endif

a159 8
# Advanced Power Management information
if NAPM > 0
define	APM_CALL	offsetof(struct apm_connect_info, apm_entrypt)
define	APMREG_AX	offsetof(struct apmregs, ax)
define	APMREG_BX	offsetof(struct apmregs, bx)
define	APMREG_CX	offsetof(struct apmregs, cx)
define	APMREG_DX	offsetof(struct apmregs, dx)
endif
@


1.1
log
@Use genassym.sh
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.2 1997/03/27 16:18:02 niklas Exp $
d57 5
a171 7
define	APM_CODE32	offsetof(struct apm_connect_info, apm_code32_seg_base)
define	APM_CODE16	offsetof(struct apm_connect_info, apm_code16_seg_base)
define	APM_DATA	offsetof(struct apm_connect_info, apm_data_seg_base)
define	APM_CODE32_LEN	offsetof(struct apm_connect_info, apm_code32_seg_len)
define	APM_DATA_LEN	offsetof(struct apm_connect_info, apm_data_seg_len)
define	APM_ENTRY	offsetof(struct apm_connect_info, apm_entrypt)
define	APM_DETAIL	offsetof(struct apm_connect_info, apm_detail)
a172 1
define	APM_SIZE	sizeof(struct apm_connect_info)
@
