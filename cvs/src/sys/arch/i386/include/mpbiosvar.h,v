head	1.12;
access;
symbols
	OPENBSD_6_1_BASE:1.12
	OPENBSD_6_0:1.12.0.2
	OPENBSD_6_0_BASE:1.12
	OPENBSD_5_9:1.11.0.8
	OPENBSD_5_9_BASE:1.11
	OPENBSD_5_8:1.11.0.10
	OPENBSD_5_8_BASE:1.11
	OPENBSD_5_7:1.11.0.2
	OPENBSD_5_7_BASE:1.11
	OPENBSD_5_6:1.11.0.6
	OPENBSD_5_6_BASE:1.11
	OPENBSD_5_5:1.11.0.4
	OPENBSD_5_5_BASE:1.11
	OPENBSD_5_4:1.10.0.8
	OPENBSD_5_4_BASE:1.10
	OPENBSD_5_3:1.10.0.6
	OPENBSD_5_3_BASE:1.10
	OPENBSD_5_2:1.10.0.4
	OPENBSD_5_2_BASE:1.10
	OPENBSD_5_1_BASE:1.10
	OPENBSD_5_1:1.10.0.2
	OPENBSD_5_0:1.9.0.2
	OPENBSD_5_0_BASE:1.9
	OPENBSD_4_9:1.8.0.12
	OPENBSD_4_9_BASE:1.8
	OPENBSD_4_8:1.8.0.10
	OPENBSD_4_8_BASE:1.8
	OPENBSD_4_7:1.8.0.6
	OPENBSD_4_7_BASE:1.8
	OPENBSD_4_6:1.8.0.8
	OPENBSD_4_6_BASE:1.8
	OPENBSD_4_5:1.8.0.4
	OPENBSD_4_5_BASE:1.8
	OPENBSD_4_4:1.8.0.2
	OPENBSD_4_4_BASE:1.8
	OPENBSD_4_3:1.7.0.6
	OPENBSD_4_3_BASE:1.7
	OPENBSD_4_2:1.7.0.4
	OPENBSD_4_2_BASE:1.7
	OPENBSD_4_1:1.7.0.2
	OPENBSD_4_1_BASE:1.7
	OPENBSD_4_0:1.5.0.2
	OPENBSD_4_0_BASE:1.5
	OPENBSD_3_9:1.3.0.2
	OPENBSD_3_9_BASE:1.3
	OPENBSD_3_8:1.2.0.6
	OPENBSD_3_8_BASE:1.2
	OPENBSD_3_7:1.2.0.4
	OPENBSD_3_7_BASE:1.2
	OPENBSD_3_6:1.2.0.2
	OPENBSD_3_6_BASE:1.2
	SMP_SYNC_A:1.1
	SMP_SYNC_B:1.1
	UBC_SYNC_A:1.1
	UBC_SYNC_B:1.1
	SMP:1.1.0.2;
locks; strict;
comment	@ * @;


1.12
date	2016.05.18.03.45.11;	author mlarkin;	state Exp;
branches;
next	1.11;
commitid	JQz4IJ6cQ8DinMqc;

1.11
date	2014.01.05.20.23.57;	author mlarkin;	state Exp;
branches;
next	1.10;

1.10
date	2011.10.21.18.16.13;	author kettenis;	state Exp;
branches;
next	1.9;

1.9
date	2011.03.23.16.54.35;	author pirofti;	state Exp;
branches;
next	1.8;

1.8
date	2008.06.26.05.42.10;	author ray;	state Exp;
branches;
next	1.7;

1.7
date	2007.01.23.21.17.18;	author kettenis;	state Exp;
branches;
next	1.6;

1.6
date	2006.11.11.21.47.52;	author kettenis;	state Exp;
branches;
next	1.5;

1.5
date	2006.05.01.17.01.14;	author kettenis;	state Exp;
branches;
next	1.4;

1.4
date	2006.03.24.12.17.03;	author mickey;	state Exp;
branches;
next	1.3;

1.3
date	2005.11.23.09.24.52;	author mickey;	state Exp;
branches;
next	1.2;

1.2
date	2004.06.13.21.49.16;	author niklas;	state Exp;
branches;
next	1.1;

1.1
date	2001.07.14.10.02.39;	author ho;	state dead;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2001.07.14.10.02.40;	author ho;	state Exp;
branches;
next	1.1.2.2;

1.1.2.2
date	2001.07.15.15.13.29;	author ho;	state Exp;
branches;
next	1.1.2.3;

1.1.2.3
date	2001.10.27.10.54.59;	author niklas;	state Exp;
branches;
next	1.1.2.4;

1.1.2.4
date	2004.03.14.22.08.21;	author niklas;	state Exp;
branches;
next	1.1.2.5;

1.1.2.5
date	2004.06.11.14.58.37;	author grange;	state Exp;
branches;
next	1.1.2.6;

1.1.2.6
date	2004.06.13.18.46.04;	author art;	state Exp;
branches;
next	;


desc
@@


1.12
log
@
Split i386 mp hatch trampoline into code and data pages, and protect each
with proper W^X policy. The same thing was done for amd64 late last year,
catching i386 up now. Diff has been in snaps for a few days with no
reported fallout.

ok deraadt@@
@
text
@/*	$OpenBSD: mpbiosvar.h,v 1.11 2014/01/05 20:23:57 mlarkin Exp $	*/
/* $NetBSD: mpbiosvar.h,v 1.1.2.3 2000/02/29 13:17:20 sommerfeld Exp $ */

/*-
 * Copyright (c) 2000 The NetBSD Foundation, Inc.
 * All rights reserved.
 *
 * This code is derived from software contributed to The NetBSD Foundation
 * by RedBack Networks Inc.
 *
 * Author: Bill Sommerfeld
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS
 * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
 * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS
 * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */


#ifndef _MACHINE_MPBIOSVAR_H_
#define _MACHINE_MPBIOSVAR_H_

#define MP_TRAMPOLINE  (16 * PAGE_SIZE)
#define MP_TRAMP_DATA  (17 * PAGE_SIZE)

#if !defined(_LOCORE)

#include <machine/mpbiosreg.h>

struct mp_bus 
{
	char *mb_name;		/* XXX bus name */
	int mb_idx;		/* XXX bus index */
	void (*mb_intr_print) (int);
	void (*mb_intr_cfg)(const struct mpbios_int *, u_int32_t *);
	struct mp_intr_map *mb_intrs;
	u_int32_t mb_data;	/* random bus-specific datum. */
};

struct mp_intr_map
{
	struct mp_intr_map *next;
	struct mp_bus *bus;
	int bus_pin;
	struct ioapic_softc *ioapic;
	int ioapic_pin;
	int ioapic_ih;		/* int handle, for apic_intr_est */
	int type;		/* from mp spec intr record */
 	int flags;		/* from mp spec intr record */
	u_int32_t redir;
	int cpu_id;
};

#if defined(_KERNEL)
extern int mp_verbose;
extern struct mp_bus *mp_busses;
extern int mp_nbusses;
extern struct mp_intr_map *mp_intrs;
extern int mp_nintrs;
extern struct mp_bus *mp_isa_bus;
extern struct mp_bus *mp_eisa_bus;

void mpbios_scan(struct device *);
int mpbios_probe(struct device *);
int mpbios_invent(int, int, int);

void mpbios_intr_fixup(void);
#endif

#endif

#endif /* !_MACHINE_MPBIOSVAR_H_ */
@


1.11
log
@

Don't use the first 64KB for anything, including tramps. Move tramps and
hibernate goo up after 64KB to avoid posible corruption by buggy BIOS SMM
code. Diff also ensures the first 64KB doesn't get handed to UVM either.

ok deraadt@@, tested by many with no regressions reported
@
text
@d1 1
a1 1
/*	$OpenBSD: mpbiosvar.h,v 1.10 2011/10/21 18:16:13 kettenis Exp $	*/
d40 1
@


1.10
log
@Add bounds checks for access to mp_busses.  Also make sure that we don't
accidentally use ISA or EISA interrupt mappings on PCI busses.

ok jsg@@
@
text
@d1 1
a1 1
/*	$OpenBSD: mpbiosvar.h,v 1.9 2011/03/23 16:54:35 pirofti Exp $	*/
d39 1
a39 1
#define MP_TRAMPOLINE  (7 * PAGE_SIZE)
@


1.9
log
@Normalize sentinel. Use _MACHINE_*_H_ and _<ARCH>_*_H_ properly and consitently.

Discussed and okay drahn@@. Okay deraadt@@.
@
text
@d1 1
a1 1
/*	$OpenBSD: mpbiosvar.h,v 1.8 2008/06/26 05:42:10 ray Exp $	*/
d72 1
@


1.8
log
@First pass at removing clauses 3 and 4 from NetBSD licenses.

Not sure what's more surprising: how long it took for NetBSD to
catch up to the rest of the BSDs (including UCB), or the amount of
code that NetBSD has claimed for itself without attributing to the
actual authors.

OK deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: mpbiosvar.h,v 1.7 2007/01/23 21:17:18 kettenis Exp $	*/
d36 2
a37 2
#ifndef _I386_MPBIOSVAR_H_
#define _I386_MPBIOSVAR_H_
d86 1
a86 1
#endif /* !_I386_MPBIOSVAR_H_ */
@


1.7
log
@Handle not-all-lapics intterupts.
@
text
@d1 1
a1 1
/*	$OpenBSD: mpbiosvar.h,v 1.6 2006/11/11 21:47:52 kettenis Exp $	*/
a20 7
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *        This product includes software developed by the NetBSD
 *        Foundation, Inc. and its contributors.
 * 4. Neither the name of The NetBSD Foundation nor the names of its
 *    contributors may be used to endorse or promote products derived
 *    from this software without specific prior written permission.
@


1.6
log
@Get rid of magic isa and eisa bus numbers in mpbios code.  Pave the way for
alternative sources for interrupt information.

ok gwk@@, brad@@
@
text
@d1 1
a1 1
/*	$OpenBSD: mpbiosvar.h,v 1.5 2006/05/01 17:01:14 kettenis Exp $	*/
d73 1
d80 1
@


1.5
log
@Fixup broken mpbios'es on VT8237 and nForce4 chipsets.  Fixes interrupt
routing for several integrated devices on those chipsets in GENERIC.MP.
ok brad@@, mickey@@
@
text
@d1 1
a1 1
/*	$OpenBSD: mpbiosvar.h,v 1.4 2006/03/24 12:17:03 mickey Exp $	*/
d79 2
a80 2
extern int mp_isa_bus;
extern int mp_eisa_bus;
@


1.4
log
@move the mp tramp higher to avoid trashing boot args and also to fight strange memory zeroing happennning on some amd machines; toby@@ ok
@
text
@d1 1
a1 1
/*	$OpenBSD: mpbiosvar.h,v 1.3 2005/11/23 09:24:52 mickey Exp $	*/
d85 2
@


1.3
log
@resolve a couple of problems in mpbios-mapped interrupts:
- synthesise isa mappings (as 1-1) should those be missing in mpbios;
- for rcc osb* firce "special" ints into isa mappings always.
niklas@@ ok and testing by many since
@
text
@d1 1
a1 1
/*	$OpenBSD: mpbiosvar.h,v 1.2 2004/06/13 21:49:16 niklas Exp $	*/
d46 1
a46 1
#define MP_TRAMPOLINE  (2 * PAGE_SIZE)
@


1.2
log
@debranch SMP, have fun
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d84 1
@


1.1
log
@file mpbiosvar.h was initially added on branch SMP.
@
text
@d1 88
@


1.1.2.1
log
@Initial import of some SMP code from NetBSD.
Not really working here yet, but there is some work in progress.
@
text
@a0 86
/* $NetBSD: mpbiosvar.h,v 1.1.2.3 2000/02/29 13:17:20 sommerfeld Exp $ */

/*-
 * Copyright (c) 2000 The NetBSD Foundation, Inc.
 * All rights reserved.
 *
 * This code is derived from software contributed to The NetBSD Foundation
 * by RedBack Networks Inc.
 *
 * Author: Bill Sommerfeld
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *        This product includes software developed by the NetBSD
 *        Foundation, Inc. and its contributors.
 * 4. Neither the name of The NetBSD Foundation nor the names of its
 *    contributors may be used to endorse or promote products derived
 *    from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS
 * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
 * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS
 * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */


#ifndef _I386_MPBIOSVAR_H_
#define _I386_MPBIOSVAR_H_

#define MP_TRAMPOLINE  (3 * NBPG)

#if !defined(_LOCORE)

#include <machine/mpbiosreg.h>

struct mp_bus 
{
	char *mb_name;		/* XXX bus name */
	int mb_idx;		/* XXX bus index */
	void (*mb_intr_print) __P((int));
	void (*mb_intr_cfg) __P((const struct mpbios_int *, u_int32_t *));
	struct mp_intr_map *mb_intrs;
	u_int32_t mb_data;	/* random bus-specific datum. */
};

struct mp_intr_map
{
	struct mp_intr_map *next;
	struct mp_bus *bus;
	int bus_pin;
	struct ioapic_softc *ioapic;
	int ioapic_pin;
	int ioapic_ih;		/* int handle, for apic_intr_est */
	int type;		/* from mp spec intr record */
 	int flags;		/* from mp spec intr record */
	u_int32_t redir;
};

#if defined(_KERNEL)
extern int mp_verbose;
extern struct mp_bus *mp_busses;
extern struct mp_intr_map *mp_intrs;
extern int mp_isa_bus;

void mpbios_scan __P((struct device *));
int mpbios_probe __P((struct device *));
#endif

#endif

#endif /* !_I386_MPBIOSVAR_H_ */
@


1.1.2.2
log
@Add $OpenBSD$.
@
text
@a0 1
/*	$OpenBSD$	*/
@


1.1.2.3
log
@The MP trampoline was colliding with the PT page for the 4st 4MB
@
text
@d1 1
a1 1
/*	$OpenBSD: mpbiosvar.h,v 1.1.2.2 2001/07/15 15:13:29 ho Exp $	*/
d46 1
a46 1
#define MP_TRAMPOLINE  (4 * NBPG)
@


1.1.2.4
log
@Some merged code from NetBSD, more to come
@
text
@d1 1
a1 1
/*	$OpenBSD: mpbiosvar.h,v 1.1.2.3 2001/10/27 10:54:59 niklas Exp $	*/
d46 1
a46 1
#define MP_TRAMPOLINE  (2 * PAGE_SIZE)
@


1.1.2.5
log
@Add mp_eisa_bus extern declaration.
@
text
@d1 1
a1 1
/*	$OpenBSD: mpbiosvar.h,v 1.1.2.4 2004/03/14 22:08:21 niklas Exp $	*/
a79 1
extern int mp_eisa_bus;
@


1.1.2.6
log
@un__Pee
@
text
@d1 1
a1 1
/*	$OpenBSD: mpbiosvar.h,v 1.1.2.5 2004/06/11 14:58:37 grange Exp $	*/
d56 2
a57 2
	void (*mb_intr_print) (int);
	void (*mb_intr_cfg)(const struct mpbios_int *, u_int32_t *);
d82 2
a83 2
void mpbios_scan(struct device *);
int mpbios_probe(struct device *);
@


