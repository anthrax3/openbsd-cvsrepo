head	1.12;
access;
symbols
	OPENBSD_6_1_BASE:1.12
	OPENBSD_6_0:1.12.0.10
	OPENBSD_6_0_BASE:1.12
	OPENBSD_5_9:1.12.0.6
	OPENBSD_5_9_BASE:1.12
	OPENBSD_5_8:1.12.0.8
	OPENBSD_5_8_BASE:1.12
	OPENBSD_5_7:1.12.0.2
	OPENBSD_5_7_BASE:1.12
	OPENBSD_5_6:1.12.0.4
	OPENBSD_5_6_BASE:1.12
	OPENBSD_5_5:1.11.0.18
	OPENBSD_5_5_BASE:1.11
	OPENBSD_5_4:1.11.0.14
	OPENBSD_5_4_BASE:1.11
	OPENBSD_5_3:1.11.0.12
	OPENBSD_5_3_BASE:1.11
	OPENBSD_5_2:1.11.0.10
	OPENBSD_5_2_BASE:1.11
	OPENBSD_5_1_BASE:1.11
	OPENBSD_5_1:1.11.0.8
	OPENBSD_5_0:1.11.0.6
	OPENBSD_5_0_BASE:1.11
	OPENBSD_4_9:1.11.0.4
	OPENBSD_4_9_BASE:1.11
	OPENBSD_4_8:1.11.0.2
	OPENBSD_4_8_BASE:1.11
	OPENBSD_4_7:1.10.0.20
	OPENBSD_4_7_BASE:1.10
	OPENBSD_4_6:1.10.0.22
	OPENBSD_4_6_BASE:1.10
	OPENBSD_4_5:1.10.0.18
	OPENBSD_4_5_BASE:1.10
	OPENBSD_4_4:1.10.0.16
	OPENBSD_4_4_BASE:1.10
	OPENBSD_4_3:1.10.0.14
	OPENBSD_4_3_BASE:1.10
	OPENBSD_4_2:1.10.0.12
	OPENBSD_4_2_BASE:1.10
	OPENBSD_4_1:1.10.0.10
	OPENBSD_4_1_BASE:1.10
	OPENBSD_4_0:1.10.0.8
	OPENBSD_4_0_BASE:1.10
	OPENBSD_3_9:1.10.0.6
	OPENBSD_3_9_BASE:1.10
	OPENBSD_3_8:1.10.0.4
	OPENBSD_3_8_BASE:1.10
	OPENBSD_3_7:1.10.0.2
	OPENBSD_3_7_BASE:1.10
	OPENBSD_3_6:1.9.0.6
	OPENBSD_3_6_BASE:1.9
	SMP_SYNC_A:1.9
	SMP_SYNC_B:1.9
	OPENBSD_3_5:1.9.0.4
	OPENBSD_3_5_BASE:1.9
	OPENBSD_3_4:1.9.0.2
	OPENBSD_3_4_BASE:1.9
	UBC_SYNC_A:1.7
	OPENBSD_3_3:1.7.0.6
	OPENBSD_3_3_BASE:1.7
	OPENBSD_3_2:1.7.0.4
	OPENBSD_3_2_BASE:1.7
	OPENBSD_3_1:1.7.0.2
	OPENBSD_3_1_BASE:1.7
	UBC_SYNC_B:1.7
	UBC:1.6.0.2
	UBC_BASE:1.6
	OPENBSD_3_0:1.5.0.2
	OPENBSD_3_0_BASE:1.5
	OPENBSD_2_9:1.4.0.4
	OPENBSD_2_9_BASE:1.4
	OPENBSD_2_8:1.4.0.2
	OPENBSD_2_8_BASE:1.4
	OPENBSD_2_7:1.3.0.16
	OPENBSD_2_7_BASE:1.3
	SMP:1.3.0.14
	SMP_BASE:1.3
	kame_19991208:1.3
	OPENBSD_2_6:1.3.0.12
	OPENBSD_2_6_BASE:1.3
	OPENBSD_2_5:1.3.0.10
	OPENBSD_2_5_BASE:1.3
	OPENBSD_2_4:1.3.0.8
	OPENBSD_2_4_BASE:1.3
	OPENBSD_2_3:1.3.0.6
	OPENBSD_2_3_BASE:1.3
	OPENBSD_2_2:1.3.0.4
	OPENBSD_2_2_BASE:1.3
	OPENBSD_2_1:1.3.0.2
	OPENBSD_2_1_BASE:1.3
	OPENBSD_2_0:1.2.0.2
	OPENBSD_2_0_BASE:1.2
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@ * @;


1.12
date	2014.03.29.18.09.29;	author guenther;	state Exp;
branches;
next	1.11;

1.11
date	2010.07.09.18.44.10;	author kettenis;	state Exp;
branches;
next	1.10;

1.10
date	2005.01.07.02.03.17;	author pascoe;	state Exp;
branches;
next	1.9;

1.9
date	2003.08.21.05.08.15;	author drahn;	state Exp;
branches;
next	1.8;

1.8
date	2003.06.02.23.27.47;	author millert;	state Exp;
branches;
next	1.7;

1.7
date	2002.03.14.01.26.33;	author millert;	state Exp;
branches;
next	1.6;

1.6
date	2001.11.30.20.26.02;	author mickey;	state Exp;
branches
	1.6.2.1;
next	1.5;

1.5
date	2001.06.27.04.16.37;	author mickey;	state Exp;
branches;
next	1.4;

1.4
date	2000.08.05.22.07.32;	author niklas;	state Exp;
branches;
next	1.3;

1.3
date	97.01.27.20.34.14;	author deraadt;	state Exp;
branches
	1.3.14.1;
next	1.2;

1.2
date	96.03.24.16.52.31;	author tholo;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.50.35;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.50.35;	author deraadt;	state Exp;
branches;
next	;

1.3.14.1
date	2001.04.18.16.07.41;	author niklas;	state Exp;
branches;
next	1.3.14.2;

1.3.14.2
date	2001.07.04.10.16.51;	author niklas;	state Exp;
branches;
next	1.3.14.3;

1.3.14.3
date	2001.12.05.00.39.10;	author niklas;	state Exp;
branches;
next	1.3.14.4;

1.3.14.4
date	2002.03.28.10.31.04;	author niklas;	state Exp;
branches;
next	1.3.14.5;

1.3.14.5
date	2003.06.07.11.11.37;	author ho;	state Exp;
branches;
next	1.3.14.6;

1.3.14.6
date	2004.02.19.10.48.42;	author niklas;	state Exp;
branches;
next	;

1.6.2.1
date	2002.06.11.03.35.54;	author art;	state Exp;
branches;
next	;


desc
@@


1.12
log
@It's been a quarter century: we can assume volatile is present with that name.

ok dlg@@ mpi@@ deraadt@@
@
text
@/*	$OpenBSD: profile.h,v 1.11 2010/07/09 18:44:10 kettenis Exp $	*/
/*	$NetBSD: profile.h,v 1.6 1995/03/28 18:17:08 jtc Exp $	*/

/*
 * Copyright (c) 1992, 1993
 *	The Regents of the University of California.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 *	@@(#)profile.h	8.1 (Berkeley) 6/11/93
 */

#define	_MCOUNT_DECL static __inline void _mcount

#define	MCOUNT \
extern void mcount(void) __asm("__mcount");				\
__weak_alias(mcount,__mcount);						\
void									\
mcount(void)								\
{									\
	int selfpc, frompcindex;					\
	int eax, ecx, edx;						\
									\
	__asm volatile("movl %%eax,%0" : "=g" (eax));			\
	__asm volatile("movl %%ecx,%0" : "=g" (ecx));			\
	__asm volatile("movl %%edx,%0" : "=g" (edx));			\
	/*								\
	 * find the return address for mcount,				\
	 * and the return address for mcount's caller.			\
	 *								\
	 * selfpc = pc pushed by mcount call				\
	 */								\
	__asm volatile ("movl 4(%%ebp),%0" : "=r" (selfpc));		\
	/*								\
	 * frompcindex = pc pushed by call into self.			\
	 */								\
	__asm volatile ("movl (%%ebp),%0;movl 4(%0),%0" :		\
	    "+r" (frompcindex));					\
	_mcount(frompcindex, selfpc);					\
									\
	__asm volatile("movl %0,%%edx" : : "g" (edx));			\
	__asm volatile("movl %0,%%ecx" : : "g" (ecx));			\
	__asm volatile("movl %0,%%eax" : : "g" (eax));			\
}

#ifdef _KERNEL
/*
 * We inline the code that splhigh and splx would do here as otherwise we would
 * call recursively into mcount() as machdep.c is compiled with -pg on a 
 * profiling build.
 */
#define	MCOUNT_ENTER	_SPLRAISE(s, IPL_HIGH); __splbarrier()
#define	MCOUNT_EXIT	__splbarrier(); _SPLX(s)
#endif /* _KERNEL */
@


1.11
log
@We need to preserve %eax, %ecx and %edx since GCC 4.x might use these
registers in the prologue to realign the stack.

ok marco@@, deraadt@@, guenther@@
@
text
@d1 1
a1 1
/*	$OpenBSD: profile.h,v 1.10 2005/01/07 02:03:17 pascoe Exp $	*/
d55 1
a55 1
	__asm __volatile ("movl 4(%%ebp),%0" : "=r" (selfpc));		\
d59 1
a59 1
	__asm __volatile ("movl (%%ebp),%0;movl 4(%0),%0" :		\
@


1.10
log
@Fix profiled kernel builds on i386 by moving splraise/splx code into macros
permitting non-recursive reuse in mcount.

Should be a no-op for normal builds.
@
text
@d1 1
a1 1
/*	$OpenBSD: profile.h,v 1.9 2003/08/21 05:08:15 drahn Exp $	*/
d41 1
a41 1
mcount()								\
d44 5
d62 4
@


1.9
log
@fix symbol name error in mcount functionality in a.out->ELF transition.

This changes the real definition to __mcount, but with a weak mcount
for compat. On the next major bump the weak alias should be removed.
Without this diff the compiler symbol mcount conflicts with the
user mcount() function.
@
text
@d1 1
a1 1
/*	$OpenBSD: profile.h,v 1.8 2003/06/02 23:27:47 millert Exp $	*/
d61 3
a63 2
 * Note that we assume splhigh() and splx() cannot call mcount()
 * recursively.
d65 2
a66 2
#define	MCOUNT_ENTER	s = splhigh()
#define	MCOUNT_EXIT	splx(s)
@


1.8
log
@Remove the advertising clause in the UCB license which Berkeley
rescinded 22 July 1999.  Proofed by myself and Theo.
@
text
@d1 1
a1 1
/*	$OpenBSD: profile.h,v 1.7 2002/03/14 01:26:33 millert Exp $	*/
d38 2
a39 1
extern void mcount(void) __asm("mcount");				\
@


1.7
log
@First round of __P removal in sys
@
text
@d1 1
a1 1
/*	$OpenBSD: profile.h,v 1.6 2001/11/30 20:26:02 mickey Exp $	*/
d16 1
a16 5
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by the University of
 *	California, Berkeley and its contributors.
 * 4. Neither the name of the University nor the names of its contributors
@


1.6
log
@prevent reorder of __asm w/ __volatile.
from netbsd:
Declare some asm statement with output as volatile.  Without this,
gcc with -march=pentiumpro produce bad code.
@
text
@d1 1
a1 1
/*	$OpenBSD: profile.h,v 1.5 2001/06/27 04:16:37 mickey Exp $	*/
d42 1
a42 1
extern void mcount __P((void)) __asm("mcount");				\
@


1.6.2.1
log
@Sync UBC branch to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: profile.h,v 1.6 2001/11/30 20:26:02 mickey Exp $	*/
d42 1
a42 1
extern void mcount(void) __asm("mcount");				\
@


1.5
log
@fix constraint, no idea how did it work
@
text
@d1 1
a1 1
/*	$OpenBSD: profile.h,v 1.4 2000/08/05 22:07:32 niklas Exp $	*/
d53 1
a53 1
	__asm("movl 4(%%ebp),%0" : "=r" (selfpc));			\
d57 2
a58 1
	__asm("movl (%%ebp),%0;movl 4(%0),%0" : "+r" (frompcindex));	\
@


1.4
log
@$OpenBSD$
@
text
@d1 1
a1 1
/*	$OpenBSD: profile.h,v 1.6 1995/03/28 18:17:08 jtc Exp $	*/
d57 1
a57 1
	__asm("movl (%%ebp),%0;movl 4(%0),%0" : "=r" (frompcindex));	\
@


1.3
log
@prototyping problems, PR#71, felix@@mamba.pond.sub.org
@
text
@d1 1
@


1.3.14.1
log
@Update the SMP branch to -current, this breaks the SMP branch though.
But it will be fixed soonish.  Note, nothing new has happened, this is just
a merge of the trunk into this branch.
@
text
@a0 1
/*	$OpenBSD: profile.h,v 1.4 2000/08/05 22:07:32 niklas Exp $	*/
@


1.3.14.2
log
@Merge in -current from two days ago in the SMP branch.
As usual with merges, they do not indicate progress, so do not hold
your breath for working SMP, and do not mail me and ask about the
state of it.  It has not changed.  There is work ongoing, but very, very
slowly.  The commit is done in parts as to not lock up the tree in too
big chunks at a time.
@
text
@d1 1
a1 1
/*	$OpenBSD: profile.h,v 1.3.14.1 2001/04/18 16:07:41 niklas Exp $	*/
d57 1
a57 1
	__asm("movl (%%ebp),%0;movl 4(%0),%0" : "+r" (frompcindex));	\
@


1.3.14.3
log
@Merge in -current
@
text
@d1 1
a1 1
/*	$OpenBSD: profile.h,v 1.3.14.2 2001/07/04 10:16:51 niklas Exp $	*/
d53 1
a53 1
	__asm __volatile ("movl 4(%%ebp),%0" : "=r" (selfpc));		\
d57 1
a57 2
	__asm __volatile ("movl (%%ebp),%0;movl 4(%0),%0" :		\
	    "+r" (frompcindex));					\
@


1.3.14.4
log
@Merge in -current from about a week ago
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d42 1
a42 1
extern void mcount(void) __asm("mcount");				\
@


1.3.14.5
log
@Sync SMP branch to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: profile.h,v 1.3.14.4 2002/03/28 10:31:04 niklas Exp $	*/
d16 5
a20 1
 * 3. Neither the name of the University nor the names of its contributors
@


1.3.14.6
log
@Merge of current from two weeks agointo the SMP branch
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d38 1
a38 2
extern void mcount(void) __asm("__mcount");				\
__weak_alias(mcount,__mcount);						\
@


1.2
log
@Use __asm in place of asm
@
text
@d41 1
a41 1
extern void mcount() __asm("mcount");					\
@


1.1
log
@Initial revision
@
text
@d38 1
a38 1
#define	_MCOUNT_DECL static inline void _mcount
d41 1
a41 1
extern void mcount() asm("mcount");					\
d52 1
a52 1
	asm("movl 4(%%ebp),%0" : "=r" (selfpc));			\
d56 1
a56 1
	asm("movl (%%ebp),%0;movl 4(%0),%0" : "=r" (frompcindex));	\
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
