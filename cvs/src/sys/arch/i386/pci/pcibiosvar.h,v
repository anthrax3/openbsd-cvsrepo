head	1.18;
access;
symbols
	OPENBSD_6_2:1.18.0.28
	OPENBSD_6_2_BASE:1.18
	OPENBSD_6_1:1.18.0.30
	OPENBSD_6_1_BASE:1.18
	OPENBSD_6_0:1.18.0.26
	OPENBSD_6_0_BASE:1.18
	OPENBSD_5_9:1.18.0.22
	OPENBSD_5_9_BASE:1.18
	OPENBSD_5_8:1.18.0.24
	OPENBSD_5_8_BASE:1.18
	OPENBSD_5_7:1.18.0.16
	OPENBSD_5_7_BASE:1.18
	OPENBSD_5_6:1.18.0.20
	OPENBSD_5_6_BASE:1.18
	OPENBSD_5_5:1.18.0.18
	OPENBSD_5_5_BASE:1.18
	OPENBSD_5_4:1.18.0.14
	OPENBSD_5_4_BASE:1.18
	OPENBSD_5_3:1.18.0.12
	OPENBSD_5_3_BASE:1.18
	OPENBSD_5_2:1.18.0.10
	OPENBSD_5_2_BASE:1.18
	OPENBSD_5_1_BASE:1.18
	OPENBSD_5_1:1.18.0.8
	OPENBSD_5_0:1.18.0.6
	OPENBSD_5_0_BASE:1.18
	OPENBSD_4_9:1.18.0.4
	OPENBSD_4_9_BASE:1.18
	OPENBSD_4_8:1.18.0.2
	OPENBSD_4_8_BASE:1.18
	OPENBSD_4_7:1.17.0.10
	OPENBSD_4_7_BASE:1.17
	OPENBSD_4_6:1.17.0.12
	OPENBSD_4_6_BASE:1.17
	OPENBSD_4_5:1.17.0.8
	OPENBSD_4_5_BASE:1.17
	OPENBSD_4_4:1.17.0.6
	OPENBSD_4_4_BASE:1.17
	OPENBSD_4_3:1.17.0.4
	OPENBSD_4_3_BASE:1.17
	OPENBSD_4_2:1.17.0.2
	OPENBSD_4_2_BASE:1.17
	OPENBSD_4_1:1.16.0.2
	OPENBSD_4_1_BASE:1.16
	OPENBSD_4_0:1.15.0.4
	OPENBSD_4_0_BASE:1.15
	OPENBSD_3_9:1.15.0.2
	OPENBSD_3_9_BASE:1.15
	OPENBSD_3_8:1.14.0.4
	OPENBSD_3_8_BASE:1.14
	OPENBSD_3_7:1.14.0.2
	OPENBSD_3_7_BASE:1.14
	OPENBSD_3_6:1.13.0.2
	OPENBSD_3_6_BASE:1.13
	SMP_SYNC_A:1.12
	SMP_SYNC_B:1.12
	OPENBSD_3_5:1.12.0.2
	OPENBSD_3_5_BASE:1.12
	OPENBSD_3_4:1.11.0.2
	OPENBSD_3_4_BASE:1.11
	UBC_SYNC_A:1.10
	OPENBSD_3_3:1.10.0.6
	OPENBSD_3_3_BASE:1.10
	OPENBSD_3_2:1.10.0.4
	OPENBSD_3_2_BASE:1.10
	OPENBSD_3_1:1.10.0.2
	OPENBSD_3_1_BASE:1.10
	UBC_SYNC_B:1.10
	UBC:1.8.0.2
	UBC_BASE:1.8
	OPENBSD_3_0:1.7.0.2
	OPENBSD_3_0_BASE:1.7
	OPENBSD_2_9:1.6.0.4
	OPENBSD_2_9_BASE:1.6
	SMP:1.6.0.2
	OPENBSD_2_8:1.1.0.2
	OPENBSD_2_8_BASE:1.1;
locks; strict;
comment	@ * @;


1.18
date	2010.07.02.16.11.19;	author jsg;	state Exp;
branches;
next	1.17;

1.17
date	2007.03.19.05.32.05;	author deraadt;	state Exp;
branches;
next	1.16;

1.16
date	2006.11.29.22.40.13;	author miod;	state Exp;
branches;
next	1.15;

1.15
date	2005.11.23.09.24.57;	author mickey;	state Exp;
branches;
next	1.14;

1.14
date	2004.09.26.20.17.42;	author mickey;	state Exp;
branches;
next	1.13;

1.13
date	2004.06.22.09.47.01;	author mickey;	state Exp;
branches;
next	1.12;

1.12
date	2003.11.16.20.30.06;	author avsm;	state Exp;
branches;
next	1.11;

1.11
date	2003.07.30.05.26.33;	author mickey;	state Exp;
branches;
next	1.10;

1.10
date	2002.03.14.03.15.54;	author millert;	state Exp;
branches;
next	1.9;

1.9
date	2002.03.14.01.26.33;	author millert;	state Exp;
branches;
next	1.8;

1.8
date	2001.10.25.19.03.49;	author mickey;	state Exp;
branches
	1.8.2.1;
next	1.7;

1.7
date	2001.05.12.19.12.44;	author mickey;	state Exp;
branches;
next	1.6;

1.6
date	2001.01.27.04.59.40;	author mickey;	state Exp;
branches
	1.6.2.1;
next	1.5;

1.5
date	2001.01.25.01.00.59;	author mickey;	state Exp;
branches;
next	1.4;

1.4
date	2001.01.25.00.07.40;	author mickey;	state Exp;
branches;
next	1.3;

1.3
date	2001.01.24.23.40.29;	author mickey;	state Exp;
branches;
next	1.2;

1.2
date	2001.01.24.23.16.14;	author mickey;	state Exp;
branches;
next	1.1;

1.1
date	2000.10.31.18.56.42;	author deraadt;	state Exp;
branches;
next	;

1.6.2.1
date	2001.04.18.16.08.30;	author niklas;	state Exp;
branches;
next	1.6.2.2;

1.6.2.2
date	2001.07.04.10.18.06;	author niklas;	state Exp;
branches;
next	1.6.2.3;

1.6.2.3
date	2001.10.31.03.01.13;	author nate;	state Exp;
branches;
next	1.6.2.4;

1.6.2.4
date	2002.03.28.10.31.05;	author niklas;	state Exp;
branches;
next	1.6.2.5;

1.6.2.5
date	2004.02.19.10.48.42;	author niklas;	state Exp;
branches;
next	;

1.8.2.1
date	2002.06.11.03.35.54;	author art;	state Exp;
branches;
next	;


desc
@@


1.18
log
@remove unused pciaddr_search function.
ok kettenis@@
@
text
@/*	$OpenBSD: pcibiosvar.h,v 1.17 2007/03/19 05:32:05 deraadt Exp $	*/
/*	$NetBSD: pcibios.h,v 1.2 2000/04/28 17:15:16 uch Exp $	*/

/*
 * Copyright (c) 1999, by UCHIYAMA Yasushi
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. The name of the developer may NOT be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */

/*
 * Data structure definitions for the PCI BIOS interface.
 */

#define	PCIBIOS_ADDR_FIXUP	0x001
#define	PCIBIOS_BUS_FIXUP	0x002
#define	PCIBIOS_INTR_FIXUP	0x004
#define	PCIBIOS_INTR_GUESS	0x008
#define	PCIBIOS_VERBOSE		0x010
#define	PCIBIOS_INTRDEBUG	0x020
#define	PCIBIOS_FIXUP_FORCE	0x040

/*
 * PCI BIOS return codes.
 */
#define	PCIBIOS_SUCCESS			0x00
#define	PCIBIOS_SERVICE_NOT_PRESENT	0x80
#define	PCIBIOS_FUNCTION_NOT_SUPPORTED	0x81
#define	PCIBIOS_BAD_VENDOR_ID		0x83
#define	PCIBIOS_DEVICE_NOT_FOUND	0x86
#define	PCIBIOS_BAD_REGISTER_NUMBER	0x87
#define	PCIBIOS_SET_FAILED		0x88
#define	PCIBIOS_BUFFER_TOO_SMALL	0x89

struct pcibios_softc {
	struct device sc_dev;

	int max_bus;

	/* address fixup guts */
	struct extent *extent_mem;
	struct extent *extent_port;
	bus_addr_t mem_alloc_start;
	bus_addr_t port_alloc_start;
	int nbogus;
};

/*
 * PCI IRQ Routing Table definitions.
 */

/*
 * Slot entry (per PCI 2.1)
 */
struct pcibios_linkmap {
	u_int8_t	link;
	u_int16_t	bitmap;
} __packed;

struct pcibios_intr_routing {
	u_int8_t	bus;
	u_int8_t	device;
	struct pcibios_linkmap linkmap[4];	/* INT[A:D]# */
	u_int8_t	slot;
	u_int8_t	reserved;
} __packed;

/*
 * $PIR header.  Reference:
 *
 *	http://www.microsoft.com/whdc/archive/pciirq.mspx
 */
struct pcibios_pir_header {
	u_int32_t	signature;		/* $PIR */
	u_int16_t	version;
	u_int16_t	tablesize;
	u_int8_t	router_bus;
	u_int8_t	router_devfunc;
	u_int16_t	exclusive_irq;
	u_int32_t	compat_router;		/* PCI vendor/product */
	u_int32_t	miniport;
	u_int8_t	reserved[11];
	u_int8_t	checksum;
} __packed;

#define	PIR_DEVFUNC_DEVICE(devfunc)	(((devfunc) >> 3) & 0x1f)
#define	PIR_DEVFUNC_FUNCTION(devfunc)	((devfunc) & 7)
#define	PIR_DEVFUNC_COMPOSE(dev,func)	((((dev) &0x1f) << 3) | ((func) & 7))

void	pcibios_init(void);

extern struct pcibios_pir_header pcibios_pir_header;
extern struct pcibios_intr_routing *pcibios_pir_table;
extern int pcibios_pir_table_nentries;

extern int pcibios_flags;

typedef void *pciintr_icu_handle_t;

struct pciintr_icu {
	int	(*pi_getclink)(pciintr_icu_handle_t, int, int *);
	int	(*pi_get_intr)(pciintr_icu_handle_t, int, int *);
	int	(*pi_set_intr)(pciintr_icu_handle_t, int, int);
	int	(*pi_get_trigger)(pciintr_icu_handle_t, int, int *);
	int	(*pi_set_trigger)(pciintr_icu_handle_t, int, int);
};

typedef const struct pciintr_icu *pciintr_icu_tag_t;

#define	pciintr_icu_getclink(t, h, link, pirqp)				\
	(*(t)->pi_getclink)((h), (link), (pirqp))
#define	pciintr_icu_get_intr(t, h, pirq, irqp)				\
	(*(t)->pi_get_intr)((h), (pirq), (irqp))
#define	pciintr_icu_set_intr(t, h, pirq, irq)				\
	(*(t)->pi_set_intr)((h), (pirq), (irq))
#define	pciintr_icu_get_trigger(t, h, irq, triggerp)			\
	(*(t)->pi_get_trigger)((h), (irq), (triggerp))
#define	pciintr_icu_set_trigger(t, h, irq, trigger)			\
	(*(t)->pi_set_trigger)((h), (irq), (trigger))

#define	PCIBIOS_PRINTV(arg) \
	do { \
		if (pcibios_flags & PCIBIOS_VERBOSE) \
			printf arg; \
	} while (0)

#define	PCIADDR_SEARCH_IO	0
#define	PCIADDR_SEARCH_MEM	1

#define	PCI_INT_VIA_ISA		0x20000000 /* XXX see APIC_INT_VIA_APIC */

int  pci_intr_fixup(struct pcibios_softc *, pci_chipset_tag_t, bus_space_tag_t);
int  pci_bus_fixup(pci_chipset_tag_t, int);
void pci_addr_fixup(struct pcibios_softc *, pci_chipset_tag_t, int);
void pci_device_foreach(struct pcibios_softc *, pci_chipset_tag_t, int,
    void (*)(struct pcibios_softc *, pci_chipset_tag_t, pcitag_t));
int  pci_intr_header_fixup(pci_chipset_tag_t, pcitag_t, pci_intr_handle_t *);
int  pci_intr_route_link(pci_chipset_tag_t, pci_intr_handle_t *);
int  pci_intr_post_fixup(void);

/*
 * Init functions for our known PCI ICUs.
 */
int	piix_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	opti82c558_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	opti82c700_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	via82c586_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	via8231_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	sis85c503_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	amd756_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	ali1543_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	osb4_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);

@


1.17
log
@typo fixes; didickman@@gmail
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.16 2006/11/29 22:40:13 miod Exp $	*/
a146 1
struct extent *pciaddr_search(int, bus_addr_t *, bus_size_t);
@


1.16
log
@Nuke all commons but one, and enable --warn-common in LINKFLAGS.
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.15 2005/11/23 09:24:57 mickey Exp $	*/
d89 1
a89 1
 *	http://www.microsoft.com/HWDEV/busbios/PCIIRQ.htm
@


1.15
log
@resolve a couple of problems in mpbios-mapped interrupts:
- synthesise isa mappings (as 1-1) should those be missing in mpbios;
- for rcc osb* firce "special" ints into isa mappings always.
niklas@@ ok and testing by many since
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.14 2004/09/26 20:17:42 mickey Exp $	*/
d114 1
a114 1
int pcibios_flags;
@


1.14
log
@make PCIBIOS_INTR_FIXUP_FORCE into an UKCable flag instead; from Thorsten Glaser <tg@@66h.42h.de>
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.13 2004/06/22 09:47:01 mickey Exp $	*/
d148 2
@


1.13
log
@support for rcc osb4 and csb5; tested on quad-zion and another box i have
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.12 2003/11/16 20:30:06 avsm Exp $	*/
d39 1
@


1.12
log
@convert __attribute__((__packed__)) to __packed so that parsers unaware
of gcc extensions have more of a chance.
ok mcbride@@, no objections from millert@@, deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.11 2003/07/30 05:26:33 mickey Exp $	*/
d175 2
@


1.11
log
@support for vt8231 from netbsd via pr3362 and tested by matthew.gream@@pobox.com
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.10 2002/03/14 03:15:54 millert Exp $	*/
d75 1
a75 1
} __attribute__((__packed__));
d83 1
a83 1
} __attribute__((__packed__));
d101 1
a101 1
} __attribute__((__packed__));
@


1.10
log
@Final __P removal plus some cosmetic fixups
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.9 2002/03/14 01:26:33 millert Exp $	*/
d167 2
@


1.9
log
@First round of __P removal in sys
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.8 2001/10/25 19:03:49 mickey Exp $	*/
d151 2
a152 2
void pci_device_foreach __P((struct pcibios_softc *, pci_chipset_tag_t, int,
    void (*)(struct pcibios_softc *, pci_chipset_tag_t, pcitag_t)));
@


1.8
log
@add an ali1543 and fix amd756 icu drivers
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.7 2001/05/12 19:12:44 mickey Exp $	*/
d107 1
a107 1
void	pcibios_init __P((void));
d118 5
a122 5
	int	(*pi_getclink) __P((pciintr_icu_handle_t, int, int *));
	int	(*pi_get_intr) __P((pciintr_icu_handle_t, int, int *));
	int	(*pi_set_intr) __P((pciintr_icu_handle_t, int, int));
	int	(*pi_get_trigger) __P((pciintr_icu_handle_t, int, int *));
	int	(*pi_set_trigger) __P((pciintr_icu_handle_t, int, int));
d146 1
a146 1
struct extent *pciaddr_search __P((int, bus_addr_t *, bus_size_t));
d148 3
a150 3
int  pci_intr_fixup __P((struct pcibios_softc *, pci_chipset_tag_t, bus_space_tag_t));
int  pci_bus_fixup __P((pci_chipset_tag_t, int));
void pci_addr_fixup __P((struct pcibios_softc *, pci_chipset_tag_t, int));
d152 4
a155 4
    void (*) __P((struct pcibios_softc *, pci_chipset_tag_t, pcitag_t))));
int  pci_intr_header_fixup __P((pci_chipset_tag_t, pcitag_t, pci_intr_handle_t *));
int  pci_intr_route_link __P((pci_chipset_tag_t, pci_intr_handle_t *));
int  pci_intr_post_fixup __P((void));
d160 14
a173 14
int	piix_init __P((pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *));
int	opti82c558_init __P((pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *));
int	opti82c700_init __P((pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *));
int	via82c586_init __P((pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *));
int	sis85c503_init __P((pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *));
int	amd756_init __P((pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *));
int	ali1543_init __P((pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *));
@


1.8.2.1
log
@Sync UBC branch to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.8 2001/10/25 19:03:49 mickey Exp $	*/
d107 1
a107 1
void	pcibios_init(void);
d118 5
a122 5
	int	(*pi_getclink)(pciintr_icu_handle_t, int, int *);
	int	(*pi_get_intr)(pciintr_icu_handle_t, int, int *);
	int	(*pi_set_intr)(pciintr_icu_handle_t, int, int);
	int	(*pi_get_trigger)(pciintr_icu_handle_t, int, int *);
	int	(*pi_set_trigger)(pciintr_icu_handle_t, int, int);
d146 1
a146 1
struct extent *pciaddr_search(int, bus_addr_t *, bus_size_t);
d148 8
a155 8
int  pci_intr_fixup(struct pcibios_softc *, pci_chipset_tag_t, bus_space_tag_t);
int  pci_bus_fixup(pci_chipset_tag_t, int);
void pci_addr_fixup(struct pcibios_softc *, pci_chipset_tag_t, int);
void pci_device_foreach(struct pcibios_softc *, pci_chipset_tag_t, int,
    void (*)(struct pcibios_softc *, pci_chipset_tag_t, pcitag_t));
int  pci_intr_header_fixup(pci_chipset_tag_t, pcitag_t, pci_intr_handle_t *);
int  pci_intr_route_link(pci_chipset_tag_t, pci_intr_handle_t *);
int  pci_intr_post_fixup(void);
d160 14
a173 14
int	piix_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	opti82c558_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	opti82c700_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	via82c586_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	sis85c503_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	amd756_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	ali1543_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
@


1.7
log
@always print the icu we've found
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.6 2001/01/27 04:59:40 mickey Exp $	*/
d172 3
@


1.6
log
@change interrupt routing strategy from simple
run through the devices and programming the icu
and pci headers before real pci bus autoconf starts
and include all devices present on all pci busses,
to a per attached device routing in pci_intr_map().
this solves several cases of premature interrupts hanging
system due to absent interrupt handlers during autoconf.
10x for testing: millert@@ krw@@ aaron@@ chris@@ tholo@@ brad@@ jason@@ deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.5 2001/01/25 01:00:59 mickey Exp $	*/
d105 1
d148 1
a148 1
int  pci_intr_fixup __P((pci_chipset_tag_t, bus_space_tag_t));
@


1.6.2.1
log
@Update the SMP branch to -current, this breaks the SMP branch though.
But it will be fixed soonish.  Note, nothing new has happened, this is just
a merge of the trunk into this branch.
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.6 2001/01/27 04:59:40 mickey Exp $	*/
@


1.6.2.2
log
@Merge in -current from two days ago in the SMP branch.
As usual with merges, they do not indicate progress, so do not hold
your breath for working SMP, and do not mail me and ask about the
state of it.  It has not changed.  There is work ongoing, but very, very
slowly.  The commit is done in parts as to not lock up the tree in too
big chunks at a time.
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.6.2.1 2001/04/18 16:08:30 niklas Exp $	*/
a104 1
#define	PIR_DEVFUNC_COMPOSE(dev,func)	((((dev) &0x1f) << 3) | ((func) & 7))
d147 1
a147 1
int  pci_intr_fixup __P((struct pcibios_softc *, pci_chipset_tag_t, bus_space_tag_t));
@


1.6.2.3
log
@Sync the SMP branch to something just after 3.0
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.6.2.2 2001/07/04 10:18:06 niklas Exp $	*/
a171 3
int	ali1543_init __P((pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *));

@


1.6.2.4
log
@Merge in -current from about a week ago
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d107 1
a107 1
void	pcibios_init(void);
d118 5
a122 5
	int	(*pi_getclink)(pciintr_icu_handle_t, int, int *);
	int	(*pi_get_intr)(pciintr_icu_handle_t, int, int *);
	int	(*pi_set_intr)(pciintr_icu_handle_t, int, int);
	int	(*pi_get_trigger)(pciintr_icu_handle_t, int, int *);
	int	(*pi_set_trigger)(pciintr_icu_handle_t, int, int);
d146 1
a146 1
struct extent *pciaddr_search(int, bus_addr_t *, bus_size_t);
d148 8
a155 8
int  pci_intr_fixup(struct pcibios_softc *, pci_chipset_tag_t, bus_space_tag_t);
int  pci_bus_fixup(pci_chipset_tag_t, int);
void pci_addr_fixup(struct pcibios_softc *, pci_chipset_tag_t, int);
void pci_device_foreach(struct pcibios_softc *, pci_chipset_tag_t, int,
    void (*)(struct pcibios_softc *, pci_chipset_tag_t, pcitag_t));
int  pci_intr_header_fixup(pci_chipset_tag_t, pcitag_t, pci_intr_handle_t *);
int  pci_intr_route_link(pci_chipset_tag_t, pci_intr_handle_t *);
int  pci_intr_post_fixup(void);
d160 14
a173 14
int	piix_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	opti82c558_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	opti82c700_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	via82c586_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	sis85c503_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	amd756_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	ali1543_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
@


1.6.2.5
log
@Merge of current from two weeks agointo the SMP branch
@
text
@d75 1
a75 1
} __packed;
d83 1
a83 1
} __packed;
d101 1
a101 1
} __packed;
a166 2
	    pciintr_icu_tag_t *, pciintr_icu_handle_t *);
int	via8231_init(pci_chipset_tag_t, bus_space_tag_t, pcitag_t,
@


1.5
log
@make code for searching in pcibios's addr allocation
extents common for both io and mem and private to pcibios.
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.4 2001/01/25 00:07:40 mickey Exp $	*/
d15 12
a26 12
 * 
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND 
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE 
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE 
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE 
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS 
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) 
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT 
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY 
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF 
 * SUCH DAMAGE. 
d37 2
d52 13
a110 1
extern int pcibios_max_bus;
d112 1
a112 9
struct pciaddr {
	struct extent *extent_mem;
	struct extent *extent_port;
	bus_addr_t mem_alloc_start;
	bus_addr_t port_alloc_start;
	int nbogus;
};

extern struct pciaddr pciaddr;
a136 6

int pcibios_flags;

#ifdef PCIBIOSVERBOSE
extern int pcibiosverbose;

d139 1
a139 6
		if (pcibiosverbose) \
			printf arg; \
	} while (0)
#define	PCIBIOS_PRINTVN(n, arg) \
	do { \
		 if (pcibiosverbose > (n)) \
a141 4
#else
#define	PCIBIOS_PRINTV(arg)
#define	PCIBIOS_PRINTVN(n, arg)
#endif
d147 1
a147 1
int  pci_intr_fixup __P((pci_chipset_tag_t, bus_space_tag_t, u_int16_t *));
d149 6
a154 3
void pci_addr_fixup __P((pci_chipset_tag_t, int));
void pci_device_foreach __P((pci_chipset_tag_t, int,
    void (*) __P((pci_chipset_tag_t, pcitag_t))));
a170 1

@


1.4
log
@put pci_intr_fixup.h into pcibiosvar.h; billions of tiny headers for nothing
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.3 2001/01/24 23:40:29 mickey Exp $	*/
d151 4
@


1.3
log
@put pci_addr_fixup.h into pcibiosvar.h as well,
all it had were a struct and a proto.
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.2 2001/01/24 23:16:14 mickey Exp $	*/
d108 24
d152 1
d157 16
@


1.2
log
@elliminate pci_bus_fixup.h by moving
pci_bus_fixup() proto into pcibiosvar.h
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibiosvar.h,v 1.1 2000/10/31 18:56:42 deraadt Exp $	*/
d98 12
d129 1
a132 1
int pcibios_flags;
@


1.1
log
@rename pcibios.h to pcibiosvar.h
@
text
@d1 1
a1 1
/*	$OpenBSD: pcibios.h,v 1.7 2000/09/07 20:50:39 mickey Exp $	*/
a97 3
void pci_device_foreach __P((pci_chipset_tag_t, int,
			     void (*) (pci_chipset_tag_t, pcitag_t)));

d116 1
@

