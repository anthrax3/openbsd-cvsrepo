head	1.11;
access;
symbols
	SMP_SYNC_A:1.11
	SMP_SYNC_B:1.11
	UBC_SYNC_A:1.11
	UBC_SYNC_B:1.11
	SMP:1.11.0.2
	OPENBSD_2_1:1.7.0.2
	OPENBSD_2_1_BASE:1.7;
locks; strict;
comment	@# @;


1.11
date	97.08.12.19.05.53;	author mickey;	state dead;
branches;
next	1.10;

1.10
date	97.07.18.00.29.10;	author mickey;	state Exp;
branches;
next	1.9;

1.9
date	97.07.08.03.41.00;	author mickey;	state Exp;
branches;
next	1.8;

1.8
date	97.05.29.05.24.01;	author mickey;	state Exp;
branches;
next	1.7;

1.7
date	97.04.29.00.16.13;	author mickey;	state Exp;
branches
	1.7.2.1;
next	1.6;

1.6
date	97.04.28.07.39.01;	author weingart;	state Exp;
branches;
next	1.5;

1.5
date	97.04.21.20.20.28;	author mickey;	state Exp;
branches;
next	1.4;

1.4
date	97.04.21.19.52.51;	author mickey;	state Exp;
branches;
next	1.3;

1.3
date	97.04.09.08.39.27;	author mickey;	state Exp;
branches;
next	1.2;

1.2
date	97.03.31.03.12.12;	author weingart;	state Exp;
branches;
next	1.1;

1.1
date	96.10.29.09.22.58;	author mickey;	state dead;
branches
	1.1.2.1;
next	;

1.1.2.1
date	96.10.29.09.22.59;	author mickey;	state Exp;
branches;
next	1.1.2.2;

1.1.2.2
date	96.10.29.10.27.40;	author mickey;	state Exp;
branches;
next	;

1.7.2.1
date	97.06.01.09.53.08;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.11
log
@move that inline
@
text
@/*	$OpenBSD: biostime.S,v 1.10 1997/07/18 00:29:10 mickey Exp $	*/

/*
 * Copyright (c) 1997 Michael Shalayeff
 * Copyright (c) 1997 Tobias Weingartner
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by
 *	Michael Shalayeff and Tobias Weingartner.
 * 4. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR 
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 */

#include <machine/asm.h>
#define	_LOCORE
#include <machine/biosvar.h>
#undef	_LOCORE

/*
 * int usleep(u_long us);
 *	sleep for that number of microseconds
 *	returns nonzero if failed
 * This BIOSes do not have this call:
 * <mho> SystemSOFT BIOS for VLSI Eagle  II Version 1.01 (2618-00)
 * <mho> BIOS Version: 1.00.04, Date: 08/08/96
 * <mho> (WHatever that means...)
 */
ENTRY(usleep)
	pushl	%ebx
	pushl	%ecx

	xorl	%edx, %edx
	movl	8(%esp), %ecx
	movw	%cx, %dx
	shrl	$16, %ecx

	movb	$0x86, %ah
	DOINT(0x15)
#ifdef notdef
	xorb	%al, %al
	jnc	1f
	movl	%ah, %al
1:	movzbl	%al, %eax
#endif
	popl	%ecx
	popl	%ebx
	ret


/*
 * int biostime(char buf[4])
 */
ENTRY(biostime)
	pushl %ebp
	movl %esp, %ebp

	pushl	%ecx
	pushl	%ebx

	movb	$0x02, %ah
	DOINT(0x1a)
	movb	$1, %al
	jc	1f

	/* Get address of buffer */
	movl	8(%ebp), %ebx
	movb	%ch, 0(%ebx)
	movb	%cl, 1(%ebx)
	movb	%dh, 2(%ebx)
	movb	%dl, 3(%ebx)
	xorl	%eax, %eax

1:	movzbl	%al, %eax

	popl	%ebx
	popl	%ecx
	popl	%ebp
	ret


/*
 * int biosdate(char buf[4])
 */
ENTRY(biosdate)
	pushl %ebp
	movl %esp, %ebp

	pushl	%ecx
	pushl	%ebx

	movb	$0x04, %ah
	DOINT(0x1a)
	movb	$1, %al
	jc	1f

	/* Get address of buffer */
	movl	8(%ebp), %ebx
	movb	%ch, 0(%ebx)
	movb	%cl, 1(%ebx)
	movb	%dh, 2(%ebx)
	movb	%dl, 3(%ebx)
	xorl	%eax, %eax

1:	movzbl	%al, %eax

	popl	%ebx
	popl	%ecx
	popl	%ebp
	ret

@


1.10
log
@proper includes
s/BIOSINT/DOINT/g
pass %es in bios regs save area
@
text
@d1 1
a1 1
/*	$OpenBSD: biostime.S,v 1.9 1997/07/08 03:41:00 mickey Exp $	*/
@


1.9
log
@optimize
@
text
@d1 1
a1 1
/*	$OpenBSD: biostime.S,v 1.8 1997/05/29 05:24:01 mickey Exp $	*/
d39 1
a39 1
#include "biosdev.h"
d61 1
a61 1
	BIOSINT(0x15)
d84 1
a84 1
	BIOSINT(0x1a)
d115 1
a115 1
	BIOSINT(0x1a)
@


1.8
log
@safety
@
text
@d1 1
a1 1
/*	$OpenBSD: biostime.S,v 1.7 1997/04/29 00:16:13 mickey Exp $	*/
d46 4
d53 1
d55 1
d62 1
d67 2
a68 1

a82 3
	/* Get address of buffer */
	movl	8(%ebp), %ebx

d85 2
a86 1
	jc		1f
d88 2
a89 1
	movl	$0x0, %eax
d94 1
d96 1
a96 1
	jmp		2f
d98 1
a98 3
1:	movl	$0x01, %eax

2:	popl	%ebx
a113 3
	/* Get address of buffer */
	movl	8(%ebp), %ebx

d116 2
a117 1
	jc		1f
d119 2
a120 1
	movl	$0x0, %eax
d125 1
d127 1
a127 1
	jmp		2f
d129 1
a129 3
1:	movl	$0x01, %eax

2:	popl	%ebx
@


1.7
log
@ok.
@
text
@d1 1
a1 1
/*	$OpenBSD: biostime.S,v 1.6 1997/04/28 07:39:01 weingart Exp $	*/
d48 1
a48 1
	pushl	%ecx
d61 1
a61 1
	popl	%ecx
@


1.7.2.1
log
@2.1 laptop kbd fixes from mickey
@
text
@d1 1
a1 1
/*	$OpenBSD: biostime.S,v 1.8 1997/05/29 05:24:01 mickey Exp $	*/
d48 1
a48 1
	pushl	%ebx
d61 1
a61 1
	popl	%ebx
@


1.6
log
@Add getsecs().  Use biostime & biosdate routines.
Parse and convert to seconds since epoch.  Please
test, there is a new command "time", which should
print the current time (according to the BIOS) on
the console.
@
text
@d1 1
a1 1
/*	$OpenBSD: biostime.S,v 1.5 1997/04/21 20:20:28 mickey Exp $	*/
d5 1
d18 2
a19 1
 *	This product includes software developed by Michael Shalayeff.
d36 1
@


1.5
log
@usleep testing code
@
text
@d1 1
a1 1
/*	$OpenBSD: biostime.S,v 1.4 1997/04/21 19:52:51 mickey Exp $	*/
d61 1
d63 34
a96 1
 *
d98 27
a124 1
ENTRY(getsecs)
@


1.4
log
@rewrite
@
text
@d1 1
a1 1
/*	$OpenBSD: biostime.S,v 1.3 1997/04/09 08:39:27 mickey Exp $	*/
d53 4
a56 2
	setnc	%al
	movzbl	%al, %eax
@


1.3
log
@emulate bios calls. more debugging stuff. some fixes.
@
text
@d1 1
a1 1
/*	$OpenBSD: biostime.S,v 1.2 1997/03/31 03:12:12 weingart Exp $	*/
d4 28
a31 1
 * Ported to boot 386BSD by Julian Elischer (julian@@tfs.com) Sept 1992
a32 23
 * Mach Operating System
 * Copyright (c) 1992, 1991 Carnegie Mellon University
 * All Rights Reserved.
 * 
 * Permission to use, copy, modify and distribute this software and its
 * documentation is hereby granted, provided that both the copyright
 * notice and this permission notice appear in all copies of the
 * software, derivative works or modified versions, and any portions
 * thereof, and that both notices appear in supporting documentation.
 * 
 * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS "AS IS"
 * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR
 * ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.
 * 
 * Carnegie Mellon requests users of this software to return to
 * 
 *  Software Distribution Coordinator  or  Software.Distribution@@CS.CMU.EDU
 *  School of Computer Science
 *  Carnegie Mellon University
 *  Pittsburgh PA 15213-3890
 * 
 * any improvements or extensions that they make and grant Carnegie Mellon
 * the rights to redistribute these changes.
a33 24

/*
  Copyright 1988, 1989, 1990, 1991, 1992 
   by Intel Corporation, Santa Clara, California.

                All Rights Reserved

Permission to use, copy, modify, and distribute this software and
its documentation for any purpose and without fee is hereby
granted, provided that the above copyright notice appears in all
copies and that both the copyright notice and this permission notice
appear in supporting documentation, and that the name of Intel
not be used in advertising or publicity pertaining to distribution
of the software without specific, written prior permission.

INTEL DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE
INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS,
IN NO EVENT SHALL INTEL BE LIABLE FOR ANY SPECIAL, INDIRECT, OR
CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN ACTION OF CONTRACT,
NEGLIGENCE, OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION
WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
*/

d40 4
a43 10
# BIOS call "INT 15H Function 86H" to sleep for a set number of microseconds
#	Call with	%ah = 0x86
#			%cx = time interval (high)
#			%dx = time interval (low)
#	Return:	
#		If error
#			CF  = set
#		else
#			CF  = clear
*/
a45 1
	pushl	%edx
d47 3
a49 2
	movw	12(%esp), %dx
	movw	14(%esp), %cx
a55 1
	popl	%edx
d60 2
a61 3
#
#
*/
@


1.2
log
@Initial /boot stuff (from Mickey)
@
text
@d1 1
a1 1
/*	$OpenBSD: biostime.S,v 1.1.2.2 1996/10/29 10:27:40 mickey Exp $	*/
d55 3
a57 2
#define addr32	.byte 0x67
#define data32	.byte 0x66
d71 2
a72 3
	pushl	%ebp
	movl	%esp, %ebp
	pushl	%ebx
d74 2
a75 4
	movw	8(%ebp), %dx
	movw	10(%ebp), %cx

	call	_C_LABEL(prot_to_real)
d78 3
a80 9
	int	$0x15
	setnc	%ah

	movb	%ah, %bl	# real_to_prot uses %eax

	data32
	call	_C_LABEL(real_to_prot)

	movzbl	%bl, %eax
d82 2
a83 2
	popl	%ebx
	popl	%ebp
@


1.1
log
@file biostime.S was initially added on branch new.
@
text
@d1 100
@


1.1.2.1
log
@support libsa
@
text
@a0 101
/*	$OpenBSD$	*/

/*
 * Ported to boot 386BSD by Julian Elischer (julian@@tfs.com) Sept 1992
 *
 * Mach Operating System
 * Copyright (c) 1992, 1991 Carnegie Mellon University
 * All Rights Reserved.
 * 
 * Permission to use, copy, modify and distribute this software and its
 * documentation is hereby granted, provided that both the copyright
 * notice and this permission notice appear in all copies of the
 * software, derivative works or modified versions, and any portions
 * thereof, and that both notices appear in supporting documentation.
 * 
 * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS "AS IS"
 * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR
 * ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.
 * 
 * Carnegie Mellon requests users of this software to return to
 * 
 *  Software Distribution Coordinator  or  Software.Distribution@@CS.CMU.EDU
 *  School of Computer Science
 *  Carnegie Mellon University
 *  Pittsburgh PA 15213-3890
 * 
 * any improvements or extensions that they make and grant Carnegie Mellon
 * the rights to redistribute these changes.
 */

/*
  Copyright 1988, 1989, 1990, 1991, 1992 
   by Intel Corporation, Santa Clara, California.

                All Rights Reserved

Permission to use, copy, modify, and distribute this software and
its documentation for any purpose and without fee is hereby
granted, provided that the above copyright notice appears in all
copies and that both the copyright notice and this permission notice
appear in supporting documentation, and that the name of Intel
not be used in advertising or publicity pertaining to distribution
of the software without specific, written prior permission.

INTEL DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE
INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS,
IN NO EVENT SHALL INTEL BE LIABLE FOR ANY SPECIAL, INDIRECT, OR
CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN ACTION OF CONTRACT,
NEGLIGENCE, OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION
WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
*/

#include <machine/asm.h>
#define addr32	.byte 0x67
#define data32	.byte 0x66

/*
# BIOS call "INT 15H Function 86H" to sleep for a set number of microseconds
#	Call with	%ah = 0x86
#			%cx = time interval (high)
#			%dx = time interval (low)
#	Return:	
#		If error
#			CF  = set
#		else
#			CF  = clear
*/
ENTRY(usleep)
	pushl	%ebp
	movl	%esp, %ebp
	pushl	%ebx

	movw	8(%ebp), %dx
	movw	10(%ebp), %cx

	call	_C_LABEL(prot_to_real)

	movb	$0x86, %ah
	int	$0x15
	setnc	%ah

	movb	%ah, %bl	# real_to_prot uses %eax

	data32
	call	_C_LABEL(real_to_prot)

	xorl	%eax, %eax
	movb	%bl, %al

	popl	%ebx
	popl	%ebp
	ret

/*
#
#
*/
ENTRY(getsecs)
	ret

@


1.1.2.2
log
@don't load idt if NO_IDTR defined.
syntax error in conf.c
shave some bytes in *.S files.
@
text
@d1 1
a1 1
/*	$OpenBSD: biostime.S,v 1.1.2.1 1996/10/29 09:22:59 mickey Exp $	*/
d88 2
a89 1
	movzbl	%bl, %eax
@
