head	1.26;
access;
symbols
	OPENBSD_6_1:1.26.0.4
	OPENBSD_6_1_BASE:1.26
	OPENBSD_6_0:1.21.0.4
	OPENBSD_6_0_BASE:1.21
	OPENBSD_5_9:1.21.0.2
	OPENBSD_5_9_BASE:1.21
	OPENBSD_5_8:1.20.0.6
	OPENBSD_5_8_BASE:1.20
	OPENBSD_5_7:1.20.0.2
	OPENBSD_5_7_BASE:1.20
	OPENBSD_5_6:1.19.0.4
	OPENBSD_5_6_BASE:1.19
	OPENBSD_5_5:1.16.0.4
	OPENBSD_5_5_BASE:1.16
	OPENBSD_5_4:1.15.0.2
	OPENBSD_5_4_BASE:1.15
	OPENBSD_5_3:1.14.0.2
	OPENBSD_5_3_BASE:1.14
	OPENBSD_5_2:1.5.0.10
	OPENBSD_5_2_BASE:1.5
	OPENBSD_5_1_BASE:1.5
	OPENBSD_5_1:1.5.0.8
	OPENBSD_5_0:1.5.0.6
	OPENBSD_5_0_BASE:1.5
	OPENBSD_4_9:1.5.0.4
	OPENBSD_4_9_BASE:1.5
	OPENBSD_4_8:1.5.0.2
	OPENBSD_4_8_BASE:1.5
	OPENBSD_4_7:1.3.0.8
	OPENBSD_4_7_BASE:1.3
	OPENBSD_4_6:1.3.0.10
	OPENBSD_4_6_BASE:1.3
	OPENBSD_4_5:1.3.0.6
	OPENBSD_4_5_BASE:1.3
	OPENBSD_4_4:1.3.0.4
	OPENBSD_4_4_BASE:1.3
	OPENBSD_4_3:1.3.0.2
	OPENBSD_4_3_BASE:1.3
	OPENBSD_4_2:1.2.0.10
	OPENBSD_4_2_BASE:1.2
	OPENBSD_4_1:1.2.0.8
	OPENBSD_4_1_BASE:1.2
	OPENBSD_4_0:1.2.0.6
	OPENBSD_4_0_BASE:1.2
	OPENBSD_3_9:1.2.0.4
	OPENBSD_3_9_BASE:1.2
	OPENBSD_3_8:1.2.0.2
	OPENBSD_3_8_BASE:1.2
	OPENBSD_3_7:1.1.0.8
	OPENBSD_3_7_BASE:1.1
	OPENBSD_3_6:1.1.0.6
	OPENBSD_3_6_BASE:1.1
	SMP_SYNC_A:1.1
	SMP_SYNC_B:1.1
	SMP:1.1.0.4
	OPENBSD_3_5:1.1.0.2
	OPENBSD_3_5_BASE:1.1;
locks; strict;
comment	@# @;


1.26
date	2016.09.18.16.34.59;	author jsing;	state Exp;
branches;
next	1.25;
commitid	xxSOamF7jPcxnio1;

1.25
date	2016.09.11.17.52.47;	author jsing;	state Exp;
branches;
next	1.24;
commitid	OIt9eg6fQy6pFToA;

1.24
date	2016.09.11.15.54.11;	author jsing;	state Exp;
branches;
next	1.23;
commitid	m28Q0aUDbVqwDb3p;

1.23
date	2016.09.10.16.38.16;	author jsing;	state Exp;
branches;
next	1.22;
commitid	Guvt83tYQgzHIRwk;

1.22
date	2016.07.30.03.25.48;	author guenther;	state Exp;
branches;
next	1.21;
commitid	HVbAtwruDlJazNH2;

1.21
date	2015.09.02.04.09.24;	author yasuoka;	state Exp;
branches;
next	1.20;
commitid	1T0xGkKNIiRZnTmz;

1.20
date	2014.11.19.20.10.01;	author miod;	state Exp;
branches;
next	1.19;
commitid	wpSvUTrFjUmf0cF9;

1.19
date	2014.07.15.22.14.37;	author deraadt;	state Exp;
branches;
next	1.18;
commitid	NR8siXEkpaNp3MWn;

1.18
date	2014.07.13.09.26.08;	author jasper;	state Exp;
branches;
next	1.17;
commitid	Cnjup0HpCIRrcQ6o;

1.17
date	2014.07.12.21.54.58;	author jasper;	state Exp;
branches;
next	1.16;
commitid	3HeD4LaLGiS22I3y;

1.16
date	2013.12.28.02.51.07;	author deraadt;	state Exp;
branches;
next	1.15;

1.15
date	2013.04.23.16.41.13;	author jsing;	state Exp;
branches;
next	1.14;

1.14
date	2013.01.18.21.09.04;	author espie;	state Exp;
branches;
next	1.13;

1.13
date	2013.01.18.04.10.16;	author jsing;	state Exp;
branches;
next	1.12;

1.12
date	2013.01.18.03.45.23;	author jsing;	state Exp;
branches;
next	1.11;

1.11
date	2012.10.31.14.32.16;	author jsing;	state Exp;
branches;
next	1.10;

1.10
date	2012.10.29.14.39.08;	author jsing;	state Exp;
branches;
next	1.9;

1.9
date	2012.10.09.11.43.22;	author jsing;	state Exp;
branches;
next	1.8;

1.8
date	2012.09.25.09.01.03;	author pascal;	state Exp;
branches;
next	1.7;

1.7
date	2012.08.29.22.23.08;	author pascal;	state Exp;
branches;
next	1.6;

1.6
date	2012.08.21.14.46.19;	author pascal;	state Exp;
branches;
next	1.5;

1.5
date	2010.07.10.17.04.22;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	2010.07.10.16.11.44;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	2007.11.25.18.25.32;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	2005.07.30.14.32.46;	author millert;	state Exp;
branches;
next	1.1;

1.1
date	2004.03.19.13.48.19;	author tom;	state Exp;
branches
	1.1.4.1;
next	;

1.1.4.1
date	2004.06.05.23.09.01;	author niklas;	state Exp;
branches;
next	;


desc
@@


1.26
log
@Add bcrypt pbkdf support to the softraid crypto boot loader code.

Based on a diff from djm@@
@
text
@#	$OpenBSD: Makefile,v 1.25 2016/09/11 17:52:47 jsing Exp $

MAN=	pxeboot.8

.if ${MACHINE} == "i386"
S=	${.CURDIR}/../../../..
SADIR=	${.CURDIR}/..

PROG=	pxeboot
SRCS=	srt0.S conf.c devopen.c open.c
LD?=	ld
SIZE?=	size
LDFLAGS+=-nostdlib -Bstatic -Ttext $(LINKADDR) -N -x -nopie -znorelro
INSTALL_STRIP=
BINMODE=644

CLEANFILES+=	crt0.o ${PROG}.whole

.PATH:	${SADIR}/libsa
SRCS+=	debug_i386.S gidt.S random_i386.S
SRCS+=	cmd_i386.c exec_i386.c gateA20.c machdep.c
SRCS+=	apmprobe.c bioscons.c biosdev.c debug.c diskprobe.c memprobe.c \
	pciprobe.c ps2probe.c time.c
SRCS+=	pxe_call.S pxe.c pxe_net.c pxe_udp.c
SRCS+=	softraid_i386.c

.PATH:	${S}/stand/boot
SRCS+=	boot.c cmd.c vars.c bootarg.c

.PATH:	${S}/lib/libsa
SRCS+=	alloc.c ctime.c exit.c getchar.c globals.c memcmp.c memcpy.c memset.c \
	printf.c putchar.c snprintf.c strcmp.c strerror.c strlen.c strncmp.c \
	strncpy.c strtol.c strtoll.c
SRCS+=	close.c closeall.c cons.c cread.c dev.c disklabel.c dkcksum.c fstat.c \
	lseek.c read.c readdir.c stat.c
SRCS+=	elf32.c elf64.c loadfile.c
SRCS+=	nfs.c ufs.c tftp.c
SRCS+=	bootp.c ether.c net.c netif.c rpc.c
SRCS+=	aes_xts.c bcrypt_pbkdf.c blowfish.c explicit_bzero.c hmac_sha1.c \
	pkcs5_pbkdf2.c rijndael.c sha1.c sha2.c softraid.c

.PATH:	${S}/lib/libkern/arch/i386
SRCS+=	divdi3.c moddi3.c qdivrem.c udivdi3.c umoddi3.c

.PATH:	${S}/lib/libkern
SRCS+=	strlcpy.c

.PATH:	${S}/lib/libz
SRCS+=	adler32.c crc32.c inflate.c inftrees.c

.depend srt0.o gidt.o pxe_call.o: assym.h

${PROG}: $(OBJS)
	$(LD) $(LDFLAGS) -o ${PROG} $(OBJS)
	@@$(SIZE) ${PROG}
	cp ${PROG} ${PROG}.whole
	@@if [ -x ${.OBJDIR}/${PROG} ]; then \
		objcopy -O binary ${PROG} ${.OBJDIR}/.tmp;\
		mv -f ${.OBJDIR}/.tmp ${.OBJDIR}/${PROG}; \
		ls -l ${.OBJDIR}/${PROG}; \
	fi

.else
NOPROG=
.endif

.include <bsd.prog.mk>

CPPFLAGS+=-DSOFTRAID
CPPFLAGS+=-DBOOTMAGIC=$(BOOTMAGIC) ${DEBUGFLAGS} -DLINKADDR=${LINKADDR}
CPPFLAGS+=-DSLOW -DSMALL -DNOBYFOUR -DNO_GZIP -DDYNAMIC_CRC_TABLE
CPPFLAGS+=-DHEAP_LIMIT=${HEAP_LIMIT}
CPPFLAGS+=-I${S}/stand/boot
CFLAGS+=$(SACFLAGS) -D__INTERNAL_LIBSA_CREAD -fno-pie
#AFLAGS+=-Wa,-R
# AFLAGS+=-Wa,-a
AFLAGS+=-fno-pie
@


1.25
log
@Switch i386 boot code to libsa MI softraid.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.24 2016/09/11 15:54:11 jsing Exp $
d39 2
a40 2
SRCS+=	aes_xts.c explicit_bzero.c hmac_sha1.c pkcs5_pbkdf2.c rijndael.c \
	sha1.c softraid.c
@


1.24
log
@Rename softraid boot files, which are currently in an MD location. This
will allow us to bring in a MI softraid.{c,h} in lib/libsa.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.23 2016/09/10 16:38:16 jsing Exp $
d39 2
a40 1
SRCS+=	aes_xts.c explicit_bzero.c hmac_sha1.c pkcs5_pbkdf2.c rijndael.c sha1.c
@


1.23
log
@Rename libsa pbkdf2.c to pkcs5_pbkdf2.c so that we match libutil.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.22 2016/07/30 03:25:48 guenther Exp $
d25 1
a25 1
SRCS+=	softraid.c
@


1.22
log
@Prep for relro: make sure it's off for any non-PIE stand/ program

ok millert@@ kettenis@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.21 2015/09/02 04:09:24 yasuoka Exp $
d39 1
a39 1
SRCS+=	aes_xts.c explicit_bzero.c hmac_sha1.c pbkdf2.c rijndael.c sha1.c
@


1.21
log
@Bring the boot changes on amd64 to i386.  alloca is deleted.
Also fix the boot from BIOS and bump the version.

input and ok deraadt
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.20 2014/11/19 20:10:01 miod Exp $
d13 1
a13 1
LDFLAGS+=-nostdlib -Bstatic -Ttext $(LINKADDR) -N -x -nopie
@


1.20
log
@Only keep {recv,send}udp() in the pxe-specific code, the remainder of what
used to be local net.c (renamed to pxe_udp.c) can now be obtained from
libsa's net.c rather than being duplicated.

No functional change.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.19 2014/07/15 22:14:37 deraadt Exp $
d20 1
a20 1
SRCS+=	alloca.S debug_i386.S gidt.S random_i386.S
@


1.19
log
@mode 644 for installing these files
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.18 2014/07/13 09:26:08 jasper Exp $
d10 1
a10 1
SRCS=	srt0.S conf.c devopen.c net.c open.c
d24 1
a24 1
SRCS+=	pxe_call.S pxe.c pxe_net.c
d38 1
a38 1
SRCS+=	bootp.c ether.c netif.c rpc.c
@


1.18
log
@move putchar() into libsa

"sure" miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.17 2014/07/12 21:54:58 jasper Exp $
d15 1
@


1.17
log
@move getchar() into libsa where applicable

ok miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.16 2013/12/28 02:51:07 deraadt Exp $
d31 2
a32 2
	printf.c snprintf.c strcmp.c strerror.c strlen.c strncmp.c strncpy.c \
	strtol.c strtoll.c
@


1.16
log
@Try to load entropy data from disk:/etc/random.seed, and additionally
use a MD-supplied random function.  Then, insert this into the ELF
openbsd.randomdata of the kernel, so that it has entropy right from
the start.  Some help from jsing for the softraid aspects.
Also tested by phessler
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.15 2013/04/23 16:41:13 jsing Exp $
d30 3
a32 3
SRCS+=	alloc.c ctime.c exit.c globals.c memcmp.c memcpy.c memset.c printf.c \
	snprintf.c strcmp.c strerror.c strlen.c strncmp.c strncpy.c strtol.c \
	strtoll.c
@


1.15
log
@Include udivdi3/umoddi3 when compiling the amd64/i386 boot blocks - they
are needed for the upcoming type changes.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.14 2013/01/18 21:09:04 espie Exp $
d19 1
a19 1
SRCS+=	alloca.S debug_i386.S gidt.S
@


1.14
log
@fix bogus dependencies, and allow mkdep to run
checked on amd64 by rpe@@
okay jsing@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.13 2013/01/18 04:10:16 jsing Exp $
d41 1
a41 1
SRCS+=	moddi3.c divdi3.c qdivrem.c
@


1.13
log
@Generate assym.h where we need it, instead of reaching around into other
object directories.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.12 2013/01/18 03:45:23 jsing Exp $
d49 1
a49 3
${.CURDIR}/srt0.S: assym.h
${SADIR}/libsa/gidt.S: assym.h
${SADIR}/libsa/pxe_call.S: assym.h
@


1.12
log
@Clean up/standardise makefiles for i386/stand.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.11 2012/10/31 14:32:16 jsing Exp $
d48 4
@


1.11
log
@Enable softraid boot support for cdboot(8) and pxeboot(8).
@
text
@d1 1
a1 3
#	$OpenBSD: Makefile,v 1.10 2012/10/29 14:39:08 jsing Exp $

.include "${.CURDIR}/../Makefile.inc"
d6 1
a6 1
S	=${.CURDIR}/../../../..
@


1.10
log
@Build i386 cdboot(8) and pxeboot(8) using the same method as the amd64
versions. Compile all required sources directly, rather than linking
against uninstalled libraries.

Discussed with deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.9 2012/10/09 11:43:22 jsing Exp $
d26 1
d40 1
d67 1
@


1.9
log
@Remove -noinhibit-exec now that we no longer have to deal with
"relocation truncated" linker errors.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.8 2012/09/25 09:01:03 pascal Exp $
d12 1
a18 1
SRCS=	srt0.S
d20 6
a25 3
SRCS+=	boot.c cmd.c vars.c bootarg.c conf.c devopen.c net.c open.c
LDADD=	${LIBSA} ${LIBZ}
DPADD=	${LIBSA} ${LIBZ}
d27 15
a41 2
.PATH:	${S}/lib/libkern/arch/i386 ${S}/lib/libkern
SRCS+=	strlcpy.c moddi3.c divdi3.c qdivrem.c
d43 5
a47 1
.PATH:	${S}/stand/boot
d49 2
a50 2
${PROG}: $(OBJS) $(DPADD)
	$(LD) $(LDFLAGS) -o ${PROG} $(OBJS) $(LDADD)
d66 3
@


1.8
log
@Reduce the diff between amd64/stand and i386/stand, requested by deraadt@@.
These create essentially the same bootblocks, so the build system should not be
diverging too much, or at least easily diffable.
There is still a lot of work to be done here, but this is the low-hanging fruit.

ok jsing@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.7 2012/08/29 22:23:08 pascal Exp $
d14 1
a14 1
LDFLAGS+=-nostdlib -Bstatic -Ttext $(LINKADDR) -N -x -noinhibit-exec -nopie
@


1.7
log
@Kill all NOPIE and NOPIE_FLAGS in i386/stand, replacing them with -fno-pie
and -nopie directly.  Binaries from a PIE system are identical to those from
a recent snapshot.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.6 2012/08/21 14:46:19 pascal Exp $
d8 3
d14 1
a14 1
LDFLAGS+=-nostdlib -Bstatic -nopie
a16 1
LDFLAGS+=-Ttext $(LINKADDR) -N -x -noinhibit-exec
a20 3
S	=${.CURDIR}/../../../..
SADIR=	${.CURDIR}/..

d45 2
a46 3
CPPFLAGS+=-DBOOTMAGIC=$(BOOTMAGIC) ${DEBUGFLAGS}
CPPFLAGS+=-DLINKADDR=${LINKADDR}
CFLAGS+=${SACFLAGS} -D__INTERNAL_LIBSA_CREAD -fno-pie
@


1.6
log
@Add NOPIE= bits for sys/arch/*/stand to ensure that bootblocks will always be
built with -fno-pie.  This gets the hairiest part of PIE out of the way ...

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.5 2010/07/10 17:04:22 deraadt Exp $
d11 1
a11 1
LDFLAGS+=-nostdlib -Bstatic
d48 1
a48 2
CFLAGS+=${SACFLAGS} -D__INTERNAL_LIBSA_CREAD
CFLAGS+=${NOPIE_FLAGS}
d51 1
a51 1
AFLAGS+=${NOPIE_FLAGS}
@


1.5
log
@actually, pxeboot must remain linked with -N
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.3 2007/11/25 18:25:32 deraadt Exp $
d49 1
d52 1
@


1.4
log
@link bootblocks with -Z instead of -N, to ensure that the file offset and
addresses line up correctly.  Newer i386 gcc4 - for some reason -- is
prompting the linker with -N to not do this alignment which it used to do
(perhaps because the alignment of all .o's have dropped to very small
amounts??).  Using -Z wastes around a page of bootblock space which matters
even more on the small install media, so this definately needs revisiting.
Workaround from toby
@
text
@d14 2
a15 2
LDFLAGS+=-Ttext $(LINKADDR) -Z -x -noinhibit-exec
CLEANFILES+=	crt0.o
d33 1
@


1.3
log
@libkern, begone.  Move to a new mechanism where config(8)'s "file"
directive can select between MI and MD versions of these files.  At
the same time, adjust the boot programs to pick exactly what they need,
instead of the 7 or 8 mechanisms previously used.

There will be some fallout from this, but testing it all by myself is a
ridiculously slow process; it will be finished in-tree.

Various developers were very nice and avoided making fun of me when I
was gibbering in the corner..
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.2 2005/07/30 14:32:46 millert Exp $
d14 1
a14 1
LDFLAGS+=-Ttext $(LINKADDR) -N -x -noinhibit-exec
@


1.2
log
@Add libkern and link it in after libz
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.1 2004/03/19 13:48:19 tom Exp $
d22 5
a26 2
LDADD=	${LIBSA} ${LIBZ} ${LIBKERN}
DPADD=	${LIBSA} ${LIBZ} ${LIBKERN}
@


1.1
log
@Enter pxeboot, derived from the NetBSD implementation.  Initially
intended to support network installs using bsd.rd over TFTP.

Thanks to the many who tested, including Diana Eichert.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.31 2003/04/17 12:06:05 mickey Exp $
d22 2
a23 2
LDADD=	${LIBSA} ${LIBZ}
DPADD=	${LIBSA} ${LIBZ}
@


1.1.4.1
log
@Merge with the trunk
@
text
@d1 1
a1 1
#	$OpenBSD$
@

