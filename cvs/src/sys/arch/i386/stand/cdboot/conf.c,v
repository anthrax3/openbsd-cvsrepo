head	1.31;
access;
symbols
	OPENBSD_6_2:1.31.0.2
	OPENBSD_6_2_BASE:1.31
	OPENBSD_6_1:1.30.0.4
	OPENBSD_6_1_BASE:1.30
	OPENBSD_6_0:1.28.0.2
	OPENBSD_6_0_BASE:1.28
	OPENBSD_5_9:1.27.0.2
	OPENBSD_5_9_BASE:1.27
	OPENBSD_5_8:1.24.0.10
	OPENBSD_5_8_BASE:1.24
	OPENBSD_5_7:1.24.0.2
	OPENBSD_5_7_BASE:1.24
	OPENBSD_5_6:1.24.0.6
	OPENBSD_5_6_BASE:1.24
	OPENBSD_5_5:1.24.0.4
	OPENBSD_5_5_BASE:1.24
	OPENBSD_5_4:1.20.0.4
	OPENBSD_5_4_BASE:1.20
	OPENBSD_5_3:1.20.0.2
	OPENBSD_5_3_BASE:1.20
	OPENBSD_5_2:1.18.0.2
	OPENBSD_5_2_BASE:1.18
	OPENBSD_5_1_BASE:1.17
	OPENBSD_5_1:1.17.0.4
	OPENBSD_5_0:1.17.0.2
	OPENBSD_5_0_BASE:1.17
	OPENBSD_4_9:1.16.0.2
	OPENBSD_4_9_BASE:1.16
	OPENBSD_4_8:1.13.0.2
	OPENBSD_4_8_BASE:1.13
	OPENBSD_4_7:1.11.0.6
	OPENBSD_4_7_BASE:1.11
	OPENBSD_4_6:1.11.0.8
	OPENBSD_4_6_BASE:1.11
	OPENBSD_4_5:1.11.0.4
	OPENBSD_4_5_BASE:1.11
	OPENBSD_4_4:1.11.0.2
	OPENBSD_4_4_BASE:1.11
	OPENBSD_4_3:1.10.0.4
	OPENBSD_4_3_BASE:1.10
	OPENBSD_4_2:1.10.0.2
	OPENBSD_4_2_BASE:1.10
	OPENBSD_4_1:1.7.0.2
	OPENBSD_4_1_BASE:1.7
	OPENBSD_4_0:1.5.0.6
	OPENBSD_4_0_BASE:1.5
	OPENBSD_3_9:1.5.0.4
	OPENBSD_3_9_BASE:1.5
	OPENBSD_3_8:1.5.0.2
	OPENBSD_3_8_BASE:1.5
	OPENBSD_3_7:1.1.0.4
	OPENBSD_3_7_BASE:1.1
	OPENBSD_3_6:1.1.0.2
	OPENBSD_3_6_BASE:1.1;
locks; strict;
comment	@ * @;


1.31
date	2017.09.08.05.36.52;	author deraadt;	state Exp;
branches;
next	1.30;
commitid	uRv5pa9QDlZaYgwD;

1.30
date	2016.09.18.16.36.09;	author jsing;	state Exp;
branches;
next	1.29;
commitid	WkSscQaY8qKWlKae;

1.29
date	2016.09.13.18.27.49;	author jasper;	state Exp;
branches;
next	1.28;
commitid	PHzGPdVfpKxkA6ei;

1.28
date	2016.05.28.15.53.39;	author sthen;	state Exp;
branches;
next	1.27;
commitid	FG665gYSEoDAcq6f;

1.27
date	2016.02.19.21.30.06;	author naddy;	state Exp;
branches;
next	1.26;
commitid	xYBoDj8fiMmLqnCC;

1.26
date	2015.09.18.13.30.56;	author miod;	state Exp;
branches;
next	1.25;
commitid	1BEcCDYd9p5DIl0g;

1.25
date	2015.09.02.04.09.24;	author yasuoka;	state Exp;
branches;
next	1.24;
commitid	1T0xGkKNIiRZnTmz;

1.24
date	2014.02.18.13.56.02;	author jsing;	state Exp;
branches;
next	1.23;

1.23
date	2014.01.02.23.27.37;	author deraadt;	state Exp;
branches;
next	1.22;

1.22
date	2013.12.28.02.53.04;	author deraadt;	state Exp;
branches;
next	1.21;

1.21
date	2013.10.20.13.25.21;	author stsp;	state Exp;
branches;
next	1.20;

1.20
date	2012.10.31.14.32.54;	author jsing;	state Exp;
branches;
next	1.19;

1.19
date	2012.10.09.14.01.36;	author jsing;	state Exp;
branches;
next	1.18;

1.18
date	2012.06.03.13.17.47;	author kettenis;	state Exp;
branches;
next	1.17;

1.17
date	2011.03.08.17.24.31;	author krw;	state Exp;
branches;
next	1.16;

1.16
date	2010.12.06.22.51.45;	author jasper;	state Exp;
branches;
next	1.15;

1.15
date	2010.12.06.22.11.01;	author jasper;	state Exp;
branches;
next	1.14;

1.14
date	2010.12.06.18.44.49;	author jasper;	state Exp;
branches;
next	1.13;

1.13
date	2010.08.11.14.18.52;	author deraadt;	state Exp;
branches;
next	1.12;

1.12
date	2010.07.02.00.36.52;	author weingart;	state Exp;
branches;
next	1.11;

1.11
date	2008.04.19.23.20.22;	author weingart;	state Exp;
branches;
next	1.10;

1.10
date	2007.05.31.21.43.57;	author tom;	state Exp;
branches;
next	1.9;

1.9
date	2007.05.30.01.25.43;	author tom;	state Exp;
branches;
next	1.8;

1.8
date	2007.04.27.10.08.34;	author tom;	state Exp;
branches;
next	1.7;

1.7
date	2007.01.02.16.29.27;	author tom;	state Exp;
branches;
next	1.6;

1.6
date	2006.10.12.15.49.58;	author krw;	state Exp;
branches;
next	1.5;

1.5
date	2005.05.03.13.18.05;	author tom;	state Exp;
branches;
next	1.4;

1.4
date	2005.05.03.13.02.45;	author tom;	state Exp;
branches;
next	1.3;

1.3
date	2005.04.30.16.14.35;	author tom;	state Exp;
branches;
next	1.2;

1.2
date	2005.04.25.23.09.04;	author tom;	state Exp;
branches;
next	1.1;

1.1
date	2004.06.23.00.21.49;	author tom;	state Exp;
branches;
next	;


desc
@@


1.31
log
@If you use sys/param.h, you don't need sys/types.h
@
text
@/*	$OpenBSD: conf.c,v 1.30 2016/09/18 16:36:09 jsing Exp $	*/

/*
 * Copyright (c) 2004 Tom Cosgrove
 * Copyright (c) 1996 Michael Shalayeff
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR 
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */

#include <sys/param.h>
#include <netinet/in.h>
#include <libsa.h>
#include <lib/libsa/ufs.h>
#include <lib/libsa/cd9660.h>
#ifdef notdef
#include <lib/libsa/fat.h>
#include <lib/libsa/nfs.h>
#include <lib/libsa/tftp.h>
#include <lib/libsa/netif.h>
#endif
#include <biosdev.h>
#include <dev/cons.h>
#include "debug.h"

const char version[] = "3.28";
int	debug = 1;

void (*sa_cleanup)(void) = NULL;


void (*i386_probe1[])(void) = {
	ps2probe, gateA20on, debug_init, cninit, apmprobe,
	pciprobe, /* smpprobe, */ memprobe
};
void (*i386_probe2[])(void) = {
	diskprobe, cdprobe
};

struct i386_boot_probes probe_list[] = {
	{ "probing", i386_probe1, nitems(i386_probe1) },
	{ "disk",    i386_probe2, nitems(i386_probe2) },
};
int nibprobes = nitems(probe_list);

struct fs_ops file_system[] = {
	{ ufs_open,    ufs_close,    ufs_read,    ufs_write,    ufs_seek,
	  ufs_stat,    ufs_readdir    },
	{ cd9660_open, cd9660_close, cd9660_read, cd9660_write, cd9660_seek,
	  cd9660_stat, cd9660_readdir },
#ifdef notdef
	{ tftp_open,   tftp_close,   tftp_read,   tftp_write,   tftp_seek,
	  tftp_stat,   tftp_readdir   },
	{ nfs_open,    nfs_close,    nfs_read,    nfs_write,    nfs_seek,
	  nfs_stat,    nfs_readdir    },
	{ fat_open,    fat_close,    fat_read,    fat_write,    fat_seek,
	  fat_stat,    fat_readdir    },
#endif
};
int nfsys = nitems(file_system);

struct devsw	devsw[] = {
	{ "BIOS", biosstrategy, biosopen, biosclose, biosioctl },
};
int ndevs = nitems(devsw);

struct consdev constab[] = {
	{ pc_probe, pc_init, pc_getc, pc_putc },
	{ com_probe, com_init, com_getc, com_putc },
	{ NULL }
};
struct consdev *cn_tab = constab;
@


1.30
log
@Bump boot loader versions due to bcrypt pbkdf support.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.29 2016/09/13 18:27:49 jasper Exp $	*/
a30 1
#include <sys/types.h>
@


1.29
log
@crank bootloader version after .SUNW_ctf change

as discussed with jsing@@ it's easier this way to ensure people have
bootblocks capable of loading the section
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.28 2016/05/28 15:53:39 sthen Exp $	*/
d46 1
a46 1
const char version[] = "3.27";
@


1.28
log
@crank version numbers of those bootloaders that have been changed by
the com_init fix.  ok beck deraadt
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.27 2016/02/19 21:30:06 naddy Exp $	*/
d46 1
a46 1
const char version[] = "3.26";
@


1.27
log
@belatedly bump bootstrap version after mdrandom() changes; ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.26 2015/09/18 13:30:56 miod Exp $	*/
d46 1
a46 1
const char version[] = "3.25";
@


1.26
log
@Remove support for building the boot blocks with DEBUGFLAGS=-D_TEST, which is
supposed to create a userland binary in order to test non-boot related
functionality. This feature has been bitrotting in a non-compiling state
for years, and causes a too-many-ifdefs disease now that there are intrusive
EFI changes.

No functional change.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.25 2015/09/02 04:09:24 yasuoka Exp $	*/
d46 1
a46 1
const char version[] = "3.24";
@


1.25
log
@Bring the boot changes on amd64 to i386.  alloca is deleted.
Also fix the boot from BIOS and bump the version.

input and ok deraadt
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.24 2014/02/18 13:56:02 jsing Exp $	*/
a41 1
#include <lib/libsa/unixdev.h>
a48 3
#undef _TEST


a78 4
#ifdef _TEST
	{ null_open,   null_close,   null_read,   null_write,   null_seek,
	  null_stat,   null_readdir   }
#endif
a82 3
#ifdef _TEST
	{ "UNIX", unixstrategy, unixopen, unixclose, unixioctl },
#else
a83 1
#endif
a87 3
#ifdef _TEST
	{ unix_probe, unix_init, unix_getc, unix_putc },
#else
a89 1
#endif
@


1.24
log
@Bump version numbers.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.23 2014/01/02 23:27:37 deraadt Exp $	*/
d47 1
a47 1
const char version[] = "3.23";
@


1.23
log
@crank version after random instruction fix from jsing
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.22 2013/12/28 02:53:04 deraadt Exp $	*/
d47 1
a47 1
const char version[] = "3.22";
@


1.22
log
@crank the version
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.21 2013/10/20 13:25:21 stsp Exp $	*/
d47 1
a47 1
const char version[] = "3.21";
@


1.21
log
@Add i386/amd64 boot(8) support for keydisk-based softraid crypto volumes.

So far, only passphrase-based crypto volumes were bootable. Full disk
encryption with keydisks required a non-crypto partition to load the kernel.

The bootloader now scans all BIOS-visible disks for RAID partitions and
automatically associates keydisk partitions with their crypto volume.
Attempting to boot from a volume without its keydisk currently results
in a passphrase prompt (this might be changed in the future).

There is no need to re-create existing volumes. Moving the root partition
onto the crypto disk and running installboot(8) is all that's needed.

help & ok jsing
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.20 2012/10/31 14:32:54 jsing Exp $	*/
d47 1
a47 1
const char version[] = "3.20";
@


1.20
log
@Bump version numbers.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.17 2011/03/08 17:24:31 krw Exp $	*/
d47 1
a47 1
const char version[] = "3.19";
@


1.19
log
@Bump boot versions due to recent changes.
@
text
@d47 1
a47 1
const char version[] = "3.18";
@


1.18
log
@Add support for serial consoles at non-standard addresses.  This implements
a new "machine comaddr" command that makes it possible to configure the
io port used to access the serial port.  This can be used to use serial ports
on a puc(4) device as serial console.
@
text
@d47 1
a47 1
const char version[] = "3.17";
@


1.17
log
@Fix extended partition searching so we don't get lost. The offset
of the next EBR is relative to the start of the extended partition
described in the first MBR, not relative to the EBR specifying the
offset in its extended partition entry.

Clean up installboot -v output. Use daddr64_t for all sector numbers.

Not a complete fix, but better than what we had. More tweaks to
come.

Inspired by a diff and cluebat from uscav on tech@@ a few weeks
ago.

Feedback from matthew@@, weingart@@.

ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.16 2010/12/06 22:51:45 jasper Exp $	*/
d47 1
a47 1
const char version[] = "3.16";
@


1.16
log
@- properly remove NENTS now after fixing the fallout.

ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.15 2010/12/06 22:11:01 jasper Exp $	*/
d47 1
a47 1
const char version[] = "3.15";
@


1.15
log
@- partially revert previous NENTS removal for arches which got busted.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.14 2010/12/06 18:44:49 jasper Exp $	*/
d30 1
d65 2
a66 2
	{ "probing", i386_probe1, NENTS(i386_probe1) },
	{ "disk",    i386_probe2, NENTS(i386_probe2) },
d68 1
a68 1
int nibprobes = NENTS(probe_list);
d88 1
a88 1
int nfsys = NENTS(file_system);
d97 1
a97 1
int ndevs = NENTS(devsw);
@


1.14
log
@- drop NENTS(), which was yet another copy of nitems().
no binary change


ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.13 2010/08/11 14:18:52 deraadt Exp $	*/
d64 2
a65 2
	{ "probing", i386_probe1, nitems(i386_probe1) },
	{ "disk",    i386_probe2, nitems(i386_probe2) },
d67 1
a67 1
int nibprobes = nitems(probe_list);
d87 1
a87 1
int nfsys = nitems(file_system);
d96 1
a96 1
int ndevs = nitems(devsw);
@


1.13
log
@crank version
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.12 2010/07/02 00:36:52 weingart Exp $	*/
d64 2
a65 2
	{ "probing", i386_probe1, NENTS(i386_probe1) },
	{ "disk",    i386_probe2, NENTS(i386_probe2) },
d67 1
a67 1
int nibprobes = NENTS(probe_list);
d87 1
a87 1
int nfsys = NENTS(file_system);
d96 1
a96 1
int ndevs = NENTS(devsw);
@


1.12
log
@Add ability to limit memory presented to kernel with
'machine memory =128M' style commands.  Thanks to
phessler for finding a small man page niggle.  Bumped
version strings to a nice round fraction, and make them
the same across the board.  Easier to identify boot
binary versions that way.

ok thib@@, tedu@@, phessler@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.11 2008/04/19 23:20:22 weingart Exp $	*/
d46 1
a46 1
const char version[] = "3.14";
@


1.11
log
@Change ELF loader to use the LMA as the load address for the
various segments.  Hopefully this will help remove various
hacks in the boot loader in the future.  This should have no
effect on most architectures (as we tend to have LMA == VMA).

ok drahn@@, soft ok's various others.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.10 2007/05/31 21:43:57 tom Exp $	*/
d46 1
a46 1
const char version[] = "2.02";
@


1.10
log
@Forgot to commit the changes to this file with the rest of the ELF32+64
pieces.  Since this is where the "boot both ELF32 and ELF64" behaviour
is turned on for i386, it is quite important.

Bump version numbers too.

Found by ckuethe@@; thanks.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.9 2007/05/30 01:25:43 tom Exp $	*/
d46 1
a46 1
const char version[] = "2.01";
@


1.9
log
@Pull out the ELF loadfile pieces from the standalone libraries, so that
both 32- and 64-bit versions can be created (previously only one or the
other could be built for a given boot loader).

Use this to allow the i386 and amd64 boot blocks to boot both ELF32 and
ELF64 kernels (i.e. amd64 boot blocks can now load i386 kernels, and
vice versa).  Obviously the system must support LONG mode in order to
successfully run the amd64 kernel once it is loaded.

Advice and discussions from/with dale@@ (going back three years).  Much
testing nick@@ and todd@@; thanks.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.8 2007/04/27 10:08:34 tom Exp $	*/
d46 1
a46 1
const char version[] = "2.00";
@


1.8
log
@Check for Control key held down when starting, and don't read boot.conf
if it is.  This gives a way to recover from "switching to com0" when
there's no serial cable handy.

Bump version numbers.

A similar change will be made to amd64 boot soon.

ok toby@@ deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.7 2007/01/02 16:29:27 tom Exp $	*/
d46 1
a46 1
const char version[] = "1.07";
@


1.7
log
@Fix the keyboard problem seen on Intel Macs, where only the first
keypress is seen by boot.

It appears that on the Intel Mac, we have to issue the "check for
keystroke" BIOS call before the "get keystroke" call will get it
(unlike any other BIOS I have seen in over 20 years).

It would not have been possible to fix this problem without the
donation from Steven N. Fettig (steve (at) anywheretechnology.com);
many thanks.

Bump versions of boot, cdboot and pxeboot accordingly.

Testing kettenis@@, otto@@, and others; ok weingart@@.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.6 2006/10/12 15:49:58 krw Exp $	*/
d46 1
a46 1
const char version[] = "1.06";
@


1.6
log
@Bump versions to note behaviour change of no longer trying
to boot from NetBSD partitions. Requested by tom@@.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.5 2005/05/03 13:18:05 tom Exp $	*/
d46 1
a46 1
const char version[] = "1.05";
@


1.5
log
@The return value from getEBDAaddr() (info) is not used in bios_E820(),
so nuke it.  amd64 no longer needs biosprobe.c listed in SRCS.  Trims
100 bytes from the boot blocks.

Bump versions on boot, cdboot and pxeboot, as I'm getting cautious in
my old age.

ok weingart@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.4 2005/05/03 13:02:45 tom Exp $	*/
d46 1
a46 1
const char version[] = "1.04";
@


1.4
log
@Convert the size of a memory chunk from bytes to megabytes before
casting to a 32-bit value, not after.  Corrects the display of large
memory chunks in the probing: line (mem[615K 3518M 0M a20=on] becomes
mem[615K 3518M 12288M a20=on]).

Bump version on boot, cdboot and pxeboot accordingly.

"looks ok to me" weingart@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.3 2005/04/30 16:14:35 tom Exp $	*/
d46 1
a46 1
const char version[] = "1.03";
@


1.3
log
@Ensure we save the %ebx register returned from the BIOS call, not just
%bx.  Fixes problem introduced in gidt.S r1.29, which could lead to an
incomplete memory map, and "too little memory available; running in
degraded mode", as found by Roy Morris rmorris (at) internetsecure (dot)
com.  (Thanks for the report, and for testing the fix.)

Bump version on boot, cdboot and pxeboot accordingly.

ok weingart@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.2 2005/04/25 23:09:04 tom Exp $	*/
d46 1
a46 1
const char version[] = "1.02";
@


1.2
log
@[OpenBSD]

Make boot code use real mode with 64K segments instead of 1M
segments.  Improves stability with some disk controller cards.
Also explicitly state operand size on some moves.

Bump version on boot, cdboot and pxeboot accordingly.

"just get them in" beck@@ ok weingart@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.1 2004/06/23 00:21:49 tom Exp $	*/
d46 1
a46 1
const char version[] = "1.01";
@


1.1
log
@Enter cdboot, a CD-specific second-stage bootrap.

Testing krw@@ and todd@@, thanks.

assistance, testing and ok weingart@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.1 2004/03/19 13:48:19 tom Exp $	*/
d46 1
a46 1
const char version[] = "1.00";
@

