head	1.30;
access;
symbols
	OPENBSD_6_1_BASE:1.30
	OPENBSD_6_0:1.22.0.2
	OPENBSD_6_0_BASE:1.22
	OPENBSD_5_9:1.21.0.4
	OPENBSD_5_9_BASE:1.21
	OPENBSD_5_8:1.21.0.6
	OPENBSD_5_8_BASE:1.21
	OPENBSD_5_7:1.21.0.2
	OPENBSD_5_7_BASE:1.21
	OPENBSD_5_6:1.17.0.4
	OPENBSD_5_6_BASE:1.17
	OPENBSD_5_5:1.15.0.4
	OPENBSD_5_5_BASE:1.15
	OPENBSD_5_4:1.14.0.2
	OPENBSD_5_4_BASE:1.14
	OPENBSD_5_3:1.11.0.2
	OPENBSD_5_3_BASE:1.11
	OPENBSD_5_2:1.9.0.2
	OPENBSD_5_2_BASE:1.9
	OPENBSD_5_1_BASE:1.8
	OPENBSD_5_1:1.8.0.2
	OPENBSD_5_0:1.7.0.2
	OPENBSD_5_0_BASE:1.7
	OPENBSD_4_9:1.4.0.2
	OPENBSD_4_9_BASE:1.4;
locks; strict;
comment	@# @;


1.30
date	2017.03.18.17.31.31;	author visa;	state Exp;
branches;
next	1.29;
commitid	vFbZyjXkw28QhPsX;

1.29
date	2016.11.29.09.08.34;	author mpi;	state Exp;
branches;
next	1.28;
commitid	yUJbDchhkVm6F1HA;

1.28
date	2016.11.15.09.08.38;	author natano;	state Exp;
branches;
next	1.27;
commitid	uQeojuKIzgIWOEnv;

1.27
date	2016.10.27.20.44.20;	author natano;	state Exp;
branches;
next	1.26;
commitid	eR4vLZnymgQjVxbj;

1.26
date	2016.10.24.18.26.17;	author deraadt;	state Exp;
branches;
next	1.25;
commitid	84F8eQ949AbxN83e;

1.25
date	2016.10.15.13.45.08;	author deraadt;	state Exp;
branches;
next	1.24;
commitid	TtDw6IYffbT8oPEE;

1.24
date	2016.10.14.18.43.02;	author deraadt;	state Exp;
branches;
next	1.23;
commitid	dUZQxi6w3YqAb6KQ;

1.23
date	2016.09.24.19.13.03;	author kettenis;	state Exp;
branches;
next	1.22;
commitid	N8Z5nlTJHj3pmauV;

1.22
date	2016.04.29.12.44.52;	author mpi;	state Exp;
branches;
next	1.21;
commitid	Vbd8R29nZBKG6KtM;

1.21
date	2015.01.13.01.12.50;	author deraadt;	state Exp;
branches;
next	1.20;
commitid	xEYSgcMiEU7N21VE;

1.20
date	2015.01.11.19.25.14;	author tedu;	state Exp;
branches;
next	1.19;
commitid	Jqptj5xcqx8IMSNU;

1.19
date	2014.11.18.01.17.37;	author deraadt;	state Exp;
branches;
next	1.18;
commitid	Qj1gzxwenHvm4gTb;

1.18
date	2014.10.04.18.10.14;	author brad;	state Exp;
branches;
next	1.17;
commitid	iaz4yUwbbR9oynrV;

1.17
date	2014.06.27.17.28.10;	author miod;	state Exp;
branches;
next	1.16;
commitid	4oLMUaAeehjjGoUk;

1.16
date	2014.05.10.22.25.16;	author jasper;	state Exp;
branches;
next	1.15;

1.15
date	2013.10.15.19.23.29;	author guenther;	state Exp;
branches;
next	1.14;

1.14
date	2013.06.23.20.33.51;	author miod;	state Exp;
branches;
next	1.13;

1.13
date	2013.04.01.19.12.14;	author miod;	state Exp;
branches;
next	1.12;

1.12
date	2013.03.30.07.25.20;	author tedu;	state Exp;
branches;
next	1.11;

1.11
date	2012.08.28.21.03.32;	author pascal;	state Exp;
branches;
next	1.10;

1.10
date	2012.08.22.16.58.26;	author pascal;	state Exp;
branches;
next	1.9;

1.9
date	2012.06.17.11.02.32;	author miod;	state Exp;
branches;
next	1.8;

1.8
date	2011.11.08.18.41.34;	author matthieu;	state Exp;
branches;
next	1.7;

1.7
date	2011.07.07.22.28.18;	author guenther;	state Exp;
branches;
next	1.6;

1.6
date	2011.07.06.02.08.05;	author tedu;	state Exp;
branches;
next	1.5;

1.5
date	2011.04.15.02.41.28;	author guenther;	state Exp;
branches;
next	1.4;

1.4
date	2010.12.30.18.49.31;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	2010.12.02.20.57.08;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	2010.12.02.04.35.03;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	2010.09.20.06.32.30;	author syuu;	state Exp;
branches;
next	;


desc
@@


1.30
log
@Build mips64 kernels with -ffreestanding.

OK kettenis@@
@
text
@#	$OpenBSD: Makefile.octeon,v 1.29 2016/11/29 09:08:34 mpi Exp $

# For instructions on building kernels consult the config(8) and options(4)
# manual pages.
#
# N.B.: NO DEPENDENCIES ON FOLLOWING FLAGS ARE VISIBLE TO MAKEFILE
#	IF YOU CHANGE THE DEFINITION OF ANY OF THESE RECOMPILE EVERYTHING
# DEBUG is set to -g by config if debugging is requested (config -g).
# PROF is set to -pg by config if profiling is requested (config -p).

.include <bsd.own.mk>

SIZE?=	size
STRIP?=	strip
AS?=	as
CC?=	cc
LD?=	ld ${ENDIAN}

AS+=${ENDIAN}
CC+=${ENDIAN}
LD+=${ENDIAN}

# source tree is located via $S relative to the compilation directory
.ifndef S
S!=	cd ../../../..; pwd
.endif

_machdir?=	$S/arch/${_mach}
_archdir?=	$S/arch/${_arch}

INCLUDES=	-nostdinc -I$S -I${.OBJDIR} -I$S/arch
CPPFLAGS=	${INCLUDES} ${IDENT} ${PARAM} -D_KERNEL -D__${_mach}__ -MD -MP
CWARNFLAGS=	-Werror -Wall -Wimplicit-function-declaration \
		-Wno-uninitialized -Wno-pointer-sign \
		-Wframe-larger-than=2047

CMACHFLAGS=	-mno-abicalls ${ABI} -msoft-float -G 0
CMACHFLAGS+=	-ffreestanding ${NOPIE_FLAGS}
.if ${IDENT:M-DNO_PROPOLICE}
CMACHFLAGS+=	-fno-stack-protector
.endif

DEBUG?=		-g
COPTS?=		-O2
CFLAGS=		${DEBUG} ${CWARNFLAGS} ${CMACHFLAGS} ${COPTS} ${PIPE}
AFLAGS=		-D_LOCORE -x assembler-with-cpp ${CWARNFLAGS} ${CMACHFLAGS}
LDSCRIPT=	${_machdir}/conf/ld.script
LINKFLAGS=	-e start -T ${LDSCRIPT} -Ttext=${LINK_ADDRESS} -nopie
STRIPFLAGS=	-g -x

.if ${IDENT:M-DDDB_STRUCT}
DB_STRUCTINFO=	db_structinfo.h
.else
DB_STRUCTINFO=
.endif

HOSTCC?=	${CC}
HOSTED_CPPFLAGS=${CPPFLAGS:S/^-nostdinc$//}
HOSTED_CFLAGS=	${CFLAGS}
HOSTED_C=	${HOSTCC} ${HOSTED_CFLAGS} ${HOSTED_CPPFLAGS} -c $<

NORMAL_C_NOP=	${CC} ${CFLAGS} ${CPPFLAGS} -c $<
NORMAL_C=	${CC} ${CFLAGS} ${CPPFLAGS} ${PROF} -c $<
NORMAL_S=	${CC} ${AFLAGS} ${CPPFLAGS} -c $<

%OBJS

%CFILES

%SFILES

# load lines for config "xxx" will be emitted as:
# xxx: ${SYSTEM_DEP} swapxxx.o
#	${SYSTEM_LD_HEAD}
#	${SYSTEM_LD} swapxxx.o
#	${SYSTEM_LD_TAIL}
SYSTEM_HEAD=	locore.o param.o ioconf.o
SYSTEM_OBJ=	${SYSTEM_HEAD} ${OBJS}
SYSTEM_DEP=	Makefile ${SYSTEM_OBJ} ${LDSCRIPT}
SYSTEM_LD_HEAD=	@@rm -f $@@
SYSTEM_LD=	@@echo ${LD} ${LINKFLAGS} -o $@@ '$${SYSTEM_HEAD} vers.o $${OBJS}'; \
		${LD} ${LINKFLAGS} -o $@@ ${SYSTEM_HEAD} vers.o ${OBJS}
SYSTEM_LD_TAIL=	@@${SIZE} $@@; chmod 755 $@@

.if ${DEBUG} == "-g"
LINKFLAGS+=	-S
SYSTEM_LD_TAIL+=; \
		echo mv $@@ $@@.gdb; rm -f $@@.gdb; mv $@@ $@@.gdb; \
		echo ${STRIP} ${STRIPFLAGS} -o $@@ $@@.gdb; \
		${STRIP} ${STRIPFLAGS} -o $@@ $@@.gdb
.else
LINKFLAGS+=	-S
.endif

%LOAD

# cc's -MD puts the source and output paths in the dependency file;
# since those are temp files here we need to fix it up.  It also
# puts the file in /tmp, so we use -MF to put it in the current
# directory as assym.P and then generate assym.d from it with a
# good target name
assym.h: $S/kern/genassym.sh Makefile \
	 ${_archdir}/${_arch}/genassym.cf ${_machdir}/${_mach}/genassym.cf
	cat ${_archdir}/${_arch}/genassym.cf ${_machdir}/${_mach}/genassym.cf | \
	    sh $S/kern/genassym.sh ${CC} ${CFLAGS} ${CPPFLAGS} -MF assym.P > assym.h.tmp
	sed '1s/.*/assym.h: \\/' assym.P > assym.d
	sort -u assym.h.tmp > assym.h

param.c: $S/conf/param.c
	rm -f param.c
	cp $S/conf/param.c .

param.o: param.c Makefile
	${NORMAL_C}

mcount.o: $S/lib/libkern/mcount.c Makefile
	${NORMAL_C_NOP}

ioconf.o: ioconf.c
	${NORMAL_C}

vers.o: ${SYSTEM_DEP} ${SYSTEM_SWAP_DEP}
	sh $S/conf/newvers.sh
	${CC} ${CFLAGS} ${CPPFLAGS} ${PROF} -c vers.c

clean:
	rm -f *bsd *bsd.gdb *.[dio] [a-z]*.s assym.* ${DB_STRUCTINFO} param.c

cleandir: clean
	rm -f Makefile *.h ioconf.c options machine ${_mach} vers.c

symbols.sort: ${_machdir}/${_mach}/symbols.raw
	grep -v '^#' ${_machdir}/${_mach}/symbols.raw \
	    | sed 's/^	//' | sort -u > symbols.sort

depend obj:

db_structinfo.h: $S/ddb/db_structinfo.c $S/ddb/parse_structinfo.pl
	${CC} ${CFLAGS} ${CPPFLAGS} -MT $@@ -gstabs -c $S/ddb/db_structinfo.c
	objdump -g db_structinfo.o | perl $S/ddb/parse_structinfo.pl > $@@
	rm -f db_structinfo.o

locore.o: ${_machdir}/${_mach}/locore.S assym.h
context.o cp0access.o exception.o: assym.h
lcore_access.o lcore_ddb.o lcore_float.o tlbhandler.o: assym.h
mips64r2.o: assym.h

# The install target can be redefined by putting a
# install-kernel-${MACHINE_NAME} target into /etc/mk.conf
MACHINE_NAME!=  uname -n
install: install-kernel-${MACHINE_NAME}
.if !target(install-kernel-${MACHINE_NAME}})
install-kernel-${MACHINE_NAME}:
	cmp -s bsd /bsd || ln -f /bsd /obsd
	cp bsd /nbsd
	mv /nbsd /bsd
.endif

# pull in the dependency information
.if !empty(DB_STRUCTINFO) && !exists(${DB_STRUCTINFO})
 ${SYSTEM_OBJ}: ${DB_STRUCTINFO}
.endif
.ifnmake clean
. for o in ${SYSTEM_OBJ} assym.h ${DB_STRUCTINFO}
.  if exists(${o:R}.d)
.   include "${o:R}.d"
.  elif exists($o)
    .PHONY: $o
.  endif
. endfor
.endif

%RULES
@


1.29
log
@Build kernel with DEBUG=-g by default.

This will allow us to extract type informations from DWARF2 sections.  It
also makes developer life easier as debug information are now included in
every object.

Resulting kernels will be stripped using strip(1) instead of ld(1).

Kernel build time increases by approximately 10%.  However it is still
possible to disable this by defining DEBUG="".

ok kettenis@@, bluhm@@, natano@@, jasper@@, reyk@@, deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.28 2016/11/15 09:08:38 natano Exp $
d34 1
a34 1
		-Wno-main -Wno-uninitialized -Wno-pointer-sign \
d38 1
a38 3
CMACHFLAGS+=	-fno-builtin-printf -fno-builtin-snprintf \
		-fno-builtin-vsnprintf -fno-builtin-log \
		-fno-builtin-log2 -fno-builtin-malloc ${NOPIE_FLAGS}
@


1.28
log
@Clean up the kernel Makefile's:

- Remove the 'lint' target. lint has been removed with OpenBSD 5.2.
- Remove the 'tags' target. It does nothing of value.
- Replace 'clean::' with 'clean:', as requested by espie and millert,
  and remove files from the 'clean' target, that are never generated.
- Don't create a file called 'depend' in 'make depend', but just do
  nothing instead.

ok mpi tb
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.27 2016/10/27 20:44:20 natano Exp $
d45 1
a86 1
DEBUG?=
@


1.27
log
@We don't generate an eddep script for kernel builds nowadays. The last
reference to eddep in the kernel Makefile I could find is in 4.3BSD,
released some 30 years ago.

ok tb millert
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.26 2016/10/24 18:26:17 deraadt Exp $
d128 2
a129 3
clean::
	rm -f *bsd *bsd.gdb tags *.[dio] [a-z]*.s \
	    [Ee]rrs linterrs assym.* ${DB_STRUCTINFO} param.c
a133 5
lint:
	@@lint -hbxncez -Dvolatile= ${CPPFLAGS} -UKGDB \
	    ${CFILES} ioconf.c param.c | \
	    grep -v 'static function .* unused'

d138 1
a138 7
obj:

depend:
	@@touch $@@

tags:
	@@echo "see $S/kern/Makefile for tags"
@


1.26
log
@make cleandir should skip the version file; ok otto millert
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.25 2016/10/15 13:45:08 deraadt Exp $
d129 1
a129 1
	rm -f eddep *bsd *bsd.gdb tags *.[dio] [a-z]*.s \
@


1.25
log
@cleandir: target for kernel compile directories
ok natano
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.24 2016/10/14 18:43:02 deraadt Exp $
d133 1
a133 1
	rm -f Makefile *.h ioconf.c options machine ${_mach} vers.c version
@


1.24
log
@Kernel builds now happen in compile/CONFIG/obj@@ -> /usr/obj/... [or ./obj/,
if srctree is not rooted at /usr/src].  As a result, stock GENERIC & RAMDISK
kernels are commited to the tree, to ensure the src tree can be "readonly"
during builds, with all writes occuring inside the obj space.  config -b
options are handled by ../Makefile.inc.  The canonical new way to configure
one of these kernels is:
    % cd /sys/arch/amd64/compile/GENERIC.MP
    % doas make obj
    % make config
    % make
    % doas cp obj/bsd /bsd
The build infrastructure will use this new mechanism in a de-escalation
way using BUILDUSER.
Much help from natano and tb.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.23 2016/09/24 19:13:03 kettenis Exp $
d130 4
a133 1
	    [Ee]rrs linterrs assym.h ${DB_STRUCTINFO}
@


1.23
log
@Add -Wno-pointer-sign to all our gcc4 architectures.

ok patrick@@ (for armv7), deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.22 2016/04/29 12:44:52 mpi Exp $
d31 1
a31 1
INCLUDES=	-nostdinc -I$S -I. -I$S/arch
d140 2
@


1.22
log
@Do not remove local symbols from the table.

ddb(4) can now see static functions.  That doesn't mean we should start
declaring functions as ``static'', however it helps for the few existing
exceptions.

ok deraadt@@, kettenis@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.21 2015/01/13 01:12:50 deraadt Exp $
d34 1
a34 1
		-Wno-main -Wno-uninitialized \
@


1.21
log
@for the install: target, use cmp as a rough attempt for avoiding repeated
make install
from Simon Nicolussi
ok jsing tedu
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.20 2015/01/11 19:25:14 tedu Exp $
d88 1
a88 1
LINKFLAGS+=	-X
d94 1
a94 1
LINKFLAGS+=	-x
@


1.20
log
@switch prototype warnings to implicit-declaration warnings.
This should catch all the same bad cases, but be a little less aggravating
in circumstances where a prototype isn't necessary
ok deraadt
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.19 2014/11/18 01:17:37 deraadt Exp $
d163 1
a163 2
	rm -f /obsd
	ln /bsd /obsd
@


1.19
log
@(except for the arm architectures...) unify the way the ld.script is
used and depended, mimicking new changes by guenther to amd64.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.18 2014/10/04 18:10:14 brad Exp $
d33 1
a33 1
CWARNFLAGS=	-Werror -Wall -Wstrict-prototypes -Wmissing-prototypes \
@


1.18
log
@Switch the kernel configs over to using -Wframe-larger-than= instead of
-Wstack-larger-than-. This is what modern GCC supports as well as LLVM.

ok miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.17 2014/06/27 17:28:10 miod Exp $
d48 2
a49 2
LINKFLAGS=	-e start -T ${_machdir}/conf/ld.script -Ttext=${LINK_ADDRESS} \
		-nopie
d80 1
a80 1
SYSTEM_DEP=	Makefile ${SYSTEM_OBJ}
@


1.17
log
@Update list of .S depencies over assym.h.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.16 2014/05/10 22:25:16 jasper Exp $
d35 1
a35 1
		-Wstack-larger-than-2047
@


1.16
log
@various format string fixes and remove -Wno-format from octeon

feedback/ok miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.15 2013/10/15 19:23:29 guenther Exp $
d153 3
a155 2
cache_octeon2.o context.o cp0access.o exception.o: assym.h
fp.o lcore_access.o lcore_float.o tlbhandler.o lcore_ddb.o: assym.h
@


1.15
log
@Rewrite the awk script that generates the data for option DDB_STRUCT:
 - switch to perl for better data structures and (thus) speed
 - fix a couple glitches in the interpretation of the stabs output
 - compress the strings by putting them in one big array and overlaying
   suffixes
 - all sizes and offsets are <64k, so use u_short for them
This results in ~60% reduction in the resulting text size and it now
takes less than a second to create on fast platforms.

ok miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.14 2013/06/23 20:33:51 miod Exp $
d34 1
a34 1
		-Wno-main -Wno-uninitialized -Wno-format \
@


1.14
log
@Stop using -traditional-cpp on gcc3/4 platforms.

Add CWARNFLAGS to the command line when using -xassembler-with-cpp. We are
mostly interested in -Werror here.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.13 2013/04/01 19:12:14 miod Exp $
d147 1
a147 1
db_structinfo.h: $S/ddb/db_structinfo.c $S/ddb/parse_structinfo.awk
d149 1
a149 1
	objdump -g db_structinfo.o | awk -f $S/ddb/parse_structinfo.awk > $@@
@


1.13
log
@Build mips kernels with -G 0, to disable use of so-called `small' data and
bss sections. The current kernel linker script is not gp-friendly enough for
that; and while gas 2.15 was not attempting to output gp-relative relocations
for variables which might have ended up in .sdata or .sbss, gas 2.17 will,
and the kernel will fail to link.

To be improved eventually with a better kernel ld script putting the
gp-addressable sections close enough to gp... and making sure kernel gp is
reloaded in all the userland->kernel code paths which might need gp in the
kernel.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.12 2013/03/30 07:25:20 tedu Exp $
d47 1
a47 1
AFLAGS=		-D_LOCORE -x assembler-with-cpp ${CMACHFLAGS}
@


1.12
log
@reorder include search directories. cuts lookups by quite a bit.
ok deraadt miod
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.11 2012/08/28 21:03:32 pascal Exp $
d37 1
a37 1
CMACHFLAGS=	-mno-abicalls ${ABI} -msoft-float
@


1.11
log
@Add -nopie to LINKFLAGS on ELF architectures.  Note that this needs an
updated gcc and ld to understand the new -nopie flag.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.10 2012/08/22 16:58:26 pascal Exp $
d31 1
a31 1
INCLUDES=	-nostdinc -I. -I$S -I$S/arch
@


1.10
log
@Build the kernel with -fno-pie.  Just getting Ms out of my tree; this will be
cleaned up later.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.9 2012/06/17 11:02:32 miod Exp $
d48 2
a49 1
LINKFLAGS=	-e start -T ${_machdir}/conf/ld.script -Ttext=${LINK_ADDRESS}
@


1.9
log
@Remove leftover loongson or sgi references.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.8 2011/11/08 18:41:34 matthieu Exp $
d40 1
a40 1
		-fno-builtin-log2 -fno-builtin-malloc 
@


1.8
log
@Garbage collect now unused MKDEP definitions. ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.7 2011/07/07 22:28:18 guenther Exp $
d153 1
a153 1
fp.o lcore_access.o lcore_float.o tlbhandler.o lcore_ddb.o pmon32.o: assym.h
@


1.7
log
@The drahn memorial bad kernel build fix: prevent blood pressure
spikes in other developers by making it so that removal of a .d
file without removing the corresponding object will result in the
latter being treated as out of date.

ok beck@@ art@@ drahn@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.6 2011/07/06 02:08:05 tedu Exp $
a12 1
MKDEP?=	mkdep
@


1.6
log
@make clean should clean .d files, so as to leave a fresh canvas.
ok beck deraadt
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.5 2011/04/15 02:41:28 guenther Exp $
d173 5
a177 3
. for o in ${SYSTEM_OBJ:.o=.d} assym.d ${DB_STRUCTINFO:.h=.d}
.  if exists($o)
.   include "$o"
@


1.5
log
@Convert the kernel Makefiles to autogenerate dependencies during compilation
using the -MD option to cc, with -MP, -MT, and -MF where needed, converting
"make depend" to a no-op.  This increases parallelism for those using "make -j"
and keeps the dependencies up to date with each compilation automatically.

sparc and vax users will need to rebuild gcc with support for the
-M[PTF] options before config'ing with this diff.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.4 2010/12/30 18:49:31 deraadt Exp $
d129 1
a129 1
	rm -f eddep *bsd *bsd.gdb tags *.[io] [a-z]*.s \
@


1.4
log
@If genassym fails, sort on the pipeline will indicate no error resulting
in some grief.  Split this out.
From Vladimir Kirillov
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.3 2010/12/02 20:57:08 deraadt Exp $
d33 1
a33 1
CPPFLAGS=	${INCLUDES} ${IDENT} ${PARAM} -D_KERNEL -D__${_mach}__
d79 2
a80 1
SYSTEM_DEP=	Makefile ${SYSTEM_HEAD} ${OBJS}
d99 5
d107 2
a108 1
	    sh $S/kern/genassym.sh ${CC} ${CFLAGS} ${CPPFLAGS} > assym.h.tmp
d141 3
a146 14
AFILES=	${_machdir}/${_mach}/locore.S
depend:: .depend
.depend: ${AFILES} param.c ioconf.c ${CFILES} ${SFILES} assym.h ${DB_STRUCTINFO}
	${MKDEP} ${AFLAGS} ${CPPFLAGS} ${AFILES}
	${MKDEP} -a ${CFLAGS} ${CPPFLAGS} param.c ioconf.c ${CFILES}
.if !empty(SFILES)
	${MKDEP} -a ${AFLAGS} ${CPPFLAGS} ${SFILES}
.endif
	cat ${_archdir}/${_arch}/genassym.cf ${_machdir}/${_mach}/genassym.cf | \
	    sh $S/kern/genassym.sh ${MKDEP} -f assym.dep ${CFLAGS} ${CPPFLAGS}
	@@sed -e 's/.*\.o: /assym.h: /' -e 's/\/tmp\/genassym_c.[^ ]*//' \
	    < assym.dep >> .depend
	@@rm -f assym.dep

d148 1
a148 1
	${CC} ${CFLAGS} ${CPPFLAGS} -gstabs -c $S/ddb/db_structinfo.c
d166 12
@


1.3
log
@After the most recent change, make it possible to make -j again.  The
early MD and late MI files must be split up so that vers.o can sneak
between.  Issue spotted by bluhm, repair discussed with miod
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.2 2010/12/02 04:35:03 deraadt Exp $
d101 2
a102 3
	    sh $S/kern/genassym.sh ${CC} ${CFLAGS} ${CPPFLAGS} | \
	    sort -u > assym.h.tmp && \
	    mv -f assym.h.tmp assym.h
@


1.2
log
@move vers.o to before the other objects, so that it is not linked last.
having it linked last is bad (on at least i386 and amd64) because the lapic
is mapped over the start of the data segment -- savecore(8) then reads the
version string for a fixed buffer space, and reads into the lapic area
causing unintended side-effects (at least on Intel X5570 and X5680)
found by pedro, discussed with kettenis and mpf and miod
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.octeon,v 1.1 2010/09/20 06:32:30 syuu Exp $
d78 2
a79 2
SYSTEM_OBJ=	locore.o param.o ioconf.o vers.o ${OBJS}
SYSTEM_DEP=	Makefile ${SYSTEM_OBJ}
d81 2
a82 2
SYSTEM_LD=	@@echo ${LD} ${LINKFLAGS} -o $@@ '$${SYSTEM_OBJ}'; \
		${LD} ${LINKFLAGS} -o $@@ ${SYSTEM_OBJ}
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.loongson,v 1.25 2010/05/28 14:27:08 guenther Exp $
d78 1
a78 1
SYSTEM_OBJ=	locore.o param.o ioconf.o ${OBJS}
d81 2
a82 2
SYSTEM_LD=	@@echo ${LD} ${LINKFLAGS} -o $@@ '$${SYSTEM_OBJ}' vers.o; \
		${LD} ${LINKFLAGS} -o $@@ ${SYSTEM_OBJ} vers.o
@

