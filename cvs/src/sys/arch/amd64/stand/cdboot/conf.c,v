head	1.33;
access;
symbols
	OPENBSD_6_2_BASE:1.33
	OPENBSD_6_1:1.32.0.4
	OPENBSD_6_1_BASE:1.32
	OPENBSD_6_0:1.30.0.2
	OPENBSD_6_0_BASE:1.30
	OPENBSD_5_9:1.29.0.2
	OPENBSD_5_9_BASE:1.29
	OPENBSD_5_8:1.26.0.10
	OPENBSD_5_8_BASE:1.26
	OPENBSD_5_7:1.26.0.2
	OPENBSD_5_7_BASE:1.26
	OPENBSD_5_6:1.26.0.6
	OPENBSD_5_6_BASE:1.26
	OPENBSD_5_5:1.26.0.4
	OPENBSD_5_5_BASE:1.26
	OPENBSD_5_4:1.22.0.4
	OPENBSD_5_4_BASE:1.22
	OPENBSD_5_3:1.22.0.2
	OPENBSD_5_3_BASE:1.22
	OPENBSD_5_2:1.20.0.2
	OPENBSD_5_2_BASE:1.20
	OPENBSD_5_1_BASE:1.19
	OPENBSD_5_1:1.19.0.4
	OPENBSD_5_0:1.19.0.2
	OPENBSD_5_0_BASE:1.19
	OPENBSD_4_9:1.18.0.2
	OPENBSD_4_9_BASE:1.18
	OPENBSD_4_8:1.15.0.2
	OPENBSD_4_8_BASE:1.15
	OPENBSD_4_7:1.13.0.6
	OPENBSD_4_7_BASE:1.13
	OPENBSD_4_6:1.13.0.8
	OPENBSD_4_6_BASE:1.13
	OPENBSD_4_5:1.13.0.4
	OPENBSD_4_5_BASE:1.13
	OPENBSD_4_4:1.13.0.2
	OPENBSD_4_4_BASE:1.13
	OPENBSD_4_3:1.12.0.4
	OPENBSD_4_3_BASE:1.12
	OPENBSD_4_2:1.12.0.2
	OPENBSD_4_2_BASE:1.12
	OPENBSD_4_1:1.9.0.2
	OPENBSD_4_1_BASE:1.9
	OPENBSD_4_0:1.7.0.4
	OPENBSD_4_0_BASE:1.7
	OPENBSD_3_9:1.7.0.6
	OPENBSD_3_9_BASE:1.7
	OPENBSD_3_8:1.7.0.2
	OPENBSD_3_8_BASE:1.7
	OPENBSD_3_7:1.1.0.4
	OPENBSD_3_7_BASE:1.1
	OPENBSD_3_6:1.1.0.2
	OPENBSD_3_6_BASE:1.1;
locks; strict;
comment	@ * @;


1.33
date	2017.09.08.05.36.51;	author deraadt;	state Exp;
branches;
next	1.32;
commitid	uRv5pa9QDlZaYgwD;

1.32
date	2016.09.18.16.36.09;	author jsing;	state Exp;
branches;
next	1.31;
commitid	WkSscQaY8qKWlKae;

1.31
date	2016.09.13.18.27.48;	author jasper;	state Exp;
branches;
next	1.30;
commitid	PHzGPdVfpKxkA6ei;

1.30
date	2016.05.28.15.53.39;	author sthen;	state Exp;
branches;
next	1.29;
commitid	FG665gYSEoDAcq6f;

1.29
date	2016.02.19.21.30.06;	author naddy;	state Exp;
branches;
next	1.28;
commitid	xYBoDj8fiMmLqnCC;

1.28
date	2015.09.18.13.30.56;	author miod;	state Exp;
branches;
next	1.27;
commitid	1BEcCDYd9p5DIl0g;

1.27
date	2015.09.02.04.09.24;	author yasuoka;	state Exp;
branches;
next	1.26;
commitid	1T0xGkKNIiRZnTmz;

1.26
date	2014.02.18.13.56.02;	author jsing;	state Exp;
branches;
next	1.25;

1.25
date	2014.01.02.23.27.38;	author deraadt;	state Exp;
branches;
next	1.24;

1.24
date	2013.12.28.02.53.03;	author deraadt;	state Exp;
branches;
next	1.23;

1.23
date	2013.10.20.13.32.05;	author stsp;	state Exp;
branches;
next	1.22;

1.22
date	2012.10.29.13.59.52;	author jsing;	state Exp;
branches;
next	1.21;

1.21
date	2012.10.09.14.01.36;	author jsing;	state Exp;
branches;
next	1.20;

1.20
date	2012.06.03.13.18.33;	author kettenis;	state Exp;
branches;
next	1.19;

1.19
date	2011.03.08.17.24.31;	author krw;	state Exp;
branches;
next	1.18;

1.18
date	2010.12.06.22.51.45;	author jasper;	state Exp;
branches;
next	1.17;

1.17
date	2010.12.06.22.11.01;	author jasper;	state Exp;
branches;
next	1.16;

1.16
date	2010.12.06.18.44.49;	author jasper;	state Exp;
branches;
next	1.15;

1.15
date	2010.08.11.14.18.52;	author deraadt;	state Exp;
branches;
next	1.14;

1.14
date	2010.07.02.00.36.52;	author weingart;	state Exp;
branches;
next	1.13;

1.13
date	2008.04.19.23.20.22;	author weingart;	state Exp;
branches;
next	1.12;

1.12
date	2007.05.30.01.25.43;	author tom;	state Exp;
branches;
next	1.11;

1.11
date	2007.05.27.18.38.33;	author tom;	state Exp;
branches;
next	1.10;

1.10
date	2007.04.28.19.23.10;	author deraadt;	state Exp;
branches;
next	1.9;

1.9
date	2007.01.02.16.34.16;	author tom;	state Exp;
branches;
next	1.8;

1.8
date	2006.10.12.15.49.58;	author krw;	state Exp;
branches;
next	1.7;

1.7
date	2005.08.01.23.39.56;	author weingart;	state Exp;
branches;
next	1.6;

1.6
date	2005.05.28.05.47.33;	author weingart;	state Exp;
branches;
next	1.5;

1.5
date	2005.05.03.13.18.05;	author tom;	state Exp;
branches;
next	1.4;

1.4
date	2005.05.03.13.02.45;	author tom;	state Exp;
branches;
next	1.3;

1.3
date	2005.04.30.16.39.03;	author tom;	state Exp;
branches;
next	1.2;

1.2
date	2005.04.29.16.14.04;	author tom;	state Exp;
branches;
next	1.1;

1.1
date	2004.08.21.18.53.38;	author tom;	state Exp;
branches;
next	;


desc
@@


1.33
log
@If you use sys/param.h, you don't need sys/types.h
@
text
@/*	$OpenBSD: conf.c,v 1.32 2016/09/18 16:36:09 jsing Exp $	*/

/*
 * Copyright (c) 2004 Tom Cosgrove
 * Copyright (c) 1996 Michael Shalayeff
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR 
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */

#include <sys/param.h>
#include <netinet/in.h>
#include <libsa.h>
#include <lib/libsa/ufs.h>
#include <lib/libsa/cd9660.h>
#ifdef notdef
#include <lib/libsa/fat.h>
#include <lib/libsa/nfs.h>
#include <lib/libsa/tftp.h>
#include <lib/libsa/netif.h>
#endif
#include <biosdev.h>
#include <dev/cons.h>

const char version[] = "3.28";
int	debug = 1;


void (*sa_cleanup)(void) = NULL;


void (*amd64_probe1[])(void) = {
	gateA20on, cninit, memprobe
};
void (*amd64_probe2[])(void) = {
	diskprobe, cdprobe
};

struct i386_boot_probes probe_list[] = {
	{ "probing", amd64_probe1, nitems(amd64_probe1) },
	{ "disk",    amd64_probe2, nitems(amd64_probe2) }
};
int nibprobes = nitems(probe_list);

struct fs_ops file_system[] = {
	{ cd9660_open, cd9660_close, cd9660_read, cd9660_write, cd9660_seek,
	  cd9660_stat, cd9660_readdir },
	{ ufs_open,    ufs_close,    ufs_read,    ufs_write,    ufs_seek,
	  ufs_stat,    ufs_readdir    },
#ifdef notdef
	{ tftp_open,   tftp_close,   tftp_read,   tftp_write,   tftp_seek,
	  tftp_stat,   tftp_readdir   },
	{ nfs_open,    nfs_close,    nfs_read,    nfs_write,    nfs_seek,
	  nfs_stat,    nfs_readdir    },
	{ fat_open,    fat_close,    fat_read,    fat_write,    fat_seek,
	  fat_stat,    fat_readdir    },
#endif
};
int nfsys = nitems(file_system);

struct devsw	devsw[] = {
	{ "BIOS", biosstrategy, biosopen, biosclose, biosioctl },
};
int ndevs = nitems(devsw);

struct consdev constab[] = {
	{ pc_probe, pc_init, pc_getc, pc_putc },
	{ com_probe, com_init, com_getc, com_putc },
	{ NULL }
};
struct consdev *cn_tab = constab;
@


1.32
log
@Bump boot loader versions due to bcrypt pbkdf support.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.31 2016/09/13 18:27:48 jasper Exp $	*/
a30 1
#include <sys/types.h>
@


1.31
log
@crank bootloader version after .SUNW_ctf change

as discussed with jsing@@ it's easier this way to ensure people have
bootblocks capable of loading the section
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.30 2016/05/28 15:53:39 sthen Exp $	*/
d45 1
a45 1
const char version[] = "3.27";
@


1.30
log
@crank version numbers of those bootloaders that have been changed by
the com_init fix.  ok beck deraadt
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.29 2016/02/19 21:30:06 naddy Exp $	*/
d45 1
a45 1
const char version[] = "3.26";
@


1.29
log
@belatedly bump bootstrap version after mdrandom() changes; ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.28 2015/09/18 13:30:56 miod Exp $	*/
d45 1
a45 1
const char version[] = "3.25";
@


1.28
log
@Remove support for building the boot blocks with DEBUGFLAGS=-D_TEST, which is
supposed to create a userland binary in order to test non-boot related
functionality. This feature has been bitrotting in a non-compiling state
for years, and causes a too-many-ifdefs disease now that there are intrusive
EFI changes.

No functional change.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.27 2015/09/02 04:09:24 yasuoka Exp $	*/
d45 1
a45 1
const char version[] = "3.24";
@


1.27
log
@Bring the boot changes on amd64 to i386.  alloca is deleted.
Also fix the boot from BIOS and bump the version.

input and ok deraadt
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.26 2014/02/18 13:56:02 jsing Exp $	*/
a41 1
#include <lib/libsa/unixdev.h>
@


1.26
log
@Bump version numbers.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.25 2014/01/02 23:27:38 deraadt Exp $	*/
d46 1
a46 1
const char version[] = "3.23";
@


1.25
log
@crank version after random instruction fix from jsing
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.24 2013/12/28 02:53:03 deraadt Exp $	*/
d46 1
a46 1
const char version[] = "3.22";
@


1.24
log
@crank the version
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.23 2013/10/20 13:32:05 stsp Exp $	*/
d46 1
a46 1
const char version[] = "3.21";
@


1.23
log
@Bump version numbers. Was supposed to be part of the keydisk boot commit.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.22 2012/10/29 13:59:52 jsing Exp $	*/
d46 1
a46 1
const char version[] = "3.20";
@


1.22
log
@Bump version.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.19 2011/03/08 17:24:31 krw Exp $	*/
d46 1
a46 1
const char version[] = "3.19";
@


1.21
log
@Bump boot versions due to recent changes.
@
text
@d46 1
a46 1
const char version[] = "3.18";
@


1.20
log
@Add support for serial consoles at non-standard addresses.  This implements
a new "machine comaddr" command that makes it possible to configure the
io port used to access the serial port.  This can be used to use serial ports
on a puc(4) device as serial console.
@
text
@d46 1
a46 1
const char version[] = "3.17";
@


1.19
log
@Fix extended partition searching so we don't get lost. The offset
of the next EBR is relative to the start of the extended partition
described in the first MBR, not relative to the EBR specifying the
offset in its extended partition entry.

Clean up installboot -v output. Use daddr64_t for all sector numbers.

Not a complete fix, but better than what we had. More tweaks to
come.

Inspired by a diff and cluebat from uscav on tech@@ a few weeks
ago.

Feedback from matthew@@, weingart@@.

ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.18 2010/12/06 22:51:45 jasper Exp $	*/
d46 1
a46 1
const char version[] = "3.16";
@


1.18
log
@- properly remove NENTS now after fixing the fallout.

ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.17 2010/12/06 22:11:01 jasper Exp $	*/
d46 1
a46 1
const char version[] = "3.15";
@


1.17
log
@- partially revert previous NENTS removal for arches which got busted.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.16 2010/12/06 18:44:49 jasper Exp $	*/
d30 1
d61 2
a62 2
	{ "probing", amd64_probe1, NENTS(amd64_probe1) },
	{ "disk",    amd64_probe2, NENTS(amd64_probe2) }
d64 1
a64 1
int nibprobes = NENTS(probe_list);
d80 1
a80 1
int nfsys = NENTS(file_system);
d85 1
a85 1
int ndevs = NENTS(devsw);
@


1.16
log
@- drop NENTS(), which was yet another copy of nitems().
no binary change


ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.15 2010/08/11 14:18:52 deraadt Exp $	*/
d60 2
a61 2
	{ "probing", amd64_probe1, nitems(amd64_probe1) },
	{ "disk",    amd64_probe2, nitems(amd64_probe2) }
d63 1
a63 1
int nibprobes = nitems(probe_list);
d79 1
a79 1
int nfsys = nitems(file_system);
d84 1
a84 1
int ndevs = nitems(devsw);
@


1.15
log
@crank version
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.14 2010/07/02 00:36:52 weingart Exp $	*/
d60 2
a61 2
	{ "probing", amd64_probe1, NENTS(amd64_probe1) },
	{ "disk",    amd64_probe2, NENTS(amd64_probe2) }
d63 1
a63 1
int nibprobes = NENTS(probe_list);
d79 1
a79 1
int nfsys = NENTS(file_system);
d84 1
a84 1
int ndevs = NENTS(devsw);
@


1.14
log
@Add ability to limit memory presented to kernel with
'machine memory =128M' style commands.  Thanks to
phessler for finding a small man page niggle.  Bumped
version strings to a nice round fraction, and make them
the same across the board.  Easier to identify boot
binary versions that way.

ok thib@@, tedu@@, phessler@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.13 2008/04/19 23:20:22 weingart Exp $	*/
d45 1
a45 1
const char version[] = "3.14";
@


1.13
log
@Change ELF loader to use the LMA as the load address for the
various segments.  Hopefully this will help remove various
hacks in the boot loader in the future.  This should have no
effect on most architectures (as we tend to have LMA == VMA).

ok drahn@@, soft ok's various others.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.12 2007/05/30 01:25:43 tom Exp $	*/
d45 1
a45 1
const char version[] = "2.01";
@


1.12
log
@Pull out the ELF loadfile pieces from the standalone libraries, so that
both 32- and 64-bit versions can be created (previously only one or the
other could be built for a given boot loader).

Use this to allow the i386 and amd64 boot blocks to boot both ELF32 and
ELF64 kernels (i.e. amd64 boot blocks can now load i386 kernels, and
vice versa).  Obviously the system must support LONG mode in order to
successfully run the amd64 kernel once it is loaded.

Advice and discussions from/with dale@@ (going back three years).  Much
testing nick@@ and todd@@; thanks.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.11 2007/05/27 18:38:33 tom Exp $	*/
d45 1
a45 1
const char version[] = "2.00";
@


1.11
log
@Unbreak cdboot and pxeboot machine memory +/-; bad mpf@@.

ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.10 2007/04/28 19:23:10 deraadt Exp $	*/
d45 1
a45 1
const char version[] = "1.10";
@


1.10
log
@clone "Control key" logic from i386 written by tom; tested by art
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.9 2007/01/02 16:34:16 tom Exp $	*/
d45 1
a45 1
const char version[] = "1.09";
@


1.9
log
@Issue the BIOS "check for keystroke" call before "get keystroke", as
now required on i386 for Intel Macs.

Bump versions of boot, cdboot and pxeboot accordingly.

Reminded by deraadt@@.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.8 2006/10/12 15:49:58 krw Exp $	*/
d45 1
a45 1
const char version[] = "1.08";
@


1.8
log
@Bump versions to note behaviour change of no longer trying
to boot from NetBSD partitions. Requested by tom@@.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.7 2005/08/01 23:39:56 weingart Exp $	*/
d45 1
a45 1
const char version[] = "1.07";
@


1.7
log
@Increment version so we can distinguish this in the future.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.6 2005/05/28 05:47:33 weingart Exp $	*/
d45 1
a45 1
const char version[] = "1.06";
@


1.6
log
@*slightly drunk*

To all my "friends", and my lovely future wife...  Thank you.  Anyone
who still wants to sign the shirt, it's on my bakc.  Again, thank you.

This commit was ok'd by drahn@@, art@@, niklas@@, in spite of my condition.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.5 2005/05/03 13:18:05 tom Exp $	*/
d45 1
a45 1
const char version[] = "1.05";
@


1.5
log
@The return value from getEBDAaddr() (info) is not used in bios_E820(),
so nuke it.  amd64 no longer needs biosprobe.c listed in SRCS.  Trims
100 bytes from the boot blocks.

Bump versions on boot, cdboot and pxeboot, as I'm getting cautious in
my old age.

ok weingart@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.4 2005/05/03 13:02:45 tom Exp $	*/
d45 1
a45 1
const char version[] = "1.04";
@


1.4
log
@Convert the size of a memory chunk from bytes to megabytes before
casting to a 32-bit value, not after.  Corrects the display of large
memory chunks in the probing: line (mem[615K 3518M 0M a20=on] becomes
mem[615K 3518M 12288M a20=on]).

Bump version on boot, cdboot and pxeboot accordingly.

"looks ok to me" weingart@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.3 2005/04/30 16:39:03 tom Exp $	*/
d45 1
a45 1
const char version[] = "1.03";
@


1.3
log
@As on i386, ensure we save the %ebx register returned from the BIOS
call, not just %bx.  Fixes problem introduced in gidt.S r1.3.

Problem found, and fix tested, on i386 by Roy Morris rmorris (at)
internetsecure (dot) com.  Thanks.

Bump version on boot, cdboot and pxeboot accordingly.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.2 2005/04/29 16:14:04 tom Exp $	*/
d45 1
a45 1
const char version[] = "1.02";
@


1.2
log
@Make boot code use real mode with 64K segments instead of 1M segments,
to match i386 boot blocks.  Improves stability with some disk controller
cards.  Also expicitly state operand size on some moves.

Bump version on boot, cdboot and pxeboot accordingly.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.1 2004/06/23 00:21:49 tom Exp $	*/
d45 1
a45 1
const char version[] = "1.01";
@


1.1
log
@Enter cdboot, a CD-specific second-stage bootrap.  Based on the i386
cdboot that Toby and I put together at the hackathon.

"go for it" deraadt@@
@
text
@d45 1
a45 1
const char version[] = "1.00";
@

