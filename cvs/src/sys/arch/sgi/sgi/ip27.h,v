head	1.6;
access;
symbols
	OPENBSD_6_2:1.6.0.6
	OPENBSD_6_2_BASE:1.6
	OPENBSD_6_1:1.6.0.8
	OPENBSD_6_1_BASE:1.6
	OPENBSD_6_0:1.6.0.4
	OPENBSD_6_0_BASE:1.6
	OPENBSD_5_9:1.6.0.2
	OPENBSD_5_9_BASE:1.6
	OPENBSD_5_8:1.4.0.24
	OPENBSD_5_8_BASE:1.4
	OPENBSD_5_7:1.4.0.16
	OPENBSD_5_7_BASE:1.4
	OPENBSD_5_6:1.4.0.20
	OPENBSD_5_6_BASE:1.4
	OPENBSD_5_5:1.4.0.18
	OPENBSD_5_5_BASE:1.4
	OPENBSD_5_4:1.4.0.14
	OPENBSD_5_4_BASE:1.4
	OPENBSD_5_3:1.4.0.12
	OPENBSD_5_3_BASE:1.4
	OPENBSD_5_2:1.4.0.10
	OPENBSD_5_2_BASE:1.4
	OPENBSD_5_1_BASE:1.4
	OPENBSD_5_1:1.4.0.8
	OPENBSD_5_0:1.4.0.6
	OPENBSD_5_0_BASE:1.4
	OPENBSD_4_9:1.4.0.4
	OPENBSD_4_9_BASE:1.4
	OPENBSD_4_8:1.4.0.2
	OPENBSD_4_8_BASE:1.4
	OPENBSD_4_7:1.2.0.2
	OPENBSD_4_7_BASE:1.2
	OPENBSD_4_6:1.1.0.2
	OPENBSD_4_6_BASE:1.1;
locks; strict;
comment	@ * @;


1.6
date	2015.12.25.09.02.57;	author visa;	state Exp;
branches;
next	1.5;
commitid	up7cBfv7QqAqYrQj;

1.5
date	2015.12.25.08.34.51;	author visa;	state Exp;
branches;
next	1.4;
commitid	mGLOAekfSVArdeBr;

1.4
date	2010.05.09.18.37.47;	author miod;	state Exp;
branches;
next	1.3;

1.3
date	2010.03.20.16.22.55;	author miod;	state Exp;
branches;
next	1.2;

1.2
date	2009.11.07.14.49.01;	author miod;	state Exp;
branches;
next	1.1;

1.1
date	2009.05.28.18.02.43;	author miod;	state Exp;
branches;
next	;


desc
@@


1.6
log
@Add launch logic for secondary CPUs. The PROM's launch entry point address
and function signature are from Linux.
@
text
@/*	$OpenBSD: ip27.h,v 1.5 2015/12/25 08:34:51 visa Exp $	*/

/*
 * Copyright (c) 2009 Miodrag Vallat.
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

/*
 * Non-XBow related IP27 and IP35 definitions
 */

/* NMI register save areas */

#define	IP27_NMI_KREGS_BASE		0x11400
#define	IP27_NMI_KREGS_SIZE		0x200	/* per CPU */
#define	IP27_NMI_EFRAME_BASE		0x11800

#define	IP35_NMI_KREGS_BASE		0x9000
#define	IP35_NMI_KREGS_SIZE		0x400	/* per CPU */
#define	IP35_NMI_EFRAME_BASE		0xa000

/* IP27 system types */

#define	IP27_SN0	0x00
#define	IP27_SN00	0x01
#define	IP27_O200	IP27_SN00
#define	IP27_O2K	IP27_SN0
#define	IP27_UNKNOWN	0x02

/* IP35 Brick types */

#define	IP35_CBRICK	0x00
#define	IP35_O350	0x02
#define	IP35_FUEL	0x04
#define	IP35_O300	0x08

/*
 * Specific device assignment
 */

#define	IP27_O200_BRIDGE_WIDGET		8
#define	IP27_O2K_BRIDGE_WIDGET		15

#define	IP27_IOC_SLOTNO			2
#define	IP27_IOC2_SLOTNO		6

/* PROM entry points */

#define IP27_PROM_LAUNCH_SLAVE		0x1fc00038

#define ip27_prom_launch_slave (*(void (*)(int nasid, int cpu, \
    void (*func)(uint64_t), uint64_t param, uint64_t sp, \
    uint64_t gp))PHYS_TO_CKSEG1(IP27_PROM_LAUNCH_SLAVE))

/*
 * IP27 configuration structure.  Used to tell Origin 200 and Origin 2000
 * apart.
 */

#define	IP27_CONFIG_OFFSET	0x60	/* relative to LBOOTBASE */
#define	IP27_CONFIG_MAGIC	0x69703237636f6e66LL	/* "ip27conf" */

struct ip27_config {
	volatile uint32_t	time_const;
	volatile uint32_t	r10k_sysad;
	volatile uint64_t	magic;
	volatile uint64_t	cpu_hz;
	volatile uint64_t	hub_hz;
	volatile uint64_t	rtc_hz;
	volatile uint32_t	ecc_enable;
	volatile uint32_t	fprom_cyc;
	volatile uint32_t	ip27_subtype;
	volatile uint32_t	cksum;
	volatile uint32_t	flash_count;
	volatile uint32_t	fprom_wr;
	volatile uint32_t	prom_ver;
	volatile uint32_t	prom_rev;
	volatile uint32_t	config_specific;
};

/*
 * CPU identification
 */

#define IP27_SLICE_LCPU(x)		((x) & 1)
#define IP27_SLICE_SUBNODE(x)		(((x) & 2) >> 1)
@


1.5
log
@Make interrupt masking MP-aware. Linux IP27 and IP35 ports served as a
substitute for hardware documentation.
@
text
@d1 1
a1 1
/*	$OpenBSD: ip27.h,v 1.4 2010/05/09 18:37:47 miod Exp $	*/
d57 8
@


1.4
log
@Proper support for IP35 C-Brick types (i.e. Origin 3000): do not attach
a (missing) second serial port to ioc(4), read spdmem(4) records from the
right index, and query the Ethernet address from the I-Brick eeprom instead
of the C-Brick eeprom.
Tested by Sebastian Reitenbach, thanks!
@
text
@d1 1
a1 1
/*	$OpenBSD: ip27.h,v 1.3 2010/03/20 16:22:55 miod Exp $	*/
d83 7
@


1.3
log
@Add code to tell Origin 200 and Origin 2000 / Onyx 2 apart.
Use this to correctly handle the onboard IOC3 chip configuration on O2k
(two IOC3 chips to be able to provide four serial ports, and the other
 subdevices are split accross the two IOC3 chips).
@
text
@d1 1
a1 1
/*	$OpenBSD: ip27.h,v 1.2 2009/11/07 14:49:01 miod Exp $	*/
d43 1
@


1.2
log
@Change sgi system identification from a single system type list, to a smaller
system type list (which really is the system family) and a subsystem type.

No functional change yet.
@
text
@d1 1
a1 1
/*	$OpenBSD: ip27.h,v 1.1 2009/05/28 18:02:43 miod Exp $	*/
d33 8
d46 36
@


1.1
log
@Handle NMI interrupts on IP27/IP35, gives us a change to play with ddb,
and then restart system (NMI on these systems aren't intended to be
recoverable).
@
text
@d1 1
a1 1
/*	$OpenBSD: ip30.h,v 1.1 2008/04/07 22:43:45 miod Exp $	*/
d32 6
@

