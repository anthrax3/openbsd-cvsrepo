head	1.47;
access;
symbols
	OPENBSD_6_1:1.47.0.10
	OPENBSD_6_1_BASE:1.47
	OPENBSD_6_0:1.47.0.8
	OPENBSD_6_0_BASE:1.47
	OPENBSD_5_9:1.47.0.4
	OPENBSD_5_9_BASE:1.47
	OPENBSD_5_8:1.47.0.6
	OPENBSD_5_8_BASE:1.47
	OPENBSD_5_7:1.47.0.2
	OPENBSD_5_7_BASE:1.47
	OPENBSD_5_6:1.46.0.4
	OPENBSD_5_6_BASE:1.46
	OPENBSD_5_5:1.45.0.6
	OPENBSD_5_5_BASE:1.45
	OPENBSD_5_4:1.45.0.2
	OPENBSD_5_4_BASE:1.45
	OPENBSD_5_3:1.44.0.6
	OPENBSD_5_3_BASE:1.44
	OPENBSD_5_2:1.44.0.4
	OPENBSD_5_2_BASE:1.44
	OPENBSD_5_1_BASE:1.44
	OPENBSD_5_1:1.44.0.2
	OPENBSD_5_0:1.43.0.2
	OPENBSD_5_0_BASE:1.43
	OPENBSD_4_9:1.42.0.2
	OPENBSD_4_9_BASE:1.42
	OPENBSD_4_8:1.41.0.2
	OPENBSD_4_8_BASE:1.41
	OPENBSD_4_7:1.34.0.2
	OPENBSD_4_7_BASE:1.34
	OPENBSD_4_6:1.32.0.6
	OPENBSD_4_6_BASE:1.32
	OPENBSD_4_5:1.32.0.2
	OPENBSD_4_5_BASE:1.32
	OPENBSD_4_4:1.31.0.4
	OPENBSD_4_4_BASE:1.31
	OPENBSD_4_3:1.31.0.2
	OPENBSD_4_3_BASE:1.31
	OPENBSD_4_2:1.30.0.2
	OPENBSD_4_2_BASE:1.30
	OPENBSD_4_1:1.29.0.6
	OPENBSD_4_1_BASE:1.29
	OPENBSD_4_0:1.29.0.4
	OPENBSD_4_0_BASE:1.29
	OPENBSD_3_9:1.29.0.2
	OPENBSD_3_9_BASE:1.29
	OPENBSD_3_8:1.27.0.2
	OPENBSD_3_8_BASE:1.27
	OPENBSD_3_7:1.26.0.4
	OPENBSD_3_7_BASE:1.26
	OPENBSD_3_6:1.26.0.2
	OPENBSD_3_6_BASE:1.26
	SMP_SYNC_A:1.25
	SMP_SYNC_B:1.25
	OPENBSD_3_5:1.24.0.4
	OPENBSD_3_5_BASE:1.24
	OPENBSD_3_4:1.24.0.2
	OPENBSD_3_4_BASE:1.24
	UBC_SYNC_A:1.22
	OPENBSD_3_3:1.22.0.4
	OPENBSD_3_3_BASE:1.22
	OPENBSD_3_2:1.22.0.2
	OPENBSD_3_2_BASE:1.22
	OPENBSD_3_1:1.20.0.2
	OPENBSD_3_1_BASE:1.20
	UBC_SYNC_B:1.22
	UBC:1.18.0.4
	UBC_BASE:1.18
	OPENBSD_3_0:1.18.0.2
	OPENBSD_3_0_BASE:1.18
	OPENBSD_2_9:1.16.0.4
	OPENBSD_2_9_BASE:1.16
	OPENBSD_2_8:1.16.0.2
	OPENBSD_2_8_BASE:1.16
	OPENBSD_2_7:1.15.0.4
	OPENBSD_2_7_BASE:1.15
	SMP:1.15.0.2
	SMP_BASE:1.15
	kame_19991208:1.15
	OPENBSD_2_6:1.14.0.2
	OPENBSD_2_6_BASE:1.14
	OPENBSD_2_5:1.5.0.2
	OPENBSD_2_5_BASE:1.5
	OPENBSD_2_4:1.2.0.2
	OPENBSD_2_4_BASE:1.2;
locks; strict;
comment	@# @;


1.47
date	2015.02.09.08.20.13;	author miod;	state Exp;
branches;
next	1.46;
commitid	5i6cIXcWVyhDvWR9;

1.46
date	2014.04.08.09.34.23;	author mpi;	state Exp;
branches;
next	1.45;

1.45
date	2013.03.31.17.04.28;	author deraadt;	state Exp;
branches;
next	1.44;

1.44
date	2011.11.08.15.39.50;	author kettenis;	state Exp;
branches;
next	1.43;

1.43
date	2011.06.06.14.23.26;	author jsing;	state Exp;
branches;
next	1.42;

1.42
date	2010.12.30.14.30.12;	author jsing;	state Exp;
branches;
next	1.41;

1.41
date	2010.07.01.05.33.32;	author jsing;	state Exp;
branches;
next	1.40;

1.40
date	2010.06.29.00.50.40;	author jsing;	state Exp;
branches;
next	1.39;

1.39
date	2010.06.03.15.48.58;	author jsing;	state Exp;
branches;
next	1.38;

1.38
date	2010.05.19.13.10.24;	author jsing;	state Exp;
branches;
next	1.37;

1.37
date	2010.05.16.14.54.43;	author jsing;	state Exp;
branches;
next	1.36;

1.36
date	2010.04.19.16.32.53;	author jsing;	state Exp;
branches;
next	1.35;

1.35
date	2010.04.19.14.05.04;	author jsing;	state Exp;
branches;
next	1.34;

1.34
date	2009.12.31.12.52.35;	author jsing;	state Exp;
branches;
next	1.33;

1.33
date	2009.07.29.18.31.11;	author kettenis;	state Exp;
branches;
next	1.32;

1.32
date	2009.02.14.19.03.50;	author kettenis;	state Exp;
branches;
next	1.31;

1.31
date	2007.10.10.15.53.51;	author art;	state Exp;
branches;
next	1.30;

1.30
date	2007.05.14.19.54.21;	author martin;	state Exp;
branches;
next	1.29;

1.29
date	2006.01.10.01.17.28;	author martin;	state Exp;
branches;
next	1.28;

1.28
date	2006.01.06.18.53.05;	author millert;	state Exp;
branches;
next	1.27;

1.27
date	2005.04.21.04.39.35;	author mickey;	state Exp;
branches;
next	1.26;

1.26
date	2004.06.13.21.49.14;	author niklas;	state Exp;
branches;
next	1.25;

1.25
date	2004.06.08.22.00.25;	author mickey;	state Exp;
branches;
next	1.24;

1.24
date	2003.07.15.18.15.41;	author mickey;	state Exp;
branches;
next	1.23;

1.23
date	2003.06.02.23.27.46;	author millert;	state Exp;
branches;
next	1.22;

1.22
date	2002.09.20.18.59.57;	author mickey;	state Exp;
branches;
next	1.21;

1.21
date	2002.04.30.21.04.29;	author mickey;	state Exp;
branches;
next	1.20;

1.20
date	2002.03.15.21.44.18;	author mickey;	state Exp;
branches;
next	1.19;

1.19
date	2002.01.16.20.50.16;	author miod;	state Exp;
branches;
next	1.18;

1.18
date	2001.09.20.18.31.14;	author mickey;	state Exp;
branches
	1.18.4.1;
next	1.17;

1.17
date	2001.09.16.14.28.04;	author miod;	state Exp;
branches;
next	1.16;

1.16
date	2000.07.03.17.45.11;	author mickey;	state Exp;
branches;
next	1.15;

1.15
date	99.11.25.18.32.23;	author mickey;	state Exp;
branches
	1.15.2.1;
next	1.14;

1.14
date	99.08.14.03.16.01;	author mickey;	state Exp;
branches;
next	1.13;

1.13
date	99.07.20.14.13.32;	author mickey;	state Exp;
branches;
next	1.12;

1.12
date	99.07.12.18.14.28;	author mickey;	state Exp;
branches;
next	1.11;

1.11
date	99.06.18.05.19.52;	author mickey;	state Exp;
branches;
next	1.10;

1.10
date	99.06.12.17.40.01;	author mickey;	state Exp;
branches;
next	1.9;

1.9
date	99.06.12.17.36.16;	author mickey;	state Exp;
branches;
next	1.8;

1.8
date	99.06.05.03.36.17;	author mickey;	state Exp;
branches;
next	1.7;

1.7
date	99.05.21.17.34.50;	author mickey;	state Exp;
branches;
next	1.6;

1.6
date	99.04.20.20.39.13;	author mickey;	state Exp;
branches;
next	1.5;

1.5
date	99.02.02.15.13.57;	author mickey;	state Exp;
branches;
next	1.4;

1.4
date	99.01.20.19.29.50;	author mickey;	state Exp;
branches;
next	1.3;

1.3
date	98.12.23.17.56.24;	author mickey;	state Exp;
branches;
next	1.2;

1.2
date	98.09.14.18.59.50;	author mickey;	state Exp;
branches;
next	1.1;

1.1
date	98.09.12.03.12.55;	author mickey;	state Exp;
branches;
next	;

1.15.2.1
date	2001.04.18.16.06.09;	author niklas;	state Exp;
branches;
next	1.15.2.2;

1.15.2.2
date	2001.10.31.02.52.47;	author nate;	state Exp;
branches;
next	1.15.2.3;

1.15.2.3
date	2002.03.06.00.57.22;	author niklas;	state Exp;
branches;
next	1.15.2.4;

1.15.2.4
date	2002.03.28.10.07.19;	author niklas;	state Exp;
branches;
next	1.15.2.5;

1.15.2.5
date	2003.03.27.23.26.53;	author niklas;	state Exp;
branches;
next	1.15.2.6;

1.15.2.6
date	2003.06.07.11.11.36;	author ho;	state Exp;
branches;
next	1.15.2.7;

1.15.2.7
date	2004.02.19.10.48.40;	author niklas;	state Exp;
branches;
next	1.15.2.8;

1.15.2.8
date	2004.06.07.18.46.50;	author tedu;	state Exp;
branches;
next	1.15.2.9;

1.15.2.9
date	2004.06.10.11.40.23;	author niklas;	state Exp;
branches;
next	;

1.18.4.1
date	2002.01.31.22.55.09;	author niklas;	state Exp;
branches;
next	1.18.4.2;

1.18.4.2
date	2002.06.11.03.35.37;	author art;	state Exp;
branches;
next	1.18.4.3;

1.18.4.3
date	2002.10.29.00.28.02;	author art;	state Exp;
branches;
next	;


desc
@@


1.47
log
@No need to export USRSTACK
@
text
@#	$OpenBSD: genassym.cf,v 1.46 2014/04/08 09:34:23 mpi Exp $

#
# Copyright (c) 1982, 1990, 1993
#	The Regents of the University of California.  All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. Neither the name of the University nor the names of its contributors
#    may be used to endorse or promote products derived from this software
#    without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.
#
#	@@(#)genassym.c	8.3 (Berkeley) 1/4/94
#

include <sys/param.h>
include <sys/systm.h>
include <sys/buf.h>
include <sys/proc.h>
include <sys/mbuf.h>
include <sys/msgbuf.h>
include <sys/syscall.h>
include <sys/user.h>

include <uvm/uvm_extern.h>

include <machine/cpu.h>
include <machine/frame.h>
include <machine/iomod.h>
include <machine/mutex.h>
include <machine/pmap.h>
include <machine/psl.h>
include <machine/pte.h>
include <machine/reg.h>

# general constants
export	HPPA_PID_KERNEL
export	HPPA_SID_KERNEL
export	VM_MAXUSER_ADDRESS

# `break' entry points
export	HPPA_BREAK_KERNEL
export	HPPA_BREAK_GET_PSW
export	HPPA_BREAK_SET_PSW

# saved state fields
struct	trapframe
member	tf_flags
member	TF_PHYS		tf_sar
member	tf_r1
member	TF_R2		tf_rp
member	TF_GOTO		tf_rp
member	tf_r3
member	tf_r4
member	tf_r5
member	tf_r6
member	tf_r7
member	tf_r8
member	tf_r9
member	tf_r10
member	tf_r11
member	tf_r12
member	tf_r13
member	tf_r14
member	tf_r15
member	tf_r16
member	tf_r17
member	tf_r18
member	TF_R19		tf_t4
member	TF_R20		tf_t3
member	TF_R21		tf_t2
member	TF_R22		tf_t1
member	TF_R23		tf_arg3
member	TF_R24		tf_arg2
member	TF_R25		tf_arg1
member	TF_R26		tf_arg0
member	TF_R27		tf_dp
member	TF_R28		tf_ret0
member	TF_R29		tf_ret1
member	TF_R30		tf_sp
member	tf_r31
member	tf_sr0
member	tf_sr1
member	tf_sr2
member	tf_sr3
member	tf_sr4
member	tf_sr5
member	tf_sr6
member	tf_sr7
member	TF_CR0		tf_rctr
member	TF_CR10		tf_ccr
member	TF_IIOQH	tf_iioq_head
member	TF_IIOQT	tf_iioq_tail
member	TF_IISQH	tf_iisq_head
member	TF_IISQT	tf_iisq_tail
member	TF_CR8		tf_pidr1
member	TF_CR9		tf_pidr2
member	TF_CR11		tf_sar
member	TF_CR12		tf_pidr3
member	TF_CR13		tf_pidr4
member	TF_CR15		tf_eiem
member	TF_CR19		tf_iir
member	TF_CR20		tf_isr
member	TF_CR21		tf_ior
member	TF_CR22		tf_ipsw
member	TF_CR23		tf_eirr
member	TF_CR25		tf_vtop
member	tf_cr27
member	tf_cr28
member	tf_cr30

# proc fields and values
struct	proc
member	p_addr
member	p_priority
member	p_stat
member	p_wchan
member	p_md
member	P_MD_FLAGS		p_md.md_flags
member	P_MD_REGS		p_md.md_regs

export	SRUN
export	SONPROC

struct	pcb
member	pcb_fpstate
member	pcb_onfault
member	pcb_space
member	pcb_ksp

struct	user
member	u_pcb

struct	uvmexp
member	fpswtch

struct	cpu_info
member	ci_curproc
member	ci_stack
member	ci_psw
member	ci_cpl
member	ci_ipending
member	ci_trap_save
member	ci_fpu_state
member	ci_ipi
member	ci_hpa

struct	hppa_fpstate
member	hfp_regs
member	hfp_cpu

# system calls
export	SYSCALLGATE
export	SYS_exit
export	SYS_execve
export	SYS_sigreturn

# errno
export	EFAULT
export	ENAMETOOLONG
@


1.46
log
@Less <uvm/uvm.h>
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.45 2013/03/31 17:04:28 deraadt Exp $
a54 1
export	USRSTACK
@


1.45
log
@NBPG and PGSHIFT are now available directly from cpp due to param.h
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.44 2011/11/08 15:39:50 kettenis Exp $
d43 1
a43 1
include <uvm/uvm.h>
a151 3

struct	uvm
member	page_idle_zero
@


1.44
log
@Save and restore cr27 and add the necessary glue to use it as the userland
thread register.

ok guenther@@, jsing@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.43 2011/06/06 14:23:26 jsing Exp $
a54 2
export	NBPG
export	PGSHIFT
@


1.43
log
@Sort includes.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.42 2010/12/30 14:30:12 jsing Exp $
d129 1
@


1.42
log
@Prior to loading the FPU context onto the current CPU, check to see if the
FPU context is still present on another CPU. If so, perform an FPU
shootdown and wait for the FPU context to be saved before continuing.

ok kettenis@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.40 2010/06/29 00:50:40 jsing Exp $
d46 4
d51 1
a52 4
include <machine/pte.h>
include <machine/frame.h>
include <machine/pmap.h>
include <machine/iomod.h>
@


1.41
log
@Create a struct to store FP state and include a pointer to the CPU that
currently holds the FPU context for this process. This will be soon used
to implement FPU shootdowns on multiprocessor kernels.

ok kettenis@@
@
text
@d167 2
@


1.40
log
@Store pointer to process FPU state in struct cpu_info.

ok kettenis@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.39 2010/06/03 15:48:58 jsing Exp $
d145 1
a145 1
member	pcb_fpregs
d167 4
@


1.39
log
@Rename ci_spinup_stack to ci_stack and use it as the stack for both CPU
spin up and FPU emulation. Since all CPUs need a stack for FPU emulation,
move the allocation code to cpuattach().

ok kettenis@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.38 2010/05/19 13:10:24 jsing Exp $
d166 1
@


1.38
log
@Spin up secondary CPUs on hppa multiprocessor kernels. At this stage we
enable clock interrupts, however do not allow processes to be scheduled
onto the secondary CPUs - hopefully we can change this shortly...

ok kettenis@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.37 2010/05/16 14:54:43 jsing Exp $
d161 1
a161 1
member	ci_spinup_stack
@


1.37
log
@Use a per CPU trap save area, ensuring that we maintain 64-byte alignment
so that it stays within a single cache line.

Feedback and ok kettenis@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.35 2010/04/19 14:05:04 jsing Exp $
d161 1
@


1.36
log
@Make ipending a per-CPU value.

ok kettenis@@
@
text
@d164 1
@


1.35
log
@Make the Processor Status Word (PSW) a per-CPU value.

ok kettenis@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.33 2009/07/29 18:31:11 kettenis Exp $
d163 1
@


1.34
log
@Make cpl and cpu_inintr per CPU variables. For locore.S, cpl becomes an
offset within cpu_primary_info - this will need to be revisited shortly.

ok kettenis@@
@
text
@d161 1
@


1.33
log
@Get rid of non-equivalent aliases of the pcb by moving the fpu state out
of the pcb and using the p_addr member of 'struct proc' to calculate the
address of the kernel stack when switching to virtual mode after taking a trap.
Remove the now unecessary cache flushes; they're actually harmful since they
create non-equivalent aliases.  This seems to fix the memory corruption we
have been observing from time to time.

This diff does not rename fpu_curpcb, which is now somewhat incorrectly named.
I hope to change things back again as soon as we are able to map the pcb 1:1.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.32 2009/02/14 19:03:50 kettenis Exp $
d161 1
@


1.32
log
@Make spstrcpy() return ENAMETOOLONG if the string being copied is too long.

ok miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.31 2007/10/10 15:53:51 art Exp $
a147 1
member	pcb_uva
@


1.31
log
@Make context switching much more MI:
 - Move the functionality of choosing a process from cpu_switch into
   a much simpler function: cpu_switchto. Instead of having the locore
   code walk the run queues, let the MI code choose the process we
   want to run and only implement the context switching itself in MD
   code.
 - Let MD context switching run without worrying about spls or locks.
 - Instead of having the idle loop implemented with special contexts
   in MD code, implement one idle proc for each cpu. make the idle
   loop MI with MD hooks.
 - Change the proc lists from the old style vax queues to TAILQs.
 - Change the sleep queue from vax queues to TAILQs. This makes
   wakeup() go from O(n^2) to O(n)

there will be some MD fallout, but it will be fixed shortly.
There's also a few cleanups to be done after this.

deraadt@@, kettenis@@ ok
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.30 2007/05/14 19:54:21 martin Exp $
d171 1
@


1.30
log
@move hppa to __HAVE_CPUINFO

input from miod@@, ok kettenis@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.29 2006/01/10 01:17:28 martin Exp $
a132 2
member	p_forw
member	p_back
@


1.29
log
@The __CONCAT macro here collides with the one in cdefs.h pulled in via
errno.h. Don't include errno.h and export EFAULT therefore.

looks good miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.28 2006/01/06 18:53:05 millert Exp $
d161 3
@


1.28
log
@Adapt things to use __type_t instead of _BSD_TYPE_T_
Add new sys/_types.h header
Include machine/_types.h or sys/_types.h where applicable
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.27 2005/04/21 04:39:35 mickey Exp $
d167 3
@


1.27
log
@count fpu lazy context switches; deraadt@@ ok
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.26 2004/06/13 21:49:14 niklas Exp $
a44 1
include	<machine/types.h>
@


1.26
log
@debranch SMP, have fun
@
text
@d1 1
a1 1
#	$OpenBSD$
d159 3
@


1.25
log
@always create a stack frame in cpu_switch() and put a stub
for doing page idle zeroing.
store the kernele stack pointer into pcb instead of trapframe
for debuggers doing stack traces; from kettenis@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.24 2003/07/15 18:15:41 mickey Exp $
d145 1
@


1.24
log
@hptmask goes away as a register and frees one tmp cr
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.23 2003/06/02 23:27:46 millert Exp $
d151 1
d155 3
@


1.23
log
@Remove the advertising clause in the UCB license which Berkeley
rescinded 22 July 1999.  Proofed by myself and Theo.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.22 2002/09/20 18:59:57 mickey Exp $
a127 1
member	TF_CR24		tf_hptm
@


1.22
log
@gonna need cr10, aka ccr from the trapframe
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.21 2002/04/30 21:04:29 mickey Exp $
d15 1
a15 5
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#	This product includes software developed by the University of
#	California, Berkeley and its contributors.
# 4. Neither the name of the University nor the names of its contributors
@


1.21
log
@unused stuffing
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.20 2002/03/15 21:44:18 mickey Exp $
d116 1
@


1.20
log
@rewrite a pmap to use multilevel page tables.
lower 12 bits contain the perms, no unused bits left,
but a couple for off-tlb use (as the ref implemented now).
do not use the hvt, which might get some use later
if proven to speed thigs up, tlb handlers would po
another dozen of insns though, but if that's worth its...
move on the data seg and map kernel text rdonly (idea form fredette),
since all of the page0 mods done before that we are all fine
except for some viper fluff, but later w/ that.
this also picks up a bit more of ddb magic for bpt and ss.
tlb handlers can use a little bit more of attention,
but things, visually, seem to be much faster already, --
sorry, no benchmarks for now.

* effort sponsored in part by the `henry st. old ale house'
* and mr.pete and mr.lee in particular in thier generous entrirety.
* the proj took a little more that 72man*h as it was expected,
* but within murhy's law estimations.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.19 2002/01/16 20:50:16 miod Exp $
a69 5

# pte things
#export	TLB_REF_POS
export	TLB_GATE_PROT
#export	TLB_DIRTY_POS
@


1.19
log
@Don't include <sys/map.h> when you don't need what's in it.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.18 2001/09/20 18:31:14 mickey Exp $
d72 1
a72 1
export	TLB_REF_POS
d74 1
a74 16
export	TLB_DIRTY_POS

# hpt_table fields
struct	hpt_entry
member	hpt_tlbprot
member	hpt_tlbpage
member	hpt_entry
define	HPT_TAG		0

# pv_entry fields
struct	pv_entry
member	pv_hash
member	pv_space
member	pv_va
member	pv_tlbpage
member	pv_tlbprot
@


1.18
log
@make this produce the assym.h at least, was very hard to test of course
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.17 2001/09/16 14:28:04 miod Exp $
a40 1
include <sys/map.h>
@


1.18.4.1
log
@Merge in -current, builds on i386, otherwise untested
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.19 2002/01/16 20:50:16 miod Exp $
d41 1
@


1.18.4.2
log
@Sync UBC branch to -current
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.18.4.1 2002/01/31 22:55:09 niklas Exp $
d70 20
@


1.18.4.3
log
@sync to -current
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.18.4.2 2002/06/11 03:35:37 art Exp $
a115 1
member	TF_CR10		tf_ccr
@


1.17
log
@Make use of "export", "struct" and "member" keywords to be easier to read
and simpler.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.16 2000/07/03 17:45:11 mickey Exp $
d94 1
a94 1
member	TF_FLAGS
d96 1
a96 1
member	TF_R1
d99 16
a114 16
member	TF_R3
member	TF_R4
member	TF_R5
member	TF_R6
member	TF_R7
member	TF_R8
member	TF_R9
member	TF_R10
member	TF_R11
member	TF_R12
member	TF_R13
member	TF_R14
member	TF_R15
member	TF_R16
member	TF_R17
member	TF_R18
d127 9
a135 9
member	TF_R31
member	TF_SR0
member	TF_SR1
member	TF_SR2
member	TF_SR3
member	TF_SR4
member	TF_SR5
member	TF_SR6
member	TF_SR7
d154 2
a155 3
member	TF_CR28
member	TF_CR30
member	TF_SIZE		sizeof(struct trapframe)
@


1.16
log
@export SYSCALLGATE
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.15 1999/11/25 18:32:23 mickey Exp $
a58 1

d60 6
a65 6
define	NBPG			NBPG
define	PGSHIFT			PGSHIFT
define	USRSTACK		USRSTACK
define	HPPA_PID_KERNEL		HPPA_PID_KERNEL
define	HPPA_SID_KERNEL		HPPA_SID_KERNEL
define	VM_MAXUSER_ADDRESS	VM_MAXUSER_ADDRESS
d68 3
a70 3
define	HPPA_BREAK_KERNEL	HPPA_BREAK_KERNEL
define	HPPA_BREAK_GET_PSW	HPPA_BREAK_GET_PSW
define	HPPA_BREAK_SET_PSW	HPPA_BREAK_SET_PSW
d73 3
a75 3
define	TLB_REF_POS		TLB_REF_POS
define	TLB_GATE_PROT		TLB_GATE_PROT
define	TLB_DIRTY_POS		TLB_DIRTY_POS
d82 1
a82 1
define	hpt_tag	0
a86 1
member	pv_pmap
a91 15
# pmap
struct	pmap
member	pmap_space
member	pmap_pid

# export iomod
struct	iomod
member	io_command

# export mbuf
struct	mbuf
member	m_len
member	m_next
member	m_data

d93 64
a156 63
define	TF_SIZE		sizeof(struct trapframe)
define	TF_FLAGS	offsetof(struct trapframe, tf_flags)
define	TF_PHYS		offsetof(struct trapframe, tf_sar)
define	TF_R1		offsetof(struct trapframe, tf_r1)
define	TF_R2		offsetof(struct trapframe, tf_rp)
define	TF_GOTO		offsetof(struct trapframe, tf_rp)
define	TF_R3		offsetof(struct trapframe, tf_r3)
define	TF_R4		offsetof(struct trapframe, tf_r4)
define	TF_R5		offsetof(struct trapframe, tf_r5)
define	TF_R6		offsetof(struct trapframe, tf_r6)
define	TF_R7		offsetof(struct trapframe, tf_r7)
define	TF_R8		offsetof(struct trapframe, tf_r8)
define	TF_R9		offsetof(struct trapframe, tf_r9)
define	TF_R10		offsetof(struct trapframe, tf_r10)
define	TF_R11		offsetof(struct trapframe, tf_r11)
define	TF_R12		offsetof(struct trapframe, tf_r12)
define	TF_R13		offsetof(struct trapframe, tf_r13)
define	TF_R14		offsetof(struct trapframe, tf_r14)
define	TF_R15		offsetof(struct trapframe, tf_r15)
define	TF_R16		offsetof(struct trapframe, tf_r16)
define	TF_R17		offsetof(struct trapframe, tf_r17)
define	TF_R18		offsetof(struct trapframe, tf_r18)
define	TF_R19		offsetof(struct trapframe, tf_t4)
define	TF_R20		offsetof(struct trapframe, tf_t3)
define	TF_R21		offsetof(struct trapframe, tf_t2)
define	TF_R22		offsetof(struct trapframe, tf_t1)
define	TF_R23		offsetof(struct trapframe, tf_arg3)
define	TF_R24		offsetof(struct trapframe, tf_arg2)
define	TF_R25		offsetof(struct trapframe, tf_arg1)
define	TF_R26		offsetof(struct trapframe, tf_arg0)
define	TF_R27		offsetof(struct trapframe, tf_dp)
define	TF_R28		offsetof(struct trapframe, tf_ret0)
define	TF_R29		offsetof(struct trapframe, tf_ret1)
define	TF_R30		offsetof(struct trapframe, tf_sp)
define	TF_R31		offsetof(struct trapframe, tf_r31)
define	TF_SR0		offsetof(struct trapframe, tf_sr0)
define	TF_SR1		offsetof(struct trapframe, tf_sr1)
define	TF_SR2		offsetof(struct trapframe, tf_sr2)
define	TF_SR3		offsetof(struct trapframe, tf_sr3)
define	TF_SR4		offsetof(struct trapframe, tf_sr4)
define	TF_SR5		offsetof(struct trapframe, tf_sr5)
define	TF_SR6		offsetof(struct trapframe, tf_sr6)
define	TF_SR7		offsetof(struct trapframe, tf_sr7)
define	TF_CR0		offsetof(struct trapframe, tf_rctr)
define	TF_IIOQH	offsetof(struct trapframe, tf_iioq_head)
define	TF_IIOQT	offsetof(struct trapframe, tf_iioq_tail)
define	TF_IISQH	offsetof(struct trapframe, tf_iisq_head)
define	TF_IISQT	offsetof(struct trapframe, tf_iisq_tail)
define	TF_CR8		offsetof(struct trapframe, tf_pidr1)
define	TF_CR9		offsetof(struct trapframe, tf_pidr2)
define	TF_CR11		offsetof(struct trapframe, tf_sar)
define	TF_CR12		offsetof(struct trapframe, tf_pidr3)
define	TF_CR13		offsetof(struct trapframe, tf_pidr4)
define	TF_CR15		offsetof(struct trapframe, tf_eiem)
define	TF_CR19		offsetof(struct trapframe, tf_iir)
define	TF_CR20		offsetof(struct trapframe, tf_isr)
define	TF_CR21		offsetof(struct trapframe, tf_ior)
define	TF_CR22		offsetof(struct trapframe, tf_ipsw)
define	TF_CR23		offsetof(struct trapframe, tf_eirr)
define	TF_CR24		offsetof(struct trapframe, tf_hptm)
define	TF_CR25		offsetof(struct trapframe, tf_vtop)
define	TF_CR28		offsetof(struct trapframe, tf_cr28)
define	TF_CR30		offsetof(struct trapframe, tf_cr30)
a161 1
member	p_vmspace
d167 4
a170 4
define	P_MD_FLAGS		offsetof(struct proc, p_md.md_flags)
define	P_MD_REGS		offsetof(struct proc, p_md.md_regs)
define	SSLEEP			SSLEEP
define	SRUN			SRUN
a180 3
# interrupt/fault metering
#define	V_INTR			offsetof(struct vmmeter, v_intr)

d182 4
a185 4
define	SYSCALLGATE		SYSCALLGATE
define	SYS_exit		SYS_exit
define	SYS_execve		SYS_execve
define	SYS_sigreturn		SYS_sigreturn
@


1.15
log
@new pcb and frame
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.14 1999/08/14 03:16:01 mickey Exp $
d202 1
@


1.15.2.1
log
@Update the SMP branch to -current, this breaks the SMP branch though.
But it will be fixed soonish.  Note, nothing new has happened, this is just
a merge of the trunk into this branch.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.16 2000/07/03 17:45:11 mickey Exp $
a201 1
define	SYSCALLGATE		SYSCALLGATE
@


1.15.2.2
log
@Sync the SMP branch to something just after 3.0
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.15.2.1 2001/04/18 16:06:09 niklas Exp $
d59 1
d61 6
a66 6
export	NBPG
export	PGSHIFT
export	USRSTACK
export	HPPA_PID_KERNEL
export	HPPA_SID_KERNEL
export	VM_MAXUSER_ADDRESS
d69 3
a71 3
export	HPPA_BREAK_KERNEL
export	HPPA_BREAK_GET_PSW
export	HPPA_BREAK_SET_PSW
d74 3
a76 3
export	TLB_REF_POS
export	TLB_GATE_PROT
export	TLB_DIRTY_POS
d83 1
a83 1
define	HPT_TAG		0
d88 1
d94 15
d110 63
a172 63
struct	trapframe
member	tf_flags
member	TF_PHYS		tf_sar
member	tf_r1
member	TF_R2		tf_rp
member	TF_GOTO		tf_rp
member	tf_r3
member	tf_r4
member	tf_r5
member	tf_r6
member	tf_r7
member	tf_r8
member	tf_r9
member	tf_r10
member	tf_r11
member	tf_r12
member	tf_r13
member	tf_r14
member	tf_r15
member	tf_r16
member	tf_r17
member	tf_r18
member	TF_R19		tf_t4
member	TF_R20		tf_t3
member	TF_R21		tf_t2
member	TF_R22		tf_t1
member	TF_R23		tf_arg3
member	TF_R24		tf_arg2
member	TF_R25		tf_arg1
member	TF_R26		tf_arg0
member	TF_R27		tf_dp
member	TF_R28		tf_ret0
member	TF_R29		tf_ret1
member	TF_R30		tf_sp
member	tf_r31
member	tf_sr0
member	tf_sr1
member	tf_sr2
member	tf_sr3
member	tf_sr4
member	tf_sr5
member	tf_sr6
member	tf_sr7
member	TF_CR0		tf_rctr
member	TF_IIOQH	tf_iioq_head
member	TF_IIOQT	tf_iioq_tail
member	TF_IISQH	tf_iisq_head
member	TF_IISQT	tf_iisq_tail
member	TF_CR8		tf_pidr1
member	TF_CR9		tf_pidr2
member	TF_CR11		tf_sar
member	TF_CR12		tf_pidr3
member	TF_CR13		tf_pidr4
member	TF_CR15		tf_eiem
member	TF_CR19		tf_iir
member	TF_CR20		tf_isr
member	TF_CR21		tf_ior
member	TF_CR22		tf_ipsw
member	TF_CR23		tf_eirr
member	TF_CR24		tf_hptm
member	TF_CR25		tf_vtop
member	tf_cr28
member	tf_cr30
d178 1
d184 4
a187 4
member	P_MD_FLAGS		p_md.md_flags
member	P_MD_REGS		p_md.md_regs

export	SRUN
d198 3
d202 4
a205 4
export	SYSCALLGATE
export	SYS_exit
export	SYS_execve
export	SYS_sigreturn
@


1.15.2.3
log
@Merge in trunk
@
text
@d1 1
a1 1
#	$OpenBSD$
d41 1
@


1.15.2.4
log
@Merge in -current from about a week ago
@
text
@d72 1
a72 1
#export	TLB_REF_POS
d74 16
a89 1
#export	TLB_DIRTY_POS
@


1.15.2.5
log
@Sync the SMP branch with 3.3
@
text
@d71 5
a120 1
member	TF_CR10		tf_ccr
@


1.15.2.6
log
@Sync SMP branch to -current
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.15.2.5 2003/03/27 23:26:53 niklas Exp $
d15 5
a19 1
# 3. Neither the name of the University nor the names of its contributors
@


1.15.2.7
log
@Merge of current from two weeks agointo the SMP branch
@
text
@d1 1
a1 1
#	$OpenBSD$
d128 1
@


1.15.2.8
log
@set SONPROC, help from mickey
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.15.2.7 2004/02/19 10:48:40 niklas Exp $
a144 1
export	SONPROC
@


1.15.2.9
log
@sync with head, make i386 __HAVE_CPUINFO
@
text
@d1 1
a1 1
#	$OpenBSD$
a151 1
member	pcb_ksp
a154 3

struct	uvm
member	page_idle_zero
@


1.14
log
@export cr23
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.13 1999/07/20 14:13:32 mickey Exp $
a60 2
define	UPAGES			UPAGES
define	USPACE			USPACE
d112 1
d172 1
d190 1
a190 1
member	pcb_tf
d193 1
a193 1
member	pcb_fpregs
@


1.13
log
@export cr28 for DEBUGging purposes
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.12 1999/07/12 18:14:28 mickey Exp $
d146 8
d169 1
a169 8
define	TF_SR0		offsetof(struct trapframe, tf_sr0)
define	TF_SR1		offsetof(struct trapframe, tf_sr1)
define	TF_SR2		offsetof(struct trapframe, tf_sr2)
define	TF_SR3		offsetof(struct trapframe, tf_sr3)
define	TF_SR4		offsetof(struct trapframe, tf_sr4)
define	TF_SR5		offsetof(struct trapframe, tf_sr5)
define	TF_SR6		offsetof(struct trapframe, tf_sr6)
define	TF_SR7		offsetof(struct trapframe, tf_sr7)
@


1.12
log
@export cr24 and cr25 from trapframe structure
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.11 1999/06/18 05:19:52 mickey Exp $
d171 1
@


1.11
log
@do not include fpu regs into trapframe, according to the
lazy fpu context switching it could be well saved into pcb.
this brings trapframe to 256 bytes (including 5 spare words).
adjust all the code to deal w/ moved fpu regs save area.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.10 1999/06/12 17:40:01 mickey Exp $
d169 2
@


1.10
log
@no need for vmspace.vm_pmap
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.9 1999/06/12 17:36:16 mickey Exp $
a168 1
define	TF_FPREGS	offsetof(struct trapframe, tf_fpregs)
d189 1
@


1.9
log
@no need for vmmap_pmap
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.8 1999/06/05 03:36:17 mickey Exp $
a192 3

struct	vmspace
member	vm_pmap
@


1.8
log
@export p_md
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.7 1999/05/21 17:34:50 mickey Exp $
a99 3

# vm_map
define vmmap_pmap	offsetof(struct vm_map, pmap)
@


1.7
log
@break bits, cleanup
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.6 1999/04/20 20:39:13 mickey Exp $
d183 1
@


1.6
log
@export some more
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.5 1999/02/02 15:13:57 mickey Exp $
a65 1
define	INTSTACK_SIZE		INTSTACK_SIZE
d70 5
d172 1
@


1.5
log
@add struct mbuf
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.4 1999/01/20 19:29:50 mickey Exp $
d39 1
d48 1
a48 1
include <vm/vm.h>
d68 2
d112 56
a167 56
define	TF_FLAGS	offsetof(struct trapframe, flags)
define	TF_R1		offsetof(struct trapframe, r1)
define	TF_R2		offsetof(struct trapframe, rp)
define	TF_GOTO		offsetof(struct trapframe, rp)
define	TF_R3		offsetof(struct trapframe, r3)
define	TF_R4		offsetof(struct trapframe, r4)
define	TF_R5		offsetof(struct trapframe, r5)
define	TF_R6		offsetof(struct trapframe, r6)
define	TF_R7		offsetof(struct trapframe, r7)
define	TF_R8		offsetof(struct trapframe, r8)
define	TF_R9		offsetof(struct trapframe, r9)
define	TF_R10		offsetof(struct trapframe, r10)
define	TF_R11		offsetof(struct trapframe, r11)
define	TF_R12		offsetof(struct trapframe, r12)
define	TF_R13		offsetof(struct trapframe, r13)
define	TF_R14		offsetof(struct trapframe, r14)
define	TF_R15		offsetof(struct trapframe, r15)
define	TF_R16		offsetof(struct trapframe, r16)
define	TF_R17		offsetof(struct trapframe, r17)
define	TF_R18		offsetof(struct trapframe, r18)
define	TF_R19		offsetof(struct trapframe, t4)
define	TF_R20		offsetof(struct trapframe, t3)
define	TF_R21		offsetof(struct trapframe, t2)
define	TF_R22		offsetof(struct trapframe, t1)
define	TF_R23		offsetof(struct trapframe, arg3)
define	TF_R24		offsetof(struct trapframe, arg2)
define	TF_R25		offsetof(struct trapframe, arg1)
define	TF_R26		offsetof(struct trapframe, arg0)
define	TF_R27		offsetof(struct trapframe, dp)
define	TF_R28		offsetof(struct trapframe, ret0)
define	TF_R29		offsetof(struct trapframe, ret1)
define	TF_R30		offsetof(struct trapframe, sp)
define	TF_R31		offsetof(struct trapframe, r31)
define	TF_CR0		offsetof(struct trapframe, rctr)
define	TF_IIOQH	offsetof(struct trapframe, iioq_head)
define	TF_IIOQT	offsetof(struct trapframe, iioq_tail)
define	TF_IISQH	offsetof(struct trapframe, iisq_head)
define	TF_IISQT	offsetof(struct trapframe, iisq_tail)
define	TF_CR8		offsetof(struct trapframe, pidr1)
define	TF_CR9		offsetof(struct trapframe, pidr2)
define	TF_CR11		offsetof(struct trapframe, sar)
define	TF_CR12		offsetof(struct trapframe, pidr3)
define	TF_CR13		offsetof(struct trapframe, pidr4)
define	TF_CR15		offsetof(struct trapframe, eiem)
define	TF_CR19		offsetof(struct trapframe, iir)
define	TF_CR20		offsetof(struct trapframe, isr)
define	TF_CR21		offsetof(struct trapframe, ior)
define	TF_CR22		offsetof(struct trapframe, ipsw)
define	TF_SR0		offsetof(struct trapframe, sr0)
define	TF_SR1		offsetof(struct trapframe, sr1)
define	TF_SR2		offsetof(struct trapframe, sr2)
define	TF_SR3		offsetof(struct trapframe, sr3)
define	TF_SR4		offsetof(struct trapframe, sr4)
define	TF_SR5		offsetof(struct trapframe, sr5)
define	TF_SR6		offsetof(struct trapframe, sr6)
define	TF_SR7		offsetof(struct trapframe, sr7)
d183 10
a192 2
# VM structure fields
define	VM_PMAP			offsetof(struct vmspace, vm_map.pmap)
d195 1
a195 1
define	V_INTR			offsetof(struct vmmeter, v_intr)
@


1.4
log
@cleanup some rudimentaries
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.3 1998/12/23 17:56:24 mickey Exp $
d100 6
@


1.3
log
@remove bogus CACHE_LINE_SIZE
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.2 1998/09/14 18:59:50 mickey Exp $
a68 2
define	TLB_ICACHE_POS		TLB_ICACHE_POS
define	TLB_DCACHE_POS		TLB_DCACHE_POS
a71 2
define	TLB_ALIGNED_POS		TLB_ALIGNED_POS
define	TLB_AR_KRW		TLB_AR_KRW
a87 1
member	pv_tlbsw
@


1.2
log
@iodc.h bye, bye
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.1 1998/09/12 03:12:55 mickey Exp $
a75 3

# cpu stuff
define	CACHE_LINE_SIZE		CACHE_LINE_SIZE
@


1.1
log
@.s definitions exported from C
@
text
@d1 1
a1 1
#	$OpenBSD$
a55 1
include <machine/iodc.h>
@

