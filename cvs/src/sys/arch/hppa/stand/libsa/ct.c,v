head	1.9;
access;
symbols
	OPENBSD_6_0:1.9.0.50
	OPENBSD_6_0_BASE:1.9
	OPENBSD_5_9:1.9.0.46
	OPENBSD_5_9_BASE:1.9
	OPENBSD_5_8:1.9.0.48
	OPENBSD_5_8_BASE:1.9
	OPENBSD_5_7:1.9.0.40
	OPENBSD_5_7_BASE:1.9
	OPENBSD_5_6:1.9.0.44
	OPENBSD_5_6_BASE:1.9
	OPENBSD_5_5:1.9.0.42
	OPENBSD_5_5_BASE:1.9
	OPENBSD_5_4:1.9.0.38
	OPENBSD_5_4_BASE:1.9
	OPENBSD_5_3:1.9.0.36
	OPENBSD_5_3_BASE:1.9
	OPENBSD_5_2:1.9.0.34
	OPENBSD_5_2_BASE:1.9
	OPENBSD_5_1_BASE:1.9
	OPENBSD_5_1:1.9.0.32
	OPENBSD_5_0:1.9.0.30
	OPENBSD_5_0_BASE:1.9
	OPENBSD_4_9:1.9.0.28
	OPENBSD_4_9_BASE:1.9
	OPENBSD_4_8:1.9.0.26
	OPENBSD_4_8_BASE:1.9
	OPENBSD_4_7:1.9.0.22
	OPENBSD_4_7_BASE:1.9
	OPENBSD_4_6:1.9.0.24
	OPENBSD_4_6_BASE:1.9
	OPENBSD_4_5:1.9.0.20
	OPENBSD_4_5_BASE:1.9
	OPENBSD_4_4:1.9.0.18
	OPENBSD_4_4_BASE:1.9
	OPENBSD_4_3:1.9.0.16
	OPENBSD_4_3_BASE:1.9
	OPENBSD_4_2:1.9.0.14
	OPENBSD_4_2_BASE:1.9
	OPENBSD_4_1:1.9.0.12
	OPENBSD_4_1_BASE:1.9
	OPENBSD_4_0:1.9.0.10
	OPENBSD_4_0_BASE:1.9
	OPENBSD_3_9:1.9.0.8
	OPENBSD_3_9_BASE:1.9
	OPENBSD_3_8:1.9.0.6
	OPENBSD_3_8_BASE:1.9
	OPENBSD_3_7:1.9.0.4
	OPENBSD_3_7_BASE:1.9
	OPENBSD_3_6:1.9.0.2
	OPENBSD_3_6_BASE:1.9
	SMP_SYNC_A:1.9
	SMP_SYNC_B:1.9
	OPENBSD_3_5:1.8.0.4
	OPENBSD_3_5_BASE:1.8
	OPENBSD_3_4:1.8.0.2
	OPENBSD_3_4_BASE:1.8
	UBC_SYNC_A:1.8
	OPENBSD_3_3:1.6.0.6
	OPENBSD_3_3_BASE:1.6
	OPENBSD_3_2:1.6.0.4
	OPENBSD_3_2_BASE:1.6
	OPENBSD_3_1:1.6.0.2
	OPENBSD_3_1_BASE:1.6
	UBC_SYNC_B:1.6
	UBC:1.5.0.14
	UBC_BASE:1.5
	OPENBSD_3_0:1.5.0.12
	OPENBSD_3_0_BASE:1.5
	OPENBSD_2_9:1.5.0.10
	OPENBSD_2_9_BASE:1.5
	OPENBSD_2_8:1.5.0.8
	OPENBSD_2_8_BASE:1.5
	OPENBSD_2_7:1.5.0.6
	OPENBSD_2_7_BASE:1.5
	SMP:1.5.0.4
	SMP_BASE:1.5
	kame_19991208:1.5
	OPENBSD_2_6:1.5.0.2
	OPENBSD_2_6_BASE:1.5
	OPENBSD_2_5:1.4.0.2
	OPENBSD_2_5_BASE:1.4
	OPENBSD_2_4:1.3.0.2
	OPENBSD_2_4_BASE:1.3
	mickey-boot:1.1.1.1
	mickey:1.1.1;
locks; strict;
comment	@ * @;


1.9
date	2004.04.07.18.24.20;	author mickey;	state Exp;
branches;
next	1.8;

1.8
date	2003.04.29.22.38.50;	author mickey;	state Exp;
branches;
next	1.7;

1.7
date	2003.04.16.07.20.50;	author mickey;	state Exp;
branches;
next	1.6;

1.6
date	2002.03.15.18.19.52;	author millert;	state Exp;
branches;
next	1.5;

1.5
date	99.04.20.20.01.01;	author mickey;	state Exp;
branches
	1.5.4.1
	1.5.14.1;
next	1.4;

1.4
date	99.02.13.04.43.18;	author mickey;	state Exp;
branches;
next	1.3;

1.3
date	98.09.29.07.20.44;	author mickey;	state Exp;
branches;
next	1.2;

1.2
date	98.07.08.21.34.33;	author mickey;	state Exp;
branches;
next	1.1;

1.1
date	98.06.23.18.46.42;	author mickey;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	98.06.23.18.46.42;	author mickey;	state Exp;
branches;
next	;

1.5.4.1
date	2002.03.28.10.31.03;	author niklas;	state Exp;
branches;
next	1.5.4.2;

1.5.4.2
date	2003.05.13.19.41.04;	author ho;	state Exp;
branches;
next	1.5.4.3;

1.5.4.3
date	2004.06.05.23.10.49;	author niklas;	state Exp;
branches;
next	;

1.5.14.1
date	2002.06.11.03.35.38;	author art;	state Exp;
branches;
next	1.5.14.2;

1.5.14.2
date	2003.05.19.21.43.13;	author tedu;	state Exp;
branches;
next	;


desc
@@


1.9
log
@update copyright; miod@@ is fine w/ files where he holds it too
@
text
@/*	$OpenBSD: ct.c,v 1.8 2003/04/29 22:38:50 mickey Exp $	*/

/*
 * Copyright (c) 1998-2004 Michael Shalayeff
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR OR HIS RELATIVES BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF MIND, USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING
 * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 * THE POSSIBILITY OF SUCH DAMAGE.
 */
/*
 * Copyright 1996 1995 by Open Software Foundation, Inc.
 *              All Rights Reserved
 *
 * Permission to use, copy, modify, and distribute this software and
 * its documentation for any purpose and without fee is hereby granted,
 * provided that the above copyright notice appears in all copies and
 * that both the copyright notice and this permission notice appear in
 * supporting documentation.
 *
 * OSF DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE
 * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
 * FOR A PARTICULAR PURPOSE.
 *
 * IN NO EVENT SHALL OSF BE LIABLE FOR ANY SPECIAL, INDIRECT, OR
 * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
 * LOSS OF USE, DATA OR PROFITS, WHETHER IN ACTION OF CONTRACT,
 * NEGLIGENCE, OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION
 * WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 */

#include "libsa.h"

#include <sys/param.h>
#include <sys/disklabel.h>
#include <sys/reboot.h>

#include <machine/pdc.h>
#include <machine/iomod.h>

#include "dev_hppa.h"

int
ctopen(struct open_file *f, ...)
{
	struct hppa_dev *dp = f->f_devdata;

	if (!(dp->pz_dev = pdc_findev(-1, PCL_SEQU)))
		return (ENXIO);

	return (0);
}

/*ARGSUSED*/
int
ctclose(f)
	struct open_file *f;
{
	free (f->f_devdata, sizeof(struct hppa_dev));
	f->f_devdata = NULL;
	return 0;
}
@


1.8
log
@some cleanup and redo ct as lf (just different dev type). saves some memory
@
text
@d1 1
a1 1
/*	$OpenBSD: ct.c,v 1.8 2003/04/29 22:27:07 mickey Exp $	*/
d4 1
a4 1
 * Copyright (c) 1998 Michael Shalayeff
a14 5
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by Michael Shalayeff.
 * 4. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
d19 8
a26 7
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
@


1.7
log
@clean some spaces and registers and other fluff
@
text
@d1 1
a1 1
/*	$OpenBSD: ct.c,v 1.6 2002/03/15 18:19:52 millert Exp $	*/
a64 4
struct pz_device ctdev;
iodcio_t ctiodc;	/* cartridge tape IODC entry point */
int ctcode[IODC_MAXSIZE/sizeof(int)];

a68 3
	int ret;

	if (ctiodc == 0) {
d70 2
a71 15
		if ((ret = (*pdc)(PDC_IODC, PDC_IODC_READ, pdcbuf, ctdev.pz_hpa,
				  IODC_IO, ctcode, IODC_MAXSIZE)) < 0) {
			printf("ct: device ENTRY_IO Read ret'd %d\n", ret);
			return (EIO);
		} else
			ctdev.pz_iodc_io = ctiodc = (iodcio_t) ctcode;
	}

	dp->pz_dev = &ctdev;

	if (ctiodc != NULL)
		if ((ret = (*ctiodc)(ctdev.pz_hpa, IODC_IO_READ, ctdev.pz_spa,
				     ctdev.pz_layers, pdcbuf, 0,
				     dp->buf, 0, 0)) < 0)
			printf("ct: device rewind ret'd %d\n", ret);
@


1.6
log
@Kill #if __STDC__ used to do K&R vs. ANSI varargs/stdarg; just do things
the ANSI way.
@
text
@d1 1
a1 1
/*	$OpenBSD: ct.c,v 1.5 1999/04/20 20:01:01 mickey Exp $	*/
d33 19
a51 19
 * Copyright 1996 1995 by Open Software Foundation, Inc.   
 *              All Rights Reserved 
 *  
 * Permission to use, copy, modify, and distribute this software and 
 * its documentation for any purpose and without fee is hereby granted, 
 * provided that the above copyright notice appears in all copies and 
 * that both the copyright notice and this permission notice appear in 
 * supporting documentation. 
 *  
 * OSF DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE 
 * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS 
 * FOR A PARTICULAR PURPOSE. 
 *  
 * IN NO EVENT SHALL OSF BE LIABLE FOR ANY SPECIAL, INDIRECT, OR 
 * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM 
 * LOSS OF USE, DATA OR PROFITS, WHETHER IN ACTION OF CONTRACT, 
 * NEGLIGENCE, OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION 
 * WITH THE USE OR PERFORMANCE OF THIS SOFTWARE. 
 * 
d72 1
a72 1
	register struct hppa_dev *dp = f->f_devdata;
@


1.5
log
@fix different alignment problems
correct PDC/IODC call formats
factor some more code out to the dev_hppa.c routines
basically boot on many more machine by now
@
text
@d1 1
a1 1
/*	$OpenBSD: ct.c,v 1.4 1999/02/13 04:43:18 mickey Exp $	*/
a69 1
#ifdef __STDC__
a70 4
#else
ctopen(f)
	struct open_file *f;
#endif
@


1.5.14.1
log
@Sync UBC branch to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: ct.c,v 1.5 1999/04/20 20:01:01 mickey Exp $	*/
d70 1
d72 4
@


1.5.14.2
log
@sync
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d33 19
a51 19
 * Copyright 1996 1995 by Open Software Foundation, Inc.
 *              All Rights Reserved
 *
 * Permission to use, copy, modify, and distribute this software and
 * its documentation for any purpose and without fee is hereby granted,
 * provided that the above copyright notice appears in all copies and
 * that both the copyright notice and this permission notice appear in
 * supporting documentation.
 *
 * OSF DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE
 * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
 * FOR A PARTICULAR PURPOSE.
 *
 * IN NO EVENT SHALL OSF BE LIABLE FOR ANY SPECIAL, INDIRECT, OR
 * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
 * LOSS OF USE, DATA OR PROFITS, WHETHER IN ACTION OF CONTRACT,
 * NEGLIGENCE, OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION
 * WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
d65 4
d72 4
a75 1
	struct hppa_dev *dp = f->f_devdata;
d77 15
a91 2
	if (!(dp->pz_dev = pdc_findev(-1, PCL_SEQU)))
		return (ENXIO);
@


1.5.4.1
log
@Merge in -current from about a week ago
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d70 1
d72 4
@


1.5.4.2
log
@Sync the SMP branch to -current.
@
text
@d1 1
a1 1
/*	$OpenBSD: ct.c,v 1.5.4.1 2002/03/28 10:31:03 niklas Exp $	*/
d33 19
a51 19
 * Copyright 1996 1995 by Open Software Foundation, Inc.
 *              All Rights Reserved
 *
 * Permission to use, copy, modify, and distribute this software and
 * its documentation for any purpose and without fee is hereby granted,
 * provided that the above copyright notice appears in all copies and
 * that both the copyright notice and this permission notice appear in
 * supporting documentation.
 *
 * OSF DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE
 * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
 * FOR A PARTICULAR PURPOSE.
 *
 * IN NO EVENT SHALL OSF BE LIABLE FOR ANY SPECIAL, INDIRECT, OR
 * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
 * LOSS OF USE, DATA OR PROFITS, WHETHER IN ACTION OF CONTRACT,
 * NEGLIGENCE, OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION
 * WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
d65 4
d72 4
a75 1
	struct hppa_dev *dp = f->f_devdata;
d77 15
a91 2
	if (!(dp->pz_dev = pdc_findev(-1, PCL_SEQU)))
		return (ENXIO);
@


1.5.4.3
log
@Merge with the trunk
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d4 1
a4 1
 * Copyright (c) 1998-2004 Michael Shalayeff
d15 5
d24 7
a30 8
 * IN NO EVENT SHALL THE AUTHOR OR HIS RELATIVES BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF MIND, USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING
 * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 * THE POSSIBILITY OF SUCH DAMAGE.
@


1.4
log
@remove local cvs Id
@
text
@d1 1
a1 1
/*	$OpenBSD: ct.c,v 1.3 1998/09/29 07:20:44 mickey Exp $	*/
d59 1
a67 17
char ctbuf[IODC_MAXSIZE] __attribute__ ((aligned(MINIOSIZ)));

/* hp800-specific comments:
 *
 * Tape driver ALWAYS uses "Alternate Boot Device", which is assumed to ALWAYS
 * be the boot device in pagezero (meaning we booted from it).
 *
 * NOTE about skipping file, below:  It's assumed that a read gets 2k (a page).
 * This is done because, even though the cartridge tape has record sizes of 1k,
 * and an EOF takes one record, reads through the IODC must be in 2k chunks,
 * and must start on a 2k-byte boundary.  This means that ANY TAPE FILE TO BE
 * SKIPPED OVER IS GOING TO HAVE TO BE AN ODD NUMBER OF 1 KBYTE RECORDS so the
 * read of the subsequent file can start on a 2k boundary.  If a real error
 * occurs, the record count is reset below, so this isn't a problem.
 */
int	ctbyteno;	/* block number on tape to access next */
int	ctworking;	/* flag:  have we read anything successfully? */
d77 1
d90 2
d94 2
a95 1
				     ctdev.pz_layers, pdcbuf,0, ctbuf,0,0)) < 0)
d106 2
a107 3
	ctbyteno = 0;
	ctworking = 0;

@


1.3
log
@there is only one strategy routine: iodcstrategy
@
text
@d1 1
a1 2
/*	$OpenBSD: ct.c,v 1.2 1998/07/08 21:34:33 mickey Exp $	*/
/*	$NOWHERE: ct.c,v 2.2 1998/06/22 18:41:34 mickey Exp $	*/
@


1.2
log
@use those new pdc call types
@
text
@d1 1
a1 1
/*	$OpenBSD: ct.c,v 1.1.1.1 1998/06/23 18:46:42 mickey Exp $	*/
a32 1

a60 1
#include <machine/iodc.h>
d65 1
d68 1
d94 1
a94 2
	struct hppa_dev *dp = f->f_devdata;
	int i, ret, part = B_PARTITION(dp->bootdev);
d107 2
a108 2
		if ((ret = (*ctiodc)(ctdev.pz_hpa, IODC_IO_BOOTIN, ctdev.pz_spa,
				     ctdev.pz_layers, pdcbuf,0, btbuf,0,0)) < 0)
a110 19
	ctbyteno = 0;
	for (i = part; --i >= 0; ) {
		ctworking = 0;
		for (;;) {
			ret = iodc_rw(btbuf, ctbyteno, IONBPG, F_READ, &ctdev);
			ctbyteno += IONBPG;
			if (ret <= 0)
				break;
			ctworking = 1;
		}
		if (ret < 0 && (ret != -4 || !ctworking)) {
			printf("ct: error %d after %d %d-byte records\n",
				ret, ctbyteno >> IOPGSHIFT, IONBPG);
			ctbyteno = 0;
			ctworking = 0;
			return (EIO);
		}
	}
	ctworking = 0;
a122 24
}

int
ctstrategy(devdata, rw, dblk, size, buf, rsize)
	void *devdata;
	int rw;
	daddr_t dblk;
	size_t size;
	void *buf;
	size_t *rsize;
{
	int ret;

	if ((ret = iodc_rw(buf, ctbyteno, size, rw, &ctdev)) < 0) {
		if (ret == -4 && ctworking)
			ret = 0;

		ctworking = 0;
	} else {
		ctworking = 1;
		ctbyteno += ret;
	}

	return (ret);
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d67 1
a67 1
int (*ctiodc)();	/* cartridge tape IODC entry point */
d104 1
a104 1
			ctdev.pz_iodc_io = ctiodc = (int (*)()) ctcode;
@


1.1.1.1
log
@ok, it boots, include and libkern to come
@
text
@@
