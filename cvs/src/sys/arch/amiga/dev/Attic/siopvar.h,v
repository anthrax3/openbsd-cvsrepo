head	1.5;
access;
symbols
	SMP_SYNC_A:1.5
	SMP_SYNC_B:1.5
	UBC_SYNC_A:1.5
	OPENBSD_3_2:1.4.0.4
	OPENBSD_3_2_BASE:1.4
	OPENBSD_3_1:1.4.0.2
	OPENBSD_3_1_BASE:1.4
	UBC_SYNC_B:1.4
	UBC:1.3.0.26
	UBC_BASE:1.3
	OPENBSD_3_0:1.3.0.24
	OPENBSD_3_0_BASE:1.3
	OPENBSD_2_9:1.3.0.22
	OPENBSD_2_9_BASE:1.3
	OPENBSD_2_8:1.3.0.20
	OPENBSD_2_8_BASE:1.3
	OPENBSD_2_7:1.3.0.18
	OPENBSD_2_7_BASE:1.3
	SMP:1.3.0.16
	SMP_BASE:1.3
	kame_19991208:1.3
	OPENBSD_2_6:1.3.0.14
	OPENBSD_2_6_BASE:1.3
	OPENBSD_2_5:1.3.0.12
	OPENBSD_2_5_BASE:1.3
	OPENBSD_2_4:1.3.0.10
	OPENBSD_2_4_BASE:1.3
	OPENBSD_2_3:1.3.0.8
	OPENBSD_2_3_BASE:1.3
	OPENBSD_2_2:1.3.0.6
	OPENBSD_2_2_BASE:1.3
	OPENBSD_2_1:1.3.0.4
	OPENBSD_2_1_BASE:1.3
	OPENBSD_2_0:1.3.0.2
	OPENBSD_2_0_BASE:1.3
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@ * @;


1.5
date	2002.12.31.16.35.38;	author miod;	state dead;
branches;
next	1.4;

1.4
date	2002.03.14.01.26.29;	author millert;	state Exp;
branches;
next	1.3;

1.3
date	96.05.02.06.44.36;	author niklas;	state Exp;
branches
	1.3.16.1
	1.3.26.1;
next	1.2;

1.2
date	96.02.03.18.32.59;	author chuck;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.50.02;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.50.02;	author deraadt;	state Exp;
branches;
next	;

1.3.16.1
date	2002.03.28.10.06.14;	author niklas;	state Exp;
branches;
next	1.3.16.2;

1.3.16.2
date	2003.03.27.23.19.18;	author niklas;	state dead;
branches;
next	;

1.3.26.1
date	2002.06.11.03.34.58;	author art;	state Exp;
branches;
next	1.3.26.2;

1.3.26.2
date	2003.05.19.21.49.39;	author tedu;	state dead;
branches;
next	;


desc
@@


1.5
log
@amiga and sun3 turned out to not be y2k+3 compliant here. Remove them, as
well as the few userland tools which were only used on these platforms.
@
text
@/*	$OpenBSD: siopvar.h,v 1.4 2002/03/14 01:26:29 millert Exp $	*/
/*	$NetBSD: siopvar.h,v 1.14 1996/04/21 21:12:38 veego Exp $	*/

/*
 * Copyright (c) 1990 The Regents of the University of California.
 * All rights reserved.
 *
 * This code is derived from software contributed to Berkeley by
 * Van Jacobson of Lawrence Berkeley Laboratory.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by the University of
 *	California, Berkeley and its contributors.
 * 4. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 *	@@(#)siopvar.h	7.1 (Berkeley) 5/8/90
 */
#ifndef _SIOPVAR_H_
#define _SIOPVAR_H_

/*
 * The largest single request will be MAXPHYS bytes which will require
 * at most MAXPHYS/NBPG+1 chain elements to describe, i.e. if none of
 * the buffer pages are physically contiguous (MAXPHYS/NBPG) and the
 * buffer is not page aligned (+1).
 */
#define	DMAMAXIO	(MAXPHYS/NBPG+1)

/*
 * Data Structure for SCRIPTS program
 */
struct siop_ds {
	long	scsi_addr;		/* SCSI ID & sync */
	long	idlen;			/* Identify message */
	char	*idbuf;
	long	cmdlen;			/* SCSI command */
	char	*cmdbuf;
	long	stslen;			/* Status */
	char	*stsbuf;
	long	msglen;			/* Message */
	char	*msgbuf;
	long	msginlen;		/* Message in */
	char	*msginbuf;
	long	extmsglen;		/* Extended message in */
	char	*extmsgbuf;
	long	synmsglen;		/* Sync transfer request */
	char	*synmsgbuf;
	struct {
		long datalen;
		char *databuf;
	} chain[DMAMAXIO];
};

/*
 * ACB. Holds additional information for each SCSI command Comments: We
 * need a separate scsi command block because we may need to overwrite it
 * with a request sense command.  Basicly, we refrain from fiddling with
 * the scsi_xfer struct (except do the expected updating of return values).
 * We'll generally update: xs->{flags,resid,error,sense,status} and
 * occasionally xs->retries.
 */
struct siop_acb {
	TAILQ_ENTRY(siop_acb) chain;
	struct scsi_xfer *xs;	/* SCSI xfer ctrl block from above */
	int		flags;	/* Status */
#define ACB_FREE	0x00
#define ACB_ACTIVE	0x01
#define ACB_DONE	0x04
#define ACB_CHKSENSE	0x08
	struct scsi_generic cmd;  /* SCSI command block */
	struct siop_ds ds;
	void	*iob_buf;
	u_long	iob_curbuf;
	u_long	iob_len, iob_curlen;
	u_char	msgout[6];
	u_char	msg[6];
	u_char	stat[1];
	u_char	status;
	u_char	dummy[2];
	int	 clen;
	char	*daddr;		/* Saved data pointer */
	int	 dleft;		/* Residue */
};

/*
 * Some info about each (possible) target on the SCSI bus.  This should
 * probably have been a "per target+lunit" structure, but we'll leave it at
 * this for now.  Is there a way to reliably hook it up to sc->fordriver??
 */
struct siop_tinfo {
	int	cmds;		/* #commands processed */
	int	dconns;		/* #disconnects */
	int	touts;		/* #timeouts */
	int	perrs;		/* #parity errors */
	int	senses;		/* #request sense commands sent */
	ushort	lubusy;		/* What local units/subr. are busy? */
	u_char  flags;
	u_char  period;		/* Period suggestion */
	u_char  offset;		/* Offset suggestion */
} tinfo_t;

struct	siop_softc {
	struct	device sc_dev;
	struct	isr sc_isr;

	u_char	sc_istat;
	u_char	sc_dstat;
	u_char	sc_sstat0;
	u_char	sc_sstat1;
	u_long	sc_intcode;
	struct	scsi_link sc_link;	/* proto for sub devices */
	u_long	sc_scriptspa;		/* physical address of scripts */
	siop_regmap_p	sc_siopp;	/* the SIOP */
	u_long	sc_active;		/* number of active I/O's */

	/* Lists of command blocks */
	TAILQ_HEAD(acb_list, siop_acb) free_list,
				       ready_list,
				       nexus_list;

	struct siop_acb *sc_nexus;	/* current command */
#define SIOP_NACB 8
	struct siop_acb *sc_acb;	/* the real command blocks */
	struct siop_tinfo sc_tinfo[8];

	u_short	sc_clock_freq;
	u_char	sc_dcntl;
	u_char	sc_ctest7;
	u_short	sc_tcp[4];
	u_char	sc_flags;
	u_char	sc_sien;
	u_char	sc_dien;
	u_char	sc_minsync;
	/* one for each target */
	struct syncpar {
		u_char state;
		u_char sxfer;
		u_char sbcl;
	} sc_sync[8];
};

/* sc_flags */
#define	SIOP_INTSOFF	0x80	/* Interrupts turned off */
#define	SIOP_INTDEFER	0x40	/* Level 6 interrupt has been deferred */
#define	SIOP_ALIVE	0x01	/* controller initialized */
#define SIOP_SELECTED	0x04	/* bus is in selected state. Needed for
				   correct abort procedure. */

/* sync states */
#define SYNC_START	0	/* no sync handshake started */
#define SYNC_SENT	1	/* we sent sync request, no answer yet */
#define SYNC_DONE	2	/* target accepted our (or inferior) settings,
				   or it rejected the request and we stay async */

#define	MSG_CMD_COMPLETE	0x00
#define MSG_EXT_MESSAGE		0x01
#define	MSG_SAVE_DATA_PTR	0x02
#define	MSG_RESTORE_PTR		0x03
#define	MSG_DISCONNECT		0x04
#define	MSG_INIT_DETECT_ERROR	0x05
#define	MSG_ABORT		0x06
#define	MSG_REJECT		0x07
#define	MSG_NOOP		0x08
#define	MSG_PARITY_ERROR	0x09
#define	MSG_BUS_DEVICE_RESET	0x0C
#define	MSG_IDENTIFY		0x80
#define	MSG_IDENTIFY_DR		0xc0	/* (disconnect/reconnect allowed) */
#define	MSG_SYNC_REQ		0x01

#define	STS_CHECKCOND	0x02	/* Check Condition (ie., read sense) */
#define	STS_CONDMET	0x04	/* Condition Met (ie., search worked) */
#define	STS_BUSY	0x08
#define	STS_INTERMED	0x10	/* Intermediate status sent */
#define	STS_EXT		0x80	/* Extended status valid */

void siop_minphys(struct buf *bp);
int siop_scsicmd(struct scsi_xfer *);
void siopinitialize(struct siop_softc *);
void siopintr(struct siop_softc *);
#ifdef DEBUG
void siop_dump(struct siop_softc *);
#endif

#endif /* _SIOPVAR_H */
@


1.4
log
@First round of __P removal in sys
@
text
@d1 1
a1 1
/*	$OpenBSD: siopvar.h,v 1.3 1996/05/02 06:44:36 niklas Exp $	*/
@


1.3
log
@Sync with NetBSD 9600430.  The port has gone over a major -Wall treat
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d199 4
a202 4
void siop_minphys __P((struct buf *bp));
int siop_scsicmd __P((struct scsi_xfer *));
void siopinitialize __P((struct siop_softc *));
void siopintr __P((struct siop_softc *));
d204 1
a204 1
void siop_dump __P((struct siop_softc *));
@


1.3.26.1
log
@Sync UBC branch to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: siopvar.h,v 1.3 1996/05/02 06:44:36 niklas Exp $	*/
d199 4
a202 4
void siop_minphys(struct buf *bp);
int siop_scsicmd(struct scsi_xfer *);
void siopinitialize(struct siop_softc *);
void siopintr(struct siop_softc *);
d204 1
a204 1
void siop_dump(struct siop_softc *);
@


1.3.26.2
log
@sync
@
text
@d1 1
a1 1
/*	$OpenBSD: siopvar.h,v 1.3.26.1 2002/06/11 03:34:58 art Exp $	*/
@


1.3.16.1
log
@Merge in -current from about a week ago
@
text
@d199 4
a202 4
void siop_minphys(struct buf *bp);
int siop_scsicmd(struct scsi_xfer *);
void siopinitialize(struct siop_softc *);
void siopintr(struct siop_softc *);
d204 1
a204 1
void siop_dump(struct siop_softc *);
@


1.3.16.2
log
@Sync the SMP branch with 3.3
@
text
@d1 1
a1 1
/*	$OpenBSD: siopvar.h,v 1.3.16.1 2002/03/28 10:06:14 niklas Exp $	*/
@


1.2
log
@Ensure siop_acb alignment via malloc rather than let alignment depend
on the size of MI data structures that come before it in the softc.
Chip will not function properly if alignment is wrong.
Detected and fixed by: Chuck Cranor <chuck@@ccrc.wustl.edu>
                and Michael L Hitch <osymh@@gemini.oscs.montana.edu>
@
text
@d1 2
a2 1
/*	$NetBSD: siopvar.h,v 1.12 1995/09/16 16:11:31 chopps Exp $	*/
d201 5
@


1.1
log
@Initial revision
@
text
@d144 2
a145 1
	struct siop_acb sc_acb[8];	/* the real command blocks */
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
