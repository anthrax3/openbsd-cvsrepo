head	1.12;
access;
symbols
	OPENBSD_6_2_BASE:1.12
	OPENBSD_6_1:1.6.0.4
	OPENBSD_6_1_BASE:1.6
	OPENBSD_6_0:1.2.0.2
	OPENBSD_6_0_BASE:1.2;
locks; strict;
comment	@ * @;


1.12
date	2017.09.08.05.36.51;	author deraadt;	state Exp;
branches;
next	1.11;
commitid	uRv5pa9QDlZaYgwD;

1.11
date	2017.08.21.20.05.32;	author kettenis;	state Exp;
branches;
next	1.10;
commitid	ZtRULBVnq9vYcbgE;

1.10
date	2017.08.07.19.34.53;	author kettenis;	state Exp;
branches;
next	1.9;
commitid	9gJdvyH7ZN4Nyv48;

1.9
date	2017.07.31.14.05.57;	author kettenis;	state Exp;
branches;
next	1.8;
commitid	p3t5q42UUWAtrX6X;

1.8
date	2017.07.29.19.38.01;	author kettenis;	state Exp;
branches;
next	1.7;
commitid	i1w0ErqWv21Br1mf;

1.7
date	2017.07.24.11.15.34;	author patrick;	state Exp;
branches;
next	1.6;
commitid	xjraNNAQseTa1JtE;

1.6
date	2016.10.23.19.06.08;	author kettenis;	state Exp;
branches;
next	1.5;
commitid	Jm2RcEnymdSNb8Fg;

1.5
date	2016.10.06.18.15.44;	author kettenis;	state Exp;
branches;
next	1.4;
commitid	BQmlDk49Vlbp1uQn;

1.4
date	2016.09.24.13.40.12;	author kettenis;	state Exp;
branches;
next	1.3;
commitid	wtbC8osG5m0rEk4i;

1.3
date	2016.09.13.18.27.49;	author jasper;	state Exp;
branches;
next	1.2;
commitid	PHzGPdVfpKxkA6ei;

1.2
date	2016.05.14.20.00.24;	author kettenis;	state Exp;
branches;
next	1.1;
commitid	tHmXcV1FdW3Zog5T;

1.1
date	2016.05.14.17.55.15;	author kettenis;	state Exp;
branches;
next	;
commitid	IdQZw2Pw0GuFYXCI;


desc
@@


1.12
log
@If you use sys/param.h, you don't need sys/types.h
@
text
@/*	$OpenBSD: conf.c,v 1.11 2017/08/21 20:05:32 kettenis Exp $	*/

/*
 * Copyright (c) 1996 Michael Shalayeff
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */

#include <sys/param.h>
#include <lib/libsa/stand.h>
#include <lib/libsa/ufs.h>
#include <dev/cons.h>

#include "efiboot.h"
#include "efidev.h"

const char version[] = "1.0";
int	debug = 0;

struct fs_ops file_system[] = {
	{ ufs_open,    ufs_close,    ufs_read,    ufs_write,    ufs_seek,
	  ufs_stat,    ufs_readdir    },
};
int nfsys = nitems(file_system);

struct devsw	devsw[] = {
	{ "sd", efistrategy, efiopen, eficlose, efiioctl },
};
int ndevs = nitems(devsw);

struct consdev constab[] = {
	{ efi_cons_probe, efi_cons_init, efi_cons_getc, efi_cons_putc },
	{ NULL }
};
struct consdev *cn_tab;
@


1.11
log
@Pass the address of the EFI system table and the EFI memory map through
properties in the /chosen node of the FDT.  The properties match the ones
used by Linux (see Documentation/arm/uefi.txt in the Linux kernel source
tree) but with the "linux," prefix replaced by "openbsd,".

While there, reduce the diffs to the arm64 efiboot.

ok tom@@, jsg@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.10 2017/08/07 19:34:53 kettenis Exp $	*/
a29 1
#include <sys/types.h>
@


1.10
log
@Add "machine exit" and "machine poweroff" commands to the arm64 and armv7
bootloaders.  Replace while (1) { } with for (;;) continue; per request
from tom@@.

ok tom@@, jsg@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.9 2017/07/31 14:05:57 kettenis Exp $	*/
d38 1
a38 1
const char version[] = "0.9";
@


1.9
log
@Back out previous commit but handle the case where the device path consists
of a single MEDIA_DEVICE_PATH component specially to cater for U-Boot's
somewhat broken device path handling.  Add comments to prevent confusion
in the future.  Bump the version number once again.

ok brynet@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.8 2017/07/29 19:38:01 kettenis Exp $	*/
d38 1
a38 1
const char version[] = "0.8";
@


1.8
log
@Fix off-by-one in return value of efi_device_path_depth().

ok patrick@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.7 2017/07/24 11:15:34 patrick Exp $	*/
d38 1
a38 1
const char version[] = "0.7";
@


1.7
log
@Port amd64's updates to the device path comparison to armv7.  Fixes
bootup on the i.MX6UL evaluation kit.

ok kettenis@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.6 2016/10/23 19:06:08 kettenis Exp $	*/
d38 1
a38 1
const char version[] = "0.6";
@


1.6
log
@Remove sunxi board IDs.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.5 2016/10/06 18:15:44 kettenis Exp $	*/
d38 1
a38 1
const char version[] = "0.5";
@


1.5
log
@Remove board IDs for the i.MX platform.  The kernel doesn't need them anymore.
Make sure we pass 0 as the board ID instead of random garbage if we don't
find a matching compatible string.

ok jsg@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.4 2016/09/24 13:40:12 kettenis Exp $	*/
d38 1
a38 1
const char version[] = "0.4";
@


1.4
log
@Pass esym to the kernel in r0.  Since u-boot passes 0 in this register, we
can easily determine that the value passed is valid and use it to initialize
the kernel symbol tableo.

ok tom@@, patrick@@
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.3 2016/09/13 18:27:49 jasper Exp $	*/
d38 1
a38 1
const char version[] = "0.3";
@


1.3
log
@crank bootloader version after .SUNW_ctf change

as discussed with jsing@@ it's easier this way to ensure people have
bootblocks capable of loading the section
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.2 2016/05/14 20:00:24 kettenis Exp $	*/
d38 1
a38 1
const char version[] = "0.2";
@


1.2
log
@Handle boot options, and pass the boot device to the kernel.  The boot device
is currently hardcoded to be sd0.  Still need to figure out how we will do
proper boot device selection when we start using the FDT.
@
text
@d1 1
a1 1
/*	$OpenBSD: conf.c,v 1.1 2016/05/14 17:55:15 kettenis Exp $	*/
d38 1
a38 1
const char version[] = "0.1";
@


1.1
log
@Initial stab at an EFI bootloader for armv7.  Bits and pieces from FreeBSD
and our amd64 EFI bootloader.  The current code works on a 2GB CuBox-i,
but probably not on anything else.  It needs a u-boot with EFI loader
support.
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d48 1
a48 1
	{ "efi", efistrategy, efiopen, eficlose, efiioctl },
@

