head	1.13;
access;
symbols
	OPENBSD_6_1:1.12.0.4
	OPENBSD_6_1_BASE:1.12
	OPENBSD_6_0:1.8.0.2
	OPENBSD_6_0_BASE:1.8
	OPENBSD_5_9:1.5.0.2
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.5.0.4
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.1.0.2
	OPENBSD_5_7_BASE:1.1
	OPENBSD_5_6:1.1.0.6
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.4
	OPENBSD_5_5_BASE:1.1;
locks; strict;
comment	@ * @;


1.13
date	2017.08.27.12.42.22;	author kettenis;	state Exp;
branches;
next	1.12;
commitid	ifsgDTQn6J0tcw48;

1.12
date	2016.10.25.00.04.59;	author jsg;	state Exp;
branches;
next	1.11;
commitid	kyDRkoOZHQsbTiU5;

1.11
date	2016.10.09.00.53.43;	author jsg;	state Exp;
branches;
next	1.10;
commitid	NJkwmASvm1yJz5Bo;

1.10
date	2016.10.05.07.29.59;	author patrick;	state Exp;
branches;
next	1.9;
commitid	WOkIaqGc4aRCRDhH;

1.9
date	2016.08.15.21.04.32;	author patrick;	state Exp;
branches;
next	1.8;
commitid	eDrjUzPpQZN2eX5m;

1.8
date	2016.06.08.15.27.05;	author jsg;	state Exp;
branches;
next	1.7;
commitid	O8sdMmMKqczNQU5p;

1.7
date	2016.06.04.18.09.16;	author jsg;	state Exp;
branches;
next	1.6;
commitid	tYyT96DOGdhLjy9v;

1.6
date	2016.05.18.22.55.23;	author kettenis;	state Exp;
branches;
next	1.5;
commitid	3F9JV9gcDaM81aVG;

1.5
date	2015.07.15.21.09.40;	author jsg;	state Exp;
branches;
next	1.4;
commitid	lpOHULXxeFU5ykAG;

1.4
date	2015.05.19.03.30.54;	author jsg;	state Exp;
branches;
next	1.3;
commitid	l6xI4SC4UUe6il2U;

1.3
date	2015.05.19.00.05.59;	author jsg;	state Exp;
branches;
next	1.2;
commitid	bo8vCG1OOftVcP5V;

1.2
date	2015.05.15.15.35.43;	author jsg;	state Exp;
branches;
next	1.1;
commitid	AFNG6oUBgS2y44wd;

1.1
date	2013.10.30.20.20.23;	author syl;	state Exp;
branches;
next	;


desc
@@


1.13
log
@Add glass console support for arm64.  This uses the "stdout-path" property
of the /chosen node in the device tree to decide whether the framebuffer
should be used as the console device.  Most, if not all, machines will
have that set to use a serial console and there is no easy way yet to
change that.

ok jsg@@
@
text
@/*	$OpenBSD: armv7_machdep.h,v 1.12 2016/10/25 00:04:59 jsg Exp $	*/
/*
 * Copyright (c) 2013 Sylvestre Gallon <ccna.syl@@gmail.com>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#ifndef __PLATFORMVAR_H__
#define __PLATFORMVAR_H__

void platform_init(void);
void platform_powerdown(void);
void platform_watchdog_reset(void);
void platform_init_cons(void);
void platform_init_mainbus(struct device *);
struct board_dev *platform_board_devs();
extern void (*cpuresetfn)(void);
extern void (*powerdownfn)(void);

struct armv7_platform {
	struct board_dev *devs;
	void (*board_init)(void);
	void (*smc_write)(bus_space_tag_t, bus_space_handle_t, bus_size_t,
	    uint32_t, uint32_t);
	void (*init_cons)(void);
	void (*watchdog_reset)(void);
	void (*powerdown)(void);
	void (*init_mainbus)(struct device *);
};

#endif /* __PLATFORMVAR_H__ */
@


1.12
log
@Remove now unused disable_l2_if_needed interface.
ok kettenis@@ patrick@@
@
text
@d1 1
a1 1
/*	$OpenBSD: armv7_machdep.h,v 1.11 2016/10/09 00:53:43 jsg Exp $	*/
a20 2
extern int stdout_node;

a26 1
void *fdt_find_cons(const char *);
@


1.11
log
@Add a power down function pointer so power down can work without the
platform abstraction.

ok tom@@ kettenis@@
@
text
@d1 1
a1 1
/*	$OpenBSD: armv7_machdep.h,v 1.10 2016/10/05 07:29:59 patrick Exp $	*/
a27 1
void platform_disable_l2_if_needed(void);
a40 1
	void (*disable_l2_if_needed)(void);
@


1.10
log
@Introduce a global function pointer to reset the CPU akin to amd64 and
i386.  As newer ARMs where we use device tree from the get go don't
necessarily have a 'platform', this will allow drivers to hook
themselves as a way to reset the CPU.

ok jsg@@ kettenis@@ tom@@
@
text
@d1 1
a1 1
/*	$OpenBSD: armv7_machdep.h,v 1.9 2016/08/15 21:04:32 patrick Exp $	*/
d32 1
@


1.9
log
@Now that com(4) uses a different iot for the initial console and the
main attachment, the serial port is now longer recognized as console.
To fix this, store the OFW node of the initial console and check it
in the attachment driver.

ok kettenis@@
@
text
@d1 1
a1 1
/*	$OpenBSD: armv7_machdep.h,v 1.8 2016/06/08 15:27:05 jsg Exp $	*/
d31 1
@


1.8
log
@Use fdt to find the console to initialise.  Try to use /chosen/stdout-path
if present otherwise fallback to /aliases/serial0.

Don't require a platform match to run the various console init functions
so the init functions will run for unknown board ids.

With and ok kettenis@@ on a earlier version.
@
text
@d1 1
a1 1
/*	$OpenBSD: armv7_machdep.h,v 1.7 2016/06/04 18:09:16 jsg Exp $	*/
d20 2
@


1.7
log
@Remove model specific strings keyed off the board id.
We now pull the model string from fdt.
@
text
@d1 1
a1 1
/*	$OpenBSD: armv7_machdep.h,v 1.6 2016/05/18 22:55:23 kettenis Exp $	*/
d28 1
@


1.6
log
@Introduce a per-platform init_mainbus() hook that can be used to attach
platform-specific devices to mainbus before we start walking the FDT.

ok patrick@@
@
text
@d1 1
a1 1
/*	$OpenBSD: armv7_machdep.h,v 1.5 2015/07/15 21:09:40 jsg Exp $	*/
a26 2
const char *platform_boot_name(void);
const char *platform_board_name(void);
a29 2
	const char *boot_name;
	const char *(*board_name)(void);
@


1.5
log
@The exynos gic is not at a fixed offset from periphbase unlike
the other socs.  Handle this by setting variables in exynos{4,5}_init
functions and calling the board_init callback earlier.

tested by and ok bmercer@@
@
text
@d1 1
a1 1
/*	$OpenBSD: armv7_machdep.h,v 1.4 2015/05/19 03:30:54 jsg Exp $	*/
d25 1
d42 1
@


1.4
log
@Abstract the soc_machdep.c functions to allow a kernel to be built for
multiple socs.

From Patrick Wildt in bitrig with some additional changes.
@
text
@d1 1
a1 1
/*	$OpenBSD: armv7_machdep.h,v 1.3 2015/05/19 00:05:59 jsg Exp $	*/
a21 1
void platform_board_init();
a25 1
void platform_board_init(void);
@


1.3
log
@use the same va entry point on all armv7 socs
Similiar changes were made in bitrig by Patrick Wildt.

As part of this change the physical load address for imx and sunxi have
changed.  Any u-boot settings that include it will need to be modified.

imx: 0x10800000 -> 0x10300000
sunxi: 0x40800000 -> 0x40300000

Tested by bmercer, canacar and myself.
ok bmercer@@
@
text
@d1 1
a1 1
/*	$OpenBSD: armv7_machdep.h,v 1.2 2015/05/15 15:35:43 jsg Exp $	*/
d21 2
d26 3
d30 14
a43 2
void platform_disable_l2_if_needed(void);
extern const char *platform_boot_name;
@


1.2
log
@Make board attaching table driven and move it out into the soc
directories.  Move the device tables while here as was done in bitrig.
With these changes the only use of the board id defines is in the soc
directories.

Tested by matthieu and djm on imx and myself on omap and sunxi (qemu).
ok djm@@, ok jasper@@ on an earlier version
@
text
@d1 1
a1 1
/*	$OpenBSD: armv7_machdep.h,v 1.1 2013/10/30 20:20:23 syl Exp $	*/
a24 1
void platform_bootconfig_dram(BootConfig *, psize_t *, psize_t *);
@


1.1
log
@Put all the generic machdep code in armv7_machedep.c

Cleanup the machdep code removing:
- useless includes
- useless globals and prototypes
- useless #if 0 and #if 1
- some style(9) issues

This commit will make the bringup of new SoC easier.

ok patrick@@ jasper@@ rapha@@
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d24 1
a24 1
void platform_print_board_type(void);
@

