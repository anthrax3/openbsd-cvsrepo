head	1.21;
access;
symbols
	OPENBSD_6_1:1.21.0.2
	OPENBSD_6_1_BASE:1.21
	OPENBSD_6_0:1.13.0.2
	OPENBSD_6_0_BASE:1.13
	OPENBSD_5_9:1.12.0.2
	OPENBSD_5_9_BASE:1.12
	OPENBSD_5_8:1.12.0.4
	OPENBSD_5_8_BASE:1.12
	OPENBSD_5_7:1.7.0.2
	OPENBSD_5_7_BASE:1.7
	OPENBSD_5_6:1.4.0.4
	OPENBSD_5_6_BASE:1.4
	OPENBSD_5_5:1.3.0.4
	OPENBSD_5_5_BASE:1.3;
locks; strict;
comment	@# @;


1.21
date	2017.01.25.11.15.07;	author kettenis;	state Exp;
branches;
next	1.20;
commitid	SbX05HnGufiooA06;

1.20
date	2016.11.29.09.08.34;	author mpi;	state Exp;
branches;
next	1.19;
commitid	yUJbDchhkVm6F1HA;

1.19
date	2016.11.15.09.08.37;	author natano;	state Exp;
branches;
next	1.18;
commitid	uQeojuKIzgIWOEnv;

1.18
date	2016.10.27.20.44.20;	author natano;	state Exp;
branches;
next	1.17;
commitid	eR4vLZnymgQjVxbj;

1.17
date	2016.10.24.18.26.17;	author deraadt;	state Exp;
branches;
next	1.16;
commitid	84F8eQ949AbxN83e;

1.16
date	2016.10.15.13.45.08;	author deraadt;	state Exp;
branches;
next	1.15;
commitid	TtDw6IYffbT8oPEE;

1.15
date	2016.10.14.18.43.01;	author deraadt;	state Exp;
branches;
next	1.14;
commitid	dUZQxi6w3YqAb6KQ;

1.14
date	2016.09.24.19.13.03;	author kettenis;	state Exp;
branches;
next	1.13;
commitid	N8Z5nlTJHj3pmauV;

1.13
date	2016.04.29.12.44.52;	author mpi;	state Exp;
branches;
next	1.12;
commitid	Vbd8R29nZBKG6KtM;

1.12
date	2015.06.08.06.33.16;	author jsg;	state Exp;
branches;
next	1.11;
commitid	TKnNVNES86I6ApFq;

1.11
date	2015.06.02.02.30.16;	author jsg;	state Exp;
branches;
next	1.10;
commitid	MDqoReLKfFLYYM4U;

1.10
date	2015.05.27.00.06.14;	author jsg;	state Exp;
branches;
next	1.9;
commitid	G6QP18Ap4gF8hOTp;

1.9
date	2015.05.20.01.44.20;	author jsg;	state Exp;
branches;
next	1.8;
commitid	AyYz7FgJK6jKwvRv;

1.8
date	2015.05.19.00.05.59;	author jsg;	state Exp;
branches;
next	1.7;
commitid	bo8vCG1OOftVcP5V;

1.7
date	2015.01.13.01.12.49;	author deraadt;	state Exp;
branches;
next	1.6;
commitid	xEYSgcMiEU7N21VE;

1.6
date	2015.01.11.19.25.13;	author tedu;	state Exp;
branches;
next	1.5;
commitid	Jqptj5xcqx8IMSNU;

1.5
date	2014.10.04.18.10.14;	author brad;	state Exp;
branches;
next	1.4;
commitid	iaz4yUwbbR9oynrV;

1.4
date	2014.05.08.21.17.01;	author miod;	state Exp;
branches;
next	1.3;

1.3
date	2014.02.02.03.59.25;	author miod;	state Exp;
branches;
next	1.2;

1.2
date	2013.10.15.19.23.26;	author guenther;	state Exp;
branches;
next	1.1;

1.1
date	2013.09.04.14.38.25;	author patrick;	state Exp;
branches;
next	;


desc
@@


1.21
log
@Build amd64 kernels with -ffreestanding.  Synchronize the arm64 and armv7
kernel makefiles, that are using -ffreestanding already, with the amd64 one.
Other architectures will follow later.

ok jca@@, visa@@
@
text
@#	$OpenBSD: Makefile.armv7,v 1.20 2016/11/29 09:08:34 mpi Exp $

# For instructions on building kernels consult the config(8) and options(4)
# manual pages.
#
# N.B.: NO DEPENDENCIES ON FOLLOWING FLAGS ARE VISIBLE TO MAKEFILE
#	IF YOU CHANGE THE DEFINITION OF ANY OF THESE RECOMPILE EVERYTHING
# DEBUG is set to -g by config if debugging is requested (config -g).
# PROF is set to -pg by config if profiling is requested (config -p).

.include <bsd.own.mk>

SIZE?=	size
STRIP?=	strip

# source tree is located via $S relative to the compilation directory
.ifndef S
S!=	cd ../../../..; pwd
.endif

_machdir?=	$S/arch/${_mach}
_archdir?=	$S/arch/${_arch}

INCLUDES=	-nostdinc -I$S -I. -I$S/arch
CPPFLAGS=	${INCLUDES} ${IDENT} ${PARAM} -D_KERNEL -D__${_mach}__ -MD -MP
CWARNFLAGS=	-Werror -Wall -Wimplicit-function-declaration \
		-Wno-uninitialized -Wno-pointer-sign \
		-Wframe-larger-than=2047

CMACHFLAGS=	-msoft-float -march=armv6 -Wa,-march=armv7a
CMACHFLAGS+=	-ffreestanding ${NOPIE_FLAGS}
.if ${IDENT:M-DNO_PROPOLICE}
CMACHFLAGS+=	-fno-stack-protector
.endif

DEBUG?=		-g
COPTS?=		-O2
CFLAGS=		${DEBUG} ${CWARNFLAGS} ${CMACHFLAGS} ${COPTS} ${PIPE}
AFLAGS=		-D_LOCORE -x assembler-with-cpp ${CWARNFLAGS} ${CMACHFLAGS}
LINKFLAGS=	-T ldscript --warn-common -nopie

.if ${IDENT:M-DDDB_STRUCT}
DB_STRUCTINFO=	db_structinfo.h
.else
DB_STRUCTINFO=
.endif

HOSTCC?=	${CC}
HOSTED_CPPFLAGS=${CPPFLAGS:S/^-nostdinc$//}
HOSTED_CFLAGS=	${CFLAGS}
HOSTED_C=	${HOSTCC} ${HOSTED_CFLAGS} ${HOSTED_CPPFLAGS} -c $<

NORMAL_C_NOP=	${CC} ${CFLAGS} ${CPPFLAGS} -c $<
NORMAL_C=	${CC} ${CFLAGS} ${CPPFLAGS} ${PROF} -c $<
NORMAL_S=	${CC} ${AFLAGS} ${CPPFLAGS} -c $<

%OBJS

%CFILES

%SFILES

# load lines for config "xxx" will be emitted as:
# xxx: ${SYSTEM_DEP} swapxxx.o
#	${SYSTEM_LD_HEAD}
#	${SYSTEM_LD} swapxxx.o
#	${SYSTEM_LD_TAIL}
SYSTEM_HEAD=	${_mach}_start.o locore.o param.o ioconf.o
SYSTEM_OBJ=	${SYSTEM_HEAD} ${OBJS}
SYSTEM_DEP=	Makefile ${SYSTEM_OBJ}
SYSTEM_LD_HEAD=	@@rm -f $@@
SYSTEM_LD_HEAD+=; \
		cat ${_archdir}/conf/ldscript.head ${_archdir}/conf/ldscript.tail | \
		    sed -e 's/@@KERNEL_BASE_PHYS@@/0/' \
		    -e 's/@@KERNEL_BASE_VIRT@@/${KERNEL_BASE_VIRT}/' \
		    -e 's/(KERNEL_BASE_phys)/(KERNEL_BASE_virt)/' > ldscript

SYSTEM_LD=	@@echo ${LD} ${LINKFLAGS} -o $@@ '$${SYSTEM_HEAD} vers.o $${OBJS}'; \
		${LD} ${LINKFLAGS} -o $@@ ${SYSTEM_HEAD} vers.o ${OBJS}
SYSTEM_LD_TAIL=	@@${SIZE} $@@; chmod 755 $@@

.if ${DEBUG} == "-g"
STRIPFLAGS=	-S
SYSTEM_LD_TAIL+=; \
		echo mv $@@ $@@.gdb; rm -f $@@.gdb; mv $@@ $@@.gdb; \
		echo ${STRIP} ${STRIPFLAGS} -o $@@ $@@.gdb; \
		${STRIP} ${STRIPFLAGS} -o $@@ $@@.gdb
.else
LINKFLAGS+=	-S
.endif

%LOAD

# cc's -MD puts the source and output paths in the dependency file;
# since those are temp files here we need to fix it up.  It also
# puts the file in /tmp, so we use -MF to put it in the current
# directory as assym.P and then generate assym.d from it with a
# good target name
assym.h: $S/kern/genassym.sh Makefile \
	 ${_archdir}/${_arch}/genassym.cf ${_machdir}/${_mach}/genassym.cf
	cat ${_archdir}/${_arch}/genassym.cf ${_machdir}/${_mach}/genassym.cf | \
	    sh $S/kern/genassym.sh ${CC} ${CFLAGS} ${CPPFLAGS} -MF assym.P > assym.h.tmp
	sed '1s/.*/assym.h: \\/' assym.P > assym.d
	sort -u assym.h.tmp > assym.h

param.c: $S/conf/param.c
	rm -f param.c
	cp $S/conf/param.c .

param.o: param.c Makefile
	${NORMAL_C}

mcount.o: $S/lib/libkern/mcount.c Makefile
	${NORMAL_C_NOP}

ioconf.o: ioconf.c
	${NORMAL_C}

vers.o: ${SYSTEM_DEP} ${SYSTEM_SWAP_DEP}
	sh $S/conf/newvers.sh
	${CC} ${CFLAGS} ${CPPFLAGS} ${PROF} -c vers.c

clean:
	rm -f *bsd *bsd.gdb *.[dio] [a-z]*.s assym.* ${DB_STRUCTINFO} param.c

cleandir: clean
	rm -f Makefile *.h ioconf.c options machine ${_mach} vers.c

depend obj:

db_structinfo.h: $S/ddb/db_structinfo.c $S/ddb/parse_structinfo.pl
	${CC} ${CFLAGS} ${CPPFLAGS} -MT $@@ -gstabs -c $S/ddb/db_structinfo.c
	objdump -g db_structinfo.o | perl $S/ddb/parse_structinfo.pl > $@@
	rm -f db_structinfo.o

${_mach}_start.o: ${_machdir}/${_mach}/${_mach}_start.S
locore.o: ${_archdir}/${_arch}/locore.S assym.h
in_cksum_arm.o fiq_subr.o bcopyinout.o copystr.o sigcode.o: assym.h
vectors.o cpuswitch7.o exception.o bcopy_page.o irq_dispatch.o: assym.h
armv7_start.o: assym.h

# The install target can be redefined by putting a
# install-kernel-${MACHINE_NAME} target into /etc/mk.conf
MACHINE_NAME!=  uname -n
install: install-kernel-${MACHINE_NAME}
.if !target(install-kernel-${MACHINE_NAME}})
install-kernel-${MACHINE_NAME}:
	cmp -s bsd /bsd || ln -f /bsd /obsd
	cp bsd /nbsd
	mv /nbsd /bsd
.endif

# pull in the dependency information
.if !empty(DB_STRUCTINFO) && !exists(${DB_STRUCTINFO})
 ${SYSTEM_OBJ}: ${DB_STRUCTINFO}
.endif
.ifnmake clean
. for o in ${SYSTEM_OBJ} assym.h ${DB_STRUCTINFO}
.  if exists(${o:R}.d)
.   include "${o:R}.d"
.  elif exists($o)
    .PHONY: $o
.  endif
. endfor
.endif


# until we get native booting working, put this in the tree.
KERNADDR_OMAP=0x80300000
KERNADDR_IMX=0x10300000
KERNADDR_SUNXI=0x40300000
KERNADDR_EXYNOS=0x40300000
KERNADDR_VEXPRESSA15=0x80300000
KERNADDR_VEXPRESSA9=0x60300000

.for SOC in IMX OMAP SUNXI EXYNOS VEXPRESSA9 VEXPRESSA15
bsd.${SOC}.umg: bsd
	mkuboot -a arm -o linux -e ${KERNADDR_${SOC}} -l ${KERNADDR_${SOC}} \
	    bsd bsd.${SOC}.umg
.endfor

bsd.rd: bsd
	cp bsd bsd.rd
	$S/../distrib/${_mach}/ramdisk/rdsetroot < $S/../distrib/${_mach}/ramdisk/mr.fs bsd.rd

%RULES
@


1.20
log
@Build kernel with DEBUG=-g by default.

This will allow us to extract type informations from DWARF2 sections.  It
also makes developer life easier as debug information are now included in
every object.

Resulting kernels will be stripped using strip(1) instead of ld(1).

Kernel build time increases by approximately 10%.  However it is still
possible to disable this by defining DEBUG="".

ok kettenis@@, bluhm@@, natano@@, jasper@@, reyk@@, deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.19 2016/11/15 09:08:37 natano Exp $
d27 1
a27 1
		-Wno-main -Wno-uninitialized -Wno-pointer-sign \
d30 2
a31 4
CMACHFLAGS=	-ffreestanding -msoft-float -march=armv6 -Wa,-march=armv7a
CMACHFLAGS+=	-fno-builtin-printf -fno-builtin-snprintf \
		-fno-builtin-vsnprintf -fno-builtin-log \
		-fno-builtin-log2 -fno-builtin-malloc ${NOPIE_FLAGS}
@


1.19
log
@Clean up the kernel Makefile's:

- Remove the 'lint' target. lint has been removed with OpenBSD 5.2.
- Remove the 'tags' target. It does nothing of value.
- Replace 'clean::' with 'clean:', as requested by espie and millert,
  and remove files from the 'clean' target, that are never generated.
- Don't create a file called 'depend' in 'make depend', but just do
  nothing instead.

ok mpi tb
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.18 2016/10/27 20:44:20 natano Exp $
d38 1
a83 1
DEBUG?=
@


1.18
log
@We don't generate an eddep script for kernel builds nowadays. The last
reference to eddep in the kernel Makefile I could find is in 4.3BSD,
released some 30 years ago.

ok tb millert
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.17 2016/10/24 18:26:17 deraadt Exp $
d125 2
a126 3
clean::
	rm -f *bsd *bsd.gdb tags *.[dio] [a-z]*.s \
	    [Ee]rrs linterrs assym.* ${DB_STRUCTINFO} param.c
d131 1
a131 12
lint:
	@@lint -hbxncez -Dvolatile= ${CPPFLAGS} -UKGDB \
	    ${CFILES} ioconf.c param.c | \
	    grep -v 'static function .* unused'

obj:

depend:
	@@touch $@@

tags:
	@@echo "see $S/kern/Makefile for tags"
@


1.17
log
@make cleandir should skip the version file; ok otto millert
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.16 2016/10/15 13:45:08 deraadt Exp $
d126 1
a126 1
	rm -f eddep *bsd *bsd.gdb tags *.[dio] [a-z]*.s \
@


1.16
log
@cleandir: target for kernel compile directories
ok natano
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.15 2016/10/14 18:43:01 deraadt Exp $
d130 1
a130 1
	rm -f Makefile *.h ioconf.c options machine ${_mach} vers.c version
@


1.15
log
@Kernel builds now happen in compile/CONFIG/obj@@ -> /usr/obj/... [or ./obj/,
if srctree is not rooted at /usr/src].  As a result, stock GENERIC & RAMDISK
kernels are commited to the tree, to ensure the src tree can be "readonly"
during builds, with all writes occuring inside the obj space.  config -b
options are handled by ../Makefile.inc.  The canonical new way to configure
one of these kernels is:
    % cd /sys/arch/amd64/compile/GENERIC.MP
    % doas make obj
    % make config
    % make
    % doas cp obj/bsd /bsd
The build infrastructure will use this new mechanism in a de-escalation
way using BUILDUSER.
Much help from natano and tb.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.14 2016/09/24 19:13:03 kettenis Exp $
d127 4
a130 1
	    [Ee]rrs linterrs assym.h ${DB_STRUCTINFO}
@


1.14
log
@Add -Wno-pointer-sign to all our gcc4 architectures.

ok patrick@@ (for armv7), deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.13 2016/04/29 12:44:52 mpi Exp $
d133 2
@


1.13
log
@Do not remove local symbols from the table.

ddb(4) can now see static functions.  That doesn't mean we should start
declaring functions as ``static'', however it helps for the few existing
exceptions.

ok deraadt@@, kettenis@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.12 2015/06/08 06:33:16 jsg Exp $
d27 1
a27 1
		-Wno-main -Wno-uninitialized \
@


1.12
log
@Add initial support for the ARM Versatile Express boards as emulated by
qemu with virtio memory ranges.

Unfortunately the vexpress-a9 and vexpress-a15 boards/targets have
different load addresses and memory maps.

Code for the PL011 UART and mmio virtio attachment from Patrick Wildt
in bitrig.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.11 2015/06/02 02:30:16 jsg Exp $
d85 1
a85 2
LINKFLAGS+=	-X
STRIPFLAGS=	-g -x
d91 1
a91 1
LINKFLAGS+=	-x
@


1.11
log
@with binutils 2.17 we can change some raw opcodes into instruction names
ok miod@@ deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.10 2015/05/27 00:06:14 jsg Exp $
d183 2
d186 1
a186 1
.for SOC in IMX OMAP SUNXI EXYNOS
@


1.10
log
@make the exynos code compile without fdt
ok bmercer@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.9 2015/05/20 01:44:20 jsg Exp $
d30 1
a30 1
CMACHFLAGS=	-ffreestanding -msoft-float -march=armv6
@


1.9
log
@Now all the socs use the same va entry point and don't have any
conflicting symbols we can combine the configs.

Multiple umg files are still required however.  The bsd.umg target in
the kernel is replaced by targets for bsd.IMX.umg, bsd.OMAP.umg and
bsd.SUNXI.umg.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.8 2015/05/19 00:05:59 jsg Exp $
d182 1
d184 1
a184 1
.for SOC in IMX OMAP SUNXI
@


1.8
log
@use the same va entry point on all armv7 socs
Similiar changes were made in bitrig by Patrick Wildt.

As part of this change the physical load address for imx and sunxi have
changed.  Any u-boot settings that include it will need to be modified.

imx: 0x10800000 -> 0x10300000
sunxi: 0x40800000 -> 0x40300000

Tested by bmercer, canacar and myself.
ok bmercer@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.7 2015/01/13 01:12:49 deraadt Exp $
d179 9
a187 6

bsdrd.umg: bsd.rd
	mkuboot -a arm -o linux -e ${KERNEL_BASE_PHYS} -l ${KERNEL_BASE_PHYS} bsd.rd bsdrd.umg

bsd.umg: bsd
	mkuboot -a arm -o linux -e ${KERNEL_BASE_PHYS} -l ${KERNEL_BASE_PHYS} bsd bsd.umg
@


1.7
log
@for the install: target, use cmp as a rough attempt for avoiding repeated
make install
from Simon Nicolussi
ok jsing tedu
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.6 2015/01/11 19:25:13 tedu Exp $
d75 3
a77 2
		    sed -e 's/@@KERNEL_BASE_PHYS@@/${KERNEL_BASE_PHYS}/' \
		    -e 's/@@KERNEL_BASE_VIRT@@/${KERNEL_BASE_VIRT}/' > ldscript
@


1.6
log
@switch prototype warnings to implicit-declaration warnings.
This should catch all the same bad cases, but be a little less aggravating
in circumstances where a prototype isn't necessary
ok deraadt
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.5 2014/10/04 18:10:14 brad Exp $
d157 1
a157 2
	rm -f /obsd
	ln /bsd /obsd
@


1.5
log
@Switch the kernel configs over to using -Wframe-larger-than= instead of
-Wstack-larger-than-. This is what modern GCC supports as well as LLVM.

ok miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.4 2014/05/08 21:17:01 miod Exp $
d26 1
a26 1
CWARNFLAGS=	-Werror -Wall -Wstrict-prototypes -Wmissing-prototypes \
@


1.4
log
@Format string fixes and removal of -Wno-format for arm kernels.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.3 2014/02/02 03:59:25 miod Exp $
d28 1
a28 1
		-Wstack-larger-than-2047
@


1.3
log
@armv7_start.o needs an explicit dependency on assym.h now; nick
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.2 2013/10/15 19:23:26 guenther Exp $
d27 1
a27 1
		-Wno-main -Wno-uninitialized -Wno-format \
@


1.2
log
@Rewrite the awk script that generates the data for option DDB_STRUCT:
 - switch to perl for better data structures and (thus) speed
 - fix a couple glitches in the interpretation of the stabs output
 - compress the strings by putting them in one big array and overlaying
   suffixes
 - all sizes and offsets are <64k, so use u_short for them
This results in ~60% reduction in the resulting text size and it now
takes less than a second to create on fast platforms.

ok miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.armv7,v 1.1 2013/09/04 14:38:25 patrick Exp $
d149 1
@


1.1
log
@In the future, we shouldn't have one port port ARM SoC, that's just
ridiculous.  This is the first step for a common and generic ARM port
for ARMv7 SoCs.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile.beagle,v 1.45 2013/08/02 09:09:17 rapha Exp $
d140 1
a140 1
db_structinfo.h: $S/ddb/db_structinfo.c $S/ddb/parse_structinfo.awk
d142 1
a142 1
	objdump -g db_structinfo.o | awk -f $S/ddb/parse_structinfo.awk > $@@
@

