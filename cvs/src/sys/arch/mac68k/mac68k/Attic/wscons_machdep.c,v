head	1.7;
access;
symbols
	OPENBSD_5_1_BASE:1.6
	OPENBSD_5_1:1.6.0.18
	OPENBSD_5_0:1.6.0.16
	OPENBSD_5_0_BASE:1.6
	OPENBSD_4_9:1.6.0.14
	OPENBSD_4_9_BASE:1.6
	OPENBSD_4_8:1.6.0.12
	OPENBSD_4_8_BASE:1.6
	OPENBSD_4_7:1.6.0.8
	OPENBSD_4_7_BASE:1.6
	OPENBSD_4_6:1.6.0.10
	OPENBSD_4_6_BASE:1.6
	OPENBSD_4_5:1.6.0.6
	OPENBSD_4_5_BASE:1.6
	OPENBSD_4_4:1.6.0.4
	OPENBSD_4_4_BASE:1.6
	OPENBSD_4_3:1.6.0.2
	OPENBSD_4_3_BASE:1.6
	OPENBSD_4_2:1.5.0.8
	OPENBSD_4_2_BASE:1.5
	OPENBSD_4_1:1.5.0.6
	OPENBSD_4_1_BASE:1.5
	OPENBSD_4_0:1.5.0.4
	OPENBSD_4_0_BASE:1.5
	OPENBSD_3_9:1.5.0.2
	OPENBSD_3_9_BASE:1.5;
locks; strict;
comment	@ * @;


1.7
date	2012.06.20.18.23.52;	author matthew;	state dead;
branches;
next	1.6;

1.6
date	2008.01.23.16.37.56;	author jsing;	state Exp;
branches;
next	1.5;

1.5
date	2006.01.18.23.21.17;	author miod;	state Exp;
branches;
next	1.4;

1.4
date	2006.01.10.21.19.15;	author miod;	state Exp;
branches;
next	1.3;

1.3
date	2006.01.09.20.51.49;	author miod;	state Exp;
branches;
next	1.2;

1.2
date	2006.01.08.16.36.54;	author miod;	state Exp;
branches;
next	1.1;

1.1
date	2006.01.04.20.39.05;	author miod;	state Exp;
branches;
next	;


desc
@@


1.7
log
@RIP mac68k.  No one loves you anymore.
@
text
@/*	$OpenBSD: wscons_machdep.c,v 1.6 2008/01/23 16:37:56 jsing Exp $	*/
/*	$NetBSD: maccons.c,v 1.5 2005/01/15 16:00:59 chs Exp $	*/

/*
 * Copyright (C) 1999 Scott Reynolds.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

#include <sys/param.h>
#include <sys/systm.h>
#include <sys/device.h>
#include <sys/conf.h>
#include <sys/timeout.h>

#include <machine/autoconf.h>
#include <machine/bus.h>
#include <machine/cpu.h>

#include <dev/cons.h>

#include <dev/wscons/wskbdvar.h>
#include <dev/wscons/wsdisplayvar.h>
#include <dev/rasops/rasops.h>

#include <mac68k/dev/nubus.h>
#include <mac68k/dev/macfbvar.h>
#include <dev/adb/akbdvar.h>

#include "wsdisplay.h"
#include "wskbd.h"

cons_decl(ws);

int	maccons_initted = (-1);

void
wscnprobe(struct consdev *cp)
{
#if NWSDISPLAY > 0
	int     maj, unit;
#endif

	cp->cn_dev = NODEV;
	cp->cn_pri = CN_LOWPRI;

#if NWSDISPLAY > 0
	unit = 0;
	for (maj = 0; maj < nchrdev; maj++)
		if (cdevsw[maj].d_open == wsdisplayopen)
			break;

	if (maj != nchrdev) {
		cp->cn_pri = CN_MIDPRI;
		cp->cn_dev = makedev(maj, unit);
	}
#endif
}

void
wscninit(struct consdev *cp)
{
	/*
	 * XXX evil hack; see consinit() for an explanation.
	 * note:  maccons_initted is initialized to (-1).
	 */
	if (++maccons_initted > 0) {
		macfb_cnattach();
		akbd_cnattach();
	}
}

int
wscngetc(dev_t dev)
{
#if NWSKBD > 0
	return wskbd_cngetc(dev);
#else
	return 0;
#endif
}

void
wscnputc(dev_t dev, int c)
{
#if NWSDISPLAY > 0
	wsdisplay_cnputc(dev,c);	
#endif
}

void
wscnpollc(dev_t dev, int on)
{
#if NWSKBD > 0
	wskbd_cnpollc(dev,on);
#endif
}
@


1.6
log
@Cleanup cn_pri. Change constants to more meaningful names, rather than
the hp300 related ones currently in use. CN_NORMAL becomes CN_LOWPRI,
CN_INTERNAL becomes CN_MIDPRI and CN_REMOTE becomes CN_HIGHPRI.

ok miod@@
@
text
@d1 1
a1 1
/*	$OpenBSD: wscons_machdep.c,v 1.5 2006/01/18 23:21:17 miod Exp $	*/
@


1.5
log
@Factorize akbd and ams drivers between mac68k and macppc; while there, start
moving out common adb code as well, and merge adb_direct.c into adb.c to
simplify external header files.

No functional change; more cleanups to come.
@
text
@d1 1
a1 1
/*	$OpenBSD: wscons_machdep.c,v 1.4 2006/01/10 21:19:15 miod Exp $	*/
d65 1
a65 1
	cp->cn_pri = CN_NORMAL;
d74 1
a74 1
		cp->cn_pri = CN_INTERNAL;
@


1.4
log
@Simplify external macfb interfaces, kill an intermediate attachment structure.
@
text
@d1 1
a1 1
/*	$OpenBSD: wscons_machdep.c,v 1.3 2006/01/09 20:51:49 miod Exp $	*/
d48 1
a48 1
#include <mac68k/dev/akbdvar.h>
@


1.3
log
@Ditch the grf frame buffer abstraction, and directly attach macfb to
either obio or nubus. No functional change, shaves a few more KB...
@
text
@d1 1
a1 1
/*	$OpenBSD: wscons_machdep.c,v 1.2 2006/01/08 16:36:54 miod Exp $	*/
a56 3
/* From Booter via locore */
extern u_int32_t	mac68k_vidphys;

d88 1
a88 1
		macfb_cnattach(mac68k_vidphys);
@


1.2
log
@Switch macfb from an rcons backend to a rasops backend; supposedly restores
all pixel depth operation, but there are still font display problems at
4bpp and 16bpp at the moment; also make sure the display is white on black,
whichever colour depth we are in.
@
text
@d1 1
a1 1
/*	$OpenBSD: wscons_machdep.c,v 1.1 2006/01/04 20:39:05 miod Exp $	*/
d37 1
d46 1
@


1.1
log
@Import NetBSD's direct adb code on mac68k, switching to real keyboard and mouse
drivers, and to wscons as the console; a few parts borrowed from OpenBSD/macppc
as well.

Currently only working with displays configured in 1bpp or 8bpp modes; this
limitation will be worked on ASAP.

Tested by claudio@@ kettenis@@ martin@@ nick@@ and I on various models. X11 changes
coming soon.
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d43 1
@

