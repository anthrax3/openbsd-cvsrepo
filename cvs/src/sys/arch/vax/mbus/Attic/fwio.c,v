head	1.4;
access;
symbols
	OPENBSD_5_9:1.3.0.2
	OPENBSD_5_9_BASE:1.3
	OPENBSD_5_8:1.2.0.20
	OPENBSD_5_8_BASE:1.2
	OPENBSD_5_7:1.2.0.12
	OPENBSD_5_7_BASE:1.2
	OPENBSD_5_6:1.2.0.16
	OPENBSD_5_6_BASE:1.2
	OPENBSD_5_5:1.2.0.14
	OPENBSD_5_5_BASE:1.2
	OPENBSD_5_4:1.2.0.10
	OPENBSD_5_4_BASE:1.2
	OPENBSD_5_3:1.2.0.8
	OPENBSD_5_3_BASE:1.2
	OPENBSD_5_2:1.2.0.6
	OPENBSD_5_2_BASE:1.2
	OPENBSD_5_1_BASE:1.2
	OPENBSD_5_1:1.2.0.4
	OPENBSD_5_0:1.2.0.2
	OPENBSD_5_0_BASE:1.2
	OPENBSD_4_9:1.1.0.10
	OPENBSD_4_9_BASE:1.1
	OPENBSD_4_8:1.1.0.8
	OPENBSD_4_8_BASE:1.1
	OPENBSD_4_7:1.1.0.4
	OPENBSD_4_7_BASE:1.1
	OPENBSD_4_6:1.1.0.6
	OPENBSD_4_6_BASE:1.1
	OPENBSD_4_5:1.1.0.2
	OPENBSD_4_5_BASE:1.1;
locks; strict;
comment	@ * @;


1.4
date	2016.03.09.16.28.48;	author deraadt;	state dead;
branches;
next	1.3;
commitid	OSDG2O3Cgeifnf1W;

1.3
date	2015.09.13.12.31.35;	author miod;	state Exp;
branches;
next	1.2;
commitid	crsKIfL2CNapLk7x;

1.2
date	2011.07.06.20.42.52;	author miod;	state Exp;
branches;
next	1.1;

1.1
date	2008.08.18.23.19.25;	author miod;	state Exp;
branches;
next	;


desc
@@


1.4
log
@We are done providing support for the vax.
lots of agreement.
@
text
@/*	$OpenBSD: fwio.c,v 1.3 2015/09/13 12:31:35 miod Exp $	*/

/*
 * Copyright (c) 2008 Miodrag Vallat.
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

/*
 * Firefox Workstation I/O Module
 *
 * This M-bus board sports:
 * - a System Support Chip implementing the (off cpu) clocks.
 * - a SII controller, in SCSI mode, with 128KB static memory.
 * - a LANCE Ethernet controller, with 128KB static memory.
 * - a DZQ11-compatible DC7085 4 lines serial controller.
 */


#include <sys/param.h>
#include <sys/systm.h>
#include <sys/device.h>
#include <sys/malloc.h>

#include <machine/bus.h>

#include <vax/mbus/mbusreg.h>
#include <vax/mbus/mbusvar.h>
#include <vax/mbus/fwioreg.h>
#include <vax/mbus/fwiovar.h>

struct fwio_softc {
	struct device	sc_dev;
	long		sc_loc[1];	/* locators override */
};

void	fwio_attach(struct device *, struct device *, void *);
int	fwio_match(struct device *, void *, void *);

struct cfdriver fwio_cd = {
	NULL, "fwio", DV_DULL
};

const struct cfattach fwio_ca = {
	sizeof(struct fwio_softc), fwio_match, fwio_attach
};

int	fwio_print(void *, const char *);

int
fwio_match(struct device *parent, void *vcf, void *aux)
{
	struct mbus_attach_args *maa = (struct mbus_attach_args *)aux;

	if (maa->maa_class == CLASS_IO && maa->maa_interface == INTERFACE_FBIC)
		return 1;

	return 0;
}

void
fwio_attach(struct device *parent, struct device *self, void *aux)
{
	struct mbus_attach_args *maa = (struct mbus_attach_args *)aux;
	struct fwio_softc *sc = (struct fwio_softc *)self;
	struct fwio_attach_args faa;

	printf("\n");

	/*
	 * Save our mid in locators.  booted_sd() in autoconf.c depends
	 * on this to find the correct boot device.
	 */
	sc->sc_loc[0] = maa->maa_mid;
	self->dv_cfdata->cf_loc = sc->sc_loc;

	faa.faa_mid = maa->maa_mid;
	faa.faa_base = MBUS_SLOT_BASE(maa->maa_mid);
	faa.faa_vecbase = maa->maa_vecbase;

	faa.faa_dev = "dz";
	(void)config_found(self, &faa, fwio_print);

	faa.faa_dev = "le";
	(void)config_found(self, &faa, fwio_print);

	faa.faa_dev = "sii";
	(void)config_found(self, &faa, fwio_print);
}

int
fwio_print(void *aux, const char *pnp)
{
	struct fwio_attach_args *faa = (struct fwio_attach_args *)aux;

	if (pnp != NULL)
		printf("%s at %s", faa->faa_dev, pnp);

	return (UNCONF);
}
@


1.3
log
@Locators are long now.
@
text
@d1 1
a1 1
/*	$OpenBSD: fwio.c,v 1.2 2011/07/06 20:42:52 miod Exp $	*/
@


1.2
log
@These files no longer need to include <machine/nexus.h>
@
text
@d1 1
a1 1
/*	$OpenBSD: fwio.c,v 1.1 2008/08/18 23:19:25 miod Exp $	*/
d44 1
a44 1
	int		sc_loc[1];	/* locators override */
@


1.1
log
@Add support for the ``Firefox'' VAXstation 3520/3540/3820/3840 workstations,
currently limited to serial console and a single processor working.

All ``on-board'' devices, including the Q-bus adapter, but except for
the frame buffer, are supported. The machine will boot over the network
or from SCSI devices.

Lots of thanks to Al Kossow for www.bitsavers.org, on which I found the
technical documentation allowing me to complete this port (which was
lacking at the time I got that machine...).
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
a35 1
#include <machine/nexus.h>
@

