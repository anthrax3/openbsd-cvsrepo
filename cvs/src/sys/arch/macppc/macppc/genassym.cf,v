head	1.25;
access;
symbols
	OPENBSD_6_1:1.25.0.8
	OPENBSD_6_1_BASE:1.25
	OPENBSD_6_0:1.25.0.4
	OPENBSD_6_0_BASE:1.25
	OPENBSD_5_9:1.25.0.2
	OPENBSD_5_9_BASE:1.25
	OPENBSD_5_8:1.24.0.6
	OPENBSD_5_8_BASE:1.24
	OPENBSD_5_7:1.24.0.2
	OPENBSD_5_7_BASE:1.24
	OPENBSD_5_6:1.22.0.18
	OPENBSD_5_6_BASE:1.22
	OPENBSD_5_5:1.22.0.16
	OPENBSD_5_5_BASE:1.22
	OPENBSD_5_4:1.22.0.12
	OPENBSD_5_4_BASE:1.22
	OPENBSD_5_3:1.22.0.10
	OPENBSD_5_3_BASE:1.22
	OPENBSD_5_2:1.22.0.8
	OPENBSD_5_2_BASE:1.22
	OPENBSD_5_1_BASE:1.22
	OPENBSD_5_1:1.22.0.6
	OPENBSD_5_0:1.22.0.4
	OPENBSD_5_0_BASE:1.22
	OPENBSD_4_9:1.22.0.2
	OPENBSD_4_9_BASE:1.22
	OPENBSD_4_8:1.21.0.6
	OPENBSD_4_8_BASE:1.21
	OPENBSD_4_7:1.21.0.2
	OPENBSD_4_7_BASE:1.21
	OPENBSD_4_6:1.21.0.4
	OPENBSD_4_6_BASE:1.21
	OPENBSD_4_5:1.19.0.2
	OPENBSD_4_5_BASE:1.19
	OPENBSD_4_4:1.17.0.2
	OPENBSD_4_4_BASE:1.17
	OPENBSD_4_3:1.16.0.2
	OPENBSD_4_3_BASE:1.16
	OPENBSD_4_2:1.14.0.2
	OPENBSD_4_2_BASE:1.14
	OPENBSD_4_1:1.12.0.8
	OPENBSD_4_1_BASE:1.12
	OPENBSD_4_0:1.12.0.6
	OPENBSD_4_0_BASE:1.12
	OPENBSD_3_9:1.12.0.4
	OPENBSD_3_9_BASE:1.12
	OPENBSD_3_8:1.12.0.2
	OPENBSD_3_8_BASE:1.12
	OPENBSD_3_7:1.11.0.4
	OPENBSD_3_7_BASE:1.11
	OPENBSD_3_6:1.11.0.2
	OPENBSD_3_6_BASE:1.11
	SMP_SYNC_A:1.9
	SMP_SYNC_B:1.9
	OPENBSD_3_5:1.9.0.2
	OPENBSD_3_5_BASE:1.9
	OPENBSD_3_4:1.8.0.2
	OPENBSD_3_4_BASE:1.8
	UBC_SYNC_A:1.7
	OPENBSD_3_3:1.7.0.4
	OPENBSD_3_3_BASE:1.7
	OPENBSD_3_2:1.7.0.2
	OPENBSD_3_2_BASE:1.7
	OPENBSD_3_1:1.5.0.2
	OPENBSD_3_1_BASE:1.5
	UBC_SYNC_B:1.7
	UBC:1.4.0.2
	UBC_BASE:1.4
	SMP:1.3.0.4
	OPENBSD_3_0:1.3.0.2
	OPENBSD_3_0_BASE:1.3;
locks; strict;
comment	@# @;


1.25
date	2015.08.14.06.14.19;	author dlg;	state Exp;
branches;
next	1.24;
commitid	fjF8E1NC4JOIKQOD;

1.24
date	2014.09.06.10.45.29;	author mpi;	state Exp;
branches;
next	1.23;
commitid	psPuYzRRUiGpyp76;

1.23
date	2014.09.06.10.15.52;	author mpi;	state Exp;
branches;
next	1.22;
commitid	RzNS2F7j0UQHdMTX;

1.22
date	2010.09.28.20.27.55;	author miod;	state Exp;
branches;
next	1.21;

1.21
date	2009.06.09.01.12.38;	author deraadt;	state Exp;
branches;
next	1.20;

1.20
date	2009.06.02.21.38.09;	author drahn;	state Exp;
branches;
next	1.19;

1.19
date	2008.11.21.17.35.52;	author deraadt;	state Exp;
branches;
next	1.18;

1.18
date	2008.09.18.03.56.25;	author drahn;	state Exp;
branches;
next	1.17;

1.17
date	2008.04.27.15.59.49;	author drahn;	state Exp;
branches;
next	1.16;

1.16
date	2007.12.04.22.36.39;	author kettenis;	state Exp;
branches;
next	1.15;

1.15
date	2007.10.10.15.53.52;	author art;	state Exp;
branches;
next	1.14;

1.14
date	2007.03.22.19.26.28;	author kettenis;	state Exp;
branches;
next	1.13;

1.13
date	2007.03.20.20.59.54;	author kettenis;	state Exp;
branches;
next	1.12;

1.12
date	2005.08.02.21.02.48;	author drahn;	state Exp;
branches;
next	1.11;

1.11
date	2004.06.24.22.35.56;	author drahn;	state Exp;
branches;
next	1.10;

1.10
date	2004.06.13.21.49.18;	author niklas;	state Exp;
branches;
next	1.9;

1.9
date	2003.10.16.05.03.22;	author deraadt;	state Exp;
branches;
next	1.8;

1.8
date	2003.06.02.23.27.50;	author millert;	state Exp;
branches;
next	1.7;

1.7
date	2002.09.15.09.01.58;	author deraadt;	state Exp;
branches;
next	1.6;

1.6
date	2002.09.15.02.02.43;	author deraadt;	state Exp;
branches;
next	1.5;

1.5
date	2002.03.21.03.02.32;	author drahn;	state Exp;
branches;
next	1.4;

1.4
date	2001.11.06.19.53.15;	author miod;	state Exp;
branches
	1.4.2.1;
next	1.3;

1.3
date	2001.09.16.14.28.04;	author miod;	state Exp;
branches
	1.3.4.1;
next	1.2;

1.2
date	2001.09.11.20.05.24;	author miod;	state Exp;
branches;
next	1.1;

1.1
date	2001.09.01.15.57.06;	author drahn;	state Exp;
branches;
next	;

1.3.4.1
date	2001.10.31.03.01.16;	author nate;	state Exp;
branches;
next	1.3.4.2;

1.3.4.2
date	2001.11.13.21.00.53;	author niklas;	state Exp;
branches;
next	1.3.4.3;

1.3.4.3
date	2002.03.28.10.36.01;	author niklas;	state Exp;
branches;
next	1.3.4.4;

1.3.4.4
date	2003.06.07.11.13.14;	author ho;	state Exp;
branches;
next	1.3.4.5;

1.3.4.5
date	2004.02.19.10.49.03;	author niklas;	state Exp;
branches;
next	1.3.4.6;

1.3.4.6
date	2004.06.07.01.57.15;	author tedu;	state Exp;
branches;
next	;

1.4.2.1
date	2002.06.11.03.36.34;	author art;	state Exp;
branches;
next	1.4.2.2;

1.4.2.2
date	2002.10.29.00.28.06;	author art;	state Exp;
branches;
next	;


desc
@@


1.25
log
@replace the asm mutexes with a c implementation.

there's no real functional advantage to this, except that it will
make it easier to add deadlock detection to the code.

this is modelled on the c mutex implementation thats on alpha,
mips64, and hppa.

ok mpi@@ kettenis@@
@
text
@#	$OpenBSD: genassym.cf,v 1.24 2014/09/06 10:45:29 mpi Exp $
#
# Copyright (c) 1982, 1990 The Regents of the University of California.
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. Neither the name of the University nor the names of its contributors
#    may be used to endorse or promote products derived from this software
#    without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.
#
#	@@(#)genassym.c	7.8 (Berkeley) 5/7/91
#

include <sys/param.h>
include <sys/time.h>
include <sys/proc.h>
include <uvm/uvm_extern.h>

include <machine/pcb.h>
include <machine/pmap.h>
include <machine/cpu.h>
include <machine/mutex.h>

export	FRAMELEN
struct	trapframe	FRAME_
member	0		fixreg[0]
member	1		fixreg[1]
member	2		fixreg[2]
member	3		fixreg[3]
member	lr
member	cr
member	ctr
member	xer
member	srr0
member	srr1
member	dar
member	dsisr
member	exc

define	SFRAMELEN	roundup(sizeof(struct switchframe), 16)

struct	pcb
member	PCB_PMR		pcb_pmreal
member	pcb_sp
member	PCB_FAULT	pcb_onfault

struct	pmap
member	PM_SR		pm_sr[0]
member	PM_USRSR	pm_sr[PPC_USER_SR]
member	PM_KERNELSR	pm_sr[PPC_KERNEL_SR]

struct	proc
member	p_addr
member	p_stat
member	p_cpu
member  P_MD_ASTPENDING	p_md.md_astpending

struct	sigframe
member	sf_sc

struct fpsig

export	SONPROC

struct	cpu_info
member	ci_curproc
member	ci_curpcb
member	ci_curpm
member	ci_want_resched
member	ci_cpl
member	ci_flags
export	CI_FLAGS_SLEEPING
member	ci_intrdepth
member	ci_intstk
member	ci_tempsave
member	ci_ddbsave
member	ci_disisave
ifdef DIAGNOSTIC
member	ci_mutex_level
endif
@


1.24
log
@Rename ci_iactive into ci_flags, this field now holds the going-to-
sleep bit.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.23 2014/09/06 10:15:52 mpi Exp $
a99 5

struct	mutex
member	mtx_wantipl
member	mtx_oldcpl
member	mtx_owner
@


1.23
log
@Rewrite cpu_idle & friends to not check and update the hid0 register
in the idle loop, in preparation for G5 support.

Only do a disable/enable interrupt dance if the running CPU supports a
sleep mode.

Fix entering ddb(8) from interrupt context by not modifying the return
address of the 'forced' trap frame.

While here, modify the existing logic to terminate prefetching of all
data streams if AltiVec is supported before setting the POW bit.

With inputs/explanations from drahn, looks ok to miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.22 2010/09/28 20:27:55 miod Exp $
d90 2
a91 2
member	ci_iactive
export	CI_IACTIVE_SLEEPING
@


1.22
log
@Implement a per-cpu held mutex counter if DIAGNOSTIC on all non-x86 platforms,
to complete matthew@@'s commit of a few days ago, and drop __HAVE_CPU_MUTEX_LEVEL
define. With help from, and ok deraadt@@.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.21 2009/06/09 01:12:38 deraadt Exp $
d90 2
@


1.21
log
@backout interrupt diff until it the next round of fixes
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.19 2008/11/21 17:35:52 deraadt Exp $
d95 3
@


1.20
log
@Reintroduce the macppc interrupt subsystem rewrite. Several bugs have
been found and corrected.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.18 2008/09/18 03:56:25 drahn Exp $
d89 1
@


1.19
log
@back out the new interrupt subsystem because some little bug still lurks in there
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.17 2008/04/27 15:59:49 drahn Exp $
a88 1
member	ci_cpl
@


1.18
log
@Redesign of the powerpc interrupt architecture, use true levels intead of
blocking specific interrupts. Needs signficant testing to prove that
one remaining elusive bug has been squashed.
@
text
@d89 1
@


1.17
log
@Switch to proc based ast pending for SMP. ok kettenis.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.16 2007/12/04 22:36:39 kettenis Exp $
a88 1
member	ci_cpl
@


1.16
log
@Remove remains of the idle pcb/stack.

ok miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.15 2007/10/10 15:53:52 art Exp $
d75 1
a87 1
member	ci_astpending
@


1.15
log
@Make context switching much more MI:
 - Move the functionality of choosing a process from cpu_switch into
   a much simpler function: cpu_switchto. Instead of having the locore
   code walk the run queues, let the MI code choose the process we
   want to run and only implement the context switching itself in MD
   code.
 - Let MD context switching run without worrying about spls or locks.
 - Instead of having the idle loop implemented with special contexts
   in MD code, implement one idle proc for each cpu. make the idle
   loop MI with MD hooks.
 - Change the proc lists from the old style vax queues to TAILQs.
 - Change the sleep queue from vax queues to TAILQs. This makes
   wakeup() go from O(n^2) to O(n)

there will be some MD fallout, but it will be fixed shortly.
There's also a few cleanups to be done after this.

deraadt@@, kettenis@@ ok
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.14 2007/03/22 19:26:28 kettenis Exp $
a86 1
member	ci_idle_pcb
@


1.14
log
@Move powerpc to __HAVE_MUTEX.  With help from drahn@@.  Tested by nick@@, xsa@@,
deraadt@@.

"reads right" deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.13 2007/03/20 20:59:54 kettenis Exp $
a63 1
member	pcb_spl
a71 2
member	p_forw
member	p_back
@


1.13
log
@Move macppc to __HAVE_CPUINFO, and make locore.S and trap.c suitable for
MULTIPROCESSOR.  From now on sprg0 holds a pointer to struct cpuinfo, which
is used to spill registers to during trap instead of the globals we used to
use for that purpose.  Bits and pieces from NetBSD.  Help from drahn@@ and art@@.
Tested by xsa@@, thib@@, miod@@, gwk@@, deraadt@@.

ok drahn@@, gwk@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.12 2005/08/02 21:02:48 drahn Exp $
d41 1
d99 5
@


1.12
log
@Save floating point context on signals, looked at miod@@ is it in yet? deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.11 2004/06/24 22:35:56 drahn Exp $
d40 1
d76 1
d84 14
@


1.11
log
@Do a better job at containing powerpc specific #defines to PPC_...
ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.10 2004/06/13 21:49:18 niklas Exp $
d75 5
@


1.10
log
@debranch SMP, have fun
@
text
@d1 1
a1 1
#	$OpenBSD$
d67 2
a68 2
member	PM_USRSR	pm_sr[USER_SR]
member	PM_KERNELSR	pm_sr[KERNEL_SR]
@


1.9
log
@more white
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.8 2003/06/02 23:27:50 millert Exp $
d74 3
@


1.8
log
@Remove the advertising clause in the UCB license which Berkeley
rescinded 22 July 1999.  Proofed by myself and Theo.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.7 2002/09/15 09:01:58 deraadt Exp $
d38 1
a38 1
include <machine/pcb.h>               
@


1.7
log
@backout premature
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.5 2002/03/21 03:02:32 drahn Exp $
d14 1
a14 5
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#	This product includes software developed by the University of
#	California, Berkeley and its contributors.
# 4. Neither the name of the University nor the names of its contributors
@


1.6
log
@KNF
@
text
@d42 1
a42 1
include <machine/pcb.h>
@


1.5
log
@Map up to 1G 1-1 using dbats, this disables dynamically swapped bats for now,
until the issue with SR invalidation/loading is corrected.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.4 2001/11/06 19:53:15 miod Exp $
d42 1
a42 1
include <machine/pcb.h>               
@


1.4
log
@Replace inclusion of <vm/foo.h> with the correct <uvm/bar.h> when necessary.
(Look ma, I might have broken the tree)
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.3 2001/09/16 14:28:04 miod Exp $
d70 1
@


1.4.2.1
log
@Sync UBC branch to -current
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.4 2001/11/06 19:53:15 miod Exp $
a69 1
member	PM_SR		pm_sr[0]
@


1.4.2.2
log
@sync to -current
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.4.2.1 2002/06/11 03:36:34 art Exp $
@


1.3
log
@Make use of "export", "struct" and "member" keywords to be easier to read
and simpler.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.2 2001/09/11 20:05:24 miod Exp $
d40 1
a40 1
include <vm/vm.h>
@


1.3.4.1
log
@Sync the SMP branch to something just after 3.0
@
text
@d1 1
a1 1
#	$OpenBSD$
@


1.3.4.2
log
@Merge in -current
@
text
@d40 1
a40 1
include <uvm/uvm_extern.h>
@


1.3.4.3
log
@Merge in -current from about a week ago
@
text
@a69 1
member	PM_SR		pm_sr[0]
@


1.3.4.4
log
@Sync SMP branch to -current
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.3.4.3 2002/03/28 10:36:01 niklas Exp $
d14 5
a18 1
# 3. Neither the name of the University nor the names of its contributors
@


1.3.4.5
log
@Merge of current from two weeks agointo the SMP branch
@
text
@d1 1
a1 1
#	$OpenBSD$
d38 1
a38 1
include <machine/pcb.h>
@


1.3.4.6
log
@p_stat = SONPROC
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.3.4.5 2004/02/19 10:49:03 niklas Exp $
a73 3
member	p_stat

export	SONPROC
@


1.2
log
@Don't include <vm/vm_kern.h> if you don't need foo_map.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.1 2001/09/01 15:57:06 drahn Exp $
d45 15
a59 16


define	FRAMELEN	FRAMELEN
define	FRAME_0		offsetof(struct trapframe, fixreg[0])
define	FRAME_1		offsetof(struct trapframe, fixreg[1])
define	FRAME_2		offsetof(struct trapframe, fixreg[2])
define	FRAME_3		offsetof(struct trapframe, fixreg[3])
define	FRAME_LR	offsetof(struct trapframe, lr)
define	FRAME_CR	offsetof(struct trapframe, cr)
define	FRAME_CTR	offsetof(struct trapframe, ctr)
define	FRAME_XER	offsetof(struct trapframe, xer)
define	FRAME_SRR0	offsetof(struct trapframe, srr0)
define	FRAME_SRR1	offsetof(struct trapframe, srr1)
define	FRAME_DAR	offsetof(struct trapframe, dar)
define	FRAME_DSISR	offsetof(struct trapframe, dsisr)
define	FRAME_EXC	offsetof(struct trapframe, exc)
d63 14
a76 12
define	PCB_PMR		offsetof(struct pcb, pcb_pmreal)
define	PCB_SP		offsetof(struct pcb, pcb_sp)
define	PCB_SPL		offsetof(struct pcb, pcb_spl)
define	PCB_FAULT	offsetof(struct pcb, pcb_onfault)

define	PM_USRSR	offsetof(struct pmap, pm_sr[USER_SR])
define	PM_KERNELSR	offsetof(struct pmap, pm_sr[KERNEL_SR])

define	P_FORW		offsetof(struct proc, p_forw)
define	P_BACK		offsetof(struct proc, p_back)
define	P_ADDR		offsetof(struct proc, p_addr)

@


1.1
log
@The "powerpc" port which has supported the newer Apple Macintosh powerpc based
is being renamed to macppc. This is to allow sharing of common code
between different powerpc base platforms.

Most of the work involved in the renaming process was performed by miod@@

Files moved from powerpc/powerpc to macppc/macppc.
These files were missed in the original move of this directory.
@
text
@d1 1
a1 1
#	$OpenBSD: genassym.cf,v 1.2 1997/10/13 13:42:57 pefo Exp $
a40 1
include <vm/vm_kern.h>
a41 1
 
@

