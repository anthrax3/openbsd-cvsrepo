head	1.14;
access;
symbols
	OPENBSD_6_1:1.14.0.14
	OPENBSD_6_1_BASE:1.14
	OPENBSD_6_0:1.14.0.12
	OPENBSD_6_0_BASE:1.14
	OPENBSD_5_9:1.14.0.8
	OPENBSD_5_9_BASE:1.14
	OPENBSD_5_8:1.14.0.10
	OPENBSD_5_8_BASE:1.14
	OPENBSD_5_7:1.14.0.2
	OPENBSD_5_7_BASE:1.14
	OPENBSD_5_6:1.14.0.6
	OPENBSD_5_6_BASE:1.14
	OPENBSD_5_5:1.14.0.4
	OPENBSD_5_5_BASE:1.14
	OPENBSD_5_4:1.12.0.2
	OPENBSD_5_4_BASE:1.12
	OPENBSD_5_3:1.11.0.2
	OPENBSD_5_3_BASE:1.11
	OPENBSD_5_2:1.10.0.6
	OPENBSD_5_2_BASE:1.10
	OPENBSD_5_1_BASE:1.10
	OPENBSD_5_1:1.10.0.4
	OPENBSD_5_0:1.10.0.2
	OPENBSD_5_0_BASE:1.10
	OPENBSD_4_9:1.9.0.22
	OPENBSD_4_9_BASE:1.9
	OPENBSD_4_8:1.9.0.20
	OPENBSD_4_8_BASE:1.9
	OPENBSD_4_7:1.9.0.16
	OPENBSD_4_7_BASE:1.9
	OPENBSD_4_6:1.9.0.18
	OPENBSD_4_6_BASE:1.9
	OPENBSD_4_5:1.9.0.14
	OPENBSD_4_5_BASE:1.9
	OPENBSD_4_4:1.9.0.12
	OPENBSD_4_4_BASE:1.9
	OPENBSD_4_3:1.9.0.10
	OPENBSD_4_3_BASE:1.9
	OPENBSD_4_2:1.9.0.8
	OPENBSD_4_2_BASE:1.9
	OPENBSD_4_1:1.9.0.6
	OPENBSD_4_1_BASE:1.9
	OPENBSD_4_0:1.9.0.4
	OPENBSD_4_0_BASE:1.9
	OPENBSD_3_9:1.9.0.2
	OPENBSD_3_9_BASE:1.9
	OPENBSD_3_8:1.7.0.14
	OPENBSD_3_8_BASE:1.7
	OPENBSD_3_7:1.7.0.12
	OPENBSD_3_7_BASE:1.7
	OPENBSD_3_6:1.7.0.10
	OPENBSD_3_6_BASE:1.7
	SMP_SYNC_A:1.7
	SMP_SYNC_B:1.7
	OPENBSD_3_5:1.7.0.8
	OPENBSD_3_5_BASE:1.7
	OPENBSD_3_4:1.7.0.6
	OPENBSD_3_4_BASE:1.7
	UBC_SYNC_A:1.7
	OPENBSD_3_3:1.7.0.4
	OPENBSD_3_3_BASE:1.7
	OPENBSD_3_2:1.7.0.2
	OPENBSD_3_2_BASE:1.7
	OPENBSD_3_1:1.4.0.2
	OPENBSD_3_1_BASE:1.4
	UBC_SYNC_B:1.7
	UBC:1.2.0.2
	UBC_BASE:1.2
	SMP:1.1.0.4
	OPENBSD_3_0:1.1.0.2
	OPENBSD_3_0_BASE:1.1;
locks; strict;
comment	@ * @;


1.14
date	2013.10.09.17.43.50;	author mpi;	state Exp;
branches;
next	1.13;

1.13
date	2013.09.13.07.29.02;	author mpi;	state Exp;
branches;
next	1.12;

1.12
date	2013.03.17.15.10.33;	author kettenis;	state Exp;
branches;
next	1.11;

1.11
date	2012.12.08.12.51.34;	author mpi;	state Exp;
branches;
next	1.10;

1.10
date	2011.05.25.07.42.15;	author mpi;	state Exp;
branches;
next	1.9;

1.9
date	2005.12.09.22.54.15;	author kettenis;	state Exp;
branches;
next	1.8;

1.8
date	2005.10.09.14.17.32;	author drahn;	state Exp;
branches;
next	1.7;

1.7
date	2002.09.15.09.01.58;	author deraadt;	state Exp;
branches;
next	1.6;

1.6
date	2002.09.15.02.02.43;	author deraadt;	state Exp;
branches;
next	1.5;

1.5
date	2002.06.08.15.45.29;	author miod;	state Exp;
branches;
next	1.4;

1.4
date	2002.02.23.16.59.36;	author matthieu;	state Exp;
branches;
next	1.3;

1.3
date	2002.01.07.05.03.23;	author drahn;	state Exp;
branches;
next	1.2;

1.2
date	2001.11.06.18.41.10;	author art;	state Exp;
branches
	1.2.2.1;
next	1.1;

1.1
date	2001.09.01.15.49.06;	author drahn;	state Exp;
branches
	1.1.4.1;
next	;

1.1.4.1
date	2001.10.31.03.01.15;	author nate;	state Exp;
branches;
next	1.1.4.2;

1.1.4.2
date	2001.11.13.21.00.53;	author niklas;	state Exp;
branches;
next	1.1.4.3;

1.1.4.3
date	2002.03.06.01.06.11;	author niklas;	state Exp;
branches;
next	1.1.4.4;

1.1.4.4
date	2003.03.27.23.29.46;	author niklas;	state Exp;
branches;
next	;

1.2.2.1
date	2002.01.31.22.55.14;	author niklas;	state Exp;
branches;
next	1.2.2.2;

1.2.2.2
date	2002.06.11.03.36.34;	author art;	state Exp;
branches;
next	1.2.2.3;

1.2.2.3
date	2002.10.29.00.28.06;	author art;	state Exp;
branches;
next	;


desc
@@


1.14
log
@Initialize ns_per_tick as soon as we have read the timebase from the
device-tree to restore the behaviour present before my last change.

This fixes a regression seen on some Powerbooks where one of the two
kiic(4) would always timeout when trying to configure the audio chip.
@
text
@/*	$OpenBSD: cpu.h,v 1.13 2013/09/13 07:29:02 mpi Exp $	*/
/*	$NetBSD: cpu.h,v 1.1 1996/09/30 16:34:21 ws Exp $	*/

/*
 * Copyright (C) 1995, 1996 Wolfgang Solfrank.
 * Copyright (C) 1995, 1996 TooLs GmbH.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by TooLs GmbH.
 * 4. The name of TooLs GmbH may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY TOOLS GMBH ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL TOOLS GMBH BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
 * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
#ifndef	_MACHINE_CPU_H_
#define	_MACHINE_CPU_H_

/* 
 * CTL_MACHDEP definitions.
 */
#define CPU_ALLOWAPERTURE	1	/* allow mmap of /dev/xf86 */
#define CPU_ALTIVEC		2	/* altivec is present */
#define CPU_MAXID		3	/* number of valid machdep ids */

#define	CTL_MACHDEP_NAMES { \
	{ 0, 0 }, \
	{ "allowaperture", CTLTYPE_INT }, \
	{ "altivec", CTLTYPE_INT }, \
}

#ifdef _KERNEL

#include <powerpc/cpu.h>

/* Frequency scaling */
#define FREQ_FULL	0
#define FREQ_HALF	1
#define FREQ_QUARTER	2	/* Supported only on IBM 970MP */

extern u_int32_t	ppc_curfreq;
extern u_int32_t	ppc_maxfreq;
extern int		ppc_altivec;

extern void (*ppc64_slew_voltage)(u_int);

extern u_int32_t	ticks_per_sec;
extern u_int32_t 	ns_per_tick;

#endif /* _KERNEL */
#endif /* _MACHINE_CPU_H_ */
@


1.13
log
@Initialize the variable guarding the clock interrupt routine after
calling initclocks().  This prevents hardclock() from trying to
schedule a softclock interrupt before its cookie has been allocated,
leading to a panic.

While here grab the ticks/second value from the OpenFirmware at the
same time we read the clock frequency, no need to look twice for the
same node.

Looks ok to kettenis@@
@
text
@d1 1
a1 1
/*	$OpenBSD: cpu.h,v 1.12 2013/03/17 15:10:33 kettenis Exp $	*/
d66 1
@


1.12
log
@Avoid namespace pollution from <powerpc/cpu.h>.

ok mpi@@, deraadt@@, miod@@, millert@@
@
text
@d1 1
a1 1
/*	$OpenBSD: cpu.h,v 1.11 2012/12/08 12:51:34 mpi Exp $	*/
d64 2
@


1.11
log
@Fix a comment now that PowerPC 970 are recognized, make it clear that
changing the frequency to a quarter mode is only supported by 970MP.
@
text
@d1 1
a1 1
/*	$OpenBSD: cpu.h,v 1.10 2011/05/25 07:42:15 mpi Exp $	*/
a36 2
#include <powerpc/cpu.h>

d50 4
d65 2
a66 1
#endif	/* _MACHINE_CPU_H_ */
@


1.10
log
@Add dfs(4), a driver to support the Dynamic Frequency Switching feature
found on some G4 PowerBook.

Tested by many, thanks.

ok sthen@@, kettenis@@, miod@@
@
text
@d1 1
a1 1
/*	$OpenBSD: cpu.h,v 1.9 2005/12/09 22:54:15 kettenis Exp $	*/
d55 1
a55 1
#define FREQ_QUARTER	2	/* Not supported on IBM 970FX */
@


1.9
log
@Add hook for voltage slewing the G5.
"figure you should just commit" drahn@@
@
text
@d1 1
a1 1
/*	$OpenBSD: cpu.h,v 1.8 2005/10/09 14:17:32 drahn Exp $	*/
d52 8
a59 1
extern int ppc_altivec;
@


1.8
log
@Provide a machdep sysctl to determine if altivec is avaliable on macppc
@
text
@d1 1
a1 1
/*	$OpenBSD: cpu.h,v 1.7 2002/09/15 09:01:58 deraadt Exp $	*/
d53 2
@


1.7
log
@backout premature
@
text
@d1 1
a1 1
/*	$OpenBSD: cpu.h,v 1.5 2002/06/08 15:45:29 miod Exp $	*/
d43 2
a44 1
#define	CPU_MAXID		2	/* number of valid machdep ids */
d49 1
d51 2
@


1.6
log
@KNF
@
text
@d39 1
a39 1
/*
@


1.5
log
@Factorize common parts (cache-related stuff).
ok drahn@@
@
text
@d1 1
a1 1
/*	$OpenBSD: cpu.h,v 1.4 2002/02/23 16:59:36 matthieu Exp $	*/
d39 1
a39 1
/* 
@


1.4
log
@Add aperture driver support for macppc, and also place writing to /dev/pci
under the control of machdep.allowaperture.
This allows to run the X server on macppc with securelevel=1, given that
machdep.allowaperture is != 0.
OK deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: cpu.h,v 1.3 2002/01/07 05:03:23 drahn Exp $	*/
a38 24
#define	CACHELINESIZE	32			/* For now		XXX */

static __inline void
syncicache(void *from, int len)
{
	int l;
	char *p = from;
	len = len + (((u_int32_t) from) & (CACHELINESIZE-1));
	l = len;
	
	do {
		__asm__ __volatile__ ("dcbst 0,%0" :: "r"(p));
		p += CACHELINESIZE;
	} while ((l -= CACHELINESIZE) > 0);
	__asm__ __volatile__ ("sync");
	p = from;
	l = len;
	do {
		__asm__ __volatile__ ("icbi 0,%0" :: "r"(p));
		p += CACHELINESIZE;
	} while ((l -= CACHELINESIZE) > 0);
	__asm__ __volatile__ ("isync");
}

a44 1

d49 1
@


1.3
log
@On cache flushing, if start is not cacheline aligned, add to the lenght
to make sure the whole region is flushed. from conversation with pefo.
@
text
@d1 1
a1 1
/*	$OpenBSD: cpu.h,v 1.2 2001/11/06 18:41:10 art Exp $	*/
d63 11
@


1.2
log
@Let fork1, uvm_fork, and cpu_fork take a function/argument pair as argument,
instead of doing fork1, cpu_set_kpc. This lets us retire cpu_set_kpc and
avoid a multiprocessor race.

This commit breaks vax because it doesn't look like any other arch, someone
working on vax might want to look at this and try to adapt the code to be
more like the rest of the world.

Idea and uvm parts from NetBSD.
@
text
@d1 1
a1 1
/*	$OpenBSD: cpu.h,v 1.1 2001/09/01 15:49:06 drahn Exp $	*/
d44 1
a44 1
	int l = len;
d46 2
@


1.2.2.1
log
@Merge in -current, builds on i386, otherwise untested
@
text
@d1 1
a1 1
/*	$OpenBSD: cpu.h,v 1.3 2002/01/07 05:03:23 drahn Exp $	*/
d44 1
a44 1
	int l;
a45 2
	len = len + (((u_int32_t) from) & (CACHELINESIZE-1));
	l = len;
@


1.2.2.2
log
@Sync UBC branch to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: cpu.h,v 1.2.2.1 2002/01/31 22:55:14 niklas Exp $	*/
d39 1
a39 5
/* 
 * CTL_MACHDEP definitions.
 */
#define CPU_ALLOWAPERTURE	1	/* allow mmap of /dev/xf86 */
#define	CPU_MAXID		2	/* number of valid machdep ids */
d41 20
a60 3
#define	CTL_MACHDEP_NAMES { \
	{ 0, 0 }, \
	{ "allowaperture", CTLTYPE_INT }, \
@


1.2.2.3
log
@sync to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: cpu.h,v 1.2.2.2 2002/06/11 03:36:34 art Exp $	*/
@


1.1
log
@The "powerpc" port which has supported the newer Apple Macintosh powerpc based
is being renamed to macppc. This is to allow sharing of common code
between different powerpc base platforms.

Most of the work involved in the renaming process was performed by miod@@

Files moved from powerpc/include to macppc/include
Some files were not "moved" but wrapper files were created which include
the powerpc/include version.

Several of the powerpc/include files where changed to reflect that they
are POWERPC_* not MACHINE_*.
@
text
@d1 1
a1 1
/*	$OpenBSD: cpu.h,v 1.7 2001/07/09 01:35:32 mickey Exp $	*/
a37 2

void	child_return __P((struct proc *));
@


1.1.4.1
log
@Sync the SMP branch to something just after 3.0
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
@


1.1.4.2
log
@Merge in -current
@
text
@d39 2
@


1.1.4.3
log
@Merge in trunk
@
text
@d44 1
a44 1
	int l;
a45 2
	len = len + (((u_int32_t) from) & (CACHELINESIZE-1));
	l = len;
a60 11
/* 
 * CTL_MACHDEP definitions.
 */
#define CPU_ALLOWAPERTURE	1	/* allow mmap of /dev/xf86 */
#define	CPU_MAXID		2	/* number of valid machdep ids */


#define	CTL_MACHDEP_NAMES { \
	{ 0, 0 }, \
	{ "allowaperture", CTLTYPE_INT }, \
}
@


1.1.4.4
log
@Sync the SMP branch with 3.3
@
text
@d39 24
d69 1
a73 1

@


