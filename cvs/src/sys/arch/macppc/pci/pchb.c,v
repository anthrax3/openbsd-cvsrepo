head	1.14;
access;
symbols
	OPENBSD_6_1:1.14.0.12
	OPENBSD_6_1_BASE:1.14
	OPENBSD_6_0:1.14.0.10
	OPENBSD_6_0_BASE:1.14
	OPENBSD_5_9:1.14.0.6
	OPENBSD_5_9_BASE:1.14
	OPENBSD_5_8:1.14.0.8
	OPENBSD_5_8_BASE:1.14
	OPENBSD_5_7:1.14.0.2
	OPENBSD_5_7_BASE:1.14
	OPENBSD_5_6:1.14.0.4
	OPENBSD_5_6_BASE:1.14
	OPENBSD_5_5:1.13.0.8
	OPENBSD_5_5_BASE:1.13
	OPENBSD_5_4:1.13.0.4
	OPENBSD_5_4_BASE:1.13
	OPENBSD_5_3:1.13.0.2
	OPENBSD_5_3_BASE:1.13
	OPENBSD_5_2:1.11.0.18
	OPENBSD_5_2_BASE:1.11
	OPENBSD_5_1_BASE:1.11
	OPENBSD_5_1:1.11.0.16
	OPENBSD_5_0:1.11.0.14
	OPENBSD_5_0_BASE:1.11
	OPENBSD_4_9:1.11.0.12
	OPENBSD_4_9_BASE:1.11
	OPENBSD_4_8:1.11.0.10
	OPENBSD_4_8_BASE:1.11
	OPENBSD_4_7:1.11.0.6
	OPENBSD_4_7_BASE:1.11
	OPENBSD_4_6:1.11.0.8
	OPENBSD_4_6_BASE:1.11
	OPENBSD_4_5:1.11.0.4
	OPENBSD_4_5_BASE:1.11
	OPENBSD_4_4:1.11.0.2
	OPENBSD_4_4_BASE:1.11
	OPENBSD_4_3:1.10.0.8
	OPENBSD_4_3_BASE:1.10
	OPENBSD_4_2:1.10.0.6
	OPENBSD_4_2_BASE:1.10
	OPENBSD_4_1:1.10.0.4
	OPENBSD_4_1_BASE:1.10
	OPENBSD_4_0:1.10.0.2
	OPENBSD_4_0_BASE:1.10
	OPENBSD_3_9:1.8.0.2
	OPENBSD_3_9_BASE:1.8
	OPENBSD_3_8:1.6.0.8
	OPENBSD_3_8_BASE:1.6
	OPENBSD_3_7:1.6.0.6
	OPENBSD_3_7_BASE:1.6
	OPENBSD_3_6:1.6.0.4
	OPENBSD_3_6_BASE:1.6
	SMP_SYNC_A:1.6
	SMP_SYNC_B:1.6
	OPENBSD_3_5:1.6.0.2
	OPENBSD_3_5_BASE:1.6
	OPENBSD_3_4:1.5.0.2
	OPENBSD_3_4_BASE:1.5
	UBC_SYNC_A:1.5
	OPENBSD_3_3:1.4.0.4
	OPENBSD_3_3_BASE:1.4
	OPENBSD_3_2:1.4.0.2
	OPENBSD_3_2_BASE:1.4
	OPENBSD_3_1:1.3.0.2
	OPENBSD_3_1_BASE:1.3
	UBC_SYNC_B:1.4
	UBC:1.2.0.2
	UBC_BASE:1.2
	SMP:1.1.0.4
	OPENBSD_3_0:1.1.0.2
	OPENBSD_3_0_BASE:1.1;
locks; strict;
comment	@ * @;


1.14
date	2014.03.26.14.41.41;	author mpi;	state Exp;
branches;
next	1.13;

1.13
date	2012.12.22.19.07.50;	author mpi;	state Exp;
branches;
next	1.12;

1.12
date	2012.12.04.10.42.05;	author mpi;	state Exp;
branches;
next	1.11;

1.11
date	2008.06.26.05.42.12;	author ray;	state Exp;
branches;
next	1.10;

1.10
date	2006.04.10.22.14.12;	author deraadt;	state Exp;
branches;
next	1.9;

1.9
date	2006.04.10.08.34.22;	author brad;	state Exp;
branches;
next	1.8;

1.8
date	2005.10.02.22.09.40;	author brad;	state Exp;
branches;
next	1.7;

1.7
date	2005.09.29.20.11.13;	author kettenis;	state Exp;
branches;
next	1.6;

1.6
date	2003.10.15.23.00.57;	author drahn;	state Exp;
branches;
next	1.5;

1.5
date	2003.04.27.11.22.52;	author ho;	state Exp;
branches;
next	1.4;

1.4
date	2002.07.29.19.55.56;	author drahn;	state Exp;
branches;
next	1.3;

1.3
date	2002.03.14.01.26.37;	author millert;	state Exp;
branches;
next	1.2;

1.2
date	2001.12.18.17.33.34;	author drahn;	state Exp;
branches
	1.2.2.1;
next	1.1;

1.1
date	2001.09.01.15.55.17;	author drahn;	state Exp;
branches
	1.1.4.1;
next	;

1.1.4.1
date	2001.10.31.03.01.16;	author nate;	state Exp;
branches;
next	1.1.4.2;

1.1.4.2
date	2002.03.06.01.06.11;	author niklas;	state Exp;
branches;
next	1.1.4.3;

1.1.4.3
date	2002.03.28.10.36.01;	author niklas;	state Exp;
branches;
next	1.1.4.4;

1.1.4.4
date	2003.03.27.23.29.46;	author niklas;	state Exp;
branches;
next	1.1.4.5;

1.1.4.5
date	2003.05.13.19.41.06;	author ho;	state Exp;
branches;
next	1.1.4.6;

1.1.4.6
date	2004.02.19.10.49.04;	author niklas;	state Exp;
branches;
next	;

1.2.2.1
date	2002.06.11.03.36.34;	author art;	state Exp;
branches;
next	1.2.2.2;

1.2.2.2
date	2002.10.29.00.28.06;	author art;	state Exp;
branches;
next	1.2.2.3;

1.2.2.3
date	2003.05.19.21.49.43;	author tedu;	state Exp;
branches;
next	;


desc
@@


1.14
log
@No need to include <sys/lock.h> when only <sys/rwlock.h> is needed,
so remove the former and include the latter instead of pulling it
in <dev/pci/agpvar.h>.  This header already requires various other
types anyway.  While here remove unneeded headers.
@
text
@/*	$OpenBSD: pchb.c,v 1.13 2012/12/22 19:07:50 mpi Exp $	*/
/*	$NetBSD: pchb.c,v 1.4 2000/01/25 07:19:11 tsubai Exp $	*/

/*-
 * Copyright (c) 1996 The NetBSD Foundation, Inc.
 * All rights reserved.
 *
 * This code is derived from software contributed to The NetBSD Foundation
 * by Jason R. Thorpe.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS
 * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
 * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */

#include <sys/types.h>
#include <sys/param.h>
#include <sys/systm.h>
#include <sys/device.h>
#include <sys/rwlock.h>

#include <machine/bus.h>

#include <dev/pci/pcivar.h>
#include <dev/pci/pcireg.h>
#include <dev/pci/pcidevs.h>

#include <dev/pci/agpvar.h>

#include "agp.h"

int	pchbmatch(struct device *, void *, void *);
void	pchbattach(struct device *, struct device *, void *);

struct cfattach pchb_ca = {
	sizeof(struct device), pchbmatch, pchbattach
};

struct cfdriver pchb_cd = {
	NULL, "pchb", DV_DULL
};

int
pchbmatch(struct device *parent, void *cf, void *aux)
{
	struct pci_attach_args *pa = aux;

	/*
	 * Match all known PCI host chipsets.
	 */
	switch (PCI_VENDOR(pa->pa_id)) {
	case PCI_VENDOR_APPLE:
		switch (PCI_PRODUCT(pa->pa_id)) {
		case PCI_PRODUCT_APPLE_BANDIT:
		case PCI_PRODUCT_APPLE_UNINORTH:
		case PCI_PRODUCT_APPLE_UNINORTHETH:
		case PCI_PRODUCT_APPLE_UNINORTH_AGP:
		case PCI_PRODUCT_APPLE_PANGEA:
		case PCI_PRODUCT_APPLE_PANGEA_PCI:
		case PCI_PRODUCT_APPLE_PANGEA_AGP:
		case PCI_PRODUCT_APPLE_UNINORTH2:
		case PCI_PRODUCT_APPLE_UNINORTH2ETH:
		case PCI_PRODUCT_APPLE_UNINORTH2_AGP:
		case PCI_PRODUCT_APPLE_UNINORTH_AGP3:
		case PCI_PRODUCT_APPLE_UNINORTH5:
		case PCI_PRODUCT_APPLE_UNINORTH6:
		case PCI_PRODUCT_APPLE_SHASTA_HT:
		case PCI_PRODUCT_APPLE_K2:
		case PCI_PRODUCT_APPLE_INTREPID2_AGP:
		case PCI_PRODUCT_APPLE_INTREPID2_PCI1:
		case PCI_PRODUCT_APPLE_INTREPID2_PCI2:
		case PCI_PRODUCT_APPLE_U3_AGP:
		case PCI_PRODUCT_APPLE_U3L_AGP:
		case PCI_PRODUCT_APPLE_K2_AGP:
			return (1);
		}
		break;

	case PCI_VENDOR_MOT:
		switch (PCI_PRODUCT(pa->pa_id)) {
		case PCI_PRODUCT_MOT_MPC106:
			return (1);
		}
		break;
	}

	return (0);
}

/*ARGSUSED*/
void
pchbattach(struct device *parent, struct device  *self, void *aux)
{
#if NAGP > 0
	struct pci_attach_args *pa = aux;
#endif /* NAGP > 0 */

	printf("\n");

#if NAGP > 0
	if (pci_get_capability(pa->pa_pc, pa->pa_tag, PCI_CAP_AGP,
	    NULL, NULL) != 0) {
		struct agp_attach_args	aa;
		aa.aa_busname = "agp";
		aa.aa_pa = pa;

		config_found(self, &aa, agpdev_print);
	}
#endif /* NAGP > 0 */
}
@


1.13
log
@Attach all known U3 AGP bridges
@
text
@d1 1
a1 1
/*	$OpenBSD: pchb.c,v 1.12 2012/12/04 10:42:05 mpi Exp $	*/
d37 1
@


1.12
log
@Add support for Uninorth AGP bridges found in most if not all the macppc
machines with a G3 or G4 microprocessor. It would not be difficult to add
support for U3 bridges found in G5 powered macppc to this driver but I
don't have such hardware.
@
text
@d1 1
a1 1
/*	$OpenBSD: pchb.c,v 1.11 2008/06/26 05:42:12 ray Exp $	*/
a84 1
		case PCI_PRODUCT_APPLE_K2_AGP:
d88 3
@


1.11
log
@First pass at removing clauses 3 and 4 from NetBSD licenses.

Not sure what's more surprising: how long it took for NetBSD to
catch up to the rest of the BSDs (including UCB), or the amount of
code that NetBSD has claimed for itself without attributing to the
actual authors.

OK deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: pchb.c,v 1.10 2006/04/10 22:14:12 deraadt Exp $	*/
d44 4
d108 4
d114 6
a119 5
	/*
	 * All we do is print out a description.  Eventually, we
	 * might want to add code that does something that's
	 * possibly chipset-specific.
	 */
d121 3
a123 5
	/*
	pci_devinfo(pa->pa_id, pa->pa_class, 0, devinfo, sizeof devinfo);
	printf("%s: %s (rev. 0x%02x)\n", self->dv_xname, devinfo,
	    PCI_REVISION(pa->pa_class));
	*/
@


1.10
log
@typo by brad
@
text
@d1 1
a1 1
/*	$OpenBSD: pchb.c,v 1.9 2006/04/10 08:34:22 brad Exp $	*/
a18 7
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *        This product includes software developed by the NetBSD
 *        Foundation, Inc. and its contributors.
 * 4. Neither the name of The NetBSD Foundation nor the names of its
 *    contributors may be used to endorse or promote products derived
 *    from this software without specific prior written permission.
@


1.9
log
@Intrepid 2 host bridges.
@
text
@d1 1
a1 1
/*	$OpenBSD: pchb.c,v 1.8 2005/10/02 22:09:40 brad Exp $	*/
d91 1
a91 1
		case PCI_PRODUCT_APPLE_INTREPID2_PCI1:
@


1.8
log
@a little bit more consistent naming scheme for Apple devices and add
missing K2 host bridge and AGP bridge PCI ids.

ok drahn@@
@
text
@d1 1
a1 1
/*	$OpenBSD: pchb.c,v 1.7 2005/09/29 20:11:13 kettenis Exp $	*/
d89 3
@


1.7
log
@Add Shasta HyperTransport.
ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: pchb.c,v 1.6 2003/10/15 23:00:57 drahn Exp $	*/
d76 3
a78 3
		case PCI_PRODUCT_APPLE_UNINORTHAGP:
		case PCI_PRODUCT_APPLE_PANGEA_PCI1:
		case PCI_PRODUCT_APPLE_PANGEA_PCI2:
d82 1
a82 1
		case PCI_PRODUCT_APPLE_UNINORTH2AGP:
d87 2
@


1.6
log
@Further down the ANSI/KNF road, only binary difference is __LINE__.
@
text
@d1 1
a1 1
/*	$OpenBSD: pchb.c,v 1.5 2003/04/27 11:22:52 ho Exp $	*/
d86 1
@


1.5
log
@strcpy/sprintf cleanup of sys/dev. miod@@, deraadt@@ says to commit.
@
text
@d1 1
a1 1
/*	$OpenBSD: pchb.c,v 1.4 2002/07/29 19:55:56 drahn Exp $	*/
d63 1
a63 4
pchbmatch(parent, cf, aux)
	struct device *parent;
	void *cf;
	void *aux;
d103 1
a103 3
pchbattach(parent, self, aux)
	struct device *parent, *self;
	void *aux;
a104 1

@


1.4
log
@Recognize additional host bridges, pretty printing only, no function diff.
@
text
@d1 1
a1 1
/*	$OpenBSD: pchb.c,v 1.3 2002/03/14 01:26:37 millert Exp $	*/
d120 1
a120 1
	pci_devinfo(pa->pa_id, pa->pa_class, 0, devinfo);
@


1.3
log
@First round of __P removal in sys
@
text
@d1 1
a1 1
/*	$OpenBSD: pchb.c,v 1.2 2001/12/18 17:33:34 drahn Exp $	*/
d86 3
@


1.2
log
@Recognize newer uni-n chips.
@
text
@d1 1
a1 1
/*	$OpenBSD: pchb.c,v 1.1 2001/09/01 15:55:17 drahn Exp $	*/
d51 2
a52 2
int	pchbmatch __P((struct device *, void *, void *));
void	pchbattach __P((struct device *, struct device *, void *));
@


1.2.2.1
log
@Sync UBC branch to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: pchb.c,v 1.2 2001/12/18 17:33:34 drahn Exp $	*/
d51 2
a52 2
int	pchbmatch(struct device *, void *, void *);
void	pchbattach(struct device *, struct device *, void *);
@


1.2.2.2
log
@sync to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: pchb.c,v 1.2.2.1 2002/06/11 03:36:34 art Exp $	*/
a85 3
		case PCI_PRODUCT_APPLE_UNINORTH_AGP3:
		case PCI_PRODUCT_APPLE_UNINORTH5:
		case PCI_PRODUCT_APPLE_UNINORTH6:
@


1.2.2.3
log
@sync
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d120 1
a120 1
	pci_devinfo(pa->pa_id, pa->pa_class, 0, devinfo, sizeof devinfo);
@


1.1
log
@The "powerpc" port which has supported the newer Apple Macintosh powerpc based
is being renamed to macppc. This is to allow sharing of common code
between different powerpc base platforms.

Most of the work involved in the renaming process was performed by miod@@

Files moved from powerpc/pci to macppc/pci

The file pci_machdep.h was not moved in this conversion.
It needs to be check if it is correct that should be the only shared
powerpc/pci file. Or if that file too should be MD, or more files MI.
@
text
@d1 1
a1 1
/*	$OpenBSD: pchb.c,v 1.5 2001/07/04 08:38:52 niklas Exp $	*/
d83 3
@


1.1.4.1
log
@Sync the SMP branch to something just after 3.0
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
@


1.1.4.2
log
@Merge in trunk
@
text
@a82 3
		case PCI_PRODUCT_APPLE_UNINORTH2:
		case PCI_PRODUCT_APPLE_UNINORTH2ETH:
		case PCI_PRODUCT_APPLE_UNINORTH2AGP:
@


1.1.4.3
log
@Merge in -current from about a week ago
@
text
@d51 2
a52 2
int	pchbmatch(struct device *, void *, void *);
void	pchbattach(struct device *, struct device *, void *);
@


1.1.4.4
log
@Sync the SMP branch with 3.3
@
text
@a85 3
		case PCI_PRODUCT_APPLE_UNINORTH_AGP3:
		case PCI_PRODUCT_APPLE_UNINORTH5:
		case PCI_PRODUCT_APPLE_UNINORTH6:
@


1.1.4.5
log
@Sync the SMP branch to -current.
@
text
@d1 1
a1 1
/*	$OpenBSD: pchb.c,v 1.1.4.4 2003/03/27 23:29:46 niklas Exp $	*/
d120 1
a120 1
	pci_devinfo(pa->pa_id, pa->pa_class, 0, devinfo, sizeof devinfo);
@


1.1.4.6
log
@Merge of current from two weeks agointo the SMP branch
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d63 4
a66 1
pchbmatch(struct device *parent, void *cf, void *aux)
d106 3
a108 1
pchbattach(struct device *parent, struct device  *self, void *aux)
d110 1
@


