head	1.9;
access;
symbols
	OPENBSD_5_5:1.8.0.8
	OPENBSD_5_5_BASE:1.8
	OPENBSD_5_4:1.8.0.4
	OPENBSD_5_4_BASE:1.8
	OPENBSD_5_3:1.8.0.2
	OPENBSD_5_3_BASE:1.8
	OPENBSD_5_2:1.7.0.48
	OPENBSD_5_2_BASE:1.7
	OPENBSD_5_1_BASE:1.7
	OPENBSD_5_1:1.7.0.46
	OPENBSD_5_0:1.7.0.44
	OPENBSD_5_0_BASE:1.7
	OPENBSD_4_9:1.7.0.42
	OPENBSD_4_9_BASE:1.7
	OPENBSD_4_8:1.7.0.40
	OPENBSD_4_8_BASE:1.7
	OPENBSD_4_7:1.7.0.36
	OPENBSD_4_7_BASE:1.7
	OPENBSD_4_6:1.7.0.38
	OPENBSD_4_6_BASE:1.7
	OPENBSD_4_5:1.7.0.34
	OPENBSD_4_5_BASE:1.7
	OPENBSD_4_4:1.7.0.32
	OPENBSD_4_4_BASE:1.7
	OPENBSD_4_3:1.7.0.30
	OPENBSD_4_3_BASE:1.7
	OPENBSD_4_2:1.7.0.28
	OPENBSD_4_2_BASE:1.7
	OPENBSD_4_1:1.7.0.26
	OPENBSD_4_1_BASE:1.7
	OPENBSD_4_0:1.7.0.24
	OPENBSD_4_0_BASE:1.7
	OPENBSD_3_9:1.7.0.22
	OPENBSD_3_9_BASE:1.7
	OPENBSD_3_8:1.7.0.20
	OPENBSD_3_8_BASE:1.7
	OPENBSD_3_7:1.7.0.18
	OPENBSD_3_7_BASE:1.7
	OPENBSD_3_6:1.7.0.16
	OPENBSD_3_6_BASE:1.7
	SMP_SYNC_A:1.7
	SMP_SYNC_B:1.7
	OPENBSD_3_5:1.7.0.14
	OPENBSD_3_5_BASE:1.7
	OPENBSD_3_4:1.7.0.12
	OPENBSD_3_4_BASE:1.7
	UBC_SYNC_A:1.7
	OPENBSD_3_3:1.7.0.10
	OPENBSD_3_3_BASE:1.7
	OPENBSD_3_2:1.7.0.8
	OPENBSD_3_2_BASE:1.7
	OPENBSD_3_1:1.7.0.6
	OPENBSD_3_1_BASE:1.7
	UBC_SYNC_B:1.7
	UBC:1.7.0.4
	UBC_BASE:1.7
	OPENBSD_3_0:1.7.0.2
	OPENBSD_3_0_BASE:1.7
	OPENBSD_2_9:1.6.0.22
	OPENBSD_2_9_BASE:1.6
	OPENBSD_2_8:1.6.0.20
	OPENBSD_2_8_BASE:1.6
	OPENBSD_2_7:1.6.0.18
	OPENBSD_2_7_BASE:1.6
	SMP:1.6.0.16
	SMP_BASE:1.6
	kame_19991208:1.6
	OPENBSD_2_6:1.6.0.14
	OPENBSD_2_6_BASE:1.6
	OPENBSD_2_5:1.6.0.12
	OPENBSD_2_5_BASE:1.6
	OPENBSD_2_4:1.6.0.10
	OPENBSD_2_4_BASE:1.6
	OPENBSD_2_3:1.6.0.8
	OPENBSD_2_3_BASE:1.6
	OPENBSD_2_2:1.6.0.6
	OPENBSD_2_2_BASE:1.6
	OPENBSD_2_1:1.6.0.4
	OPENBSD_2_1_BASE:1.6
	OPENBSD_2_0:1.6.0.2
	OPENBSD_2_0_BASE:1.6
	theo-1:1.1.1.2
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@# @;


1.9
date	2014.03.18.22.36.35;	author miod;	state dead;
branches;
next	1.8;

1.8
date	2013.02.02.13.36.06;	author miod;	state Exp;
branches;
next	1.7;

1.7
date	2001.07.04.08.06.56;	author niklas;	state Exp;
branches;
next	1.6;

1.6
date	96.05.16.02.30.37;	author chuck;	state Exp;
branches
	1.6.16.1;
next	1.5;

1.5
date	96.04.28.10.48.54;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	95.11.17.22.05.43;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	95.11.17.21.49.51;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	95.11.07.08.50.40;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.51.14;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.51.14;	author deraadt;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	95.10.18.10.44.16;	author deraadt;	state Exp;
branches;
next	;

1.6.16.1
date	2001.10.31.03.01.18;	author nate;	state Exp;
branches;
next	;


desc
@@


1.9
log
@Retire hp300, mvme68k and mvme88k ports. These ports have no users, keeping
this hardware alive is becoming increasingly difficult, and I should heed the
message sent by the three disks which have died on me over the last few days.

Noone sane will mourn these ports anyway. So long, and thanks for the fish.
@
text
@|	$OpenBSD: SRT0.S,v 1.8 2013/02/02 13:36:06 miod Exp $
|	$NetBSD: SRT0.S,v 1.2 1995/08/12 18:38:55 gwr Exp $

| Copyright (c) 1995 Gordon W. Ross
| All rights reserved.
|
| Redistribution and use in source and binary forms, with or without
| modification, are permitted provided that the following conditions
| are met:
| 1. Redistributions of source code must retain the above copyright
|    notice, this list of conditions and the following disclaimer.
| 2. Redistributions in binary form must reproduce the above copyright
|    notice, this list of conditions and the following disclaimer in the
|    documentation and/or other materials provided with the distribution.
| 3. The name of the author may not be used to endorse or promote products
|    derived from this software without specific prior written permission.
| 4. All advertising materials mentioning features or use of this software
|    must display the following acknowledgement:
|      This product includes software developed by Gordon Ross
|
| THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
| IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
| OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
| IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
| INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
| NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
| DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
| THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
| (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
| THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

|	this is a pre-startup wrapper for bugcrt which relocates the
|	code to the correct place before exec()ing.

|	SRT0.S - Stand-alone Run-Time startup code, part 0
	.file	"SRT0.S"
	.text
	.globl	__estack
__estack:
	.globl	xstart
xstart:
| first, relocate code to correct place without touching critical regs
| (args are in: d0, d1, d4, a0, a1, a2, a3, a4, a5, a6)
| 	[a3 and a4 only when netbooting]
	movl	%a3, %d3		| SAVE a3 in d3
	movl	%a4, %d5		| SAVE a4 in d5
	lea	%pc@@(xstart:w), %a3	| a3 = current addr (could be anywhere)
	lea	xstart:l, %a4		| a4 = desired location (LINKADDR)
	cmpl	%a3, %a4		| already there?
	beqs	restart			| short-circuit out

					| Relocate the code and data 
	movl	#edata,%d2		| Desired end of program
	subl	%a4,%d2			| Calculate length, round up.
	lsrl	#2,%d2
Lcp:
	movl	%a3@@+, %a4@@+
	dbra	%d2, Lcp

| Force a long jump to the relocated code (not pc-relative)
	lea	restart:l, %a3
	jmp	%a3@@

restart:
| now in the relocated code

| Set up stack (just before relocated text)
	lea	__estack:l, %a3
	movl	%a3, %sp

| now that we have relocated, call the bugcrt  (note we skip over the special
|	bug header which has a PC and SP in it)
	movl	%d3, %a3		| RESTORE a3
	movl	%d5, %a4		| RESTORE a4
	jmp	__start

| The end.
@


1.8
log
@mvme68k ELF bits. Boot block updates heavily based upon the recent mvme88k
a.out->ELF transition.
@
text
@d1 1
a1 1
|	$OpenBSD: SRT0.S,v 1.7 2001/07/04 08:06:56 niklas Exp $
@


1.7
log
@$OpenBSD$
@
text
@d1 1
a1 1
|	$OpenBSD: SRT0.S,v 1.2 1995/08/12 18:38:55 gwr Exp $
d45 5
a49 5
	movl	a3, d3			| SAVE a3 in d3
	movl	a4, d5			| SAVE a4 in d5
	lea	pc@@(xstart:w), a3	| a3 = current addr (could be anywhere)
	lea	xstart:l, a4		| a4 = desired location (LINKADDR)
	cmpl	a3, a4			| already there?
d53 3
a55 3
	movl	#_edata,d2		| Desired end of program
	subl	a4,d2			| Calculate length, round up.
	lsrl	#2,d2
d57 2
a58 2
	movl	a3@@+, a4@@+
	dbra	d2, Lcp
d61 2
a62 2
	lea	restart:l, a3
	jmp	a3@@
d68 2
a69 2
	lea	__estack:l, a3
	movl	a3, sp
d73 3
a75 3
	movl	d3, a3			| RESTORE a3
	movl	d5, a4			| RESTORE a4
	jmp	_start
@


1.6
log
@sync with sun3 port.
major reorg. & cleanup.
new SRT that works with bugcrt.
common parse_arg.
@
text
@d1 1
@


1.6.16.1
log
@Sync the SMP branch to something just after 3.0
@
text
@a0 1
|	$OpenBSD$
@


1.5
log
@add OpenBSD header
@
text
@d1 1
a1 1
|	$OpenBSD$
a2 29
| Copyright (c) 1995 Theo de Raadt
| 
| Redistribution and use in source and binary forms, with or without
| modification, are permitted provided that the following conditions
| are met:
| 1. Redistributions of source code must retain the above copyright
|    notice, this list of conditions and the following disclaimer.
| 2. Redistributions in binary form must reproduce the above copyright
|    notice, this list of conditions and the following disclaimer in the
|    documentation and/or other materials provided with the distribution.
| 3. All advertising materials mentioning features or use of this software
|    must display the following acknowledgement:
|	This product includes software developed under OpenBSD by
|	Theo de Raadt for Willowglen Singapore.
| 4. The name of the author may not be used to endorse or promote products
|    derived from this software without specific prior written permission.
|
| THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS
| OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
| WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
| ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY
| DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
| DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
| OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
| HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
| LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
| OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
| SUCH DAMAGE.
|
d31 3
d35 3
a37 3
		.file	"SRT0.S"
		.text
		.globl	__estack
d39 19
a57 19
		.globl	start
start:
| Check to see if the code is located correctly.
| This SHOULD do a PC-relative load into a0, but...
|		lea	start, a0	| current location (0x4000)
| XXX - GAS version 1.93 gets the above lea wrong!
		.word	0x41fa
		.word	0xfffe
| Now force a long (not PC-relative) load to a1 and compare.
		lea	start:l, a1	| desired location (LINKADDR)
		cmpl	a0, a1
		beqs	restart

| Relocate the code and data to where they belong.
		movl	#_edata,d2	| Desired end of program
		subl	a1,d2		| Calculate length, round up.
		lsrl	#2,d2
Lcp:		movl	a0@@+, a1@@+
		dbra	d2, Lcp
d60 2
a61 2
		lea	restart:l, a0
		jmp	a0@@
d67 8
a74 29
		lea	__estack:l, a0
		movl	a0, sp
		subl	a6, a6

		movl	d0, _devlun
		movl	d1, _ctrlun
		movl	a3, _oparg
		movl	a4, _opargend

| Call the run-time startup C code, which will:
|   initialize, call main, call exit
		jsr	__start:l

| If _start returns, fall into abort.
		.globl	_abort
_abort:
		trap	#0

| If abort returns, fall into reset.
		.globl	_reset
_reset:
		reset
		jmp	_reset

| function to get the vector base register
		.globl	_getvbr
_getvbr:
		movc	vbr, d0
		rts
a76 7

		.data
		.globl	_devlun, _ctrlun, _oparg, _opargend
_devlun:	.long	0
_ctrlun:	.long	0
_oparg:		.long	0
_opargend:	.long	0
@


1.4
log
@incorrect comment character in header
@
text
@d1 1
a1 1
|	$Id: SRT0.S,v 1.3 1995/11/17 21:49:51 deraadt Exp $
@


1.3
log
@incorrect comment character in header
@
text
@d1 1
a1 1
!	$Id: SRT0.S,v 1.2 1995/11/07 08:50:40 deraadt Exp $
@


1.2
log
@$Id$ throughout
update many copyrights
@
text
@d1 1
a1 1
#	$Id$
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
|	$NetBSD: SRT0.S,v 1.1.1.1 1995/07/25 23:12:21 chuck Exp $
d3 29
d61 3
a63 3
	.file	"SRT0.S"
	.text
	.globl	__estack
d65 1
a65 1
	.globl	start
d69 1
a69 1
|	lea	start, a0	| current location (0x4000)
d71 2
a72 2
	.word	0x41fa
	.word	0xfffe
d74 3
a76 3
	lea	start:l, a1	| desired location (LINKADDR)
	cmpl	a0, a1
	beqs	restart
d79 5
a83 6
	movl	#_edata,d0	| Desired end of program
	subl	a1,d0		| Calculate length, round up.
	lsrl	#2,d0
Lcp:
	movl	a0@@+, a1@@+
	dbra	d0, Lcp
d86 2
a87 2
	lea	restart:l, a0
	jmp	a0@@
a91 2
	movl	a6@@(8), __cmd_buf	| get cmd_line from sboot

d93 8
a100 3
	lea	__estack:l, a0
	movl	a0, sp
	subl	a6, a6
d104 1
a104 1
	jsr	__start:l
d107 1
a107 1
	.globl	_abort
d109 1
a109 1
	jsr	0x4000
d112 1
a112 1
	.globl	_reset
d114 8
a121 2
	reset
	jmp	_reset
d124 7
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@


1.1.1.2
log
@mvme68k port by me. some parts by dale rahn.
@
text
@d1 1
a1 1
|	$NetBSD: SRT0.S,v 1.1.1.2 1995/06/01 20:37:55 gwr Exp $
a2 1
| Copyright (c) 1995 Theo de Raadt
d32 3
a34 3
		.file	"SRT0.S"
		.text
		.globl	__estack
d36 1
a36 1
		.globl	start
d40 1
a40 1
|		lea	start, a0	| current location (0x4000)
d42 2
a43 2
		.word	0x41fa
		.word	0xfffe
d45 3
a47 3
		lea	start:l, a1	| desired location (LINKADDR)
		cmpl	a0, a1
		beqs	restart
d50 6
a55 5
		movl	#_edata,d2	| Desired end of program
		subl	a1,d2		| Calculate length, round up.
		lsrl	#2,d2
Lcp:		movl	a0@@+, a1@@+
		dbra	d2, Lcp
d58 2
a59 2
		lea	restart:l, a0
		jmp	a0@@
d64 2
d67 3
a69 8
		lea	__estack:l, a0
		movl	a0, sp
		subl	a6, a6

		movl	d0, _devlun
		movl	d1, _ctrlun
		movl	a3, _oparg
		movl	a4, _opargend
d73 1
a73 1
		jsr	__start:l
d76 1
a76 1
		.globl	_abort
d78 1
a78 1
		trap	#0
d81 1
a81 1
		.globl	_reset
d83 2
a84 8
		reset
		jmp	_reset

| function to get the vector base register
		.globl	_getvbr
_getvbr:
		movc	vbr, d0
		rts
a86 7

		.data
		.globl	_devlun, _ctrlun, _oparg, _opargend
_devlun:	.long	0
_ctrlun:	.long	0
_oparg:		.long	0
_opargend:	.long	0
@
