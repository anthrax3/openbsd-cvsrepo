head	1.28;
access;
symbols
	OPENBSD_6_1_BASE:1.28
	OPENBSD_6_0:1.25.0.2
	OPENBSD_6_0_BASE:1.25
	OPENBSD_5_9:1.24.0.2
	OPENBSD_5_9_BASE:1.24
	OPENBSD_5_8:1.19.0.4
	OPENBSD_5_8_BASE:1.19
	OPENBSD_5_7:1.18.0.2
	OPENBSD_5_7_BASE:1.18
	OPENBSD_5_6:1.17.0.4
	OPENBSD_5_6_BASE:1.17
	OPENBSD_5_5:1.16.0.14
	OPENBSD_5_5_BASE:1.16
	OPENBSD_5_4:1.16.0.10
	OPENBSD_5_4_BASE:1.16
	OPENBSD_5_3:1.16.0.8
	OPENBSD_5_3_BASE:1.16
	OPENBSD_5_2:1.16.0.6
	OPENBSD_5_2_BASE:1.16
	OPENBSD_5_1_BASE:1.16
	OPENBSD_5_1:1.16.0.4
	OPENBSD_5_0:1.16.0.2
	OPENBSD_5_0_BASE:1.16
	OPENBSD_4_9:1.15.0.2
	OPENBSD_4_9_BASE:1.15
	OPENBSD_4_8:1.14.0.8
	OPENBSD_4_8_BASE:1.14
	OPENBSD_4_7:1.14.0.4
	OPENBSD_4_7_BASE:1.14
	OPENBSD_4_6:1.14.0.6
	OPENBSD_4_6_BASE:1.14
	OPENBSD_4_5:1.14.0.2
	OPENBSD_4_5_BASE:1.14
	OPENBSD_4_4:1.13.0.6
	OPENBSD_4_4_BASE:1.13
	OPENBSD_4_3:1.13.0.4
	OPENBSD_4_3_BASE:1.13
	OPENBSD_4_2:1.13.0.2
	OPENBSD_4_2_BASE:1.13
	OPENBSD_4_1:1.11.0.4
	OPENBSD_4_1_BASE:1.11
	OPENBSD_4_0:1.11.0.2
	OPENBSD_4_0_BASE:1.11
	OPENBSD_3_9:1.10.0.20
	OPENBSD_3_9_BASE:1.10
	OPENBSD_3_8:1.10.0.18
	OPENBSD_3_8_BASE:1.10
	OPENBSD_3_7:1.10.0.16
	OPENBSD_3_7_BASE:1.10
	OPENBSD_3_6:1.10.0.14
	OPENBSD_3_6_BASE:1.10
	SMP_SYNC_A:1.10
	SMP_SYNC_B:1.10
	OPENBSD_3_5:1.10.0.12
	OPENBSD_3_5_BASE:1.10
	OPENBSD_3_4:1.10.0.10
	OPENBSD_3_4_BASE:1.10
	UBC_SYNC_A:1.10
	OPENBSD_3_3:1.10.0.8
	OPENBSD_3_3_BASE:1.10
	OPENBSD_3_2:1.10.0.6
	OPENBSD_3_2_BASE:1.10
	OPENBSD_3_1:1.10.0.4
	OPENBSD_3_1_BASE:1.10
	UBC_SYNC_B:1.10
	UBC:1.10.0.2
	UBC_BASE:1.10
	OPENBSD_3_0:1.9.0.2
	OPENBSD_3_0_BASE:1.9
	OPENBSD_2_9_BASE:1.6
	OPENBSD_2_9:1.6.0.2
	OPENBSD_2_8:1.5.0.16
	OPENBSD_2_8_BASE:1.5
	OPENBSD_2_7:1.5.0.14
	OPENBSD_2_7_BASE:1.5
	SMP:1.5.0.12
	SMP_BASE:1.5
	kame_19991208:1.5
	OPENBSD_2_6:1.5.0.10
	OPENBSD_2_6_BASE:1.5
	OPENBSD_2_5:1.5.0.8
	OPENBSD_2_5_BASE:1.5
	OPENBSD_2_4:1.5.0.6
	OPENBSD_2_4_BASE:1.5
	OPENBSD_2_3:1.5.0.4
	OPENBSD_2_3_BASE:1.5
	OPENBSD_2_2:1.5.0.2
	OPENBSD_2_2_BASE:1.5
	OPENBSD_2_1:1.4.0.4
	OPENBSD_2_1_BASE:1.4
	OPENBSD_2_0:1.4.0.2
	OPENBSD_2_0_BASE:1.4
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@ * @;


1.28
date	2017.01.09.17.58.44;	author mpi;	state Exp;
branches;
next	1.27;
commitid	j82PkKLhCqOiV0JZ;

1.27
date	2017.01.09.17.21.42;	author mpi;	state Exp;
branches;
next	1.26;
commitid	o57YWCdCXNjzNuSt;

1.26
date	2016.09.02.12.17.33;	author tb;	state Exp;
branches;
next	1.25;
commitid	Z6hUPnAcS0GtAGum;

1.25
date	2016.03.06.13.33.21;	author mpi;	state Exp;
branches;
next	1.24;
commitid	5oBW5nA61tcU7qMr;

1.24
date	2016.01.25.14.30.30;	author mpi;	state Exp;
branches;
next	1.23;
commitid	7AkssaZPPd7mA8h3;

1.23
date	2015.09.13.08.28.10;	author guenther;	state Exp;
branches;
next	1.22;
commitid	tl54BEWCiYyAGiYJ;

1.22
date	2015.09.12.10.27.45;	author deraadt;	state Exp;
branches;
next	1.21;
commitid	xu8ofY3OkCnnat1I;

1.21
date	2015.09.12.08.26.01;	author guenther;	state Exp;
branches;
next	1.20;
commitid	nfHE7jOi2HXCWd1T;

1.20
date	2015.08.30.18.12.52;	author deraadt;	state Exp;
branches;
next	1.19;
commitid	29ZmUBnX7RCjAqO9;

1.19
date	2015.03.14.03.38.46;	author jsg;	state Exp;
branches;
next	1.18;
commitid	p4LJxGKbi0BU2cG6;

1.18
date	2014.09.14.14.17.24;	author jsg;	state Exp;
branches;
next	1.17;
commitid	uzzBR7hz9ncd4O6G;

1.17
date	2014.07.08.13.02.57;	author deraadt;	state Exp;
branches;
next	1.16;
commitid	E2I6e8QZgMmNFC95;

1.16
date	2011.04.03.16.46.19;	author drahn;	state Exp;
branches;
next	1.15;

1.15
date	2010.11.27.19.57.23;	author miod;	state Exp;
branches;
next	1.14;

1.14
date	2008.10.26.22.23.10;	author deraadt;	state Exp;
branches;
next	1.13;

1.13
date	2007.06.04.17.03.04;	author miod;	state Exp;
branches;
next	1.12;

1.12
date	2007.06.04.16.52.39;	author miod;	state Exp;
branches;
next	1.11;

1.11
date	2006.03.13.06.23.20;	author jsg;	state Exp;
branches;
next	1.10;

1.10
date	2001.11.06.19.53.18;	author miod;	state Exp;
branches;
next	1.9;

1.9
date	2001.08.19.19.47.45;	author art;	state Exp;
branches;
next	1.8;

1.8
date	2001.08.19.16.12.05;	author art;	state Exp;
branches;
next	1.7;

1.7
date	2001.08.18.18.50.59;	author art;	state Exp;
branches;
next	1.6;

1.6
date	2001.04.05.20.05.29;	author art;	state Exp;
branches;
next	1.5;

1.5
date	97.07.19.22.31.21;	author niklas;	state Exp;
branches
	1.5.12.1;
next	1.4;

1.4
date	96.04.21.22.19.16;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	96.03.11.11.16.26;	author mickey;	state Exp;
branches;
next	1.2;

1.2
date	96.02.20.13.35.44;	author mickey;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.52.28;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.52.28;	author deraadt;	state Exp;
branches;
next	;

1.5.12.1
date	2001.05.14.22.07.01;	author niklas;	state Exp;
branches;
next	1.5.12.2;

1.5.12.2
date	2001.10.31.03.11.47;	author nate;	state Exp;
branches;
next	1.5.12.3;

1.5.12.3
date	2001.11.13.21.05.48;	author niklas;	state Exp;
branches;
next	;


desc
@@


1.28
log
@Revert previous, it's a documented behavior and people might rely on it.

Pointed by deraadt@@
@
text
@/*	$OpenBSD: db_trap.c,v 1.27 2017/01/09 17:21:42 mpi Exp $	*/
/*	$NetBSD: db_trap.c,v 1.9 1996/02/05 01:57:18 christos Exp $	*/

/*
 * Mach Operating System
 * Copyright (c) 1993,1992,1991,1990 Carnegie Mellon University
 * All Rights Reserved.
 *
 * Permission to use, copy, modify and distribute this software and its
 * documentation is hereby granted, provided that both the copyright
 * notice and this permission notice appear in all copies of the
 * software, derivative works or modified versions, and any portions
 * thereof, and that both notices appear in supporting documentation.
 *
 * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS "AS IS"
 * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR
 * ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.
 *
 * Carnegie Mellon requests users of this software to return to
 *
 *  Software Distribution Coordinator  or  Software.Distribution@@CS.CMU.EDU
 *  School of Computer Science
 *  Carnegie Mellon University
 *  Pittsburgh PA 15213-3890
 *
 * any improvements or extensions that they make and grant Carnegie Mellon
 * the rights to redistribute these changes.
 *
 * 	Author: David B. Golub, Carnegie Mellon University
 *	Date:	7/90
 */

/*
 * Trap entry point to kernel debugger.
 */
#include <sys/param.h>
#include <sys/systm.h>

#include <machine/db_machdep.h>

#include <ddb/db_run.h>
#include <ddb/db_command.h>
#include <ddb/db_output.h>
#include <ddb/db_sym.h>
#include <ddb/db_extern.h>
#include <ddb/db_interface.h>
#include <ddb/db_var.h>

void
db_trap(int type, int code)
{
	boolean_t	bkpt;
	boolean_t	watchpt;

	db_is_active = 1;
	bkpt = IS_BREAKPOINT_TRAP(type, code);
	watchpt = IS_WATCHPOINT_TRAP(type, code);

	if (db_stop_at_pc(&ddb_regs, &bkpt)) {
		if (db_inst_count) {
			db_printf("After %d instructions\n", db_inst_count);
		}
		if (bkpt)
			db_printf("Breakpoint at\t");
		else if (watchpt)
			db_printf("Watchpoint at\t");
		else
			db_printf("Stopped at\t");
		db_dot = PC_REGS(&ddb_regs);
		db_print_loc_and_inst(db_dot);

		if (panicstr != NULL) {
			static int ddb_msg_shown;

			if (! ddb_msg_shown) {
				/* show on-proc threads */
				db_show_all_procs(0, 0, 0, "o");
			}
			/* then the backtrace */
			db_stack_trace_print(db_dot, 0, 14 /* arbitrary */, "",
			    db_printf);

			if (db_print_position() != 0)
				db_printf("\n");
			if (! ddb_msg_shown) {
				db_printf(
"https://www.openbsd.org/ddb.html describes the minimum info required in bug\n"
"reports.  Insufficient info makes it difficult to find and fix bugs.\n");
				ddb_msg_shown = 1;
			}
		}

		db_command_loop();
	}

	db_restart_at_pc(&ddb_regs, watchpt);
	db_is_active = 0;
}
@


1.27
log
@Stop and restart the watchdog timer when entering and leaving ddb(4).

From Christian Ludwig.
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.26 2016/09/02 12:17:33 tb Exp $	*/
a55 1
	db_wdog_disable();
a96 1
	db_wdog_enable();
@


1.26
log
@move links from http to https://www.openbsd.org/

ok beck
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.25 2016/03/06 13:33:21 mpi Exp $	*/
d56 1
d98 1
@


1.25
log
@DDB_REGS -> &ddb_regs.

All our archs use the same define.
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.24 2016/01/25 14:30:30 mpi Exp $	*/
d87 1
a87 1
"http://www.openbsd.org/ddb.html describes the minimum info required in bug\n"
@


1.24
log
@Kill trailing whitespaces.  No object change.
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.23 2015/09/13 08:28:10 guenther Exp $	*/
d59 1
a59 1
	if (db_stop_at_pc(DDB_REGS, &bkpt)) {
d69 1
a69 1
		db_dot = PC_REGS(DDB_REGS);
d96 1
a96 1
	db_restart_at_pc(DDB_REGS, watchpt);
@


1.23
log
@On show the ps/o output and ddb.html blurb once, so that we don't get them
after each "mach ddbcpu N"

ok miod@@ deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.22 2015/09/12 10:27:45 deraadt Exp $	*/
d4 1
a4 1
/* 
d8 1
a8 1
 * 
d14 1
a14 1
 * 
d18 1
a18 1
 * 
d20 1
a20 1
 * 
d25 1
a25 1
 * 
@


1.22
log
@show a few more lines of trace; discussed in the room
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.21 2015/09/12 08:26:01 guenther Exp $	*/
d73 6
a78 2
			/* show on-proc threads */
			db_show_all_procs(0, 0, 0, "o");
d85 2
a86 1
			db_printf(
d89 2
@


1.21
log
@When panicing, show the non-idle, on-proc threads before showing the stack
trace

ok deraadt@@ miod@@ beck@@
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.20 2015/08/30 18:12:52 deraadt Exp $	*/
d76 1
a76 1
			db_stack_trace_print(db_dot, 0, 10 /* arbitrary */, "",
@


1.20
log
@Automatically perform traces upon panic.  Shrink message about
reporting bugs to pointing at http://www.openbsd.org/ddb.html,
because vertical space becomes more precious.
ok beck krw kettenis
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.19 2015/03/14 03:38:46 jsg Exp $	*/
d73 3
@


1.19
log
@Remove some includes include-what-you-use claims don't
have any direct symbols used.  Tested for indirect use by compiling
amd64/i386/sparc64 kernels.

ok tedu@@ deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.18 2014/09/14 14:17:24 jsg Exp $	*/
d72 1
a72 5
		/*
		 * Just in case we do not have any usable console driver,
		 * give the user a traceback.
		 */
		if (cold) {
a74 1
		}
a75 1
		if (panicstr != NULL) {
d78 3
a80 8
			db_printf("RUN AT LEAST 'trace' AND 'ps' AND INCLUDE "
			    "OUTPUT WHEN REPORTING THIS PANIC!\n");
#ifdef MULTIPROCESSOR
			db_printf("IF RUNNING SMP, USE 'mach ddbcpu <#>' AND "
			    "'trace' ON OTHER PROCESSORS, TOO.\n");
#endif
			db_printf("DO NOT EVEN BOTHER REPORTING THIS WITHOUT "
			    "INCLUDING THAT INFORMATION!\n");
@


1.18
log
@remove uneeded proc.h includes
ok mpi@@ kspillner@@
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.17 2014/07/08 13:02:57 deraadt Exp $	*/
a42 1
#include <ddb/db_break.h>
@


1.17
log
@These do not need the extremely poorly named uvm/uvm_extern.h (which
pulls in the universe). occasionally they need sys/systm.h
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.16 2011/04/03 16:46:19 drahn Exp $	*/
a36 1
#include <sys/proc.h>
@


1.16
log
@Allow kernel printfs to go to console if in ddb instead of being redirected
to xconsole. ok deraadt@@ guenther@@
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.15 2010/11/27 19:57:23 miod Exp $	*/
a38 2

#include <uvm/uvm_extern.h>
@


1.15
log
@Remove ddb single-step load and store counters. Most platforms do not
implement them, and they are of questionable usefulness.
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.14 2008/10/26 22:23:10 deraadt Exp $	*/
d51 1
d59 1
d102 1
@


1.14
log
@for MP, ask people to try to trace the other cpus too
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.13 2007/06/04 17:03:04 miod Exp $	*/
d63 1
a63 3
			db_printf("After %d instructions ", db_inst_count);
			db_printf("(%d loads, %d stores),\n", db_load_count,
			    db_store_count);
@


1.13
log
@Ten lines of backtrace should be better on 25-line screens, so that the panic
message is still visible.
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.12 2007/06/04 16:52:39 miod Exp $	*/
d90 4
@


1.12
log
@If it's cold at panic time, attempt to show a small backtrace, there are too
many machines where glass console does not work correctly at this stage.
By popular demand...
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.11 2006/03/13 06:23:20 jsg Exp $	*/
d81 1
a81 1
			db_stack_trace_print(db_dot, 0, 20 /* arbitrary */, "",
@


1.11
log
@ansi/deregister. No binary change.
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.10 2001/11/06 19:53:18 miod Exp $	*/
d50 1
d75 9
@


1.10
log
@Replace inclusion of <vm/foo.h> with the correct <uvm/bar.h> when necessary.
(Look ma, I might have broken the tree)
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.9 2001/08/19 19:47:45 art Exp $	*/
d52 1
a52 2
db_trap(type, code)
	int	type, code;
@


1.9
log
@shorter
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.8 2001/08/19 16:12:05 art Exp $	*/
d40 1
a40 1
#include <vm/vm.h>
@


1.8
log
@shorten the message to fit on a line.
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.7 2001/08/18 18:50:59 art Exp $	*/
a78 1
			db_printf("\n\n**********************************\n");
a82 2
			db_printf("DON'T WASTE OUR TIME!\n");
			db_printf("**********************************\n\n");
@


1.7
log
@I am sick and tired of bug reports LACKING INFORMATION.
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.6 2001/04/05 20:05:29 art Exp $	*/
d81 1
a81 1
			    "THE OUTPUT WHEN REPORTING THIS PANIC!\n");
@


1.6
log
@Tell the users what to report when the kernel crashes.
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.5 1997/07/19 22:31:21 niklas Exp $	*/
d79 7
a85 2
			db_printf("Run at least 'trace' and 'ps' and include "
			    "the output when reporting this panic.\n");
@


1.5
log
@Include vm/vm.h everywhere it is needed to get at boolean_t (I would prefer
to have it in sys/types.h but that is problematic).  Some KNF.
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.4 1996/04/21 22:19:16 deraadt Exp $	*/
d38 1
d75 7
@


1.5.12.1
log
@merge in approximately 2.9 into SMP branch
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.6 2001/04/05 20:05:29 art Exp $	*/
a37 1
#include <sys/systm.h>
a73 7

		if (panicstr != NULL) {
			if (db_print_position() != 0)
				db_printf("\n");
			db_printf("Run at least 'trace' and 'ps' and include "
			    "the output when reporting this panic.\n");
		}
@


1.5.12.2
log
@Sync the SMP branch to something just after 3.0
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.5.12.1 2001/05/14 22:07:01 niklas Exp $	*/
d79 2
a80 4
			db_printf("RUN AT LEAST 'trace' AND 'ps' AND INCLUDE "
			    "OUTPUT WHEN REPORTING THIS PANIC!\n");
			db_printf("DO NOT EVEN BOTHER REPORTING THIS WITHOUT "
			    "INCLUDING THAT INFORMATION!\n");
@


1.5.12.3
log
@Merge in -current
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d40 1
a40 1
#include <uvm/uvm_extern.h>
@


1.4
log
@partial sync with netbsd 960418, more to come
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.3 1996/03/11 11:16:26 mickey Exp $	*/
d39 2
d61 13
a73 12
	    if (db_inst_count) {
		db_printf("After %d instructions (%d loads, %d stores),\n",
			  db_inst_count, db_load_count, db_store_count);
	    }
	    if (bkpt)
		db_printf("Breakpoint at\t");
	    else if (watchpt)
		db_printf("Watchpoint at\t");
	    else
		db_printf("Stopped at\t");
	    db_dot = PC_REGS(DDB_REGS);
	    db_print_loc_and_inst(db_dot);
d75 1
a75 1
	    db_command_loop();
@


1.3
log
@Debbuger changed towards the latest Mach.
Some minor changes for Linux ;) emulation.
Small bug fixes from NetBSD.
@
text
@d1 2
a2 1
/*	$OpenBSD: db_trap.c,v 1.2 1996/02/20 13:35:44 mickey Exp $	*/
@


1.2
log
@netbsd-current import & 'boot' cmd addition.
@
text
@d1 1
a1 1
/*	$OpenBSD: db_trap.c,v 1.9 1996/02/05 01:57:18 christos Exp $	*/
d5 1
a5 1
 * Copyright (c) 1991,1990 Carnegie Mellon University
d14 1
a14 1
 * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS 
d25 2
a26 2
 * any improvements or extensions that they make and grant Carnegie the
 * rights to redistribute these changes.
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
/*	$NetBSD: db_trap.c,v 1.8 1994/12/02 06:07:37 gwr Exp $	*/
d43 3
d47 1
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
