head	1.17;
access;
symbols
	OPENBSD_6_1:1.17.0.6
	OPENBSD_6_1_BASE:1.17
	OPENBSD_6_0:1.17.0.4
	OPENBSD_6_0_BASE:1.17
	OPENBSD_5_9:1.17.0.2
	OPENBSD_5_9_BASE:1.17
	OPENBSD_5_8:1.13.0.6
	OPENBSD_5_8_BASE:1.13
	OPENBSD_5_7:1.13.0.2
	OPENBSD_5_7_BASE:1.13
	OPENBSD_5_6:1.11.0.8
	OPENBSD_5_6_BASE:1.11
	OPENBSD_5_5:1.11.0.6
	OPENBSD_5_5_BASE:1.11
	OPENBSD_5_4:1.11.0.2
	OPENBSD_5_4_BASE:1.11
	OPENBSD_5_3:1.10.0.2
	OPENBSD_5_3_BASE:1.10
	OPENBSD_5_2:1.9.0.16
	OPENBSD_5_2_BASE:1.9
	OPENBSD_5_1_BASE:1.9
	OPENBSD_5_1:1.9.0.14
	OPENBSD_5_0:1.9.0.12
	OPENBSD_5_0_BASE:1.9
	OPENBSD_4_9:1.9.0.10
	OPENBSD_4_9_BASE:1.9
	OPENBSD_4_8:1.9.0.8
	OPENBSD_4_8_BASE:1.9
	OPENBSD_4_7:1.9.0.4
	OPENBSD_4_7_BASE:1.9
	OPENBSD_4_6:1.9.0.6
	OPENBSD_4_6_BASE:1.9
	OPENBSD_4_5:1.9.0.2
	OPENBSD_4_5_BASE:1.9
	OPENBSD_4_4:1.8.0.22
	OPENBSD_4_4_BASE:1.8
	OPENBSD_4_3:1.8.0.20
	OPENBSD_4_3_BASE:1.8
	OPENBSD_4_2:1.8.0.18
	OPENBSD_4_2_BASE:1.8
	OPENBSD_4_1:1.8.0.16
	OPENBSD_4_1_BASE:1.8
	OPENBSD_4_0:1.8.0.14
	OPENBSD_4_0_BASE:1.8
	OPENBSD_3_9:1.8.0.12
	OPENBSD_3_9_BASE:1.8
	OPENBSD_3_8:1.8.0.10
	OPENBSD_3_8_BASE:1.8
	OPENBSD_3_7:1.8.0.8
	OPENBSD_3_7_BASE:1.8
	OPENBSD_3_6:1.8.0.6
	OPENBSD_3_6_BASE:1.8
	SMP_SYNC_A:1.8
	SMP_SYNC_B:1.8
	OPENBSD_3_5:1.8.0.4
	OPENBSD_3_5_BASE:1.8
	OPENBSD_3_4:1.8.0.2
	OPENBSD_3_4_BASE:1.8
	UBC_SYNC_A:1.7
	OPENBSD_3_3:1.6.0.4
	OPENBSD_3_3_BASE:1.6
	OPENBSD_3_2:1.6.0.2
	OPENBSD_3_2_BASE:1.6
	OPENBSD_3_1:1.4.0.2
	OPENBSD_3_1_BASE:1.4
	UBC_SYNC_B:1.6
	UBC:1.2.0.26
	UBC_BASE:1.2
	OPENBSD_3_0:1.2.0.24
	OPENBSD_3_0_BASE:1.2
	OPENBSD_2_9_BASE:1.2
	OPENBSD_2_9:1.2.0.22
	OPENBSD_2_8:1.2.0.20
	OPENBSD_2_8_BASE:1.2
	OPENBSD_2_7:1.2.0.18
	OPENBSD_2_7_BASE:1.2
	SMP:1.2.0.16
	SMP_BASE:1.2
	kame_19991208:1.2
	OPENBSD_2_6:1.2.0.14
	OPENBSD_2_6_BASE:1.2
	OPENBSD_2_5:1.2.0.12
	OPENBSD_2_5_BASE:1.2
	OPENBSD_2_4:1.2.0.10
	OPENBSD_2_4_BASE:1.2
	OPENBSD_2_3:1.2.0.8
	OPENBSD_2_3_BASE:1.2
	OPENBSD_2_2:1.2.0.6
	OPENBSD_2_2_BASE:1.2
	OPENBSD_2_1:1.2.0.4
	OPENBSD_2_1_BASE:1.2
	OPENBSD_2_0:1.2.0.2
	OPENBSD_2_0_BASE:1.2
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@ * @;


1.17
date	2015.12.03.23.12.13;	author claudio;	state Exp;
branches;
next	1.16;
commitid	sEFNGMhBR5gKYXG7;

1.16
date	2015.10.07.10.50.35;	author mpi;	state Exp;
branches;
next	1.15;
commitid	hPrd2a6fiZdlN2yP;

1.15
date	2015.09.04.08.43.39;	author mpi;	state Exp;
branches;
next	1.14;
commitid	qAevExm24QrBjVNL;

1.14
date	2015.08.30.10.39.16;	author mpi;	state Exp;
branches;
next	1.13;
commitid	avqdJydG8T8nvZhe;

1.13
date	2014.12.23.03.26.24;	author tedu;	state Exp;
branches;
next	1.12;
commitid	5maZww1zcSNGP9Eu;

1.12
date	2014.08.31.01.42.36;	author guenther;	state Exp;
branches;
next	1.11;
commitid	zF5A8BuuSSyqaDyM;

1.11
date	2013.04.24.10.17.08;	author mpi;	state Exp;
branches;
next	1.10;

1.10
date	2012.09.15.00.47.08;	author guenther;	state Exp;
branches;
next	1.9;

1.9
date	2009.02.22.07.47.22;	author otto;	state Exp;
branches;
next	1.8;

1.8
date	2003.06.02.23.28.21;	author millert;	state Exp;
branches;
next	1.7;

1.7
date	2003.05.12.00.48.52;	author jason;	state Exp;
branches;
next	1.6;

1.6
date	2002.05.27.11.47.00;	author itojun;	state Exp;
branches;
next	1.5;

1.5
date	2002.05.27.02.59.41;	author itojun;	state Exp;
branches;
next	1.4;

1.4
date	2002.03.15.01.20.04;	author millert;	state Exp;
branches;
next	1.3;

1.3
date	2002.03.14.01.27.14;	author millert;	state Exp;
branches;
next	1.2;

1.2
date	96.03.03.12.11.38;	author niklas;	state Exp;
branches
	1.2.16.1
	1.2.26.1;
next	1.1;

1.1
date	95.10.18.08.53.26;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.53.26;	author deraadt;	state Exp;
branches;
next	;

1.2.16.1
date	2002.03.28.14.52.01;	author niklas;	state Exp;
branches;
next	1.2.16.2;

1.2.16.2
date	2003.03.28.00.41.30;	author niklas;	state Exp;
branches;
next	1.2.16.3;

1.2.16.3
date	2003.05.13.19.36.57;	author ho;	state Exp;
branches;
next	1.2.16.4;

1.2.16.4
date	2003.06.07.11.09.07;	author ho;	state Exp;
branches;
next	;

1.2.26.1
date	2002.06.11.03.32.33;	author art;	state Exp;
branches;
next	1.2.26.2;

1.2.26.2
date	2003.05.19.22.32.19;	author tedu;	state Exp;
branches;
next	;


desc
@@


1.17
log
@mpi@@ forgot to commit this. That should unbreak the tree.
@
text
@/*	$OpenBSD: domain.h,v 1.16 2015/10/07 10:50:35 mpi Exp $	*/
/*	$NetBSD: domain.h,v 1.10 1996/02/09 18:25:07 christos Exp $	*/

/*
 * Copyright (c) 1982, 1986, 1993
 *	The Regents of the University of California.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 *	@@(#)domain.h	8.1 (Berkeley) 6/2/93
 */

/*
 * Structure per communications domain.
 */

#ifndef	_SOCKLEN_T_DEFINED_
#define	_SOCKLEN_T_DEFINED_
typedef	__socklen_t	socklen_t;	/* length type for network syscalls */
#endif

/*
 * Forward structure declarations for function prototypes [sic].
 */
struct	mbuf;
struct	ifnet;

struct	domain {
	int	dom_family;		/* AF_xxx */
	char	*dom_name;
	void	(*dom_init)(void);	/* initialize domain data structures */
					/* externalize access rights */
	int	(*dom_externalize)(struct mbuf *, socklen_t, int);
					/* dispose of internalized rights */
	void	(*dom_dispose)(struct mbuf *);
	struct	protosw *dom_protosw, *dom_protoswNPROTOSW;
					/* initialize routing table */
	unsigned int	dom_rtkeylen;	/* maximum size of the key */
	unsigned int	dom_rtoffset;	/* offset of the key, in bytes */
	unsigned int	dom_maxplen;	/* maxium prefix length, in bits */
	void	*(*dom_ifattach)(struct ifnet *);
	void	(*dom_ifdetach)(struct ifnet *, void *);
					/* af-dependent data on ifnet */
};

#ifdef _KERNEL
extern struct domain *domains[];
void domaininit(void);

extern struct domain inetdomain;

#ifdef INET6
extern struct domain inet6domain;
#endif

#endif /* _KERNEL */
@


1.16
log
@Initialize the routing table before domains.

The routing table is not an optional component of the network stack
and initializing it inside the "routing domain" requires some ugly
introspection in the domain interface.

This put the rtable* layer at the same level of the if* level.  These
two subsystem are organized around the two global data structure used
in the network stack:

- the global &ifnet list, to be used in process context only, and
- the routing table which can be read in interrupt context.

This change makes the rtable_* layer domain-aware and extends the
"struct domain" such that INET, INET6 and MPLS can specify the length
of the binary key used in lookups.  This allows us to keep, or move
towards, AF-free route and rtable layers.

While here stop the madness and pass the size of the maximum key length
in *byte* to rn_inithead0().

ok claudio@@, mikeb@@
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.15 2015/09/04 08:43:39 mpi Exp $	*/
d62 1
@


1.15
log
@Make every subsystem using a radix tree call rn_init() and pass the
length of the key as argument.

This way every consumer of the radix tree has a chance to explicitly
initialize the shared data structures and no longer rely on another
subsystem to do the initialization.

As a bonus ``dom_maxrtkey'' is no longer used an die.

ART kernels should now be fully usable because pf(4) and IPSEC properly
initialized the radix tree.

ok chris@@, reyk@@
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.14 2015/08/30 10:39:16 mpi Exp $	*/
d60 2
a61 2
	int	(*dom_rtattach)(void **, int);
	int	dom_rtoffset;		/* an arg to rtattach, in bits */
@


1.14
log
@Use a global table for domains instead of building a list at run time.

As a side effect there's no need to run if_attachdomain() after the
list of domains has been built.

ok claudio@@, reyk@@
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.13 2014/12/23 03:26:24 tedu Exp $	*/
a61 1
	int	dom_maxrtkey;		/* for routing layer */
@


1.13
log
@unifdef INET
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.12 2014/08/31 01:42:36 guenther Exp $	*/
a58 1
	struct	domain *dom_next;
d69 1
a69 1
extern struct	domain *domains;
@


1.12
log
@Add additional kernel interfaces for setting close-on-exec on fds
when creating them: pipe2(), dup3(), accept4(), MSG_CMSG_CLOEXEC,
SOCK_CLOEXEC.  Includes SOCK_NONBLOCK support.

ok matthew@@
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.11 2013/04/24 10:17:08 mpi Exp $	*/
a72 1
#ifdef INET
a73 1
#endif
@


1.11
log
@Instead of having various extern declarations for protocol variables,
declare them once in their corresponding header file.
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.10 2012/09/15 00:47:08 guenther Exp $	*/
d55 1
a55 1
	int	(*dom_externalize)(struct mbuf *, socklen_t);
@


1.10
log
@Improve POSIX/SUS compliance of <netdb.h>, <sys/socket.h>, and <sys/un.h>.

Much ports testing of various versions by naddy@@ and jasper@@
ok matthew@@, miller@@
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.9 2009/02/22 07:47:22 otto Exp $	*/
d72 7
d80 2
@


1.9
log
@fix PR 6082: do not create more fd's than will fit in the message on
the receiving side when passing fd's. ok deraadt@@ kettenis@@
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.8 2003/06/02 23:28:21 millert Exp $	*/
d38 5
@


1.8
log
@Remove the advertising clause in the UCB license which Berkeley
rescinded 22 July 1999.  Proofed by myself and Theo.
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.7 2003/05/12 00:48:52 jason Exp $	*/
d50 1
a50 1
	int	(*dom_externalize)(struct mbuf *);
@


1.7
log
@Nuke a whole bunch of commons; ok tedu (still more to come *sigh*)
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.6 2002/05/27 11:47:00 itojun Exp $	*/
d16 1
a16 5
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by the University of
 *	California, Berkeley and its contributors.
 * 4. Neither the name of the University nor the names of its contributors
@


1.6
log
@no need for __P
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.5 2002/05/27 02:59:41 itojun Exp $	*/
d69 1
a69 1
struct	domain *domains;
@


1.5
log
@framework to add af-dependent data structure to struct ifnet.
as discussed at bsd-api-discuss.  sync w/kame
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.4 2002/03/15 01:20:04 millert Exp $	*/
d63 2
a64 2
	void	*(*dom_ifattach) __P((struct ifnet *));
	void	(*dom_ifdetach) __P((struct ifnet *, void *));
@


1.4
log
@Cosmetic changes only, primarily making comments line up nicely after the
__P removal.
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.3 2002/03/14 01:27:14 millert Exp $	*/
d47 1
d63 3
@


1.3
log
@First round of __P removal in sys
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.2 1996/03/03 12:11:38 niklas Exp $	*/
d51 5
a55 3
	void	(*dom_init)		/* initialize domain data structures */(void);
	int	(*dom_externalize)	/* externalize access rights */(struct mbuf *);
	void	(*dom_dispose)		/* dispose of internalized rights */(struct mbuf *);
d58 2
a59 1
	int	(*dom_rtattach)		/* initialize routing table */(void **, int);
@


1.2
log
@From NetBSD: 960217 merge
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d51 3
a53 6
	void	(*dom_init)		/* initialize domain data structures */
			__P((void));
	int	(*dom_externalize)	/* externalize access rights */
			__P((struct mbuf *));
	void	(*dom_dispose)		/* dispose of internalized rights */
			__P((struct mbuf *));
d56 1
a56 2
	int	(*dom_rtattach)		/* initialize routing table */
			__P((void **, int));
d63 1
a63 1
void domaininit __P((void));
@


1.2.26.1
log
@Sync UBC branch to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.2 1996/03/03 12:11:38 niklas Exp $	*/
a46 1
struct	ifnet;
d51 6
a56 5
	void	(*dom_init)(void);	/* initialize domain data structures */
					/* externalize access rights */
	int	(*dom_externalize)(struct mbuf *);
					/* dispose of internalized rights */
	void	(*dom_dispose)(struct mbuf *);
d59 2
a60 2
					/* initialize routing table */
	int	(*dom_rtattach)(void **, int);
a62 3
	void	*(*dom_ifattach)(struct ifnet *);
	void	(*dom_ifdetach)(struct ifnet *, void *);
					/* af-dependent data on ifnet */
d67 1
a67 1
void domaininit(void);
@


1.2.26.2
log
@sync
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d69 1
a69 1
extern struct	domain *domains;
@


1.2.16.1
log
@Merge in -current from roughly a week ago
@
text
@d51 6
a56 5
	void	(*dom_init)(void);	/* initialize domain data structures */
					/* externalize access rights */
	int	(*dom_externalize)(struct mbuf *);
					/* dispose of internalized rights */
	void	(*dom_dispose)(struct mbuf *);
d59 2
a60 2
					/* initialize routing table */
	int	(*dom_rtattach)(void **, int);
d67 1
a67 1
void domaininit(void);
@


1.2.16.2
log
@Sync the SMP branch with 3.3
@
text
@a46 1
struct	ifnet;
a61 3
	void	*(*dom_ifattach)(struct ifnet *);
	void	(*dom_ifdetach)(struct ifnet *, void *);
					/* af-dependent data on ifnet */
@


1.2.16.3
log
@Sync the SMP branch to -current. This includes moving to ELF.
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.2.16.2 2003/03/28 00:41:30 niklas Exp $	*/
d69 1
a69 1
extern struct	domain *domains;
@


1.2.16.4
log
@Sync SMP branch to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: domain.h,v 1.2.16.3 2003/05/13 19:36:57 ho Exp $	*/
d16 5
a20 1
 * 3. Neither the name of the University nor the names of its contributors
@


1.1
log
@Initial revision
@
text
@d1 2
a2 1
/*	$NetBSD: domain.h,v 1.8 1995/03/26 20:24:03 jtc Exp $	*/
d52 1
a52 1
		__P((void));
d54 3
a56 3
		__P((struct mbuf *));
	int	(*dom_dispose)		/* dispose of internalized rights */
		__P((struct mbuf *));
d60 1
a60 1
		__P((void **, int));
d67 1
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
