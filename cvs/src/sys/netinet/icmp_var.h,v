head	1.15;
access;
symbols
	OPENBSD_6_0:1.14.0.14
	OPENBSD_6_0_BASE:1.14
	OPENBSD_5_9:1.14.0.8
	OPENBSD_5_9_BASE:1.14
	OPENBSD_5_8:1.14.0.10
	OPENBSD_5_8_BASE:1.14
	OPENBSD_5_7:1.14.0.2
	OPENBSD_5_7_BASE:1.14
	OPENBSD_5_6:1.14.0.6
	OPENBSD_5_6_BASE:1.14
	OPENBSD_5_5:1.14.0.4
	OPENBSD_5_5_BASE:1.14
	OPENBSD_5_4:1.13.0.24
	OPENBSD_5_4_BASE:1.13
	OPENBSD_5_3:1.13.0.22
	OPENBSD_5_3_BASE:1.13
	OPENBSD_5_2:1.13.0.20
	OPENBSD_5_2_BASE:1.13
	OPENBSD_5_1_BASE:1.13
	OPENBSD_5_1:1.13.0.18
	OPENBSD_5_0:1.13.0.16
	OPENBSD_5_0_BASE:1.13
	OPENBSD_4_9:1.13.0.14
	OPENBSD_4_9_BASE:1.13
	OPENBSD_4_8:1.13.0.12
	OPENBSD_4_8_BASE:1.13
	OPENBSD_4_7:1.13.0.8
	OPENBSD_4_7_BASE:1.13
	OPENBSD_4_6:1.13.0.10
	OPENBSD_4_6_BASE:1.13
	OPENBSD_4_5:1.13.0.6
	OPENBSD_4_5_BASE:1.13
	OPENBSD_4_4:1.13.0.4
	OPENBSD_4_4_BASE:1.13
	OPENBSD_4_3:1.13.0.2
	OPENBSD_4_3_BASE:1.13
	OPENBSD_4_2:1.12.0.16
	OPENBSD_4_2_BASE:1.12
	OPENBSD_4_1:1.12.0.14
	OPENBSD_4_1_BASE:1.12
	OPENBSD_4_0:1.12.0.12
	OPENBSD_4_0_BASE:1.12
	OPENBSD_3_9:1.12.0.10
	OPENBSD_3_9_BASE:1.12
	OPENBSD_3_8:1.12.0.8
	OPENBSD_3_8_BASE:1.12
	OPENBSD_3_7:1.12.0.6
	OPENBSD_3_7_BASE:1.12
	OPENBSD_3_6:1.12.0.4
	OPENBSD_3_6_BASE:1.12
	SMP_SYNC_A:1.12
	SMP_SYNC_B:1.12
	OPENBSD_3_5:1.12.0.2
	OPENBSD_3_5_BASE:1.12
	OPENBSD_3_4:1.11.0.2
	OPENBSD_3_4_BASE:1.11
	UBC_SYNC_A:1.10
	OPENBSD_3_3:1.10.0.2
	OPENBSD_3_3_BASE:1.10
	OPENBSD_3_2:1.9.0.2
	OPENBSD_3_2_BASE:1.9
	OPENBSD_3_1:1.7.0.2
	OPENBSD_3_1_BASE:1.7
	UBC_SYNC_B:1.9
	UBC:1.6.0.4
	UBC_BASE:1.6
	OPENBSD_3_0:1.6.0.2
	OPENBSD_3_0_BASE:1.6
	OPENBSD_2_9_BASE:1.5
	OPENBSD_2_9:1.5.0.4
	OPENBSD_2_8:1.5.0.2
	OPENBSD_2_8_BASE:1.5
	OPENBSD_2_7:1.4.0.12
	OPENBSD_2_7_BASE:1.4
	SMP:1.4.0.10
	SMP_BASE:1.4
	kame_19991208:1.4
	OPENBSD_2_6:1.4.0.8
	OPENBSD_2_6_BASE:1.4
	OPENBSD_2_5:1.4.0.6
	OPENBSD_2_5_BASE:1.4
	OPENBSD_2_4:1.4.0.4
	OPENBSD_2_4_BASE:1.4
	OPENBSD_2_3:1.4.0.2
	OPENBSD_2_3_BASE:1.4
	OPENBSD_2_2:1.3.0.2
	OPENBSD_2_2_BASE:1.3
	OPENBSD_2_1:1.2.0.2
	OPENBSD_2_1_BASE:1.2
	OPENBSD_2_0:1.1.1.1.0.2
	OPENBSD_2_0_BASE:1.1.1.1
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@ * @;


1.15
date	2017.02.07.22.30.16;	author jmatthew;	state Exp;
branches;
next	1.14;
commitid	zOHrIfL0Sj9leJjB;

1.14
date	2014.01.19.05.01.50;	author claudio;	state Exp;
branches;
next	1.13;

1.13
date	2007.12.13.20.00.53;	author reyk;	state Exp;
branches;
next	1.12;

1.12
date	2004.02.15.11.16.08;	author markus;	state Exp;
branches;
next	1.11;

1.11
date	2003.06.02.23.28.13;	author millert;	state Exp;
branches;
next	1.10;

1.10
date	2003.02.12.14.41.07;	author jason;	state Exp;
branches;
next	1.9;

1.9
date	2002.06.09.02.11.47;	author jsyn;	state Exp;
branches;
next	1.8;

1.8
date	2002.05.24.21.53.08;	author deraadt;	state Exp;
branches;
next	1.7;

1.7
date	2002.01.12.00.51.59;	author ericj;	state Exp;
branches;
next	1.6;

1.6
date	2001.06.09.07.03.39;	author angelos;	state Exp;
branches
	1.6.4.1;
next	1.5;

1.5
date	2000.10.10.14.24.33;	author itojun;	state Exp;
branches;
next	1.4;

1.4
date	98.01.06.01.38.35;	author deraadt;	state Exp;
branches
	1.4.10.1;
next	1.3;

1.3
date	97.08.26.20.02.30;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	97.02.24.14.06.33;	author niklas;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.53.10;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.53.10;	author deraadt;	state Exp;
branches;
next	;

1.4.10.1
date	2001.05.14.22.40.06;	author niklas;	state Exp;
branches;
next	1.4.10.2;

1.4.10.2
date	2001.07.04.10.54.27;	author niklas;	state Exp;
branches;
next	1.4.10.3;

1.4.10.3
date	2002.03.06.02.15.07;	author niklas;	state Exp;
branches;
next	1.4.10.4;

1.4.10.4
date	2003.03.28.00.06.54;	author niklas;	state Exp;
branches;
next	1.4.10.5;

1.4.10.5
date	2003.06.07.11.06.08;	author ho;	state Exp;
branches;
next	1.4.10.6;

1.4.10.6
date	2004.06.05.23.11.25;	author niklas;	state Exp;
branches;
next	;

1.6.4.1
date	2002.01.31.22.55.44;	author niklas;	state Exp;
branches;
next	1.6.4.2;

1.6.4.2
date	2002.06.11.03.31.36;	author art;	state Exp;
branches;
next	1.6.4.3;

1.6.4.3
date	2003.05.19.22.40.40;	author tedu;	state Exp;
branches;
next	;


desc
@@


1.15
log
@Use percpu counters for icmp

ok dlg@@ a while ago
some input from jca@@ who wrote the same diff
@
text
@/*	$OpenBSD: icmp_var.h,v 1.14 2014/01/19 05:01:50 claudio Exp $	*/
/*	$NetBSD: icmp_var.h,v 1.8 1995/03/26 20:32:19 jtc Exp $	*/

/*
 * Copyright (c) 1982, 1986, 1993
 *	The Regents of the University of California.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 *	@@(#)icmp_var.h	8.1 (Berkeley) 6/10/93
 */

#ifndef _NETINET_ICMP_VAR_H_
#define _NETINET_ICMP_VAR_H_

/*
 * Variables related to this implementation
 * of the internet control message protocol.
 */
struct	icmpstat {
/* statistics related to icmp packets generated */
	u_long	icps_error;		/* # of calls to icmp_error */
	u_long	icps_toofreq;		/* no error because rate limiter */
	u_long	icps_oldshort;		/* no error because old ip too short */
	u_long	icps_oldicmp;		/* no error because old was icmp */
	u_long	icps_outhist[ICMP_MAXTYPE + 1];
/* statistics related to input messages processed */
	u_long	icps_badcode;		/* icmp_code out of range */
	u_long	icps_tooshort;		/* packet < ICMP_MINLEN */
	u_long	icps_checksum;		/* bad checksum */
	u_long	icps_badlen;		/* calculated bound mismatch */
	u_long	icps_reflect;		/* number of responses */
	u_long	icps_bmcastecho;	/* rejected broadcast icmps */
	u_long	icps_inhist[ICMP_MAXTYPE + 1];
};

/*
 * Names for ICMP sysctl objects
 */
#define	ICMPCTL_MASKREPL	1	/* allow replies to netmask requests */
#define ICMPCTL_BMCASTECHO	2	/* reply to icmps to broadcast/mcast */
#define ICMPCTL_ERRPPSLIMIT	3	/* ICMP error pps limitation */
#define	ICMPCTL_REDIRACCEPT	4	/* Accept redirects from routers */
#define	ICMPCTL_REDIRTIMEOUT	5	/* Remove routes added via redirects */
#define	ICMPCTL_TSTAMPREPL	6	/* allow replies to timestamp requests */
#define ICMPCTL_STATS		7	/* ICMP statistics */
#define ICMPCTL_MAXID		8

#define ICMPCTL_NAMES { \
	{ 0, 0 }, \
	{ "maskrepl", CTLTYPE_INT }, \
	{ "bmcastecho", CTLTYPE_INT }, \
	{ "errppslimit", CTLTYPE_INT }, \
	{ "rediraccept", CTLTYPE_INT }, \
	{ "redirtimeout", CTLTYPE_INT }, \
	{ "tstamprepl", CTLTYPE_INT }, \
	{ "stats", CTLTYPE_STRUCT } \
}

#define ICMPCTL_VARS { \
	NULL, \
	&icmpmaskrepl, \
	&icmpbmcastecho, \
	&icmperrppslim, \
	&icmp_rediraccept, \
	NULL, \
	&icmptstamprepl, \
	NULL \
}

#ifdef _KERNEL

#include <sys/percpu.h>

enum icmpstat_counters {
	icps_error,
	icps_toofreq,
	icps_oldshort,
	icps_oldicmp,
	icps_outhist,
	icps_badcode = icps_outhist + ICMP_MAXTYPE + 1,
	icps_tooshort,
	icps_checksum,
	icps_badlen,
	icps_reflect,
	icps_bmcastecho,
	icps_inhist,
	icps_ncounters = icps_inhist + ICMP_MAXTYPE + 1
};

extern struct cpumem *icmpcounters;

static inline void
icmpstat_inc(enum icmpstat_counters c)
{
	counters_inc(icmpcounters, c);
}

#endif /* _KERNEL */
#endif /* _NETINET_ICMP_VAR_H_ */
@


1.14
log
@Start counting droped icmp errors because the rate limit is exceeded.
OK benno@@ deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.13 2007/12/13 20:00:53 reyk Exp $	*/
d94 27
a120 1
extern struct	icmpstat icmpstat;
@


1.13
log
@implement sysctls to report IP, TCP, UDP, and ICMP statistics and
change netstat to use them instead of accessing kvm for it. more
protocols will be added later.

discussed with deraadt@@ claudio@@ gilles@@
ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.12 2004/02/15 11:16:08 markus Exp $	*/
d45 1
@


1.12
log
@switch to sysctl_int_arr(); ok itojun, henning, miod, deraadt
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.11 2003/06/02 23:28:13 millert Exp $	*/
d67 2
a68 1
#define ICMPCTL_MAXID		7
d78 1
d89 1
@


1.11
log
@Remove the advertising clause in the UCB license which Berkeley
rescinded 22 July 1999.  Proofed by myself and Theo.
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.10 2003/02/12 14:41:07 jason Exp $	*/
d77 10
@


1.10
log
@Remove commons; inspired by netbsd.
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.9 2002/06/09 02:11:47 jsyn Exp $	*/
d16 1
a16 5
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by the University of
 *	California, Berkeley and its contributors.
 * 4. Neither the name of the University nor the names of its contributors
@


1.9
log
@fix the use of "cuz" in the tree; these are all in comments

noticed by aaron@@, recommended by deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.8 2002/05/24 21:53:08 deraadt Exp $	*/
d84 1
a84 1
struct	icmpstat icmpstat;
@


1.8
log
@add net.inet.icmp.tstamprepl sysctl for timestamp control; jason@@ackley.net
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.7 2002/01/12 00:51:59 ericj Exp $	*/
d49 2
a50 2
	u_long	icps_oldshort;		/* no error 'cuz old ip too short */
	u_long	icps_oldicmp;		/* no error 'cuz old was icmp */
@


1.7
log
@
add rediraccept and redirtimeout sysctl's.
rediraccept allows one to ignore ICMP_REDIRECT
redirtimeout sets a timeout on the routing entries pretaining to
ICMP_REDIRECT, this timeout is defaulted to 10 minutes. (same as ipv6)
From NetBSD.
millert@@ ok
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.6 2001/06/09 07:03:39 angelos Exp $	*/
d70 2
a71 1
#define ICMPCTL_MAXID		6
d80 1
@


1.6
log
@Inclusion protection.
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.5 2000/10/10 14:24:33 itojun Exp $	*/
d68 3
a70 1
#define ICMPCTL_MAXID		4
d77 2
@


1.6.4.1
log
@Merge in -current, builds on i386, otherwise untested
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.7 2002/01/12 00:51:59 ericj Exp $	*/
d68 1
a68 3
#define	ICMPCTL_REDIRACCEPT	4	/* Accept redirects from routers */
#define	ICMPCTL_REDIRTIMEOUT	5	/* Remove routes added via redirects */
#define ICMPCTL_MAXID		6
a74 2
	{ "rediraccept", CTLTYPE_INT }, \
	{ "redirtimeout", CTLTYPE_INT }, \
@


1.6.4.2
log
@Sync UBC branch to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.6.4.1 2002/01/31 22:55:44 niklas Exp $	*/
d49 2
a50 2
	u_long	icps_oldshort;		/* no error because old ip too short */
	u_long	icps_oldicmp;		/* no error because old was icmp */
d70 1
a70 2
#define	ICMPCTL_TSTAMPREPL	6	/* allow replies to timestamp requests */
#define ICMPCTL_MAXID		7
a78 1
	{ "tstamprepl", CTLTYPE_INT }, \
@


1.6.4.3
log
@sync
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d84 1
a84 1
extern struct	icmpstat icmpstat;
@


1.5
log
@bring in icmp rate limitation code.
make icmp6 rate limitation to latest (uses ppsratecheck only).
(sync with netbsd)
TODO: tcp SYN rate limit?
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.4 1998/01/06 01:38:35 deraadt Exp $	*/
d39 3
d79 2
a80 1
#endif
@


1.4
log
@net.inet.icmp.bmcastecho: do not smurf to smurfing broadcast packets
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.3 1997/08/26 20:02:30 deraadt Exp $	*/
d64 2
a65 1
#define ICMPCTL_MAXID		3
d71 1
@


1.4.10.1
log
@merge in approximately 2.9 into SMP branch
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.5 2000/10/10 14:24:33 itojun Exp $	*/
d64 1
a64 2
#define ICMPCTL_ERRPPSLIMIT	3	/* ICMP error pps limitation */
#define ICMPCTL_MAXID		4
a69 1
	{ "errppslimit", CTLTYPE_INT }, \
@


1.4.10.2
log
@Merge in -current from two days ago in the SMP branch.
As usual with merges, they do not indicate progress, so do not hold
your breath for working SMP, and do not mail me and ask about the
state of it.  It has not changed.  There is work ongoing, but very, very
slowly.  The commit is done in parts as to not lock up the tree in too
big chunks at a time.
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.4.10.1 2001/05/14 22:40:06 niklas Exp $	*/
a38 3
#ifndef _NETINET_ICMP_VAR_H_
#define _NETINET_ICMP_VAR_H_

d76 1
a76 2
#endif /* _KERNEL */
#endif /* _NETINET_ICMP_VAR_H_ */
@


1.4.10.3
log
@Merge in trunk
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d68 1
a68 3
#define	ICMPCTL_REDIRACCEPT	4	/* Accept redirects from routers */
#define	ICMPCTL_REDIRTIMEOUT	5	/* Remove routes added via redirects */
#define ICMPCTL_MAXID		6
a74 2
	{ "rediraccept", CTLTYPE_INT }, \
	{ "redirtimeout", CTLTYPE_INT }, \
@


1.4.10.4
log
@Sync the SMP branch with 3.3
@
text
@d49 2
a50 2
	u_long	icps_oldshort;		/* no error because old ip too short */
	u_long	icps_oldicmp;		/* no error because old was icmp */
d70 1
a70 2
#define	ICMPCTL_TSTAMPREPL	6	/* allow replies to timestamp requests */
#define ICMPCTL_MAXID		7
a78 1
	{ "tstamprepl", CTLTYPE_INT }, \
d82 1
a82 1
extern struct	icmpstat icmpstat;
@


1.4.10.5
log
@Sync SMP branch to -current
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.4.10.4 2003/03/28 00:06:54 niklas Exp $	*/
d16 5
a20 1
 * 3. Neither the name of the University nor the names of its contributors
@


1.4.10.6
log
@Merge with the trunk
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
a76 10
}

#define ICMPCTL_VARS { \
	NULL, \
	&icmpmaskrepl, \
	&icmpbmcastecho, \
	&icmperrppslim, \
	&icmp_rediraccept, \
	NULL, \
	&icmptstamprepl, \
@


1.3
log
@indent
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.2 1997/02/24 14:06:33 niklas Exp $	*/
d55 1
d63 2
a64 1
#define ICMPCTL_MAXID		2
d69 1
@


1.2
log
@OpenBSD tags + some prototyping police
@
text
@d1 1
a1 1
/*	$OpenBSD: icmp_var.h,v 1.8 1995/03/26 20:32:19 jtc Exp $	*/
d50 1
a50 1
 	u_long	icps_badcode;		/* icmp_code out of range */
@


1.1
log
@Initial revision
@
text
@d1 1
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
