head	1.11;
access;
symbols
	OPENBSD_3_2:1.10.0.2
	OPENBSD_3_2_BASE:1.10
	OPENBSD_3_1:1.5.0.6
	OPENBSD_3_1_BASE:1.5
	OPENBSD_3_0:1.5.0.4
	OPENBSD_3_0_BASE:1.5
	OPENBSD_2_9_BASE:1.5
	OPENBSD_2_9:1.5.0.2
	OPENBSD_2_8:1.4.0.16
	OPENBSD_2_8_BASE:1.4
	OPENBSD_2_7:1.4.0.14
	OPENBSD_2_7_BASE:1.4
	OPENBSD_2_6:1.4.0.12
	OPENBSD_2_6_BASE:1.4
	OPENBSD_2_5:1.4.0.10
	OPENBSD_2_5_BASE:1.4
	OPENBSD_2_4:1.4.0.8
	OPENBSD_2_4_BASE:1.4
	OPENBSD_2_3:1.4.0.6
	OPENBSD_2_3_BASE:1.4
	OPENBSD_2_2:1.4.0.4
	OPENBSD_2_2_BASE:1.4
	OPENBSD_2_1:1.4.0.2
	OPENBSD_2_1_BASE:1.4
	OPENBSD_2_0:1.3.0.2
	OPENBSD_2_0_BASE:1.3
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@ * @;


1.11
date	2003.02.20.20.38.08;	author millert;	state dead;
branches;
next	1.10;

1.10
date	2002.05.14.18.05.39;	author millert;	state Exp;
branches;
next	1.9;

1.9
date	2002.05.13.16.12.07;	author millert;	state Exp;
branches;
next	1.8;

1.8
date	2002.05.11.23.16.44;	author millert;	state Exp;
branches;
next	1.7;

1.7
date	2002.05.11.23.02.33;	author millert;	state Exp;
branches;
next	1.6;

1.6
date	2002.05.11.21.56.54;	author millert;	state Exp;
branches;
next	1.5;

1.5
date	2000.11.17.18.40.50;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	97.03.01.23.40.09;	author millert;	state Exp;
branches;
next	1.3;

1.3
date	96.08.03.20.16.57;	author millert;	state Exp;
branches;
next	1.2;

1.2
date	96.06.26.05.31.28;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.44.54;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.44.54;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.11
log
@Sync with ISC cron-current + my at(1) integration.
The at(1) code is now more tightly integrated into the cron codebase.
@
text
@/*	$OpenBSD: panic.c,v 1.10 2002/05/14 18:05:39 millert Exp $	*/
/*	$NetBSD: panic.c,v 1.2 1995/03/25 18:13:33 glass Exp $	*/

/*
 * panic.c - terminate fast in case of error
 * Copyright (c) 1993 by Thomas Koenig
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. The name of the author(s) may not be used to endorse or promote
 *    products derived from this software without specific prior written
 *    permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR(S) ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR(S) BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

#include "at.h"
#include "panic.h"
#include "privs.h"

#ifndef lint
static const char rcsid[] = "$OpenBSD: panic.c,v 1.10 2002/05/14 18:05:39 millert Exp $";
#endif

/*
 * Something fatal has happened, print error message and exit.
 */
__dead void
panic(const char *a)
{
	(void)fprintf(stderr, "%s: %s\n", __progname, a);
	if (fcreated) {
		PRIV_START;
		unlink(atfile);
		PRIV_END;
	}

	exit(EXIT_FAILURE);
}

/*
 * Some operating system error; print error message and exit.
 */
__dead void
perr(const char *a)
{
	if (!force)
		perror(a);
	if (fcreated) {
		PRIV_START;
		unlink(atfile);
		PRIV_END;
	}

	exit(EXIT_FAILURE);
}

/*
 * Two-parameter version of perr().
 */
__dead void 
perr2(const char *a, const char *b)
{
	if (!force)
		(void)fputs(a, stderr);
	perr(b);
}

__dead void
usage(void)
{
	/* Print usage and exit.  */
	switch (program) {
	case AT:
	case CAT:
		(void)fprintf(stderr,
		    "usage: at [-bm] [-f file] [-q queue] -t time_arg\n"
		    "       at [-bm] [-f file] [-q queue] timespec\n"
		    "       at -c job [job ...]\n"
		    "       at -l [-q queue] [job ...]\n"
		    "       at -r job [job ...]\n");
		break;
	case ATQ:
		(void)fprintf(stderr,
		    "usage: atq [-cnv] [-q queue] [name...]\n");
		break;
	case ATRM:
		(void)fprintf(stderr,
		    "usage: atrm [-afi] [[job] [name] ...]\n");
		break;
	case BATCH:
		(void)fprintf(stderr,
		    "usage: batch [-m] [-f file] [-q queue] [timespec]\n");
		break;
	}
	exit(EXIT_FAILURE);
}
@


1.10
log
@Major changes:

Job names are now "runtime.queue" where runtime is when the job will run
in Unix time format.  This is what SysV at does and allows us to nuke
the .SEQ file.

Historic BSD options for atq and atrm are now implemented;
atq and atrm get their own man pages.

At no longer does anything with the -v flag.  We print the execution
time when jobs are submitted so there is no need.

Most *scanf() usage is gone (one remains in atrun).

Better sanity checks in atrun.

Random style/cleanup.

With these changes we have the best of both worlds; POSIX compliance with
the traditional BSD features.
@
text
@d1 1
a1 1
/*	$OpenBSD: panic.c,v 1.9 2002/05/13 16:12:07 millert Exp $	*/
d39 1
a39 1
static const char rcsid[] = "$OpenBSD: panic.c,v 1.9 2002/05/13 16:12:07 millert Exp $";
@


1.9
log
@Only print usage for the command that was run (at, atq, atrm, batch), not
all four.  Also differentiate between the touch(1) style time as time_arg
and the at(1) style time as timespec (which is what SUS3 does).
Instead of referring to the touch time format as POSIX time, reference
touch.  This is what SUS3 does and it is what users will know.
@
text
@d1 1
a1 1
/*	$OpenBSD: panic.c,v 1.8 2002/05/11 23:16:44 millert Exp $	*/
a28 2
/* System Headers */

d34 1
a34 2
/* Local headers */

a35 1
#include "at.h"
a37 2
/* File scope variables */

d39 1
a39 1
static const char rcsid[] = "$OpenBSD: panic.c,v 1.8 2002/05/11 23:16:44 millert Exp $";
d42 3
a44 4
/* External variables */

/* Global functions */

a47 3
	/*
	 * Something fatal has happened, print error message and exit.
	 */
d58 3
d64 2
a65 4
	/*
	 * Some operating system error; print error message and exit.
	 */
	perror(a);
d75 3
d81 2
a82 1
	(void)fputs(a, stderr);
d94 5
a98 3
		    "Usage: at [-blmrv] [-f file] [-q queue] -t time_arg\n"
		    "       at [-blmrv] [-f file] [-q queue] timespec\n"
		    "       at -c job [job ...]\n");
d101 2
a102 1
		(void)fprintf(stderr, "Usage: atq [-q queue] [-v]\n");
d105 2
a106 1
		(void)fprintf(stderr, "Usage: atrm job [job ...]\n");
d110 1
a110 1
		    "Usage: batch [-mv] [-f file] [-q queue] [timespec]\n");
@


1.8
log
@Pass -Wall and use ANSI function headers.
@
text
@d1 1
a1 1
/*	$OpenBSD: panic.c,v 1.7 2002/05/11 23:02:33 millert Exp $	*/
d45 1
a45 1
static const char rcsid[] = "$OpenBSD: panic.c,v 1.7 2002/05/11 23:02:33 millert Exp $";
d95 19
a113 7
	(void)fprintf(stderr,
	    "Usage: at [-blmrv] [-f file] [-q queue] -t [[CC]YY]MMDDhhmm[.SS]\n"
	    "       at [-blmrv] [-f file] [-q queue] time\n"
	    "       at -c job [job ...]\n"
	    "       atq [-q queue] [-v]\n"
	    "       atrm job [job ...]\n"
	    "       batch [-mv] [-f file] [-q queue]\n");
@


1.7
log
@Add POSIX -r and -t flags from FreeBSD.  The old -d option is now
deprecated and no longer documented.
Also, use __progname instead of examining argv and clean up a few minor
warnings.
@
text
@d1 1
a1 1
/*	$OpenBSD: panic.c,v 1.6 2002/05/11 21:56:54 millert Exp $	*/
d45 1
a45 1
static char rcsid[] = "$OpenBSD: panic.c,v 1.6 2002/05/11 21:56:54 millert Exp $";
d53 1
a53 2
panic(a)
	char *a;
d60 1
a60 1
		PRIV_START
d62 1
a62 1
		PRIV_END
d69 1
a69 2
perr(a)
	char *a;
d76 1
a76 1
		PRIV_START
d78 1
a78 1
		PRIV_END
d85 1
a85 2
perr2(a, b)
	char *a, *b;
@


1.6
log
@Kill -V (version) option since it has no relation to reality any more.
@
text
@d1 1
a1 1
/*	$OpenBSD: panic.c,v 1.5 2000/11/17 18:40:50 deraadt Exp $	*/
d45 1
a45 1
static char rcsid[] = "$OpenBSD: panic.c,v 1.5 2000/11/17 18:40:50 deraadt Exp $";
d52 1
a52 1
void
d59 1
a59 1
	(void)fprintf(stderr, "%s: %s\n", namep, a);
d69 1
a69 1
void
d86 1
a86 1
void 
d94 1
a94 1
void
d99 2
a100 1
	    "Usage: at [-q queue] [-f file] [-mldbv] time\n"
d104 1
a104 1
	    "       batch [-q queue] [-f file] [-mv]\n");
@


1.5
log
@sync program usage to manual page; mpech@@prosoft.org.lv
@
text
@d1 1
a1 1
/*	$OpenBSD: panic.c,v 1.4 1997/03/01 23:40:09 millert Exp $	*/
d45 1
a45 1
static char rcsid[] = "$OpenBSD: panic.c,v 1.4 1997/03/01 23:40:09 millert Exp $";
d99 5
a103 5
	    "Usage: at [-V] [-q queue] [-f file] [-mldbv] time\n"
	    "       at [-V] -c job [job ...]\n"
	    "       atq [-V] [-q queue] [-v]\n"
	    "       atrm [-V] job [job ...]\n"
	    "       batch [-V] [-q queue] [-f file] [-mv]\n");
@


1.4
log
@Merge in changes from at 2.9
@
text
@d1 1
a1 1
/*	$OpenBSD: panic.c,v 1.3 1996/08/03 20:16:57 millert Exp $	*/
d45 1
a45 1
static char rcsid[] = "$OpenBSD: panic.c,v 1.3 1996/08/03 20:16:57 millert Exp $";
d98 6
a103 5
	(void)fprintf(stderr,   "Usage: at [-V] [-q x] [-f file] [-m] time\n"
				"       at [-V] -c job [job ...]\n"
				"       atq [-V] [-q x] [-v]\n"
				"       atrm [-V] job [job ...]\n"
				"       batch [-V] [-f file] [-m]\n");
@


1.3
log
@Was runing most of the code with real and effective uid of 0, contrary
to the comments.  Fixed that and made sure unlink of job file is done
as root so it can succeed.  Also will now detect empty input.
@
text
@d1 1
a1 1
/*	$OpenBSD: panic.c,v 1.2 1996/06/26 05:31:28 deraadt Exp $	*/
a6 1
 * All rights reserved.
d20 1
a20 1
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
d45 1
a45 1
static char rcsid[] = "$OpenBSD: panic.c,v 1.2 1996/06/26 05:31:28 deraadt Exp $";
d56 4
a59 3
/* Something fatal has happened, print error message and exit.
 */
	fprintf(stderr, "%s: %s\n", namep, a);
d73 3
a75 2
/* Some operating system error; print error message and exit.
 */
d90 1
a90 1
	fprintf(stderr, "%s", a);
d97 6
a102 6
/* Print usage and exit.
*/
	fprintf(stderr, "Usage: at [-q x] [-f file] [-m] time\n"
	    "       atq [-q x] [-v]\n"
	    "       atrm [-q x] job ...\n"
	    "       batch [-f file] [-m]\n");
@


1.2
log
@rcsid
@
text
@d1 1
a1 1
/*	$OpenBSD: panic.c,v 1.2 1995/03/25 18:13:33 glass Exp $	*/
d41 1
d46 1
a46 1
static char rcsid[] = "$OpenBSD: panic.c,v 1.2 1995/03/25 18:13:33 glass Exp $";
d60 2
a61 1
	if (fcreated)
d63 2
d76 2
a77 1
	if (fcreated)
d79 2
@


1.1
log
@Initial revision
@
text
@d1 1
d45 1
a45 1
static char rcsid[] = "$NetBSD: panic.c,v 1.2 1995/03/25 18:13:33 glass Exp $";
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
