head	1.5;
access;
symbols
	OPENBSD_6_1_BASE:1.5
	OPENBSD_6_0:1.5.0.10
	OPENBSD_6_0_BASE:1.5
	OPENBSD_5_9:1.5.0.6
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.5.0.8
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.5.0.2
	OPENBSD_5_7_BASE:1.5
	OPENBSD_5_6:1.5.0.4
	OPENBSD_5_6_BASE:1.5
	OPENBSD_5_5:1.2.0.8
	OPENBSD_5_5_BASE:1.2
	OPENBSD_5_4:1.2.0.4
	OPENBSD_5_4_BASE:1.2
	OPENBSD_5_3:1.2.0.2
	OPENBSD_5_3_BASE:1.2
	OPENBSD_5_2:1.1.0.2
	OPENBSD_5_2_BASE:1.1;
locks; strict;
comment	@# @;


1.5
date	2014.04.16.14.39.06;	author zhuk;	state Exp;
branches;
next	1.4;

1.4
date	2014.04.16.10.31.27;	author zhuk;	state Exp;
branches;
next	1.3;

1.3
date	2014.03.31.13.44.04;	author ajacoutot;	state Exp;
branches;
next	1.2;

1.2
date	2012.11.09.10.55.01;	author espie;	state Exp;
branches;
next	1.1;

1.1
date	2012.07.13.11.56.13;	author espie;	state Exp;
branches;
next	;


desc
@@


1.5
log
@Whitespace tweaks before further tweaks; no objections from ajacoutot@@.
@
text
@# $OpenBSD: Library.pm,v 1.4 2014/04/16 10:31:27 zhuk Exp $

# Copyright (c) 2007-2010 Steven Mestdagh <steven@@openbsd.org>
# Copyright (c) 2012 Marc Espie <espie@@openbsd.org>
#
# Permission to use, copy, modify, and distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

use strict;
use warnings;
use feature qw(say);

use LT::LaFile;

package LT::LaFile;
sub link
{
	return LT::Linker::LaFile->new->link(@@_);
}

package LT::Linker::LaFile;
our @@ISA = qw(LT::Linker);

use LT::Util;
use LT::Trace;
use File::Basename;

sub link
{
	my ($linker, $self, $ltprog, $ltconfig, $la, $fname, $odir, $shared, 
	    $objs, $dirs, $libs, $deplibs, $libdirs, $parser, $gp) = @@_;

	tsay {"creating link command for library (linked ",
		($shared) ? "dynamically" : "statically", ")"};

	my $RPdirs = $self->{RPdirs};

	my @@libflags;
	my @@cmd;
	my $dst = ($odir eq '.') ? "$ltdir/$fname" : "$odir/$ltdir/$fname";
	if ($la =~ m/\.a$/) {
		# probably just a convenience library
		$dst = ($odir eq '.') ? "$fname" : "$odir/$fname";
	}
	my $symlinkdir = $ltdir;
	if ($odir ne '.') {
		$symlinkdir = "$odir/$ltdir";
	}
	mkdir $symlinkdir if ! -d $symlinkdir;

	my ($staticlibs, $finalorderedlibs, $args) =
	    $linker->common1($parser, $gp, $deplibs, $libdirs, $dirs, $libs);

	# static linking
	if (!$shared) {
		@@cmd = ('ar', 'cru', $dst);
		foreach my $a (@@$staticlibs) {
			if ($a =~ m/\.a$/ && $a !~ m/_pic\.a/) {
				# extract objects from archive
				my $libfile = basename($a);
				my $xdir = "$odir/$ltdir/${la}x/$libfile";
				LT::Archive->extract($xdir, $a);
				my @@kobjs = LT::Archive->get_objlist($a);
				map { $_ = "$xdir/$_"; } @@kobjs;
				push @@libflags, @@kobjs;
			}
		}
		foreach my $k (@@$finalorderedlibs) {
			my $l = $libs->{$k};
			# XXX improve test
			# this has to be done probably only with
			# convenience libraries
			next if !defined $l->{lafile};
			my $lainfo = LT::LaFile->parse($l->{lafile});
			next if ($lainfo->stringize('dlname') ne '');
			$l->resolve_library($dirs, 0, 0, ref($self));
			my $a = $l->{fullpath};
			if ($a =~ m/\.a$/ && $a !~ m/_pic\.a/) {
				# extract objects from archive
				my $libfile = basename $a;
				my $xdir = "$odir/$ltdir/${la}x/$libfile";
				LT::Archive->extract($xdir, $a);
				my @@kobjs = LT::Archive->get_objlist($a);
				map { $_ = "$xdir/$_"; } @@kobjs;
				push @@libflags, @@kobjs;
			}
		}
		push @@cmd, @@libflags if @@libflags;
		push @@cmd, @@$objs if @@$objs;
		LT::Exec->link(@@cmd);
		LT::Exec->link('ranlib', $dst);
		return;
	}

	my $tmp = [];
	while (my $k = shift @@$finalorderedlibs) {
		my $l = $libs->{$k};
		$l->resolve_library($dirs, 1, $gp->static, ref($self));
		if ($l->{dropped}) {
			# remove library if dependency on it has been dropped
			delete $libs->{$k};
		} else {
			push(@@$tmp, $k);
		}
	}
	$finalorderedlibs = $tmp;

	my @@libobjects = values %$libs;
	tsay {"libs:\n", join("\n", (keys %$libs))};
	tsay {"libfiles:\n", 
	    join("\n", map { $_->{fullpath}//'UNDEF' } @@libobjects) };

	$linker->create_symlinks($symlinkdir, $libs);
	my $prev_was_archive = 0;
	my $libcounter = 0;
	foreach my $k (@@$finalorderedlibs) {
		my $a = $libs->{$k}->{fullpath} || die "Link error: $k not found in \$libs\n";
		if ($a =~ m/\.a$/) {
			# don't make a -lfoo out of a static library
			push @@libflags, '-Wl,-whole-archive' unless $prev_was_archive;
			push @@libflags, $a;
			if ($libcounter == @@$finalorderedlibs - 1) {
				push @@libflags, '-Wl,-no-whole-archive';
			}
			$prev_was_archive = 1;
		} else {
			push @@libflags, '-Wl,-no-whole-archive' if $prev_was_archive;
			$prev_was_archive = 0;
			push @@libflags, $linker->infer_libparameter($a, $k);
		}
		$libcounter++;
	}

	# add libdirs to rpath if they are not in standard lib path
	for my $l (@@$libdirs) {
		if (!LT::OSConfig->is_search_dir($l)) {
			push @@$RPdirs, $l;
		}
	}

	my @@linkeropts = ();
	if (!$ltconfig->noshared) {
		for my $d (@@$RPdirs) {
			push(@@linkeropts, '-rpath', $d);
		}
	}

	@@cmd = @@$ltprog;
	push @@cmd, $ltconfig->sharedflag, @@{$ltconfig->picflags};
	push @@cmd, '-o', $dst;
	push @@cmd, '-pthread' if $parser->{pthread};
	push @@cmd, @@$args if $args;
	push @@cmd, @@$objs if @@$objs;
	push @@cmd, '-Wl,-whole-archive', @@$staticlibs, '-Wl,-no-whole-archive'
	    if @@$staticlibs;
	push @@cmd, "-L$symlinkdir", @@libflags if @@libflags;

	my @@e = $linker->export_symbols($ltconfig, 
	    "$odir/$ltdir/$la", $gp, @@$objs, @@$staticlibs);
	push(@@cmd, join(',', "-Wl", @@e)) if @@e;
	push @@cmd, join(',', "-Wl", @@linkeropts) if @@linkeropts;
	LT::Exec->link(@@cmd);
}

1;
@


1.4
log
@Make directory ordering in our libtool stable. Fixes quiet a few issues
ajacoutot@@, me and probably others were seeing. No fallout in bulk build.

Input from espie@@ and ajacoutot@@.
Prodding by ajacoutot@@
Bulk test by jasper@@
@
text
@d1 1
a1 1
# $OpenBSD: Library.pm,v 1.3 2014/03/31 13:44:04 ajacoutot Exp $
d164 1
a164 1
       		if @@$staticlibs;
@


1.3
log
@Match GNU libtool and properly add -rpath to the linker when linking
libraries. Until now we only did that for bin programs, but some libs
can also depend on other libs which aren't in the standard search path.

passed a full ports bulk (thanks jasper@@)
ok jasper@@ sthen@@
@
text
@d1 1
a1 1
# $OpenBSD: Library.pm,v 1.2 2012/11/09 10:55:01 espie Exp $
a142 1
	$libdirs = reverse_zap_duplicates_ref($libdirs);
a148 1
	$RPdirs = reverse_zap_duplicates_ref($RPdirs) if $RPdirs;
@


1.2
log
@*really* filter symbols on elf systems: introduce a new "export_symbols"
method that does all the work to produce the right options (one option,
so that the *.ver file contains all useful information).

Have to cater to regexp: in particular, make sure to nm on every object
and static library we might need, so we don't lose anything.

Allow for the result to be empty (since some projects use -export-symbols-regex
everywhere, *including on binaries with empty symbol lists*)

should now be clean portswise.

As usual, a non working option means lots of weird fuck-ups to fix first...

thx to millert@@ for the hint, aja,jasper,landry for comments and testing.
@
text
@d1 1
a1 1
# $OpenBSD: Library.pm,v 1.1 2012/07/13 11:56:13 espie Exp $
d45 2
d143 16
d172 1
@


1.1
log
@move stuff around some more, do not load link parts unless we are actually
linking.

(and always load basic linker class when we're actually linking)


Start making a proper "library stash class".
@
text
@d1 1
a1 1
# $OpenBSD: LaFile.pm,v 1.16 2012/07/12 19:21:00 espie Exp $
a101 8
	# dynamic linking
	my $symbolsfile;
	if ($gp->export_symbols) {
		$symbolsfile = $gp->export_symbols;
	} elsif ($gp->export_symbols_regex) {
		($symbolsfile = "$odir/$ltdir/$la") =~ s/\.la$/.exp/;
		LT::Archive->get_symbollist($symbolsfile, $gp->export_symbols_regex, $objs);
	}
d150 4
a153 1
	push @@cmd, "-Wl,-retain-symbols-file,$symbolsfile" if $symbolsfile;
@

