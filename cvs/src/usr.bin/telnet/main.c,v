head	1.36;
access;
symbols
	OPENBSD_6_0:1.36.0.4
	OPENBSD_6_0_BASE:1.36
	OPENBSD_5_9:1.36.0.2
	OPENBSD_5_9_BASE:1.36
	OPENBSD_5_8:1.30.0.8
	OPENBSD_5_8_BASE:1.30
	OPENBSD_5_7:1.30.0.2
	OPENBSD_5_7_BASE:1.30
	OPENBSD_5_6:1.30.0.4
	OPENBSD_5_6_BASE:1.30
	OPENBSD_5_5:1.22.0.4
	OPENBSD_5_5_BASE:1.22
	OPENBSD_5_4:1.20.0.14
	OPENBSD_5_4_BASE:1.20
	OPENBSD_5_3:1.20.0.12
	OPENBSD_5_3_BASE:1.20
	OPENBSD_5_2:1.20.0.10
	OPENBSD_5_2_BASE:1.20
	OPENBSD_5_1_BASE:1.20
	OPENBSD_5_1:1.20.0.8
	OPENBSD_5_0:1.20.0.6
	OPENBSD_5_0_BASE:1.20
	OPENBSD_4_9:1.20.0.4
	OPENBSD_4_9_BASE:1.20
	OPENBSD_4_8:1.20.0.2
	OPENBSD_4_8_BASE:1.20
	OPENBSD_4_7:1.19.0.2
	OPENBSD_4_7_BASE:1.19
	OPENBSD_4_6:1.17.0.4
	OPENBSD_4_6_BASE:1.17
	OPENBSD_4_5:1.16.0.8
	OPENBSD_4_5_BASE:1.16
	OPENBSD_4_4:1.16.0.6
	OPENBSD_4_4_BASE:1.16
	OPENBSD_4_3:1.16.0.4
	OPENBSD_4_3_BASE:1.16
	OPENBSD_4_2:1.16.0.2
	OPENBSD_4_2_BASE:1.16
	OPENBSD_4_1:1.15.0.14
	OPENBSD_4_1_BASE:1.15
	OPENBSD_4_0:1.15.0.12
	OPENBSD_4_0_BASE:1.15
	OPENBSD_3_9:1.15.0.10
	OPENBSD_3_9_BASE:1.15
	OPENBSD_3_8:1.15.0.8
	OPENBSD_3_8_BASE:1.15
	OPENBSD_3_7:1.15.0.6
	OPENBSD_3_7_BASE:1.15
	OPENBSD_3_6:1.15.0.4
	OPENBSD_3_6_BASE:1.15
	OPENBSD_3_5:1.15.0.2
	OPENBSD_3_5_BASE:1.15
	OPENBSD_3_4:1.14.0.2
	OPENBSD_3_4_BASE:1.14
	OPENBSD_3_3:1.13.0.6
	OPENBSD_3_3_BASE:1.13
	OPENBSD_3_2:1.13.0.4
	OPENBSD_3_2_BASE:1.13
	OPENBSD_3_1:1.13.0.2
	OPENBSD_3_1_BASE:1.13
	OPENBSD_3_0:1.11.0.2
	OPENBSD_3_0_BASE:1.11
	OPENBSD_2_9_BASE:1.10
	OPENBSD_2_9:1.10.0.2
	OPENBSD_2_8:1.9.0.4
	OPENBSD_2_8_BASE:1.9
	OPENBSD_2_7:1.9.0.2
	OPENBSD_2_7_BASE:1.9
	OPENBSD_2_6:1.7.0.6
	OPENBSD_2_6_BASE:1.7
	OPENBSD_2_5:1.7.0.4
	OPENBSD_2_5_BASE:1.7
	OPENBSD_2_4:1.7.0.2
	OPENBSD_2_4_BASE:1.7
	OPENBSD_2_3:1.6.0.2
	OPENBSD_2_3_BASE:1.6
	OPENBSD_2_2:1.4.0.4
	OPENBSD_2_2_BASE:1.4
	OPENBSD_2_1:1.4.0.2
	OPENBSD_2_1_BASE:1.4
	OPENBSD_2_0:1.3.0.2
	OPENBSD_2_0_BASE:1.3
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@ * @;


1.36
date	2015.12.06.12.00.16;	author tobias;	state Exp;
branches;
next	1.35;
commitid	CoyY8UEEpJPwBza5;

1.35
date	2015.11.19.22.01.33;	author deraadt;	state Exp;
branches;
next	1.34;
commitid	67X8Seil5rUNjQEO;

1.34
date	2015.11.13.18.05.37;	author schwarze;	state Exp;
branches;
next	1.33;
commitid	XkovvEC4BIqmUh46;

1.33
date	2015.11.13.17.13.59;	author deraadt;	state Exp;
branches;
next	1.32;
commitid	F2YeJCpXd3bTjvTz;

1.32
date	2015.11.13.17.04.48;	author deraadt;	state Exp;
branches;
next	1.31;
commitid	djH4uFvsg7Vd7Wbw;

1.31
date	2015.11.13.17.01.12;	author deraadt;	state Exp;
branches;
next	1.30;
commitid	d9ke1jbuBYVSlCUU;

1.30
date	2014.07.22.07.30.24;	author jsg;	state Exp;
branches;
next	1.29;
commitid	5F2TXUtxGWuYgYJc;

1.29
date	2014.07.20.11.20.52;	author guenther;	state Exp;
branches;
next	1.28;
commitid	vDfZnfFmji7VDagO;

1.28
date	2014.07.20.10.32.23;	author jsg;	state Exp;
branches;
next	1.27;
commitid	9XoXHCD8D3PmuHcG;

1.27
date	2014.07.20.10.18.10;	author guenther;	state Exp;
branches;
next	1.26;
commitid	g3VtcxajtWcT7VuD;

1.26
date	2014.07.20.08.12.45;	author guenther;	state Exp;
branches;
next	1.25;
commitid	qbZdS8s4KEeVt81G;

1.25
date	2014.07.20.06.39.41;	author guenther;	state Exp;
branches;
next	1.24;
commitid	2c9hYJDg2dE2R3T8;

1.24
date	2014.07.20.05.22.02;	author guenther;	state Exp;
branches;
next	1.23;
commitid	mkPeU1MBN7ewMEUq;

1.23
date	2014.07.19.23.50.38;	author guenther;	state Exp;
branches;
next	1.22;
commitid	J1fNmylmVMpKGeua;

1.22
date	2013.10.26.21.33.29;	author sthen;	state Exp;
branches;
next	1.21;

1.21
date	2013.10.21.09.12.55;	author phessler;	state Exp;
branches;
next	1.20;

1.20
date	2010.07.03.04.44.51;	author guenther;	state Exp;
branches;
next	1.19;

1.19
date	2009.10.27.23.59.44;	author deraadt;	state Exp;
branches;
next	1.18;

1.18
date	2009.08.06.22.51.52;	author sobrado;	state Exp;
branches;
next	1.17;

1.17
date	2009.06.05.00.20.46;	author claudio;	state Exp;
branches;
next	1.16;

1.16
date	2007.03.15.22.51.16;	author jmc;	state Exp;
branches;
next	1.15;

1.15
date	2003.12.28.21.53.01;	author otto;	state Exp;
branches;
next	1.14;

1.14
date	2003.06.03.02.56.18;	author millert;	state Exp;
branches;
next	1.13;

1.13
date	2002.03.22.13.49.28;	author hin;	state Exp;
branches;
next	1.12;

1.12
date	2001.11.03.00.07.53;	author hin;	state Exp;
branches;
next	1.11;

1.11
date	2001.05.25.10.24.25;	author hin;	state Exp;
branches;
next	1.10;

1.10
date	2001.01.21.22.46.37;	author aaron;	state Exp;
branches;
next	1.9;

1.9
date	99.12.15.11.16.31;	author deraadt;	state Exp;
branches;
next	1.8;

1.8
date	99.12.06.00.31.55;	author deraadt;	state Exp;
branches;
next	1.7;

1.7
date	98.05.15.03.16.38;	author art;	state Exp;
branches;
next	1.6;

1.6
date	98.04.07.20.01.10;	author art;	state Exp;
branches;
next	1.5;

1.5
date	98.03.12.04.57.35;	author art;	state Exp;
branches;
next	1.4;

1.4
date	97.01.15.23.43.20;	author millert;	state Exp;
branches;
next	1.3;

1.3
date	96.07.03.14.01.56;	author niklas;	state Exp;
branches;
next	1.2;

1.2
date	96.03.27.19.33.03;	author niklas;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.46.14;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.46.14;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.36
log
@Use __progname instead of manually handling argv[0].

ok deraadt, mmcc, tedu
@
text
@/*	$OpenBSD: main.c,v 1.35 2015/11/19 22:01:33 deraadt Exp $	*/
/*	$NetBSD: main.c,v 1.5 1996/02/28 21:04:05 thorpej Exp $	*/

/*
 * Copyright (c) 1988, 1990, 1993
 *	The Regents of the University of California.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */

#include "telnet_locl.h"

#include <sys/socket.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

int family = AF_UNSPEC;
int rtableid = -1;

/*
 * Initialize variables.
 */
void
tninit(void)
{
    init_terminal();

    init_network();

    init_telnet();

    init_sys();
}

static __dead void
usage(void)
{
	extern char *__progname;

	(void)fprintf(stderr,
	    "usage: %s [-4678acDEKLr] [-b hostalias] [-e escapechar] "
	    "[-l user]\n"
	    "\t[-n tracefile] [-V rtable] [host [port]]\n",
	    __progname);

	exit(1);
}

/*
 * main.  Parse arguments, invoke the protocol or command parser.
 */

int
main(int argc, char *argv[])
{
	int ch;
	extern char *__progname;
	char *user, *alias;
	const char *errstr;

	tninit();		/* Clear out things */

	TerminalSaveState();

	prompt = __progname;

	user = alias = NULL;

	rlogin = (strncmp(prompt, "rlog", 4) == 0) ? '~' : _POSIX_VDISABLE;

	autologin = -1;

	while ((ch = getopt(argc, argv, "4678ab:cDEe:KLl:n:rV:"))
	    != -1) {
		switch(ch) {
		case '4':
			family = AF_INET;
			break;
		case '6':
			family = AF_INET6;
			break;
		case '7':
			eight = 0;
			break;
		case '8':
			eight = 3;	/* binary output and input */
			break;
		case 'a':
			autologin = 1;
			break;
		case 'b':
			alias = optarg;
			break;
		case 'c':
			skiprc = 1;
			break;
		case 'D': {
			/* sometimes we don't want a mangled display */
			char *p;
			if((p = getenv("DISPLAY")))
				env_define("DISPLAY", (unsigned char*)p);
			break;
		}
		case 'E':
			rlogin = escape = _POSIX_VDISABLE;
			break;
		case 'e':
			set_escape_char(optarg);
			break;
		case 'K':
			autologin = 0;
			break;
		case 'L':
			eight |= 2;	/* binary output only */
			break;
		case 'l':
			autologin = -1;
			user = optarg;
			break;
		case 'n':
			SetNetTrace(optarg);
			break;
		case 'r':
			rlogin = '~';
			break;
		case 'V':
			rtableid = (int)strtonum(optarg, 0,
			    RT_TABLEID_MAX, &errstr);
			if (errstr) {
				fprintf(stderr, "%s: Warning: "
				    "-V ignored, rtable %s: %s\n",
				    prompt, errstr, optarg);
			}
			break;
		case '?':
		default:
			usage();
		}
	}

	if (rtableid >= 0)
		if (setrtable(rtableid) == -1) {
			perror("setrtable");
			exit(1);
		}

	if (pledge("stdio rpath wpath getpw dns inet tty", NULL) == -1) {
		perror("pledge");
		exit(1);
	}

	if (autologin == -1)
		autologin = (rlogin == _POSIX_VDISABLE) ? 0 : 1;

	argc -= optind;
	argv += optind;

	if (argc) {
		char *args[8], **argp = args;

		if (argc > 2)
			usage();
		*argp++ = prompt;
		if (user) {
			*argp++ = "-l";
			*argp++ = user;
		}
		if (alias) {
			*argp++ = "-b";
			*argp++ = alias;
		}
		*argp++ = argv[0];		/* host */
		if (argc > 1)
			*argp++ = argv[1];	/* port */
		*argp = NULL;

		if (setjmp(toplevel) != 0)
			Exit(0);
		if (tn(argp - args, args) == 1)
			return (0);
		else
			return (1);
	}
	(void)setjmp(toplevel);
	for (;;) {
		command(1, NULL, 0);
	}
	return 0;
}
@


1.35
log
@how did the pledge "dns" get forgotten?!?! wow..
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.34 2015/11/13 18:05:37 schwarze Exp $	*/
d80 1
d88 1
a88 4
	if ((prompt = strrchr(argv[0], '/')))
		++prompt;
	else
		prompt = argv[0];
@


1.34
log
@move pledge(2) after setrtable(2), like in nc(1);
OK deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.33 2015/11/13 17:13:59 deraadt Exp $	*/
d172 1
a172 1
	if (pledge("stdio rpath wpath getpw inet tty", NULL) == -1) {
@


1.33
log
@pledge "stdio rpath wpath getpw inet tty" at startup.   After opening
the socket and entering the main loop, pledge "stdio tty".

For my next trick, I will be adding chacha20-poly1305 support.
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.32 2015/11/13 17:04:48 deraadt Exp $	*/
a82 5
	if (pledge("stdio rpath wpath getpw inet tty", NULL) == -1) {
		perror("pledge");
		exit(1);
	}

d171 5
@


1.32
log
@Use setrtable() for the entire process, rather than doing it for the
socket later.  Same idea as in nc(1).
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.31 2015/11/13 17:01:12 deraadt Exp $	*/
d82 5
@


1.31
log
@Remove support for the debug command; noone needs setsockopt SO_DEBUG
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.30 2014/07/22 07:30:24 jsg Exp $	*/
d165 6
@


1.30
log
@use ansi style function declarations
with suggestions from and ok guenther@@
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.29 2014/07/20 11:20:52 guenther Exp $	*/
d64 1
a64 1
	    "usage: %s [-4678acDdEKLr] [-b hostalias] [-e escapechar] "
d98 1
a98 1
	while ((ch = getopt(argc, argv, "4678ab:cDdEe:KLl:n:rV:"))
a128 3
		case 'd':
			debug = 1;
			break;
@


1.29
log
@Fix array overflow in command line handling
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.28 2014/07/20 10:32:23 jsg Exp $	*/
d46 2
a47 2
    void
tninit()
d76 2
a77 4
	int
main(argc, argv)
	int argc;
	char *argv[];
@


1.28
log
@use NULL instead of 0 when dealing with pointers
ok guenther@@
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.27 2014/07/20 10:18:10 guenther Exp $	*/
d178 1
a178 1
		char *args[7], **argp = args;
@


1.27
log
@Kill lint comments; mark ExitString() as __dead
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.26 2014/07/20 08:12:45 guenther Exp $	*/
d194 1
a194 1
		*argp = 0;
d205 1
a205 1
		command(1, 0, 0);
@


1.26
log
@More encryption tentacles: intr_happened and intr_waiting vanish
Push more includes into .c files
Make ring.c only need ring.h
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.25 2014/07/20 06:39:41 guenther Exp $	*/
d58 2
a59 2
	void
usage()
a167 1
			/* NOTREACHED */
@


1.25
log
@Correctly cast to unsigned char for ctype functions/macros
Push <ctype.h> and <unistd.h> into the .c files
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.24 2014/07/20 05:22:02 guenther Exp $	*/
d35 3
@


1.24
log
@Simplify #includes, start pushing them into the .c files, eliminate
extern declarations from .c files that duplicate those in .h files,
start marking functions with __dead
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.23 2014/07/19 23:50:38 guenther Exp $	*/
d35 1
a35 4
/* These values need to be the same as defined in libtelnet/kerberos5.c */
/* Either define them in both places, or put in some common header file. */
#define OPTS_FORWARD_CREDS	0x00000002
#define OPTS_FORWARDABLE_CREDS	0x00000001
@


1.23
log
@Flense the telnet code base of unwanted ifdefs: authentication/encryption
tn3270, sgtty, pre-POSIX and other ancient system support, etc.  Brings up
to date the manpage with what we support.

ok matthieu@@ beck@@ jmc@@ millert@@ deraadt@@ okan@@
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.22 2013/10/26 21:33:29 sthen Exp $	*/
a80 2
	extern char *optarg;
	extern int optind;
@


1.22
log
@Only use setsockopt(..SO_RTABLE..) if the -V flag is given to nc/telnet,
same style as traceroute6 (change to int and use -1 as a flag, so rtable 0
can still be used as an explicit parameter).
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.21 2013/10/21 09:12:55 phessler Exp $	*/
a39 16
#ifdef KRB5
#define FORWARD
/* XXX ugly hack to setup dns-proxy stuff */
#define Authenticator asn1_Authenticator
#include <kerberosV/krb5.h>
#endif

#ifdef KRB4
#include <kerberosIV/krb.h>
#endif

#ifdef FORWARD
int forward_flags;
static int default_forward=0;
#endif

a55 4

#if defined(TN3270)
    init_3270();
#endif
d64 3
a66 8
#if defined(TN3270)
	    "usage: %s [-d] [-n filename] [-t commandname] [sysname [port]]\n",
# else
	    "usage: %s [-468acdEFfKLrx] [-b hostalias] [-e escapechar] "
	    "[-k realm]\n"
	    "\t[-l user] [-n tracefile] [-V rtable] [-X authtype] "
	    "[host [port]]\n",
#endif
a71 38

#ifdef KRB5
static void
krb5_init(void)
{
    krb5_context context;
    krb5_error_code ret;

    ret = krb5_init_context(&context);
    if (ret)
	return;

#if defined(AUTHENTICATION) && defined(KRB5) && defined(FORWARD)
    if (krb5_config_get_bool (context, NULL,
         "libdefaults", "forward", NULL)) {
           forward_flags |= OPTS_FORWARD_CREDS;
           default_forward=1;
    }
    if (krb5_config_get_bool (context, NULL,
         "libdefaults", "forwardable", NULL)) {
           forward_flags |= OPTS_FORWARDABLE_CREDS;
           default_forward=1;
    }
#endif
#ifdef  ENCRYPTION
    if (krb5_config_get_bool (context, NULL,
        "libdefaults", "encrypt", NULL)) {
          encrypt_auto(1);
          decrypt_auto(1); 
	  wantencryption = 1;
          EncryptVerbose(1);
        }
#endif

    krb5_free_context(context);
}
#endif

a85 7
#ifdef	FORWARD
	extern int forward_flags;
#endif	/* FORWARD */

#ifdef KRB5
	krb5_init();
#endif
a99 5
	/* 
	 * if AUTHENTICATION and ENCRYPTION is set autologin will be
	 * set to true after the getopt switch; unless the -K option is
	 * passed 
	 */
d102 1
a102 1
	while ((ch = getopt(argc, argv, "4678DEKLS:X:ab:cde:fFk:l:n:rt:V:x"))
d111 3
d117 8
a124 2
		case '7':
			eight = 0;
d133 3
a135 1

d139 3
a142 1
#ifdef	AUTHENTICATION
a143 1
#endif
a147 81
		case 'S':
		    {
#ifdef	HAS_GETTOS
			extern int tos;

			if ((tos = parsetos(optarg, "tcp")) < 0)
				fprintf(stderr, "%s%s%s%s\n",
					prompt, ": Bad TOS argument '",
					optarg,
					"; will try to use default TOS");
#else
			fprintf(stderr,
			   "%s: Warning: -S ignored, no parsetos() support.\n",
								prompt);
#endif
		    }
			break;
		case 'X':
#ifdef	AUTHENTICATION
			auth_disable_name(optarg);
#endif
			break;
		case 'a':
			autologin = 1;
			break;
		case 'c':
			skiprc = 1;
			break;
		case 'd':
			debug = 1;
			break;
		case 'e':
			set_escape_char(optarg);
			break;
		case 'f':
#if defined(AUTHENTICATION) && defined(KRB5) && defined(FORWARD)
			if ((forward_flags & OPTS_FORWARD_CREDS) &&
			    !default_forward) {
			    fprintf(stderr,
				    "%s: Only one of -f and -F allowed.\n",
				    prompt);
			    usage();
			}
			forward_flags |= OPTS_FORWARD_CREDS;
#else
			fprintf(stderr,
			 "%s: Warning: -f ignored, no Kerberos V5 support.\n",
				prompt);
#endif
			break;
		case 'F':
#if defined(AUTHENTICATION) && defined(KRB5) && defined(FORWARD)
			if ((forward_flags & OPTS_FORWARD_CREDS) &&
			    !default_forward) {
			    fprintf(stderr,
				    "%s: Only one of -f and -F allowed.\n",
				    prompt);
			    usage();
			}
			forward_flags |= OPTS_FORWARD_CREDS;
			forward_flags |= OPTS_FORWARDABLE_CREDS;
#else
			fprintf(stderr,
			 "%s: Warning: -F ignored, no Kerberos V5 support.\n",
				prompt);
#endif
			break;
		case 'k':
#if defined(AUTHENTICATION) && defined(KRB4)
		    {
			extern char *dest_realm, dst_realm_buf[];
			extern int dst_realm_sz;
			dest_realm = dst_realm_buf;
			(void)strncpy(dest_realm, optarg, dst_realm_sz);
		    }
#else
			fprintf(stderr,
			   "%s: Warning: -k ignored, no Kerberos V4 support.\n",
								prompt);
#endif
			break;
a151 3
		case 'b':
			alias = optarg;
			break;
d153 1
a153 14
#if defined(TN3270) && defined(unix)
			/* distinguish between "-n oasynch" and "-noasynch" */
			if (argv[optind - 1][0] == '-' && argv[optind - 1][1]
			    == 'n' && argv[optind - 1][2] == 'o') {
				if (!strcmp(optarg, "oasynch")) {
					noasynchtty = 1;
					noasynchnet = 1;
				} else if (!strcmp(optarg, "oasynchtty"))
					noasynchtty = 1;
				else if (!strcmp(optarg, "oasynchnet"))
					noasynchnet = 1;
			} else
#endif	/* defined(TN3270) && defined(unix) */
				SetNetTrace(optarg);
a157 10
		case 't':
#if defined(TN3270) && defined(unix)
			(void)strlcpy(tline, optarg, sizeof tline);
			transcom = tline;
#else
			fprintf(stderr,
			   "%s: Warning: -t ignored, no TN3270 support.\n",
								prompt);
#endif
			break;
a166 12
		case 'x':
#ifdef ENCRYPTION
			encrypt_auto(1);
			decrypt_auto(1);
			wantencryption = 1;
			EncryptVerbose(1);
#else
			fprintf(stderr,
			    "%s: Warning: -x ignored, no ENCRYPT support.\n",
								prompt);
#endif
			break;
a173 11
	if (autologin == -1) {
#if defined(AUTHENTICATION)
		if(check_krb4_tickets() || check_krb5_tickets())
			autologin = 1;
#endif
#if defined(ENCRYPTION)
		encrypt_auto(1);
		decrypt_auto(1);
#endif
	}

d208 1
a208 6
#ifdef TN3270
		if (shell_active)
			shell_continue();
		else
#endif
			command(1, 0, 0);
@


1.21
log
@Oups, a little bit overzealous.  If we "route -T4 exec telnet foo", then
make sure telnet runs in rdomain 4 as expected.  Same for nc.
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.20 2010/07/03 04:44:51 guenther Exp $	*/
d57 1
a57 1
u_int rtableid;
a175 1
	rtableid = getrtable();
d329 1
a329 1
			rtableid = (unsigned int)strtonum(optarg, 0,
@


1.20
log
@Fix the naming of interfaces and variables for rdomains and rtables
and make it possible to bind sockets (including listening sockets!)
to rtables and not just rdomains.  This changes the name of the
system calls, socket option, and ioctl.  After building with this
you should remove the files /usr/share/man/cat2/[gs]etrdomain.0.

Since this removes the existing [gs]etrdomain() system calls, the
libc major is bumped.

Written by claudio@@, criticized^Wcritiqued by me
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.19 2009/10/27 23:59:44 deraadt Exp $	*/
d176 1
@


1.19
log
@rcsid[] and sccsid[] and copyright[] are essentially unmaintained (and
unmaintainable).  these days, people use source.  these id's do not provide
any benefit, and do hurt the small install media
(the 33,000 line diff is essentially mechanical)
ok with the idea millert, ok dms
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.18 2009/08/06 22:51:52 sobrado Exp $	*/
d57 1
a57 1
u_int rdomain;
d89 1
a89 1
	    "\t[-l user] [-n tracefile] [-V rdomain] [-X authtype] "
d329 1
a329 1
			rdomain = (unsigned int)strtonum(optarg, 0,
d332 2
a333 2
				fprintf(stderr, 
				    "%s: Warning: -R ignored, rdomain %s: %s\n",
@


1.18
log
@fix typo in argument name for a recently added option.
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.17 2009/06/05 00:20:46 claudio Exp $	*/
a31 6

#ifndef lint
static char copyright[] =
"@@(#) Copyright (c) 1988, 1990, 1993\n\
	The Regents of the University of California.  All rights reserved.\n";
#endif /* not lint */
@


1.17
log
@Last but not least. Telnet -V rdomain to connect to systems in other routing
domains.
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.16 2007/03/15 22:51:16 jmc Exp $	*/
d95 1
a95 1
	    "\t[-l user] [-n tracefile] [-V rdoamin] [-X authtype] "
@


1.16
log
@telnet.1: sort options; from Igor Sobrado

main.c: whack most of usage(), and have different usage() depending
whether this is invoked as telnet or tn3270;
help otto; ok millert
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.15 2003/12/28 21:53:01 otto Exp $	*/
d63 1
d95 2
a96 1
	    "\t[-l user] [-n tracefile] [-X authtype] [host [port]]\n",
d154 1
d183 1
a183 1
	while ((ch = getopt(argc, argv, "4678DEKLS:X:ab:cde:fFk:l:n:rt:x"))
d333 9
@


1.15
log
@Introduce -4 and -6: options to force usage of IPv4 or IPv6 only.
From PR 1974.

ok henning@@ jose@@
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.14 2003/06/03 02:56:18 millert Exp $	*/
d86 5
a90 13
	fprintf(stderr, "Usage: %s %s%s%s%s\n",
	    prompt,
#ifdef	AUTHENTICATION
	    "[-4] [-6] [-8] [-E] [-K] [-L] [-S tos] [-X atype] [-a] [-c] [-d]",
	    "\n\t[-e char] [-k realm] [-l user] [-f/-F] [-n tracefile] [-b hostalias] ",
#else
	    "[-4] [-6] [-8] [-E] [-L] [-S tos] [-a] [-c] [-d] [-e char]",
	    "\n\t[-l user][-n tracefile] [-b hostalias] ",
#endif
	    "\n\t"
#if defined(TN3270) && defined(unix)
# ifdef AUTHENTICATION
	    "[-noasynch] [-noasynctty] [-noasyncnet] [-r] [-t transcom]\n\t",
d92 3
a94 4
	    "[-noasynch] [-noasynctty] [-noasyncnet] [-r] [-t transcom]\n\t",
# endif
#else
	    "[-r] ",
d96 2
a97 4
#ifdef ENCRYPTION
	    "[-x] "
#endif
	    "[host-name [port]]");
@


1.14
log
@Remove the advertising clause in the UCB license which Berkeley
rescinded 22 July 1999.  Proofed by myself and Theo.
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.13 2002/03/22 13:49:28 hin Exp $	*/
d62 2
d89 2
a90 2
	    "[-8] [-E] [-K] [-L] [-S tos] [-X atype] [-a] [-c] [-d] [-e char]",
	    "\n\t[-k realm] [-l user] [-f/-F] [-n tracefile] [-b hostalias ] ",
d92 2
a93 2
	    "[-8] [-E] [-L] [-S tos] [-a] [-c] [-d] [-e char] [-l user]",
	    "\n\t[-n tracefile] [-b hostalias ] ",
d95 1
d98 1
a98 1
	    "[-noasynch] [-noasynctty]\n\t[-noasyncnet] [-r] [-t transcom] ",
d100 1
a100 1
	    "[-noasynch] [-noasynctty] [-noasyncnet] [-r]\n\t[-t transcom]",
a104 1
	    "\n\t"
d191 2
a192 1
	while ((ch = getopt(argc, argv, "78DEKLS:X:ab:cde:fFk:l:n:rt:x")) != -1) {
d194 6
@


1.13
log
@Telnet encryption warning messages, taken from kth-krb4-1.1.1.

(krb4-1.1.1 will be imported after release)

Noone bothered to look at this, but I've used this for a couple of weeks,
and i really want this to go in before release.
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.12 2001/11/03 00:07:53 hin Exp $	*/
d16 1
a16 5
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by the University of
 *	California, Berkeley and its contributors.
 * 4. Neither the name of the University nor the names of its contributors
@


1.12
log
@Telnet client shouldn't say it does Kerberos unless there actually exists
a krb4 or krb5 ticket file.
ok art@@
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.11 2001/05/25 10:24:25 hin Exp $	*/
d143 1
d341 1
d358 2
a359 2
	    if(check_krb4_tickets() || check_krb5_tickets())
		autologin = 1;
d366 1
a366 1
	
@


1.11
log
@KerberosV support from Heimdal.
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.10 2001/01/21 22:46:37 aaron Exp $	*/
d356 1
@


1.10
log
@oflow fix in rev 1.8 was wrong; mjl@@netbsd.org
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.9 1999/12/15 11:16:31 deraadt Exp $	*/
d50 1
a50 1
#if KRB5
d52 3
d61 5
d114 37
d168 4
d255 2
a256 1
			if (forward_flags & OPTS_FORWARD_CREDS) {
d271 2
a272 1
			if (forward_flags & OPTS_FORWARD_CREDS) {
d354 1
a354 5
#ifdef KRB4
	{
		char realm[REALM_SZ];

		if (krb_get_lrealm(realm, 0) != KSUCCESS) {
d356 1
a356 5
			auth_disable_name("KERBEROS_V4");
#endif
		} else if (autologin == -1) {
#if defined(AUTHENTICATION)
			autologin = 1;
d359 2
a360 2
			encrypt_auto(1);
			decrypt_auto(1);
a361 1
		}
d363 1
a363 2
#endif /* KRB4 */

@


1.9
log
@usage cleanup
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.8 1999/12/06 00:31:55 deraadt Exp $	*/
d277 1
a278 1
			(void)strlcpy(transcom, optarg, sizeof transcom);
@


1.8
log
@oflow
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.7 1998/05/15 03:16:38 art Exp $	*/
d84 1
a84 1
	    "\n\t[-k realm] [-l user] [-f/-F] [-n tracefile] [-b hostalias ]",
d87 1
a87 1
	    "\n\t[-n tracefile] [-b hostalias ]",
d98 1
d100 1
a100 4
	    "[-x] [host-name [port]]"
#else

	    "[host-name [port]]"
d102 1
a102 1
	);
@


1.7
log
@cleanup warnings.
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.6 1998/04/07 20:01:10 art Exp $	*/
d280 1
a280 1
			(void)strcpy(transcom, optarg);
@


1.6
log
@ - show usage for the encrypt command when there are no arguments.
 - don't default to autologin and autoencrypt when kerberos is disabled.
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.5 1998/03/12 04:57:35 art Exp $	*/
d112 1
a112 1

d366 1
@


1.5
log
@encryption support from kth-krb 0.9.8 (kerberos only)
plus some tweaks for better binary/8-bit support.
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.4 1997/01/15 23:43:20 millert Exp $	*/
d54 4
d252 1
a252 6
			if(autologin == 0){
				fprintf(stderr, "%s: Warning: -K ignored\n", 
					prompt);
				autologin = -1;
                 }

d305 9
a313 1
	if (autologin == -1) {          /* esc@@magic.fi; force  */
d315 1
a315 1
		autologin = 1;
d318 2
a319 2
		encrypt_auto(1);
		decrypt_auto(1);
d321 1
d323 1
@


1.4
log
@getopt(3) returns -1 when out of args, not EOF, whee!
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.3 1996/07/03 14:01:56 niklas Exp $	*/
d43 1
a43 14
#ifndef lint
#if 0
static char sccsid[] = "@@(#)main.c	8.3 (Berkeley) 5/30/95";
static char rcsid[] = "$NetBSD: main.c,v 1.5 1996/02/28 21:04:05 thorpej Exp $";
#else
static char rcsid[] = "$OpenBSD: main.c,v 1.3 1996/07/03 14:01:56 niklas Exp $";
#endif
#endif /* not lint */

#include <sys/types.h>

#include "ring.h"
#include "externs.h"
#include "defines.h"
d50 1
a50 1
#if 0
d94 4
d99 1
d116 1
a116 1
	char *user, *alias, *strrchr();
a121 3
#if	defined(CRAY) && !defined(__STDC__)
	_setlist_init();	/* Work around compiler bug */
#endif
d125 1
a125 1
	if (prompt = strrchr(argv[0], '/'))
d133 6
d141 1
a141 1
	while ((ch = getopt(argc, argv, "8EKLS:X:ab:cde:fFk:l:n:rt:x")) != -1) {
d146 11
d236 2
a237 1
			extern char *dest_realm, dst_realm_buf[], dst_realm_sz;
d248 6
a253 1
			autologin = 1;
d289 5
d297 1
d305 11
@


1.3
log
@Add a -b option that takes a hostname or IP-address as an argument.
This address is bound to the local socket of the TCP connection and is
useful for talking to services which does authentication based on IP-
addresses.
@
text
@d1 1
a1 1
/*	$OpenBSD: main.c,v 1.2 1996/03/27 19:33:03 niklas Exp $	*/
d48 1
a48 1
static char rcsid[] = "$OpenBSD: main.c,v 1.2 1996/03/27 19:33:03 niklas Exp $";
d146 1
a146 1
	while ((ch = getopt(argc, argv, "8EKLS:X:ab:cde:fFk:l:n:rt:x")) != EOF) {
@


1.2
log
@From NetBSD: merge of 960317
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d48 1
a48 1
static char rcsid[] = "$OpenBSD$";
d93 1
a93 1
	    "\n\t[-k realm] [-l user] [-f/-F] [-n tracefile] ",
d96 1
a96 1
	    "\n\t[-n tracefile]",
d124 1
a124 1
	char *user, *strrchr();
d141 1
a141 1
	user = NULL;
d146 1
a146 1
	while ((ch = getopt(argc, argv, "8EKLS:X:acde:fFk:l:n:rt:x")) != EOF) {
d244 3
d302 4
@


1.1
log
@Initial revision
@
text
@d1 3
d5 2
a6 2
 * Copyright (c) 1988, 1990 Regents of the University of California.
 * All rights reserved.
d38 3
a40 3
char copyright[] =
"@@(#) Copyright (c) 1988, 1990 Regents of the University of California.\n\
 All rights reserved.\n";
d44 6
a49 2
/* from: static char sccsid[] = "@@(#)main.c	5.5 (Berkeley) 12/18/92"; */
static char *rcsid = "$Id: main.c,v 1.3 1994/02/25 03:00:29 cgd Exp $";
d60 2
a61 2
#define OPTS_FORWARD_CREDS           0x00000002
#define OPTS_FORWARDABLE_CREDS       0x00000001
d76 1
a76 1
    
d92 2
a93 2
	    " [-8] [-E] [-K] [-L] [-X atype] [-a] [-d] [-e char] [-k realm]",
	    "\n\t[-l user] [-f/-F] [-n tracefile] ",
d95 2
a96 2
	    " [-8] [-E] [-L] [-a] [-d] [-e char] [-l user] [-n tracefile]",
	    "\n\t",
d100 1
a100 1
	    "[-noasynch] [-noasynctty] [-noasyncnet]\n\t[-r] [-t transcom] ",
d102 1
a102 1
	    "[-noasynch] [-noasynctty] [-noasyncnet] [-r] [-t transcom]\n\t",
d199 1
a199 1
			    fprintf(stderr, 
d207 1
a207 1
			 "%s: Warning: -f ignored, no Kerberos V5 support.\n", 
d214 1
a214 1
			    fprintf(stderr, 
d223 1
a223 1
			 "%s: Warning: -F ignored, no Kerberos V5 support.\n", 
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@

