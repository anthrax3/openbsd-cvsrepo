head	1.18;
access;
symbols
	OPENBSD_6_2_BASE:1.18
	OPENBSD_6_1:1.17.0.20
	OPENBSD_6_1_BASE:1.17
	OPENBSD_6_0:1.17.0.16
	OPENBSD_6_0_BASE:1.17
	OPENBSD_5_9:1.17.0.12
	OPENBSD_5_9_BASE:1.17
	OPENBSD_5_8:1.17.0.14
	OPENBSD_5_8_BASE:1.17
	OPENBSD_5_7:1.17.0.6
	OPENBSD_5_7_BASE:1.17
	OPENBSD_5_6:1.17.0.10
	OPENBSD_5_6_BASE:1.17
	OPENBSD_5_5:1.17.0.8
	OPENBSD_5_5_BASE:1.17
	OPENBSD_5_4:1.17.0.4
	OPENBSD_5_4_BASE:1.17
	OPENBSD_5_3:1.17.0.2
	OPENBSD_5_3_BASE:1.17
	OPENBSD_5_2:1.15.0.16
	OPENBSD_5_2_BASE:1.15
	OPENBSD_5_1_BASE:1.15
	OPENBSD_5_1:1.15.0.14
	OPENBSD_5_0:1.15.0.12
	OPENBSD_5_0_BASE:1.15
	OPENBSD_4_9:1.15.0.10
	OPENBSD_4_9_BASE:1.15
	OPENBSD_4_8:1.15.0.8
	OPENBSD_4_8_BASE:1.15
	OPENBSD_4_7:1.15.0.4
	OPENBSD_4_7_BASE:1.15
	OPENBSD_4_6:1.15.0.6
	OPENBSD_4_6_BASE:1.15
	OPENBSD_4_5:1.15.0.2
	OPENBSD_4_5_BASE:1.15
	OPENBSD_4_4:1.14.0.6
	OPENBSD_4_4_BASE:1.14
	OPENBSD_4_3:1.14.0.4
	OPENBSD_4_3_BASE:1.14
	OPENBSD_4_2:1.14.0.2
	OPENBSD_4_2_BASE:1.14
	OPENBSD_4_1:1.13.0.16
	OPENBSD_4_1_BASE:1.13
	OPENBSD_4_0:1.13.0.14
	OPENBSD_4_0_BASE:1.13
	OPENBSD_3_9:1.13.0.12
	OPENBSD_3_9_BASE:1.13
	OPENBSD_3_8:1.13.0.10
	OPENBSD_3_8_BASE:1.13
	OPENBSD_3_7:1.13.0.8
	OPENBSD_3_7_BASE:1.13
	OPENBSD_3_6:1.13.0.6
	OPENBSD_3_6_BASE:1.13
	OPENBSD_3_5:1.13.0.4
	OPENBSD_3_5_BASE:1.13
	OPENBSD_3_4:1.13.0.2
	OPENBSD_3_4_BASE:1.13
	OPENBSD_3_3:1.11.0.6
	OPENBSD_3_3_BASE:1.11
	OPENBSD_3_2:1.11.0.4
	OPENBSD_3_2_BASE:1.11
	OPENBSD_3_1:1.11.0.2
	OPENBSD_3_1_BASE:1.11
	OPENBSD_3_0:1.10.0.6
	OPENBSD_3_0_BASE:1.10
	OPENBSD_2_9_BASE:1.10
	OPENBSD_2_9:1.10.0.4
	OPENBSD_2_8:1.10.0.2
	OPENBSD_2_8_BASE:1.10
	OPENBSD_2_7:1.9.0.2
	OPENBSD_2_7_BASE:1.9
	OPENBSD_2_6:1.8.0.6
	OPENBSD_2_6_BASE:1.8
	OPENBSD_2_5:1.8.0.4
	OPENBSD_2_5_BASE:1.8
	OPENBSD_2_4:1.8.0.2
	OPENBSD_2_4_BASE:1.8
	OPENBSD_2_3:1.7.0.2
	OPENBSD_2_3_BASE:1.7
	OPENBSD_2_2:1.6.0.4
	OPENBSD_2_2_BASE:1.6
	OPENBSD_2_1:1.6.0.2
	OPENBSD_2_1_BASE:1.6
	OPENBSD_2_0:1.4.0.2
	OPENBSD_2_0_BASE:1.4
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@# @;


1.18
date	2017.06.05.14.33.42;	author espie;	state Exp;
branches;
next	1.17;
commitid	HVF7DW6DvKwU4n0O;

1.17
date	2012.08.30.22.06.43;	author halex;	state Exp;
branches;
next	1.16;

1.16
date	2012.08.29.16.51.12;	author guenther;	state Exp;
branches;
next	1.15;

1.15
date	2008.08.28.08.39.44;	author jmc;	state Exp;
branches;
next	1.14;

1.14
date	2007.08.06.19.16.06;	author sobrado;	state Exp;
branches;
next	1.13;

1.13
date	2003.07.16.09.38.01;	author otto;	state Exp;
branches;
next	1.12;

1.12
date	2003.06.03.02.56.13;	author millert;	state Exp;
branches;
next	1.11;

1.11
date	2002.02.25.03.37.45;	author pvalchev;	state Exp;
branches;
next	1.10;

1.10
date	2000.07.23.22.22.07;	author millert;	state Exp;
branches;
next	1.9;

1.9
date	2000.02.10.11.39.48;	author d;	state Exp;
branches;
next	1.8;

1.8
date	98.09.02.06.40.07;	author deraadt;	state Exp;
branches;
next	1.7;

1.7
date	97.12.12.09.19.59;	author deraadt;	state Exp;
branches;
next	1.6;

1.6
date	97.01.25.14.27.44;	author niklas;	state Exp;
branches;
next	1.5;

1.5
date	97.01.25.08.47.56;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	96.09.30.16.55.20;	author bitblt;	state Exp;
branches;
next	1.3;

1.3
date	96.09.16.01.20.02;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	96.06.26.05.37.07;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.45.47;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.45.47;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.18
log
@explicitly pass -w since clang -M doesn't imply it.

okay millert@@
@
text
@#!/bin/sh -
#
#	$OpenBSD: mkdep.gcc.sh,v 1.17 2012/08/30 22:06:43 halex Exp $
#	$NetBSD: mkdep.gcc.sh,v 1.9 1994/12/23 07:34:59 jtc Exp $
#
# Copyright (c) 1991, 1993
#	The Regents of the University of California.  All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. Neither the name of the University nor the names of its contributors
#    may be used to endorse or promote products derived from this software
#    without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.
#
#	@@(#)mkdep.gcc.sh	8.1 (Berkeley) 6/6/93
#

#
# Scan for a -o option in the arguments and record the filename given.
# This is needed, since "cc -M -o out" writes to the file "out", not to
# stdout.
#
scanfordasho() {
	while [ $# != 0 ]
	do case "$1" in
		-o)	
			file="$2"; shift; shift ;;
		-o*)
			file="${1#-o}"; shift ;;
		*)
			shift ;;
		esac
	done
}

D=.depend			# default dependency file is .depend
append=0
pflag=

while :
	do case "$1" in
		# -a appends to the depend file
		-a)
			append=1
			shift ;;

		# -f allows you to select a makefile name
		-f)
			D=$2
			shift; shift ;;

		# the -p flag produces "program: program.c" style dependencies
		# so .o's don't get produced
		-p)
			pflag=p
			shift ;;
		*)
			break ;;
	esac
done

if [ $# = 0 ] ; then
	echo 'usage: mkdep [-ap] [-f file] [flags] file ...'
	exit 1
fi

scanfordasho "$@@"

TMP=`mktemp /tmp/mkdep.XXXXXXXXXX` || exit 1

trap 'rm -f $TMP ; trap 2 ; kill -2 $$' 1 2 3 13 15

if [ "x$file" = x ]; then
	${CC:-cc} -M -w "$@@" > $TMP
else
	${CC:-cc} -M -w "$@@" && cat -- "$file" > $TMP
fi

if [ $? != 0 ]; then
	echo 'mkdep: compile failed.'
	rm -f $TMP
	exit 1
fi

postproc() {
	in=$1
	if [ x$pflag = x ]; then
		sed -e 's; \./; ;g' $in
	else
		sed -e 's;\.o[ ]*:; :;' -e 's; \./; ;g' $in
	fi
}

if [ $append = 1 ]; then
	postproc $TMP >> $D
	if [ $? != 0 ]; then
		echo 'mkdep: append failed.'
		rm -f $TMP
		exit 1
	fi
else
	postproc $TMP > $D
	if [ $? != 0 ]; then
		echo 'mkdep: rename failed.'
		rm -f $TMP
		exit 1
	fi
fi

rm -f $TMP
exit 0
@


1.17
log
@fix typo in last commit

"obviously correct" guenther@@
@
text
@d3 1
a3 1
#	$OpenBSD: mkdep.gcc.sh,v 1.16 2012/08/29 16:51:12 guenther Exp $
d92 1
a92 1
	${CC:-cc} -M "$@@" > $TMP
d94 1
a94 1
	${CC:-cc} -M "$@@" && cat -- "$file" > $TMP
@


1.16
log
@Test the exit status of the compiler by pulling it out the pipeline, so
that mkdep can fail if the compiler does.

Patch from Gerhard Roth (Gerhard_Roth at genua.de)
ok halex@@
@
text
@d3 1
a3 1
#	$OpenBSD: mkdep.gcc.sh,v 1.15 2008/08/28 08:39:44 jmc Exp $
d120 1
a120 1
	postprocd $TMP > $D
@


1.15
log
@typo; from hyjial
ok otto
@
text
@d3 1
a3 1
#	$OpenBSD: mkdep.gcc.sh,v 1.14 2007/08/06 19:16:06 sobrado Exp $
d92 1
a92 1
	${CC:-cc} -M "$@@"
d94 1
a94 6
	${CC:-cc} -M "$@@" && cat "$file"
fi |
if [ x$pflag = x ]; then
	sed -e 's; \./; ;g' > $TMP
else
	sed -e 's;\.o[ ]*:; :;' -e 's; \./; ;g' > $TMP
d103 9
d113 1
a113 1
	cat $TMP >> $D
d120 1
a120 1
	mv -f $TMP $D
@


1.14
log
@the ellipsis is not an optional argument; while here, sync the usage
and synopsis of commands

lots of good ideas by jmc@@

ok jmc@@
@
text
@d3 1
a3 1
#	$OpenBSD: mkdep.gcc.sh,v 1.13 2003/07/16 09:38:01 otto Exp $
d37 1
a37 1
# Scan for a -o option in the arguments are record the filename given.
@


1.13
log
@Produce correct output if the options include "-o". Remove umask
juggling that is no longer needed.
ok millert@@ henning@@
@
text
@d3 1
a3 1
#	$OpenBSD: mkdep.gcc.sh,v 1.12 2003/06/03 02:56:13 millert Exp $
d81 1
a81 1
	echo 'usage: mkdep [-p] [-f depend_file] [cc_flags] file ...'
@


1.12
log
@Remove the advertising clause in the UCB license which Berkeley
rescinded 22 July 1999.  Proofed by myself and Theo.
@
text
@d3 1
a3 1
#	$OpenBSD: mkdep.gcc.sh,v 1.11 2002/02/25 03:37:45 pvalchev Exp $
d36 18
d85 1
a85 2
um=`umask`
umask 022
a88 1
umask $um
d91 5
d97 1
a97 1
	${CC:-cc} -M "$@@" | sed -e 's; \./; ;g' > $TMP
d99 1
a99 1
	${CC:-cc} -M "$@@" | sed -e 's;\.o[ ]*:; :;' -e 's; \./; ;g' > $TMP
@


1.11
log
@use mktemp, don't bother with creating a directory when only one tmp file is
needed; ok millert, espie
@
text
@d3 1
a3 1
#	$OpenBSD: mkdep.gcc.sh,v 1.10 2000/07/23 22:22:07 millert Exp $
d17 1
a17 5
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#	This product includes software developed by the University of
#	California, Berkeley and its contributors.
# 4. Neither the name of the University nor the names of its contributors
@


1.10
log
@When moving temp file -> .depend use "mv -f"
@
text
@d3 1
a3 1
#	$OpenBSD: mkdep.gcc.sh,v 1.9 2000/02/10 11:39:48 d Exp $
a70 3
DTMP=/tmp/mkdep$$
TMP=$DTMP/mkdep

d73 2
a74 4
if ! mkdir $DTMP ; then
	echo failed to create tmp dir $DTMP
	exit 1
fi
d77 1
a77 1
trap 'rm -rf $DTMP ; trap 2 ; kill -2 $$' 1 2 3 13 15
d87 1
a87 1
	rm -rf $DTMP
d95 1
a95 1
		rm -rf $DTMP
d102 1
a102 1
		rm -rf $DTMP
d107 1
a107 1
rm -rf $DTMP
@


1.9
log
@make mkdep -p work with newer gcc. okayed a very long time ago by fries@@ (do you remember, todd?) actually uses todd's relaxed regex
@
text
@d3 1
a3 1
#	$OpenBSD: mkdep.gcc.sh,v 1.8 1998/09/02 06:40:07 deraadt Exp $
d104 1
a104 1
	mv $TMP $D
@


1.8
log
@if trapped, kill self in same way
@
text
@d3 1
a3 1
#	$OpenBSD: mkdep.gcc.sh,v 1.7 1997/12/12 09:19:59 deraadt Exp $
d87 1
a87 1
	${CC:-cc} -M "$@@" | sed -e 's;\.o :; :;' -e 's; \./; ;g' > $TMP
@


1.7
log
@if final cat or mv fails, fail out
@
text
@d3 1
a3 1
#	$OpenBSD: mkdep.gcc.sh,v 1.6 1997/01/25 14:27:44 niklas Exp $
d82 1
a82 1
trap 'rm -rf $DTMP ; exit 1' 1 2 3 13 15
@


1.6
log
@Use ${CC:-cc} instead of cc
@
text
@d3 1
a3 1
#	$OpenBSD: mkdep.gcc.sh,v 1.5 1997/01/25 08:47:56 deraadt Exp $
d80 1
d98 5
a102 1
	rm -rf $DTMP
d105 5
a109 1
	rm -rf $DTMP
d111 2
a113 3



@


1.5
log
@do not use PATH, s/gcc/cc/, mouse@@Rodents.Montreal.QC.CA netbsd pr#3138
@
text
@d3 1
a3 1
#	$OpenBSD: mkdep.gcc.sh,v 1.4 1996/09/30 16:55:20 bitblt Exp $
d84 1
a84 1
	cc -M "$@@" | sed -e 's; \./; ;g' > $TMP
d86 1
a86 1
	cc -M "$@@" | sed -e 's;\.o :; :;' -e 's; \./; ;g' > $TMP
@


1.4
log
@these scripts now always clean up their temporary directories.
@
text
@d3 1
a3 1
#	$OpenBSD: mkdep.gcc.sh,v 1.3 1996/09/16 01:20:02 deraadt Exp $
a39 3
PATH=/bin:/usr/bin:/usr/ucb
export PATH

d84 1
a84 1
	gcc -M "$@@" | sed -e 's; \./; ;g' > $TMP
d86 1
a86 1
	gcc -M "$@@" | sed -e 's;\.o :; :;' -e 's; \./; ;g' > $TMP
@


1.3
log
@kill the race; spotted by bitblt
@
text
@d3 1
a3 1
#	$OpenBSD: mkdep.gcc.sh,v 1.2 1996/06/26 05:37:07 deraadt Exp $
d103 1
d106 3
@


1.2
log
@rcsid
@
text
@d3 1
a3 1
#	$OpenBSD: mkdep.gcc.sh,v 1.9 1994/12/23 07:34:59 jtc Exp $
d74 2
a75 1
TMP=/tmp/mkdep$$
d77 8
a84 1
trap 'rm -f $TMP ; exit 1' 1 2 3 13 15
d94 1
a94 1
	rm -f $TMP
d100 1
a100 1
	rm -f $TMP
@


1.1
log
@Initial revision
@
text
@d3 1
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
