head	1.18;
access;
symbols
	OPENBSD_6_1:1.18.0.10
	OPENBSD_6_1_BASE:1.18
	OPENBSD_6_0:1.18.0.12
	OPENBSD_6_0_BASE:1.18
	OPENBSD_5_9:1.18.0.8
	OPENBSD_5_9_BASE:1.18
	OPENBSD_5_8:1.18.0.6
	OPENBSD_5_8_BASE:1.18
	OPENBSD_5_7:1.18.0.2
	OPENBSD_5_7_BASE:1.18
	OPENBSD_5_6:1.18.0.4
	OPENBSD_5_6_BASE:1.18
	OPENBSD_5_5:1.16.0.18
	OPENBSD_5_5_BASE:1.16
	OPENBSD_5_4:1.16.0.14
	OPENBSD_5_4_BASE:1.16
	OPENBSD_5_3:1.16.0.12
	OPENBSD_5_3_BASE:1.16
	OPENBSD_5_2:1.16.0.10
	OPENBSD_5_2_BASE:1.16
	OPENBSD_5_1_BASE:1.16
	OPENBSD_5_1:1.16.0.8
	OPENBSD_5_0:1.16.0.6
	OPENBSD_5_0_BASE:1.16
	OPENBSD_4_9:1.16.0.4
	OPENBSD_4_9_BASE:1.16
	OPENBSD_4_8:1.16.0.2
	OPENBSD_4_8_BASE:1.16
	OPENBSD_4_7:1.15.0.6
	OPENBSD_4_7_BASE:1.15
	OPENBSD_4_6:1.15.0.8
	OPENBSD_4_6_BASE:1.15
	OPENBSD_4_5:1.15.0.4
	OPENBSD_4_5_BASE:1.15
	OPENBSD_4_4:1.15.0.2
	OPENBSD_4_4_BASE:1.15
	OPENBSD_4_3:1.14.0.2
	OPENBSD_4_3_BASE:1.14
	OPENBSD_4_2:1.13.0.6
	OPENBSD_4_2_BASE:1.13
	OPENBSD_4_1:1.13.0.2
	OPENBSD_4_1_BASE:1.13
	OPENBSD_4_0:1.13.0.4
	OPENBSD_4_0_BASE:1.13
	OPENBSD_3_9:1.8.0.2
	OPENBSD_3_9_BASE:1.8
	OPENBSD_3_8:1.7.0.6
	OPENBSD_3_8_BASE:1.7
	OPENBSD_3_7:1.7.0.4
	OPENBSD_3_7_BASE:1.7
	OPENBSD_3_6:1.7.0.2
	OPENBSD_3_6_BASE:1.7
	OPENBSD_3_5:1.6.0.4
	OPENBSD_3_5_BASE:1.6
	OPENBSD_3_4:1.6.0.2
	OPENBSD_3_4_BASE:1.6
	OPENBSD_3_3:1.4.0.4
	OPENBSD_3_3_BASE:1.4
	OPENBSD_3_2:1.4.0.2
	OPENBSD_3_2_BASE:1.4
	OPENBSD_3_1:1.3.0.4
	OPENBSD_3_0:1.3.0.2;
locks; strict;
comment	@ * @;


1.18
date	2014.07.15.15.54.14;	author millert;	state Exp;
branches;
next	1.17;
commitid	z7plx8Gkj6l2sxem;

1.17
date	2014.06.24.01.13.21;	author djm;	state Exp;
branches;
next	1.16;
commitid	1h9UxAQmwdaqUzyX;

1.16
date	2010.06.25.08.46.17;	author djm;	state Exp;
branches;
next	1.15;

1.15
date	2008.07.02.12.36.39;	author djm;	state Exp;
branches;
next	1.14;

1.14
date	2007.08.23.03.22.16;	author djm;	state Exp;
branches;
next	1.13;

1.13
date	2006.08.05.07.52.52;	author dtucker;	state Exp;
branches;
next	1.12;

1.12
date	2006.08.03.03.34.41;	author deraadt;	state Exp;
branches;
next	1.11;

1.11
date	2006.07.09.15.15.10;	author stevesk;	state Exp;
branches;
next	1.10;

1.10
date	2006.03.25.13.17.01;	author djm;	state Exp;
branches;
next	1.9;

1.9
date	2006.03.19.18.51.18;	author deraadt;	state Exp;
branches;
next	1.8;

1.8
date	2006.02.20.17.19.54;	author stevesk;	state Exp;
branches
	1.8.2.1;
next	1.7;

1.7
date	2004.05.11.19.01.43;	author deraadt;	state Exp;
branches
	1.7.6.1;
next	1.6;

1.6
date	2003.08.26.09.58.43;	author markus;	state Exp;
branches
	1.6.2.1
	1.6.4.1;
next	1.5;

1.5
date	2003.07.31.09.21.02;	author markus;	state Exp;
branches;
next	1.4;

1.4
date	2002.06.27.10.35.47;	author deraadt;	state Exp;
branches
	1.4.2.1
	1.4.4.1;
next	1.3;

1.3
date	2002.06.19.00.27.55;	author deraadt;	state Exp;
branches
	1.3.2.1
	1.3.4.1;
next	1.2;

1.2
date	2002.05.31.11.35.15;	author markus;	state Exp;
branches;
next	1.1;

1.1
date	2002.05.25.18.51.07;	author markus;	state Exp;
branches;
next	;

1.3.2.1
date	2002.06.22.07.23.16;	author miod;	state Exp;
branches;
next	1.3.2.2;

1.3.2.2
date	2002.10.11.14.53.06;	author miod;	state Exp;
branches;
next	;

1.3.4.1
date	2002.06.26.15.52.13;	author jason;	state Exp;
branches;
next	1.3.4.2;

1.3.4.2
date	2002.10.11.14.51.52;	author miod;	state Exp;
branches;
next	;

1.4.2.1
date	2003.09.16.21.20.24;	author brad;	state Exp;
branches;
next	;

1.4.4.1
date	2003.09.16.20.50.42;	author brad;	state Exp;
branches;
next	1.4.4.2;

1.4.4.2
date	2004.03.04.18.18.15;	author brad;	state Exp;
branches;
next	;

1.6.2.1
date	2004.08.19.22.37.30;	author brad;	state Exp;
branches;
next	;

1.6.4.1
date	2004.08.19.04.13.26;	author brad;	state Exp;
branches;
next	;

1.7.6.1
date	2006.10.06.03.19.32;	author brad;	state Exp;
branches;
next	;

1.8.2.1
date	2006.09.30.04.06.50;	author brad;	state Exp;
branches;
next	;


desc
@@


1.18
log
@Add support for Unix domain socket forwarding.  A remote TCP port
may be forwarded to a local Unix domain socket and vice versa or
both ends may be a Unix domain socket.  This is a reimplementation
of the streamlocal patches by William Ahern from:
    http://www.25thandclement.com/~william/projects/streamlocal.html
OK djm@@ markus@@
@
text
@/* $OpenBSD: auth2-none.c,v 1.17 2014/06/24 01:13:21 djm Exp $ */
/*
 * Copyright (c) 2000 Markus Friedl.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

#include <sys/types.h>
#include <stdarg.h>
#include <stdio.h>

#include "xmalloc.h"
#include "key.h"
#include "hostfile.h"
#include "auth.h"
#include "packet.h"
#include "log.h"
#include "buffer.h"
#include "misc.h"
#include "servconf.h"
#include "compat.h"
#include "ssh2.h"
#ifdef GSSAPI
#include "ssh-gss.h"
#endif
#include "monitor_wrap.h"

/* import */
extern ServerOptions options;

/* "none" is allowed only one time */
static int none_enabled = 1;

static int
userauth_none(Authctxt *authctxt)
{
	none_enabled = 0;
	packet_check_eom();
	if (options.permit_empty_passwd && options.password_authentication)
		return (PRIVSEP(auth_password(authctxt, "")));
	return (0);
}

Authmethod method_none = {
	"none",
	userauth_none,
	&none_enabled
};
@


1.17
log
@New key API: refactor key-related functions to be more library-like,
existing API is offered as a set of wrappers.

with and ok markus@@

Thanks also to Ben Hawkes, David Tomaschik, Ivan Fratric, Matthew
Dempsky and Ron Bowes for a detailed review a few months ago.
@
text
@d1 1
a1 1
/* $OpenBSD: auth2-none.c,v 1.16 2010/06/25 08:46:17 djm Exp $ */
d37 1
@


1.16
log
@skip the initial check for access with an empty password when
PermitEmptyPasswords=no;
@
text
@d1 1
a1 1
/* $OpenBSD: auth2-none.c,v 1.15 2008/07/02 12:36:39 djm Exp $ */
d27 2
@


1.15
log
@Make protocol 2 MaxAuthTries behaviour a little more sensible:

Check whether client has exceeded MaxAuthTries before running
an authentication method and skip it if they have, previously it
would always allow one try (for "none" auth).

Preincrement failure count before post-auth test - previously this
checked and postincremented, also to allow one "none" try.

Together, these two changes always count the "none" auth method
which could be skipped by a malicious client (e.g. an SSH worm)
to get an extra attempt at a real auth method. They also make
MaxAuthTries=0 a useful way to block users entirely (esp. in a
sshd_config Match block).

Also, move sending of any preauth banner from "none" auth method
to the first call to input_userauth_request(), so worms that skip
the "none" method get to see it too.
@
text
@d1 1
a1 1
/* $OpenBSD: auth2-none.c,v 1.14 2007/08/23 03:22:16 djm Exp $ */
d54 1
a54 1
	if (options.password_authentication)
@


1.14
log
@Support "Banner=none" to disable displaying of the pre-login banner;
ok dtucker@@ deraadt@@
@
text
@d1 1
a1 1
/* $OpenBSD: auth2-none.c,v 1.13 2006/08/05 07:52:52 dtucker Exp $ */
a26 6
#include <sys/stat.h>
#include <sys/uio.h>

#include <fcntl.h>
#include <unistd.h>
#include <string.h>
a35 1
#include "atomicio.h"
a48 56
char *
auth2_read_banner(void)
{
	struct stat st;
	char *banner = NULL;
	size_t len, n;
	int fd;

	if ((fd = open(options.banner, O_RDONLY)) == -1)
		return (NULL);
	if (fstat(fd, &st) == -1) {
		close(fd);
		return (NULL);
	}
	if (st.st_size > 1*1024*1024) {
		close(fd);
		return (NULL);
	}

	len = (size_t)st.st_size;		/* truncate */
	banner = xmalloc(len + 1);
	n = atomicio(read, fd, banner, len);
	close(fd);

	if (n != len) {
		xfree(banner);
		return (NULL);
	}
	banner[n] = '\0';

	return (banner);
}

static void
userauth_banner(void)
{
	char *banner = NULL;

	if (options.banner == NULL ||
	    strcasecmp(options.banner, "none") == 0 ||
	    (datafellows & SSH_BUG_BANNER) != 0)
		return;

	if ((banner = PRIVSEP(auth2_read_banner())) == NULL)
		goto done;

	packet_start(SSH2_MSG_USERAUTH_BANNER);
	packet_put_cstring(banner);
	packet_put_cstring("");		/* language, unused */
	packet_send();
	debug("userauth_banner: sent");
done:
	if (banner)
		xfree(banner);
}

a53 1
	userauth_banner();
@


1.13
log
@Add headers required to build with KERBEROS5=no.  ok djm@@
@
text
@d1 1
a1 1
/* $OpenBSD: auth2-none.c,v 1.12 2006/08/03 03:34:41 deraadt Exp $ */
d32 1
d94 3
a96 1
	if (options.banner == NULL || (datafellows & SSH_BUG_BANNER))
@


1.12
log
@almost entirely get rid of the culture of ".h files that include .h files"
ok djm, sort of ok stevesk
makes the pain stop in one easy step
@
text
@d1 1
a1 1
/* $OpenBSD: auth2-none.c,v 1.11 2006/07/09 15:15:10 stevesk Exp $ */
d28 1
d31 1
@


1.11
log
@move #include <fcntl.h> out of includes.h
@
text
@d1 1
a1 1
/* $OpenBSD: auth2-none.c,v 1.10 2006/03/25 13:17:01 djm Exp $ */
a25 2
#include "includes.h"

d31 3
a34 1
#include "xmalloc.h"
d37 1
d42 3
@


1.10
log
@Put $OpenBSD$ tags back (as comments) to replace the RCSID()s that
Theo nuked - our scripts to sync -portable need them in the files
@
text
@d1 1
a1 1
/* $OpenBSD$ */
d30 2
@


1.9
log
@RCSID() can die
@
text
@d1 1
@


1.8
log
@move #include <sys/stat.h> out of includes.h; ok markus@@
@
text
@a25 1
RCSID("$OpenBSD: auth2-none.c,v 1.7 2004/05/11 19:01:43 deraadt Exp $");
@


1.8.2.1
log
@upgrade to OpenSSH 4.4
@
text
@a0 1
/* $OpenBSD: auth2-none.c,v 1.13 2006/08/05 07:52:52 dtucker Exp $ */
d25 3
a29 4
#include <sys/uio.h>

#include <fcntl.h>
#include <unistd.h>
d31 1
a32 3
#include "key.h"
#include "hostfile.h"
#include "auth.h"
a34 1
#include "buffer.h"
a38 3
#ifdef GSSAPI
#include "ssh-gss.h"
#endif
@


1.7
log
@improve some code lint did not like; djm millert ok
@
text
@d26 4
a29 1
RCSID("$OpenBSD: auth2-none.c,v 1.6 2003/08/26 09:58:43 markus Exp $");
@


1.7.6.1
log
@upgrade to OpenSSH 4.4
@
text
@a0 1
/* $OpenBSD: auth2-none.c,v 1.13 2006/08/05 07:52:52 dtucker Exp $ */
d25 2
a26 6
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/uio.h>

#include <fcntl.h>
#include <unistd.h>
d28 1
a29 3
#include "key.h"
#include "hostfile.h"
#include "auth.h"
a31 1
#include "buffer.h"
a35 3
#ifdef GSSAPI
#include "ssh-gss.h"
#endif
@


1.6
log
@fix passwd auth for 'username leaks via timing'; with djm@@, original patches from solar
@
text
@d26 1
a26 1
RCSID("$OpenBSD: auth2-none.c,v 1.5 2003/07/31 09:21:02 markus Exp $");
d49 1
a49 1
	off_t len, n;
d58 6
a63 1
	len = st.st_size;
@


1.6.2.1
log
@upgrade to OpenSSH 3.9
@
text
@d26 1
a26 1
RCSID("$OpenBSD: auth2-none.c,v 1.7 2004/05/11 19:01:43 deraadt Exp $");
d49 1
a49 1
	size_t len, n;
d58 1
a58 6
	if (st.st_size > 1*1024*1024) {
		close(fd);
		return (NULL);
	}

	len = (size_t)st.st_size;		/* truncate */
@


1.6.4.1
log
@upgrade to OpenSSH 3.9
@
text
@d26 1
a26 1
RCSID("$OpenBSD: auth2-none.c,v 1.7 2004/05/11 19:01:43 deraadt Exp $");
d49 1
a49 1
	size_t len, n;
d58 1
a58 6
	if (st.st_size > 1*1024*1024) {
		close(fd);
		return (NULL);
	}

	len = (size_t)st.st_size;		/* truncate */
@


1.5
log
@check whether passwd auth is allowd, similar to proto 1; rob@@pitman.co.za
ok henning
@
text
@d26 1
a26 1
RCSID("$OpenBSD: auth2-none.c,v 1.4 2002/06/27 10:35:47 deraadt Exp $");
d99 1
a99 1
	if (options.password_authentication && authctxt->valid)
@


1.4
log
@use xfree()
@
text
@d26 1
a26 1
RCSID("$OpenBSD: auth2-none.c,v 1.3 2002/06/19 00:27:55 deraadt Exp $");
d99 3
a101 1
	return (authctxt->valid ? PRIVSEP(auth_password(authctxt, "")) : 0);
@


1.4.2.1
log
@upgrade to OpenSSH 3.7
@
text
@d26 1
a26 1
RCSID("$OpenBSD: auth2-none.c,v 1.6 2003/08/26 09:58:43 markus Exp $");
d99 1
a99 3
	if (options.password_authentication)
		return (PRIVSEP(auth_password(authctxt, "")));
	return (0);
@


1.4.4.1
log
@upgrade to OpenSSH 3.7
@
text
@d26 1
a26 1
RCSID("$OpenBSD: auth2-none.c,v 1.6 2003/08/26 09:58:43 markus Exp $");
d99 1
a99 3
	if (options.password_authentication)
		return (PRIVSEP(auth_password(authctxt, "")));
	return (0);
@


1.4.4.2
log
@upgrade to OpenSSH 3.8upgrade to OpenSSH 3.8upgrade to OpenSSH 3.8
@
text
@@


1.3
log
@KNF done automatically while reading....
@
text
@d26 1
a26 1
RCSID("$OpenBSD: auth2-none.c,v 1.2 2002/05/31 11:35:15 markus Exp $");
d64 1
a64 1
		free(banner);
@


1.3.4.1
log
@More missing files in 3.4 merge
@
text
@d26 1
a26 1
RCSID("$OpenBSD: auth2-none.c,v 1.3 2002/06/19 00:27:55 deraadt Exp $");
@


1.3.4.2
log
@Update to OpenSSH 3.5
@
text
@d26 1
a26 1
RCSID("$OpenBSD: auth2-none.c,v 1.4 2002/06/27 10:35:47 deraadt Exp $");
d64 1
a64 1
		xfree(banner);
@


1.3.2.1
log
@Update OpenSSH to version 3.3 (with local changes, configuration files still
living in /etc and privsep user being nobody).
@
text
@d26 1
a26 1
RCSID("$OpenBSD: auth2-none.c,v 1.3 2002/06/19 00:27:55 deraadt Exp $");
@


1.3.2.2
log
@Update to OpenSSH 3.5
@
text
@d26 1
a26 1
RCSID("$OpenBSD: auth2-none.c,v 1.4 2002/06/27 10:35:47 deraadt Exp $");
d64 1
a64 1
		xfree(banner);
@


1.2
log
@move Authmethod definitons to per-method file.
@
text
@d26 1
a26 1
RCSID("$OpenBSD: auth2-none.c,v 1.1 2002/05/25 18:51:07 markus Exp $");
d68 1
a68 1
	
a90 1
	return;
@


1.1
log
@split auth2.c into one file per method; ok provos@@/deraadt@@
@
text
@d26 1
a26 1
RCSID("$OpenBSD: auth2.c,v 1.91 2002/05/13 02:37:39 itojun Exp $");
d41 3
d94 1
a94 1
int
d97 1
a97 5
	static int called = 0;

	if (called)
		return (0);
	called = 1;
d102 6
@

