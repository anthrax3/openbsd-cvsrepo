head	1.17;
access;
symbols
	OPENBSD_6_1_BASE:1.17
	OPENBSD_6_0:1.17.0.4
	OPENBSD_6_0_BASE:1.17
	OPENBSD_5_9:1.17.0.2
	OPENBSD_5_9_BASE:1.17
	OPENBSD_5_8:1.16.0.6
	OPENBSD_5_8_BASE:1.16
	OPENBSD_5_7:1.16.0.2
	OPENBSD_5_7_BASE:1.16
	OPENBSD_5_6:1.7.0.4
	OPENBSD_5_6_BASE:1.7
	OPENBSD_5_5:1.6.0.6
	OPENBSD_5_5_BASE:1.6
	OPENBSD_5_4:1.6.0.2
	OPENBSD_5_4_BASE:1.6
	OPENBSD_5_3:1.5.0.6
	OPENBSD_5_3_BASE:1.5
	OPENBSD_5_2:1.5.0.4
	OPENBSD_5_2_BASE:1.5
	OPENBSD_5_1_BASE:1.5
	OPENBSD_5_1:1.5.0.2
	OPENBSD_5_0:1.4.0.2
	OPENBSD_5_0_BASE:1.4
	OPENBSD_4_9:1.2.0.2
	OPENBSD_4_9_BASE:1.2;
locks; strict;
comment	@ * @;


1.17
date	2015.11.07.13.57.55;	author schwarze;	state Exp;
branches;
next	1.16;
commitid	UKwSq7JMt0q6KNpK;

1.16
date	2015.01.30.04.08.37;	author schwarze;	state Exp;
branches;
next	1.15;
commitid	KL58yWbJhw6UbgSB;

1.15
date	2015.01.28.17.30.37;	author schwarze;	state Exp;
branches;
next	1.14;
commitid	B9i4oMLogJsiyrd5;

1.14
date	2015.01.28.15.02.25;	author schwarze;	state Exp;
branches;
next	1.13;
commitid	Um2gz4HrZv1IOy6F;

1.13
date	2015.01.21.00.45.16;	author schwarze;	state Exp;
branches;
next	1.12;
commitid	luBZukwvZIctwZsD;

1.12
date	2015.01.14.22.44.51;	author schwarze;	state Exp;
branches;
next	1.11;
commitid	7qvZiyLLUmJiYfWk;

1.11
date	2014.12.01.08.05.02;	author schwarze;	state Exp;
branches;
next	1.10;
commitid	dkxNPoJe0koFMMLd;

1.10
date	2014.11.27.14.31.29;	author deraadt;	state Exp;
branches;
next	1.9;
commitid	je75OeVgCvwQD2St;

1.9
date	2014.10.25.14.32.07;	author schwarze;	state Exp;
branches;
next	1.8;
commitid	0lmH8qIaoxl2FlKf;

1.8
date	2014.10.16.01.10.06;	author schwarze;	state Exp;
branches;
next	1.7;
commitid	3N6FMKugsVoc1dko;

1.7
date	2014.04.20.16.44.44;	author schwarze;	state Exp;
branches;
next	1.6;

1.6
date	2013.05.31.21.37.08;	author schwarze;	state Exp;
branches;
next	1.5;

1.5
date	2011.09.18.10.25.28;	author schwarze;	state Exp;
branches;
next	1.4;

1.4
date	2011.04.24.16.22.02;	author schwarze;	state Exp;
branches;
next	1.3;

1.3
date	2011.03.20.23.36.42;	author schwarze;	state Exp;
branches;
next	1.2;

1.2
date	2011.01.25.12.24.26;	author schwarze;	state Exp;
branches;
next	1.1;

1.1
date	2011.01.04.22.28.17;	author schwarze;	state Exp;
branches;
next	;


desc
@@


1.17
log
@In private header files, __BEGIN_DECLS and __END_DECLS are pointless.
Because these work slightly differently on different systems,
they are becoming a maintenance burden in the portable version,
so delete them.

Besides, one of the chief design goals of the mandoc toolbox is to
make sure that nothing related to documentation requires C++.
Consequently, linking mandoc against any kind of C++ program would
defeat the purpose and is not supported.
I don't understand why kristaps@@ added them in the first place.
@
text
@/*	$OpenBSD: libroff.h,v 1.16 2015/01/30 04:08:37 schwarze Exp $ */
/*
 * Copyright (c) 2009, 2010, 2011 Kristaps Dzonsons <kristaps@@bsd.lv>
 * Copyright (c) 2014, 2015 Ingo Schwarze <schwarze@@openbsd.org>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

enum	tbl_part {
	TBL_PART_OPTS, /* in options (first line) */
	TBL_PART_LAYOUT, /* describing layout */
	TBL_PART_DATA, /* creating data rows */
	TBL_PART_CDATA /* continue previous row */
};

struct	tbl_node {
	struct mparse	 *parse; /* parse point */
	int		  pos; /* invocation column */
	int		  line; /* invocation line */
	enum tbl_part	  part;
	struct tbl_opts	  opts;
	struct tbl_row	 *first_row;
	struct tbl_row	 *last_row;
	struct tbl_span	 *first_span;
	struct tbl_span	 *current_span;
	struct tbl_span	 *last_span;
	struct tbl_node	 *next;
};

struct	eqn_node {
	struct eqn	  eqn;    /* syntax tree of this equation */
	struct mparse	 *parse;  /* main parser, for error reporting */
	struct eqn_node  *next;   /* singly linked list of equations */
	struct eqn_def	 *defs;   /* array of definitions */
	char		 *data;   /* source code of this equation */
	size_t		  defsz;  /* number of definitions */
	size_t		  sz;     /* length of the source code */
	size_t		  cur;    /* parse point in the source code */
	size_t		  rew;    /* beginning of the current token */
	int		  gsize;  /* default point size */
	int		  delim;  /* in-line delimiters enabled */
	char		  odelim; /* in-line opening delimiter */
	char		  cdelim; /* in-line closing delimiter */
};

struct	eqn_def {
	char		 *key;
	size_t		  keysz;
	char		 *val;
	size_t		  valsz;
};


struct tbl_node	*tbl_alloc(int, int, struct mparse *);
void		 tbl_restart(int, int, struct tbl_node *);
void		 tbl_free(struct tbl_node *);
void		 tbl_reset(struct tbl_node *);
enum rofferr	 tbl_read(struct tbl_node *, int, const char *, int);
void		 tbl_option(struct tbl_node *, int, const char *, int *);
void		 tbl_layout(struct tbl_node *, int, const char *, int);
void		 tbl_data(struct tbl_node *, int, const char *, int);
int		 tbl_cdata(struct tbl_node *, int, const char *, int);
const struct tbl_span	*tbl_span(struct tbl_node *);
int		 tbl_end(struct tbl_node **);
struct eqn_node	*eqn_alloc(int, int, struct mparse *);
enum rofferr	 eqn_end(struct eqn_node **);
void		 eqn_free(struct eqn_node *);
enum rofferr	 eqn_read(struct eqn_node **, int,
			const char *, int, int *);
@


1.16
log
@Abolish struct tbl_head and replace it by an "int col" member in
struct tbl_cell.  No functional change, minus 40 lines of code.
@
text
@d1 1
a1 1
/*	$OpenBSD: libroff.h,v 1.15 2015/01/28 17:30:37 schwarze Exp $ */
a62 1
__BEGIN_DECLS
a79 2

__END_DECLS
@


1.15
log
@* Polish tbl(7) error reporting.
* Do not print out macro names in tbl(7) data blocks.
* Like with GNU tbl, let empty tables cause a blank line.
* Avoid producing empty tables in -Tman.
@
text
@d1 1
a1 1
/*	$OpenBSD: libroff.h,v 1.14 2015/01/28 15:02:25 schwarze Exp $ */
a36 2
	struct tbl_head	 *first_head;
	struct tbl_head	 *last_head;
@


1.14
log
@For now, it can't be helped that mandoc tbl(7) ignores high-level macros,
but stop throwing away their arguments.  This fixes information loss in a
handful of Xenocara manuals, at the price of a small amount of formatting
noise creeping through.
@
text
@d1 1
a1 1
/*	$OpenBSD: libroff.h,v 1.13 2015/01/21 00:45:16 schwarze Exp $ */
d77 1
a77 1
void		 tbl_end(struct tbl_node **);
@


1.13
log
@blank lines in tables do not need special handling; simplifies code
and reduces groff/mandoc differences in base by about 1%
@
text
@d1 1
a1 1
/*	$OpenBSD: libroff.h,v 1.12 2015/01/14 22:44:51 schwarze Exp $ */
d4 1
a4 1
 * Copyright (c) 2014 Ingo Schwarze <schwarze@@openbsd.org>
d72 4
a75 4
void		 tbl_option(struct tbl_node *, int, const char *);
void		 tbl_layout(struct tbl_node *, int, const char *);
void		 tbl_data(struct tbl_node *, int, const char *);
int		 tbl_cdata(struct tbl_node *, int, const char *);
@


1.12
log
@simplify by getting rid of ROFF_ERR in tbl(7) parsing; no functional change
@
text
@d1 1
a1 1
/*	$OpenBSD: libroff.h,v 1.11 2014/12/01 08:05:02 schwarze Exp $ */
d74 1
a74 1
int		 tbl_data(struct tbl_node *, int, const char *);
@


1.11
log
@header cleanup:
* add missing forward declarations
* remove needless header inclusions
* some style unification
@
text
@d1 1
a1 1
/*	$OpenBSD: libroff.h,v 1.10 2014/11/27 14:31:29 deraadt Exp $ */
d72 2
a73 2
int		 tbl_option(struct tbl_node *, int, const char *);
int		 tbl_layout(struct tbl_node *, int, const char *);
@


1.10
log
@remove unneccessary inclusion protection; ok schwarze
@
text
@d1 1
a1 1
/*	$OpenBSD: libroff.h,v 1.9 2014/10/25 14:32:07 schwarze Exp $ */
a18 2
__BEGIN_DECLS

d64 2
@


1.9
log
@Report arguments to .EQ as an error, and simplify the code:
* drop trivial wrapper function roff_openeqn()
* drop unused first arg of function eqn_alloc()
* drop usused member "name" of struct eqn_node
@
text
@d1 1
a1 1
/*	$OpenBSD: libroff.h,v 1.8 2014/10/16 01:10:06 schwarze Exp $ */
a17 2
#ifndef LIBROFF_H
#define LIBROFF_H
a84 2

#endif /*LIBROFF_H*/
@


1.8
log
@Implement in-line equations, much needed by Xenocara manuals.
Put the steering into the roff parser rather than into the mdoc
parser such that it works for all macro languages and on both text
and macro lines.
Line breaks and blank characters generated before and after in-line
equations are not perfect yet, but let's do one thing at a time.
@
text
@d1 1
a1 1
/*	$OpenBSD$ */
d80 1
a80 1
struct eqn_node	*eqn_alloc(const char *, int, int, struct mparse *);
@


1.7
log
@KNF: case (FOO):  ->  case FOO, remove /* LINTED */ and /* ARGSUSED */,
remove trailing whitespace and blanks before tabs, improve some indenting;
no functional change
@
text
@d1 1
a1 1
/*	$Id: libroff.h,v 1.6 2013/05/31 21:37:08 schwarze Exp $ */
d4 1
d47 13
a59 10
	struct eqn_def	 *defs;
	size_t		  defsz;
	char		 *data;
	size_t		  rew;
	size_t		  cur;
	size_t		  sz;
	int		  gsize;
	struct eqn	  eqn;
	struct mparse	 *parse;
	struct eqn_node  *next;
@


1.6
log
@The name "struct tbl" was badly misleading for two reasons:
1) This struct almost exclusively contains the table options.
2) Information about the table as a whole is actually in "struct tbl_node".
Besides, "struct tbl" was almost impossible to search for.
So rename it to "struct tbl_opts".  No functional change.
@
text
@d1 1
a1 1
/*	$Id: libroff.h,v 1.5 2011/09/18 10:25:28 schwarze Exp $ */
d69 1
a69 1
enum rofferr 	 tbl_read(struct tbl_node *, int, const char *, int);
d79 1
a79 1
enum rofferr 	 eqn_read(struct eqn_node **, int, 
@


1.5
log
@sync to version 1.11.5:
adding an implementation of the eqn(7) language
by kristaps@@

So far, only .EQ/.EN blocks are handled, in-line equations are not, and
rendering is not yet very pretty, but the parser is fairly complete.
@
text
@d1 1
a1 1
/*	$Id: libroff.h,v 1.4 2011/04/24 16:22:02 schwarze Exp $ */
d34 1
a34 1
	struct tbl	  opts;
@


1.4
log
@Merge version 1.11.1:
Again lots of cleanup and maintenance work by kristaps@@.
- simplify error reporting: less function pointers, more mandoc_[v]msg
- main: split document parsing out of main.c into read.c
- roff, mdoc, man: improved recognition of control characters
- roff: better handling of if/else stack overflows
- roff: add some predefined strings for backward compatibility
- mdoc, man: empty sections are not errors
- mdoc: move delimiter handling to libmdoc
- some header restructuring and some minor features and fixes
This merge causes two minor regressions
that i will fix in separate commits right afterwards.
@
text
@d1 1
a1 1
/*	$Id: libroff.h,v 1.3 2011/03/20 23:36:42 schwarze Exp $ */
d46 7
d54 9
a62 1
	struct eqn_node	 *next;
d75 3
a77 3
void		 tbl_end(struct tbl_node *);
struct eqn_node	*eqn_alloc(int, int);
void		 eqn_end(struct eqn_node *);
d79 2
a80 1
enum rofferr 	 eqn_read(struct eqn_node **, int, const char *, int);
@


1.3
log
@Import the foundation for eqn(7) support.
Written by kristaps@@.

For now, i'm adding one line to each of the four frontends
to just pass the input text through to the output,
not yet interpreting any of then eqn keywords.
@
text
@d1 1
a1 1
/*	$Id: libroff.h,v 1.2 2011/01/25 12:24:26 schwarze Exp $ */
d30 1
a30 2
	mandocmsg	  msg; /* status messages */
	void		 *data; /* privdata for messages */
d50 1
a50 4
#define	TBL_MSG(tblp, type, line, col) \
	(*(tblp)->msg)((type), (tblp)->data, (line), (col), NULL)

struct tbl_node	*tbl_alloc(int, int, void *, mandocmsg);
@


1.2
log
@Since tbl_data() can now produce multiple spans, let parsebuf()
generate man(7) or mdoc(7) nodes for all these spans,
not only for the last one.
Restores the horizontal lines in the cpu(4/hppa) tables.
ok kristaps@@
@
text
@d1 1
a1 1
/*	$Id: libroff.h,v 1.1 2011/01/04 22:28:17 schwarze Exp $ */
d46 5
d65 4
@


1.1
log
@Merge kristaps@@' cleaner tbl integration, removing mine;
there are still a few bugs, but fixing these will be easier in tree.
@
text
@d1 1
a1 1
/*	$Id: libroff.h,v 1.1 2010/12/28 10:51:03 kristaps Exp $ */
d39 1
d58 1
a58 1
const struct tbl_span *tbl_span(const struct tbl_node *);
@

