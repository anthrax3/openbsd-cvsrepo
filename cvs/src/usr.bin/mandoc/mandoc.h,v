head	1.184;
access;
symbols
	OPENBSD_6_1:1.157.0.4
	OPENBSD_6_1_BASE:1.157
	OPENBSD_6_0:1.151.0.4
	OPENBSD_6_0_BASE:1.151
	OPENBSD_5_9:1.151.0.2
	OPENBSD_5_9_BASE:1.151
	OPENBSD_5_8:1.146.0.4
	OPENBSD_5_8_BASE:1.146
	OPENBSD_5_7:1.143.0.2
	OPENBSD_5_7_BASE:1.143
	OPENBSD_5_6:1.86.0.4
	OPENBSD_5_6_BASE:1.86
	OPENBSD_5_5:1.59.0.4
	OPENBSD_5_5_BASE:1.59
	OPENBSD_5_4:1.52.0.2
	OPENBSD_5_4_BASE:1.52
	OPENBSD_5_3:1.50.0.2
	OPENBSD_5_3_BASE:1.50
	OPENBSD_5_2:1.48.0.2
	OPENBSD_5_2_BASE:1.48
	OPENBSD_5_1_BASE:1.43
	OPENBSD_5_1:1.43.0.2
	OPENBSD_5_0:1.38.0.2
	OPENBSD_5_0_BASE:1.38
	OPENBSD_4_9:1.33.0.2
	OPENBSD_4_9_BASE:1.33
	OPENBSD_4_8:1.11.0.2
	OPENBSD_4_8_BASE:1.11;
locks; strict;
comment	@ * @;


1.184
date	2017.07.05.15.03.20;	author schwarze;	state Exp;
branches;
next	1.183;
commitid	zLikkELVVpcrsPcx;

1.183
date	2017.07.03.17.33.01;	author schwarze;	state Exp;
branches;
next	1.182;
commitid	GVGIMNk3MmDCIOSK;

1.182
date	2017.07.03.13.40.00;	author schwarze;	state Exp;
branches;
next	1.181;
commitid	1dutikfSlALoEQie;

1.181
date	2017.07.02.15.31.48;	author schwarze;	state Exp;
branches;
next	1.180;
commitid	AHLDG8sc9gJmviax;

1.180
date	2017.07.01.09.47.23;	author schwarze;	state Exp;
branches;
next	1.179;
commitid	bUWzoq61QcedQFz7;

1.179
date	2017.06.29.15.21.46;	author schwarze;	state Exp;
branches;
next	1.178;
commitid	GIZSbEspTHFlNqWu;

1.178
date	2017.06.25.17.42.37;	author schwarze;	state Exp;
branches;
next	1.177;
commitid	lU4NKBZiOj5pFGLJ;

1.177
date	2017.06.24.18.58.09;	author schwarze;	state Exp;
branches;
next	1.176;
commitid	Ml3HiKmSwGhhly92;

1.176
date	2017.06.24.15.59.28;	author schwarze;	state Exp;
branches;
next	1.175;
commitid	k99BPjhy9T1oDPrY;

1.175
date	2017.06.24.14.38.27;	author schwarze;	state Exp;
branches;
next	1.174;
commitid	ebFpCjoYaInwxToS;

1.174
date	2017.06.17.23.06.43;	author schwarze;	state Exp;
branches;
next	1.173;
commitid	IbYSiNWSEwkdSFTZ;

1.173
date	2017.06.17.22.40.27;	author schwarze;	state Exp;
branches;
next	1.172;
commitid	eh9zSUWrW3gWUWkZ;

1.172
date	2017.06.14.01.31.19;	author schwarze;	state Exp;
branches;
next	1.171;
commitid	PPUZg39EU736tntb;

1.171
date	2017.06.11.19.36.31;	author schwarze;	state Exp;
branches;
next	1.170;
commitid	XRYVv5vPYVYMmfcL;

1.170
date	2017.06.11.17.16.36;	author schwarze;	state Exp;
branches;
next	1.169;
commitid	dPcvyya15rxVpblT;

1.169
date	2017.06.10.01.48.31;	author schwarze;	state Exp;
branches;
next	1.168;
commitid	GnqehULkzSOZe9a6;

1.168
date	2017.06.08.18.11.15;	author schwarze;	state Exp;
branches;
next	1.167;
commitid	iJqHiCg2x8ufqICJ;

1.167
date	2017.06.08.00.21.23;	author schwarze;	state Exp;
branches;
next	1.166;
commitid	deNJv5UgZ6ZWmFWt;

1.166
date	2017.06.07.23.29.31;	author schwarze;	state Exp;
branches;
next	1.165;
commitid	ZGR4ldkhpkbOKKrj;

1.165
date	2017.06.06.15.00.56;	author schwarze;	state Exp;
branches;
next	1.164;
commitid	LdhzICSunbnL2oyB;

1.164
date	2017.06.03.15.54.09;	author schwarze;	state Exp;
branches;
next	1.163;
commitid	iOor4zVcyUusVswq;

1.163
date	2017.06.02.19.21.03;	author schwarze;	state Exp;
branches;
next	1.162;
commitid	P297MbnOCh21x0GC;

1.162
date	2017.06.01.19.05.15;	author schwarze;	state Exp;
branches;
next	1.161;
commitid	dWvl4SBMkA0iJYZz;

1.161
date	2017.06.01.15.24.41;	author schwarze;	state Exp;
branches;
next	1.160;
commitid	HpKDtV1c60HwJeIE;

1.160
date	2017.05.31.15.30.12;	author schwarze;	state Exp;
branches;
next	1.159;
commitid	JVG7q5p4I1jfXSdC;

1.159
date	2017.05.30.19.29.31;	author schwarze;	state Exp;
branches;
next	1.158;
commitid	aKw7GZmlWwBhe2SM;

1.158
date	2017.05.16.19.05.36;	author schwarze;	state Exp;
branches;
next	1.157;
commitid	IIx55ETP0e3E42lv;

1.157
date	2017.03.06.17.25.24;	author schwarze;	state Exp;
branches;
next	1.156;
commitid	T3Lyz7zZ1p6Y3Qbz;

1.156
date	2017.01.28.23.26.56;	author schwarze;	state Exp;
branches;
next	1.155;
commitid	7sT9Hxn0lUNOlacH;

1.155
date	2017.01.09.01.36.22;	author schwarze;	state Exp;
branches;
next	1.154;
commitid	h3vKZfLhTYNgTrav;

1.154
date	2017.01.08.00.10.22;	author schwarze;	state Exp;
branches;
next	1.153;
commitid	W4clzDItIfTolc66;

1.153
date	2016.12.28.17.21.17;	author schwarze;	state Exp;
branches;
next	1.152;
commitid	KjwyCoopqjkm90wM;

1.152
date	2016.10.09.18.16.46;	author schwarze;	state Exp;
branches;
next	1.151;
commitid	naY2DgYOKonEJYdH;

1.151
date	2016.01.08.02.53.09;	author schwarze;	state Exp;
branches;
next	1.150;
commitid	HwNcDew1e7MZc0JI;

1.150
date	2015.11.07.13.57.55;	author schwarze;	state Exp;
branches;
next	1.149;
commitid	UKwSq7JMt0q6KNpK;

1.149
date	2015.10.30.19.03.36;	author schwarze;	state Exp;
branches;
next	1.148;
commitid	B2ZxW3H5UgZIgEOi;

1.148
date	2015.10.13.22.57.49;	author schwarze;	state Exp;
branches;
next	1.147;
commitid	jXIG8UzKLXm2Z9i6;

1.147
date	2015.09.14.15.35.47;	author schwarze;	state Exp;
branches;
next	1.146;
commitid	rmmzXNvCXUtwzubE;

1.146
date	2015.07.19.05.59.07;	author schwarze;	state Exp;
branches;
next	1.145;
commitid	X9sGdJbndRzfjdoG;

1.145
date	2015.04.18.16.34.03;	author schwarze;	state Exp;
branches;
next	1.144;
commitid	PxhkeHVIvdTMOTs6;

1.144
date	2015.04.18.16.04.40;	author schwarze;	state Exp;
branches;
next	1.143;
commitid	6MYJ7cd8mhJ77AGH;

1.143
date	2015.02.23.13.30.02;	author schwarze;	state Exp;
branches;
next	1.142;
commitid	0JG7TLVmNW4cori6;

1.142
date	2015.02.06.16.05.51;	author schwarze;	state Exp;
branches;
next	1.141;
commitid	Bj9alpGWXCQILmH9;

1.141
date	2015.02.06.11.54.03;	author schwarze;	state Exp;
branches;
next	1.140;
commitid	Wgxy0y7jtcdh0XG7;

1.140
date	2015.02.06.07.12.34;	author schwarze;	state Exp;
branches;
next	1.139;
commitid	QDbepmLqTNee3zgJ;

1.139
date	2015.02.06.03.31.11;	author schwarze;	state Exp;
branches;
next	1.138;
commitid	EGoCKP2gntS3HBlE;

1.138
date	2015.02.04.18.03.28;	author schwarze;	state Exp;
branches;
next	1.137;
commitid	voy6CFtu7t43ZgbA;

1.137
date	2015.02.04.16.38.31;	author schwarze;	state Exp;
branches;
next	1.136;
commitid	MoF7T4hAk1bvNz7U;

1.136
date	2015.01.30.17.31.20;	author schwarze;	state Exp;
branches;
next	1.135;
commitid	8uPgte1HahL1XRHj;

1.135
date	2015.01.30.04.08.37;	author schwarze;	state Exp;
branches;
next	1.134;
commitid	KL58yWbJhw6UbgSB;

1.134
date	2015.01.28.21.10.28;	author schwarze;	state Exp;
branches;
next	1.133;
commitid	fvM2x3xHE0B4upcu;

1.133
date	2015.01.28.17.30.37;	author schwarze;	state Exp;
branches;
next	1.132;
commitid	B9i4oMLogJsiyrd5;

1.132
date	2015.01.27.05.20.30;	author schwarze;	state Exp;
branches;
next	1.131;
commitid	x93gRIdSgdjntkaE;

1.131
date	2015.01.26.18.41.45;	author schwarze;	state Exp;
branches;
next	1.130;
commitid	mmVgjPEivVGaZY4u;

1.130
date	2015.01.26.13.02.53;	author schwarze;	state Exp;
branches;
next	1.129;
commitid	TckXsclN2hfFrBFF;

1.129
date	2015.01.26.00.54.09;	author schwarze;	state Exp;
branches;
next	1.128;
commitid	vhh5zuNKcPCGcJgK;

1.128
date	2015.01.24.01.59.40;	author schwarze;	state Exp;
branches;
next	1.127;
commitid	pxeX1HXdNjYPBYKE;

1.127
date	2015.01.22.21.36.44;	author schwarze;	state Exp;
branches;
next	1.126;
commitid	feJuP9ph3mKvcaqr;

1.126
date	2015.01.21.20.20.49;	author schwarze;	state Exp;
branches;
next	1.125;
commitid	oPCJQka1zVKJ04b2;

1.125
date	2015.01.20.21.12.46;	author schwarze;	state Exp;
branches;
next	1.124;
commitid	yL1piccWr1moLOpy;

1.124
date	2015.01.15.04.26.06;	author schwarze;	state Exp;
branches;
next	1.123;
commitid	TgtfgXU8Rz8XgmeH;

1.123
date	2015.01.15.02.29.07;	author schwarze;	state Exp;
branches;
next	1.122;
commitid	Vo5xG7mxv2w7gxZV;

1.122
date	2015.01.14.22.57.57;	author schwarze;	state Exp;
branches;
next	1.121;
commitid	pB8ZvBlUeO92L1BP;

1.121
date	2015.01.14.22.02.00;	author schwarze;	state Exp;
branches;
next	1.120;
commitid	3rgOerOpi4Q1Co7V;

1.120
date	2015.01.14.17.45.25;	author schwarze;	state Exp;
branches;
next	1.119;
commitid	5UxaFbklRRwvScbK;

1.119
date	2014.12.16.23.44.16;	author schwarze;	state Exp;
branches;
next	1.118;
commitid	r7Pkn5lMmGIVLeBR;

1.118
date	2014.12.01.08.05.02;	author schwarze;	state Exp;
branches;
next	1.117;
commitid	dkxNPoJe0koFMMLd;

1.117
date	2014.11.30.05.28.00;	author schwarze;	state Exp;
branches;
next	1.116;
commitid	4gOj8tbqcpkeLVbt;

1.116
date	2014.11.30.02.31.32;	author schwarze;	state Exp;
branches;
next	1.115;
commitid	2VPAWCQ5LDs66xdK;

1.115
date	2014.11.28.18.07.38;	author schwarze;	state Exp;
branches;
next	1.114;
commitid	FLjJT6vAqGK0xVjM;

1.114
date	2014.11.27.23.35.03;	author schwarze;	state Exp;
branches;
next	1.113;
commitid	h4lbTux1L5FzGMXy;

1.113
date	2014.11.27.14.31.29;	author deraadt;	state Exp;
branches;
next	1.112;
commitid	je75OeVgCvwQD2St;

1.112
date	2014.11.26.21.40.11;	author schwarze;	state Exp;
branches;
next	1.111;
commitid	BFoJYar3mOvn9yB3;

1.111
date	2014.10.30.00.05.02;	author schwarze;	state Exp;
branches;
next	1.110;
commitid	dxVoXRJjO1zZjAXI;

1.110
date	2014.10.29.00.17.01;	author schwarze;	state Exp;
branches;
next	1.109;
commitid	DT3doJsSOKw5l7CZ;

1.109
date	2014.10.28.17.35.42;	author schwarze;	state Exp;
branches;
next	1.108;
commitid	pNwmOla3ZQwLgu2f;

1.108
date	2014.10.26.18.06.28;	author schwarze;	state Exp;
branches;
next	1.107;
commitid	35r4kUpCbAKnK6uq;

1.107
date	2014.10.20.19.21.31;	author schwarze;	state Exp;
branches;
next	1.106;
commitid	7LDoViU00JgOAI7G;

1.106
date	2014.10.14.02.16.02;	author schwarze;	state Exp;
branches;
next	1.105;
commitid	CvxMGBcRTJn11Q3v;

1.105
date	2014.10.12.19.10.56;	author schwarze;	state Exp;
branches;
next	1.104;
commitid	oFUg4cCWEgutyqUr;

1.104
date	2014.10.11.21.14.11;	author schwarze;	state Exp;
branches;
next	1.103;
commitid	ArFLy7r4v7g9NTzH;

1.103
date	2014.10.10.15.25.06;	author schwarze;	state Exp;
branches;
next	1.102;
commitid	MpqXOG3dhTX11YQI;

1.102
date	2014.10.09.15.59.08;	author schwarze;	state Exp;
branches;
next	1.101;
commitid	Wy6YFSKH1ddfqJiG;

1.101
date	2014.10.09.15.21.46;	author schwarze;	state Exp;
branches;
next	1.100;
commitid	QH4xwyTeTm9ROYu8;

1.100
date	2014.09.12.00.53.21;	author schwarze;	state Exp;
branches;
next	1.99;
commitid	nVgiAqRo1hF16aAQ;

1.99
date	2014.09.11.23.52.47;	author schwarze;	state Exp;
branches;
next	1.98;
commitid	OL6L1tS4sl1FuVNA;

1.98
date	2014.09.07.23.24.33;	author schwarze;	state Exp;
branches;
next	1.97;
commitid	fhtI2THcHW6rewCo;

1.97
date	2014.09.03.23.20.33;	author schwarze;	state Exp;
branches;
next	1.96;
commitid	nPk0DzpqFSEanZEV;

1.96
date	2014.08.08.16.17.09;	author schwarze;	state Exp;
branches;
next	1.95;
commitid	TLMAnDXVMoqLltgG;

1.95
date	2014.08.08.15.54.10;	author schwarze;	state Exp;
branches;
next	1.94;
commitid	yBKHNskikm52fHMo;

1.94
date	2014.08.08.15.48.43;	author schwarze;	state Exp;
branches;
next	1.93;
commitid	G8BpeOpuFhU22sI2;

1.93
date	2014.08.08.15.45.58;	author schwarze;	state Exp;
branches;
next	1.92;
commitid	HtYC13kYxIr23M9f;

1.92
date	2014.08.08.15.42.39;	author schwarze;	state Exp;
branches;
next	1.91;
commitid	dIfosrluXZ6tTQFU;

1.91
date	2014.08.08.15.38.46;	author schwarze;	state Exp;
branches;
next	1.90;
commitid	0s9bQuCDRMV0Ke9L;

1.90
date	2014.08.08.15.26.28;	author schwarze;	state Exp;
branches;
next	1.89;
commitid	p7GwHxeS0xJRdvMp;

1.89
date	2014.08.08.15.21.17;	author schwarze;	state Exp;
branches;
next	1.88;
commitid	6Tv1eQzz4fj9QlUj;

1.88
date	2014.08.08.15.15.27;	author schwarze;	state Exp;
branches;
next	1.87;
commitid	fgZ1S3QYW6RU4QWI;

1.87
date	2014.08.08.15.10.14;	author schwarze;	state Exp;
branches;
next	1.86;
commitid	V6V8vpTM0RQ4gS7I;

1.86
date	2014.07.09.11.30.07;	author schwarze;	state Exp;
branches;
next	1.85;
commitid	WErJgzRtDKBz19TC;

1.85
date	2014.07.07.21.35.42;	author schwarze;	state Exp;
branches;
next	1.84;
commitid	O2S43bw50KTGcriR;

1.84
date	2014.07.07.16.12.06;	author schwarze;	state Exp;
branches;
next	1.83;
commitid	JkcWLt8pXBmAkPFj;

1.83
date	2014.07.07.15.03.24;	author schwarze;	state Exp;
branches;
next	1.82;
commitid	LD7wx5yJuIhKJiro;

1.82
date	2014.07.07.11.34.41;	author schwarze;	state Exp;
branches;
next	1.81;
commitid	SxiKID1BRkm7SsXU;

1.81
date	2014.07.06.19.08.56;	author schwarze;	state Exp;
branches;
next	1.80;
commitid	rolX8OitNNoUBJoD;

1.80
date	2014.07.05.12.33.54;	author schwarze;	state Exp;
branches;
next	1.79;
commitid	IbTbYyU1XoSImvHA;

1.79
date	2014.07.05.01.11.33;	author schwarze;	state Exp;
branches;
next	1.78;
commitid	xwzAVywNWdayFtqP;

1.78
date	2014.07.04.16.11.41;	author schwarze;	state Exp;
branches;
next	1.77;
commitid	sgqZ9hnRM3L6yvgn;

1.77
date	2014.07.04.01.50.03;	author schwarze;	state Exp;
branches;
next	1.76;
commitid	Y8kkUfI8kBY4R2Vw;

1.76
date	2014.07.03.23.23.45;	author schwarze;	state Exp;
branches;
next	1.75;
commitid	r0fsz0DrjbQnVa67;

1.75
date	2014.07.03.21.23.08;	author schwarze;	state Exp;
branches;
next	1.74;
commitid	fILxF31MgcuaKrF8;

1.74
date	2014.07.02.20.18.42;	author schwarze;	state Exp;
branches;
next	1.73;
commitid	9LBCQenwbyZCIKCe;

1.73
date	2014.07.02.13.10.15;	author schwarze;	state Exp;
branches;
next	1.72;
commitid	Ao0fphsjJ98jbj9D;

1.72
date	2014.07.02.11.42.56;	author schwarze;	state Exp;
branches;
next	1.71;
commitid	aUdrdtDM8sKwymS7;

1.71
date	2014.07.02.05.51.49;	author schwarze;	state Exp;
branches;
next	1.70;
commitid	fKiFNFn6PyMDO56P;

1.70
date	2014.07.02.03.47.07;	author schwarze;	state Exp;
branches;
next	1.69;
commitid	p4pNII1v0bYCswy0;

1.69
date	2014.07.01.22.36.35;	author schwarze;	state Exp;
branches;
next	1.68;
commitid	6SNWblzmBTWk9YRA;

1.68
date	2014.06.30.23.45.03;	author schwarze;	state Exp;
branches;
next	1.67;
commitid	REPMRSo60FbInFiA;

1.67
date	2014.06.25.00.19.17;	author schwarze;	state Exp;
branches;
next	1.66;
commitid	JeAYFU7kC8rIy3dQ;

1.66
date	2014.06.20.22.58.41;	author schwarze;	state Exp;
branches;
next	1.65;
commitid	ktgkM223FL3EC6E8;

1.65
date	2014.06.20.17.23.09;	author schwarze;	state Exp;
branches;
next	1.64;
commitid	gTaF7NL9JpgvI2ni;

1.64
date	2014.04.20.16.44.44;	author schwarze;	state Exp;
branches;
next	1.63;

1.63
date	2014.03.28.23.25.54;	author schwarze;	state Exp;
branches;
next	1.62;

1.62
date	2014.03.21.22.17.01;	author schwarze;	state Exp;
branches;
next	1.61;

1.61
date	2014.03.19.22.20.36;	author schwarze;	state Exp;
branches;
next	1.60;

1.60
date	2014.03.19.21.50.59;	author schwarze;	state Exp;
branches;
next	1.59;

1.59
date	2014.01.22.20.58.35;	author schwarze;	state Exp;
branches;
next	1.58;

1.58
date	2014.01.05.20.26.27;	author schwarze;	state Exp;
branches;
next	1.57;

1.57
date	2014.01.02.16.29.46;	author schwarze;	state Exp;
branches;
next	1.56;

1.56
date	2013.12.30.18.27.15;	author schwarze;	state Exp;
branches;
next	1.55;

1.55
date	2013.10.05.21.17.29;	author schwarze;	state Exp;
branches;
next	1.54;

1.54
date	2013.09.16.00.25.06;	author schwarze;	state Exp;
branches;
next	1.53;

1.53
date	2013.08.08.20.07.24;	author schwarze;	state Exp;
branches;
next	1.52;

1.52
date	2013.07.13.12.51.37;	author schwarze;	state Exp;
branches;
next	1.51;

1.51
date	2013.05.31.21.37.08;	author schwarze;	state Exp;
branches;
next	1.50;

1.50
date	2012.11.19.22.28.35;	author schwarze;	state Exp;
branches;
next	1.49;

1.49
date	2012.11.16.22.20.40;	author schwarze;	state Exp;
branches;
next	1.48;

1.48
date	2012.07.18.11.09.30;	author schwarze;	state Exp;
branches;
next	1.47;

1.47
date	2012.07.12.15.09.50;	author schwarze;	state Exp;
branches;
next	1.46;

1.46
date	2012.05.28.13.00.51;	author schwarze;	state Exp;
branches;
next	1.45;

1.45
date	2012.05.26.20.03.34;	author schwarze;	state Exp;
branches;
next	1.44;

1.44
date	2012.05.24.23.33.23;	author schwarze;	state Exp;
branches;
next	1.43;

1.43
date	2011.11.12.22.43.18;	author schwarze;	state Exp;
branches;
next	1.42;

1.42
date	2011.11.05.16.02.18;	author schwarze;	state Exp;
branches;
next	1.41;

1.41
date	2011.10.09.17.59.56;	author schwarze;	state Exp;
branches;
next	1.40;

1.40
date	2011.09.18.10.25.28;	author schwarze;	state Exp;
branches;
next	1.39;

1.39
date	2011.09.17.13.45.28;	author schwarze;	state Exp;
branches;
next	1.38;

1.38
date	2011.05.29.21.22.18;	author schwarze;	state Exp;
branches;
next	1.37;

1.37
date	2011.04.24.16.22.02;	author schwarze;	state Exp;
branches;
next	1.36;

1.36
date	2011.04.21.22.59.54;	author schwarze;	state Exp;
branches;
next	1.35;

1.35
date	2011.03.20.23.36.42;	author schwarze;	state Exp;
branches;
next	1.34;

1.34
date	2011.03.07.01.35.33;	author schwarze;	state Exp;
branches;
next	1.33;

1.33
date	2011.02.10.00.06.30;	author schwarze;	state Exp;
branches;
next	1.32;

1.32
date	2011.02.06.17.33.20;	author schwarze;	state Exp;
branches;
next	1.31;

1.31
date	2011.01.16.19.27.25;	author schwarze;	state Exp;
branches;
next	1.30;

1.30
date	2011.01.16.01.11.50;	author schwarze;	state Exp;
branches;
next	1.29;

1.29
date	2011.01.10.23.53.32;	author schwarze;	state Exp;
branches;
next	1.28;

1.28
date	2011.01.09.14.30.48;	author schwarze;	state Exp;
branches;
next	1.27;

1.27
date	2011.01.04.22.28.17;	author schwarze;	state Exp;
branches;
next	1.26;

1.26
date	2011.01.03.23.39.27;	author schwarze;	state Exp;
branches;
next	1.25;

1.25
date	2010.12.09.23.01.18;	author schwarze;	state Exp;
branches;
next	1.24;

1.24
date	2010.12.07.00.08.52;	author schwarze;	state Exp;
branches;
next	1.23;

1.23
date	2010.12.01.22.02.29;	author schwarze;	state Exp;
branches;
next	1.22;

1.22
date	2010.11.29.00.12.02;	author schwarze;	state Exp;
branches;
next	1.21;

1.21
date	2010.11.28.19.35.33;	author schwarze;	state Exp;
branches;
next	1.20;

1.20
date	2010.10.26.23.34.38;	author schwarze;	state Exp;
branches;
next	1.19;

1.19
date	2010.10.26.22.48.07;	author schwarze;	state Exp;
branches;
next	1.18;

1.18
date	2010.10.26.22.28.57;	author schwarze;	state Exp;
branches;
next	1.17;

1.17
date	2010.10.24.18.15.43;	author schwarze;	state Exp;
branches;
next	1.16;

1.16
date	2010.10.23.15.49.30;	author schwarze;	state Exp;
branches;
next	1.15;

1.15
date	2010.10.16.20.49.37;	author schwarze;	state Exp;
branches;
next	1.14;

1.14
date	2010.09.27.21.25.28;	author schwarze;	state Exp;
branches;
next	1.13;

1.13
date	2010.09.26.20.19.58;	author schwarze;	state Exp;
branches;
next	1.12;

1.12
date	2010.08.20.00.53.35;	author schwarze;	state Exp;
branches;
next	1.11;

1.11
date	2010.07.25.18.05.54;	author schwarze;	state Exp;
branches;
next	1.10;

1.10
date	2010.07.13.01.09.13;	author schwarze;	state Exp;
branches;
next	1.9;

1.9
date	2010.07.01.15.36.59;	author schwarze;	state Exp;
branches;
next	1.8;

1.8
date	2010.06.30.20.29.44;	author schwarze;	state Exp;
branches;
next	1.7;

1.7
date	2010.06.26.17.56.43;	author schwarze;	state Exp;
branches;
next	1.6;

1.6
date	2010.06.06.20.30.08;	author schwarze;	state Exp;
branches;
next	1.5;

1.5
date	2010.05.26.02.39.58;	author schwarze;	state Exp;
branches;
next	1.4;

1.4
date	2010.05.23.23.35.26;	author schwarze;	state Exp;
branches;
next	1.3;

1.3
date	2010.05.23.22.45.00;	author schwarze;	state Exp;
branches;
next	1.2;

1.2
date	2010.05.20.00.58.02;	author schwarze;	state Exp;
branches;
next	1.1;

1.1
date	2010.05.16.01.46.39;	author schwarze;	state Exp;
branches;
next	;


desc
@@


1.184
log
@The EQN_LISTONE box type is pointless.
Simplify by just using EQN_LIST with expectargs = 1.
Noticed while investigating a bug report from bentley@@.
No functional change.
@
text
@/*	$OpenBSD: mandoc.h,v 1.183 2017/07/03 17:33:01 schwarze Exp $ */
/*
 * Copyright (c) 2010, 2011, 2014 Kristaps Dzonsons <kristaps@@bsd.lv>
 * Copyright (c) 2010-2017 Ingo Schwarze <schwarze@@openbsd.org>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHORS DISCLAIM ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#define ASCII_NBRSP	 31  /* non-breaking space */
#define	ASCII_HYPH	 30  /* breakable hyphen */
#define	ASCII_BREAK	 29  /* breakable zero-width space */

/*
 * Status level.  This refers to both internal status (i.e., whilst
 * running, when warnings/errors are reported) and an indicator of a
 * threshold of when to halt (when said internal state exceeds the
 * threshold).
 */
enum	mandoclevel {
	MANDOCLEVEL_OK = 0,
	MANDOCLEVEL_STYLE, /* style suggestions */
	MANDOCLEVEL_WARNING, /* warnings: syntax, whitespace, etc. */
	MANDOCLEVEL_ERROR, /* input has been thrown away */
	MANDOCLEVEL_UNSUPP, /* input needs unimplemented features */
	MANDOCLEVEL_BADARG, /* bad argument in invocation */
	MANDOCLEVEL_SYSERR, /* system error */
	MANDOCLEVEL_MAX
};

/*
 * All possible things that can go wrong within a parse, be it libroff,
 * libmdoc, or libman.
 */
enum	mandocerr {
	MANDOCERR_OK,

	MANDOCERR_BASE, /* ===== start of base system conventions ===== */

	MANDOCERR_MDOCDATE, /* Mdocdate found: Dd ... */
	MANDOCERR_MDOCDATE_MISSING, /* Mdocdate missing: Dd ... */
	MANDOCERR_ARCH_BAD,  /* unknown architecture: Dt ... arch */
	MANDOCERR_OS_ARG,  /* operating system explicitly specified: Os ... */
	MANDOCERR_RCS_MISSING, /* RCS id missing */
	MANDOCERR_XR_BAD,  /* referenced manual not found: Xr name sec */

	MANDOCERR_STYLE, /* ===== start of style suggestions ===== */

	MANDOCERR_DATE_LEGACY, /* legacy man(7) date format: Dd ... */
	MANDOCERR_RCS_REP, /* duplicate RCS id: ... */
	MANDOCERR_SEC_TYPO,  /* typo in section name: Sh ... */
	MANDOCERR_MACRO_USELESS, /* useless macro: macro */
	MANDOCERR_BX, /* consider using OS macro: macro */
	MANDOCERR_ER_ORDER, /* errnos out of order: Er ... */
	MANDOCERR_ER_REP, /* duplicate errno: Er ... */
	MANDOCERR_DELIM, /* trailing delimiter: macro ... */
	MANDOCERR_DELIM_NB, /* no blank before trailing delimiter: macro ... */
	MANDOCERR_FUNC, /* function name without markup: name() */

	MANDOCERR_WARNING, /* ===== start of warnings ===== */

	/* related to the prologue */
	MANDOCERR_DT_NOTITLE, /* missing manual title, using UNTITLED: line */
	MANDOCERR_TH_NOTITLE, /* missing manual title, using "": [macro] */
	MANDOCERR_TITLE_CASE, /* lower case character in document title */
	MANDOCERR_MSEC_MISSING, /* missing manual section, using "": macro */
	MANDOCERR_MSEC_BAD, /* unknown manual section: Dt ... section */
	MANDOCERR_DATE_MISSING, /* missing date, using today's date */
	MANDOCERR_DATE_BAD, /* cannot parse date, using it verbatim: date */
	MANDOCERR_DATE_FUTURE, /* date in the future, using it anyway: date */
	MANDOCERR_OS_MISSING, /* missing Os macro, using "" */
	MANDOCERR_PROLOG_REP, /* duplicate prologue macro: macro */
	MANDOCERR_PROLOG_LATE, /* late prologue macro: macro */
	MANDOCERR_DT_LATE, /* skipping late title macro: Dt args */
	MANDOCERR_PROLOG_ORDER, /* prologue macros out of order: macros */

	/* related to document structure */
	MANDOCERR_SO, /* .so is fragile, better use ln(1): so path */
	MANDOCERR_DOC_EMPTY, /* no document body */
	MANDOCERR_SEC_BEFORE, /* content before first section header: macro */
	MANDOCERR_NAMESEC_FIRST, /* first section is not NAME: Sh title */
	MANDOCERR_NAMESEC_NONM, /* NAME section without Nm before Nd */
	MANDOCERR_NAMESEC_NOND, /* NAME section without description */
	MANDOCERR_NAMESEC_ND, /* description not at the end of NAME */
	MANDOCERR_NAMESEC_BAD, /* bad NAME section content: macro */
	MANDOCERR_NAMESEC_PUNCT, /* missing comma before name: Nm name */
	MANDOCERR_ND_EMPTY, /* missing description line, using "" */
	MANDOCERR_ND_LATE, /* description line outside NAME section */
	MANDOCERR_SEC_ORDER, /* sections out of conventional order: Sh title */
	MANDOCERR_SEC_REP, /* duplicate section title: Sh title */
	MANDOCERR_SEC_MSEC, /* unexpected section: Sh title for ... only */
	MANDOCERR_XR_SELF,  /* cross reference to self: Xr name sec */
	MANDOCERR_XR_ORDER, /* unusual Xr order: ... after ... */
	MANDOCERR_XR_PUNCT, /* unusual Xr punctuation: ... after ... */
	MANDOCERR_AN_MISSING, /* AUTHORS section without An macro */

	/* related to macros and nesting */
	MANDOCERR_MACRO_OBS, /* obsolete macro: macro */
	MANDOCERR_MACRO_CALL, /* macro neither callable nor escaped: macro */
	MANDOCERR_PAR_SKIP, /* skipping paragraph macro: macro ... */
	MANDOCERR_PAR_MOVE, /* moving paragraph macro out of list: macro */
	MANDOCERR_NS_SKIP, /* skipping no-space macro */
	MANDOCERR_BLK_NEST, /* blocks badly nested: macro ... */
	MANDOCERR_BD_NEST, /* nested displays are not portable: macro ... */
	MANDOCERR_BL_MOVE, /* moving content out of list: macro */
	MANDOCERR_TA_LINE, /* first macro on line: Ta */
	MANDOCERR_FI_SKIP, /* fill mode already enabled, skipping: fi */
	MANDOCERR_NF_SKIP, /* fill mode already disabled, skipping: nf */
	MANDOCERR_BLK_LINE, /* line scope broken: macro breaks macro */
	MANDOCERR_BLK_BLANK, /* skipping blank line in line scope */

	/* related to missing arguments */
	MANDOCERR_REQ_EMPTY, /* skipping empty request: request */
	MANDOCERR_COND_EMPTY, /* conditional request controls empty scope */
	MANDOCERR_MACRO_EMPTY, /* skipping empty macro: macro */
	MANDOCERR_BLK_EMPTY, /* empty block: macro */
	MANDOCERR_ARG_EMPTY, /* empty argument, using 0n: macro arg */
	MANDOCERR_BD_NOTYPE, /* missing display type, using -ragged: Bd */
	MANDOCERR_BL_LATETYPE, /* list type is not the first argument: Bl arg */
	MANDOCERR_BL_NOWIDTH, /* missing -width in -tag list, using 6n */
	MANDOCERR_EX_NONAME, /* missing utility name, using "": Ex */
	MANDOCERR_FO_NOHEAD, /* missing function name, using "": Fo */
	MANDOCERR_IT_NOHEAD, /* empty head in list item: Bl -type It */
	MANDOCERR_IT_NOBODY, /* empty list item: Bl -type It */
	MANDOCERR_IT_NOARG, /* missing argument, using next line: Bl -c It */
	MANDOCERR_BF_NOFONT, /* missing font type, using \fR: Bf */
	MANDOCERR_BF_BADFONT, /* unknown font type, using \fR: Bf font */
	MANDOCERR_PF_SKIP, /* nothing follows prefix: Pf arg */
	MANDOCERR_RS_EMPTY, /* empty reference block: Rs */
	MANDOCERR_XR_NOSEC, /* missing section argument: Xr arg */
	MANDOCERR_ARG_STD, /* missing -std argument, adding it: macro */
	MANDOCERR_OP_EMPTY, /* missing option string, using "": OP */
	MANDOCERR_UR_NOHEAD, /* missing resource identifier, using "": UR */
	MANDOCERR_EQN_NOBOX, /* missing eqn box, using "": op */

	/* related to bad arguments */
	MANDOCERR_ARG_QUOTE, /* unterminated quoted argument */
	MANDOCERR_ARG_REP, /* duplicate argument: macro arg */
	MANDOCERR_AN_REP, /* skipping duplicate argument: An -arg */
	MANDOCERR_BD_REP, /* skipping duplicate display type: Bd -type */
	MANDOCERR_BL_REP, /* skipping duplicate list type: Bl -type */
	MANDOCERR_BL_SKIPW, /* skipping -width argument: Bl -type */
	MANDOCERR_BL_COL, /* wrong number of cells */
	MANDOCERR_AT_BAD, /* unknown AT&T UNIX version: At version */
	MANDOCERR_FA_COMMA, /* comma in function argument: arg */
	MANDOCERR_FN_PAREN, /* parenthesis in function name: arg */
	MANDOCERR_LB_BAD, /* unknown library name: Lb ... */
	MANDOCERR_RS_BAD, /* invalid content in Rs block: macro */
	MANDOCERR_SM_BAD, /* invalid Boolean argument: macro arg */
	MANDOCERR_FT_BAD, /* unknown font, skipping request: ft font */
	MANDOCERR_TR_ODD, /* odd number of characters in request: tr char */

	/* related to plain text */
	MANDOCERR_FI_BLANK, /* blank line in fill mode, using .sp */
	MANDOCERR_FI_TAB, /* tab in filled text */
	MANDOCERR_SPACE_EOL, /* whitespace at end of input line */
	MANDOCERR_EOS, /* new sentence, new line */
	MANDOCERR_COMMENT_BAD, /* bad comment style */
	MANDOCERR_ESC_BAD, /* invalid escape sequence: esc */
	MANDOCERR_STR_UNDEF, /* undefined string, using "": name */

	/* related to tables */
	MANDOCERR_TBLLAYOUT_SPAN, /* tbl line starts with span */
	MANDOCERR_TBLLAYOUT_DOWN, /* tbl column starts with span */
	MANDOCERR_TBLLAYOUT_VERT, /* skipping vertical bar in tbl layout */

	MANDOCERR_ERROR, /* ===== start of errors ===== */

	/* related to tables */
	MANDOCERR_TBLOPT_ALPHA, /* non-alphabetic character in tbl options */
	MANDOCERR_TBLOPT_BAD, /* skipping unknown tbl option: option */
	MANDOCERR_TBLOPT_NOARG, /* missing tbl option argument: option */
	MANDOCERR_TBLOPT_ARGSZ, /* wrong tbl option argument size: option */
	MANDOCERR_TBLLAYOUT_NONE, /* empty tbl layout */
	MANDOCERR_TBLLAYOUT_CHAR, /* invalid character in tbl layout: char */
	MANDOCERR_TBLLAYOUT_PAR, /* unmatched parenthesis in tbl layout */
	MANDOCERR_TBLDATA_NONE, /* tbl without any data cells */
	MANDOCERR_TBLDATA_SPAN, /* ignoring data in spanned tbl cell: data */
	MANDOCERR_TBLDATA_EXTRA, /* ignoring extra tbl data cells: data */
	MANDOCERR_TBLDATA_BLK, /* data block open at end of tbl: macro */

	/* related to document structure and macros */
	MANDOCERR_FILE, /* cannot open file */
	MANDOCERR_ROFFLOOP, /* input stack limit exceeded, infinite loop? */
	MANDOCERR_CHAR_BAD, /* skipping bad character: number */
	MANDOCERR_MACRO, /* skipping unknown macro: macro */
	MANDOCERR_REQ_INSEC, /* skipping insecure request: request */
	MANDOCERR_IT_STRAY, /* skipping item outside list: It ... */
	MANDOCERR_TA_STRAY, /* skipping column outside column list: Ta */
	MANDOCERR_BLK_NOTOPEN, /* skipping end of block that is not open */
	MANDOCERR_RE_NOTOPEN, /* fewer RS blocks open, skipping: RE arg */
	MANDOCERR_BLK_BROKEN, /* inserting missing end of block: macro ... */
	MANDOCERR_BLK_NOEND, /* appending missing end of block: macro */

	/* related to request and macro arguments */
	MANDOCERR_NAMESC, /* escaped character not allowed in a name: name */
	MANDOCERR_BD_FILE, /* NOT IMPLEMENTED: Bd -file */
	MANDOCERR_BD_NOARG, /* skipping display without arguments: Bd */
	MANDOCERR_BL_NOTYPE, /* missing list type, using -item: Bl */
	MANDOCERR_CE_NONUM, /* argument is not numeric, using 1: ce ... */
	MANDOCERR_NM_NONAME, /* missing manual name, using "": Nm */
	MANDOCERR_OS_UNAME, /* uname(3) system call failed, using UNKNOWN */
	MANDOCERR_ST_BAD, /* unknown standard specifier: St standard */
	MANDOCERR_IT_NONUM, /* skipping request without numeric argument */
	MANDOCERR_SO_PATH, /* NOT IMPLEMENTED: .so with absolute path or ".." */
	MANDOCERR_SO_FAIL, /* .so request failed */
	MANDOCERR_ARG_SKIP, /* skipping all arguments: macro args */
	MANDOCERR_ARG_EXCESS, /* skipping excess arguments: macro ... args */
	MANDOCERR_DIVZERO, /* divide by zero */

	MANDOCERR_UNSUPP, /* ===== start of unsupported features ===== */

	MANDOCERR_TOOLARGE, /* input too large */
	MANDOCERR_CHAR_UNSUPP, /* unsupported control character: number */
	MANDOCERR_REQ_UNSUPP, /* unsupported roff request: request */
	MANDOCERR_TBLOPT_EQN, /* eqn delim option in tbl: arg */
	MANDOCERR_TBLLAYOUT_MOD, /* unsupported tbl layout modifier: m */
	MANDOCERR_TBLMACRO, /* ignoring macro in table: macro */

	MANDOCERR_MAX
};

struct	tbl_opts {
	char		  tab; /* cell-separator */
	char		  decimal; /* decimal point */
	int		  opts;
#define	TBL_OPT_CENTRE	 (1 << 0)
#define	TBL_OPT_EXPAND	 (1 << 1)
#define	TBL_OPT_BOX	 (1 << 2)
#define	TBL_OPT_DBOX	 (1 << 3)
#define	TBL_OPT_ALLBOX	 (1 << 4)
#define	TBL_OPT_NOKEEP	 (1 << 5)
#define	TBL_OPT_NOSPACE	 (1 << 6)
#define	TBL_OPT_NOWARN	 (1 << 7)
	int		  cols; /* number of columns */
	int		  lvert; /* width of left vertical line */
	int		  rvert; /* width of right vertical line */
};

enum	tbl_cellt {
	TBL_CELL_CENTRE, /* c, C */
	TBL_CELL_RIGHT, /* r, R */
	TBL_CELL_LEFT, /* l, L */
	TBL_CELL_NUMBER, /* n, N */
	TBL_CELL_SPAN, /* s, S */
	TBL_CELL_LONG, /* a, A */
	TBL_CELL_DOWN, /* ^ */
	TBL_CELL_HORIZ, /* _, - */
	TBL_CELL_DHORIZ, /* = */
	TBL_CELL_MAX
};

/*
 * A cell in a layout row.
 */
struct	tbl_cell {
	struct tbl_cell	 *next;
	char		 *wstr; /* min width represented as a string */
	size_t		  width; /* minimum column width */
	size_t		  spacing; /* to the right of the column */
	int		  vert; /* width of subsequent vertical line */
	int		  col; /* column number, starting from 0 */
	int		  flags;
#define	TBL_CELL_TALIGN	 (1 << 0) /* t, T */
#define	TBL_CELL_BALIGN	 (1 << 1) /* d, D */
#define	TBL_CELL_BOLD	 (1 << 2) /* fB, B, b */
#define	TBL_CELL_ITALIC	 (1 << 3) /* fI, I, i */
#define	TBL_CELL_EQUAL	 (1 << 4) /* e, E */
#define	TBL_CELL_UP	 (1 << 5) /* u, U */
#define	TBL_CELL_WIGN	 (1 << 6) /* z, Z */
#define	TBL_CELL_WMAX	 (1 << 7) /* x, X */
	enum tbl_cellt	  pos;
};

/*
 * A layout row.
 */
struct	tbl_row {
	struct tbl_row	 *next;
	struct tbl_cell	 *first;
	struct tbl_cell	 *last;
	int		  vert; /* width of left vertical line */
};

enum	tbl_datt {
	TBL_DATA_NONE, /* has no data */
	TBL_DATA_DATA, /* consists of data/string */
	TBL_DATA_HORIZ, /* horizontal line */
	TBL_DATA_DHORIZ, /* double-horizontal line */
	TBL_DATA_NHORIZ, /* squeezed horizontal line */
	TBL_DATA_NDHORIZ /* squeezed double-horizontal line */
};

/*
 * A cell within a row of data.  The "string" field contains the actual
 * string value that's in the cell.  The rest is layout.
 */
struct	tbl_dat {
	struct tbl_cell	 *layout; /* layout cell */
	struct tbl_dat	 *next;
	char		 *string; /* data (NULL if not TBL_DATA_DATA) */
	int		  spans; /* how many spans follow */
	int		  block; /* T{ text block T} */
	enum tbl_datt	  pos;
};

enum	tbl_spant {
	TBL_SPAN_DATA, /* span consists of data */
	TBL_SPAN_HORIZ, /* span is horizontal line */
	TBL_SPAN_DHORIZ /* span is double horizontal line */
};

/*
 * A row of data in a table.
 */
struct	tbl_span {
	struct tbl_opts	 *opts;
	struct tbl_row	 *layout; /* layout row */
	struct tbl_dat	 *first;
	struct tbl_dat	 *last;
	struct tbl_span	 *prev;
	struct tbl_span	 *next;
	int		  line; /* parse line */
	enum tbl_spant	  pos;
};

enum	eqn_boxt {
	EQN_ROOT, /* root of parse tree */
	EQN_TEXT, /* text (number, variable, whatever) */
	EQN_SUBEXPR, /* nested `eqn' subexpression */
	EQN_LIST, /* list (braces, etc.) */
	EQN_PILE, /* vertical pile */
	EQN_MATRIX /* pile of piles */
};

enum	eqn_fontt {
	EQNFONT_NONE = 0,
	EQNFONT_ROMAN,
	EQNFONT_BOLD,
	EQNFONT_FAT,
	EQNFONT_ITALIC,
	EQNFONT__MAX
};

enum	eqn_post {
	EQNPOS_NONE = 0,
	EQNPOS_SUP,
	EQNPOS_SUBSUP,
	EQNPOS_SUB,
	EQNPOS_TO,
	EQNPOS_FROM,
	EQNPOS_FROMTO,
	EQNPOS_OVER,
	EQNPOS_SQRT,
	EQNPOS__MAX
};

enum	eqn_pilet {
	EQNPILE_NONE = 0,
	EQNPILE_PILE,
	EQNPILE_CPILE,
	EQNPILE_RPILE,
	EQNPILE_LPILE,
	EQNPILE_COL,
	EQNPILE_CCOL,
	EQNPILE_RCOL,
	EQNPILE_LCOL,
	EQNPILE__MAX
};

 /*
 * A "box" is a parsed mathematical expression as defined by the eqn.7
 * grammar.
 */
struct	eqn_box {
	int		  size; /* font size of expression */
#define	EQN_DEFSIZE	  INT_MIN
	enum eqn_boxt	  type; /* type of node */
	struct eqn_box	 *first; /* first child node */
	struct eqn_box	 *last; /* last child node */
	struct eqn_box	 *next; /* node sibling */
	struct eqn_box	 *prev; /* node sibling */
	struct eqn_box	 *parent; /* node sibling */
	char		 *text; /* text (or NULL) */
	char		 *left; /* fence left-hand */
	char		 *right; /* fence right-hand */
	char		 *top; /* expression over-symbol */
	char		 *bottom; /* expression under-symbol */
	size_t		  args; /* arguments in parent */
	size_t		  expectargs; /* max arguments in parent */
	enum eqn_post	  pos; /* position of next box */
	enum eqn_fontt	  font; /* font of box */
	enum eqn_pilet	  pile; /* equation piling */
};

/*
 * An equation consists of a tree of expressions starting at a given
 * line and position.
 */
struct	eqn {
	char		 *name; /* identifier (or NULL) */
	struct eqn_box	 *root; /* root mathematical expression */
	int		  ln; /* invocation line */
	int		  pos; /* invocation position */
};

/*
 * Parse options.
 */
#define	MPARSE_MDOC	1  /* assume -mdoc */
#define	MPARSE_MAN	2  /* assume -man */
#define	MPARSE_SO	4  /* honour .so requests */
#define	MPARSE_QUICK	8  /* abort the parse early */
#define	MPARSE_UTF8	16 /* accept UTF-8 input */
#define	MPARSE_LATIN1	32 /* accept ISO-LATIN-1 input */

enum	mandoc_os {
	MANDOC_OS_OTHER = 0,
	MANDOC_OS_NETBSD,
	MANDOC_OS_OPENBSD
};

enum	mandoc_esc {
	ESCAPE_ERROR = 0, /* bail! unparsable escape */
	ESCAPE_IGNORE, /* escape to be ignored */
	ESCAPE_SPECIAL, /* a regular special character */
	ESCAPE_FONT, /* a generic font mode */
	ESCAPE_FONTBOLD, /* bold font mode */
	ESCAPE_FONTITALIC, /* italic font mode */
	ESCAPE_FONTBI, /* bold italic font mode */
	ESCAPE_FONTROMAN, /* roman font mode */
	ESCAPE_FONTPREV, /* previous font mode */
	ESCAPE_NUMBERED, /* a numbered glyph */
	ESCAPE_UNICODE, /* a unicode codepoint */
	ESCAPE_BREAK, /* break the output line */
	ESCAPE_NOSPACE, /* suppress space if the last on a line */
	ESCAPE_HORIZ, /* horizontal movement */
	ESCAPE_HLINE, /* horizontal line drawing */
	ESCAPE_SKIPCHAR, /* skip the next character */
	ESCAPE_OVERSTRIKE /* overstrike all chars in the argument */
};

typedef	void	(*mandocmsg)(enum mandocerr, enum mandoclevel,
			const char *, int, int, const char *);


struct	mparse;
struct	roff_man;

enum mandoc_esc	  mandoc_escape(const char **, const char **, int *);
void		  mchars_alloc(void);
void		  mchars_free(void);
int		  mchars_num2char(const char *, size_t);
const char	 *mchars_uc2str(int);
int		  mchars_num2uc(const char *, size_t);
int		  mchars_spec2cp(const char *, size_t);
const char	 *mchars_spec2str(const char *, size_t, size_t *);
struct mparse	 *mparse_alloc(int, enum mandocerr, mandocmsg,
			enum mandoc_os, const char *);
void		  mparse_free(struct mparse *);
void		  mparse_keep(struct mparse *);
int		  mparse_open(struct mparse *, const char *);
enum mandoclevel  mparse_readfd(struct mparse *, int, const char *);
void		  mparse_reset(struct mparse *);
void		  mparse_result(struct mparse *,
			struct roff_man **, char **);
const char	 *mparse_getkeep(const struct mparse *);
const char	 *mparse_strerror(enum mandocerr);
const char	 *mparse_strlevel(enum mandoclevel);
void		  mparse_updaterc(struct mparse *, enum mandoclevel *);
@


1.183
log
@report trailing delimiters after macros where they are usually a mistake;
the idea came up in a discussion with Thomas Klausner <wiz at NetBSD>
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.182 2017/07/03 13:40:00 schwarze Exp $ */
a340 1
	EQN_LISTONE, /* singleton list */
@


1.182
log
@warn about time machines; suggested by Thomas Klausner <wiz @@ NetBSD>
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.181 2017/07/02 15:31:48 schwarze Exp $ */
d65 2
a66 2
	MANDOCERR_ND_DOT, /* description line ends with a full stop */
	MANDOCERR_DELIM, /* no blank before trailing delimiter: macro ... */
@


1.181
log
@add warning "cross reference to self"; inspired by mdoclint
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.180 2017/07/01 09:47:23 schwarze Exp $ */
d79 1
@


1.180
log
@Basic reporting of .Xrs to manual pages that don't exist
in the base system, inspired by mdoclint(1).

We are able to do this because (1) the -mdoc parser, the -Tlint validator,
and the man(1) manual page lookup code are all in the same program
and (2) the mandoc.db(5) database format allows fast lookup.

Feedback from, previous versions tested by, and OK jmc@@.

A few features will be added to this in the tree, step by step.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.179 2017/06/29 15:21:46 schwarze Exp $ */
d100 1
@


1.179
log
@warn about some non-portable idioms in .Bl -column;
triggered by a question from Yuri Pankov (illumos)
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.178 2017/06/25 17:42:37 schwarze Exp $ */
d54 1
@


1.178
log
@Catch typos in .Sh names; suggested by jmc@@.

I'm using a very simple, linear time / zero space fuzzy string
matching heuristic rather than a full Levenshtein metric, to keep
the code both simple and fast.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.177 2017/06/24 18:58:09 schwarze Exp $ */
d112 1
d131 1
@


1.177
log
@operating system dependent message about unknown architecture;
inspired by mdoclint
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.176 2017/06/24 15:59:28 schwarze Exp $ */
d59 1
@


1.176
log
@in the base system, suggest leaving .Os blank; inspired by mdoclint
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.175 2017/06/24 14:38:27 schwarze Exp $ */
d51 1
@


1.175
log
@Split -Wstyle into -Wstyle and the even lower -Wbase, and add
-Wopenbsd and -Wnetbsd to check conventions for the base system of
a specific operating system.  Mark operating system specific messages
with "(OpenBSD)" at the end.

Please use just "-Tlint" to check base system manuals (defaulting
to -Wall, which is now -Wbase), but prefer "-Tlint -Wstyle" for the
manuals of portable software projects you maintain that are not
part of OpenBSD base, to avoid bogus recommendations about base
system conventions that do not apply.

Issue originally reported by semarie@@, solution using
an idea from tedu@@, discussed with jmc@@ and jca@@.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.174 2017/06/17 23:06:43 schwarze Exp $ */
d51 1
@


1.174
log
@style message about duplicate RCS ids; inspired by mdoclint
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.173 2017/06/17 22:40:27 schwarze Exp $ */
d47 1
a47 1
	MANDOCERR_STYLE, /* ===== start of style suggestions ===== */
d51 4
a55 1
	MANDOCERR_RCS_MISSING, /* RCS id missing */
d419 6
d460 2
a461 1
struct mparse	 *mparse_alloc(int, enum mandoclevel, mandocmsg, const char *);
@


1.173
log
@style message about missing RCS ids; inspired by mdoclint
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.172 2017/06/14 01:31:19 schwarze Exp $ */
d53 1
@


1.172
log
@implement the roff(7) \p (break output line) escape sequence
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.171 2017/06/11 19:36:31 schwarze Exp $ */
d52 1
@


1.171
log
@Style message about legacy man(7) date format in mdoc(7) documents
and operating system dependent messages about missing or unexpected
Mdocdate; inspired by mdoclint(1).
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.170 2017/06/11 17:16:36 schwarze Exp $ */
d426 1
@


1.170
log
@style message about missing .Fn markup; inspired by mdoclint
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.169 2017/06/10 01:48:31 schwarze Exp $ */
d49 3
@


1.169
log
@style message about missing blank before trailing delimiter;
inspired by mdoclint(1), and jmc@@ considers it useful
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.168 2017/06/08 18:11:15 schwarze Exp $ */
d55 1
@


1.168
log
@Implement w layout specifier (minimum column width).
Improve width calculation of text blocks.
Reduces the groff/mandoc diff in Base+Xenocara by about 800 lines.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.167 2017/06/08 00:21:23 schwarze Exp $ */
d54 1
@


1.167
log
@Portable mandoc just got a warning about unknown .Lb names
which we don't want in OpenBSD, but let's keep the message table
and the manual page in sync.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.166 2017/06/07 23:29:31 schwarze Exp $ */
d249 3
a252 2
	enum tbl_cellt	  pos;
	size_t		  spacing;
d263 1
a290 1
	int		  spans; /* how many spans follow */
d293 2
@


1.166
log
@style checks related to .Er; inspired by mdoclint(1)
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.165 2017/06/06 15:00:56 schwarze Exp $ */
d138 1
@


1.165
log
@Minimal implementation of the roff(7) .ce request (center a number
of input lines without filling).
Contrary to groff, high-level macros abort .ce mode for now.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.164 2017/06/03 15:54:09 schwarze Exp $ */
d51 2
@


1.164
log
@ignore blank lines in man(7) next line scope;
strange groff edge case behaviour found in multimedia/mjpegtools
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.163 2017/06/02 19:21:03 schwarze Exp $ */
d188 1
@


1.163
log
@Partial implementation of \h (horizontal line drawing function).
A full implementation would require access to output device properties
and state variables (both only available after the main parser has
finalized the parse tree) before numerical expansions in the roff
preprocessor (i.e., before the main parser is even started).

Not trying to pull that stunt right now because the static-width
implementation committed here is sufficient for tcl-style manual pages
and already more complicated than i would have suspected.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.162 2017/06/01 19:05:15 schwarze Exp $ */
d100 1
@


1.162
log
@Minimal implementation of the \h (horizontal motion) escape sequence.
Good enough to cope with the average DocBook insanity.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.161 2017/06/01 15:24:41 schwarze Exp $ */
d415 1
@


1.161
log
@STYLE message about full stop at the end of .Nd; inspired by mdoclint(1)
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.160 2017/05/31 15:30:12 schwarze Exp $ */
d414 1
@


1.160
log
@STYLE message about missing use of Ox/Nx/Fx/Dx; OK jmc@@ wiz@@
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.159 2017/05/30 19:29:31 schwarze Exp $ */
d51 1
@


1.159
log
@STYLE message about useless macros we don't want (Bt Tn Ud);
not a WARNING because they don't endanger portability
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.158 2017/05/16 19:05:36 schwarze Exp $ */
d50 1
@


1.158
log
@Introduce a new mandoc(1) message level, -W style, below -W warning.
Switch -W all from meaning -W warning to meaning -W style.
The meaning of -T lint does *not* change, it still implies -W warning.
No messages on the new level yet, but they will come.

Usually, i do not lightly make the user interface larger.
But this has been planned for years, and EXIT STATUS 1
was reserved for it all the time.  The message system
is now stable enough to finally implement it.

jmc@@ regarding the concept: "really good idea"
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.157 2017/03/06 17:25:24 schwarze Exp $ */
d48 2
@


1.157
log
@Using .Nd only makes sense in the NAME section.
Warn if that macro occurs elsewhere.
Triggered by a question from Dag-Erling Smoergrav <des @@ FreeBSD>.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.156 2017/01/28 23:26:56 schwarze Exp $ */
d31 1
a31 1
	MANDOCLEVEL_RESERVED,
d46 2
@


1.156
log
@Add a warning "new sentence, new line".
This does not attempt to pinpoint each and every offender, but
instead tries very hard to avoid false positives: Currently, there
are only two false positives in the whole OpenBSD base system.
Only do this in mdoc(7), not in man(7), because manuals written
in man(7) typically have much worse problems than this.
OK jmc@@ on a previous version of the patch
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.155 2017/01/09 01:36:22 schwarze Exp $ */
d74 1
@


1.155
log
@Warnings and errors that occur during mdoc_validate()
or during man_validate() have to affect the mandoc(1) EXIT STATUS.
Many thanks to <Yuri dot Pankov at gmail dot com> (illumos developer)
for reporting this regression.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.154 2017/01/08 00:10:22 schwarze Exp $ */
d137 1
@


1.154
log
@Stricter validation of the NAME section, in particular:
- require a comma between names
- reject all other text nodes
- reject all empty Nm below NAME, not only in the leading position
- reject Nm after Nd
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.153 2016/12/28 17:21:17 schwarze Exp $ */
d436 1
@


1.153
log
@Make the second, section number argument of .Xr mandatory.
In fact, we have been requiring it for many years.
The only reason to not warn when it was missing
was excessive traditionalism - it was optional in 4.4BSD.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.152 2016/10/09 18:16:46 schwarze Exp $ */
d4 1
a4 1
 * Copyright (c) 2010-2016 Ingo Schwarze <schwarze@@openbsd.org>
d68 1
a68 1
	MANDOCERR_NAMESEC_NONM, /* NAME section without name */
d72 1
@


1.152
log
@Delete complicated code dealing with .Bl -tag without -width,
and just let it default to -width 6n, which agrees with the
traditional -width Ds that is still in widespread use.

I just pushed a patch upstream to GNU roff that does the same for
groff_mdoc(7).  Before, groff contained code that was even more
complicated than mandoc, but both resulted in quite different
user-visible output.  Now, both agree, and output is nicer for both.

Useless complication noticed by Carsten Kunze (Heirloom roff).
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.151 2016/01/08 02:53:09 schwarze Exp $ */
d110 1
@


1.151
log
@Simplify the mparse_open() interface.
Just return the file descriptor or -1 on error;
there is just one kind of error anyway.
Suggested by Christos Zoulas (NetBSD).
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.150 2015/11/07 13:57:55 schwarze Exp $ */
d101 1
a101 1
	MANDOCERR_BL_NOWIDTH, /* missing -width in -tag list, using 8n */
@


1.150
log
@In private header files, __BEGIN_DECLS and __END_DECLS are pointless.
Because these work slightly differently on different systems,
they are becoming a maintenance burden in the portable version,
so delete them.

Besides, one of the chief design goals of the mandoc toolbox is to
make sure that nothing related to documentation requires C++.
Consequently, linking mandoc against any kind of C++ program would
defeat the purpose and is not supported.
I don't understand why kristaps@@ added them in the first place.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.149 2015/10/30 19:03:36 schwarze Exp $ */
d4 1
a4 1
 * Copyright (c) 2010-2015 Ingo Schwarze <schwarze@@openbsd.org>
d426 1
a426 1
enum mandoclevel  mparse_open(struct mparse *, int *, const char *);
@


1.149
log
@If a .Bd block has no arguments at all, drop the block and only keep
its contents.  Removing a gratuitious difference to groff output
found after a related bug report from krw@@.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.148 2015/10/13 22:57:49 schwarze Exp $ */
a410 1
__BEGIN_DECLS
a433 2

__END_DECLS
@


1.148
log
@Major character table cleanup:
* Use ohash(3) rather than a hand-rolled hash table.
* Make the character table static in the chars.c module:
There is no need to pass a pointer around, we most certainly
never want to use two different character tables concurrently.
* No need to keep the characters in a separate file chars.in;
that merely encourages downstream porters to mess with them.
* Sort the characters to agree with the mandoc_chars(7) manual page.
* Specify Unicode codepoints in hex, not decimal (that's the detail
that originally triggered this patch).
No functional change, minus 100 LOC, and i don't see a performance change.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.147 2015/09/14 15:35:47 schwarze Exp $ */
d175 1
@


1.147
log
@Remove the warning about children of .Vt blocks because actually,
.Vt type global_variable No = Dv defined_constant ;
is the best way to specify in the SYNOPSIS how a global variable
is initialized in the rare case where that matters.
Issue noticed by jmc@@.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.146 2015/07/19 05:59:07 schwarze Exp $ */
a412 1
struct	mchars;
d416 2
a417 2
struct mchars	 *mchars_alloc(void);
void		  mchars_free(struct mchars *);
d421 3
a423 6
int		  mchars_spec2cp(const struct mchars *,
			const char *, size_t);
const char	 *mchars_spec2str(const struct mchars *,
			const char *, size_t, size_t *);
struct mparse	 *mparse_alloc(int, enum mandoclevel, mandocmsg,
			const struct mchars *, const char *);
@


1.146
log
@Do not fork and exec gunzip(1), just link with libz instead.
As discussed with deraadt@@, that's cleaner and will help tame(2).
Something like this was also suggested earlier by bapt at FreeBSD.
Minus 50 lines of code, deleting one interface function (mparse_wait),
no functional change intended.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.145 2015/04/18 16:34:03 schwarze Exp $ */
a88 1
	MANDOCERR_VT_CHILD, /* .Vt block has child macro: macro */
@


1.145
log
@Profit from the unified struct roff_man and reduce the number of
arguments of mparse_result() by one.  No functional change.
Written on the ICE Bruxelles-Koeln on the way back from p2k15.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.144 2015/04/18 16:04:40 schwarze Exp $ */
a438 1
enum mandoclevel  mparse_wait(struct mparse *);
@


1.144
log
@Replace the structs mdoc and man by a unified struct roff_man.
Almost completely mechanical, no functional change.
Written on the train from Exeter to London returning from p2k15.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.143 2015/02/23 13:30:02 schwarze Exp $ */
d434 1
a434 1
void		  mparse_result(struct mparse *, struct roff_man **,
@


1.143
log
@improve NAME section diagnostics;
confusing messages reported by Jan Stary <hans at stare dot cz>
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.142 2015/02/06 16:05:51 schwarze Exp $ */
d10 1
a10 1
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
d12 1
a12 1
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
d415 1
a415 2
struct	mdoc;
struct	man;
d434 2
a435 2
void		  mparse_result(struct mparse *,
			struct mdoc **, struct man **, char **);
@


1.142
log
@replace the last legacy generic message type, "argument count wrong",
by more specific messages, improving diagnostics for .cc .tr .Bl -column
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.141 2015/02/06 11:54:03 schwarze Exp $ */
d68 4
a71 1
	MANDOCERR_NAMESEC_BAD, /* bad NAME section contents: macro */
@


1.141
log
@better error reporting regarding .OP .RS .UR .TH arguments
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.140 2015/02/06 07:12:34 schwarze Exp $ */
d120 1
d127 1
a171 1
	MANDOCERR_ARGCOUNT, /* argument count wrong */
@


1.140
log
@Delete the legacy generic warning type MANDOCERR_ARGCWARN,
replacing the last instances by more specific warnings.
Improved functionality, minus 50 lines of code.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.139 2015/02/06 03:31:11 schwarze Exp $ */
d109 2
@


1.139
log
@better handle .Fo and .Fd without argument
better handle .Fo with more than one argument
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.138 2015/02/04 18:03:28 schwarze Exp $ */
d95 1
a96 1
	MANDOCERR_ARGCWARN, /* argument count wrong */
@


1.138
log
@discard .Rs head arguments and improve .Rs diagnostics
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.137 2015/02/04 16:38:31 schwarze Exp $ */
d101 1
@


1.137
log
@more specific .Nd diagnostics, allowing to get rid of enum check_lvl
and the respective argument of check_count()
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.136 2015/01/30 17:31:20 schwarze Exp $ */
d106 1
@


1.136
log
@Delete the redundant tbl span flags, just inspect the actual data
where needed, which is less fragile.
This fixes a subtle NULL pointer access to tp->tbl.cols:
Due to a bug in the man(7) parser, the first span of a table can
end up in a .TP head, in which case tblcalc() was never called.
Found by jsg@@ with afl.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.135 2015/01/30 04:08:37 schwarze Exp $ */
d69 1
@


1.135
log
@Abolish struct tbl_head and replace it by an "int col" member in
struct tbl_cell.  No functional change, minus 40 lines of code.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.134 2015/01/28 21:10:28 schwarze Exp $ */
a287 3
	int		  flags;
#define	TBL_SPAN_FIRST	 (1 << 0)
#define	TBL_SPAN_LAST	 (1 << 1)
@


1.134
log
@Clean up eqn(7) error handling:
* When "define" fails, do not drop the whole equation.
* Free memory after "undef".
* Use standard mandoc error types instead of rolling our own.
* Delete obfuscating EQN_MSG() macro.
* Add function prototypes while here.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.133 2015/01/28 17:30:37 schwarze Exp $ */
a206 11
/*
 * The head of a table specifies all of its columns.  When formatting a
 * tbl_span, iterate over these and plug in data from the tbl_span when
 * appropriate, using tbl_cell as a guide to placement.
 */
struct	tbl_head {
	int		  ident; /* 0 <= unique id < cols */
	struct tbl_head	 *next;
	struct tbl_head	 *prev;
};

d228 1
a237 1
	struct tbl_head	 *head;
a281 1
	struct tbl_head	 *head;
@


1.133
log
@* Polish tbl(7) error reporting.
* Do not print out macro names in tbl(7) data blocks.
* Like with GNU tbl, let empty tables cause a blank line.
* Avoid producing empty tables in -Tman.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.132 2015/01/27 05:20:30 schwarze Exp $ */
a135 6

	/* related to equations */
	MANDOCERR_EQNNSCOPE, /* unexpected equation scope closure*/
	MANDOCERR_EQNSCOPE, /* equation scope open on exit */
	MANDOCERR_EQNBADSCOPE, /* overlapping equation scopes */
	MANDOCERR_EQNEOF, /* unexpected end of equation */
@


1.132
log
@Multiple parser and formatter fixes for line drawing in tbl(7).
* Allow mixing vertical line bars with the layout options
of the preceding layout cell.
* Correctly combine box options with layout lines.
* Correctly print vertical lines in data rows, with the right spacing.
* Correctly print cross markers and left and right ends of
horizontal lines even if vertical lines differ above and below.
* Avoid the bogus error message "no table data cells"
when a table data section starts with a horizontal line.
No increase in code size.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.131 2015/01/26 18:41:45 schwarze Exp $ */
d146 2
a147 2
	MANDOCERR_TBLOPT_NOARG, /* missing tbl option argument */
	MANDOCERR_TBLOPT_ARGSZ, /* wrong tbl option argument size */
d151 4
a154 4
	MANDOCERR_TBLNODATA, /* no table data cells specified */
	MANDOCERR_TBLIGNDATA, /* ignore data in cell */
	MANDOCERR_TBLBLOCK, /* data block still open */
	MANDOCERR_TBLEXTRADAT, /* ignoring extra data cells */
d189 1
a191 1
	MANDOCERR_TBLEQN, /* eqn in tbl */
@


1.131
log
@Rework tbl(7) layout parsing:
* Continue parsing even if part of the input is invalid.
* Do not require whitespace between cell specifications.
* Allow tabs as well as blanks between modifiers.
* Mark the 'm' modifier as unsupported.
* Parse and ignore the 'p' and 'v' modifiers.
* Better warning and error messages.
* Get rid of a static buffer.
Improved functionality but minus 50 lines of code.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.130 2015/01/26 13:02:53 schwarze Exp $ */
d209 2
a219 1
	int		  vert; /* width of preceding vertical line */
d242 1
a242 1
	int		  vert; /* width of preceding vertical line */
d264 1
a264 1
	int		  vert; /* trailing vertical line */
d303 2
a309 1
	struct tbl_span	 *next;
@


1.130
log
@More improvements regarding tbl(7) options.
* Treat "allbox" as an alias for "box" for now.
* Parse and ignore the GNU tbl "nowarn" option.
* For separation, allow spaces, tabs, and commas only.
* Mark eqn(7) within tbl(7) as unsupported.
* Simplify the option table.
* Improve and sort documentation.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.129 2015/01/26 00:54:09 schwarze Exp $ */
d130 5
d148 3
a150 1
	MANDOCERR_TBLNOLAYOUT, /* no table layout cells specified */
d189 1
a189 1
	MANDOCERR_TBLLAYOUT, /* unsupported table layout */
@


1.129
log
@Improve (or rather, rewrite) tbl(7) option parsing.
* Allow the layout to start after the semicolon on the options line.
* Ignore leading commas.
* Option arguments cannot contain closing parentheses.
* Avoid needless UNSUPP messages.
* Better ERROR reporting.
* Delete unused "linesize" field in struct tbl_opts.
* No need for static buffers.
* Garbage collect one almost empty wrapper function.
Improved functionality, but minus 40 lines of code.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.128 2015/01/24 01:59:40 schwarze Exp $ */
d184 1
d200 1
@


1.128
log
@Support .RE with an argument; needed for audio/pms(1).
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.127 2015/01/22 21:36:44 schwarze Exp $ */
d139 4
a181 2
	MANDOCERR_TBL, /* unsupported table syntax */
	MANDOCERR_TBLOPT, /* unsupported table option */
a190 1
	int		  linesize;
@


1.127
log
@Traditional roff(7) explicitly allows certain control characters
in the input stream (SOH, STX, ETX, ENQ, ACK, BEL, BS) for specific
purposes (leaders, backspace, delimiters, .tr), but making sure
these don't leak through to the output is tricky, so mark them as
unsupported for now.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.126 2015/01/21 20:20:49 schwarze Exp $ */
d154 1
@


1.126
log
@Rudimentary implementation of the roff(7) \o escape sequence (overstrike).
This is of some relevance because the pod2man(1) preamble abuses it
for the icelandic letter Thorn, instead of simply using \(TP and \(Tp.
Missing feature found by sthen@@ in DateTime::Locale::is_IS(3p).
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.125 2015/01/20 21:12:46 schwarze Exp $ */
d148 1
a148 1
	MANDOCERR_BADCHAR, /* skipping bad character: number */
d175 1
@


1.125
log
@Split the -Werror message level into -Werror (broken manual, probably
using mandoc is better than using groff) and -Wunsupp (manual using
unsupported low-level roff(7) feature, probably using groff is better
than using mandoc).  Once this feature is complete, it is intended
to help porting, making the decision whether to USE_GROFF easier.

As a first step, distinguish four classes of roff(7) requests:
1. Supported (currently 24 requests)
2. Currently ignored because unimportant (120)  ->  no message
3. Ignored for good because insecure (14)  ->  -Werror
4. Currently unsupported (68)  ->  these trigger the new -Wunsupp messages
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.124 2015/01/15 04:26:06 schwarze Exp $ */
d402 2
a403 1
	ESCAPE_SKIPCHAR /* skip the next character */
@


1.124
log
@Fatal errors no longer exist.
If a file can be opened, mandoc will produce some output;
at worst, the output may be almost empty.
Simplifies error handling and frees a message type for future use.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.123 2015/01/15 02:29:07 schwarze Exp $ */
d4 1
a4 1
 * Copyright (c) 2010-2014 Ingo Schwarze <schwarze@@openbsd.org>
d34 1
a34 1
	MANDOCLEVEL_FATAL, /* input is borked */
a138 3
	MANDOCERR_TBL, /* bad table syntax */
	MANDOCERR_TBLOPT, /* bad table option */
	MANDOCERR_TBLLAYOUT, /* bad table layout */
a143 1
	MANDOCERR_TBLMACRO, /* ignoring macro in table: macro */
a146 1
	MANDOCERR_TOOLARGE, /* input too large */
d150 1
d171 9
@


1.123
log
@downgrade .so failure from FATAL to ERROR
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.122 2015/01/14 22:57:57 schwarze Exp $ */
d151 1
a174 4

	MANDOCERR_FATAL, /* ===== start of fatal errors ===== */

	MANDOCERR_TOOLARGE, /* input too large */
@


1.122
log
@downgrade ".so with absolute path" from FATAL to ERROR;
allows to get rid of ROFF_ERR
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.121 2015/01/14 22:02:00 schwarze Exp $ */
d170 1
a177 1
	MANDOCERR_SO_FAIL, /* .so request failed */
@


1.121
log
@To get rid of SYSERR entries in enum mandocerr, downgrade problems with
missing and unreadable files from SYSERR to ERROR.
Needed for upcoming work.
As a bonus, this minimally simplifies code and documentation.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.120 2015/01/14 17:45:25 schwarze Exp $ */
d169 1
a176 1
	MANDOCERR_SO_PATH, /* NOT IMPLEMENTED: .so with absolute path or ".." */
@


1.120
log
@Simplify handling of system errors: just exit(3).
We already do the same for malloc(3) failure.
The is no virtue in trying to survive failure of fork(2) and the like.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.119 2014/12/16 23:44:16 schwarze Exp $ */
d150 1
a177 6

	/* ===== system errors ===== */

	MANDOCERR_SYSEXIT, /* gunzip failed with code */
	MANDOCERR_SYSOPEN, /* cannot open file */
	MANDOCERR_SYSSIG, /* gunzip died from signal */
@


1.119
log
@Ignore mdoc(7) and man(7) macros inside tbl(7) code because they
would abort the table in an unclean way, causing assertion failures
found by jsg@@.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.118 2014/12/01 08:05:02 schwarze Exp $ */
a179 2
	MANDOCERR_SYSDUP, /* cannot dup file descriptor */
	MANDOCERR_SYSEXEC, /* cannot exec */
a180 1
	MANDOCERR_SYSFORK, /* cannot fork */
a181 2
	MANDOCERR_SYSPIPE, /* cannot open pipe */
	MANDOCERR_SYSREAD, /* cannot read file */
a182 2
	MANDOCERR_SYSSTAT, /* cannot stat file */
	MANDOCERR_SYSWAIT, /* wait failed */
@


1.118
log
@header cleanup:
* add missing forward declarations
* remove needless header inclusions
* some style unification
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.117 2014/11/30 05:28:00 schwarze Exp $ */
d147 1
@


1.117
log
@Multiple fixes with respect to .Pf:
* The first argument of .Pf is not parsed.
* Normal delimiter handling does not apply to the first argument of .Pf.
* Warn if nothing follows a prefix (inspired by groff_mdoc(7)).
* In that case, do not suppress spacing.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.116 2014/11/30 02:31:32 schwarze Exp $ */
d417 2
a422 2

__BEGIN_DECLS
@


1.116
log
@warn about attempts to call non-callable macros;
inspired by a similar warning in the groff_mdoc(7) macros
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.115 2014/11/28 18:07:38 schwarze Exp $ */
d104 1
@


1.115
log
@Drop useless architecture table.  Validating architecture names
is a job for makewhatis(8)/mandoc.db(5), not for the parser.
Removes 150 lines from source files and 4k (1%) from the binary.
Bloat found by deraadt@@.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.114 2014/11/27 23:35:03 schwarze Exp $ */
d78 1
@


1.114
log
@Downgrade .Bd -file from FATAL to ERROR.
Since this was the last remaining FATAL error in this area,
this change will allow major simplifications in the mdoc(7) parser.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.113 2014/11/27 14:31:29 deraadt Exp $ */
a54 1
	MANDOCERR_ARCH_BAD, /* unknown manual volume or arch: Dt ... volume */
@


1.113
log
@remove unneccessary inclusion protection; ok schwarze
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.112 2014/11/26 21:40:11 schwarze Exp $ */
d160 1
a172 1
	MANDOCERR_BD_FILE, /* NOT IMPLEMENTED: Bd -file */
@


1.112
log
@Simplify the mparse_open()/mparse_wait() interface.
Don't bother the user with the PID of the child process,
store it inside the opaque mparse handle.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.111 2014/10/30 00:05:02 schwarze Exp $ */
a17 2
#ifndef MANDOC_H
#define MANDOC_H
a447 2

#endif /*!MANDOC_H*/
@


1.111
log
@support UTF-8 and ISO-8859-1 input by integrating modified parts
of kristaps@@' version of the preconv(1) utility into mandoc(1);
positive feedback from bentley@@ and no concern raised when shown on tech@@
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.110 2014/10/29 00:17:01 schwarze Exp $ */
d439 1
a439 2
enum mandoclevel  mparse_open(struct mparse *, int *, const char *,
			pid_t *);
d447 1
a447 1
enum mandoclevel  mparse_wait(struct mparse *, pid_t);
@


1.110
log
@In terminal output, unify handling of Unicode and numbered character
escape sequences just like it was earlier implemented for -Thtml.
Do not let control characters other than ASCII 9 (horizontal tab)
propagate to the output, even though groff allows them; but that
really doesn't look like a great idea.

Let mchars_num2char() return int such that we can distinguish invalid \N
syntax from \N'0'.  This also reduces the danger of signed char issues
popping up.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.109 2014/10/28 17:35:42 schwarze Exp $ */
d396 2
@


1.109
log
@Make the character table available to libroff so it can check the
validity of character escape names and warn about unknown ones.
This requires mchars_spec2cp() to report unknown names again.
Fortunately, that doesn't require changing the calling code because
according to groff, invalid character escapes should not produce
output anyway, and now that we warn about them, that's fine.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.108 2014/10/26 18:06:28 schwarze Exp $ */
d426 1
a426 1
char		  mchars_num2char(const char *, size_t);
@


1.108
log
@In -Tascii mode, provide approximations even for some Unicode escape
sequences above codepoint 512 by doing a reverse lookup in the
existing mandoc_char(7) character table.

Again, groff isn't smart enough to do this and silently discards such
escape sequences without printing anything.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.107 2014/10/20 19:21:31 schwarze Exp $ */
d434 1
a434 1
			const char *);
@


1.107
log
@protect the roff parser from dividing by zero;
issue found and patch written by kristaps@@
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.106 2014/10/14 02:16:02 schwarze Exp $ */
d427 1
@


1.106
log
@Rudimentary implementation of the e, x, and z table layout modifiers
to equalize, maximize, and ignore the width of columns.
Does not yet take vertical rulers into account,
and does not do line breaks within table cells.
Considerably improves the lftp(1) manual; issue noticed by sthen@@.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.105 2014/10/12 19:10:56 schwarze Exp $ */
d169 1
@


1.105
log
@Improve error handling in the eqn(7) parser.
Get rid of the first fatal error, MANDOCERR_EQNSYNT.
In eqn(7), there is no need to be bug-compatible with groff, so there
is no need to abondon the whole equation in case of a syntax error.

In particular:
* Skip "back", "delim", "down", "fwd", "gfont", "gsize", "left",
  "right", "size", and "up" without arguments.
* Skip "gsize" and "size" with a non-numeric argument.
* Skip closing delimiters that are not open.
* Skip "above" outside piles.
* For diacritic marks and binary operators without a left operand,
  default to an empty box.
* Let piles and matrices take one argument rather than insisting
  on a braced list.  Let HTML output handle that, too.
* When rewinding, if the root box is guaranteed to match
  the termination condition, no error handling is needed.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.104 2014/10/11 21:14:11 schwarze Exp $ */
d249 1
@


1.104
log
@warn about parentheses in function names after .Fn and .Fo;
particularly useful when converting from other languages to mdoc(7);
feature suggested by bentley@@
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.103 2014/10/10 15:25:06 schwarze Exp $ */
d107 1
a137 1
	MANDOCERR_EQNSYNT, /* equation syntax error */
@


1.103
log
@Partial eqn(7) rewrite by kristaps@@ in order to get operator precedence right.
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.102 2014/10/09 15:59:08 schwarze Exp $ */
d117 1
@


1.102
log
@parse and render "from" and "to" clauses in eqn, and render matrices;
written by kristaps@@ during EuroBSDCon
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.101 2014/10/09 15:21:46 schwarze Exp $ */
d309 4
a312 15
	EQN_LIST, /* subexpressions list */
	EQN_MATRIX /* matrix subexpression */
};

enum	eqn_markt {
	EQNMARK_NONE = 0,
	EQNMARK_DOT,
	EQNMARK_DOTDOT,
	EQNMARK_HAT,
	EQNMARK_TILDE,
	EQNMARK_VEC,
	EQNMARK_DYAD,
	EQNMARK_BAR,
	EQNMARK_UNDER,
	EQNMARK__MAX
a325 1
	EQNPOS_OVER,
d332 2
d364 6
a369 2
	char		 *left;
	char		 *right;
a370 1
	enum eqn_markt	  mark; /* a mark about the box */
@


1.101
log
@parse simultaneous sub- and superscripts
and make the eqn_box list doubly linked;
written by kristaps@@ during EuroBSDCon
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.100 2014/09/12 00:53:21 schwarze Exp $ */
d3 1
a3 1
 * Copyright (c) 2010, 2011 Kristaps Dzonsons <kristaps@@bsd.lv>
d343 1
@


1.100
log
@warn about commas in function arguments; inspired by mdoclint(1)
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.99 2014/09/11 23:52:47 schwarze Exp $ */
d339 1
d370 1
@


1.99
log
@warn about botched .Xr ordering and punctuation below SEE ALSO;
inspired by mdoclint(1)
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.98 2014/09/07 23:24:33 schwarze Exp $ */
d116 1
@


1.98
log
@warn about AUTHORS sections without .An macros, inspired by mdoclint(1)
@
text
@d1 1
a1 1
/*	$OpenBSD: mandoc.h,v 1.97 2014/09/03 23:20:33 schwarze Exp $ */
d75 2
@


1.97
log
@Add *.gz support to apropos(1) -a, manm(1), and even mandoc(1).
Implemented by moving the zip code from makewhatis(8) to the parser lib.
@
text
@d1 1
a1 1
/*	$OpenBSD$ */
d75 1
@


1.96
log
@Bring the handling of defective prologues even closer to groff,
in particular relaxing the distinction between prologue and body
and further improving messages.
* The last .Dd wins and the last .Os wins, even in the body.
* The last .Dt before the first body macro wins.
* Missing title in .Dt defaults to UNTITLED.  Warn about it.
* Missing section in .Dt does not default to 1.  But warn about it.
* Do not warn multiple times about the same mdoc(7) prologue macro.
* Warn about missing .Os.
* Incomplete .TH defaults to empty strings.  Warn about it.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.95 2014/08/08 15:54:10 schwarze Exp $ */
d174 4
d179 3
d183 1
a183 1
	MANDOCERR_SYSREAD, /* cannot read file */
d433 2
d442 1
@


1.95
log
@mention requests and macros in more messages
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.94 2014/08/08 15:48:43 schwarze Exp $ */
d52 2
a53 1
	MANDOCERR_TH_MISSING, /* missing .TH macro, using "unknown 1" */
d55 1
d60 1
a60 1
	MANDOCERR_PROLOG_ORDER, /* prologue macros out of order: macro */
d62 3
a64 2
	MANDOCERR_PROLOG_BAD, /* incomplete prologue, terminated by: macro */
	MANDOCERR_PROLOG_ONLY, /* skipping prologue macro in body: macro */
@


1.94
log
@Dynamically allocate the stack of roff(7) .ie condition values
and thus get rid of the last useless fatal error.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.93 2014/08/08 15:45:58 schwarze Exp $ */
d54 2
a55 2
	MANDOCERR_MSEC_BAD, /* unknown manual section: section */
	MANDOCERR_ARCH_BAD, /* unknown manual volume or arch: volume */
d64 1
a64 1
	MANDOCERR_SO, /* .so is fragile, better use ln(1): .so path */
d67 1
a67 1
	MANDOCERR_NAMESEC_FIRST, /* first section is not "NAME": title */
d69 3
a71 3
	MANDOCERR_SEC_ORDER, /* sections out of conventional order: title */
	MANDOCERR_SEC_REP, /* duplicate section title: title */
	MANDOCERR_SEC_MSEC, /* unexpected section: title for ... only */
d82 2
a83 2
	MANDOCERR_FI_SKIP, /* fill mode already enabled, skipping .fi */
	MANDOCERR_NF_SKIP, /* fill mode already disabled, skipping .nf */
d92 2
a93 2
	MANDOCERR_BD_NOTYPE, /* missing display type, using -ragged */
	MANDOCERR_BL_LATETYPE, /* list type is not the first argument: arg */
d95 5
a99 5
	MANDOCERR_EX_NONAME, /* missing name for .Ex, using "" */
	MANDOCERR_IT_NOHEAD, /* empty head in list item: type */
	MANDOCERR_IT_NOBODY, /* empty list item: type */
	MANDOCERR_BF_NOFONT, /* missing font type, using \fR */
	MANDOCERR_BF_BADFONT, /* unknown font type, using \fR: macro font */
d106 2
a107 2
	MANDOCERR_BD_REP, /* skipping duplicate display type: type */
	MANDOCERR_BL_REP, /* skipping duplicate list type: type */
d109 1
a109 1
	MANDOCERR_AT_BAD, /* unknown AT&T UNIX version: version */
d112 1
a112 1
	MANDOCERR_FT_BAD, /* unknown font, skipping request: request font */
d143 4
a146 4
	MANDOCERR_BADCHAR, /* skipping bad character */
	MANDOCERR_MACRO, /* skipping unknown macro */
	MANDOCERR_IT_STRAY, /* skipping item outside list */
	MANDOCERR_TA_STRAY, /* skipping column outside column list */
d152 1
a152 1
	MANDOCERR_NAMESC, /* escaped character not allowed in a name */
d154 2
a155 2
	MANDOCERR_BL_NOTYPE, /* missing list type, using -item */
	MANDOCERR_NM_NONAME, /* missing manual name, using "" */
d157 1
a157 1
	MANDOCERR_ST_BAD, /* unknown standard specifier: standard */
d165 1
a165 1
	MANDOCERR_BADDISP, /* NOT IMPLEMENTED: .Bd -file */
@


1.93
log
@Split MANDOCERR_IGNARGV into one message for .An and one for .Bl
and report the macro name and argument.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.92 2014/08/08 15:42:39 schwarze Exp $ */
a167 1
	MANDOCERR_MEM, /* static buffer exhausted */
@


1.92
log
@In .Bl -column, if some of the column width declarations are given
right after the -column argument and some at the very end of the
argument list, after some other arguments like -compact, concatenate
the column lists.
This gets rid of one of the last useless FATAL errors
and actually shortens the code by a few lines.

This fixes an issue introduced more than five years ago, at first
causing an assert() since bsd.lv mdoc_action.c rev. 1.14 (June 17, 2009),
then later a FATAL error since mdoc_validate rev. 1.130 (Nov. 30, 2010),
and marked as "TODO" ever since.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.91 2014/08/08 15:38:46 schwarze Exp $ */
a102 1
	MANDOCERR_IGNARGV, /* skipping argument */
d105 1
d108 1
@


1.91
log
@Remove the useless FATAL error "argument count wrong, violates syntax".
The last remaining instance was .It in .Bl -column with more than one
excessive .Ta.  However, simply downgrading from FATAL to ERROR, it just
works fine, almost the same way as in groff, without any other changes.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.90 2014/08/08 15:26:28 schwarze Exp $ */
a163 1
	MANDOCERR_COLUMNS, /* column syntax is inconsistent */
@


1.90
log
@Get rid of the useless FATAL error "child violates parent syntax".
When finding items outside lists, simply skip them and throw an ERROR.
Handle subsections before the first section instead of bailing out.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.89 2014/08/08 15:21:17 schwarze Exp $ */
a165 1
	MANDOCERR_SYNTARGCOUNT, /* argument count wrong, violates syntax */
@


1.89
log
@Remove two useless FATAL errors.
When a file contains neither text nor macros, treat it as an empty document.
When the mdoc(7) document prologue is incomplete, use some default values.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.88 2014/08/08 15:15:27 schwarze Exp $ */
d144 1
a165 1
	MANDOCERR_SYNTCHILD, /* child violates parent syntax */
@


1.88
log
@better name and wording for the last two non-generic errors
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.87 2014/08/08 15:10:14 schwarze Exp $ */
a162 1
	MANDOCERR_NOTMANUAL, /* not a manual */
a168 1
	MANDOCERR_NODOCPROLOG, /* no document prologue */
@


1.87
log
@Various improvements related to .Ex and .Rv:
* let .Nm fall back to the empty string, not to UNKNOWN
* never let .Rv copy an argument from .Nm
* avoid spurious \fR after empty .Nm in -Tman
* correct handling of .Ex and .Rv in -Tman
* correct the wording of the output for .Rv without arguments
* use non-breaking spaces in .Ex and .Rv output where required
* split MANDOCERR_NONAME into a warning for .Ex and an error for .Nm
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.86 2014/07/09 11:30:07 schwarze Exp $ */
d152 1
d154 1
d156 1
a156 3
	MANDOCERR_UNAME, /* uname(3) system call failed */
	MANDOCERR_NUMERIC, /* request requires a numeric argument */
	MANDOCERR_BL_NOTYPE, /* missing list type, using -item */
@


1.86
log
@mark defos as const; nobody needs to change it,
and it is occasionally useful to be able to pass literal strings
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.85 2014/07/07 21:35:42 schwarze Exp $ */
d95 1
a150 1
	MANDOCERR_NONAME, /* manual name not yet set */
d152 1
@


1.85
log
@Clean up ERROR messages related to document structure and macros:
Hierarchical naming and mention macro names in messages.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.84 2014/07/07 16:12:06 schwarze Exp $ */
d422 2
a423 1
struct mparse	 *mparse_alloc(int, enum mandoclevel, mandocmsg, char *);
@


1.84
log
@no need to delete any content from .Rs blocks,
and downgrade the related message from ERROR to WARNING
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.83 2014/07/07 15:03:24 schwarze Exp $ */
d78 1
a78 1
	MANDOCERR_BLOCK_NEST, /* blocks badly nested: macro ... */
d84 1
a84 1
	MANDOCERR_LINESCOPE, /* line scope broken: macro breaks macro */
d139 1
d142 7
a150 1
	MANDOCERR_MACRO, /* skipping unknown macro */
a152 4
	MANDOCERR_STRAYTA, /* skipping column outside column list */
	MANDOCERR_NOSCOPE, /* skipping end of block that is not open */
	MANDOCERR_SCOPEBROKEN, /* missing end of block */
	MANDOCERR_SCOPEEXIT, /* scope open on exit */
@


1.83
log
@no need to skip content before first section header
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.82 2014/07/07 11:34:41 schwarze Exp $ */
d108 1
a144 1
	MANDOCERR_RS_SKIP, /* skipping invalid content in .Rs block: macro */
@


1.82
log
@implement .dei and .ami
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.81 2014/07/06 19:08:56 schwarze Exp $ */
a141 1
	MANDOCERR_NOTEXT, /* skipping text before first section header */
@


1.81
log
@Clean up messages related to plain text and to escape sequences.
* Mention invalid escape sequences and string names, and fallbacks.
* Hierarchical naming.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.80 2014/07/05 12:33:54 schwarze Exp $ */
a143 1
	MANDOCERR_REQUEST, /* NOT IMPLEMENTED: skipping request */
@


1.80
log
@Cleanup with respect to bad macro arguments.
* Fix .Sm with invalid arg: move arg out and toggle mode.
* Promote "unknown standard" from WARNING to ERROR, it loses information.
* Delete MANDOCERR_BADWIDTH, it would only indicate a mandoc(1) bug.
* Do not report MANDOCERR_BL_LATETYPE when there is no type at all.
* Mention macro names, arguments and fallbacks.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.79 2014/07/05 01:11:33 schwarze Exp $ */
d101 1
a101 1
	/* related to bad macro arguments */
d103 1
d112 6
a117 6
	MANDOCERR_NOBLANKLN, /* blank line in non-literal context */
	MANDOCERR_BADTAB, /* tab in non-literal context */
	MANDOCERR_EOLNSPACE, /* end of line whitespace */
	MANDOCERR_BADCOMMENT, /* bad comment style */
	MANDOCERR_BADESCAPE, /* bad escape sequence */
	MANDOCERR_BADQUOTE, /* unterminated quoted string */
@


1.79
log
@Cleanup regarding -offset and -width:
* Bugfix: Last one wins, not first one.
* Fix .Bl -width without argument: it means 0n, so do not ignore it.
* Report macro names, argument names and fallbacks in related messages.
* Simplify: Garbage collect auxiliary variables in pre_bd() and pre_bl().
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.78 2014/07/04 16:11:41 schwarze Exp $ */
d94 1
a94 1
	MANDOCERR_BL_WIDTH, /* missing -width in -tag list, using 8n */
d98 1
a98 1
	MANDOCERR_BF_BADFONT, /* unknown font type, using \fR: Bf font */
d104 5
a108 7
	MANDOCERR_DISPREP, /* duplicate display type */
	MANDOCERR_LISTREP, /* duplicate list type */
	MANDOCERR_BADATT, /* unknown AT&T UNIX version */
	MANDOCERR_BADBOOL, /* bad Boolean value */
	MANDOCERR_BADFONT, /* unknown font */
	MANDOCERR_BADSTANDARD, /* unknown standard specifier */
	MANDOCERR_BADWIDTH, /* bad width argument */
d146 1
@


1.78
log
@Clean up messages regarding excess arguments:
* Downgrade ".Bf -emphasis Em" from FATAL to WARNING.
* Mention the macros, the arguments, and the fallbacks.
* Hierarchical naming.
Also fix the handling of excess .It head arguments in -Tman.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.77 2014/07/04 01:50:03 schwarze Exp $ */
d90 1
d103 1
a103 1
	MANDOCERR_ARGVREP, /* duplicate argument */
@


1.77
log
@Clean up messages related to missing arguments.
* Do not warn about empty -column cells, they seem valid to me.
* Downgrade empty item and missing -std from ERROR to WARNING.
* Hierarchical naming.
* Descriptive, not imperative style.
* Mention macro names, argument names, and fallbacks.
* Garbage collect some unreachable code in post_it().
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.76 2014/07/03 23:23:45 schwarze Exp $ */
d96 2
a97 1
	MANDOCERR_FONTTYPE, /* missing font type */
d154 2
a155 1
	MANDOCERR_ARGSLOST, /* line argument(s) will be lost */
a162 1
	MANDOCERR_SYNTARGVCOUNT, /* argument count wrong, violates syntax */
@


1.76
log
@Fix formatting of empty .Bl -inset item heads.
Downgrade empty item heads from ERROR to WARNING.
Show the list type in the error message.
Choose better variable names for nodes in post_it().
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.75 2014/07/03 21:23:08 schwarze Exp $ */
d91 5
a95 4
	MANDOCERR_DISPTYPE, /* missing display type */
	MANDOCERR_LISTFIRST, /* list type must come first */
	MANDOCERR_NOWIDTHARG, /* tag lists require a width argument */
	MANDOCERR_IT_NOHEAD, /* missing head in list item: type */
d97 1
a150 3
	/* FIXME: merge following with MANDOCERR_ARGCOUNT */
	MANDOCERR_NOBODY, /* macro requires body argument(s) */
	MANDOCERR_NOARGV, /* macro requires argument(s) */
d152 1
a152 1
	MANDOCERR_LISTTYPE, /* missing list type */
@


1.75
log
@MANDOCERR_NOARGS reported three completely unrelated classes of problems.
Split the roff(7) parts out of it and report the request names for these cases.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.74 2014/07/02 20:18:42 schwarze Exp $ */
d94 1
a149 1
	MANDOCERR_NOARGS, /* macro requires line argument(s) */
@


1.74
log
@Improve and test the messages about empty macros,
in particular reporting the macro names involved.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.73 2014/07/02 13:10:15 schwarze Exp $ */
d86 3
a88 1
	/* related to missing macro arguments */
@


1.73
log
@Disentangle the MANDOCERR_CHILD message, which reported three
completely different things, into three distinct messages.
Also mention the macro names we are talking about.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.72 2014/07/02 11:42:56 schwarze Exp $ */
d87 1
a87 1
	MANDOCERR_MACROEMPTY, /* skipping empty macro */
@


1.72
log
@Clean up warnings related to macros and nesting.
* Hierarchical naming of enum mandocerr items.
* Improve the wording to make it comprehensible.
* Mention the offending macro.
* Garbage collect one chunk of ancient, long unreachable code.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.71 2014/07/02 05:51:49 schwarze Exp $ */
a78 1
	MANDOCERR_CHILD, /* child violates parent syntax */
d80 2
d140 1
@


1.71
log
@Improve "skipping paragraph macro" messages,
showing which macro was skipped and before or after what.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.70 2014/07/02 03:47:07 schwarze Exp $ */
d77 2
a78 2
	MANDOCERR_IGNNS, /* skipping no-space macro */
	MANDOCERR_SCOPENEST, /* blocks badly nested */
d80 4
a83 3
	MANDOCERR_NESTEDDISP, /* nested displays are not portable */
	MANDOCERR_SCOPEREP, /* already in literal mode */
	MANDOCERR_LINESCOPE, /* line scope broken */
a91 1
	MANDOCERR_WNOSCOPE, /* skipping end of block that is not open */
@


1.70
log
@Implement the obsolete macros .En .Es .Fr .Ot for backward compatibility,
since this is hardly more complicated than explicitly ignoring them
as we did in the past.  Of course, do not use them!
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.69 2014/07/01 22:36:35 schwarze Exp $ */
d75 2
a76 2
	MANDOCERR_IGNPAR, /* skipping paragraph macro */
	MANDOCERR_MOVEPAR, /* moving paragraph macro out of list */
@


1.69
log
@Clean up the warnings related to document structure.
* Hierarchical naming of the related enum mandocerr items.
* Mention the offending macro, section title, or string.
While here, improve some wordings:
* Descriptive instead of imperative style.
* Uniform style for "missing" and "skipping".
* Where applicable, mention the fallback used.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.68 2014/06/30 23:45:03 schwarze Exp $ */
d74 1
a74 1
	MANDOCERR_MACROOBS, /* skipping obsolete macro */
@


1.68
log
@garbage collect two unused enum mandocerr items
and fix a couple of comments while here
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.67 2014/06/25 00:19:17 schwarze Exp $ */
d52 10
a61 10
	MANDOCERR_TH_MISSING, /* no TH macro in document */
	MANDOCERR_TITLE_CASE, /* document title should be all caps */
	MANDOCERR_MSEC_BAD, /* unknown manual section */
	MANDOCERR_ARCH_BAD, /* unknown manual volume or arch */
	MANDOCERR_DATE_MISSING, /* date missing, using today's date */
	MANDOCERR_DATE_BAD, /* cannot parse date, using it verbatim */
	MANDOCERR_PROLOG_ORDER, /* prologue macros out of order */
	MANDOCERR_PROLOG_REP, /* duplicate prologue macro */
	MANDOCERR_PROLOG_BAD, /* macro not allowed in prologue: macro */
	MANDOCERR_PROLOG_ONLY, /* macro not allowed in body: macro */
d66 6
a71 6
	MANDOCERR_SEC_BEFORE, /* content before the first section header */
	MANDOCERR_NAMESECFIRST, /* NAME section must come first */
	MANDOCERR_BADNAMESEC, /* bad NAME section contents */
	MANDOCERR_SECOOO, /* sections out of conventional order */
	MANDOCERR_SECREP, /* duplicate section name */
	MANDOCERR_SECMSEC, /* section header suited to sections ... */
d135 1
a135 1
	MANDOCERR_NOTEXT, /* skipping text before the first section header */
@


1.67
log
@Improve messages related to the roff(7) .so request.

In all these messages, show the filename argument that was passed
to the .so request.

In case of failure, show an additional message reporting the file
and the line number where the failing request was found.
The existing message reporting the reason for the failure -
for example, "Permission denied" - is left in place, unchanged.

Inspired by a question asked by Nick@@ after he saw the
confusing old messages that used to be emitted in this area.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.66 2014/06/20 22:58:41 schwarze Exp $ */
d60 2
a61 2
	MANDOCERR_PROLOG_BAD, /* macro not allowed in prologue */
	MANDOCERR_PROLOG_ONLY, /* macro not allowed in body */
d64 1
a64 1
	MANDOCERR_SO, /* .so is fragile, better use ln(1) */
d109 1
a109 1
	MANDOCERR_BADESCAPE, /* unknown escape sequence */
a111 3
	/* related to equations */
	MANDOCERR_EQNQUOTE, /* unexpected literal in equation */

a150 1
	MANDOCERR_BODYLOST, /* body argument(s) will be lost */
d155 1
a155 1
	MANDOCERR_NOTMANUAL, /* manual isn't really a manual */
@


1.66
log
@As suggested by jmc@@, only include line and column numbers into messages
when they are meaningful, to avoid confusing stuff like this:
$ mandoc /dev/null
mandoc: /dev/null:0:1: FATAL: not a manual
Instead, just say:
mandoc: /dev/null: FATAL: not a manual

Another example this applies to is documents having a prologue,
but lacking a body.  Do not throw a FATAL error for these; instead,
issue a warning and show the empty document, in the man(7) case with
the same amount of blank lines as groff does.  Also downgrade mdoc(7)
documents having content before the first .Sh from FATAL to WARNING.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.65 2014/06/20 17:23:09 schwarze Exp $ */
d165 2
a166 1
	MANDOCERR_SOPATH, /* NOT IMPLEMENTED: .so with absolute path or ".." */
@


1.65
log
@Start systematic improvements of error reporting.
So far, this covers all WARNINGs related to the prologue.

1) hierarchical naming of MANDOCERR_* constants
2) mention the macro name in messages where that adds clarity
3) add one missing MANDOCERR_DATE_MISSING msg
4) fix the wording of one message related to the man(7) prologue

Started on the plane back from Ottawa.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.64 2014/04/20 16:44:44 schwarze Exp $ */
d65 2
a165 1
	MANDOCERR_NODOCBODY, /* no document body */
@


1.64
log
@KNF: case (FOO):  ->  case FOO, remove /* LINTED */ and /* ARGSUSED */,
remove trailing whitespace and blanks before tabs, improve some indenting;
no functional change
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.63 2014/03/28 23:25:54 schwarze Exp $ */
d52 10
a61 10
	MANDOCERR_NOTITLE, /* no title in document */
	MANDOCERR_UPPERCASE, /* document title should be all caps */
	MANDOCERR_BADMSEC, /* unknown manual section */
	MANDOCERR_BADVOLARCH, /* unknown manual volume or arch */
	MANDOCERR_NODATE, /* date missing, using today's date */
	MANDOCERR_BADDATE, /* cannot parse date, using it verbatim */
	MANDOCERR_PROLOGOOO, /* prologue macros out of order */
	MANDOCERR_PROLOGREP, /* duplicate prologue macro */
	MANDOCERR_BADPROLOG, /* macro not allowed in prologue */
	MANDOCERR_BADBODY, /* macro not allowed in body */
@


1.63
log
@Allow leading and trailing vertical lines,
and format them in the same way as groff.
While here, do not require whitespace before vertical lines
in layout specifications.
Issues found by bentley@@ in mpv(1).
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.62 2014/03/21 22:17:01 schwarze Exp $ */
d366 1
a366 1
 * line and position. 
d412 1
a412 1
char	 	  mchars_num2char(const char *, size_t);
d414 1
a414 1
int		  mchars_spec2cp(const struct mchars *, 
d416 1
a416 1
const char	 *mchars_spec2str(const struct mchars *, 
d423 1
a423 1
void		  mparse_result(struct mparse *, 
@


1.62
log
@The files mandoc.c and mandoc.h contained both specialised low-level
functions used for multiple languages (mdoc, man, roff), for example
mandoc_escape(), mandoc_getarg(), mandoc_eos(), and generic auxiliary
functions.  Split the auxiliaries out into their own file and header.
While here, do some #include cleanup.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.61 2014/03/19 22:20:36 schwarze Exp $ */
d243 1
@


1.61
log
@Without the MPARSE_SO option, if the file contains nothing but a
single .so request, do not read the file pointed to, but instead
let mparse_result() provide the file name pointed to as a return
value.  To be used by makewhatis(8) in the future.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.60 2014/03/19 21:50:59 schwarze Exp $ */
d4 1
a4 1
 * Copyright (c) 2012, 2013, 2014 Ingo Schwarze <schwarze@@openbsd.org>
a407 1
void		 *mandoc_calloc(size_t, size_t);
a408 4
void		 *mandoc_malloc(size_t);
void		 *mandoc_realloc(void *, size_t);
char		 *mandoc_strdup(const char *);
char		 *mandoc_strndup(const char *, size_t);
@


1.60
log
@Generalize the mparse_alloc() and roff_alloc() functions by giving
them an "options" argument, replacing the existing "inttype" and
"quick" arguments, preparing for a future MPARSE_SO option.
Store this argument in struct mparse and struct roff, replacing the
existing "inttype", "parsetype", and "quick" members.
No functional change except one tiny cosmetic fix in roff_TH().
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.59 2014/01/22 20:58:35 schwarze Exp $ */
d428 1
a428 1
			struct mdoc **, struct man **);
@


1.59
log
@Implement the \: (optional line break) escape sequence,
documented in the Ossanna-Kernighan-Ritter troff manual
and also supported by groff.

Missing feature reported by Steffen Nurpmeso <sdaoden at gmail dot com>.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.58 2014/01/05 20:26:27 schwarze Exp $ */
d375 6
a380 9
 * The type of parse sequence.  This value is usually passed via the
 * mandoc(1) command line of -man and -mdoc.  It's almost exclusively
 * -mandoc but the others have been retained for compatibility.
 */
enum	mparset {
	MPARSE_AUTO, /* magically determine the document type */
	MPARSE_MDOC, /* assume -mdoc */
	MPARSE_MAN /* assume -man */
};
d422 1
a422 2
struct mparse	 *mparse_alloc(enum mparset, enum mandoclevel,
			mandocmsg, char *, int);
@


1.58
log
@Add an option -Q (quick) to mandocdb(8)
for accelerated generation of reduced-size databases.

Implement this by allowing the parsers to optionally
abort the parse sequence after the NAME section.

While here, garbage collect the unused void *arg attribute
of struct mparse and mparse_alloc().

This reduces the processing time of mandocdb(8) on /usr/share/man
by a factor of 2 and the database size by a factor of 4.
However, it still takes 5 times the time and 6 times the space
of makewhatis(8), so more work is clearly needed.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.57 2014/01/02 16:29:46 schwarze Exp $ */
d23 1
@


1.57
log
@Since the functions in read.c are part of the mandoc(3) library,
do not print to stderr.  Instead, properly use the mmsg callback.
Issue noticed by Abhinav Upadhyay <er dot abhinav dot upadhyay
at gmail dot com> and Thomas Klausner <wiz at NetBSD>.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.56 2013/12/30 18:27:15 schwarze Exp $ */
d425 1
a425 1
			mandocmsg, void *, char *);
@


1.56
log
@Remove duplicate const specifiers from the declaration of mandoc_escape().
Found by Thomas Klausner <wiz at NetBSD dot org> using clang.
No functional change.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.55 2013/10/05 21:17:29 schwarze Exp $ */
d4 1
a4 1
 * Copyright (c) 2012, 2013 Ingo Schwarze <schwarze@@openbsd.org>
d155 1
d166 7
@


1.55
log
@Cleanup suggested by gcc-4.8.1, following hints by Christos Zoulas:
- avoid bad qualifier casting in roff.c, roff_parsetext()
  by changing the mandoc_escape arguments to "const char const **"
- avoid bad qualifier casting in mandocdb.c, index_merge()
- garbage collect a few unused variables elsewhere
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.54 2013/09/16 00:25:06 schwarze Exp $ */
d403 1
a403 2
enum mandoc_esc	  mandoc_escape(const char const **,
			const char const **, int *);
@


1.54
log
@One of the WARNING messages has to use the word "section" twice in two
different meanings, that cannot be helped.  But we can make this less
confusing by stating that the second instance refers to stuff like (2),
(3), and (9), and by adding the sections header the first instance
refers to, for example ERRORS or RETURN VALUES.

Source for confusion noticed by Jan Stary <hans at stare dot cz>,
better wording suggested by jmc@@, tweaked by me.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.53 2013/08/08 20:07:24 schwarze Exp $ */
d403 2
a404 1
enum mandoc_esc	  mandoc_escape(const char **, const char **, int *);
@


1.53
log
@Implement the roff(7) font-escape sequence \f(BI "bold+italic".
This improves the formatting of about 40 base manuals
and reduces groff-mandoc formatting differences in base by about 5%.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.52 2013/07/13 12:51:37 schwarze Exp $ */
d68 1
a68 1
	MANDOCERR_SECMSEC, /* section not in conventional manual section */
@


1.52
log
@Rudimentary implementation of the .it request (input line trap).
As with any low-level roff request involving subtle interactions
with macro internals, this implementation is not exact, but it
does handle the simplest cases.

This request occurs in man(7) code generated from DocBook,
for example mysql(1) and yasm_arch(7).
Thanks to brad@@ for reporting the issue back in January 2011.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.51 2013/05/31 21:37:08 schwarze Exp $ */
d383 1
@


1.51
log
@The name "struct tbl" was badly misleading for two reasons:
1) This struct almost exclusively contains the table options.
2) Information about the table as a whole is actually in "struct tbl_node".
Besides, "struct tbl" was almost impossible to search for.
So rename it to "struct tbl_opts".  No functional change.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.50 2012/11/19 22:28:35 schwarze Exp $ */
d4 1
a4 1
 * Copyright (c) 2012 Ingo Schwarze <schwarze@@openbsd.org>
d148 1
@


1.50
log
@Do not crash on stray .Ta macros found outside column lists.
Problem reported by jmc@@, thanks.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.49 2012/11/16 22:20:40 schwarze Exp $ */
d167 1
a167 1
struct	tbl {
d266 1
a266 1
	struct tbl	 *tbl;
@


1.49
log
@Warn about unknown volume or arch in Dt macro arguments;
patch written by Nicolas Joly <njoly at pasteur dot fr>.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.48 2012/07/18 11:09:30 schwarze Exp $ */
d4 1
d139 1
@


1.48
log
@Fix handling of paragraph macros inside lists:
* When they are trailing the last item, move them outside the list.
* When they are trailing any other none-compact item, drop them.

Improves formatting of 40 pages, e.g. grep(1), ksh(1), netstat(1),
ath(4), bsd.port.mk(5), pf.conf(5), mount(8), crypto(9).
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.47 2012/07/12 15:09:50 schwarze Exp $ */
d53 1
@


1.47
log
@The post_nm() validation function crashed when the first .Nm child node
was a non-text node.  Fix this by rewriting post_nm() to always set
the meta name to UNKNOWN when the name is missing or unusable.
While here, make MANDOCERR_NONAME an ERROR, as it usually renders
the page content unintelligible.

Bug reported by Maxim <Belooussov at gmail dot com>, thanks.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.46 2012/05/28 13:00:51 schwarze Exp $ */
d71 1
@


1.46
log
@Implement the roff \z escape sequence, intended to output the next
character without advancing the cursor position; implement it to
simply skip the next character, as it will usually be overwritten.

With this change, the pod2man(1) preamble user-defined string \*:,
intended to render as a diaeresis or umlaut diacritic above the
preceding character, is rendered in a slightly less ugly way,
though still not correctly.  It was rendered as "z.." and is now
rendered as ".".

Given that the definition of \*: uses elaborate manual \h positioning,
there is little chance for mandoc(1) to ever render it correctly,
but at least we can refrain from printing out a spurious "z", and
we can make the \z do something semi-reasonable for easier cases.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.45 2012/05/26 20:03:34 schwarze Exp $ */
a63 1
	MANDOCERR_NONAME, /* manual name not yet set */
d131 1
@


1.45
log
@Do not handle vertical lines as additional tbl(7) columns,
instead save their properties with the following column.
This simplifies layout parsing and saves a lot of code
related to column handling.

At output time, print all white space and vertical lines
separating columns before printing the following column,
and none after printing the preceding column, considerably
simplifying white space handling and width calculations.

No functional change, but it saves 150 lines of code,
and it allows the next patch to tbl_term.c, tbl_literal().
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.44 2012/05/24 23:33:23 schwarze Exp $ */
d382 2
a383 1
	ESCAPE_NOSPACE /* suppress space if the last on a line */
@


1.44
log
@Support -Ios='OpenBSD 5.1' to override uname(3) as the source of the
default value for the mdoc(7) .Os macro.
Needed for man.cgi on the OpenBSD website.

Problem with man.cgi first noticed by deraadt@@;
beck@@ and deraadt@@ agree with the way to solve the issue.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.43 2011/11/12 22:43:18 schwarze Exp $ */
a177 6
enum	tbl_headt {
	TBL_HEAD_DATA, /* plug in data from tbl_dat */
	TBL_HEAD_VERT, /* vertical spacer */
	TBL_HEAD_DVERT  /* double-vertical spacer */
};

a183 1
	enum tbl_headt	  pos;
d185 1
a199 2
	TBL_CELL_VERT, /* | */
	TBL_CELL_DVERT, /* || */
d208 1
@


1.43
log
@mark some arguments "const" that will not be changed; from kristaps@@
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.42 2011/11/05 16:02:18 schwarze Exp $ */
d416 2
a417 2
struct mparse	 *mparse_alloc(enum mparset, 
			enum mandoclevel, mandocmsg, void *);
@


1.42
log
@When the HEAD scope of .TP is broken by another block macro,
do not abort with a FATAL error, but report a regular ERROR,
remove the broken .TP from the syntax tree, and prod on.
Reported repeatedly by ports people, at least by brad@@ and jeremy@@.
Also fixes rendition(4) in Xenocara.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.41 2011/10/09 17:59:56 schwarze Exp $ */
d412 1
a412 1
int		  mchars_spec2cp(struct mchars *, 
d414 1
a414 1
const char	 *mchars_spec2str(struct mchars *, 
@


1.41
log
@Sync to version 1.12.0; all code by kristaps@@:
Implement .Rv in -Tman.
Let -man -Tman work a bit like cat(1).
Add the -Ofragment option to -T[x]html.
Minor fixes in -T[x]html.
Lots of apropos(1) and -Tman code cleanup.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.40 2011/09/18 10:25:28 schwarze Exp $ */
a152 1
	MANDOCERR_SYNTLINESCOPE, /* line scope broken, syntax violated */
@


1.40
log
@sync to version 1.11.5:
adding an implementation of the eqn(7) language
by kristaps@@

So far, only .EQ/.EN blocks are handled, in-line equations are not, and
rendering is not yet very pretty, but the parser is fairly complete.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.39 2011/09/17 13:45:28 schwarze Exp $ */
a402 9
void		  mparse_free(struct mparse *);
void		  mparse_reset(struct mparse *);
struct mparse	 *mparse_alloc(enum mparset, 
			enum mandoclevel, mandocmsg, void *);
enum mandoclevel  mparse_readfd(struct mparse *, int, const char *);
void		  mparse_result(struct mparse *, struct mdoc **, struct man **);
const char	 *mparse_strerror(enum mandocerr);
const char	 *mparse_strlevel(enum mandoclevel);

d404 1
a408 3

enum mandoc_esc	  mandoc_escape(const char **, const char **, int *);

d410 1
d413 15
a427 4
const char	 *mchars_spec2str(struct mchars *, const char *, size_t, size_t *);
int		  mchars_spec2cp(struct mchars *, const char *, size_t);
void		  mchars_free(struct mchars *);

@


1.39
log
@Change the mandocdb(8) interface to better agree with makewhatis(8);
in particular, allow recursing multiple directories and create
multiple databases in one call.
This commit includes some reorganization, and exposing mandoc_strdup
as a utility function in mandoc.h.
written by kristaps@@
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.38 2011/05/29 21:22:18 schwarze Exp $ */
d107 3
d112 7
d283 78
d362 3
a364 3
	size_t		  sz;
	char		 *data;
	int		  line; /* invocation line */
d416 1
@


1.38
log
@Merge release 1.11.3, almost all code by kristaps@@:
* Unicode output support (no Unicode input yet, though).
* Refactoring: completely handle predefined strings in roff.c.
- New function mandoc_escape() replaces a2roffdeco() and mandoc_special().
- Start using mandoc_getarg() in mdoc_argv.c.
- Clean up parsing of delimiters in mdoc(7).
* And many minor fixes and lots of cleanup.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.37 2011/04/24 16:22:02 schwarze Exp $ */
d327 1
@


1.37
log
@Merge version 1.11.1:
Again lots of cleanup and maintenance work by kristaps@@.
- simplify error reporting: less function pointers, more mandoc_[v]msg
- main: split document parsing out of main.c into read.c
- roff, mdoc, man: improved recognition of control characters
- roff: better handling of if/else stack overflows
- roff: add some predefined strings for backward compatibility
- mdoc, man: empty sections are not errors
- mdoc: move delimiter handling to libmdoc
- some header restructuring and some minor features and fixes
This merge causes two minor regressions
that i will fix in separate commits right afterwards.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.36 2011/04/21 22:59:54 schwarze Exp $ */
d291 14
d309 1
d327 10
@


1.36
log
@Merge version 1.10.10:
lots of cleanup and maintenance work by kristaps@@.
- move some main.c globals into struct curparse
- move mandoc_*alloc to mandoc.h such that all code can use them
- make mandoc_isdelim available to formatting frontends
- dissolve mdoc_strings.c, move the code where it is used
- make all error reporting functions void, their return values were useless
- and various minor cleanups and fixes
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.35 2011/03/20 23:36:42 schwarze Exp $ */
d77 1
a124 1
	MANDOCERR_LINESCOPE, /* line scope broken */
d140 1
d281 16
a296 6
 * Available registers (set in libroff, accessed elsewhere).
 */
enum	regs {
	REG_nS = 0,
	REG__MAX
};
d298 1
a298 27
/*
 * A register (struct reg) can consist of many types: this consists of
 * normalised types from the original string form.
 */
union	regval {
	unsigned  u; /* unsigned integer */
};

/*
 * A single register entity.  If "set" is zero, the value of the
 * register should be the default one, which is per-register.  It's
 * assumed that callers know which type in "v" corresponds to which
 * register value.
 */
struct	reg {
	int		  set; /* whether set or not */
	union regval	  v; /* parsed data */
};

/*
 * The primary interface to setting register values is in libroff,
 * although libmdoc and libman from time to time will manipulate
 * registers (such as `.Sh SYNOPSIS' enabling REG_nS).
 */
struct	regset {
	struct reg	  regs[REG__MAX];
};
d300 8
a307 20
/*
 * A punctuation delimiter, used only in mdoc(7) documents, is opening,
 * closing, or "middle mark" punctuation.  These govern spacing.
 * Opening punctuation (e.g., the opening parenthesis) suppresses the
 * following space; closing punctuation (e.g., the closing parenthesis)
 * suppresses the leading space; middle punctuation (e.g., the vertical
 * bar) can do either.  The middle punctuation delimiter bends the rules
 * depending on usage.
 */
enum	mdelim {
	DELIM_NONE = 0,
	DELIM_OPEN,
	DELIM_MIDDLE,
	DELIM_CLOSE
};

typedef	void	(*mandocmsg)(enum mandocerr, void *,
			int, int, const char *);

__BEGIN_DECLS
a311 2
#define	DELIMSZ	  6 /* hint: max possible size of a delimiter */
enum mdelim	  mandoc_isdelim(const char *);
@


1.35
log
@Import the foundation for eqn(7) support.
Written by kristaps@@.

For now, i'm adding one line to each of the four frontends
to just pass the input text through to the output,
not yet interpreting any of then eqn keywords.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.34 2011/03/07 01:35:33 schwarze Exp $ */
d315 19
d336 5
a340 6
/*
 * Callback function for warnings, errors, and fatal errors as they
 * occur in the compilers libroff, libmdoc, and libman.
 */
typedef	int		(*mandocmsg)(enum mandocerr, void *,
				int, int, const char *);
@


1.34
log
@Clean up date handling,
as a first step to get rid of the frequent petty warnings in this area:
 - always store dates as strings, not as seconds since the Epoch
 - for input, try the three most common formats everywhere
 - for unrecognized format, just pass the date though verbatim
 - when there is no date at all, still use the current date
Originally triggered by a one-line patch from Tim van der Molen,
<tbvdm at xs4all dot nl>, which is included here.
Feedback and OK on manual parts from jmc@@.
"please check this in" kristaps@@
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.33 2011/02/10 00:06:30 schwarze Exp $ */
d270 7
@


1.33
log
@Tbl code maintenance by kristaps@@.
- Remember the line-number of a tbl_span, and use it in messages.
- Put *_span_alloc() functions right into the *_addspan() ones,
  since these are the only places they are called from.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.32 2011/02/06 17:33:20 schwarze Exp $ */
d53 2
a54 1
	MANDOCERR_BADDATE, /* cannot parse date argument */
@


1.32
log
@If .Ns is specified on its own line, ignore it, like groff does;
from kristaps@@.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.31 2011/01/16 19:27:25 schwarze Exp $ */
d263 1
@


1.31
log
@Some improvements to error handling from kristaps@@:
* Make out-of-context .fi invocations not cause an error, but just a warning.
* Downgrade -man message about ignored empty paragraph to MANDOC_IGNPAR.
* Avoid syntax tree corruption when removing empty block macros.
Triggered by some reports from brad@@.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.30 2011/01/16 01:11:50 schwarze Exp $ */
d71 1
@


1.30
log
@Various tbl improvements from kristaps@@:
* horizontal lines do not consume layout lines
* skip excessive data cells
* prepare rendering of spanned cells
* support vertical spans
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.29 2011/01/10 23:53:32 schwarze Exp $ */
d83 1
@


1.29
log
@Refactoring in preparation for .rm support:
Unify parsing of names given as roff request arguments into a new
function roff_getname(), which is rather different from the parsing
function for normal arguments, mandoc_getarg(), because names cannot
be quoted and cannot contain whitespace or escaped characters.
The new function now throws an ERROR when finding escaped characters
in a name.
"I'm fine with this." kristaps@@
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.28 2011/01/09 14:30:48 schwarze Exp $ */
a102 3
	/* related to tables */
	MANDOCERR_TBLEXTRADAT, /* extra data cells */

d113 1
d204 1
a204 1
	int		  spacing;
d226 6
a231 6
	TBL_DATA_NONE,
	TBL_DATA_DATA,
	TBL_DATA_HORIZ,
	TBL_DATA_DHORIZ,
	TBL_DATA_NHORIZ,
	TBL_DATA_NDHORIZ
d239 2
a240 1
	struct tbl_cell	 *layout; /* layout cell: CAN BE NULL */
d242 1
a242 1
	char		 *string;
d258 1
a258 1
	struct tbl_row	 *layout; /* layout row: CAN BE NULL */
@


1.28
log
@Sync tbl handling to bsd.lv release 1.10.9:
* .T} can be followed by a delimiter, then more data.
* Do not limit table column widths (improves terminfo(5)).
* Let numerical cells respect explicitly specified minimum cell widths.
* Let terminal output survive missing data cells.
* Parse and ignore arguments in parentheses on layout cell specifications.
* Move tbl_calc() into out.c such that it can be used by all frontends.
* Give tables an HTML class.
* Some cleanup in tbl -Thtml code.
All code by kristaps@@.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.27 2011/01/04 22:28:17 schwarze Exp $ */
d119 1
@


1.27
log
@Merge kristaps@@' cleaner tbl integration, removing mine;
there are still a few bugs, but fixing these will be easier in tree.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.26 2011/01/03 23:39:27 schwarze Exp $ */
a154 1
	char		  delims[2]; /* FIXME: deprecate */
@


1.26
log
@Partial cleanup of argument count validation in mdoc(7):

* Do not segfault on empty .Db, .Rs, .Sm, and .St.
* Let check_count() really throw the requested level, not always ERROR.
* Downgrade most bad argument counts from ERROR to WARNING.
* And some related internal cleanup.

Looks fine to kristaps@@.

Note that the macros using eerr_ge1() still need to be checked at a later
time; but as all the others are done, let's use what we already have.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.25 2010/12/09 23:01:18 schwarze Exp $ */
d3 1
a3 1
 * Copyright (c) 2010 Kristaps Dzonsons <kristaps@@bsd.lv>
d103 3
d108 9
a134 1
	MANDOCERR_TBL, /* tbl(1) error */
d149 118
@


1.25
log
@Abort endless loops during roff macro and string expansion.
For now, use the simplest conceivable approach, like groff does:
Just a fixed, ugly input stack limit.
Kristaps@@ agrees.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.24 2010/12/07 00:08:52 schwarze Exp $ */
d78 1
@


1.24
log
@Complete the merge of bsd.lv version 1.10.7:
No more functional changes, just sync ordering, comments and white space.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.23 2010/12/01 22:02:29 schwarze Exp $ */
d104 1
@


1.23
log
@Merge mdoc_action.c into mdoc_validate.c, because having two places to do
basically the same things just causes code duplication and confusion.
Work by kristaps@@, including a few bugfixes he found during the merge,
and reapplying OpenBSD changes on top.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.22 2010/11/29 00:12:02 schwarze Exp $ */
d103 1
d124 1
@


1.22
log
@Implement the roff .ft (change font) request for man(7).
Of course, we don't want to encourage low-level physical markup,
but pod2man(1) writes such requests, so Perl manuals contain them,
and some Xenocara and lots and lots of ports manuals use them as well.
In base and Xenocara, this will reduce mandoc -Tlint ERROR noise;
in ports, it will improve rendering of many manuals.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.21 2010/11/28 19:35:33 schwarze Exp $ */
a90 1
	MANDOCERR_BADLIB, /* unknown library specifier */
@


1.21
log
@To avoid FATAL errors, we have been parsing and ignoring the roff
requests .am, .ami, .am1, .dei, and .rm for a long time.
Since ignoring them can (rarely) cause information loss and serious
misformatting, throw an ERROR: NOT IMPLEMENTED when finding them.
Implementing them would not be too difficult, but they are so rare
in practice that i can find better use for my time right now.

In this context,
- Put the string "NOT IMPLEMENTED" into two other error messages
as well, to distinguish them from those caused by broken input.
- Print the string "unknown macro" once, not twice in the error message
associated with MANDOCERR_MACRO, and begin printing the buffer at the
point where the unknown macro really is, not at the start of line.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.20 2010/10/26 23:34:38 schwarze Exp $ */
d90 1
@


1.20
log
@Warn developers that .so is fragile and suggest using ln(1) instead;
throwing a warning here was suggested by Joerg Sonnenberger.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.19 2010/10/26 22:48:07 schwarze Exp $ */
d106 1
d124 1
a124 1
	MANDOCERR_BADDISP, /* unsupported display type */
d129 1
a129 1
	MANDOCERR_SOPATH, /* invalid path in include directive */
@


1.19
log
@Downgrade nearly 20 ERRORS to WARNINGS.
All these indicate problems in the mdoc(7) or man(7) source code,
but they can't cause relevant information loss or clobbered formatting.
While here, error message improve wording and make it more uniform,
don't throw MANDOCERR_NOWIDTHARG twice when there is one single issue,
and consolidate MANDOCERR_WIDTHARG into MANDOCERR_IGNARGV.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.18 2010/10/26 22:28:57 schwarze Exp $ */
d60 1
@


1.18
log
@Support .so (low-level roff "switch source file"),
needed for Xenocara and various ports.
Accept only relative paths and no ascension to the parent directory
as suggested by Joerg Sonnenberger; code looked over by Joerg, too.
Useful discussions with various people, among others espie@@.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.17 2010/10/24 18:15:43 schwarze Exp $ */
d48 15
a62 1
	MANDOCERR_UPPERCASE, /* text should be uppercase */
d64 14
a77 3
	MANDOCERR_SECREP, /* section name repeats */
	MANDOCERR_PROLOGOOO, /* out of order prologue */
	MANDOCERR_PROLOGREP, /* repeated prologue entry */
d79 16
a94 2
	MANDOCERR_BADSTANDARD, /* bad standard */
	MANDOCERR_BADLIB, /* bad library */
d96 3
a98 1
	MANDOCERR_BADESCAPE, /* bad escape sequence */
a99 11
	MANDOCERR_NOWIDTHARG, /* argument requires the width argument */
	/* FIXME: merge with MANDOCERR_IGNARGV. */
	MANDOCERR_WIDTHARG, /* superfluous width argument */
	MANDOCERR_IGNARGV, /* ignoring argument */
	MANDOCERR_BADDATE, /* bad date argument */
	MANDOCERR_BADWIDTH, /* bad width argument */
	MANDOCERR_BADMSEC, /* unknown manual section */
	MANDOCERR_NESTEDDISP, /* nested displays are not portable */
	MANDOCERR_SECMSEC, /* section not in conventional manual section */
	MANDOCERR_EOLNSPACE, /* end of line whitespace */
	MANDOCERR_SCOPENEST, /* blocks badly nested */
d102 3
a104 18
	MANDOCERR_NAMESECFIRST, /* NAME section must come first */
	MANDOCERR_BADBOOL, /* bad Boolean value */
	MANDOCERR_CHILD, /* child violates parent syntax */
	MANDOCERR_BADATT, /* bad AT&T symbol */
	MANDOCERR_LISTREP, /* list type repeated */
	MANDOCERR_DISPREP, /* display type repeated */
	MANDOCERR_ARGVREP, /* argument repeated */
	MANDOCERR_NONAME, /* manual name not yet set */
	MANDOCERR_MACROOBS, /* obsolete macro ignored */
	MANDOCERR_MACROEMPTY, /* empty macro ignored */
	MANDOCERR_BADBODY, /* macro not allowed in body */
	MANDOCERR_BADPROLOG, /* macro not allowed in prologue */
	MANDOCERR_BADCHAR, /* bad character */
	MANDOCERR_BADNAMESEC, /* bad NAME section contents */
	MANDOCERR_NOBLANKLN, /* no blank lines */
	MANDOCERR_NOTEXT, /* no text in this context */
	MANDOCERR_BADCOMMENT, /* bad comment style */
	MANDOCERR_MACRO, /* unknown macro will be lost */
d107 1
a107 1
	MANDOCERR_NOSCOPE, /* no such block is open */
a108 1
	MANDOCERR_SCOPEREP, /* scope already open */
a114 1
	MANDOCERR_NOTITLE, /* no title in document */
a115 2
	MANDOCERR_DISPTYPE, /* missing display type */
	MANDOCERR_FONTTYPE, /* missing font type */
a117 1
	MANDOCERR_IGNPAR, /* paragraph macro ignored */
@


1.17
log
@Do not throw FATAL errors when there is no need to:
 - when encountering nested displays (.Bd containing .Bd, .D1, .D1)
 - when a block end macro was forgotten
 - when ending a block that was never started
 - when the uname(3) system call failed
along with a little related cleanup
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.16 2010/10/23 15:49:30 schwarze Exp $ */
d117 1
@


1.16
log
@sync comments to bsd.lv; no functional change
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.22 2010/10/04 07:01:02 kristaps Exp $ */
d66 1
d93 1
d96 1
a111 2
	/* FIXME: this should be a MANDOCERR_ERROR */
	MANDOCERR_NESTEDDISP, /* displays may not be nested */
a112 2
	MANDOCERR_SCOPEFATAL, /* blocks badly nested */
	MANDOCERR_SYNTNOSCOPE, /* no scope to rewind: syntax violated */
a118 1
	MANDOCERR_UTSNAME, /* utsname system call failed */
@


1.15
log
@Do not abort() on tbl errors, reduce the risk that tbl stuff kills a build,
and provide more useful tbl error messages in a non-intrusive way.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.14 2010/09/27 21:25:28 schwarze Exp $ */
a19 4
/*
 * This contains declarations that are available system-wide.
 */

d23 6
a28 2
__BEGIN_DECLS

d32 5
a36 5
	MANDOCLEVEL_WARNING,
	MANDOCLEVEL_ERROR,
	MANDOCLEVEL_FATAL,
	MANDOCLEVEL_BADARG,
	MANDOCLEVEL_SYSERR,
d40 4
d47 1
a47 2
	MANDOCERR_WARNING, /* ===== end of warnings ===== */

d70 1
a70 2
	MANDOCERR_ERROR, /* ===== end of errors ===== */

d107 1
a107 2
	MANDOCERR_FATAL, /* ===== end of fatal errors ===== */

a121 1

d125 3
d129 1
a129 1
	REG_nS = 0,	/* register: nS */
d134 8
d149 1
a149 3
	union {
		unsigned  u; /* unsigned integer */
	} v;
d160 2
@


1.14
log
@Merge the last bits of 1.10.6 (released today), most were already in:
* ignore double-.Pp
* ignore .Pp before .Bd and .Bl (unless -compact in specified)
* avoid double blank line upon .Pp, .br and friends in literal context
* cast enums to int when passing them to exit(3) to please lint(1)
While merging, fix a regression introduced by kristaps@@:
Outside literal mode, double blank lines must both be printed.
To achieve this again after kristaps@@ improvements in 1.10.6,
treat such blank lines as .sp (instead of .Pp as in 1.10.5)
and drop .Pp before .sp just like dropping .Pp before .Pp.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.13 2010/09/26 20:19:58 schwarze Exp $ */
d103 1
@


1.13
log
@If an explicit scope is still open at the end of an input file,
report an ERROR:  We can still render the page by just closing
the open scope, but it is likely that information will be missing
or document structure mangled.
Before, man(7) only reported a WARNING (which is dangerous because
we cannot be sure rendering is correct) and mdoc(7) ran into FATAL
(which is too drastic, there is no reason not to show what we have).
While here, add a few explicit casts to appease lint.
"looks good" kristaps@@
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.12 2010/08/20 00:53:35 schwarze Exp $ */
d102 1
@


1.12
log
@Implement a simple, consistent user interface for error handling.
We now have sufficient practical experience to know what we want,
so this is intended to be final:
- provide -Wlevel (warning, error or fatal) to select what you care about
- provide -Wstop to stop after parsing a file with warnings you care about
- provide consistent exit status codes for those warnings you care about
- fully document what warnings, errors and fatal errors mean
- remove all other cruft from the user interface, less is more:
- remove all -f knobs along with the whole -f option
- remove the old -Werror because calling warnings "fatal" is silly
- always finish parsing each file, unless fatal errors prevent that
This commit also includes a couple of related simplifications behind
the scenes regarding error handling.
Feedback and OK  kristaps@@;  Joerg Sonnenberger (NetBSD) and
Sascha Wildner (DragonFly BSD) agree with the general direction.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.11 2010/07/25 18:05:54 schwarze Exp $ */
a65 1
	MANDOCERR_SCOPEEXIT, /* scope open on exit */
d91 1
a110 1
	MANDOCERR_SYNTSCOPE, /* scope broken, syntax violated */
@


1.11
log
@Sync to bsd.lv; in particular, pull in lots of bug fixes.
new features:
* support the .in macro in man(7)
* support minimal PDF output
* support .Sm in mdoc(7) HTML output
* support .Vb and .nf in man(7) HTML output
* complete the mdoc(7) manual
bug fixes:
* do not let mdoc(7) .Pp produce a newline before/after .Sh; reported by jmc@@
* avoid double blank lines related to man(7) .sp and .br
* let man(7) .nf and .fi flush the line; reported by jsg@@ and naddy@@
* let "\ " produce a non-breaking space; reported by deraadt@@
* discard \m colour escape sequences; reported by J.C. Roberts
* map undefined 1-character-escapes to the literal character itself
maintenance:
* express mdoc(7) arguments in terms of an enum for additional type-safety
* simplify mandoc_special() and a2roffdeco()
* use strcspn in term_word() in place of a manual loop
* minor optimisations in the -Tps and -Thtml formatting frontends
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.10 2010/07/13 01:09:13 schwarze Exp $ */
d29 11
d119 1
a119 1
	MANDOCERR_MEM, /* memory exhausted */
@


1.10
log
@Merge release 1.10.4 (all code by kristaps@@), providing four new features:
1) Proper .Bk support: allow output line breaks at input line breaks,
but keep input lines together in the output, finally fixing
synopses like aucat(1), mail(1) and tmux(1).
2) Mostly finished -Tps (PostScript) output.
3) Implement -Thtml output for .Nm blocks and .Bk -words.
4) Allow iterative interpolation of user-defined roff(7) strings.
Also contains some minor bugfixes and some performance improvements.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.9 2010/07/01 15:36:59 schwarze Exp $ */
d42 1
@


1.9
log
@Improve .Nm indentation in the SYNOPSIS;
kristaps@@ will do the missing HTML part soon.
"looks nicer" jmc@@
"seems perfect to me" sobrado@@
"slap it in" kristaps@@
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.8 2010/06/30 20:29:44 schwarze Exp $ */
d20 4
a26 1

d87 1
a94 2
	MANDOCERR_FONTTYPE, /* missing font type */
	/* FIXME: this should be a MANDOCERR_ERROR */
d112 33
a144 2
typedef	int	(*mandocmsg)(enum mandocerr, 
			void *, int, int, const char *);
@


1.8
log
@improve error reporting:
* avoid error exit code after mere warnings
* add ERROR: and FATAL: to messages when appropriate
* sort the code in mmsg() to make it easier on the eye
* make the mandocerrs[] list easier to maintain
* update a few comments in mandoc.h
ok kristaps@@
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.7 2010/06/26 17:56:43 schwarze Exp $ */
d50 1
a73 1
	MANDOCERR_SCOPE, /* scope broken */
d75 1
a75 1
	MANDOCERR_NOSCOPE, /* request scope close w/none open */
d95 1
@


1.7
log
@merge release 1.10.2
* bug fixes:
- interaction of ASCII_HYPH with special chars (found by Ulrich Spoerlein)
- handling of roff conditionals (found by Ulrich Spoerlein)
- .Bd -offset will no more default to 6n
* maintenance:
- more caching of .Bd and .Bl arguments for efficiency
- deconstify man(7) validation routines
- add FreeBSD library names (provided by Ulrich Spoerlein)
* start PostScript font-switching
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.6 2010/06/06 20:30:08 schwarze Exp $ */
d28 3
d44 1
a44 1
	MANDOCERR_IGNARGV, /* macro ignoring argv */
d51 2
a52 1
#define	MANDOCERR_WARNING	MANDOCERR_SCOPEEXIT
d86 2
a87 1
#define	MANDOCERR_ERROR		MANDOCERR_BODYLOST
d95 1
a95 1
	MANDOCERR_SYNTNOSCOPE, /* request scope close w/none open */
d103 1
a103 1
	MANDOCERR_UTSNAME, /* utsname() system call failed */
a104 1
#define	MANDOCERR_FATAL		MANDOCERR_MEM
@


1.6
log
@Merge bsd.lv version 1.10.1 (to be released soon).

The main step forward is that this now has *much* better .Bl -column
support, now supporting many manuals that previously errored out
without producing any output.

Other fixes include:
* do not die from multiple list types, use the first and warn
* in .Bl without a type, default to -item
* various tweaks to .Dt
* fix .In, .Fd, .Ft, .Fn and .Fo formatting
* some documentation fixes and additions
* and fix a couple of bugs reported by Ulrich Spoerlein:
* better support for roff block-end "\}" without a preceding dot
* .In must not break the line outside SYNOPSIS
* spelling in some error messages

While merging, fix one regression in .In spacing
that needs to go to bsd.lv, too.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.5 2010/05/26 02:39:58 schwarze Exp $ */
d39 1
d41 1
d79 1
a87 2
	MANDOCERR_DISPTYPE, /* missing display type */
	/* FIXME: this should be a MANDOCERR_ERROR */
d89 1
@


1.5
log
@When a word does not fully fit onto the output line, but it contains
at least one hyphen, we already had support for breaking the line a the
last fitting hyphen.  This patch improves this functionality by only
breaking at hyphens in free-form text, and by not breaking at hyphens
* at the beginning or end of a word   or
* immediately preceded or followed by another hyphen   or
* escaped by a preceding backslash.

Before this patch, differences in break-at-hyphen support were one
of the major sources of noise in automatic comparisons to mdoc(7)
groff output.  Now, the remaining differences are hard to find among
the noise coming from other sources.

Where there are still differences, what we do seems to be better than
what groff does, see e.g. the chio(1) exchange and position commands
for one of the now rare examples.

idea and coding by kristaps@@

Besides, this was the last substantial code difference left
between bsd.lv and openbsd.org.  We are now in full sync.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.4 2010/05/23 23:35:26 schwarze Exp $ */
d29 1
a29 1
	MANDOCERR_SECOOO, /* sections out of conentional order */
a33 1
	MANDOCERR_COLUMNS, /* column syntax is inconsistent */
d42 1
a42 1
	MANDOCERR_BADMSEC, /* unknown manual sction */
d76 1
d81 1
a85 2
	/* FIXME: this should be a MANDOCERR_ERROR */
	MANDOCERR_LISTTYPE, /* missing list type */
@


1.4
log
@fix the build (oops, sorry!):
sigvec(3) triggers MANDOCERR_BODYLOST, which must not be fatal
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.3 2010/05/23 22:45:00 schwarze Exp $ */
d19 4
@


1.3
log
@Unified error and warning message system for all of mandoc,
featuring three message levels, as agreed during the mandoc hackathon:
* FATAL parser failure, cannot produce any output from this input file:
  eventually, we hope to convert most of these to ERRORs.
* ERROR, meaning mandoc cannot cope fully with the input syntax and will
  probably lose information or produce structurally garbled output;
  it will try to produce output anyway but exit non-zero at the end,
  which is eventually intended to make the ports infrastructure happy.
* WARNING, meaning you should clean up the input file, but output
  is probably mostly OK, so this will not cause error-exit at the end.
This commit is mostly just converting the old system to the new one; before
the classification will become really reliable, we must check all messages.

In particular,
* set up a new central message string table in main.c
* drop the old message string tables from man.c and mdoc.c
* get rid of the piece-meal merr enums in libman and libmdoc
* reduce number of error/warning functions from 16 to 6 (still a lot...)

While here, handle a few problems more gracefully:
* allow .Rv and .Ex to work without a prior .Nm
* allow .An to ignore extra arguments
* allow undeclared columns in .Bl -column

Written by kristaps@@.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.2 2010/05/20 00:58:02 schwarze Exp $ */
d75 1
a75 1
#define	MANDOCERR_ERROR		MANDOCERR_ARGSLOST
@


1.2
log
@Support nested roff instructions:
* allow roff_parseln() to be re-run
* allow roff_parseln() to manipulate the line buffer offset
* support the offset in the man and mdoc libraries
* adapt .if, .ie, .el, .ig, .am* and .de* support
* interpret some instructions even in conditional-negative context
Coded by kristaps during the last day of the mandoc hackathon.

To avoid regressions in the OpenBSD tree, commit this together
with some small local additions:
* detect roff block end "\}" even on macro lines
* actually implement the ".if n" conditional
* ignore .ds, .rm and .tr in libroff

Also back my old .if/.ie/.el-handling out of libman, reverting:
man.h 1.15 man.c 1.25 man_macro.c 1.15 man_validate.c 1.19
man_action.c 1.15 man_term.c 1.28 man_html.c 1.9.
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.1 2010/05/16 01:46:39 schwarze Exp $ */
d24 18
d45 21
d67 8
a74 2
	MANDOCERR_NOARGS, /* macro requires argument(s) */
	MANDOCERR_ARGSLOST, /* line arguments will be lost */
d77 17
@


1.1
log
@add forgotten header file, duh...
this is needed by Makefile rev. 1.37
@
text
@d1 1
a1 1
/*	$Id: mandoc.h,v 1.2 2010/05/15 21:53:11 kristaps Exp $ */
a24 1
	MANDOCERR_NOSCOPE, /* request scope close w/none open */
d27 2
@

