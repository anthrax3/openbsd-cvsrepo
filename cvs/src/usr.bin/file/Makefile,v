head	1.16;
access;
symbols
	OPENBSD_6_1_BASE:1.16
	OPENBSD_6_0:1.16.0.4
	OPENBSD_6_0_BASE:1.16
	OPENBSD_5_9:1.16.0.2
	OPENBSD_5_9_BASE:1.16
	OPENBSD_5_8:1.15.0.4
	OPENBSD_5_8_BASE:1.15
	OPENBSD_5_7:1.12.0.20
	OPENBSD_5_7_BASE:1.12
	OPENBSD_5_6:1.12.0.24
	OPENBSD_5_6_BASE:1.12
	OPENBSD_5_5:1.12.0.22
	OPENBSD_5_5_BASE:1.12
	OPENBSD_5_4:1.12.0.18
	OPENBSD_5_4_BASE:1.12
	OPENBSD_5_3:1.12.0.16
	OPENBSD_5_3_BASE:1.12
	OPENBSD_5_2:1.12.0.14
	OPENBSD_5_2_BASE:1.12
	OPENBSD_5_1_BASE:1.12
	OPENBSD_5_1:1.12.0.12
	OPENBSD_5_0:1.12.0.10
	OPENBSD_5_0_BASE:1.12
	OPENBSD_4_9:1.12.0.8
	OPENBSD_4_9_BASE:1.12
	OPENBSD_4_8:1.12.0.6
	OPENBSD_4_8_BASE:1.12
	OPENBSD_4_7:1.12.0.2
	OPENBSD_4_7_BASE:1.12
	OPENBSD_4_6:1.12.0.4
	OPENBSD_4_6_BASE:1.12
	OPENBSD_4_5:1.11.0.2
	OPENBSD_4_5_BASE:1.11
	OPENBSD_4_4:1.10.0.18
	OPENBSD_4_4_BASE:1.10
	OPENBSD_4_3:1.10.0.16
	OPENBSD_4_3_BASE:1.10
	OPENBSD_4_2:1.10.0.14
	OPENBSD_4_2_BASE:1.10
	OPENBSD_4_1:1.10.0.12
	OPENBSD_4_1_BASE:1.10
	OPENBSD_4_0:1.10.0.10
	OPENBSD_4_0_BASE:1.10
	OPENBSD_3_9:1.10.0.8
	OPENBSD_3_9_BASE:1.10
	OPENBSD_3_8:1.10.0.6
	OPENBSD_3_8_BASE:1.10
	OPENBSD_3_7:1.10.0.4
	OPENBSD_3_7_BASE:1.10
	OPENBSD_3_6:1.10.0.2
	OPENBSD_3_6_BASE:1.10
	OPENBSD_3_5:1.9.0.6
	OPENBSD_3_5_BASE:1.9
	OPENBSD_3_4:1.9.0.4
	OPENBSD_3_4_BASE:1.9
	OPENBSD_3_3:1.9.0.2
	OPENBSD_3_3_BASE:1.9
	OPENBSD_3_2:1.8.0.22
	OPENBSD_3_2_BASE:1.8
	OPENBSD_3_1:1.8.0.20
	OPENBSD_3_1_BASE:1.8
	OPENBSD_3_0:1.8.0.18
	OPENBSD_3_0_BASE:1.8
	OPENBSD_2_9_BASE:1.8
	OPENBSD_2_9:1.8.0.16
	OPENBSD_2_8:1.8.0.14
	OPENBSD_2_8_BASE:1.8
	OPENBSD_2_7:1.8.0.12
	OPENBSD_2_7_BASE:1.8
	OPENBSD_2_6:1.8.0.10
	OPENBSD_2_6_BASE:1.8
	OPENBSD_2_5:1.8.0.8
	OPENBSD_2_5_BASE:1.8
	OPENBSD_2_4:1.8.0.6
	OPENBSD_2_4_BASE:1.8
	OPENBSD_2_3:1.8.0.4
	OPENBSD_2_3_BASE:1.8
	OPENBSD_2_2:1.8.0.2
	OPENBSD_2_2_BASE:1.8
	OPENBSD_2_1:1.7.0.2
	OPENBSD_2_1_BASE:1.7
	OPENBSD_2_0:1.4.0.2
	OPENBSD_2_0_BASE:1.4
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@# @;


1.16
date	2015.10.04.07.25.59;	author nicm;	state Exp;
branches;
next	1.15;
commitid	dqw6dqZelGQB4GLZ;

1.15
date	2015.04.27.13.52.17;	author nicm;	state Exp;
branches;
next	1.14;
commitid	hZDBTMiQdWyr3asB;

1.14
date	2015.04.27.13.41.45;	author nicm;	state Exp;
branches;
next	1.13;
commitid	2EKcnUf9L3xLVo15;

1.13
date	2015.04.24.16.24.11;	author nicm;	state Exp;
branches;
next	1.12;
commitid	4VUU04TZM8ebPiy4;

1.12
date	2009.04.14.21.28.10;	author chl;	state Exp;
branches;
next	1.11;

1.11
date	2008.11.09.23.00.42;	author espie;	state Exp;
branches;
next	1.10;

1.10
date	2004.05.19.02.32.35;	author tedu;	state Exp;
branches;
next	1.9;

1.9
date	2003.03.03.22.24.08;	author ian;	state Exp;
branches;
next	1.8;

1.8
date	97.09.02.15.25.52;	author kstailey;	state Exp;
branches
	1.8.22.1;
next	1.7;

1.7
date	97.04.27.20.56.43;	author millert;	state Exp;
branches;
next	1.6;

1.6
date	97.02.09.23.58.15;	author millert;	state Exp;
branches;
next	1.5;

1.5
date	96.12.08.14.32.25;	author downsj;	state Exp;
branches;
next	1.4;

1.4
date	96.07.27.11.32.03;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	96.06.26.05.32.52;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	96.01.02.11.50.57;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.45.08;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.45.08;	author deraadt;	state Exp;
branches;
next	;

1.8.22.1
date	2003.03.12.02.14.16;	author margarida;	state Exp;
branches;
next	;


desc
@@


1.16
log
@Add tame(2) to file(1) and drop the old systrace(4) sandbox. tame(2) is
only applied to the child process, which requires the parent to not pass
directory file descriptors (tame("cmsg") does not allow it). Because
file(1) is already privsep, the permissions in the child can be quickly
restricted: first to "stdio cmsg getpw proc" then after the privdrop to
"stdio cmsg".
@
text
@# $OpenBSD: Makefile,v 1.15 2015/04/27 13:52:17 nicm Exp $

PROG=   file
SRCS=   file.c magic-dump.c magic-load.c magic-test.c magic-common.c \
	text.c xmalloc.c
MAN=	file.1 magic.5

LDADD=	-lutil
DPADD=	${LIBUTIL}

CDIAGFLAGS+= -Wno-long-long -Wall -W -Wnested-externs -Wformat=2
CDIAGFLAGS+= -Wmissing-prototypes -Wstrict-prototypes -Wmissing-declarations
CDIAGFLAGS+= -Wwrite-strings -Wshadow -Wpointer-arith -Wsign-compare
CDIAGFLAGS+= -Wundef -Wbad-function-cast -Winline -Wcast-align

MAGIC=		/etc/magic
MAGICOWN=	root
MAGICGRP=	bin
MAGICMODE=	444

CLEANFILES+=	magic post-magic

MAG1=		$(.CURDIR)/magdir/Header \
		$(.CURDIR)/magdir/Localstuff \
		$(.CURDIR)/magdir/OpenBSD
MAGFILES=	$(.CURDIR)/magdir/[0-9a-z]*

post-magic: $(MAGFILES)
	for i in ${.ALLSRC:N*.orig}; do \
		echo $$i; \
	done|sort|xargs -n 1024 cat >$(.TARGET)

magic: $(MAG1) post-magic
	cat ${MAG1} post-magic >$(.TARGET)

afterinstall:
	${INSTALL} ${INSTALL_COPY} -o $(MAGICOWN) -g $(MAGICGRP) \
		-m $(MAGICMODE) magic $(DESTDIR)$(MAGIC)

all: file magic

.include <bsd.prog.mk>
@


1.15
log
@Use a systrace(4) sandbox with a short whitelist of allowed syscalls for
the file(1) child process. Based on similar code in ssh sandbox-systrace.c.
Idea and help from deraadt@@.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.14 2015/04/27 13:41:45 nicm Exp $
d4 1
a4 1
SRCS=   file.c magic-dump.c magic-load.c magic-test.c magic-common.c sandbox.c \
@


1.14
log
@Add simple privilege separation to file(1). Two processes, file
descriptors and a few other bits are opened in parent and passed to
child using imsg. Child currently drops to "nobody" but this will change.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.13 2015/04/24 16:24:11 nicm Exp $
d4 2
a5 2
SRCS=   file.c magic-dump.c magic-load.c magic-test.c magic-common.c text.c \
	xmalloc.c
@


1.13
log
@New implementation of the file(1) utility. This is a simplified,
modernised version with a nearly complete magic(5) parser but omits some
of the complex builtin tests (notably ELF) and has a reduced set of
options.

ok deraadt
@
text
@d1 1
a1 1
# $OpenBSD$
d7 3
@


1.12
log
@force magic file to include all magdir files in alphabetical order,
preparing the way for upcoming update to file 4.24

almost entirely written by espie@@

"Go ahead, commit it." espie@@
@
text
@d1 11
a11 1
#	$OpenBSD: Makefile,v 1.11 2008/11/09 23:00:42 espie Exp $
a17 6
PROG=		file
SRCS=		file.c apprentice.c fsmagic.c softmagic.c ascmagic.c is_tar.c \
		print.c compress.c readelf.c magic.c funcs.c
CFLAGS+=	-DMAGIC='"$(MAGIC)"' -DUSE_UTIMES -DHAVE_CONFIG_H
MAN=		file.1 magic.5

a18 1
all:		file magic
d20 2
a21 2
MAG1=		$(.CURDIR)/magdir/Header\
		$(.CURDIR)/magdir/Localstuff\
d25 2
a26 3
post-magic:	$(MAGFILES)
	for i in ${.ALLSRC:N*.orig}; \
	do \
d28 1
a28 1
	done|sort|xargs -n 1024 cat > $(.TARGET)
d30 2
a31 2
magic:		$(MAG1) post-magic
	cat ${MAG1} post-magic > $(.TARGET)
d33 3
d37 1
a37 3
afterinstall:
	${INSTALL} ${INSTALL_COPY} -o $(MAGICOWN) -g $(MAGICGRP) -m $(MAGICMODE) magic \
		$(DESTDIR)$(MAGIC)
@


1.11
log
@protect against .orig files resulting from a patch.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.10 2004/05/19 02:32:35 tedu Exp $
d14 1
a14 1
CLEANFILES+=	magic
d17 1
a17 1
MAGFILES=	$(.CURDIR)/magdir/Header\
d19 12
a30 4
		$(.CURDIR)/magdir/OpenBSD\
		$(.CURDIR)/magdir/[0-9a-z]*
magic:		$(MAGFILES)
	cat ${.ALLSRC:N*.orig} > $(.TARGET)
@


1.10
log
@big update to file 4.09.  ok ian@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.9 2003/03/03 22:24:08 ian Exp $
d22 1
a22 1
	cat $(MAGFILES) > $(.TARGET)
@


1.9
log
@Bring in readelf.c from Christos' version 3.41 to head off a local
stack attack noted by iDefense, and for more complete 64-bit ELF support.
Add hand-made config.h to avoid running configure but still be able
to use Christos' code.  In print.c add error(...)-->err(1,...) wrapper.
Tested on i386, sparc64, macppc.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.8 1997/09/02 15:25:52 kstailey Exp $
d10 1
a10 1
		print.c compress.c readelf.c internat.c
@


1.8
log
@include files that start with numbers
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.7 1997/04/27 20:56:43 millert Exp $
d11 1
a11 1
CFLAGS+=	-DMAGIC='"$(MAGIC)"' -DUSE_UTIMES
@


1.8.22.1
log
@Pull patch from current.
Fix by ian@@
Bring in readelf.c from Christos' version 3.41 to head off a local
stack attack noted by iDefense, and for more complete 64-bit ELF support.
Add hand-made config.h to avoid running configure but still be able
to use Christos' code.  In print.c add error(...)-->err(1,...) wrapper.
Tested on i386, sparc64, macppc.

ok millert@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.9 2003/03/03 22:24:08 ian Exp $
d11 1
a11 1
CFLAGS+=	-DMAGIC='"$(MAGIC)"' -DUSE_UTIMES -DHAVE_CONFIG_H
@


1.7
log
@COPY -> INSTALL_COPY and STRIP -> INSTALL_STRIP
This fixes namespace problems where STRIP is sometimes used as
the name of the strip(1) to use and other times used as
the flag to send install(1) when stripping (or not).
COPY doesn't have this problem (yet) but was poorly named.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.6 1997/02/09 23:58:15 millert Exp $
d20 1
a20 1
		$(.CURDIR)/magdir/[a-z]*
@


1.6
log
@Updates file(1) to version 3.22 by way to NetBSD.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.5 1996/12/08 14:32:25 downsj Exp $
d25 1
a25 1
	${INSTALL} ${COPY} -o $(MAGICOWN) -g $(MAGICGRP) -m $(MAGICMODE) magic \
@


1.5
log
@install -> ${INSTALL}, -c -> ${COPY}
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.4 1996/07/27 11:32:03 deraadt Exp $
d10 2
a11 2
		print.c compress.c
CFLAGS+=	-DMAGIC='"$(MAGIC)"'
@


1.4
log
@MAGICOWN = root
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.3 1996/06/26 05:32:52 deraadt Exp $
d25 1
a25 1
	install ${COPY} -o $(MAGICOWN) -g $(MAGICGRP) -m $(MAGICMODE) magic \
@


1.3
log
@rcsid
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.2 1996/01/02 11:50:57 deraadt Exp $
d4 1
a4 1
MAGICOWN=	bin
@


1.2
log
@netbsd -> openbsd
@
text
@d1 1
a1 1
#	$Id: Makefile,v 1.1.1.1 1995/10/18 08:45:08 deraadt Exp $
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
#	$Id: Makefile,v 1.6 1994/12/22 12:29:47 cgd Exp $
d19 1
a19 1
		$(.CURDIR)/magdir/NetBSD\
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
