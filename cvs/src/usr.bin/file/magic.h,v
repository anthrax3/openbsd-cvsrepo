head	1.15;
access;
symbols
	OPENBSD_6_2:1.15.0.4
	OPENBSD_6_2_BASE:1.15
	OPENBSD_6_1:1.15.0.6
	OPENBSD_6_1_BASE:1.15
	OPENBSD_6_0:1.15.0.2
	OPENBSD_6_0_BASE:1.15
	OPENBSD_5_9:1.11.0.2
	OPENBSD_5_9_BASE:1.11
	OPENBSD_5_8:1.6.0.4
	OPENBSD_5_8_BASE:1.6
	OPENBSD_5_7:1.4.0.20
	OPENBSD_5_7_BASE:1.4
	OPENBSD_5_6:1.4.0.24
	OPENBSD_5_6_BASE:1.4
	OPENBSD_5_5:1.4.0.22
	OPENBSD_5_5_BASE:1.4
	OPENBSD_5_4:1.4.0.18
	OPENBSD_5_4_BASE:1.4
	OPENBSD_5_3:1.4.0.16
	OPENBSD_5_3_BASE:1.4
	OPENBSD_5_2:1.4.0.14
	OPENBSD_5_2_BASE:1.4
	OPENBSD_5_1_BASE:1.4
	OPENBSD_5_1:1.4.0.12
	OPENBSD_5_0:1.4.0.10
	OPENBSD_5_0_BASE:1.4
	OPENBSD_4_9:1.4.0.8
	OPENBSD_4_9_BASE:1.4
	OPENBSD_4_8:1.4.0.6
	OPENBSD_4_8_BASE:1.4
	OPENBSD_4_7:1.4.0.2
	OPENBSD_4_7_BASE:1.4
	OPENBSD_4_6:1.4.0.4
	OPENBSD_4_6_BASE:1.4
	OPENBSD_4_5:1.3.0.4
	OPENBSD_4_5_BASE:1.3
	OPENBSD_4_4:1.3.0.2
	OPENBSD_4_4_BASE:1.3
	OPENBSD_4_3:1.2.0.16
	OPENBSD_4_3_BASE:1.2
	OPENBSD_4_2:1.2.0.14
	OPENBSD_4_2_BASE:1.2
	OPENBSD_4_1:1.2.0.12
	OPENBSD_4_1_BASE:1.2
	OPENBSD_4_0:1.2.0.10
	OPENBSD_4_0_BASE:1.2
	OPENBSD_3_9:1.2.0.8
	OPENBSD_3_9_BASE:1.2
	OPENBSD_3_8:1.2.0.6
	OPENBSD_3_8_BASE:1.2
	OPENBSD_3_7:1.2.0.4
	OPENBSD_3_7_BASE:1.2
	OPENBSD_3_6:1.2.0.2
	OPENBSD_3_6_BASE:1.2;
locks; strict;
comment	@ * @;


1.15
date	2016.05.01.20.34.26;	author nicm;	state Exp;
branches;
next	1.14;
commitid	9Fc5iJrGyxGRfZc0;

1.14
date	2016.05.01.10.56.03;	author nicm;	state Exp;
branches;
next	1.13;
commitid	4wKczbrqqtYj8YHM;

1.13
date	2016.05.01.08.48.39;	author nicm;	state Exp;
branches;
next	1.12;
commitid	pIoqErW4Gu1kXma4;

1.12
date	2016.04.30.21.42.11;	author nicm;	state Exp;
branches;
next	1.11;
commitid	VzzcvK224IrqJfVf;

1.11
date	2015.10.05.20.05.52;	author nicm;	state Exp;
branches;
next	1.10;
commitid	RxwY3ihokrJggmZH;

1.10
date	2015.10.05.19.50.38;	author nicm;	state Exp;
branches;
next	1.9;
commitid	UEKcLh5DlhDlA9sA;

1.9
date	2015.10.02.18.06.27;	author deraadt;	state Exp;
branches;
next	1.8;
commitid	wAPE3Qpi3cDOGWss;

1.8
date	2015.08.11.22.12.48;	author nicm;	state Exp;
branches;
next	1.7;
commitid	W04QZVVfrRYK2LJv;

1.7
date	2015.08.11.21.42.16;	author nicm;	state Exp;
branches;
next	1.6;
commitid	wMFQLkkVNbimYXYt;

1.6
date	2015.05.29.14.15.41;	author nicm;	state Exp;
branches;
next	1.5;
commitid	gMvG6LkS3TlN9Qxb;

1.5
date	2015.04.24.16.24.11;	author nicm;	state Exp;
branches;
next	1.4;
commitid	4VUU04TZM8ebPiy4;

1.4
date	2009.04.24.18.54.34;	author chl;	state Exp;
branches;
next	1.3;

1.3
date	2008.05.08.01.40.56;	author chl;	state Exp;
branches;
next	1.2;

1.2
date	2004.05.19.02.36.26;	author tedu;	state Exp;
branches;
next	1.1;

1.1
date	2004.05.19.02.34.27;	author tedu;	state Exp;
branches;
next	;


desc
@@


1.15
log
@Tidy up some #include lines.
@
text
@/* $OpenBSD: magic.h,v 1.14 2016/05/01 10:56:03 nicm Exp $ */

/*
 * Copyright (c) 2015 Nicholas Marriott <nicm@@openbsd.org>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF MIND, USE, DATA OR PROFITS, WHETHER
 * IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING
 * OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#ifndef MAGIC_H
#define MAGIC_H

#include <sys/types.h>
#include <sys/tree.h>
#include <sys/queue.h>

#include <regex.h>
#include <stdio.h>
#include <stdarg.h>

#define MAGIC_STRING_SIZE 31
#define MAGIC_STRENGTH_MULTIPLIER 10

enum magic_type {
	MAGIC_TYPE_NONE = 0,
	MAGIC_TYPE_BYTE,
	MAGIC_TYPE_SHORT,
	MAGIC_TYPE_LONG,
	MAGIC_TYPE_QUAD,
	MAGIC_TYPE_UBYTE,
	MAGIC_TYPE_USHORT,
	MAGIC_TYPE_ULONG,
	MAGIC_TYPE_UQUAD,
	MAGIC_TYPE_FLOAT,
	MAGIC_TYPE_DOUBLE,
	MAGIC_TYPE_STRING,
	MAGIC_TYPE_PSTRING,
	MAGIC_TYPE_DATE,
	MAGIC_TYPE_QDATE,
	MAGIC_TYPE_LDATE,
	MAGIC_TYPE_QLDATE,
	MAGIC_TYPE_UDATE,
	MAGIC_TYPE_UQDATE,
	MAGIC_TYPE_ULDATE,
	MAGIC_TYPE_UQLDATE,
	MAGIC_TYPE_BESHORT,
	MAGIC_TYPE_BELONG,
	MAGIC_TYPE_BEQUAD,
	MAGIC_TYPE_UBESHORT,
	MAGIC_TYPE_UBELONG,
	MAGIC_TYPE_UBEQUAD,
	MAGIC_TYPE_BEFLOAT,
	MAGIC_TYPE_BEDOUBLE,
	MAGIC_TYPE_BEDATE,
	MAGIC_TYPE_BEQDATE,
	MAGIC_TYPE_BELDATE,
	MAGIC_TYPE_BEQLDATE,
	MAGIC_TYPE_UBEDATE,
	MAGIC_TYPE_UBEQDATE,
	MAGIC_TYPE_UBELDATE,
	MAGIC_TYPE_UBEQLDATE,
	MAGIC_TYPE_BESTRING16,
	MAGIC_TYPE_LESHORT,
	MAGIC_TYPE_LELONG,
	MAGIC_TYPE_LEQUAD,
	MAGIC_TYPE_ULESHORT,
	MAGIC_TYPE_ULELONG,
	MAGIC_TYPE_ULEQUAD,
	MAGIC_TYPE_LEFLOAT,
	MAGIC_TYPE_LEDOUBLE,
	MAGIC_TYPE_LEDATE,
	MAGIC_TYPE_LEQDATE,
	MAGIC_TYPE_LELDATE,
	MAGIC_TYPE_LEQLDATE,
	MAGIC_TYPE_ULEDATE,
	MAGIC_TYPE_ULEQDATE,
	MAGIC_TYPE_ULELDATE,
	MAGIC_TYPE_ULEQLDATE,
	MAGIC_TYPE_LESTRING16,
	MAGIC_TYPE_MELONG,
	MAGIC_TYPE_MEDATE,
	MAGIC_TYPE_MELDATE,
	MAGIC_TYPE_REGEX,
	MAGIC_TYPE_SEARCH,
	MAGIC_TYPE_DEFAULT,
	MAGIC_TYPE_CLEAR,
	MAGIC_TYPE_NAME,
	MAGIC_TYPE_USE,
};

TAILQ_HEAD(magic_lines, magic_line);
RB_HEAD(magic_tree, magic_line);
RB_HEAD(magic_named_tree, magic_line);

struct magic_line {
	struct magic		*root;
	u_int			 line;
	u_int			 strength;
	struct magic_line	*parent;

	char			 strength_operator;
	u_int			 strength_value;

	int			 text;

	int64_t			 offset;
	int			 offset_relative;

	char			 indirect_type;
	int			 indirect_relative;
	int64_t			 indirect_offset;
	char			 indirect_operator;
	int64_t			 indirect_operand;

	const char		*name;

	enum magic_type		 type;
	const char		*type_string;
	char			 type_operator;
	int64_t			 type_operand;

	char			 test_operator;
	int			 test_not;
	const char		*test_string;
	size_t			 test_string_size;
	uint64_t		 test_unsigned;
	int64_t			 test_signed;
	double			 test_double;

	int			 stringify;
	const char		*result;
	const char		*mimetype;

	struct magic_lines	 children;
	TAILQ_ENTRY(magic_line)	 entry;
	RB_ENTRY(magic_line)	 node;
};

struct magic {
	const char		*path;
	int			 warnings;

	struct magic_tree	 tree;
	struct magic_named_tree	 named;

	int			 compiled;
	regex_t			 format_short;
	regex_t			 format_long;
	regex_t			 format_quad;
	regex_t			 format_float;
	regex_t			 format_string;
};

struct magic_state {
	char			 out[4096];
	const char		*mimetype;
	int			 text;

	const char		*base;
	size_t			 size;
	size_t			 offset;
	int			 matched;

	size_t			 start;
	int			 reverse;
};

#define MAGIC_TEST_TEXT 0x1
#define MAGIC_TEST_MIME 0x2

int		 magic_compare(struct magic_line *, struct magic_line *);
RB_PROTOTYPE(magic_tree, magic_line, node, magic_compare);

int		 magic_named_compare(struct magic_line *, struct magic_line *);
RB_PROTOTYPE(magic_named_tree, magic_line, node, magic_named_compare);

char		*magic_strtoull(const char *, uint64_t *);
char		*magic_strtoll(const char *, int64_t *);
void		 magic_vwarnm(struct magic *, u_int, const char *, va_list);
void		 magic_warnm(struct magic *, u_int, const char *, ...)
		     __attribute__ ((format (printf, 3, 4)));
void		 magic_warn(struct magic_line *, const char *, ...)
		     __attribute__ ((format (printf, 2, 3)));

void		 magic_dump(struct magic *);
struct magic	*magic_load(FILE *, const char *, int);
const char	*magic_test(struct magic *, const void *, size_t, int);

#endif /* MAGIC_H */
@


1.14
log
@Add support for 'name' and 'use' which allows more of the latest magic
files to work unchanged. (We are still missing 'indirect' and a few
other bits.)
@
text
@d1 1
a1 1
/* $OpenBSD: magic.h,v 1.13 2016/05/01 08:48:39 nicm Exp $ */
d22 1
a24 1
#include <sys/stat.h>
a25 1
#include <err.h>
a28 2
#include <stdlib.h>
#include <string.h>
@


1.13
log
@Add support for 'clear' test, and fix 'default' to expand the result
string if any (used by, for example, rtf).
@
text
@d1 1
a1 1
/* $OpenBSD: magic.h,v 1.12 2016/04/30 21:42:11 nicm Exp $ */
d99 2
d105 1
d127 2
d156 1
d175 3
d185 3
@


1.12
log
@Fix the default type to work properly, that is to only match if no
previous test at the same level has matched.
@
text
@d1 1
a1 1
/* $OpenBSD: magic.h,v 1.11 2015/10/05 20:05:52 nicm Exp $ */
d98 1
@


1.11
log
@Add support for !:strength modifier to adjust strength of a test.
@
text
@d1 1
a1 1
/* $OpenBSD: magic.h,v 1.10 2015/10/05 19:50:38 nicm Exp $ */
d167 1
@


1.10
log
@Offset into the file can be size_t and add some casts to remove warnings.
@
text
@d1 1
a1 1
/* $OpenBSD: magic.h,v 1.9 2015/10/02 18:06:27 deraadt Exp $ */
d108 3
@


1.9
log
@use limits.h instead of sys/param.h to get PATH_MAX
@
text
@d1 1
a1 1
/* $OpenBSD: magic.h,v 1.8 2015/08/11 22:12:48 nicm Exp $ */
d163 1
a163 1
	int64_t			 offset;
@


1.8
log
@Support = test for floats and doubles.
@
text
@d1 1
a1 1
/* $OpenBSD: magic.h,v 1.7 2015/08/11 21:42:16 nicm Exp $ */
a21 1
#include <sys/param.h>
@


1.7
log
@Add another function for printing warnings before the magic_line is
created so all warnings go through the same fprintf.
@
text
@d1 1
a1 1
/* $OpenBSD: magic.h,v 1.6 2015/05/29 14:15:41 nicm Exp $ */
d132 1
@


1.6
log
@I got confused and made the strength multiplier 20, it should be 10.
@
text
@d1 1
a1 1
/* $OpenBSD: magic.h,v 1.5 2015/04/24 16:24:11 nicm Exp $ */
d30 1
d174 3
@


1.5
log
@New implementation of the file(1) utility. This is a simplified,
modernised version with a nearly complete magic(5) parser but omits some
of the complex builtin tests (notably ELF) and has a reduced set of
options.

ok deraadt
@
text
@d1 1
a1 1
/* $OpenBSD$ */
d34 1
a34 1
#define MAGIC_STRENGTH_MULTIPLIER 20
@


1.4
log
@file update to 4.24

The '-i' switch is now enabled so file(1) can output mime type strings.

ok ian@@
builk ports build test on amd64 by jasper@@

ok ray@@ gilles@@ on a almost identical diff
builk ports build test on sparc64 on this almost identical diff by ajacoutot@@
also tested by landry@@
@
text
@d1 2
a2 1
/* $OpenBSD: magic.h,v 1.3 2008/05/08 01:40:56 chl Exp $ */
d4 13
a16 24
 * Copyright (c) Christos Zoulas 2003.
 * All Rights Reserved.
 * 
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice immediately at the beginning of the file, without modification,
 *    this list of conditions, and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *  
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
a17 2
#ifndef _MAGIC_H
#define _MAGIC_H
d19 121
a139 1
#include <sys/types.h>
d141 13
a153 45
#define	MAGIC_NONE		0x000000 /* No flags */
#define	MAGIC_DEBUG		0x000001 /* Turn on debugging */
#define	MAGIC_SYMLINK		0x000002 /* Follow symlinks */
#define	MAGIC_COMPRESS		0x000004 /* Check inside compressed files */
#define	MAGIC_DEVICES		0x000008 /* Look at the contents of devices */
#define	MAGIC_MIME_TYPE		0x000010 /* Return only the MIME type */
#define	MAGIC_CONTINUE		0x000020 /* Return all matches */
#define	MAGIC_CHECK		0x000040 /* Print warnings to stderr */
#define	MAGIC_PRESERVE_ATIME	0x000080 /* Restore access time on exit */
#define	MAGIC_RAW		0x000100 /* Don't translate unprint chars */
#define	MAGIC_ERROR		0x000200 /* Handle ENOENT etc as real errors */
#define	MAGIC_MIME_ENCODING	0x000400 /* Return only the MIME encoding */
#define MAGIC_MIME		(MAGIC_MIME_TYPE|MAGIC_MIME_ENCODING)
#define	MAGIC_NO_CHECK_COMPRESS	0x001000 /* Don't check for compressed files */
#define	MAGIC_NO_CHECK_TAR	0x002000 /* Don't check for tar files */
#define	MAGIC_NO_CHECK_SOFT	0x004000 /* Don't check magic entries */
#define	MAGIC_NO_CHECK_APPTYPE	0x008000 /* Don't check application type */
#define	MAGIC_NO_CHECK_ELF	0x010000 /* Don't check for elf details */
#define	MAGIC_NO_CHECK_ASCII	0x020000 /* Don't check for ascii files */
#define	MAGIC_NO_CHECK_TOKENS	0x100000 /* Don't check ascii/tokens */

/* Defined for backwards compatibility; do nothing */
#define	MAGIC_NO_CHECK_FORTRAN	0x000000 /* Don't check ascii/fortran */
#define	MAGIC_NO_CHECK_TROFF	0x000000 /* Don't check ascii/troff */


#ifdef __cplusplus
extern "C" {
#endif

typedef struct magic_set *magic_t;
magic_t magic_open(int);
void magic_close(magic_t);

const char *magic_file(magic_t, const char *);
const char *magic_descriptor(magic_t, int);
const char *magic_buffer(magic_t, const void *, size_t);

const char *magic_error(magic_t);
int magic_setflags(magic_t, int);

int magic_load(magic_t, const char *);
int magic_compile(magic_t, const char *);
int magic_check(magic_t, const char *);
int magic_errno(magic_t);
d155 8
a162 1
#ifdef __cplusplus
a163 1
#endif
d165 16
a180 1
#endif /* _MAGIC_H */
@


1.3
log
@Update file to 4.21.

tested by ian@@ sthen@@

OK ian@@, "move ahead with it" deraadt@@
@
text
@d1 1
a1 1
/* $OpenBSD: magic.h,v 1.2 2004/05/19 02:36:26 tedu Exp $ */
d38 1
a38 1
#define	MAGIC_MIME		0x000010 /* Return a mime string */
d42 1
a42 1
#define	MAGIC_RAW		0x000100 /* Don't translate unprintable chars */
d44 14
a57 9
#define MAGIC_NO_CHECK_COMPRESS	0x001000 /* Don't check for compressed files */
#define MAGIC_NO_CHECK_TAR	0x002000 /* Don't check for tar files */
#define MAGIC_NO_CHECK_SOFT	0x004000 /* Don't check magic entries */
#define MAGIC_NO_CHECK_APPTYPE	0x008000 /* Don't check application type */
#define MAGIC_NO_CHECK_ELF	0x010000 /* Don't check for elf details */
#define MAGIC_NO_CHECK_ASCII	0x020000 /* Don't check for ascii files */
#define MAGIC_NO_CHECK_TROFF	0x040000 /* Don't check ascii/troff */
#define MAGIC_NO_CHECK_FORTRAN	0x080000 /* Don't check ascii/fortran */
#define MAGIC_NO_CHECK_TOKENS	0x100000 /* Don't check ascii/tokens */
d68 1
@


1.2
log
@remove old file, rcsids
@
text
@d1 1
a1 1
/* $OpenBSD$ */
a14 2
 * 3. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
d33 20
a52 11
#define	MAGIC_NONE		0x000	/* No flags */
#define	MAGIC_DEBUG		0x001	/* Turn on debugging */
#define	MAGIC_SYMLINK		0x002	/* Follow symlinks */
#define	MAGIC_COMPRESS		0x004	/* Check inside compressed files */
#define	MAGIC_DEVICES		0x008	/* Look at the contents of devices */
#define	MAGIC_MIME		0x010	/* Return a mime string */
#define	MAGIC_CONTINUE		0x020	/* Return all matches */
#define	MAGIC_CHECK		0x040	/* Print warnings to stderr */
#define	MAGIC_PRESERVE_ATIME	0x080	/* Restore access time on exit */
#define	MAGIC_RAW		0x100	/* Don't translate unprintable chars */
#define	MAGIC_ERROR		0x200	/* Handle ENOENT etc as real errors */
@


1.1
log
@file 4.09
@
text
@d1 1
@

