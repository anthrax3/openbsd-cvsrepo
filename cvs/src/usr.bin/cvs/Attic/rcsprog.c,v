head	1.6;
access;
symbols
	OPENBSD_3_7:1.2.0.2
	OPENBSD_3_7_BASE:1.2;
locks; strict;
comment	@ * @;


1.6
date	2005.04.15.15.47.16;	author deraadt;	state dead;
branches;
next	1.5;

1.5
date	2005.04.11.19.55.28;	author jfb;	state Exp;
branches;
next	1.4;

1.4
date	2005.04.11.18.02.58;	author joris;	state Exp;
branches;
next	1.3;

1.3
date	2005.04.06.18.51.29;	author joris;	state Exp;
branches;
next	1.2;

1.2
date	2005.03.05.23.22.10;	author jmc;	state Exp;
branches;
next	1.1;

1.1
date	2005.03.05.18.50.43;	author jfb;	state Exp;
branches;
next	;


desc
@@


1.6
log
@stuff moved to rcs dir
@
text
@/*	$OpenBSD: rcsprog.c,v 1.5 2005/04/11 19:55:28 jfb Exp $	*/
/*
 * Copyright (c) 2005 Jean-Francois Brousseau <jfb@@openbsd.org>
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,
 * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY
 * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL
 * THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL  DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
 * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

#include <sys/types.h>
#include <sys/wait.h>

#include <err.h>
#include <pwd.h>
#include <errno.h>
#include <stdio.h>
#include <ctype.h>
#include <stdlib.h>
#include <unistd.h>
#include <signal.h>
#include <string.h>

#include "log.h"
#include "rcs.h"
#include "strtab.h"

extern char *__progname;


const char rcs_version[] = "OpenCVS RCS version 3.6";

void  rcs_usage (void);
int   rcs_main  (int, char **);



struct rcs_prog {
	char  *prog_name;
	int  (*prog_hdlr)(int, char **);
} programs[] = {
	{ "rcs",        rcs_main  },
	{ "ci",         NULL      },
	{ "co",         NULL      },
	{ "rcsclean",   NULL      },
	{ "rcsdiff",    NULL      },
};


int
main(int argc, char **argv)
{
	u_int i;
	int ret;

	ret = -1;
	cvs_strtab_init();

	for (i = 0; i < (sizeof(programs)/sizeof(programs[0])); i++)
		if (strcmp(__progname, programs[i].prog_name) == 0)
			ret = programs[i].prog_hdlr(argc, argv);

	cvs_strtab_cleanup();

	return (ret);
}


void
rcs_usage(void)
{
	fprintf(stderr,
	    "Usage: %s [-hiLMUV] [-a users] [-b [rev]] [-c string] "
	    "[-e users] [-k opt] file ...\n"
	    "\t-a users\tAdd the login names in the comma-separated <users>\n"
	    "\t-b rev\t\tSet the head revision to <rev>\n"
	    "\t-c string\tSet the comment leader to <string>\n"
	    "\t-e users\tRemove the login names in the comma-separated <users>\n"
	    "\t-h\t\tPrint the program's usage and exit\n"
	    "\t-i\t\tCreate a new empty RCS file\n"
	    "\t-k opt\t\tSet the keyword expansion mode to <opt>\n"
	    "\t-L\t\tEnable strict locking on the specified files\n"
	    "\t-M\t\tDisable mail warning about lock breaks\n"
	    "\t-U\t\tDisable strict locking on the specified files\n"
	    "\t-V\t\tPrint the program's version string and exit\n",
	    __progname);
}


/*
 * rcs_main()
 *
 * Handler for the `rcs' program.
 * Returns 0 on success, or >0 on error.
 */
int
rcs_main(int argc, char **argv)
{
	int i, ch, flags, kflag, lkmode;
	char *oldfile, *alist, *comment, *elist, *unp, *sp;
	mode_t fmode;
	RCSFILE *file;

	kflag = lkmode = -1;
	fmode = 0;
	flags = RCS_RDWR;
	oldfile = alist = comment = elist = NULL;

	cvs_log_init(LD_STD, 0);

	while ((ch = getopt(argc, argv, "A:a:b::c:e::hik:LMUV")) != -1) {
		switch (ch) {
		case 'A':
			oldfile = optarg;
			break;
		case 'a':
			alist = optarg;
			break;
		case 'c':
			comment = optarg;
			break;
		case 'e':
			elist = optarg;
			break;
		case 'h':
			rcs_usage();
			exit(0);
		case 'i':
			flags |= RCS_CREATE;
			break;
		case 'k':
			kflag = rcs_kflag_get(optarg);
			if (RCS_KWEXP_INVAL(kflag)) {
				cvs_log(LP_ERR,
				    "invalid keyword substitution mode `%s'",
				    optarg);
				exit(1);
			}
			break;
		case 'L':
			if (lkmode == RCS_LOCK_LOOSE)
				cvs_log(LP_WARN, "-U overriden by -L");
			lkmode = RCS_LOCK_STRICT;
			break;
		case 'M':
			/* ignore for the moment */
			break;
		case 'U':
			if (lkmode == RCS_LOCK_STRICT)
				cvs_log(LP_WARN, "-L overriden by -U");
			lkmode = RCS_LOCK_LOOSE;
			break;
		case 'V':
			printf("%s\n", rcs_version);
			exit(0);
		default:
			rcs_usage();
			exit(1);
		}
	}

	argc -= optind;
	argv += optind;
	if (argc == 0) {
		cvs_log(LP_ERR, "no input file");
		exit(1);
	}

	for (i = 0; i < argc; i++) {
		printf("RCS file: %s\n", argv[0]);
		file = rcs_open(argv[0], flags, fmode);
		if (file == NULL) {
			return (1);
		}

		/* entries to add to the access list */
		if (alist != NULL) {
			unp = alist;
			do {
				sp = strchr(unp, ',');
				if (sp != NULL)
					*(sp++) = '\0';

				rcs_access_add(file, unp);

				unp = sp;
			} while (sp != NULL);
		}

		if (comment != NULL)
			rcs_comment_set(file, comment);

		if (kflag != -1)
			rcs_kwexp_set(file, kflag);

		if (lkmode != -1)
			rcs_lock_setmode(file, lkmode);

		rcs_close(file);
		printf("done\n");
	}

	return (0);
}
@


1.5
log
@open the RCS files in write mode by default to allow modifications
@
text
@d1 1
a1 1
/*	$OpenBSD: rcsprog.c,v 1.4 2005/04/11 18:02:58 joris Exp $	*/
@


1.4
log
@

don't include sysexits.h now we don't use those error codes
anymore.
@
text
@d1 1
a1 1
/*	$OpenBSD: rcsprog.c,v 1.3 2005/04/06 18:51:29 joris Exp $	*/
d122 1
a122 1
	flags = RCS_READ;
d145 1
a145 1
			flags |= (RCS_WRITE | RCS_CREATE);
@


1.3
log
@

start using strtab stuff in RCS code.

ok jfb@@, xsa@@
@
text
@d1 1
a1 1
/*	$OpenBSD: rcsprog.c,v 1.2 2005/03/05 23:22:10 jmc Exp $	*/
a38 1
#include <sysexits.h>
@


1.2
log
@add -V to usage();
ok jfb@@
@
text
@d1 1
a1 1
/*	$OpenBSD: rcsprog.c,v 1.1 2005/03/05 18:50:43 jfb Exp $	*/
d43 1
a43 1

d71 4
d78 1
a78 1
			return (*programs[i].prog_hdlr)(argc, argv);
d80 1
a80 1
	errx(1, "not too sure what you expect me to do!");
d82 1
a82 1
	return (0);
@


1.1
log
@basic implementation of the rcs(1) tool, very useful in debugging the
RCS code.  options will get supported as the missing bits get added
to the RCS parsing and output code
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d86 1
a86 1
	    "Usage: %s [-hiLMU] [-a users] [-b [rev]] [-c string] "
@

