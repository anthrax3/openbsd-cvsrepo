head	1.134;
access;
symbols
	OPENBSD_6_2_BASE:1.134
	OPENBSD_6_1:1.133.0.4
	OPENBSD_6_1_BASE:1.133
	OPENBSD_6_0:1.131.0.4
	OPENBSD_6_0_BASE:1.131
	OPENBSD_5_9:1.131.0.2
	OPENBSD_5_9_BASE:1.131
	OPENBSD_5_8:1.129.0.4
	OPENBSD_5_8_BASE:1.129
	OPENBSD_5_7:1.126.0.2
	OPENBSD_5_7_BASE:1.126
	OPENBSD_5_6:1.119.0.10
	OPENBSD_5_6_BASE:1.119
	OPENBSD_5_5:1.119.0.8
	OPENBSD_5_5_BASE:1.119
	OPENBSD_5_4:1.119.0.4
	OPENBSD_5_4_BASE:1.119
	OPENBSD_5_3:1.119.0.2
	OPENBSD_5_3_BASE:1.119
	OPENBSD_5_2:1.118.0.6
	OPENBSD_5_2_BASE:1.118
	OPENBSD_5_1_BASE:1.118
	OPENBSD_5_1:1.118.0.4
	OPENBSD_5_0:1.118.0.2
	OPENBSD_5_0_BASE:1.118
	OPENBSD_4_9:1.117.0.6
	OPENBSD_4_9_BASE:1.117
	OPENBSD_4_8:1.117.0.4
	OPENBSD_4_8_BASE:1.117
	OPENBSD_4_7:1.117.0.2
	OPENBSD_4_7_BASE:1.117
	OPENBSD_4_6:1.114.0.4
	OPENBSD_4_6_BASE:1.114
	OPENBSD_4_5:1.112.0.2
	OPENBSD_4_5_BASE:1.112
	OPENBSD_4_4:1.109.0.2
	OPENBSD_4_4_BASE:1.109
	OPENBSD_4_3:1.108.0.2
	OPENBSD_4_3_BASE:1.108
	OPENBSD_4_2:1.107.0.2
	OPENBSD_4_2_BASE:1.107
	OPENBSD_4_1:1.97.0.2
	OPENBSD_4_1_BASE:1.97
	OPENBSD_4_0:1.61.0.2
	OPENBSD_4_0_BASE:1.61
	OPENBSD_3_9:1.59.0.2
	OPENBSD_3_9_BASE:1.59
	OPENBSD_3_8:1.57.0.2
	OPENBSD_3_8_BASE:1.57
	OPENBSD_3_7:1.53.0.2
	OPENBSD_3_7_BASE:1.53
	OPENBSD_3_6:1.49.0.4
	OPENBSD_3_6_BASE:1.49
	OPENBSD_3_5:1.49.0.2
	OPENBSD_3_5_BASE:1.49
	OPENBSD_3_4:1.37.0.2
	OPENBSD_3_4_BASE:1.37
	OPENBSD_3_3:1.33.0.2
	OPENBSD_3_3_BASE:1.33;
locks; strict;
comment	@.\" @;


1.134
date	2017.04.02.18.14.34;	author jmc;	state Exp;
branches;
next	1.133;
commitid	Hi7F8gPJ8MC7ZcZD;

1.133
date	2017.03.16.15.16.21;	author jmc;	state Exp;
branches;
next	1.132;
commitid	mZ58XaksD8o2a2uF;

1.132
date	2017.03.16.15.07.45;	author jmc;	state Exp;
branches;
next	1.131;
commitid	fl78lNqaYPcgYH7u;

1.131
date	2015.08.12.14.41.37;	author jmc;	state Exp;
branches;
next	1.130;
commitid	ASFeJBPFOOOu3JAd;

1.130
date	2015.08.12.14.36.47;	author jmc;	state Exp;
branches;
next	1.129;
commitid	HAowXy9NnrPV3JQg;

1.129
date	2015.07.27.17.28.38;	author sobrado;	state Exp;
branches;
next	1.128;
commitid	a73SHFfjDK7MTyGx;

1.128
date	2015.05.18.16.04.21;	author reyk;	state Exp;
branches;
next	1.127;
commitid	BUauTTbpwkWg0A95;

1.127
date	2015.04.14.17.29.06;	author deraadt;	state Exp;
branches;
next	1.126;
commitid	ay2EV11ZRqc48yBb;

1.126
date	2015.02.15.22.27.51;	author bentley;	state Exp;
branches;
next	1.125;
commitid	NBjEVC2mdJupO4kK;

1.125
date	2015.02.07.18.05.57;	author jmc;	state Exp;
branches;
next	1.124;
commitid	1HAOxBXKqoo8ok0b;

1.124
date	2015.02.07.10.45.19;	author henning;	state Exp;
branches;
next	1.123;
commitid	KM4HBss9hVRsxfE8;

1.123
date	2014.11.22.18.15.41;	author deraadt;	state Exp;
branches;
next	1.122;
commitid	3NByYuO1tptMzbXx;

1.122
date	2014.10.11.20.06.31;	author landry;	state Exp;
branches;
next	1.121;
commitid	eNZ3xXYBTAubDLhr;

1.121
date	2014.09.16.21.16.57;	author jmc;	state Exp;
branches;
next	1.120;
commitid	yFD6dKwRvi7QWclT;

1.120
date	2014.09.01.02.48.00;	author guenther;	state Exp;
branches;
next	1.119;
commitid	GTuv8xOw0LRwNprx;

1.119
date	2012.09.27.20.12.32;	author jmc;	state Exp;
branches;
next	1.118;

1.118
date	2011.03.19.23.29.45;	author okan;	state Exp;
branches;
next	1.117;

1.117
date	2009.09.17.06.37.54;	author jmc;	state Exp;
branches;
next	1.116;

1.116
date	2009.09.07.09.43.57;	author jmc;	state Exp;
branches;
next	1.115;

1.115
date	2009.09.01.14.46.43;	author todd;	state Exp;
branches;
next	1.114;

1.114
date	2009.04.20.21.08.27;	author jmc;	state Exp;
branches;
next	1.113;

1.113
date	2009.04.20.17.42.21;	author beck;	state Exp;
branches;
next	1.112;

1.112
date	2009.02.17.22.07.11;	author jmc;	state Exp;
branches;
next	1.111;

1.111
date	2008.09.20.20.38.23;	author jmc;	state Exp;
branches;
next	1.110;

1.110
date	2008.08.11.20.28.55;	author jmc;	state Exp;
branches;
next	1.109;

1.109
date	2008.03.28.18.21.55;	author grunk;	state Exp;
branches;
next	1.108;

1.108
date	2008.01.08.22.54.25;	author jmc;	state Exp;
branches;
next	1.107;

1.107
date	2007.08.11.06.09.02;	author jmc;	state Exp;
branches;
next	1.106;

1.106
date	2007.08.11.02.48.32;	author jsg;	state Exp;
branches;
next	1.105;

1.105
date	2007.07.07.06.54.09;	author jmc;	state Exp;
branches;
next	1.104;

1.104
date	2007.06.25.12.28.34;	author tom;	state Exp;
branches;
next	1.103;

1.103
date	2007.05.31.19.19.40;	author jmc;	state Exp;
branches;
next	1.102;

1.102
date	2007.05.26.23.35.36;	author jmc;	state Exp;
branches;
next	1.101;

1.101
date	2007.05.19.21.44.21;	author jmc;	state Exp;
branches;
next	1.100;

1.100
date	2007.03.26.19.08.09;	author jmc;	state Exp;
branches;
next	1.99;

1.99
date	2007.03.26.15.20.43;	author beck;	state Exp;
branches;
next	1.98;

1.98
date	2007.03.15.21.56.25;	author jmc;	state Exp;
branches;
next	1.97;

1.97
date	2007.03.07.21.35.25;	author millert;	state Exp;
branches;
next	1.96;

1.96
date	2007.03.07.09.10.10;	author jmc;	state Exp;
branches;
next	1.95;

1.95
date	2007.03.07.08.46.23;	author jmc;	state Exp;
branches;
next	1.94;

1.94
date	2007.03.07.08.26.52;	author jmc;	state Exp;
branches;
next	1.93;

1.93
date	2007.03.06.23.38.36;	author beck;	state Exp;
branches;
next	1.92;

1.92
date	2007.03.06.09.00.13;	author jmc;	state Exp;
branches;
next	1.91;

1.91
date	2007.03.06.08.56.32;	author jmc;	state Exp;
branches;
next	1.90;

1.90
date	2007.03.06.02.00.25;	author beck;	state Exp;
branches;
next	1.89;

1.89
date	2007.03.05.21.25.29;	author beck;	state Exp;
branches;
next	1.88;

1.88
date	2007.03.05.16.59.54;	author reyk;	state Exp;
branches;
next	1.87;

1.87
date	2007.03.05.16.57.25;	author reyk;	state Exp;
branches;
next	1.86;

1.86
date	2007.03.04.06.44.45;	author joel;	state Exp;
branches;
next	1.85;

1.85
date	2007.03.04.03.19.41;	author beck;	state Exp;
branches;
next	1.84;

1.84
date	2007.03.02.08.14.59;	author jmc;	state Exp;
branches;
next	1.83;

1.83
date	2007.03.01.20.38.52;	author jmc;	state Exp;
branches;
next	1.82;

1.82
date	2007.02.28.01.01.20;	author david;	state Exp;
branches;
next	1.81;

1.81
date	2007.02.27.19.56.47;	author jmc;	state Exp;
branches;
next	1.80;

1.80
date	2007.02.27.19.48.17;	author jmc;	state Exp;
branches;
next	1.79;

1.79
date	2007.02.27.19.47.31;	author jmc;	state Exp;
branches;
next	1.78;

1.78
date	2007.02.27.18.02.23;	author jmc;	state Exp;
branches;
next	1.77;

1.77
date	2007.02.27.17.51.10;	author jmc;	state Exp;
branches;
next	1.76;

1.76
date	2007.02.27.17.19.20;	author beck;	state Exp;
branches;
next	1.75;

1.75
date	2007.02.27.15.38.27;	author jmc;	state Exp;
branches;
next	1.74;

1.74
date	2007.02.27.14.52.31;	author jmc;	state Exp;
branches;
next	1.73;

1.73
date	2007.02.27.02.10.58;	author beck;	state Exp;
branches;
next	1.72;

1.72
date	2007.02.25.22.04.12;	author jmc;	state Exp;
branches;
next	1.71;

1.71
date	2007.02.25.20.21.01;	author millert;	state Exp;
branches;
next	1.70;

1.70
date	2007.02.24.19.28.13;	author millert;	state Exp;
branches;
next	1.69;

1.69
date	2007.02.24.08.48.49;	author jmc;	state Exp;
branches;
next	1.68;

1.68
date	2007.02.23.23.14.56;	author beck;	state Exp;
branches;
next	1.67;

1.67
date	2007.02.23.19.22.07;	author beck;	state Exp;
branches;
next	1.66;

1.66
date	2006.11.14.17.37.47;	author jmc;	state Exp;
branches;
next	1.65;

1.65
date	2006.11.14.17.35.19;	author jmc;	state Exp;
branches;
next	1.64;

1.64
date	2006.10.19.11.46.51;	author jmc;	state Exp;
branches;
next	1.63;

1.63
date	2006.10.17.19.11.56;	author beck;	state Exp;
branches;
next	1.62;

1.62
date	2006.09.29.00.37.36;	author jmc;	state Exp;
branches;
next	1.61;

1.61
date	2006.08.15.20.52.12;	author kjell;	state Exp;
branches;
next	1.60;

1.60
date	2006.05.15.16.47.48;	author jcs;	state Exp;
branches;
next	1.59;

1.59
date	2005.12.01.15.21.16;	author tom;	state Exp;
branches;
next	1.58;

1.58
date	2005.11.24.08.47.10;	author jmc;	state Exp;
branches;
next	1.57;

1.57
date	2005.08.06.19.52.36;	author jmc;	state Exp;
branches;
next	1.56;

1.56
date	2005.05.17.08.25.55;	author jmc;	state Exp;
branches;
next	1.55;

1.55
date	2005.05.17.08.16.51;	author jmc;	state Exp;
branches;
next	1.54;

1.54
date	2005.04.14.16.07.52;	author beck;	state Exp;
branches;
next	1.53;

1.53
date	2005.03.11.23.09.53;	author beck;	state Exp;
branches;
next	1.52;

1.52
date	2005.01.19.17.07.31;	author deraadt;	state Exp;
branches;
next	1.51;

1.51
date	2004.10.05.21.04.36;	author beck;	state Exp;
branches;
next	1.50;

1.50
date	2004.10.05.15.20.30;	author beck;	state Exp;
branches;
next	1.49;

1.49
date	2004.03.16.09.19.25;	author jmc;	state Exp;
branches;
next	1.48;

1.48
date	2004.03.15.21.53.39;	author beck;	state Exp;
branches;
next	1.47;

1.47
date	2004.03.12.22.16.16;	author jmc;	state Exp;
branches;
next	1.46;

1.46
date	2004.03.12.21.01.16;	author beck;	state Exp;
branches;
next	1.45;

1.45
date	2004.03.10.00.32.54;	author beck;	state Exp;
branches;
next	1.44;

1.44
date	2004.03.01.18.17.42;	author xsa;	state Exp;
branches;
next	1.43;

1.43
date	2004.02.26.07.28.55;	author beck;	state Exp;
branches;
next	1.42;

1.42
date	2004.01.21.01.55.10;	author deraadt;	state Exp;
branches;
next	1.41;

1.41
date	2003.10.23.08.33.22;	author jmc;	state Exp;
branches;
next	1.40;

1.40
date	2003.10.22.21.31.38;	author beck;	state Exp;
branches;
next	1.39;

1.39
date	2003.09.25.09.07.33;	author jmc;	state Exp;
branches;
next	1.38;

1.38
date	2003.09.24.01.14.48;	author deraadt;	state Exp;
branches;
next	1.37;

1.37
date	2003.09.03.21.22.19;	author tedu;	state Exp;
branches;
next	1.36;

1.36
date	2003.08.23.21.22.34;	author dhartmei;	state Exp;
branches;
next	1.35;

1.35
date	2003.06.02.14.27.12;	author jmc;	state Exp;
branches;
next	1.34;

1.34
date	2003.04.12.22.12.58;	author deraadt;	state Exp;
branches;
next	1.33;

1.33
date	2003.03.20.01.39.36;	author david;	state Exp;
branches;
next	1.32;

1.32
date	2003.03.18.13.05.24;	author david;	state Exp;
branches;
next	1.31;

1.31
date	2003.03.15.18.09.11;	author pvalchev;	state Exp;
branches;
next	1.30;

1.30
date	2003.03.13.13.31.10;	author henning;	state Exp;
branches;
next	1.29;

1.29
date	2003.03.11.07.58.34;	author david;	state Exp;
branches;
next	1.28;

1.28
date	2003.03.11.04.39.52;	author david;	state Exp;
branches;
next	1.27;

1.27
date	2003.03.09.21.12.06;	author pvalchev;	state Exp;
branches;
next	1.26;

1.26
date	2003.03.09.20.25.33;	author pvalchev;	state Exp;
branches;
next	1.25;

1.25
date	2003.03.09.19.22.25;	author beck;	state Exp;
branches;
next	1.24;

1.24
date	2003.03.08.22.03.53;	author beck;	state Exp;
branches;
next	1.23;

1.23
date	2003.03.08.21.36.12;	author jmc;	state Exp;
branches;
next	1.22;

1.22
date	2003.03.06.09.41.31;	author henning;	state Exp;
branches;
next	1.21;

1.21
date	2003.03.06.04.07.37;	author david;	state Exp;
branches;
next	1.20;

1.20
date	2003.03.06.03.27.53;	author david;	state Exp;
branches;
next	1.19;

1.19
date	2003.03.06.01.03.09;	author henning;	state Exp;
branches;
next	1.18;

1.18
date	2003.03.04.11.32.07;	author henning;	state Exp;
branches;
next	1.17;

1.17
date	2003.03.04.09.22.54;	author deraadt;	state Exp;
branches;
next	1.16;

1.16
date	2003.03.03.08.32.07;	author cedric;	state Exp;
branches;
next	1.15;

1.15
date	2003.03.02.22.38.56;	author deraadt;	state Exp;
branches;
next	1.14;

1.14
date	2003.03.02.20.54.39;	author deraadt;	state Exp;
branches;
next	1.13;

1.13
date	2003.03.02.20.32.05;	author deraadt;	state Exp;
branches;
next	1.12;

1.12
date	2003.03.02.19.22.00;	author beck;	state Exp;
branches;
next	1.11;

1.11
date	2003.02.26.15.05.07;	author david;	state Exp;
branches;
next	1.10;

1.10
date	2003.02.13.08.23.39;	author jmc;	state Exp;
branches;
next	1.9;

1.9
date	2003.02.10.12.01.51;	author dhartmei;	state Exp;
branches;
next	1.8;

1.8
date	2003.01.20.19.52.51;	author deraadt;	state Exp;
branches;
next	1.7;

1.7
date	2003.01.01.21.04.56;	author deraadt;	state Exp;
branches;
next	1.6;

1.6
date	2002.12.31.12.19.57;	author avsm;	state Exp;
branches;
next	1.5;

1.5
date	2002.12.31.01.01.28;	author dhartmei;	state Exp;
branches;
next	1.4;

1.4
date	2002.12.25.10.14.20;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	2002.12.23.01.34.36;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	2002.12.21.18.18.38;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	2002.12.21.01.41.54;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.134
log
@note that some hosts never generate tuples and are ignored;
ok beck
@
text
@.\"	$OpenBSD: spamd.8,v 1.133 2017/03/16 15:16:21 jmc Exp $
.\"
.\" Copyright (c) 2002 Theo de Raadt.  All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
.\" IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
.\" OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
.\" IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
.\" INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
.\" NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
.\" DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
.\" THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
.\" (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
.\" THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
.\"
.Dd $Mdocdate: March 16 2017 $
.Dt SPAMD 8
.Os
.Sh NAME
.Nm spamd
.Nd spam deferral daemon
.Sh SYNOPSIS
.Nm spamd
.Op Fl 45bdv
.Op Fl B Ar maxblack
.Op Fl C Ar file
.Op Fl c Ar maxcon
.Op Fl G Ar passtime : Ns Ar greyexp : Ns Ar whiteexp
.Op Fl h Ar hostname
.Op Fl K Ar file
.Op Fl l Ar address
.Op Fl M Ar address
.Op Fl n Ar name
.Op Fl p Ar port
.Op Fl S Ar secs
.Op Fl s Ar secs
.Op Fl w Ar window
.Op Fl Y Ar synctarget
.Op Fl y Ar synclisten
.Sh DESCRIPTION
.Nm
is a fake mail daemon which rejects false mail.
It is designed to be very efficient so that it does not slow down the
receiving machine.
.Pp
.Nm
considers sending hosts to be of three types:
.Pp
.Em blacklisted
hosts are diverted to
.Nm
and
.Em tarpitted
i.e. they are communicated with very slowly
to consume the sender's resources.
Mail is rejected with either a 450 or 550 error message.
A blacklisted host will not be allowed to talk to a real mail server.
.Pp
.Em whitelisted
hosts do not talk to
.Nm .
Their connections are instead sent to a real mail server,
such as
.Xr smtpd 8 .
.Pp
.Em greylisted
hosts are diverted to
.Nm ,
but
.Nm
has not yet decided if they are likely spammers.
They are given a temporary failure message by
.Nm
when they try to deliver mail.
.Pp
When
.Nm
is run in default mode,
it will greylist connections from new hosts.
Depending on its configuration,
it may choose to blacklist the host or,
if the checks described below are met,
eventually whitelist it.
When
.Nm
is run in blacklist-only mode,
using the
.Fl b
flag,
it will consult a pre-defined set of blacklist addresses
to decide whether to tarpit the host or not.
.Pp
When a sending host talks to
.Nm ,
the reply will be
.Em stuttered .
That is,
the response will be sent back a character at a time, slowly.
For blacklisted hosts,
the entire dialogue is stuttered.
For greylisted hosts,
the default is to stutter for the first 10 seconds
of dialogue only.
.Pp
The options are as follows:
.Bl -tag -width Ds
.It Fl 4
For blacklisted entries, return error code 450 to the spammer (default).
.It Fl 5
For blacklisted entries, return error code 550 to the spammer.
.It Fl B Ar maxblack
The maximum number of concurrent blacklisted connections to stutter at.
This value may not be greater than maxcon (see below).
The default is
.Ar maxcon
\- 100.
When this value is exceeded, new blacklisted connections will not be
stuttered at.
.It Fl b
Run in blacklist-only mode.
.It Fl C Ar file
Load the certificate for TLS from the given
.Ar file .
.It Fl c Ar maxcon
The maximum number of concurrent connections to allow.
.Ar maxcon
may not exceed
.Va kern.maxfiles
\- 200, and defaults to 800.
.It Fl d
Debug mode.
.Nm
does not
.Xr fork 2
into the background.
.It Xo
.Fl G
.Ar passtime : Ns Ar greyexp : Ns Ar whiteexp
.Xc
Adjust the three time parameters for greylisting.
.Ar passtime
defaults to 25 (minutes),
.Ar greyexp
to 4 (hours),
and
.Ar whiteexp
to 864 (hours, approximately 36 days).
.It Fl h Ar hostname
The hostname that is reported in the SMTP banner.
.It Fl K Ar file
Load the private key for TLS from the given
.Ar file .
.It Fl l Ar address
Specify the local address to which
.Nm
is to
.Xr bind 2 .
By default
.Nm
listens on the localhost address 127.0.0.1.
.It Fl M Ar address
Specify a local IP address which is listed as a low priority MX record,
used to identify and trap hosts that connect to MX hosts out of order.
See
.Sx GREYTRAPPING
below for details.
.It Fl n Ar name
The SMTP version banner that is reported upon initial connection.
.It Fl p Ar port
Specify a different port number from the default port that
.Nm
should listen for diverted SMTP connections on.
The default port is found by looking for the named service
.Dq spamd
using
.Xr getservbyname 3 .
.It Fl S Ar secs
Stutter at greylisted connections for the specified amount
of seconds, after which the connection is not stuttered at.
The default is 10; maximum is 90.
.It Fl s Ar secs
Delay each character sent to the client by the specified
amount of seconds.
The default is 1; maximum is 10.
.It Fl v
Enable verbose logging.
By default
.Nm
logs connections, disconnections and blacklist matches to
.Xr syslogd 8
at
.Dv LOG_INFO
level.
With verbose logging enabled, message detail
including subject and recipient information is logged at
.Dv LOG_INFO ,
along with the message body and SMTP dialogue being logged at
.Dv LOG_DEBUG
level.
.It Fl w Ar window
Set the socket receive buffer to this many bytes, adjusting the window size.
.It Fl Y Ar synctarget
Add target
.Ar synctarget
to receive synchronisation messages.
.Ar synctarget
can be either an IPv4 address for unicast messages
or a network interface and optional TTL value for multicast messages
to the group 224.0.1.240.
If the multicast TTL is not specified, a default value of 1 is used.
This option can be specified multiple times.
See also
.Sx SYNCHRONISATION
below.
.It Fl y Ar synclisten
Listen on
.Ar synclisten
network interface for incoming synchronisation messages.
This option can be specified only once.
See also
.Sx SYNCHRONISATION
below.
.El
.Pp
When run in default mode,
connections receive the pleasantly innocuous temporary failure of:
.Bd -literal -offset 4n
451 Temporary failure, please try again later.
.Ed
.Pp
This happens in the SMTP dialogue
immediately after the DATA command is received from the client.
.Nm
will use the db file in
.Pa /var/db/spamd
to track these connections to
.Nm
by connecting IP address, HELO/EHLO, envelope-from, and envelope-to, or
.Em tuple
for short.
Hosts which connect but do not attempt to deliver mail
will not generate a tuple and always be ignored.
.Pp
A previously unseen tuple is added to the
.Pa /var/db/spamd
database, recording the time an initial connection attempt was seen.
After
.Em passtime
minutes if
.Nm
sees a retried attempt to deliver mail for the same tuple,
.Nm
will whitelist the connecting address by adding it as a
whitelist entry to
.Pa /var/db/spamd .
.Pp
.Nm
regularly scans the
.Pa /var/db/spamd
database and configures all whitelist addresses as the
.Xr pf 4
<spamd-white>
table,
allowing connections to pass to the real MTA.
Any addresses not found in
<spamd-white>
are diverted to
.Nm .
.Pp
An example
.Xr pf.conf 5
fragment is given below.
In the example, the file
.Pa /etc/mail/nospamd
contains addresses of hosts who should be passed directly
to the SMTP agent (thus bypassing
.Nm ) .
.Bd -literal -offset 4n
table <spamd-white> persist
table <nospamd> persist file "/etc/mail/nospamd"
pass in on egress proto tcp to any port smtp \e
    divert-to 127.0.0.1 port spamd
pass in on egress proto tcp from <nospamd> to any port smtp
pass in log on egress proto tcp from <spamd-white> to any port smtp
pass out log on egress proto tcp to any port smtp
.Ed
.Pp
.Nm
removes tuple entries from the
.Pa /var/db/spamd
database if delivery has not been retried within
.Em greyexp
hours from the initial time a connection is seen.
The default is 4 hours as this is the most common setting after which
MTAs will give up attempting to retry delivery of a message.
.Pp
.Nm
removes whitelist entries from the
.Pa /var/db/spamd
database if no mail delivery activity has been seen from the
whitelisted address by
.Xr spamlogd 8
within
.Em whiteexp
hours from the initial time an address
is whitelisted.
The default is 36 days to allow for the delivery of
monthly mailing list digests without greylist delays every time.
.Pp
.Xr spamd-setup 8
should be run periodically by
.Xr cron 8
to update the blacklists configured in
.Xr spamd.conf 5 .
Use
.Xr crontab 1
to uncomment the entry in root's crontab.
When run in blacklist-only mode,
the
.Fl b
flag should be specified.
.Pp
.Xr spamlogd 8
should be used to update the whitelist entries in
.Pa /var/db/spamd
when connections are seen to pass to the real MTA on the
.Em smtp
port.
.Pp
.Xr spamdb 8
can be used to examine and alter the contents of
.Pa /var/db/spamd .
See
.Xr spamdb 8
for further information.
.Pp
.Nm
sends log messages to
.Xr syslogd 8
using
.Em facility
daemon and, with increasing verbosity,
.Em level
err, warn, info, and debug.
The following
.Xr syslog.conf 5
section can be used to log connection details to a dedicated file:
.Bd -literal -offset indent
!spamd
daemon.info	/var/log/spamd
.Ed
.Pp
A typical entry shows the time of the connection and
the IP address of the connecting host.
When a host connects,
the total number of active connections and
the number of connections from blacklisted hosts is shown
.Pq connected (xx/xx) .
When a host disconnects,
the amount of time spent talking to
.Nm
is shown.
.Sh GREYTRAPPING
When running
.Nm
in default mode,
it may be useful to define
.Em spamtrap
destination addresses to catch spammers as they send mail from greylisted
hosts.
Such spamtrap addresses affect only greylisted connections to
.Nm
and are used to temporarily blacklist a host that is obviously sending spam.
Unused email addresses or email addresses on spammers' lists are very
useful for this.
When a host that is currently greylisted attempts to send mail to a
spamtrap address,
it is blacklisted for 24 hours by adding the host to the
.Nm
blacklist
<spamd-greytrap>.
Spamtrap addresses are added to the
.Pa /var/db/spamd
database with the following
.Xr spamdb 8
command:
.Pp
.Dl # spamdb -T -a 'spamtrap@@mydomain.org'
.Pp
See
.Xr spamdb 8
for further details.
.Pp
The file
.Pa /etc/mail/spamd.alloweddomains
can be used to specify a list of domainname suffixes, one per line, one of
which must match each destination email address in the greylist.
Any destination address which does not match one of the suffixes listed in
.Pa spamd.alloweddomains
will be trapped, exactly as if it were sent to a spamtrap address.
Comment lines beginning with
.Sq #
and empty lines are ignored.
.Pp
For example, if
.Pa spamd.alloweddomains
contains:
.Bd -literal -offset indent
@@humpingforjesus.com
obtuse.com
.Ed
.Pp
The following destination addresses
.Em would not
cause the sending host to be trapped:
.Bd -literal -offset indent
beardedclams@@humpingforjesus.com
beck@@obtuse.com
beck@@snouts.obtuse.com
.Ed
.Pp
However the following addresses
.Em would
cause the sending host to be trapped:
.Bd -literal -offset indent
peter@@apostles.humpingforjesus.com
bigbutts@@bofh.ucs.ualberta.ca
.Ed
.Pp
A low priority MX IP address may be specified with the
.Fl M
option.
When
.Nm
has such an address specified, no host may enter new greylist
tuples when connecting to this address; only existing entries
may be updated.
Any host attempting to make new deliveries to
the low priority MX for which a tuple has not previously
been seen will be trapped.
.Pp
Note that it is important to ensure that a host running
.Nm
with the low priority MX address active must see all the greylist
changes for a higher priority MX host for the same domains.
This is best done by the host itself receiving the connections to
the higher priority MX on another IP address (which may be an IP alias).
This will ensure that hosts are not trapped erroneously if the higher
priority MX is unavailable.
For example, on a host which is an existing MX record for a domain of
value 10, a second IP address with MX of value 99 (a higher number, and
therefore lower priority) would ensure that any RFC conformant client
would attempt delivery to the IP address with the MX value of 10
first, and should not attempt to deliver to the address with MX value 99.
.Sh BLACKLIST-ONLY MODE
When running in default mode, the
.Xr pf.conf 5
rules described above are sufficient.
However when running in blacklist-only mode,
a slightly modified
.Xr pf.conf 5
ruleset is required,
diverting any addresses found in the <spamd> table to
.Nm .
Any other addresses
are passed to the real MTA.
.Bd -literal -offset 4n
table <spamd> persist
pass in on egress inet proto tcp from <spamd> to any port smtp \e
    divert-to 127.0.0.1 port spamd
.Ed
.Pp
Addresses can be loaded into the
.Em table ,
like:
.Bd -literal -offset 4n
# pfctl -q -t spamd -T replace -f /usr/local/share/spammers
.Ed
.Pp
.Xr spamd-setup 8
can also be used to load addresses into the <spamd> table.
It has the added benefit of being able to remove addresses from
blacklists, and will connect to
.Nm
over a localhost socket, giving
.Nm
information about each source of blacklist addresses, as well as custom
rejection messages for each blacklist source
that can be used to let any real person whose mail
is deferred by
.Nm
know why their address has been listed
from sending mail.
This is important as it allows legitimate mail
senders to pressure spam sources into behaving properly so that they
may be removed from the relevant blacklists.
.Sh CONFIGURATION CONNECTIONS
.Nm
listens for configuration connections on the port identified by the
named service
.Dq spamd-cfg
(see
.Xr services 5 ) .
The configuration socket listens only on the INADDR_LOOPBACK
address.
Configuration of spamd is done by connecting to the configuration
socket, and sending blacklist information, one blacklist per line.
Each blacklist consists of a name, a message to reject mail
with, and addresses in CIDR format, all separated by semicolons (;):
.Bd -literal -offset indent
tag;"rejection message";aaa.bbb.ccc.ddd/mm;aaa.bbb.ccc.ddd/mm
.Ed
.Pp
The rejection message must be inside double quotes.
A \e" will produce a double quote in the output.
\en will produce a newline.
%A will expand to the connecting IP address in dotted quad format.
%% may be used to produce a single % in the output.
\e\e will produce a single \e.
.Nm
will reject mail by displaying all the messages from all blacklists in which
a connecting address is matched.
.Xr spamd-setup 8
is normally used to configure this information.
.Sh SYNCHRONISATION
.Nm
supports realtime synchronisation of spamd databases between
a number of spamd
daemons running on multiple machines,
using the
.Fl Y
and
.Fl y
options.
The databases are synchronised for greylisted and trapped entries;
whitelisted entries and entries made manually using
.Xr spamdb 8
are not updated.
.Pp
The following example will accept incoming multicast and unicast
synchronisation messages, and send outgoing multicast messages through
the network interface
.Ar em0 :
.Bd -literal -offset indent
# /usr/libexec/spamd -y em0 -Y em0
.Ed
.Pp
The second example will increase the multicast TTL to a value of 2,
add the unicast targets
.Ar foo.somewhere.org
and
.Ar bar.somewhere.org ,
and accept incoming unicast messages received on
.Ar bge0
only.
.Bd -literal -offset indent
# /usr/libexec/spamd -y bge0 -Y em0:2 \e
	-Y foo.somewhere.org -Y bar.somewhere.org
.Ed
.Pp
If the file
.Pa /etc/mail/spamd.key
exists,
.Nm
will calculate the message-digest fingerprint (checksum) for the file
and use it as a shared key to authenticate the synchronisation messages.
The file itself can contain any data.
For example, to create a secure random key:
.Bd -literal -offset indent
# dd if=/dev/random of=/etc/mail/spamd.key bs=2048 count=1
.Ed
.Pp
The file needs to be copied to all hosts
sending or receiving synchronisation messages.
.Sh FILES
.Bl -tag -width "/etc/mail/spamd.alloweddomainsXX" -compact
.It Pa /etc/mail/spamd.alloweddomains
Required suffixes for greytrapping.
.It Pa /etc/mail/spamd.conf
Default configuration file.
.It Pa /etc/mail/spamd.key
Authentication key for synchronisation messages.
.It Pa /var/db/spamd
Greylisting database.
.El
.Sh SEE ALSO
.Xr pf.conf 5 ,
.Xr services 5 ,
.Xr spamd.conf 5 ,
.Xr syslog.conf 5 ,
.Xr pfctl 8 ,
.Xr spamd-setup 8 ,
.Xr spamdb 8 ,
.Xr spamlogd 8 ,
.Xr syslogd 8
.Sh HISTORY
The
.Nm
command first appeared in
.Ox 3.3 .
.Sh BUGS
.Nm
currently uses the user
.Dq _spamd
outside a chroot jail when running in default mode, and requires
the greylisting database in
.Pa /var/db/spamd
to be owned by the
.Dq _spamd
user.
This is wrong and should change to a distinct user from the
one used by the chrooted
.Nm
process.
@


1.133
log
@define the role of spamd-setup a little better;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.132 2017/03/16 15:07:45 jmc Exp $
d250 2
@


1.132
log
@use one way to show filter rules, not two. the bits and pieces of the
spamd setup are complex enough without freestyling the pf rules;

while here, Bk/Ek no longer required
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.131 2015/08/12 14:41:37 jmc Exp $
d25 1
a25 1
.Dd $Mdocdate: August 12 2015 $
d319 6
a324 1
.Xr cron 8 .
a328 3
Use
.Xr crontab 1
to uncomment the entry in root's crontab.
@


1.131
log
@start replacing some \*([GL]t;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.130 2015/08/12 14:36:47 jmc Exp $
a32 1
.Bk -words
a48 1
.Ek
d288 1
a288 1
pass in on egress proto tcp from any to any port smtp \e
@


1.130
log
@divert-to a table needs an address family;
from steve shockley

ok sthen
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.129 2015/07/27 17:28:38 sobrado Exp $
d25 1
a25 1
.Dd $Mdocdate: July 27 2015 $
d288 2
a289 2
table \*(Ltspamd-white\*(Gt persist
table \*(Ltnospamd\*(Gt persist file "/etc/mail/nospamd"
d292 2
a293 2
pass in on egress proto tcp from \*(Ltnospamd\*(Gt to any port smtp
pass in log on egress proto tcp from \*(Ltspamd-white\*(Gt to any port smtp
d470 1
a470 3
diverting any addresses found in the
<spamd>
table to
d475 2
a476 2
table \*(Ltspamd\*(Gt persist
pass in on egress inet proto tcp from \*(Ltspamd\*(Gt to any port smtp \e
d488 1
a488 3
can also be used to load addresses into the
<spamd>
table.
@


1.129
log
@use file system path (.Pa) semantic markup macros where appropriate.

ok jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.128 2015/05/18 16:04:21 reyk Exp $
d25 1
a25 1
.Dd $Mdocdate: May 18 2015 $
d478 1
a478 1
pass in on egress proto tcp from \*(Ltspamd\*(Gt to any port smtp \e
@


1.128
log
@Change spamd to use divert-to instead of rdr-to.

divert-to has many advantages over rdr-to for proxies.  For example,
it is much easier to use, requires less code, does not depend on
/dev/pf, works in-band without the asynchronous lookup (DIOCNATLOOK
ioctl), saves us from additional port allocations by the rdr/NAT code,
and even avoids potential collisions and race conditions that could
theoretically happen with the lookup.

Heads up: users will have to update their spamd PF rules from rdr-to
to divert-to.  spamd now also listens to 127.0.0.1 instead of "any"
(0.0.0.0) by default which should be fine with most setups but has to
be considered for some special configurations.

Based on a diff is almost two years old but got delayed several times
... beck@@: "now is the time to get it in" :)

Tested by many
With help from okan@@
OK okan@@ beck@@ millert@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.127 2015/04/14 17:29:06 deraadt Exp $
d25 1
a25 1
.Dd $Mdocdate: April 14 2015 $
d588 1
a588 1
.It /etc/mail/spamd.alloweddomains
d590 1
a590 1
.It /etc/mail/spamd.conf
d592 1
a592 1
.It /etc/mail/spamd.key
d594 1
a594 1
.It /var/db/spamd
@


1.127
log
@wrap a long line
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.126 2015/02/15 22:27:51 bentley Exp $
d25 1
a25 1
.Dd $Mdocdate: February 15 2015 $
d61 1
a61 1
hosts are redirected to
d78 1
a78 1
hosts are redirected to
d171 1
a171 1
listens on all local addresses.
d183 1
a183 1
should listen for redirected SMTP connections on.
d276 1
a276 1
are redirected to
d291 1
a291 1
    rdr-to 127.0.0.1 port spamd
d470 1
a470 1
redirecting any addresses found in the
d479 1
a479 1
    rdr-to 127.0.0.1 port spamd
@


1.126
log
@Don't use Aq macros when <> is intended; they are not the same thing.

ok schwarze@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.125 2015/02/07 18:05:57 jmc Exp $
d25 1
a25 1
.Dd $Mdocdate: February 7 2015 $
d128 2
a129 2
When this value is exceeded new blacklisted connections will not be stuttered
at.
@


1.125
log
@put -G and it's args back onto one line in SYNOPSIS, to avoid having mandoc
split it; while here, zap trailing whitespace;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.124 2015/02/07 10:45:19 henning Exp $
d271 1
a271 1
.Aq spamd-white
d275 1
a275 1
.Aq spamd-white
d388 1
a388 1
.Aq spamd-greytrap .
d471 1
a471 1
.Aq spamd
d491 1
a491 1
.Aq spamd
@


1.124
log
@add STARTTLS support, using the shiny libtls.
Rationale: when you publish DANE records for certificate pinning, you MUST
offer TLS on the indicated service. Not offering TLS is verboten since
that would re-open the door for a MitM. This is obviously fundamentally
incompatible with having spamd in front of your mailservers - spamd kinda
is a MitM here, but intentional and utterly valid.
DANE is desirable because it allows one to not have to trust the broken
SSL CA model, and, depending on the mode chosen, even show the SSL cert
mafia the middle finger by not needing them at all.
ok reyk jsing bob
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.122 2014/10/11 20:06:31 landry Exp $
d25 1
a25 1
.Dd $Mdocdate: November 22 2014 $
d38 1
a38 4
.Oo
.Fl G
.Ar passtime : Ns Ar greyexp : Ns Ar whiteexp
.Oc
d133 1
a133 1
Load the certificate for TLS from the given 
d162 1
a162 1
Load the private key for TLS from the given 
@


1.123
log
@/dev/random has created the same effect as /dev/arandom (and /dev/urandom)
for quite some time.  Mop up the last few, by using /dev/random where we
actually want it, or not even mentioning arandom where it is irrelevant.
@
text
@d25 1
a25 1
.Dd $Mdocdate: October 11 2014 $
d36 1
d43 1
d135 3
d164 3
@


1.122
log
@Fix manpage: -y only takes interface names, and doesnt take ip addresses.
Fix example while here.
ok back@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.121 2014/09/16 21:16:57 jmc Exp $
d25 1
a25 1
.Dd $Mdocdate: September 16 2014 $
d576 1
a576 1
# dd if=/dev/arandom of=/etc/mail/spamd.key bs=2048 count=1
@


1.121
log
@less sendmail;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.120 2014/09/01 02:48:00 guenther Exp $
d25 1
a25 1
.Dd $Mdocdate: September 1 2014 $
d224 1
a224 6
for incoming synchronisation messages.
The format for
.Ar synclisten
is the same as for
.Ar synctarget ,
above.
d559 2
a560 2
and accept incoming unicast messages sent to
.Ar example.somewhere.org
d563 1
a563 1
# /usr/libexec/spamd -y example.somewhere.org -Y em0:2 \e
@


1.120
log
@Simplify the syslog.conf example: .info means that *and higher*

ok beck@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.119 2012/09/27 20:12:32 jmc Exp $
d25 1
a25 1
.Dd $Mdocdate: September 27 2012 $
d54 1
a54 3
is a fake
.Xr sendmail 8 Ns -like
daemon which rejects false mail.
d76 1
a76 1
.Xr sendmail 8 .
@


1.119
log
@remove some history details which have been around for long enough
to no longer be relevant;

ok beck
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.118 2011/03/19 23:29:45 okan Exp $
d25 1
a25 1
.Dd $Mdocdate: March 19 2011 $
d359 1
a359 1
daemon.err;daemon.warn;daemon.info	/var/log/spamd
@


1.118
log
@fix rdr-to example (requires direction); from James Turner

ok jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.117 2009/09/17 06:37:54 jmc Exp $
d25 1
a25 1
.Dd $Mdocdate: September 17 2009 $
a613 11
.Pp
Previous versions of
.Nm
required traps to be entered into the database including the enclosing
\*(Lt\*(Gt characters;
current versions expect only the email address without the enclosing
\*(Lt\*(Gt characters.
.Pp
Blacklisted hosts are no longer stored in the
.Aq spamd
table when operating in default mode for performance reasons.
@


1.117
log
@merge/update the spamlogd rules into spamd - there were some subtle
problems because of the recent pf nat changes that caused problems;
i've fleshed out the example in spamd and just added a pointer to it
from spamlogd;

ok beck
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.116 2009/09/07 09:43:57 jmc Exp $
d25 1
a25 1
.Dd $Mdocdate: September 7 2009 $
d480 2
a481 2
pass on egress proto tcp from \*(Ltspamd\*(Gt to any \e
    port smtp rdr-to 127.0.0.1 port spamd
@


1.116
log
@the example pf rules should be "pass in", not just "pass"; ok henning
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.115 2009/09/01 14:46:43 todd Exp $
d25 1
a25 1
.Dd $Mdocdate: September 1 2009 $
d280 2
a281 1
The following
d283 6
a288 1
example is suggested:
d291 1
a291 1
table \*(Ltnospamd\*(Gt persist
d295 2
a296 1
pass in on egress proto tcp from \*(Ltspamd-white\*(Gt to any port smtp
@


1.115
log
@match samples here with pf.conf(5) sample ruleset following recent pf changes
ok henning@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.114 2009/04/20 21:08:27 jmc Exp $
d25 1
a25 1
.Dd $Mdocdate: April 20 2009 $
d286 1
a286 1
pass on egress proto tcp from any to any port smtp \e
d288 2
a289 2
pass on egress proto tcp from \*(Ltnospamd\*(Gt to any port smtp
pass on egress proto tcp from \*(Ltspamd-white\*(Gt to any port smtp
@


1.114
log
@tweak previous;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.113 2009/04/20 17:42:21 beck Exp $
d285 5
a289 2
rdr pass inet proto tcp from !\*(Ltspamd-white\*(Gt to any \e
    port smtp -\*(Gt 127.0.0.1 port spamd
d473 2
a474 2
rdr pass inet proto tcp from \*(Ltspamd\*(Gt to any \e
    port smtp -\*(Gt 127.0.0.1 port spamd
@


1.113
log
@
PR 6090 - from Olli Hauer <ohauer@@gmx.de>

A number of small improvements:

- patch for empty lines and comments in alloweddomains_file
- remove some whitespaces at end of line.
- document comment and empty line handling
- Remove unused parameter 'r' from getopt in spamd.c, it is removed in the 'switch statement'
  but not in getopt.
  http://www.openbsd.org/cgi-bin/cvsweb/src/libexec/spamd/spamd.c.diff?r1=1.94;r2=1.95;f=h
- replace atoi with strtonum
- make debug output more usefull, display only what will be synced and not a second
  message which prints always "sync trapped %s"

- some cosemtic and whitespace fixes.
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.112 2009/02/17 22:07:11 jmc Exp $
d25 1
a25 1
.Dd $Mdocdate: February 17 2009 $
d401 1
a401 1
.Ar #
a402 1

@


1.112
log
@clarification for the MX stuff; requested by Stephan A. Rickauer
ok beck
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.111 2008/09/20 20:38:23 jmc Exp $
d25 1
a25 1
.Dd $Mdocdate: September 20 2008 $
d400 4
@


1.111
log
@document spamd log entry format; requested by Stephan A. Rickauer
ok beck
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.110 2008/08/11 20:28:55 jmc Exp $
d25 1
a25 1
.Dd $Mdocdate: August 11 2008 $
d441 2
a442 2
changes for a higher priority MX host for the same domains, either by
being synchronised with it, or by receiving the connections itself to
@


1.110
log
@some documentation updates for spamd synchronisation:
- whitelisted entries are not synced
- entries added manually (using spamdb) are not synced

suggested by Stephan A. Rickauer; ok reyk
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.109 2008/03/28 18:21:55 grunk Exp $
d25 1
a25 1
.Dd $Mdocdate: March 28 2008 $
d351 11
@


1.109
log
@typo, ok beck@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.108 2008/01/08 22:54:25 jmc Exp $
d25 1
a25 1
.Dd $Mdocdate: January 8 2008 $
d516 2
a517 3
supports realtime synchronisation of greylisting states between
a number of
.Nm
d524 4
@


1.108
log
@simplify the suggested pf ruleset; ok beck
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.107 2007/08/11 06:09:02 jmc Exp $
d25 1
a25 1
.Dd $Mdocdate: August 11 2007 $
d107 1
a107 1
When a sending hosts talks to
@


1.107
log
@tweak previous:
- this document talks about "default mode", not "greylisting mode"
- kill trailing whitespace
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.106 2007/08/11 02:48:32 jsg Exp $
d25 1
a25 1
.Dd $Mdocdate: July 7 2007 $
d285 1
a285 3
no rdr inet proto tcp from \*(Ltspamd-white\*(Gt to any \e
    port smtp
rdr pass inet proto tcp from any to any \e
@


1.106
log
@Add note to the effect that the spamd pf table is no
longer used in greylisting mode.
ok ckuethe@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.105 2007/07/07 06:54:09 jmc Exp $
d597 1
a597 1
Blacklisted hosts are no longer stored in the 
d599 1
a599 1
table when operating in greylisting mode for performance reasons.
@


1.105
log
@document maximum values for -S and -s;
from Saint Aardvark the Carpeted, documentation/5535;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.104 2007/06/25 12:28:34 tom Exp $
d25 1
a25 1
.Dd $Mdocdate: May 31 2007 $
d596 4
@


1.104
log
@s/is is/it is/.  From Jim Razmus, jim (at) bonetruck (dot) org; thanks.
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.103 2007/05/31 19:19:40 jmc Exp $
d188 1
a188 1
Defaults to 10.
d192 1
a192 1
Defaults to 1.
@


1.103
log
@convert to new .Dd format;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.102 2007/05/26 23:35:36 jmc Exp $
d25 1
a25 1
.Dd $Mdocdate$
d429 1
a429 1
Note that is is important to ensure that a host running
@


1.102
log
@remove a redundant paragraph; ok beck
also, this section is blacklist-only, so tweak .Sh
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.101 2007/05/19 21:44:21 jmc Exp $
d25 1
a25 1
.Dd December 18, 2002
@


1.101
log
@spamd-setup needs -b for blacklist-only mode; from Nick Templeton
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.100 2007/03/26 19:08:09 jmc Exp $
d442 1
a442 8
.Sh BLACKLISTING
The normal way that spam has been dealt with in the past is to either
accept and drop, or outright block.
When configured to use 450 responses,
.Nm
takes neither of these actions: it rejects the mail back to the senders'
queue.
.Pp
@


1.100
log
@kill trailing whitespace...shame on me if i sent bob a diff w/
whitespace at eol
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.99 2007/03/26 15:20:43 beck Exp $
d316 4
@


1.99
log
@
A couple of spamd improvements

1) Implement the NOOP command, which now seems necessary for certain
windows mail wrappers and sender verification schemes. Tested by me
and sidcarter@@symonds.net, who noticed the problem on his site.
ok millert@@

2) Change the behaviour of the maxblack parameter, instead of hanging
up immediately on new blacklisted connections when the maxblack parameter
is reached, we instead make spamd not stutter at them, so the connection
is instead completed quickly. This seems to handle peaks and spikes
much better than the old way of doing this.
ok deraadt@@, with some man page changes by jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.98 2007/03/15 21:56:25 jmc Exp $
d107 1
a107 1
When a sending hosts talks to  
@


1.98
log
@fix -y example;

closes user/5408 from sthen
ok reyk
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.97 2007/03/07 21:35:25 millert Exp $
d107 12
d126 1
a126 1
The maximum number of concurrent blacklisted connections to allow.
d131 2
@


1.97
log
@Add some emphasis for easier reading and clarify MX trapping by
explicitly mentioning IP aliases, which is typically how you would
implement MX trapping using a single host.
OK beck@@, trusted by deraadt@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.96 2007/03/07 09:10:10 jmc Exp $
d530 2
a531 2
and accept incoming unicast messages from
.Ar foo.somewhere.org
d534 1
a534 1
# /usr/libexec/spamd -y foo.somewhere.org -Y em0:2 \e
@


1.96
log
@clean up the greytrap stuff;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.95 2007/03/07 08:46:23 jmc Exp $
d383 2
a384 1
would not cause the sending host to be trapped:
d392 2
a393 1
would cause the sending host to be trapped:
d416 1
a416 1
the higher priority MX on another IP address.
@


1.95
log
@some spelling fixes;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.94 2007/03/07 08:26:52 jmc Exp $
d156 2
a157 3
Specify a local address which is listed as a low priority
MX record, used to identify and trap hosts that connect to MX
hosts out of order.
d343 1
a343 3
Such
.Em spamtrap
addresses affect only greylisted connections to
d349 2
a350 2
.Em spamtrap
address, it is blacklisted for 24 hours by adding the host to the
d371 2
a372 4
.Pa /etc/mail/spamd.alloweddomains
will be trapped, exactly as if it were sent to a
.Em spamtrap
address above.
d375 1
a375 1
.Pa /etc/mail/spamd.alloweddomains
d377 1
a377 1
.Bd -literal -offset 4n
d382 14
a395 11
the destination addresses
.Em beardedclams@@humpingforjesus.com ,
.Em beck@@obtuse.com ,
and
.Em beck@@snouts.obtuse.com
would not cause the sending host to be trapped.
However the addresses
.Em peter@@apostles.humpingforjesus.com
or
.Em bigbutts@@bofh.ucs.ualberta.ca
would cause the sending host to be trapped.
d403 1
a403 1
tuples when connecting to this address, only existing entries
d411 1
a411 1
with the low priorty MX address active must see all the greylist
d553 1
a553 1
Optional required suffixes for greytrapping.
@


1.94
log
@new sentence, new line
kill whitespace at eol
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.93 2007/03/06 23:38:36 beck Exp $
d415 2
a416 2
being synchonised with it, or by receiving the connections itself to
the higher priority MX on another ip address.
d420 2
a421 2
value 10, A second IP address with MX of value 99 (a higher number, and
therfore lower priority) would ensure that any RFC conformant client
d423 1
a423 1
first, and should not attempt to deliver to the address with MV value 99.
@


1.93
log
@Add -M option to specify a local address that is a lower priority MX
address than the primary one. spamd will trap hosts that contact this
address first without first contacting the primary.
- get it in, deraadt@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.92 2007/03/06 09:00:13 jmc Exp $
d158 4
a161 1
hosts out of order. See GREYTRAPPING below for details.
d399 3
a401 1
A low priority MX ip address may be specified with the -M option. 
d406 2
a407 1
may be updated. Any host attempting to make new deliveries to
d409 1
a409 1
been seen will be trapped. 
d423 1
a423 1
first, and should not attempt to deliver to the address with MV value 99. 
@


1.92
log
@tweak -c; sort FILES;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.91 2007/03/06 08:56:32 jmc Exp $
d43 1
d155 4
d395 23
@


1.91
log
@- move LOGGING into the main body
- move some relevant bits of SYNCHRONISATION into -Yy descriptions
- tweaks for SYNCHRONISATION

ok reyk beck
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.90 2007/03/06 02:00:25 beck Exp $
d123 3
a125 1
may not exceed kern.maxfiles - 200, and defaults to 800.
d520 2
a525 2
.It /etc/mail/spamd.alloweddomains
Optional required suffixes for greytrapping.
@


1.90
log
@document allowing -c to increase to within 200 of kern.maxfiles
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.89 2007/03/05 21:25:29 beck Exp $
d188 10
a197 1
Add a target to receive synchronisation messages; see
a199 1
This option can be specified multiple times.
d201 10
a210 2
Listen for incoming synchronisation messages on the specified address
or interface; see
a212 1
This option can be specified only once.
d310 16
a468 16
.Sh LOGGING
.Nm
sends log messages to
.Xr syslogd 8
using
.Em facility
daemon and, with increasing verbosity,
.Em level
err, warn, info and debug.
The following
.Xr syslog.conf 5
section can be used to log connection details to a dedicated file:
.Bd -literal -offset indent
!spamd
daemon.err;daemon.warn;daemon.info	/var/log/spamd
.Ed
d474 3
a476 3
daemons running on multiple machines.
To enable synchronisation, use the command line options
.Fl y
a477 3
.Fl Y .
.Pp
If the
d479 1
a479 13
option is specified,
.Nm
will listen for incoming synchronisation messages to synchronize
the local
.Pa /var/db/spamd
database.
The
.Fl Y
option will add a target for outgoing messages.
A target can be either an IPv4 address for unicast messages or a
network interface and optional TTL value for multicast messages
to the group 224.0.1.240.
If the multicast TTL is not specified, a default value of 1 is used.
d508 2
a509 2
The file can contain any data.
For example, create a secure random key:
d514 2
a515 1
The file needs to be copied to all synchronised hosts.
@


1.89
log
@remove -r option that didn't work anyway.
ok jmc@@, reyk@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.88 2007/03/05 16:59:54 reyk Exp $
d123 1
a123 1
may not exceed 800 (the default).
@


1.88
log
@better dd options for the spamd.key generation example.
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.87 2007/03/05 16:57:25 reyk Exp $
a44 1
.Op Fl r Ar reply
a161 4
.It Fl r Ar reply
For blacklisted entries, the SMTP error to return to the spammer,
e.g. 450, 451, 550.
This defaults to 450.
@


1.87
log
@document spamd.key better. what format does the file take? how do i
create one? and so on...

help from jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.86 2007/03/04 06:44:45 joel Exp $
d516 1
a516 1
# dd if=/dev/arandom of=/etc/mail/spamd.key count=4
@


1.86
log
@correct location of spamd.key
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.85 2007/03/04 03:19:41 beck Exp $
d513 7
@


1.85
log
@
Database synchronizaton for spamd/spamlogd

This adds an HMAC protected synchronization protocol for use by spamd and
spamlogd.

- spamd can receive updates from other hosts for GREY, WHITE, and TRAPPED db
entries, and will update the local /var/db/spamd accordingly.

- spamd can send updates when it makes changes to the GREY or TRAPPED
entries in the db to other hosts running spamd. (Note it does not send
WHITE entries because the other spamd will see the GREY changes and have
complete information to make appropritate decisions)

- spamlogd can send updates for WHITE db entries that it performs on the local
db to other hosts running spamd, which will then apply them on remote hosts.

note that while this diff provides synchronization for changes made to the
spamd db by the daemons, it does *not* provide for sychonizing changes
to the spamd db made manually with the spamdb command.

Synchronization protocol and most of the work by reyk@@,
with a bunch of the spamd, and spamlogd stuff by me.

testing mostly at the U of A, running happily there under big load.

ok reyk@@ jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.84 2007/03/02 08:14:59 jmc Exp $
d508 1
a508 1
.Pa /etc/spamd.key
@


1.84
log
@improve the sections on pf rules; ok beck
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.83 2007/03/01 20:38:52 jmc Exp $
d49 2
d192 11
d459 54
d517 2
@


1.83
log
@first pass at simplifying the language in this page; more to come
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.82 2007/02/28 01:01:20 david Exp $
d226 1
d228 3
a230 3
.Xr pf 4
table.
The
d232 3
a234 4
table
.Em must
be used to allow connections to pass to the
real MTA as in the following
d236 1
a236 1
example:
a244 5
Connections from addresses not listed in the
.Aq spamd-white
table are redirected to
.Nm .
.Pp
d357 13
a369 11
With
.Xr pf 4 ,
connections to port 25 (SMTP) can be redirected to another host or port,
based on the source address of the sender.
The
.Em rdr
rules used for this purpose are described in
.Xr pf.conf 5 .
The rules can be loaded into a
.Em table
to simplify handling.
a375 4
Any addresses in table
.Aq spamd
are then redirected to
.Nm .
d387 1
a387 2
.Xr spamd-setup 8
also has the added benefit of being able to remove addresses from
@


1.82
log
@double word: be be
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.81 2007/02/27 19:56:47 jmc Exp $
a69 3
See
.Sx BLACKLISTING
below for more information.
d72 1
a72 3
hosts do
.Em NOT
talk to
a86 3
If they attempt to redeliver mail
after a predetermined amount of time has passed,
they will be whitelisted.
d88 1
a88 1
By default
d90 14
a103 2
runs in greylisting mode,
considering hosts for eventual whitelisting.
d112 1
a112 2
The maximum number of concurrent blacklisted connections to allow in
greylisting mode.
d118 1
a118 4
Turn off greylisting mode, and run only as a blacklister.
See
.Sx BLACKLISTING
below.
d133 1
a133 2
Adjust the three time parameters for greylisting;
see below.
d192 1
a192 1
When run in greylisting mode,
a248 4
Connections are considered for greylisting and
eventual whitelisting (by addition to the
.Aq spamd-white
table so they are not redirected in the future) if they retry mail delivery.
d293 1
a293 1
When greylisting with
d295 1
d489 1
a489 1
outside a chroot jail when running in greylisting mode, and requires
@


1.81
log
@prevent .Em abuse:
.Dq for services
.Aq for tables
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.80 2007/02/27 19:48:17 jmc Exp $
d485 1
a485 1
required traps to be be entered into the database including the enclosing
@


1.80
log
@forgot to remove this comment;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.79 2007/02/27 19:47:31 jmc Exp $
d159 1
a159 1
.Em spamd
d227 1
a227 1
.Em spamd-white
d231 1
a231 1
.Em spamd-white
d247 1
a247 2
.Em spamd-white
.Xr pf 4
d252 1
a252 1
.Em spamd-white
d316 1
a316 1
.Em spamd-greytrap .
d384 1
a384 1
.Em spamd
d396 1
a396 1
.Em spamd
d418 1
a418 1
.Em spamd-cfg
@


1.79
log
@- don;t mark up colons
- no need for <> for tables
- use escapes for <> where needed
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.78 2007/02/27 18:02:23 jmc Exp $
a54 4
.\"It If the
.\".Xr pf 4
.\"packet filter is configured to redirect port 25 (SMTP) to this daemon,
.\"it will attempt to waste the time and resources of the spam sender.
@


1.78
log
@no -g flag for spamd-setup;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.77 2007/02/27 17:51:10 jmc Exp $
d37 4
a40 1
.Op Fl G Ar passtime:greyexp:whiteexp
d133 4
a136 1
.It Fl G Ar passtime:greyexp:whiteexp
d243 2
a244 2
table <spamd-white> persist
no rdr inet proto tcp from <spamd-white> to any \e
d247 1
a247 1
    port smtp -> 127.0.0.1 port spamd
d383 3
a385 3
table <spamd> persist
rdr pass inet proto tcp from <spamd> to any \e
    port smtp -> 127.0.0.1 port spamd
d389 1
a389 1
.Em <spamd>
d401 1
a401 1
.Em <spamd>
@


1.77
log
@explain the concepts of black/white/greylisting, briefly;
diff from Okan Demirmen, tweaked by myself and beck

ok beck
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.76 2007/02/27 17:19:20 beck Exp $
d277 2
a278 3
should be run with the
.Fl g
flag.
@


1.76
log
@the tempfail message happens after the DATA command, and
has for a little while now - it got changed so people don't get
hooped by certain stupid sender verification schemes.
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.75 2007/02/27 15:38:27 jmc Exp $
a58 1
In its default mode of operation,
d60 1
a60 9
will initially
.Em greylist
a connection,
giving the connecting machine a temporary failure message
and requesting it try again later.
Any such machine retrying after a predefined amount of time
will be put in a
.Em whitelist ,
allowing it to bypass such checks in the future.
d62 2
d65 6
a70 7
can also run in
.Em blacklist
mode,
either in addition to or instead of greylisting mode.
In this mode,
spam is never accepted,
but always rejected with either a 450 or 550 error message.
d74 27
@


1.75
log
@initial shot at making greylisting seem normal...
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.74 2007/02/27 14:52:31 jmc Exp $
d179 1
a179 1
immediately after the recipient is specified.
@


1.74
log
@sort options and usage();
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.73 2007/02/27 02:10:58 beck Exp $
d52 30
a81 4
If the
.Xr pf 4
packet filter is configured to redirect port 25 (SMTP) to this daemon,
it will attempt to waste the time and resources of the spam sender.
d97 1
a97 1
Turn off Greylisting mode, and run only as a blacklister.
d99 1
a99 1
.Sx GREYLISTING
d112 2
a113 3
Adjust the three time parameters for greylisting; see
.Sx GREYLISTING
below.
a171 107
.Nm
is designed to be very efficient so that it does not slow down the
receiving machine.
Spam is never accepted, but always rejected with either a 450 or 550
error message.
The normal way that spam has been dealt with in the past is to either
accept and drop, or outright block.
When configured to use 450 responses,
.Nm
takes neither of these actions: it rejects the mail back to the senders'
queue.
.Pp
.Nm
can be enabled in
.Xr rc.conf.local 8 .
It should be used in conjunction with
.Xr spamd-setup 8 ,
which reads
.Xr spamd.conf 5 ,
processes a list of spammers' addresses, and applies appropriate
.Xr pf 4
.Em rdr
rules.
.Xr spamd-setup 8
should be run periodically via
.Xr cron 8 .
Use
.Xr crontab 1
to uncomment the entry in root's crontab.
.Sh REDIRECTING SMTP CONNECTIONS
With
.Xr pf 4 ,
connections to port 25 (SMTP) can be redirected to another host or port,
based on the source address of the sender.
The
.Em rdr
rules used for this purpose are described in
.Xr pf.conf 5 .
The rules can be loaded into a
.Em table
to simplify handling.
.Bd -literal -offset 4n
table <spamd> persist
rdr pass inet proto tcp from <spamd> to any \e
    port smtp -> 127.0.0.1 port spamd
.Ed
.Pp
Any addresses in table
.Em <spamd>
are then redirected to
.Nm .
Addresses can be loaded into the
.Em table ,
like:
.Bd -literal -offset 4n
# pfctl -q -t spamd -T replace -f /usr/local/share/spammers
.Ed
.Pp
.Xr spamd-setup 8
can also be used to load addresses into the
.Em <spamd>
table.
.Xr spamd-setup 8
also has the added benefit of being able to remove addresses from
blacklists, and will connect to
.Nm
over a localhost socket, giving
.Nm
information about each source of blacklist addresses, as well as custom
rejection messages for each blacklist source
that can be used to let any real person whose mail
is deferred by
.Nm
know why their address has been listed
from sending mail.
This is important as it allows legitimate mail
senders to pressure spam sources into behaving properly so that they
may be removed from the relevant blacklists.
.Sh CONFIGURATION CONNECTIONS
.Nm
listens for configuration connections on the port identified by the
named service
.Em spamd-cfg
(see
.Xr services 5 ) .
The configuration socket listens only on the INADDR_LOOPBACK
address.
Configuration of spamd is done by connecting to the configuration
socket, and sending blacklist information, one blacklist per line.
Each blacklist consists of a name, a message to reject mail
with, and addresses in CIDR format, all separated by semicolons (;):
.Bd -literal -offset indent
tag;"rejection message";aaa.bbb.ccc.ddd/mm;aaa.bbb.ccc.ddd/mm
.Ed
.Pp
The rejection message must be inside double quotes.
A \e" will produce a double quote in the output.
\en will produce a newline.
%A will expand to the connecting IP address in dotted quad format.
%% may be used to produce a single % in the output.
\e\e will produce a single \e.
.Nm
will reject mail by displaying all the messages from all blacklists in which
a connecting address is matched.
.Xr spamd-setup 8
is normally used to configure this information.
.Sh GREYLISTING
d173 1
a173 12
.Nm
will run in the normal mode for any addresses blacklisted by
.Xr spamd-setup 8 .
Connections from addresses not blacklisted by
.Xr spamd-setup 8
will be considered for greylisting.
Such connections will not be stuttered at
(though see the
.Fl S
option above)
or delayed,
and will receive the pleasantly innocuous temporary failure of:
d178 2
a179 1
in the SMTP dialogue immediately after the recipient is specified.
d183 1
a183 1
to track these non-blacklisted connections to
d185 3
a187 3
by connecting IP address, HELO/EHLO, envelope-from, and envelope-to,
or "tuple" for
short.
d230 1
a230 5
If an address matches a blacklist specified in
.Pa /etc/mail/spamd.conf ,
the connection will be stuttered at by
.Nm .
All other connections will be considered for greylisting and
a233 8
Note that when greylisting we do not need the
.Em spamd
.Xr pf 4
table since all connections are passed to
.Nm
unless the source address is listed in the
.Em spamd-white
table.
d260 4
a263 1
flag when operating in greylisting mode.
d339 84
@


1.73
log
@Flag day for spamd -
1) config files move to /etc/mail
2) -g option goes away in spamd-setup and spamd - greylisting is now the default
3) option change to spamd, -b addr becomes -l addr.
4) -b option in spamd-setup and spamd to turn on old blacklisting mode.

Man page shortly to be flensed to make this easier to explain
ok deraadt@@ millert@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.72 2007/02/25 22:04:12 jmc Exp $
a35 1
.Op Fl l Ar address
d39 1
d70 5
a74 8
.It Fl l Ar address
Specify the local address to which
.Nm
is to
.Xr bind 2 .
By default
.Nm
listens on all local addresses.
a95 4
.It Fl b
Turn off Greylisting mode, and run only as a blacklister. see
.Sx GREYLISTING
below.
d98 8
@


1.72
log
@- HELO/EHLO is part of the tuple
- remove misleading sentence

ok millert
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.71 2007/02/25 20:21:01 millert Exp $
d34 1
a34 1
.Op Fl 45dgv
d36 1
a36 1
.Op Fl b Ar address
d70 1
a70 1
.It Fl b Ar address
d99 2
a100 2
.It Fl g
Greylisting mode; see
d322 1
a322 1
.Pa /etc/spamd.conf ,
d411 1
a411 1
.Pa /etc/spamd/alloweddomains
d415 1
a415 1
.Pa /etc/spamd/alloweddomains
d421 1
a421 1
.Pa /etc/spamd/alloweddomains
d456 2
a457 2
.Bl -tag -width "/etc/spamd/alloweddomainsXX" -compact
.It /etc/spamd.conf
d459 1
a459 1
.It /etc/spamd/alloweddomains
@


1.71
log
@Attempt to clarify new greylisting rules.
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.70 2007/02/24 19:28:13 millert Exp $
d276 2
a277 1
by connecting IP address, envelope-from, and envelope-to, or "tuple" for
a315 4
With this configuration,
.Xr spamd-setup 8
should be used to configure blacklists in
.Nm .
@


1.70
log
@When greylisting we don't actually need to use the <spamd> pf table.
We just do no-rdr for things in <spamd-white> and rdr the rest to spamdb.
OK beck@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.69 2007/02/24 08:48:49 jmc Exp $
a317 6
.Nm
and add them to the
.Em spamd
.Xr pf 4
table.
These connections will be stuttered at by
d319 1
a319 1
All other connections not in the
d321 1
d323 7
a329 5
.Nm
but will not be stuttered at.
Such connections will be
considered for greylisting and eventual whitelisting (by addition
to the
d331 1
a331 1
table so they are not redirected) if they retry mail delivery.
d334 2
a335 1
table since connections are passed to
d337 1
a337 1
unless the address is listed in the
a366 4
Otherwise, it will attempt to populate the
.Em spamd
.Xr pf 4
table (which is not needed when greylisting).
@


1.69
log
@tweaks;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.68 2007/02/23 23:14:56 beck Exp $
d301 3
a303 1
table must be used to allow connections to pass to the
a307 1
table <spamd> persist
d309 3
a311 3
rdr pass inet proto tcp from <spamd> to any \e
    port smtp -> 127.0.0.1 port spamd
rdr pass inet proto tcp from !<spamd-white> to any \e
d335 7
d364 9
@


1.68
log
@to_suffixes -> alloweddomains, that got missed, noticed
by okan@@demirmen.com
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.67 2007/02/23 19:22:07 beck Exp $
d425 1
a425 1
would not cause the sending host be trapped.
d427 1
a427 1
.Em peter@@apostles.humpingforjesus.com ,
d452 1
a452 1
Optional required suffixes for greytrapping
d469 1
a469 2
command
appeared in
d471 1
d475 3
a477 2
<> characters, current versions expect only the email address without the
enclosing <> characters.
@


1.67
log
@greytrapping improvements
	1) remove requirement for <> around spamtrap addresses
	2) add support for /etc/spamd/alloweddomains to specify
	   suffixes for which any destinations that don't match
	   get trapped

	various knf's by theo, feedback from jmc, millert, deraadt
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.66 2006/11/14 17:37:47 jmc Exp $
d448 1
a448 1
.Bl -tag -width "/etc/spamd/to_suffixesXX" -compact
d451 1
a451 1
.It /etc/spamd/to_suffixes
d472 1
a472 1
previous versions of
@


1.66
log
@improve previous;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.65 2006/11/14 17:35:19 jmc Exp $
d396 1
a396 1
.Dl # spamdb -T -a '<spamtrap@@mydomain.org>'
a397 1
It should be entered exactly, as the address will be used in the SMTP dialogue.
d401 30
d448 1
a448 1
.Bl -tag -width "/etc/spamd.confXX" -compact
d451 2
d472 5
@


1.65
log
@clarify "maxcon" somewhat, particularly its upper limit;
from jared rr spiegel (pr #5292), tweaked somewhat;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.64 2006/10/19 11:46:51 jmc Exp $
d81 1
a81 1
may not exceed the default of 800.
@


1.64
log
@no need to escape "'";
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.63 2006/10/17 19:11:56 beck Exp $
d67 3
a69 1
The default is maxcon \- 100.
d80 2
a81 1
The default is 800.
@


1.63
log
@Make this easier for people who aren't aware of what shell they are running.
ok deraadt@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.62 2006/09/29 00:37:36 jmc Exp $
d393 1
a393 1
.Dl # spamdb -T -a \&'<spamtrap@@mydomain.org>\&'
@


1.62
log
@typo; from sthen
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.61 2006/08/15 20:52:12 kjell Exp $
d393 1
a393 1
.Dl # spamdb -T -a \&"<spamtrap@@mydomain.org>\&"
@


1.61
log
@-r only applies to blacklists. ok beck@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.60 2006/05/15 16:47:48 jcs Exp $
d363 1
a363 1
.Pa /var/db/spamdb .
@


1.60
log
@add an -h option to override the hostname that is reported in the
SMTP banner

ok beck@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.59 2005/12/01 15:21:16 tom Exp $
d113 2
a114 1
The SMTP error to return to the spammer, i.e. 450, 451, 550.
@


1.59
log
@Spell "blacklisted" consistently.

ok jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.58 2005/11/24 08:47:10 jmc Exp $
d39 1
d100 2
@


1.58
log
@missing full stop;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.57 2005/08/06 19:52:36 jmc Exp $
d59 1
a59 1
For black listed entries, return error code 450 to the spammer (default).
d61 1
a61 1
For black-listed entries, return error code 550 to the spammer.
@


1.57
log
@replace port number 8025 w/ symbolic `spamd';
ok krw@@ deraadt@@

diff from ray lai;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.56 2005/05/17 08:25:55 jmc Exp $
d66 1
a66 1
The default is maxcon \- 100
@


1.56
log
@update FILES;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.55 2005/05/17 08:16:51 jmc Exp $
d183 1
a183 1
    port smtp -> 127.0.0.1 port 8025
d189 1
a189 2
.Nm
running on port 8025.
d302 1
a302 1
    port smtp -> 127.0.0.1 port 8025
d304 1
a304 1
    port smtp -> 127.0.0.1 port 8025
@


1.55
log
@- describe start up better
- note that greylisting does stutter slightly
- make clear role of spamdb and spamd.conf
- few minor tweaks

ok beck@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.54 2005/04/14 16:07:52 beck Exp $
d413 6
a418 1
/etc/spamd.conf
@


1.54
log
@Make spamd stutter at greylisted connections for a short period before talking
full speed. By default do this for 10 seconds. Many spammers disconnect by
then. Adds -S option to select the amount of time greylisted connections
will be stuttered at.

	feedback from jmc@@, deraadt@@,   ok deraadt@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.53 2005/03/11 23:09:53 beck Exp $
d152 8
a159 6
is best started from
.Xr rc 8
in conjunction with the
.Xr spamd-setup 8
which processes a list of spammers' addresses, and applies appropriate
.Xr pfctl 8
d163 1
a163 1
is run from
d165 3
d211 3
a213 1
is deferred by spamd know why their address has been listed
d254 5
a258 1
Such connections will not be stuttered at or delayed,
d304 2
a305 2
rdr pass inet proto tcp from !<spamd-white> to any port smtp \e
    -> 127.0.0.1 port 8025
d336 1
a336 1
MTA's will give up attempting to retry delivery of a message.
d350 1
d357 7
d390 1
a390 1
.Dl spamdb -T -a \&"<spamtrap@@mydomain.org>\&"
d392 1
a392 1
It should be entered exactly as the address will be used in the SMTP dialogue.
@


1.53
log
@"Greytrapping" for spamd - allow for spamd greylisting to maintain
a list of spamtrap destination addresses in the spamd database. When
a spamtrap address gets an attempted greylist delivery, blacklist the
offending host for a day. Does not affect hosts already whitelisted.

ok deraadt@@, jmc@@, dhartmei@@ to get it in so it can be whacked on
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.52 2005/01/19 17:07:31 deraadt Exp $
d42 1
d112 4
@


1.52
log
@clarification; ok beck
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.51 2004/10/05 21:04:36 beck Exp $
d340 32
@


1.51
log
@Change the default passtime to 25 minutes,
MTA's with a quadratic retry schedule have a retry after 26 minutes, and
then again after an hour, so this probably makes a lot more sense than the
old 30 minute default.

ok henning@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.50 2004/10/05 15:20:30 beck Exp $
d58 1
a58 1
Return error code 450 to the spammer (default).
d60 1
a60 1
Return error code 550 to the spammer.
d87 7
d262 1
a262 1
minutes (by default 25) if
d318 1
a318 1
hours (by default 4) from the initial time a connection is seen.
d330 1
a330 1
hours (by default 864, or 36 days) from the initial time an address
@


1.50
log
@change default to 451 for greylisting, thanks to a number of
people on misc, and some observations by Evan harris on the greylisting
mailing list that a number of clustered mailers like aol behave better
(and retry from the same IP) when they see a 451, but do not when
they see a 450 (traditionally used for mailbox lock failure)

450 was the original for spamd, as the default for the tarpit is to
encourage quick retries to punish blacklisted smtp servers more. This
got carried over to the greylisting implementation, and isnt' really
optimal for that case.

ok millert@@, henning@@, todd@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.49 2004/03/16 09:19:25 jmc Exp $
d255 1
a255 1
minutes (by default 30) if
@


1.49
log
@sort options and escape a minus sign;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.48 2004/03/15 21:53:39 beck Exp $
d238 1
a238 1
450 Temporary failure, please try again later.
@


1.48
log
@Add -B option, with maxblack limit to limit the number of blacklist
connections to something less than maxcon when greylisting. This ensures
you don't completely run out of connections tarpitting spammers, and not
allow real mail through.
ok dhartmei@@ millert@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.47 2004/03/12 22:16:16 jmc Exp $
d35 1
a36 1
.Op Fl B Ar maxblack
d61 5
a73 5
.It Fl B Ar maxblack
The maximum number of concurrent blacklisted connections to allow in
greylisting mode. 
This value may not be greater than maxcon (see below). 
The default is maxcon - 100
@


1.47
log
@sort options;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.46 2004/03/12 21:01:16 beck Exp $
d36 1
d69 5
@


1.46
log
@Fix typo, spotted by Eduardo Alvarenga <eduardo@@eduardo.lan.cei>
ok xsa@@ henning@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.45 2004/03/10 00:32:54 beck Exp $
d77 4
a82 4
.Sx GREYLISTING
below.
.It Fl G Ar passtime:greyexp:whiteexp
Adjust the three time parameters for greylisting; see
@


1.45
log
@add -b option to specify local bind address, sent by
yongari@@kt-is.co.kr
ok deraadt@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.44 2004/03/01 18:17:42 xsa Exp $
d254 1
a254 1
whitelist entry to to
@


1.44
log
@
typo; we do have spamlogd(8) not spamlog(8);
ok beck@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.43 2004/02/26 07:28:55 beck Exp $
d35 1
d60 8
@


1.43
log
@Add -g option for greylisting support for spamd. The greylisting techinque
originates from a paper by Evan Harris which can be found at
http://projects.puremagic.com/greylisting/. This implementation makes
spamd allow for non-blacklisted addresses to be treated as "greylisted".
where they are tracked in a db file, and whitelisted by addition to a
pf table when the same envelope from and to are retried from the same
source IP address. Testing by many, ok deraadt@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.42 2004/01/21 01:55:10 deraadt Exp $
d344 1
a344 1
.Xr spamlog 8 ,
@


1.42
log
@the example should use 'rdr pass' so that you do not have to open 8025 to
the outside world -- in fact 'rdr pass' was designed for this, but once
again someone forgot to updated the bloody man page; mcbride ok
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.41 2003/10/23 08:33:22 jmc Exp $
d34 1
a34 1
.Op Fl 45dv
d36 1
d68 8
d150 1
a150 1
rdr pass inet proto tcp from <spamd> to any \\
d212 106
d343 2
d352 14
@


1.41
log
@- add -v to SYNOPSIS
- new sentence, new line
- .Dv for variables
- fix .Xr
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.40 2003/10/22 21:31:38 beck Exp $
d141 2
a142 1
rdr inet proto tcp from <spamd> to any port smtp -> 127.0.0.1 port 8025
@


1.40
log
@make logging less verbose by default - default logs connect, disconnect
and blacklist matches. Add -v (verbose) flag to allow other detailed
logging (subject, body, smtp dialogue, etc.) when it's needed.
ok dhartmei@@ -> ok deraadt@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.39 2003/09/25 09:07:33 jmc Exp $
d34 1
a34 1
.Op Fl 45d
d85 2
a86 1
Enable verbose logging. By default
d89 10
a98 4
.Xr syslog 8
at LOG_INFO level. With verbose logging enabled, message detail
including subject and recipient information is logged at LOG_INFO, along
with the message body and SMTP dialogue being logged at LOG_DEBUG level. 
@


1.39
log
@- add .Bk/.Ek to SYNOPSIS
- use -offset rather than indenting the actual display
- kill unnecessary .Pp
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.38 2003/09/24 01:14:48 deraadt Exp $
d84 8
@


1.38
log
@crank max connections to 800 (really, there are poeple doing this)
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.37 2003/09/03 21:22:19 tedu Exp $
d33 1
d41 1
a53 1
.Pp
d124 3
a126 3
.Bd -literal
    table <spamd> persist
    rdr inet proto tcp from <spamd> to any port smtp -> 127.0.0.1 port 8025
d137 2
a138 2
.Bd -literal
    # pfctl -q -t spamd -T replace -f /usr/local/share/spammers
d172 2
a173 2
.Bd -literal
      tag;"rejection message";aaa.bbb.ccc.ddd/mm;aaa.bbb.ccc.ddd/mm
d199 1
a199 1
.Bd -literal
@


1.37
log
@permit the window/receive buffer to be adjustable.  default back to system
default.  in reponse to pr3435.  ok beck deraadt dhartmei
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.36 2003/08/23 21:22:34 dhartmei Exp $
d59 1
a59 1
The default is 200.
@


1.36
log
@add -s to specify stuttering delay, set receive buffer size to 1 byte
(causing a small TCP window size, tying up sender's resources), additional
states: keep connection until ten body lines have been received, improved
logging through syslog (envelope from/to, From:/To:/Subject: in header,
first lines of body) at various levels. ok deraadt@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.35 2003/06/02 14:27:12 jmc Exp $
d39 1
d83 2
@


1.35
log
@- remove .Pp's before .Sh
- correct .Xr
- .Ox instead of OpenBSD
- whitespace between punctuation
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.34 2003/04/12 22:12:58 deraadt Exp $
d38 1
d78 4
d183 16
d205 1
d207 2
a208 1
.Xr spamd-setup 8
@


1.34
log
@attempt not to wrap a line, bad nroff
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.33 2003/03/20 01:39:36 david Exp $
d73 1
a73 1
.Xr getservbyname 5 .
a102 1
.Pp
a149 1
.Pp
d156 1
a156 1
.Xr services 5 ).
d166 1
a166 1

a179 1
.Pp
d191 1
a191 1
.Tn OpenBSD 3.3.
@


1.33
log
@cmdline options and descriptions in alphabetical order in usage() and manpage
add arguments to the flags that take them in the DESCRIPTION
add "inet" to the rdr rule example to match etc/pf.conf example

ok dhartmei@@ henning@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.32 2003/03/18 13:05:24 david Exp $
d94 1
a94 1
and is used in conjunction with
d100 3
@


1.32
log
@duplicate words: on on, in in
ok miod@@ jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.31 2003/03/15 18:09:11 pvalchev Exp $
a33 1
.Op Fl r Ar reply
d35 1
d37 1
a37 1
.Op Fl n Ar name
d55 3
d64 3
a66 7
.It Fl r
The SMTP error to return to the spammer, i.e. 450, 451, 550.
This defaults to 450.
.It Fl c
The maximum number of concurrent connections to allow.
The default is 200.
.It Fl p
d74 3
a76 2
.It Fl n
The SMTP version banner that is reported upon initial connection.
d115 1
a115 1
    rdr proto tcp from <spamd> to any port smtp -> 127.0.0.1 port 8025
@


1.31
log
@spamd is running on port 8025, not 25; from Adrian Knoth
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.30 2003/03/13 13:31:10 henning Exp $
d156 1
a156 1
The configuration socket listens only on on the INADDR_LOOPBACK
@


1.30
log
@correct table usage in rdr example, spotted by todd
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.29 2003/03/11 07:58:34 david Exp $
d122 1
a122 1
running on port 25.
@


1.29
log
@EOL whitespace
ok jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.28 2003/03/11 04:39:52 david Exp $
d115 1
a115 1
    rdr proto tcp from { <spamd> } to any port smtp -> 127.0.0.1 port 8025
@


1.28
log
@new sentence, new line
ok beck@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.27 2003/03/09 21:12:06 pvalchev Exp $
d178 1
a178 1
/etc/spamd.conf 
@


1.27
log
@also mention max connections default; ok deraadt
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.26 2003/03/09 20:25:33 pvalchev Exp $
d65 2
a66 2
The maximum number of concurrent connections to allow.  The default
is 200.
d70 2
a71 2
should listen for redirected SMTP connections on. The default port is found
by looking for the named service
d157 4
a160 3
address. Configuration of spamd is done by connecting to the
configuration socket, and sending blacklist information, one blacklist
per line. Each blacklist consists of a name, a message to reject mail
@


1.26
log
@mention error code 450 is default; ok deraadt
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.25 2003/03/09 19:22:25 beck Exp $
d65 2
a66 1
The maximum number of concurrent connections to allow.
@


1.25
log
@Fix a few typos, Make spamd and spamd-setup use /etc/services to find
their ports. Adds "spamd" and "spamd-cfg" services to /etc/services.
Mostly from Daniel Lucq <daniel@@lucq.org>.
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.24 2003/03/08 22:03:53 beck Exp $
d52 1
a52 1
Return error code 450 to the spammer.
@


1.24
log
@remove some more ambigious bs
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.23 2003/03/08 21:36:12 jmc Exp $
d67 1
a67 1
Specify a different port number from the default of 8025 that
d69 5
a73 1
should listen for redirected SMTP connections on. 
d150 6
a155 3
listens for configuration connections one port above the one on which
it listens for redirected SMTP connections, The default is port
8026. The configuration socket listens only on on the INADDR_LOOPBACK
d180 1
@


1.23
log
@spamd typos;

ok beck@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.22 2003/03/06 09:41:31 henning Exp $
d67 1
a67 1
Specify the port number that
d69 1
a69 1
should operate on.
d146 7
a152 5
receives configuration information through a localhost connection.
Configuration information consists of blacklists, each with a name,
a message to reject mail with, and addresses in CIDR format.
When multiple lists are configured, each configuration line specifies
a blacklist, and must have the format:
d168 2
@


1.22
log
@can be can be, but also may not be, or cannot be, and in any case can be
once is better than can be can be
guess who found that? yeah, David Krause, again. great!
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.21 2003/03/06 04:07:37 david Exp $
d62 1
a62 1
The SMTP error to return to the spammer, i.e., 450, 451, 550.
d89 1
a89 1
and is used in conjuction with
d114 1
a114 1
.Aq spamd
d127 1
a127 1
.Aq spamd
d158 1
a158 1
%A will expand to the connecting ip address in dotted quad format.
d169 1
@


1.21
log
@date should be written formally: .Dd Month day, year
ok henning@@ jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.20 2003/03/06 03:27:53 david Exp $
d118 1
a118 1
Addresses can be can be loaded into the
@


1.20
log
@new sentence, new line
(fixes some sentences with only 1 space between)
ok henning@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.19 2003/03/06 01:03:09 henning Exp $
d25 1
a25 1
.Dd Dec 18, 2002
@


1.19
log
@pasto, from thierry, who does not want to be a pf-like commiter ;-)
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.18 2003/03/04 11:32:07 henning Exp $
d139 2
a140 1
from sending mail. This is important as it allows legitimate mail
d148 2
a149 2
a message to reject mail with, and addresses in CIDR format. When
multiple lists are configured, each configuration line specifies
d155 6
a160 5
The rejection message must be inside double quotes.  A \e" will
produce a double quote in the output. \en will produce a newline. %A
will expand to the connecting ip address in dotted quad format, %% may
be used to produce a single % in the output, \e\e will produce a
single \e.
@


1.18
log
@typos; Daniel Lucq
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.17 2003/03/04 09:22:54 deraadt Exp $
d118 1
a118 1
Addresses can then be can be loaded into the
@


1.17
log
@spam not SPAM; nick@@electric-pickle.net
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.16 2003/03/03 08:32:07 cedric Exp $
d145 1
a145 1
receives configuration information through a localhost connection
d148 1
a148 1
multiple lists are configured, Each configuration line specifies
d163 1
a163 1
is normally used to configure this informaiton.
@


1.16
log
@"an table" -> "a table", add persist keyword.
ok deraadt@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.15 2003/03/02 22:38:56 deraadt Exp $
d77 1
a77 1
SPAM is never accepted, but always rejected with either a 450 or 550
d79 1
a79 1
The normal way that SPAM has been dealt with in the past is to either
@


1.15
log
@more tweaking
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.14 2003/03/02 20:54:39 deraadt Exp $
d105 1
a105 1
The rules can be loaded into an
d109 1
a109 1
    table <spamd>
@


1.14
log
@more
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.13 2003/03/02 20:32:05 deraadt Exp $
d42 1
a42 1
daemon which absorbs false mail.
@


1.13
log
@knf
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.12 2003/03/02 19:22:00 beck Exp $
d122 1
a122 1
      pfctl -q -t spamd -T replace -f /usr/local/share/spammers
d149 1
a149 1
a blacklist, and  must have the format:
d154 1
a154 1
The rejection message must be inside double quotes.  a \e" will
@


1.12
log
@Spamd changes to add blacklist awareness to spamd, new spamd-setup.pl
which configures individual blacklists sources and deals with whitelists.
Perl still needs some stylistic changes as suggested by bmc which will go
in shortly.
ok deraadt@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.11 2003/02/26 15:05:07 david Exp $
d109 1
a109 1
    table <spamd>	
d115 1
a115 1
are then redirected to 
d128 1
a128 1
table. 
d136 1
a136 1
rejection messages for each blacklist source 
d141 1
a141 1
may be removed from the relevant blacklists. 
d161 1
a161 1
a connecting address is matched. 
d163 1
a163 1
is normally used to configure this informaiton. 
@


1.11
log
@start new sentence on a new line
ok mpech@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.10 2003/02/13 08:23:39 jmc Exp $
d106 1
a106 1
.Em anchor
a107 7
If the main ruleset contains the following
.Em rdr-anchor rule ,
all
.Em rdr
rules inside the specified
.Em anchor
are evaluated for SMTP connections:
d109 14
a122 1
    rdr-anchor spews proto tcp from any to any port smtp
d125 9
a133 3
And all
.Em rdr
rules related to
d135 15
a149 3
can be loaded into one or more rulesets inside that
.Em anchor ,
like:
d151 1
a151 2
    echo "rdr inet proto tcp from { 10.1.2.3, 10.2.3.4/30, 10.3.4.5/24 }
      to any port smtp -> 127.0.0.1 port 8025" | pfctl -a spews:first -f -
d153 11
@


1.10
log
@typos;

setextattr(8): example markus@@
spamd(8): someone else found some of these on bugs/misc, but for the life
	  of me i can't find out who
pf.conf(5): from openbsd@@davidkrause.com
raidctl(8): from ian@@darwinsys.com
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.9 2003/02/10 12:01:51 dhartmei Exp $
d62 2
a63 2
The SMTP error to return to the spammer, ie 450, 451, 550.  This defaults
to 450.
d76 5
a80 3
receiving machine.  SPAM is never accepted, but always rejected with
either a 450 or 550 error message.  The normal way that SPAM has been
dealt with in the past is to either accept and drop, or outright block.
@


1.9
log
@Add "inet proto tcp" to the last rdr example, it produces a syntax error
otherwise. Found by David Norman.
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.8 2003/01/20 19:52:51 deraadt Exp $
d40 1
a40 1
is a a fake
d65 1
a65 1
the Maximum number of concurrent connections to allow.
d91 2
a92 1
rdr rules.
d100 1
a100 1
.Pa rdr
d104 1
a104 1
.Pa anchor
d107 1
a107 1
.Pa rdr-anchor rule ,
d109 1
a109 1
.Pa rdr
d111 1
a111 1
.Pa anchor
d118 1
a118 1
.Pa rdr
d122 1
a122 1
.Pa anchor ,
d131 2
a132 2
.Xr spamd-setup 8 ,
.Xr pfctl 8
@


1.8
log
@typos; alan@@alanday.com
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.7 2003/01/01 21:04:56 deraadt Exp $
d124 2
a125 2
    echo "rdr from { 10.1.2.3, 10.2.3.4/30, 10.3.4.5/24 } to any port smtp
      -> 127.0.0.1 port 8025" | pfctl -a spews:first -f -
@


1.7
log
@the the; bsd@@openbsd.rutgers.edu
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.6 2002/12/31 12:19:57 avsm Exp $
d78 1
a78 1
dealt with in the way is to either accept and drop, or outright block.
d89 1
a89 1
which processes a list of spammers addresses, and applies appropriate
@


1.6
log
@fxi som tpyos
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.5 2002/12/31 01:01:28 dhartmei Exp $
d97 1
a97 1
based on the the source address of the sender.
@


1.5
log
@Mention pf rdr rules and anchors.
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.4 2002/12/25 10:14:20 deraadt Exp $
d78 1
a78 1
dealt with in the way is to either acccept and drop, or outright block.
d89 1
a89 1
which proceses a list of spammers addresses, and applies appropriate
@


1.4
log
@remove nasty verbiage
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.3 2002/12/23 01:34:36 deraadt Exp $
d93 35
d129 1
@


1.3
log
@minor minor tweaks; mjc@@bitz.ca
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.2 2002/12/21 18:18:38 deraadt Exp $
d77 3
a79 31
either a 450 or 550 error message.
.Pp
There are currently two methods that are being used to
fight spam.
.Bl -enum -offset indent
.It
Block (or slowly block) This works well, the spammers are blocked, and cannot
access your host's services.  Unfortunately this does little to combat the
problem of spam in general, allowing the spammer to continue to spam others.
.It
Accept & drop via a
.Xr sendmail 8
addon.  This works well for many sites also.  All the mail that is recieved
by your host is processed by a set of rules, and the spam is either deleted
or flagged for further action.  Unfortunately this method can consume a
considerable amount of your systems resources.
.El
.Pp
What
.Nm
does, is defer the spammers connections.  It does this in a manner
designed to use as few local resources as possible, while consuming as much
of the spammers resources as possible.
.Nm
replies to the spammers mail with error codes which cause will cause mail
to be stored in remote mail queues, taking up disk
space, and to be resent multiple times, using network resources.
.Pp
.Nm
does not follow the policy of playing nice with your neighbor.  Clients
which reach
d81 2
a82 3
have already been flagged as being spammers.  The only way to combat spam is
to remove the sender's ability to deliver it.  In this case, that means force
the delivery of spam to have a very high overhead for the remote relay.
@


1.2
log
@fixes; openbsd@@davidkrause.com
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamd.8,v 1.1 2002/12/21 01:41:54 deraadt Exp $
d84 1
a84 1
access your hosts services.  Unfortunately this does little to combat the
d91 1
a91 1
or flagged for further action.  Unfortunately this method can sonsume a
d97 2
a98 2
does, is to defer the spammers connections.  It does this in a manner
designed to use as few local resources  as possible, while consuming as much
d106 1
a106 1
does not follow the pollicy of playing nice with your neighbor.  Clients
d110 1
a110 1
to remove the senders ability to deliver it.  In this case, that means force
@


1.1
log
@spamd: work in progress
@
text
@d1 1
a1 1
.\"	$OpenBSD$
d37 1
d70 2
d130 1
a130 1
.Tn OpenBSD 3.2.
@

