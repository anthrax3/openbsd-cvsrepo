head	1.18;
access;
symbols
	OPENBSD_6_1_BASE:1.18
	OPENBSD_6_0:1.18.0.12
	OPENBSD_6_0_BASE:1.18
	OPENBSD_5_9:1.18.0.8
	OPENBSD_5_9_BASE:1.18
	OPENBSD_5_8:1.18.0.10
	OPENBSD_5_8_BASE:1.18
	OPENBSD_5_7:1.18.0.2
	OPENBSD_5_7_BASE:1.18
	OPENBSD_5_6:1.18.0.6
	OPENBSD_5_6_BASE:1.18
	OPENBSD_5_5:1.18.0.4
	OPENBSD_5_5_BASE:1.18
	OPENBSD_5_4:1.17.0.10
	OPENBSD_5_4_BASE:1.17
	OPENBSD_5_3:1.17.0.8
	OPENBSD_5_3_BASE:1.17
	OPENBSD_5_2:1.17.0.6
	OPENBSD_5_2_BASE:1.17
	OPENBSD_5_1_BASE:1.17
	OPENBSD_5_1:1.17.0.4
	OPENBSD_5_0:1.17.0.2
	OPENBSD_5_0_BASE:1.17
	OPENBSD_4_9:1.16.0.6
	OPENBSD_4_9_BASE:1.16
	OPENBSD_4_8:1.16.0.4
	OPENBSD_4_8_BASE:1.16
	OPENBSD_4_7:1.16.0.2
	OPENBSD_4_7_BASE:1.16
	OPENBSD_4_6:1.15.0.4
	OPENBSD_4_6_BASE:1.15
	OPENBSD_4_5:1.14.0.4
	OPENBSD_4_5_BASE:1.14
	OPENBSD_4_4:1.14.0.2
	OPENBSD_4_4_BASE:1.14
	OPENBSD_4_3:1.13.0.4
	OPENBSD_4_3_BASE:1.13
	OPENBSD_4_2:1.13.0.2
	OPENBSD_4_2_BASE:1.13
	OPENBSD_4_1:1.12.0.2
	OPENBSD_4_1_BASE:1.12
	OPENBSD_4_0:1.4.0.10
	OPENBSD_4_0_BASE:1.4
	OPENBSD_3_9:1.4.0.8
	OPENBSD_3_9_BASE:1.4
	OPENBSD_3_8:1.4.0.6
	OPENBSD_3_8_BASE:1.4
	OPENBSD_3_7:1.4.0.4
	OPENBSD_3_7_BASE:1.4
	OPENBSD_3_6:1.4.0.2
	OPENBSD_3_6_BASE:1.4
	OPENBSD_3_5:1.3.0.2
	OPENBSD_3_5_BASE:1.3;
locks; strict;
comment	@.\" @;


1.18
date	2013.09.15.20.02.34;	author schwarze;	state Exp;
branches;
next	1.17;

1.17
date	2011.03.04.21.01.49;	author okan;	state Exp;
branches;
next	1.16;

1.16
date	2009.09.17.06.37.54;	author jmc;	state Exp;
branches;
next	1.15;

1.15
date	2009.07.02.18.07.45;	author schwarze;	state Exp;
branches;
next	1.14;

1.14
date	2008.04.12.17.41.18;	author deraadt;	state Exp;
branches;
next	1.13;

1.13
date	2007.05.31.19.19.41;	author jmc;	state Exp;
branches;
next	1.12;

1.12
date	2007.03.04.09.58.22;	author jmc;	state Exp;
branches;
next	1.11;

1.11
date	2007.03.04.03.19.41;	author beck;	state Exp;
branches;
next	1.10;

1.10
date	2007.02.27.16.04.26;	author jmc;	state Exp;
branches;
next	1.9;

1.9
date	2006.11.04.00.19.44;	author jmc;	state Exp;
branches;
next	1.8;

1.8
date	2006.11.03.19.39.33;	author henning;	state Exp;
branches;
next	1.7;

1.7
date	2006.10.26.13.27.57;	author jmc;	state Exp;
branches;
next	1.6;

1.6
date	2006.10.25.19.17.55;	author henning;	state Exp;
branches;
next	1.5;

1.5
date	2006.10.23.07.05.49;	author jmc;	state Exp;
branches;
next	1.4;

1.4
date	2004.07.14.21.38.09;	author jmc;	state Exp;
branches;
next	1.3;

1.3
date	2004.02.28.14.53.06;	author matthieu;	state Exp;
branches;
next	1.2;

1.2
date	2004.02.27.18.25.49;	author beck;	state Exp;
branches;
next	1.1;

1.1
date	2004.02.26.07.28.55;	author beck;	state Exp;
branches;
next	;


desc
@@


1.18
log
@Some missing .Pa macros in FILES sections;
from Jan Stary <hans at stare dot cz>;
discussed with jmc@@.
@
text
@.\"	$OpenBSD: spamlogd.8,v 1.17 2011/03/04 21:01:49 okan Exp $
.\"
.\" Copyright (c) 2004 Bob Beck.  All rights reserved.
.\"
.\" Permission to use, copy, modify, and distribute this software for any
.\" purpose with or without fee is hereby granted, provided that the above
.\" copyright notice and this permission notice appear in all copies.
.\"
.\" THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
.\" WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
.\" MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
.\" ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
.\" WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
.\" ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
.\" OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
.\"
.Dd $Mdocdate: March 4 2011 $
.Dt SPAMLOGD 8
.Os
.Sh NAME
.Nm spamlogd
.Nd spamd whitelist updating daemon
.Sh SYNOPSIS
.Nm spamlogd
.Op Fl DI
.Op Fl i Ar interface
.Op Fl l Ar pflog_interface
.Op Fl W Ar whiteexp
.Op Fl Y Ar synctarget
.Sh DESCRIPTION
.Nm
manipulates the
.Xr spamd 8
database in
.Pa /var/db/spamd
used for greylisting.
.Nm
updates the
.Pa /var/db/spamd
whitelist entries whenever a connection
to port 25 is logged to the
.Xr pflog 4
interface.
The source addresses of inbound connections are whitelisted
when seen by
.Nm
to ensure that their entries in
.Pa /var/db/spamd
do not expire if the connecting host continues to send legitimate mail.
The destination addresses of outbound connections are whitelisted
when seen by
.Nm
so that replies to outbound mail may be received without initial
greylisting delays.
Greylisting is explained more fully in
.Xr spamd 8 .
.Pp
The options are as follows:
.Bl -tag -width Ds
.It Fl D
Debugging mode.
.Nm
does not disassociate from the controlling terminal.
.It Fl I
Specify that
.Nm
is only to whitelist inbound SMTP connections.
By default
.Nm
will whitelist the source of inbound SMTP connections, and the
target of outbound SMTP connections.
.It Fl i Ar interface
Specify a network interface on which packets must arrive.
The default is to watch for connections logged from all interfaces.
.It Fl l Ar pflog_interface
Specify a
.Xr pflog 4
interface to listen for connection notifications.
The default is to watch for connections logged on
.Dq pflog0 .
.It Fl W Ar whiteexp
Adjust the time for
.Ar whiteexp
in hours.
The default is 864 hours (approximately 36 days); maximum is 2160 hours
(approximately 90 days).
.It Fl Y Ar synctarget
Add a target to receive synchronisation messages; see
.Sx SYNCHRONISATION
below.
This option can be specified multiple times.
.El
.Pp
It is important to log any connections to and from the real
MTA in order for
.Nm
to update the whitelist entries.
See
.Xr spamd 8
for an example ruleset for logging such connections.
.Pp
.Nm
sends log messages to
.Xr syslogd 8
using facility
.Em daemon .
.Nm
will log each connection it sees at level
.Dv LOG_DEBUG .
.Sh SYNCHRONISATION
.Nm
supports realtime synchronisation of whitelist states by sending
the information it updates to
a number of
.Xr spamd 8
daemons running on multiple machines.
To enable synchronisation, use the command line option
.Fl Y
to specify the machines to which
.Nm
will send messages when it updates the state information.
For more information, see
.Xr spamd 8 .
.Sh FILES
.Pa /var/db/spamd
.Sh SEE ALSO
.Xr syslog 3 ,
.Xr pflog 4 ,
.Xr spamd.conf 5 ,
.Xr pflogd 8 ,
.Xr spamd 8 ,
.Xr spamd-setup 8 ,
.Xr spamdb 8 ,
.Xr syslogd 8 ,
.Xr tcpdump 8
.Sh HISTORY
The
.Nm
command first appeared in
.Ox 3.5 .
@


1.17
log
@add -W flag (whiteexp), as opposed to pulling in a hardcoded default
value from spamd/grey.c; mostly from ohauer@@gmx.de in PR/6142.

ok beck@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamlogd.8,v 1.16 2009/09/17 06:37:54 jmc Exp $
d17 1
a17 1
.Dd $Mdocdate: September 17 2009 $
d125 1
a125 1
/var/db/spamd
@


1.16
log
@merge/update the spamlogd rules into spamd - there were some subtle
problems because of the recent pf nat changes that caused problems;
i've fleshed out the example in spamd and just added a pointer to it
from spamlogd;

ok beck
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamlogd.8,v 1.15 2009/07/02 18:07:45 schwarze Exp $
d17 1
a17 1
.Dd $Mdocdate: July 2 2009 $
d28 1
d81 6
@


1.15
log
@add a missing full stop; noticed by frantisek holop <minusf at obiit dot org>
while here, add a missing comma and a missing word, too; ok jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamlogd.8,v 1.14 2008/04/12 17:41:18 deraadt Exp $
d17 1
a17 1
.Dd $Mdocdate: April 12 2008 $
d87 1
a87 1
It is important to be sure to log any connections to and from your real
d91 3
a93 11
An example
.Xr pf.conf 5
configuration for logging such connections is as follows:
.Bd -literal -offset indent
EXT_IF = "fxp0"
MAILHOSTS = "{129.128.11.10, 129.128.11.43}"
pass in log on $EXT_IF inet proto tcp to $MAILHOSTS \e
	port smtp
pass out log on $EXT_IF inet proto tcp from $MAILHOSTS \e
	to any port smtp
.Ed
@


1.14
log
@yes, all; girishvenkatachalam
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamlogd.8,v 1.13 2007/05/31 19:19:41 jmc Exp $
d17 1
a17 1
.Dd $Mdocdate: May 31 2007 $
d118 1
a118 1
To enable synchronisation, use the command line
d123 2
a124 2
For more information see
.Xr spamd 8
@


1.13
log
@convert to new .Dd format;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamlogd.8,v 1.12 2007/03/04 09:58:22 jmc Exp $
d17 1
a17 1
.Dd $Mdocdate$
d73 1
a73 1
The default is to watch for connections logged from any interfaces.
@


1.12
log
@tweaks;
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamlogd.8,v 1.11 2007/03/04 03:19:41 beck Exp $
d17 1
a17 1
.Dd February 16, 2004
@


1.11
log
@
Database synchronizaton for spamd/spamlogd

This adds an HMAC protected synchronization protocol for use by spamd and
spamlogd.

- spamd can receive updates from other hosts for GREY, WHITE, and TRAPPED db
entries, and will update the local /var/db/spamd accordingly.

- spamd can send updates when it makes changes to the GREY or TRAPPED
entries in the db to other hosts running spamd. (Note it does not send
WHITE entries because the other spamd will see the GREY changes and have
complete information to make appropritate decisions)

- spamlogd can send updates for WHITE db entries that it performs on the local
db to other hosts running spamd, which will then apply them on remote hosts.

note that while this diff provides synchronization for changes made to the
spamd db by the daemons, it does *not* provide for sychonizing changes
to the spamd db made manually with the spamdb command.

Synchronization protocol and most of the work by reyk@@,
with a bunch of the spamd, and spamlogd stuff by me.

testing mostly at the U of A, running happily there under big load.

ok reyk@@ jmc@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamlogd.8,v 1.10 2007/02/27 16:04:26 jmc Exp $
d114 1
a114 1
the information it updates to a 
a124 1
.Pp
@


1.10
log
@sync slightly w/ spamd(8);
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamlogd.8,v 1.9 2006/11/04 00:19:44 jmc Exp $
d28 1
d80 5
d111 15
@


1.9
log
@remove misplaced -l stuff; henning needs more caffeine...
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamlogd.8,v 1.8 2006/11/03 19:39:33 henning Exp $
d34 1
a34 3
used for
.Xr spamd 8
greylisting.
d52 3
a54 5
greylisting delays
(see
.Sx GREYLISTING
in
.Xr spamd 8 ) .
@


1.8
log
@donot for tcpdump, use libpcap directly.
joint work with Berk D. Demir, ok beck deraadt
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamlogd.8,v 1.7 2006/10/26 13:27:57 jmc Exp $
a65 6
.It Fl l Ar log_interface
Specify a
.Xr pflog 4
interface to listen for connection notifications.
The default is to watch for connections logged on
.Dq pflog0 .
@


1.7
log
@- sort options
- sync usage()
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamlogd.8,v 1.6 2006/10/25 19:17:55 henning Exp $
d25 1
a25 1
.Op Fl I
d62 10
@


1.6
log
@allow spamlogd to use an alternate pflog interface
spamlogd was the #1 reason for me to implement the multiple pflog thing,
so now you can finally have a nice seperation between logging and spamlogd
tracking smtp connections
joint work with djm, ok djm bob and kinda "Berk D. Demir" <bdd@@mindcast.org>
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamlogd.8,v 1.5 2006/10/23 07:05:49 jmc Exp $
a24 1
.Op Fl l Ar log_interface
d27 1
a61 6
.It Fl l Ar log_interface
Specify a
.Xr pflog 4
interface to listen for connection notifications.
The default is to watch for connections logged on
.Dq pflog0 .
d73 6
@


1.5
log
@no need to use "keep state" and "flags S/SA" in pf rules,
now that it is the default;

ok henning mcbride camield (ftp-proxy bits) deraadt
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamlogd.8,v 1.4 2004/07/14 21:38:09 jmc Exp $
d25 1
d62 6
@


1.4
log
@- new sentence, new line
- .Sx a section reference
- punctuation
- uppercase smtp
- bigger offset for display
- clarifying logging
- syslog stuff to SEE ALSO
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamlogd.8,v 1.3 2004/02/28 14:53:06 matthieu Exp $
d85 1
a85 1
	port smtp keep state
d87 1
a87 1
	to any port smtp keep state
@


1.3
log
@Fix macro definition if pf.conf example. Ok beck@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamlogd.8,v 1.2 2004/02/27 18:25:49 beck Exp $
d42 2
a43 1
interface. The source addresses of inbound connections are whitelisted
d53 5
a57 2
greylisting delays (see GREYLISTING in
.Xr spamd 8 ).
d64 1
a64 1
is only to whitelist inbound smtp connections.
d67 2
a68 2
will whitelist the source of inbound smtp connections, and the
target of outbound smtp connections.
d81 1
a81 1
.Bd -literal -offset 4n
d93 2
a94 3
using
.Em facility
daemon.
d97 1
a97 1
.Em LOG_DEBUG .
d101 1
d108 1
d113 1
a113 2
command
appeared in
@


1.2
log
@make spamlogd watch the destination of outbound smtp connections,
so that replies to mail sent out do not get greylisting delays.
ok millert@@
@
text
@d1 1
a1 1
.\"	$OpenBSD: spamlogd.8,v 1.1 2004/02/26 07:28:55 beck Exp $
d78 2
a79 2
$EXT_IF = "fxp0"
$MAILHOSTS = "{129.128.11.10, 129.128.11.43}"
@


1.1
log
@Add -g option for greylisting support for spamd. The greylisting techinque
originates from a paper by Evan Harris which can be found at
http://projects.puremagic.com/greylisting/. This implementation makes
spamd allow for non-blacklisted addresses to be treated as "greylisted".
where they are tracked in a db file, and whitelisted by addition to a
pf table when the same envelope from and to are retried from the same
source IP address. Testing by many, ok deraadt@@
@
text
@d1 1
a1 1
.\"	$OpenBSD$
d25 1
d42 12
a53 1
interface.
d57 8
d70 1
a70 1
It is important to be sure to log any connections to your real
d82 2
d85 10
@

