head	1.9;
access;
symbols
	OPENBSD_2_6:1.8.0.2
	OPENBSD_2_6_BASE:1.8
	OPENBSD_2_5:1.6.0.6
	OPENBSD_2_5_BASE:1.6
	OPENBSD_2_4:1.6.0.4
	OPENBSD_2_4_BASE:1.6
	OPENBSD_2_3:1.6.0.2
	OPENBSD_2_3_BASE:1.6
	OPENBSD_2_2:1.4.0.6
	OPENBSD_2_2_BASE:1.4
	OPENBSD_2_1:1.4.0.4
	OPENBSD_2_1_BASE:1.4
	OPENBSD_2_0:1.4.0.2
	OPENBSD_2_0_BASE:1.4
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@# @;


1.9
date	2000.02.03.18.10.48;	author espie;	state dead;
branches;
next	1.8;

1.8
date	99.09.20.19.31.40;	author alex;	state Exp;
branches;
next	1.7;

1.7
date	99.09.19.23.15.02;	author alex;	state Exp;
branches;
next	1.6;

1.6
date	97.11.18.06.13.57;	author millert;	state Exp;
branches;
next	1.5;

1.5
date	97.11.13.04.40.15;	author millert;	state Exp;
branches;
next	1.4;

1.4
date	96.10.01.21.39.07;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	96.09.15.20.47.15;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	96.09.15.20.40.45;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.43.19;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.43.19;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.9
log
@Switch to perl: *much* faster (about ten times), *much* more flexible,
simpler to understand (no more sed), and no temporary files.

Some useful comment by Matt Patton.

Ok'ed millert@@
@
text
@#! /bin/sh
#
# written by matthew green <mrg@@eterna.com.au>, based on the
# original by J.T. Conklin <jtc@@netbsd.org> and Thorsten
# Frueauf <frueauf@@ira.uka.de>.
#
# Public domain.
#
# $OpenBSD: makewhatis.sh,v 1.8 1999/09/20 19:31:40 alex Exp $
#

PATH=/usr/bin:/bin; export PATH

# Create temp files safely
LIST=`mktemp ${TMPDIR=/tmp}/makewhatislist.XXXXXXXXXX` || exit 1
WHATIS=`mktemp ${TMPDIR=/tmp}/whatis.XXXXXXXXXX` || {
	rm -f $LIST
	exit 1
}
trap "rm -f $LIST $WHATIS; exit 1" 1 2 15

MANDIRS=${*-`perl -ne 'print "$1 " if ( /^_whatdb\s+(.*)\/whatis.db\s*$/ );' \
	/etc/man.conf`}

for MANDIR in $MANDIRS; do
	if test ! -d "$MANDIR"; then 
		echo "makewhatis: $MANDIR: not a directory"
		rm -f $LIST $WHATIS
		exit 1
	fi

	find $MANDIR \( -type f -o -type l \) -name '*.[0-9]*' -ls | \
		sort -n | awk '{if (u[$1]) next; u[$1]++ ; print $11}' > $LIST
	 
	egrep '\.[1-9]$' $LIST | xargs /usr/libexec/getNAME | \
		sed -e 's/ [a-zA-Z0-9]* \\-/ -/' > $WHATIS

	egrep '\.0$' $LIST | while read file
	do
		sed -n -f /usr/share/man/makewhatis.sed $file;
	done >> $WHATIS

	egrep '\.[0].(gz|Z)$' $LIST | while read file
	do
		gzip -fdc $file | sed -n -f /usr/share/man/makewhatis.sed;
	done >> $WHATIS

	sort -u -o $WHATIS $WHATIS

	if expr `id -u` \= 0 >/dev/null; then
		install -o root -g bin -m 444 $WHATIS "$MANDIR/whatis.db"
	else
		install -m 444 $WHATIS "$MANDIR/whatis.db"
	fi
done

rm -f $LIST $WHATIS
exit 0
@


1.8
log
@Don't install whatis.db as root:bin when uid != 0.  phil@@psidev.net
@
text
@d9 1
a9 1
# $OpenBSD: makewhatis.sh,v 1.7 1999/09/19 23:15:02 alex Exp $
@


1.7
log
@When invoked without arguments, extract manpaths from /etc/man.conf.
Allow multiple paths to be specified on the command line.  millert@@ ok
@
text
@d9 1
a9 1
# $OpenBSD: makewhatis.sh,v 1.6 1997/11/18 06:13:57 millert Exp $
d50 5
a54 1
	install -o root -g bin -m 444 $WHATIS "$MANDIR/whatis.db"
@


1.6
log
@Fix misplace '>' vs. '>>'; John.P.Darrow@@wheaton.edu
@
text
@d9 1
a9 1
# $OpenBSD: makewhatis.sh,v 1.5 1997/11/13 04:40:15 millert Exp $
d22 25
a46 6
MANDIR=${1-/usr/share/man}
if test ! -d "$MANDIR"; then 
	echo "makewhatis: $MANDIR: not a directory"
	rm -f $LIST $WHATIS
	exit 1
fi
d48 1
a48 15
find $MANDIR \( -type f -o -type l \) -name '*.[0-9]*' -ls | \
    sort -n | awk '{if (u[$1]) next; u[$1]++ ; print $11}' > $LIST
 
egrep '\.[1-9]$' $LIST | xargs /usr/libexec/getNAME | \
	sed -e 's/ [a-zA-Z0-9]* \\-/ -/' > $WHATIS

egrep '\.0$' $LIST | while read file
do
	sed -n -f /usr/share/man/makewhatis.sed $file;
done >> $WHATIS

egrep '\.[0].(gz|Z)$' $LIST | while read file
do
	gzip -fdc $file | sed -n -f /usr/share/man/makewhatis.sed;
done >> $WHATIS
d50 2
a51 1
sort -u -o $WHATIS $WHATIS
a52 1
install -o root -g bin -m 444 $WHATIS "$MANDIR/whatis.db"
@


1.5
log
@From NetBSD:
    makewhatis.sh rewrite by mrg@@netbsd.org that uses getNAME(8).
    Much faster for unformatted man pages now that there is no need
    to format them on the fly.  Removes duplicate inode entries, so
    files with multiple hard links are only parsed once.
OpenBSD changes:
    set $PATH to a reasonable value
    avoid /tmp races via mktemp(1)
    obey $TMPDIR
@
text
@d9 1
a9 1
# $OpenBSD$
d33 1
a33 1
	sed -e 's/ [a-zA-Z0-9]* \\-/ -/' >> $WHATIS
d38 1
a38 1
done > $WHATIS
@


1.4
log
@cleanup TDIR in one more case
@
text
@d3 4
a6 1
# Written by J.T. Conklin <jtc@@netbsd.org>.
d9 2
d12 1
a12 2
TDIR=/tmp/whatis$$
FILE=$TDIR/whatis
d14 4
a17 5
um=`umask`
umask 022
if ! mkdir $TDIR ; then
	printf "tmp directory %s already exists, looks like:\n" $TDIR
	ls -alF $TDIR
d19 2
a20 4
fi
umask $um

trap "rm -rf $TDIR; exit 1" 1 2 15
d25 1
a25 1
	rm -rf $TDIR
d29 7
a35 1
find $MANDIR -type f -name '*.0' -print | while read file
d38 1
a38 6
done > $FILE

find $MANDIR -type f -name '*.0.Z' -print | while read file
do
	zcat $file | sed -n -f /usr/share/man/makewhatis.sed;
done >> $FILE
d40 1
a40 1
find $MANDIR -type f -name '*.0.gz' -print | while read file
d42 2
a43 2
	gzip -dc $file | sed -n -f /usr/share/man/makewhatis.sed;
done >> $FILE
d45 1
a45 1
sort -u -o $FILE $FILE
d47 2
a48 2
install -o bin -g bin -m 444 $FILE "$MANDIR/whatis.db"
rm -rf $TDIR
@


1.3
log
@handle umask nicer
@
text
@d24 1
@


1.2
log
@kill the races; found by bitblt
@
text
@d10 2
a11 1
umask 077
d17 1
@


1.1
log
@Initial revision
@
text
@d7 11
a17 1
trap "rm -f /tmp/whatis$$; exit 1" 1 2 15
d28 1
a28 1
done > /tmp/whatis$$
d33 1
a33 1
done >> /tmp/whatis$$
d38 1
a38 1
done >> /tmp/whatis$$
d40 1
a40 1
sort -u -o /tmp/whatis$$ /tmp/whatis$$
d42 2
a43 1
install -o bin -g bin -m 444 /tmp/whatis$$ "$MANDIR/whatis.db"
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
