head	1.9;
access;
symbols
	OPENBSD_6_0:1.9.0.10
	OPENBSD_6_0_BASE:1.9
	OPENBSD_5_9:1.9.0.4
	OPENBSD_5_9_BASE:1.9
	OPENBSD_5_8:1.9.0.6
	OPENBSD_5_8_BASE:1.9
	OPENBSD_5_7:1.9.0.2
	OPENBSD_5_7_BASE:1.9
	OPENBSD_5_6:1.8.0.4
	OPENBSD_5_6_BASE:1.8
	OPENBSD_5_5:1.6.0.4
	OPENBSD_5_5_BASE:1.6
	OPENBSD_5_4:1.4.0.4
	OPENBSD_5_4_BASE:1.4
	OPENBSD_5_3:1.4.0.2
	OPENBSD_5_3_BASE:1.4
	OPENBSD_5_2:1.3.0.4
	OPENBSD_5_2_BASE:1.3
	OPENBSD_5_1_BASE:1.3
	OPENBSD_5_1:1.3.0.2
	OPENBSD_5_0:1.1.0.2
	OPENBSD_5_0_BASE:1.1;
locks; strict;
comment	@# @;


1.9
date	2014.12.29.11.17.05;	author ajacoutot;	state Exp;
branches;
next	1.8;
commitid	dnRoHtEWzf1tchM0;

1.8
date	2014.06.25.12.33.33;	author sthen;	state Exp;
branches;
next	1.7;
commitid	gF56DLtQLCEqGzVo;

1.7
date	2014.05.07.02.46.05;	author sthen;	state Exp;
branches;
next	1.6;

1.6
date	2014.01.10.17.41.39;	author sthen;	state Exp;
branches;
next	1.5;

1.5
date	2013.11.26.13.01.30;	author sthen;	state Exp;
branches;
next	1.4;

1.4
date	2012.08.04.15.28.39;	author ajacoutot;	state Exp;
branches;
next	1.3;

1.3
date	2012.01.16.17.51.42;	author camield;	state Exp;
branches;
next	1.2;

1.2
date	2011.12.13.13.45.38;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2011.07.06.18.55.36;	author robert;	state Exp;
branches;
next	;


desc
@@


1.9
log
@pexp is not needed; ok sthen@@
@
text
@#!/bin/sh
#
# $OpenBSD: nsd,v 1.8 2014/06/25 12:33:33 sthen Exp $

daemon="/usr/sbin/nsd-control"
daemon_flags="-c /var/nsd/etc/nsd.conf"

. /etc/rc.d/rc.subr

rc_usercheck=NO

rc_pre() {
	if ! [[ -f /var/nsd/etc/nsd_server.key ||
	    -f /var/nsd/etc/nsd_server.pem ||
	    -f /var/nsd/etc/nsd_control.key ||
	    -f /var/nsd/etc/nsd_control.pem ]]; then
		/usr/sbin/nsd-control-setup >/dev/null 2>&1
	fi
}

rc_start() {
	${rcexec} "${daemon} ${daemon_flags} start"
}

rc_check() {
	${daemon} ${daemon_flags} status || return 1
}

rc_reload() {
	${daemon} ${daemon_flags} reconfig && ${daemon} ${daemon_flags} reload
}

rc_stop() {
	${daemon} ${daemon_flags} stop
}

rc_cmd $1
@


1.8
log
@ensure rc.d/nsd uses a correct exit code as per rc.subr(8); reported by
Ben Lovett, simpler diff from aja@@
@
text
@d3 1
a3 1
# $OpenBSD: nsd,v 1.7 2014/05/07 02:46:05 sthen Exp $
a9 1
pexp="nsd${daemon_flags:+ ${daemon_flags}}"
@


1.7
log
@pass daemon_flags to nsd-control when used to check/reload/stop nsd,
the only useful option here is to specify an alternative config path,
which must be used for these operations as well as for startup.
@
text
@d3 1
a3 1
# $OpenBSD: nsd,v 1.6 2014/01/10 17:41:39 sthen Exp $
d27 1
a27 1
	${daemon} ${daemon_flags} status
@


1.6
log
@Remove unnecessary rc_post from rc.d/nsd.

It was there to try and ensure that failure was reported if nsd stopped
shortly after startup (as it used to do if the address was in use, etc),
but this is no longer the case with nsd 4 which returns a failure at
startup in these cases, and having it there breaks properly printing
"(ok)" when stopping.
@
text
@d3 1
a3 1
# $OpenBSD: nsd,v 1.5 2013/11/26 13:01:30 sthen Exp $
d27 1
a27 1
	${daemon} status
d31 1
a31 1
	${daemon} reconfig && ${daemon} reload
d35 1
a35 1
	${daemon} stop
@


1.5
log
@update for NSD 4.0.0; generate keys for nsd-control if non-existent, and
use nsd-control to signal NSD.
@
text
@d3 1
a3 1
# $OpenBSD: nsd,v 1.4 2012/08/04 15:28:39 ajacoutot Exp $
a35 5
}

rc_post() {
	sleep 1
	rc_do rc_check || exit 0
@


1.4
log
@Set rc_usercheck to NO.
@
text
@d3 1
a3 1
# $OpenBSD: nsd,v 1.3 2012/01/16 17:51:42 camield Exp $
d5 2
a6 1
daemon="/usr/sbin/nsd"
d10 1
a10 1
rc_reload=NO
d13 20
a32 1
daemon_ctl="/usr/sbin/nsdc"
d35 1
a35 1
	${daemon_ctl} stop
d38 3
a40 2
rc_check() {
	${daemon_ctl} running
@


1.3
log
@Use nsdc to reliably stop nsd.

ok ajacoutot sthen
@
text
@d3 1
a3 1
# $OpenBSD: nsd,v 1.2 2011/12/13 13:45:38 ajacoutot Exp $
d10 1
@


1.2
log
@Set rc_reload to NO. In rc.d(8), `reload' means reloading the
configuration without service disruption which is not what -HUP does for
nsd(8).
Anyway, zone operations (...) should be done using nsdc(8) and not with
an rc script.

discussed with and ok sthen@@
@
text
@d3 1
a3 1
# $OpenBSD: nsd,v 1.1 2011/07/06 18:55:36 robert Exp $
d10 10
@


1.1
log
@Add rc.d(8) script for the system daemons that are restartable.
From now on rc(8) is going to call these scripts to start them up on boot
in the same order than before.
In addition the inetd and rwhod variables in rc.conf are deprecated so that
inetd_flags and rwhod_flags should be used. The old flags are still going
to be used for some time to allow users to switch.
There are more rc modifications to come later so let's put this in so
we can base more work on this.
It is important to mention that you can still keep using rc.local just
like the way you did before, and we have no intention to remove that either.

I'd also like to thank ajacoutot@@, halex@@, sthen@@ and schwarze@@ for working
on this with me.
@
text
@d3 1
a3 1
# $OpenBSD$
d8 2
@

