head	1.27;
access;
symbols
	OPENBSD_6_1_BASE:1.27
	OPENBSD_6_0:1.27.0.6
	OPENBSD_6_0_BASE:1.27
	OPENBSD_5_9:1.27.0.2
	OPENBSD_5_9_BASE:1.27
	OPENBSD_5_8:1.26.0.8
	OPENBSD_5_8_BASE:1.26
	OPENBSD_5_7:1.26.0.2
	OPENBSD_5_7_BASE:1.26
	OPENBSD_5_6:1.26.0.4
	OPENBSD_5_6_BASE:1.26
	OPENBSD_5_5:1.25.0.14
	OPENBSD_5_5_BASE:1.25
	OPENBSD_5_4:1.25.0.10
	OPENBSD_5_4_BASE:1.25
	OPENBSD_5_3:1.25.0.8
	OPENBSD_5_3_BASE:1.25
	OPENBSD_5_2:1.25.0.6
	OPENBSD_5_2_BASE:1.25
	OPENBSD_5_1_BASE:1.25
	OPENBSD_5_1:1.25.0.4
	OPENBSD_5_0:1.25.0.2
	OPENBSD_5_0_BASE:1.25
	OPENBSD_4_9:1.24.0.2
	OPENBSD_4_9_BASE:1.24
	OPENBSD_4_8:1.23.0.6
	OPENBSD_4_8_BASE:1.23
	OPENBSD_4_7:1.23.0.2
	OPENBSD_4_7_BASE:1.23
	OPENBSD_4_6:1.23.0.4
	OPENBSD_4_6_BASE:1.23
	OPENBSD_4_5:1.19.0.10
	OPENBSD_4_5_BASE:1.19
	OPENBSD_4_4:1.19.0.8
	OPENBSD_4_4_BASE:1.19
	OPENBSD_4_3:1.19.0.6
	OPENBSD_4_3_BASE:1.19
	OPENBSD_4_2:1.19.0.4
	OPENBSD_4_2_BASE:1.19
	OPENBSD_4_1:1.19.0.2
	OPENBSD_4_1_BASE:1.19
	OPENBSD_4_0:1.16.0.4
	OPENBSD_4_0_BASE:1.16
	OPENBSD_3_9:1.16.0.2
	OPENBSD_3_9_BASE:1.16
	OPENBSD_3_8:1.14.0.10
	OPENBSD_3_8_BASE:1.14
	OPENBSD_3_7:1.14.0.8
	OPENBSD_3_7_BASE:1.14
	OPENBSD_3_6:1.14.0.6
	OPENBSD_3_6_BASE:1.14
	OPENBSD_3_5:1.14.0.4
	OPENBSD_3_5_BASE:1.14
	OPENBSD_3_4:1.14.0.2
	OPENBSD_3_4_BASE:1.14
	OPENBSD_3_3:1.12.0.2
	OPENBSD_3_3_BASE:1.12
	OPENBSD_3_2:1.11.0.6
	OPENBSD_3_2_BASE:1.11
	OPENBSD_3_1:1.11.0.4
	OPENBSD_3_1_BASE:1.11
	OPENBSD_3_0:1.11.0.2
	OPENBSD_3_0_BASE:1.11
	OPENBSD_2_9:1.10.0.8
	OPENBSD_2_9_BASE:1.10
	OPENBSD_2_8:1.10.0.6
	OPENBSD_2_8_BASE:1.10
	OPENBSD_2_7:1.10.0.4
	OPENBSD_2_7_BASE:1.10
	OPENBSD_2_6:1.10.0.2
	OPENBSD_2_6_BASE:1.10
	OPENBSD_2_5:1.8.0.6
	OPENBSD_2_5_BASE:1.8
	OPENBSD_2_4:1.8.0.4
	OPENBSD_2_4_BASE:1.8
	OPENBSD_2_3:1.8.0.2
	OPENBSD_2_3_BASE:1.8
	OPENBSD_2_2:1.7.0.2
	OPENBSD_2_2_BASE:1.7
	OPENBSD_2_1:1.6.0.2
	OPENBSD_2_1_BASE:1.6
	OPENBSD_2_0:1.3.0.2
	OPENBSD_2_0_BASE:1.3
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@# @;


1.27
date	2015.08.14.03.02.07;	author rzalamena;	state Exp;
branches;
next	1.26;
commitid	PisPPvIXzvGpQidJ;

1.26
date	2014.04.18.10.00.48;	author schwarze;	state Exp;
branches;
next	1.25;

1.25
date	2011.07.07.23.09.46;	author guenther;	state Exp;
branches;
next	1.24;

1.24
date	2011.01.19.06.18.05;	author david;	state Exp;
branches;
next	1.23;

1.23
date	2009.05.25.21.31.24;	author schwarze;	state Exp;
branches;
next	1.22;

1.22
date	2009.05.18.19.57.56;	author schwarze;	state Exp;
branches;
next	1.21;

1.21
date	2009.05.10.19.27.25;	author schwarze;	state Exp;
branches;
next	1.20;

1.20
date	2009.05.09.17.15.49;	author schwarze;	state Exp;
branches;
next	1.19;

1.19
date	2007.02.02.14.52.48;	author ajacoutot;	state Exp;
branches;
next	1.18;

1.18
date	2006.10.26.12.20.55;	author ajacoutot;	state Exp;
branches;
next	1.17;

1.17
date	2006.10.06.04.50.31;	author hugh;	state Exp;
branches;
next	1.16;

1.16
date	2005.11.19.15.13.34;	author jmc;	state Exp;
branches;
next	1.15;

1.15
date	2005.11.12.16.14.37;	author jmc;	state Exp;
branches;
next	1.14;

1.14
date	2003.06.30.22.04.57;	author avsm;	state Exp;
branches;
next	1.13;

1.13
date	2003.04.08.20.42.42;	author millert;	state Exp;
branches;
next	1.12;

1.12
date	2003.01.14.08.12.41;	author jakob;	state Exp;
branches;
next	1.11;

1.11
date	2001.07.27.07.24.40;	author fgsch;	state Exp;
branches;
next	1.10;

1.10
date	99.09.19.23.15.28;	author alex;	state Exp;
branches;
next	1.9;

1.9
date	99.08.04.17.55.16;	author mickey;	state Exp;
branches;
next	1.8;

1.8
date	98.02.02.23.08.56;	author millert;	state Exp;
branches;
next	1.7;

1.7
date	97.09.15.09.54.40;	author deraadt;	state Exp;
branches;
next	1.6;

1.6
date	97.01.04.01.36.52;	author millert;	state Exp;
branches;
next	1.5;

1.5
date	97.01.03.23.33.50;	author millert;	state Exp;
branches;
next	1.4;

1.4
date	96.12.18.04.32.57;	author millert;	state Exp;
branches;
next	1.3;

1.3
date	96.05.26.10.25.32;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	95.12.19.13.14.15;	author david;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.37.57;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.37.57;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.27
log
@Move locate(1) database build directory back to /tmp and kill non-existent
/usr/tmp references.

Diff from Craig Skinner via tech@@ plus a /usr/tmp removal from me in the
updatedb script.

ok millert@@.
@
text
@#
#	$OpenBSD: weekly,v 1.26 2014/04/18 10:00:48 schwarze Exp $
#
# For local additions, create the file /etc/weekly.local.
# To get section headers, use the function next_part in weekly.local.
#
umask 022

PARTOUT=/var/log/weekly.part
MAINOUT=/var/log/weekly.out
install -o 0 -g 0 -m 600    /dev/null $PARTOUT
install -o 0 -g 0 -m 600 -b /dev/null $MAINOUT

start_part() {
	TITLE=$1
	exec > $PARTOUT 2>&1
}

end_part() {
	exec >> $MAINOUT 2>&1
	test -s $PARTOUT || return
	echo ""
	echo "$TITLE"
	cat $PARTOUT
}

next_part() {
	end_part
	start_part "$1"
}

run_script() {
	f=/etc/$1
	test -e $f || return
	if [ `stat -f '%Sp%u' $f | cut -b1,6,9,11-` != '---0' ]; then
		echo "$f has insecure permissions, skipping:"
		ls -l $f
		return
	fi
	. $f
}

start_part "Running weekly.local:"
run_script "weekly.local"

next_part "Rebuilding locate database:"
if [ -f /var/db/locate.database ]; then
	if TMP=`mktemp /var/db/locate.database.XXXXXXXXXX`; then
		trap 'rm -f $TMP; exit 1' 0 1 15
		UPDATEDB="/usr/libexec/locate.updatedb"
		echo "${UPDATEDB} --fcodes=- --tmpdir=${TMPDIR:-/tmp}" | \
		    nice -5 su -m nobody 2>/dev/null 1>$TMP
		if [ -s "$TMP" ]; then
			chmod 444 $TMP
			chown root:wheel $TMP
			mv -f $TMP /var/db/locate.database
		else
			echo "Not installing locate database; zero size"
		fi
	else
		echo "Not rebuilding locate database; can't create temp file"
	fi
fi

next_part "Rebuilding whatis databases:"
/usr/sbin/makewhatis ${MAKEWHATISARGS:--Q}

next_part "Doing login accounting:"
[ "X$LOGINACCOUNTING" = X1 ] && {
	ac -p | sort -nr -k 2
}

end_part
rm -f $PARTOUT

[ -s $MAINOUT ] && mail -s "`hostname` weekly output" root < $MAINOUT
@


1.26
log
@Switch to the new makewhatis(8)/apropos(1)/whatis(1) combo.
"commit the switch now" espie@@  "go for it" deraadt@@

See the apropos(1) manual for a description of what's new.
On machines where you want the full functionality,
run "sudo makewhatis" and put "MAKEWHATISARGS=' '" into weekly.local(8).
Otherwise, when upgrading via source, run "sudo makewhatis -Q".
@
text
@d2 1
a2 1
#	$OpenBSD: weekly,v 1.25 2011/07/07 23:09:46 guenther Exp $
d51 1
a51 1
		echo "${UPDATEDB} --fcodes=- --tmpdir=${TMPDIR:-/var/tmp}" | \
@


1.25
log
@Eliminate some $? tests by rolling the command into the condition

ok halex@@
@
text
@d2 1
a2 1
#	$OpenBSD: weekly,v 1.24 2011/01/19 06:18:05 david Exp $
d66 1
a66 1
/usr/libexec/makewhatis
@


1.24
log
@remove EOL whitespace
@
text
@d2 1
a2 1
#	$OpenBSD: weekly,v 1.23 2009/05/25 21:31:24 schwarze Exp $
d48 1
a48 2
	TMP=`mktemp /var/db/locate.database.XXXXXXXXXX`
	if [ $? -eq 0 ]; then
@


1.23
log
@polish comments, no functional change:
1) advertise *.local and next_part near the top of the three scripts
2) daily: mention smtpd(8) mailq behaviour (like for sendmail, postfix, exim)
3) weekly: drop a comment trivially rehashing the next two lines of code
documenting next_part in the scripts was suggested by jmc@@
ok sthen@@ okan@@ halex@@; "i won't object" ajacoutot@@
@
text
@d2 1
a2 1
#	$OpenBSD: weekly,v 1.22 2009/05/18 19:57:56 schwarze Exp $
d76 1
a76 1
                        
@


1.22
log
@/usr/libexec should not be put into the PATH
rely on the PATH set up in the root crontab(5), just like in monthly(8)
suggested by ajacoutot@@; "i like this" okan@@; feedback jmc@@ sthen@@;
"absolutely" deraadt@@
@
text
@d2 4
a5 1
#	$OpenBSD: weekly,v 1.21 2009/05/10 19:27:25 schwarze Exp $
a68 2
# If LOGINACCOUNTING is set to 1 in the environment, report user
# accounting information
@


1.21
log
@avoid unnecessary changes of the output
in order not to annoy parser scripts and their owners (like henning@@)
@
text
@d2 1
a2 1
#	$OpenBSD: weekly,v 1.20 2009/05/09 17:15:49 schwarze Exp $
a5 3
PATH=/bin:/sbin:/usr/sbin:/usr/bin:/usr/libexec
export PATH

d64 1
a64 1
makewhatis
@


1.20
log
@make weekly and monthly silent by default
add the same infrastructure to daily; silencing daily needs another step
discussed with ajacoutot@@ okan@@ todd@@ sthen@@ deraadt@@ jmc@@
"immediately commit" deraadt@@ (without seeing the final diff)
@
text
@d2 1
a2 1
#	$OpenBSD: weekly,v 1.19 2007/02/02 14:52:48 ajacoutot Exp $
d43 1
a43 1
start_part "Running /etc/weekly.local:"
@


1.19
log
@- enable weekly login accounting if LOGINACCOUNTING is set to 1 in the
environment so that it matches the ROOTBACKUP and CHECKFILESYSTEMS way
of doing things
- make the sort command use "-k" instead of the deprecated "+" option
(idea from mk@@)
- rotate /var/log/wtmp every week just after weekly ac(8) completes

ok mk@@
@
text
@a0 1
#!/bin/sh -
d2 1
a2 1
#	$OpenBSD: weekly,v 1.18 2006/10/26 12:20:55 ajacoutot Exp $
d9 13
a21 1
if [ -f /etc/weekly.local ]; then
d23 22
a44 3
	echo "Running weekly.local:"
	. /etc/weekly.local
fi
d46 1
a46 1
echo ""
a50 1
		echo "Rebuilding locate database:"
a63 2
else
	echo "Not rebuilding locate database; no /var/db/locate.database"
d66 1
a66 2
echo ""
echo "Rebuilding whatis databases:"
d71 1
a72 2
	echo ""
	echo "Doing login accounting:"
d75 5
@


1.18
log
@Force umask to 022 so we don't heritate 077 from root's crontab command
(output logs are still umask 077)

"i think this is right" deraadt@@
@
text
@d3 1
a3 1
#	$OpenBSD: weekly,v 1.17 2006/10/06 04:50:31 hugh Exp $
d43 7
a49 3
# echo ""
# echo "Doing login accounting:"
# ac -p | sort -nr +1
@


1.17
log
@Exit when asked to here too. Spotted by Theo.
@
text
@d3 1
a3 1
#	$OpenBSD: weekly,v 1.16 2005/11/19 15:13:34 jmc Exp $
d5 1
@


1.16
log
@remove unhelpful echo from the ac stuff;
ok millert@@
@
text
@d3 1
a3 1
#	$OpenBSD: weekly,v 1.15 2005/11/12 16:14:37 jmc Exp $
d19 1
a19 1
		trap 'rm -f $TMP' 0 1 15
@


1.15
log
@move the ac(8) stuff to weekly, rather than monthly, since by default
newsyslog truncates wtmp on a weekly basis; note that the ac stuff
remains commented out as before;

spotted by andreas bihlmaier;
ok deraadt@@
@
text
@d3 1
a3 1
#	$OpenBSD: weekly,v 1.14 2003/06/30 22:04:57 avsm Exp $
a44 2

#echo "."
@


1.14
log
@spacing nit, and a bit more randomness for mktemp
millert@@ ok
@
text
@d3 1
a3 1
#	$OpenBSD: weekly,v 1.13 2003/04/08 20:42:42 millert Exp $
d41 6
@


1.13
log
@Use POSIX chown semantics (user:group); noted by Leandro Costa
@
text
@d3 1
a3 1
#	$OpenBSD: weekly,v 1.12 2003/01/14 08:12:41 jakob Exp $
d9 1
a9 1
if [ -f /etc/weekly.local ];then
d17 1
a17 1
	TMP=`mktemp /var/db/locate.database.XXXXXX`
@


1.12
log
@use /var/tmp as default temporary directory when building locate database. ok millert@@
@
text
@d3 1
a3 1
#	$OpenBSD: weekly,v 1.11 2001/07/27 07:24:40 fgsch Exp $
d26 1
a26 1
			chown root.wheel $TMP
@


1.11
log
@remove clean.weekly from here. this can be added in weekly.local if
needed and we don't ship it anyway; millert@@ ok.
@
text
@d3 1
a3 1
#	$OpenBSD: weekly,v 1.10 1999/09/19 23:15:28 alex Exp $
d22 1
a22 1
		echo "${UPDATEDB} --fcodes=- --tmpdir=${TMPDIR:-/tmp}" | \
@


1.10
log
@Rebuild whatis databases.
@
text
@d3 1
a3 1
#	$OpenBSD: weekly,v 1.9 1999/08/04 17:55:16 mickey Exp $
a12 6
fi

if [ -f /usr/lib/uucp/clean.weekly ]; then
	echo ""
	echo "Cleaning up UUCP:"
	echo /usr/lib/uucp/clean.weekly | su daemon
@


1.9
log
@propagate TMPDIR into locate.updatedb
@
text
@d3 1
a3 1
#	$OpenBSD: weekly,v 1.8 1998/02/02 23:08:56 millert Exp $
d43 4
@


1.8
log
@No need to put a Subject: line.  We use "mail -s" in the crontab anyway.
@
text
@d3 1
a3 1
#	$OpenBSD: weekly,v 1.7 1997/09/15 09:54:40 deraadt Exp $
d27 2
a28 1
		echo "/usr/libexec/locate.updatedb --fcodes=-" | \
@


1.7
log
@delete dated stuff
@
text
@d3 1
a3 1
#	$OpenBSD: weekly,v 1.6 1997/01/04 01:36:52 millert Exp $
a7 3

host=`hostname -s`
echo "Subject: $host weekly run output"
@


1.6
log
@Use new options to locate.updatedb so we don't have to make the
database owned by non-root at any time.
@
text
@d3 1
a3 1
#	$OpenBSD: weekly,v 1.5 1997/01/03 23:33:50 millert Exp $
a17 32

#echo ""
#echo "Removing old .o files:"
#find /usr/src -name '*.o' -atime +21 -print -a -exec rm -f {} \;

# see if /usr/src exists and is local
# before looking there for checked-out files

#if [ -d /usr/src -a \
#  X"`find -f /usr/src ! -fstype local -prune -or -type d -print -prune`" != X ];
#then
#	echo "looking for checked out files:"
#	TDIR=/tmp/_checkout$$
#
#	if ! mkdir $TDIR ; then
#		echo "temp dir $TDIR already exists!  Probable spoof attempt."
#		ls -alF $TDIR
#	else
#		for file in `find -f /usr/src ! -fstype local -prune -or \
#		    -name 'p.*' -print | egrep 'SCCS/p\.'`; do
#			owner=`awk '{ print $3 }' $file`
#			echo "$owner	$file"
#			echo $file >> $TDIR/$owner
#		done | sed -e 's,SCCS/p.,,'
#		for file in $TDIR/*; do
#			sed -e 's,SCCS/p.,,' $file | \
#			    Mail -s 'checked out files' `basename $file`
#		done
#		rm -rf $TDIR
#	fi
#fi

a22 3
echo ""

# Rotation of message log now handled automatically by cron and 'newsyslog'
d30 2
a31 1
		echo "/usr/libexec/locate.updatedb --fcodes=-" | nice -5 su -m nobody 2>/dev/null 1>$TMP
@


1.5
log
@locate shell scripts now use mktemp(1) and weekly runs updatedb
as bin not nobody to avoid NFS problems.
@
text
@d3 1
a3 1
#	$OpenBSD: weekly,v 1.4 1996/12/18 04:32:57 millert Exp $
d18 1
d61 15
a75 5
	echo "Rebuilding locate database:"
	chmod 644 /var/db/locate.database
	chown bin /var/db/locate.database
	echo /usr/libexec/locate.updatedb | nice -5 su -m bin 2>/dev/null
	chown root.wheel /var/db/locate.database
@


1.4
log
@make commented-out stuff secure just in case anyone uncomments it.
@
text
@d3 1
a3 1
#	$OpenBSD: weekly,v 1.3 1996/05/26 10:25:32 deraadt Exp $
d62 2
a63 2
	chown nobody.nobody /var/db/locate.database
	echo /usr/libexec/locate.updatedb | nice -5 su -m nobody 2>/dev/null
@


1.3
log
@sync & label
@
text
@d3 1
a3 1
#	$OpenBSD$
d31 16
a46 12
#	mkdir $TDIR
#	for file in `find -f /usr/src ! -fstype local -prune -or \
#	    -name 'p.*' -print | egrep 'SCCS/p\.'`; do
#		owner=`awk '{ print $3 }' $file`
#		echo "$owner	$file"
#		echo $file >> $TDIR/$owner
#	done | sed -e 's,SCCS/p.,,'
#	for file in $TDIR/*; do
#		sed -e 's,SCCS/p.,,' $file | \
#		    Mail -s 'checked out files' `basename $file`
#	done
#	rm -rf $TDIR
@


1.2
log
@check for /etc/{daily,weekly,monthly}.local and run if they exist
@
text
@d3 1
a3 1
#	@@(#)weekly	5.14 (Berkeley) 6/23/91
@


1.1
log
@Initial revision
@
text
@d12 6
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
