head	1.15;
access;
symbols
	OPENBSD_3_1:1.14.0.4
	OPENBSD_3_1_BASE:1.14
	OPENBSD_3_0:1.14.0.2
	OPENBSD_3_0_BASE:1.14
	OPENBSD_2_9:1.13.0.12
	OPENBSD_2_9_BASE:1.13
	OPENBSD_2_8:1.13.0.10
	OPENBSD_2_8_BASE:1.13
	OPENBSD_2_7:1.13.0.8
	OPENBSD_2_7_BASE:1.13
	OPENBSD_2_6:1.13.0.6
	OPENBSD_2_6_BASE:1.13
	OPENBSD_2_5:1.13.0.4
	OPENBSD_2_5_BASE:1.13
	OPENBSD_2_4:1.13.0.2
	OPENBSD_2_4_BASE:1.13
	OPENBSD_2_3:1.12.0.2
	OPENBSD_2_3_BASE:1.12
	OPENBSD_2_2:1.10.0.2
	OPENBSD_2_2_BASE:1.10
	OPENBSD_2_1:1.8.0.2
	OPENBSD_2_1_BASE:1.8
	INITIAL_IMPORT:1.1.1.1
	GRAICHEN:1.1.1;
locks; strict;
comment	@# @;


1.15
date	2002.04.21.17.12.53;	author deraadt;	state dead;
branches;
next	1.14;

1.14
date	2001.06.23.19.44.56;	author deraadt;	state Exp;
branches;
next	1.13;

1.13
date	98.06.27.20.52.12;	author todd;	state Exp;
branches;
next	1.12;

1.12
date	98.03.30.07.15.22;	author deraadt;	state Exp;
branches;
next	1.11;

1.11
date	98.03.08.00.27.39;	author deraadt;	state Exp;
branches;
next	1.10;

1.10
date	97.10.01.22.13.01;	author deraadt;	state Exp;
branches;
next	1.9;

1.9
date	97.09.26.02.20.44;	author millert;	state Exp;
branches;
next	1.8;

1.8
date	97.05.15.12.33.06;	author graichen;	state Exp;
branches;
next	1.7;

1.7
date	97.05.14.18.39.05;	author niklas;	state Exp;
branches;
next	1.6;

1.6
date	97.05.12.11.26.22;	author graichen;	state Exp;
branches;
next	1.5;

1.5
date	97.05.12.11.21.12;	author graichen;	state Exp;
branches;
next	1.4;

1.4
date	97.05.10.22.38.30;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	97.05.03.17.06.29;	author graichen;	state Exp;
branches;
next	1.2;

1.2
date	97.05.03.16.50.56;	author niklas;	state Exp;
branches;
next	1.1;

1.1
date	97.05.03.00.35.22;	author graichen;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	97.05.03.00.35.22;	author graichen;	state Exp;
branches;
next	;


desc
@@


1.15
log
@simpleroot no longer used
@
text
@#	$OpenBSD: Makefile,v 1.14 2001/06/23 19:44:56 deraadt Exp $

REV=		${OSrev}

ARCHDIR=	${.CURDIR}/../${MACHINE}/simpleroot

.if exists(${ARCHDIR}/Makefile.inc)
.include "${ARCHDIR}/Makefile.inc"
.endif

MOUNT_POINT?=	/mnt
VND?=		svnd0
VND_DEV=	/dev/${VND}a
VND_RDEV=	/dev/r${VND}a
DISKTYPE=	simpleroot
PID!=		echo $$$$
IMAGEDIR?=	/var/tmp
REALIMAGE!=	echo ${IMAGEDIR}/image.${PID}
IMAGE?=		${IMAGEDIR}/simpleroot${REV}.fs
NEWFSOPTS?=
GZIP?=

LIST=		${ARCHDIR}/list

.ifndef DESTDIR
all:
	@@echo setenv DESTDIR before makeing a miniroot!
	@@false
.else

all:
	dd if=/dev/zero of=${REALIMAGE} count=${IMAGESIZE}
	vnconfig -v -c ${VND} ${REALIMAGE}
	disklabel -w -r ${VND} ${DISKTYPE}
.ifdef BOOT_DISKLABEL
	disklabel -B ${BOOT_DISKLABEL} ${VND} ${DISKTYPE}
.endif
	newfs ${NEWFSOPTS} ${VND_RDEV}
	mount ${VND_DEV} ${MOUNT_POINT}
.ifdef BOOT_INSTALLBOOT
	/usr/mdec/installboot -v ${MOUNT_POINT}/boot ${BOOT_INSTALLBOOT} ${VND}
.endif
	cd ${DESTDIR} && tar cf - `cat ${LIST}` | ( cd ${MOUNT_POINT}; \
	  tar xpf - )
	cp ${.CURDIR}/install.sh ${MOUNT_POINT}/install
	chmod 755 ${MOUNT_POINT}/install
	sed "/^VERSION=/s/=.*/=${REV}/" < ${.CURDIR}/install.sub \
	  > ${MOUNT_POINT}/install.sub
	sed -e "s/^ARCH=ARCH$/ARCH=`arch -s`/" \
	    ${.CURDIR}/../${MACHINE}/install.md > ${MOUNT_POINT}/install.md
	mkdir -p ${MOUNT_POINT}/mnt2
.if exists(/sbin/ldconfig)
	/usr/sbin/chroot ${MOUNT_POINT} /sbin/ldconfig
.endif
	( cd ${MOUNT_POINT} && \
	tar cf - .??* * | ${GZIP} ${GZIPFLAGS} \
	  > ${IMAGEDIR}/simpleroot${REV}.tar${GZIPEXT} )
	@@echo ""
	@@df -i ${MOUNT_POINT}
	@@echo ""
	umount ${MOUNT_POINT}
	vnconfig -u ${VND}
	cp ${REALIMAGE} ${IMAGE}
.if (${GZIP} == "gzip")
	${GZIP} ${IMAGE}
.endif
	rm ${REALIMAGE}

unconfig:
	-umount -f ${MOUNT_POINT}
	-vnconfig -u ${VND_DEV}
	-/bin/rm -f ${IMAGE}

clean cleandir:
	/bin/rm -f core ${IMAGE}

beforeinstall:
	cp ${IMAGE} ${DESTDIR}/snapshot

.endif	# DESTDIR check
.include <bsd.obj.mk>
.include <bsd.subdir.mk>
@


1.14
log
@argh.  stop using kernfs, using dmesg using sysctl.  encode ARCH into
install.md at build time.  remove some crud.  and the icing on the cake:
skip testing all this until next week
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.13 1998/06/27 20:52:12 todd Exp $
@


1.13
log
@s/23/${OSrev}/
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.12 1998/03/30 07:15:22 deraadt Exp $
d49 2
a50 2
	cp ${.CURDIR}/../${MACHINE}/install.md ${MOUNT_POINT}/install.md
	mkdir -p ${MOUNT_POINT}/kern
@


1.12
log
@argh
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.11 1998/03/08 00:27:39 deraadt Exp $
d3 1
a3 1
REV=		23
@


1.11
log
@moving to 2.3
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.10 1997/10/01 22:13:01 deraadt Exp $
d21 1
@


1.10
log
@21 -> 22
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.9 1997/09/26 02:20:44 millert Exp $
d3 1
a3 1
REV=		22
@


1.9
log
@Don't specify disktype to newfs when we already have a label.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.8 1997/05/15 12:33:06 graichen Exp $
d3 1
a3 2
# Revision is 2.1
REV=		21
@


1.8
log
@also create /kern & /mnt2 directories required for the installation
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.7 1997/05/14 18:39:05 niklas Exp $
d38 1
a38 1
	newfs ${NEWFSOPTS} ${VND_RDEV} ${DISKTYPE}
@


1.7
log
@Use svnds and remove ugly cache flushing
@
text
@d1 1
a1 1
#	$OpenBSD$
d50 2
@


1.6
log
@run ldconfig on the created simpleroot where required
@
text
@d1 2
d13 1
a13 1
VND?=		vnd0
a60 1
	cat /*bin/* > /dev/null
@


1.5
log
@add install scripts for the pmax
@
text
@d48 3
@


1.4
log
@install simpleroot
@
text
@d42 6
a47 1
	  tar xpf - ) && \
@


1.3
log
@forgot /boot at the installboot argument
@
text
@d66 3
@


1.2
log
@Introduce IMAGEDIR to control where the image gets built.
  Fix argument to vnconfig -u.
@
text
@d39 1
a39 1
	/usr/mdec/installboot -v ${MOUNT_POINT} ${BOOT_INSTALLBOOT} ${VND}
@


1.1
log
@Initial revision
@
text
@d16 3
a18 2
REALIMAGE!=	echo /var/tmp/image.${PID}
IMAGE?=		/var/tmp/simpleroot${REV}.fs
d45 1
a45 1
	  > /var/tmp/simpleroot${REV}.tar${GZIPEXT} )
d50 1
a50 1
	vnconfig -u ${VND_DEV}
@


1.1.1.1
log
@simpleroot: rootfilesystem for installing the pmax and maybe the alpha
on those machines you can't boot off the swap partition and thus mini-
root doesn't work - ramdisk doesn't work due to exec format problems
... so the installation will be simply dd'ing a complete rootfilesystem
image onto the disk and install the rest from there - simpleroot is this
complete rootfilesystem image - the name simpleroot comes from niklas -
thanks to him for the idea how to put it here into the distrib tree
@
text
@@

