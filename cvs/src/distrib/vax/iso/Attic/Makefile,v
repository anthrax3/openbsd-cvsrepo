head	1.17;
access;
symbols
	OPENBSD_5_9:1.16.0.2
	OPENBSD_5_9_BASE:1.16
	OPENBSD_5_8:1.15.0.6
	OPENBSD_5_8_BASE:1.15
	OPENBSD_5_7:1.15.0.2
	OPENBSD_5_7_BASE:1.15
	OPENBSD_5_6:1.13.0.6
	OPENBSD_5_6_BASE:1.13
	OPENBSD_5_5:1.13.0.4
	OPENBSD_5_5_BASE:1.13
	OPENBSD_5_4:1.9.0.2
	OPENBSD_5_4_BASE:1.9
	OPENBSD_5_3:1.8.0.4
	OPENBSD_5_3_BASE:1.8
	OPENBSD_5_2:1.8.0.2
	OPENBSD_5_2_BASE:1.8
	OPENBSD_5_1_BASE:1.7
	OPENBSD_5_1:1.7.0.4
	OPENBSD_5_0:1.7.0.2
	OPENBSD_5_0_BASE:1.7
	OPENBSD_4_9:1.6.0.2
	OPENBSD_4_9_BASE:1.6
	OPENBSD_4_8:1.5.0.6
	OPENBSD_4_8_BASE:1.5
	OPENBSD_4_7:1.5.0.2
	OPENBSD_4_7_BASE:1.5
	OPENBSD_4_6:1.5.0.4
	OPENBSD_4_6_BASE:1.5
	OPENBSD_4_5:1.3.0.2
	OPENBSD_4_5_BASE:1.3
	OPENBSD_4_4:1.2.0.4
	OPENBSD_4_4_BASE:1.2
	OPENBSD_4_3:1.2.0.2
	OPENBSD_4_3_BASE:1.2;
locks; strict;
comment	@# @;


1.17
date	2016.03.09.16.28.45;	author deraadt;	state dead;
branches;
next	1.16;
commitid	OSDG2O3Cgeifnf1W;

1.16
date	2015.10.15.19.28.32;	author miod;	state Exp;
branches;
next	1.15;
commitid	JAihZ7SpbEYKsmM1;

1.15
date	2014.09.21.13.44.45;	author deraadt;	state Exp;
branches;
next	1.14;
commitid	oU9URDYHjCPgvf88;

1.14
date	2014.08.26.21.36.44;	author deraadt;	state Exp;
branches;
next	1.13;
commitid	d7fVtFqlTBeFuAsD;

1.13
date	2014.03.02.05.46.26;	author deraadt;	state Exp;
branches;
next	1.12;

1.12
date	2014.02.28.22.53.06;	author deraadt;	state Exp;
branches;
next	1.11;

1.11
date	2014.01.24.00.34.22;	author deraadt;	state Exp;
branches;
next	1.10;

1.10
date	2014.01.12.21.58.00;	author deraadt;	state Exp;
branches;
next	1.9;

1.9
date	2013.07.16.17.31.39;	author deraadt;	state Exp;
branches;
next	1.8;

1.8
date	2012.04.26.15.54.54;	author deraadt;	state Exp;
branches;
next	1.7;

1.7
date	2011.04.18.16.52.10;	author thib;	state Exp;
branches;
next	1.6;

1.6
date	2010.10.18.05.40.47;	author deraadt;	state Exp;
branches;
next	1.5;

1.5
date	2009.05.07.17.03.22;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	2009.04.17.03.58.55;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	2008.08.25.17.18.55;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	2008.02.24.19.32.48;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	2008.02.24.11.52.17;	author maja;	state Exp;
branches;
next	;


desc
@@


1.17
log
@We are done providing support for the vax.
lots of agreement.
@
text
@#	$OpenBSD: Makefile,v 1.16 2015/10/15 19:28:32 miod Exp $

TOP=	${.CURDIR}/..

.include "${TOP}/Makefile.inc"

CDROM=		install${REV}.iso
RELXDIR?=	/home/relx-${MACHINE}
RELDIR?=	/home/rel-${MACHINE}

BASE=		${RELDIR}/base${OSrev}.tgz ${RELDIR}/comp${OSrev}.tgz \
		${RELDIR}/game${OSrev}.tgz ${RELDIR}/man${OSrev}.tgz \
		${RELDIR}/bsd ${RELDIR}/bsd.rd \
		${RELDIR}/INSTALL.${MACHINE}
XBASE=		${RELXDIR}/xbase${OSrev}.tgz ${RELXDIR}/xfont${OSrev}.tgz \
		${RELXDIR}/xshare${OSrev}.tgz ${RELXDIR}/xserv${OSrev}.tgz

MOUNT_POINT?=	/mnt
VND?=		vnd0
VND_DEV=	/dev/${VND}a
VND_RDEV=	/dev/r${VND}a
DISKTYPE=	isoroot
PID!=		echo $$$$
ISOIMAGE!=	echo image.${PID}
ISOSIZE=	798600	# 33*11*2200
NEWFSOPTS=	-t ffs -m 0 -o space -f 1024 -b 8192 -i 8192 -s ${ISOSIZE}

all: ${CDROM}

${CDROM}: ${BASE} ${XBASE}
	-rm -f ${.OBJDIR}/image.*
	dd if=/dev/zero of=${ISOIMAGE} count=${ISOSIZE}
	vnconfig -v -c ${VND} ${ISOIMAGE}
	disklabel -w ${VND} ${DISKTYPE}
	newfs ${NEWFSOPTS} ${VND_RDEV}
	mount ${VND_DEV} ${MOUNT_POINT}
	installboot -vr ${MOUNT_POINT} ${VND} \
	    ${DESTDIR}/usr/mdec/xxboot ${DESTDIR}/usr/mdec/boot
	cp ${RELDIR}/bsd.rd ${MOUNT_POINT}/bsd
	mkdir -p ${MOUNT_POINT}/${OSREV}/${MACHINE}

	cp -p ${BASE} ${MOUNT_POINT}/${OSREV}/${MACHINE}
	cp -p ${XBASE} ${MOUNT_POINT}/${OSREV}/${MACHINE}

	cat ${RELDIR}/SHA256 ${RELXDIR}/SHA256 > \
	    ${MOUNT_POINT}/${OSREV}/${MACHINE}/SHA256
	# XXX no SHA256.sig

	@@echo ""
	@@df -i ${MOUNT_POINT}
	@@echo ""
	umount ${MOUNT_POINT}
	vnconfig -u ${VND}
	mv ${ISOIMAGE} ${CDROM}

install:
	cp ${CDROM} ${RELDIR}/

clean cleandir:
	/bin/rm -f ${CDROM} ${.OBJDIR}/image.*

unconfig:
	-umount /mnt
	-vnconfig -u vnd0

.include <bsd.obj.mk>
.include <bsd.subdir.mk>
@


1.16
log
@Use MI installboot instead of disklabel -B to install boot blocks.
ok krw@@ deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.15 2014/09/21 13:44:45 deraadt Exp $
@


1.15
log
@xetc set does not go onto little iso
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.14 2014/08/26 21:36:44 deraadt Exp $
a25 2
BOOT=		${DESTDIR}/usr/mdec/boot
BOOTXX=		${DESTDIR}/usr/mdec/xxboot
d30 1
a30 1
${CDROM}: ${BASE} ${XBASE} ${BOOT} ${BOOTXX}
d37 2
a38 1
	cp ${BOOT} ${MOUNT_POINT}/
a48 1
	disklabel -B -b ${BOOTXX} ${VND}
@


1.14
log
@no more exposed etc set
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.13 2014/03/02 05:46:26 deraadt Exp $
d15 2
a16 3
XBASE=		${RELXDIR}/xbase${OSrev}.tgz ${RELXDIR}/xetc${OSrev}.tgz \
		${RELXDIR}/xfont${OSrev}.tgz ${RELXDIR}/xshare${OSrev}.tgz \
		${RELXDIR}/xserv${OSrev}.tgz
@


1.13
log
@Unfortunately... the "full-size downloadable" ISOs will ship without
internal-signing, because the procedures ran into some snags we can't
fix in time for release...
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.12 2014/02/28 22:53:06 deraadt Exp $
d12 1
a12 2
		${RELDIR}/etc${OSrev}.tgz ${RELDIR}/game${OSrev}.tgz \
		${RELDIR}/man${OSrev}.tgz \
@


1.12
log
@Put signatures in the right place on the media
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.11 2014/01/24 00:34:22 deraadt Exp $
d47 4
a50 2
	cp -p ${RELDIR}/.i-SHA256 ${MOUNT_POINT}/${OSREV}/${MACHINE}/SHA256
	cp -p ${RELDIR}/.i-SHA256.sig ${MOUNT_POINT}/${OSREV}/${MACHINE}/SHA256.sig
@


1.11
log
@Refactor the install*.iso creation in regards to signing.
ok todd
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.10 2014/01/12 21:58:00 deraadt Exp $
d47 2
a48 2
	cp -p ${RELDIR}/.i-SHA256 ${.OBJDIR}/cd-dir/${OSREV}/${MACHINE}/SHA256
	cp -p ${RELDIR}/.i-SHA256.sig ${.OBJDIR}/cd-dir/${OSREV}/${MACHINE}/SHA256.sig
d63 4
@


1.10
log
@Place a SHA256 (not SHA256.sig, sorry not yet) onto the install*.iso
media to give some upcoming changes a chance of working.

Long discussions with todd and rpe
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.9 2013/07/16 17:31:39 deraadt Exp $
d44 1
d47 3
a49 2
	cat ${RELDIR}/SHA256 ${RELXDIR}/SHA256 > \
		${MOUNT_POINT}/${OSREV}/${MACHINE}/SHA256
a59 5
	# update the SHA256 file
	grep -v ${CDROM} ${RELDIR}/SHA256 > ${RELDIR}/SHA256.new
	sum -a sha256 ${CDROM} >> ${RELDIR}/SHA256.new
	sort ${RELDIR}/SHA256.new > ${RELDIR}/SHA256
	rm ${RELDIR}/SHA256.new
@


1.9
log
@make more room because ELF is bigger
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.8 2012/04/26 15:54:54 deraadt Exp $
d46 2
@


1.8
log
@grow the iso
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.7 2011/04/18 16:52:10 thib Exp $
d27 1
a27 1
ISOSIZE=	617100	# 33*11*1700
@


1.7
log
@Deprecate vnds in favour of svnds.

In effect, this removes the "old" vndX nodes, and renames
the svndX nodes to vndX.

Old svndX nodes will still continue to work though, for now.

Cleanup accordingly.

ok deraadt@@, todd@@
comments and ok on the man page bits from jmc@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.6 2010/10/18 05:40:47 deraadt Exp $
d27 1
a27 1
ISOSIZE=	580800	# 33*11*1600
@


1.6
log
@no more misc set
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.5 2009/05/07 17:03:22 deraadt Exp $
d21 1
a21 1
VND?=		svnd0
@


1.5
log
@vax iso has to become a teeny bit bigger
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.4 2009/04/17 03:58:55 deraadt Exp $
d13 1
a13 1
		${RELDIR}/man${OSrev}.tgz ${RELDIR}/misc${OSrev}.tgz \
@


1.4
log
@For SHA256 hashes to be ready to go onto the install media, we must
build the sets before we build the media.  While there we can get rid
of DESTDIR/snapshot too, and simply install straight into RELEASEDIR.
(This also ends up saving an astounding amount of traffic/latency in a nfs
environment)
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.3 2008/08/25 17:18:55 deraadt Exp $
d27 1
a27 1
ISOSIZE=	547041	# 33*11*1507
@


1.3
log
@use ?= for adjusting RELXDIR for all sets
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.2 2008/02/24 19:32:48 deraadt Exp $
d56 5
@


1.2
log
@get REV, and make this more like other arch code
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.1 2008/02/24 11:52:17 maja Exp $
d8 1
a8 1
RELXDIR=	/home/relx-${MACHINE}
@


1.1
log
@Add an iso image, based on ramdisk and amd64 iso. -moj
@
text
@d1 1
a1 1
#	$OpenBSD$
d5 2
d10 10
a19 1
DESTDIR?=	/home/dest-${MACHINE}
a30 9

BASE=		${RELDIR}/base${OSrev}.tgz ${RELDIR}/comp${OSrev}.tgz \
		${RELDIR}/etc${OSrev}.tgz ${RELDIR}/game${OSrev}.tgz \
		${RELDIR}/man${OSrev}.tgz ${RELDIR}/misc${OSrev}.tgz \
		${RELDIR}/bsd ${RELDIR}/bsd.rd \
		${RELDIR}/INSTALL.${MACHINE}
XBASE=		${RELXDIR}/xbase${OSrev}.tgz ${RELXDIR}/xetc${OSrev}.tgz \
		${RELXDIR}/xfont${OSrev}.tgz ${RELXDIR}/xshare${OSrev}.tgz \
		${RELXDIR}/xserv${OSrev}.tgz
@

