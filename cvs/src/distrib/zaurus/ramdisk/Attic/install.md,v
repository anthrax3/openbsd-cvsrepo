head	1.42;
access;
symbols
	OPENBSD_6_0:1.41.0.4
	OPENBSD_6_0_BASE:1.41
	OPENBSD_5_9:1.41.0.2
	OPENBSD_5_9_BASE:1.41
	OPENBSD_5_8:1.35.0.4
	OPENBSD_5_8_BASE:1.35
	OPENBSD_5_7:1.31.0.2
	OPENBSD_5_7_BASE:1.31
	OPENBSD_5_6:1.31.0.4
	OPENBSD_5_6_BASE:1.31
	OPENBSD_5_5:1.29.0.2
	OPENBSD_5_5_BASE:1.29
	OPENBSD_5_4:1.28.0.6
	OPENBSD_5_4_BASE:1.28
	OPENBSD_5_3:1.28.0.4
	OPENBSD_5_3_BASE:1.28
	OPENBSD_5_2:1.28.0.2
	OPENBSD_5_2_BASE:1.28
	OPENBSD_5_1_BASE:1.27
	OPENBSD_5_1:1.27.0.4
	OPENBSD_5_0:1.27.0.2
	OPENBSD_5_0_BASE:1.27
	OPENBSD_4_9:1.26.0.4
	OPENBSD_4_9_BASE:1.26
	OPENBSD_4_8:1.26.0.2
	OPENBSD_4_8_BASE:1.26
	OPENBSD_4_7:1.24.0.2
	OPENBSD_4_7_BASE:1.24
	OPENBSD_4_6:1.24.0.4
	OPENBSD_4_6_BASE:1.24
	OPENBSD_4_5:1.16.0.4
	OPENBSD_4_5_BASE:1.16
	OPENBSD_4_4:1.16.0.2
	OPENBSD_4_4_BASE:1.16
	OPENBSD_4_3:1.14.0.2
	OPENBSD_4_3_BASE:1.14
	OPENBSD_4_2:1.12.0.2
	OPENBSD_4_2_BASE:1.12
	OPENBSD_4_1:1.9.0.2
	OPENBSD_4_1_BASE:1.9
	OPENBSD_4_0:1.8.0.2
	OPENBSD_4_0_BASE:1.8
	OPENBSD_3_9:1.7.0.4
	OPENBSD_3_9_BASE:1.7
	OPENBSD_3_8:1.7.0.2
	OPENBSD_3_8_BASE:1.7
	OPENBSD_3_7:1.2.0.2
	OPENBSD_3_7_BASE:1.2;
locks; strict;
comment	@# @;


1.42
date	2016.09.03.13.37.40;	author guenther;	state dead;
branches;
next	1.41;
commitid	6T3r4QcMFKe3Fo5T;

1.41
date	2016.02.08.17.28.09;	author krw;	state Exp;
branches;
next	1.40;
commitid	4nj4L34RoKX0PFN0;

1.40
date	2015.12.29.11.16.14;	author rpe;	state Exp;
branches;
next	1.39;
commitid	dPgVJD33gNmmCKz4;

1.39
date	2015.12.18.16.20.58;	author rpe;	state Exp;
branches;
next	1.38;
commitid	VkQ4KC1oXExBZv81;

1.38
date	2015.12.02.21.17.17;	author krw;	state Exp;
branches;
next	1.37;
commitid	qjXM8wxHbdPw7A4U;

1.37
date	2015.11.09.20.54.12;	author rpe;	state Exp;
branches;
next	1.36;
commitid	euu2kEavGhIGtt10;

1.36
date	2015.10.25.10.20.51;	author krw;	state Exp;
branches;
next	1.35;
commitid	hwNh1w1pPCoWC2Xa;

1.35
date	2015.06.02.19.54.07;	author rpe;	state Exp;
branches;
next	1.34;
commitid	zUqrjWrWSBxkCmbI;

1.34
date	2015.06.02.19.39.19;	author rpe;	state Exp;
branches;
next	1.33;
commitid	JUhqCleEkW5lHyMG;

1.33
date	2015.05.31.19.40.11;	author rpe;	state Exp;
branches;
next	1.32;
commitid	p6r5f9n0C0WoWNND;

1.32
date	2015.05.04.19.55.27;	author rpe;	state Exp;
branches;
next	1.31;
commitid	NyWrBKI5Tnb4FUEi;

1.31
date	2014.08.06.16.13.48;	author ajacoutot;	state Exp;
branches;
next	1.30;
commitid	2QQO7bSXEPixQQkd;

1.30
date	2014.08.05.13.15.51;	author deraadt;	state Exp;
branches;
next	1.29;
commitid	wtNrX8eXftNfOakG;

1.29
date	2013.11.16.18.37.27;	author rpe;	state Exp;
branches;
next	1.28;

1.28
date	2012.07.10.14.25.00;	author halex;	state Exp;
branches;
next	1.27;

1.27
date	2011.04.17.20.57.11;	author krw;	state Exp;
branches;
next	1.26;

1.26
date	2010.08.08.21.06.06;	author krw;	state Exp;
branches;
next	1.25;

1.25
date	2010.08.08.17.02.14;	author krw;	state Exp;
branches;
next	1.24;

1.24
date	2009.06.11.18.52.42;	author deraadt;	state Exp;
branches;
next	1.23;

1.23
date	2009.06.04.00.44.48;	author krw;	state Exp;
branches;
next	1.22;

1.22
date	2009.06.02.16.23.45;	author krw;	state Exp;
branches;
next	1.21;

1.21
date	2009.05.11.17.13.07;	author deraadt;	state Exp;
branches;
next	1.20;

1.20
date	2009.04.25.03.21.51;	author deraadt;	state Exp;
branches;
next	1.19;

1.19
date	2009.04.12.12.56.02;	author krw;	state Exp;
branches;
next	1.18;

1.18
date	2009.04.12.01.35.01;	author krw;	state Exp;
branches;
next	1.17;

1.17
date	2009.04.10.23.11.17;	author krw;	state Exp;
branches;
next	1.16;

1.16
date	2008.06.26.05.42.04;	author ray;	state Exp;
branches;
next	1.15;

1.15
date	2008.03.23.14.03.55;	author krw;	state Exp;
branches;
next	1.14;

1.14
date	2008.03.04.18.09.37;	author deraadt;	state Exp;
branches;
next	1.13;

1.13
date	2008.03.04.00.36.38;	author krw;	state Exp;
branches;
next	1.12;

1.12
date	2007.05.31.20.28.23;	author robert;	state Exp;
branches;
next	1.11;

1.11
date	2007.05.31.03.51.56;	author robert;	state Exp;
branches;
next	1.10;

1.10
date	2007.05.29.21.13.56;	author robert;	state Exp;
branches;
next	1.9;

1.9
date	2007.02.11.18.59.31;	author krw;	state Exp;
branches;
next	1.8;

1.8
date	2006.03.15.16.13.30;	author deraadt;	state Exp;
branches;
next	1.7;

1.7
date	2005.04.28.16.26.15;	author deraadt;	state Exp;
branches;
next	1.6;

1.6
date	2005.04.28.06.48.34;	author deraadt;	state Exp;
branches;
next	1.5;

1.5
date	2005.04.24.18.51.00;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	2005.04.02.14.34.46;	author krw;	state Exp;
branches;
next	1.3;

1.3
date	2005.03.27.15.13.50;	author krw;	state Exp;
branches;
next	1.2;

1.2
date	2005.01.16.19.24.55;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	2004.12.31.00.14.07;	author drahn;	state Exp;
branches;
next	;


desc
@@


1.42
log
@Retire zaurus, as it hasn't made the EABI jump and will be permanently broken
shortly when we use the hardware thread register in userland
@
text
@#	$OpenBSD: install.md,v 1.41 2016/02/08 17:28:09 krw Exp $
#
#
# Copyright (c) 1996 The NetBSD Foundation, Inc.
# All rights reserved.
#
# This code is derived from software contributed to The NetBSD Foundation
# by Jason R. Thorpe.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS
# ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
# TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
# PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE
# LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
# CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
# SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
# INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
# CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
# ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
# POSSIBILITY OF SUCH DAMAGE.
#
#
# machine dependent section of installation/upgrade script.
#

MDXDM=y

md_installboot() {
}

md_prep_fdisk() {
	local _disk=$1 _q _d

	while :; do
		_d=whole
		if disk_has $_disk mbr; then
			fdisk $_disk
			if disk_has $_disk mbr openbsd; then
				_q=", use the (O)penBSD area"
				_d=OpenBSD
			fi
		else
			echo "MBR has invalid signature; not showing it."
		fi
		ask "Use (W)hole disk$_q or (E)dit the MBR?" "$_d"
		case $resp in
		[wW]*)
			echo -n "Setting OpenBSD MBR partition to whole $_disk..."
			fdisk -iy $_disk >/dev/null
			echo "done."
			return ;;
		[eE]*)
			# Manually configure the MBR.
			cat <<__EOT

You will now create a single MBR partition to contain your OpenBSD data. This
partition must have an id of 'A6'; must *NOT* overlap other partitions; and
must be marked as the only active partition.  Inside the fdisk command, the
'manual' command describes all the fdisk commands in detail.

$(fdisk ${_disk})
__EOT
			fdisk -e ${_disk}
			disk_has $_disk mbr openbsd && return
			echo No OpenBSD partition in MBR, try again. ;;
		[oO]*)
			[[ $_d == OpenBSD ]] || continue
			return ;;
		esac
	done
}

md_prep_disklabel() {
	local _disk=$1 _f=/tmp/fstab.$1

	md_prep_fdisk $_disk

	disklabel_autolayout $_disk $_f || return
	[[ -s $_f ]] && return

	# Edit disklabel manually.
	# Abandon all hope, ye who enter here.
	disklabel -F $_f -E $_disk
}

md_congrats() {
	val=`ztsscale`
	case $? in
	0)
		echo 
		grep -v '^mouse\.scale.*$' /mnt/etc/wsconsctl.conf \
		     >/tmp/wsconsctl.conf 2>/dev/null
		echo $val "# see ztsscale(8)" >> /tmp/wsconsctl.conf
		cp /tmp/wsconsctl.conf /mnt/etc/wsconsctl.conf
		;;
	esac
}

md_consoleinfo() {
	local _u _d=com

	for _u in $(scan_dmesg "/^$_d\([0-9]\) .*/s//\1/p"); do
		if [[ $_d$_u == $CONSOLE || -z $CONSOLE ]]; then
			CDEV=$_d$_u
			CPROM=com$_u
			CTTY=tty0$_u
			return
		fi
	done
}
@


1.41
log
@If manual disklabel editing is requested during install, don't emit
verbiage explaining what disklabels are.

If you don't know, you should be using (A)uto!

ok rpe@@ halex@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.40 2015/12/29 11:16:14 rpe Exp $
@


1.40
log
@Change patterns in case-blocks from a*|A* to [aA]*

OK halex@@ krw@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.39 2015/12/18 16:20:58 rpe Exp $
d90 2
a91 12
	cat <<__EOT

You will now create an OpenBSD disklabel inside the OpenBSD MBR
partition. The disklabel defines how OpenBSD splits up the MBR partition
into OpenBSD partitions in which filesystems and swap space are created.
You must provide each filesystem's mountpoint in this program.

The offsets used in the disklabel are ABSOLUTE, i.e. relative to the
start of the disk, NOT the start of the OpenBSD MBR partition.

__EOT

@


1.39
log
@Introduce a new function disk_has() to inspect a disk if it has a
partition-table of a certain type and optionally if it has a partition
of a certain type.

Use disk_has() in the install.md script to replace all the various
"fdisk <disk> | grep <pattern>" commands greatly simplifying things.

positive feedback from sthen@@
"time to get it really tested" deraadt@@
OK krw@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.38 2015/12/02 21:17:17 krw Exp $
d56 1
a56 1
		w*|W*)
d61 1
a61 1
		e*|E*)
d75 1
a75 1
		o*|O*)
@


1.38
log
@If (O)penBSD is not offered as a partitioning option, do not accept
'O*|o*' as a valid response. Ignore it as we do other invalid input.

armv7 is special case to be handled separately.

Noticed by kettenis@@.

ok deraadt@@ rpe@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.37 2015/11/09 20:54:12 rpe Exp $
d45 1
a45 1
		if fdisk $_disk | grep -q 'Signature: 0xAA55'; then
d47 1
a47 1
			if fdisk $_disk | grep -q '^..: A6 '; then
d73 1
a73 1
			fdisk $_disk | grep -q ' A6 ' && return
@


1.37
log
@Fix commas in "Use (W)hole disk MBR..." question.

OK jmc@@ krw@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.36 2015/10/25 10:20:51 krw Exp $
d75 3
a77 1
		o*|O*)	return ;;
@


1.36
log
@Use 'fdisk -i', instead of 'fdisk -e' with a here document of
'reinit;update;write;quit'. They've done the same thing for some
time now.

Tweaks & test from rpe@@.

ok rpe@@ deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.35 2015/06/02 19:54:07 rpe Exp $
d48 1
a48 1
				_q=", use the (O)penBSD area,"
@


1.35
log
@Remove the $FSTABFLAG variable and use -F directly. The installer
uses disklabel UIDs unconditionally for a while already.

OK krw@@
"looks good" deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.34 2015/06/02 19:39:19 rpe Exp $
d58 1
a58 6
			fdisk -e ${_disk} <<__EOT >/dev/null
reinit
update
write
quit
__EOT
@


1.34
log
@Replace
  [[ -n $(foo | grep 'bar') ]]
with
  foo | grep -q 'bar'

OK halex@@ krw@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.33 2015/05/31 19:40:11 rpe Exp $
d105 1
a105 1
	disklabel $FSTABFLAG $_f -E $_disk
@


1.33
log
@Replace identical code in the MD scripts of the installer with a new
MI function disklabel_autolayout() which now handles all aspects of
the disklabel auto-layout and autopartitioning case for the root disk.
Remove get_disklabel_template() and merge it with the new function.

"move forward" deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.32 2015/05/04 19:55:27 rpe Exp $
d45 1
a45 1
		if [[ -n $(fdisk $_disk | grep 'Signature: 0xAA55') ]]; then
d47 1
a47 1
			if [[ -n $(fdisk $_disk | grep '^..: A6 ') ]]; then
d78 1
a78 1
			[[ -n $(fdisk $_disk | grep ' A6 ') ]] && return
@


1.32
log
@Add the new template file based autopartitioning feature of disklabel(8)
to the OpenBSD installer. It is available during unattended installation.
The template file is fetched from an url, provided as answer to a new
question in the response file:

    URL to autopartitioning template for disklabel = url

Original diff from and OK henning@@
'no objection' krw@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.31 2014/08/06 16:13:48 ajacoutot Exp $
d86 1
a86 1
	local _disk=$1 _f _op
d90 2
a91 21
	_f=/tmp/fstab.$_disk
	if [[ $_disk == $ROOTDISK ]]; then
		if $AUTO && get_disklabel_template; then
			disklabel -T /disklabel.auto $FSTABFLAG $_f -w -A $_disk && return
			echo "Autopartitioning failed"
			exit 1
		fi
		while :; do
			echo "The auto-allocated layout for $_disk is:"
			disklabel -h -A $_disk | egrep "^#  |^  [a-p]:"
			ask "Use (A)uto layout, (E)dit auto layout, or create (C)ustom layout?" a
			case $resp in
			a*|A*)	_op=-w ;;
			e*|E*)	_op=-E ;;
			c*|C*)	break ;;
			*)	continue ;;
			esac
			disklabel $FSTABFLAG $_f $_op -A $_disk
			return
		done
	fi
@


1.31
log
@sysctl machdep.ztsscale has been unused for 7 years, so stop handling it.
s/TAB/SPACE for the wsconsctl.conf comment like we do with sysctl.conf
in MI.

"get this in fast" deraadt@@
ok ratchov@@ who will test it in the next few hours
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.30 2014/08/05 13:15:51 deraadt Exp $
d92 5
@


1.30
log
@handle wsconsctl.conf and sysctl.conf just being examples.
from ratchov
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.29 2013/11/16 18:37:27 rpe Exp $
d129 1
a129 1
		echo $val "	# see ztsscale(8)" >> /tmp/wsconsctl.conf
a130 3
		grep -v '^machdep\.ztsscale.*$' /mnt/etc/sysctl.conf \
		     >/tmp/sysctl.conf 2>/dev/null
		cp /tmp/sysctl.conf /mnt/etc/sysctl.conf
@


1.29
log
@Remove AUTOROOT variable which is a leftover of r1.183 of install.sub

diff from Philipp e1c1bac6253dc54a1e89ddc046585792 at osteo dot net

ok krw@@ halex@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.28 2012/07/10 14:25:00 halex Exp $
d126 1
d128 1
a128 1
		     >/tmp/wsconsctl.conf
d132 1
a132 1
		     >/tmp/sysctl.conf
@


1.28
log
@since disklabel -W is no more, zap it from all the install.md's

ok krw@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.27 2011/04/17 20:57:11 krw Exp $
d97 1
a97 1
			a*|A*)	_op=-w ; AUTOROOT=y ;;
@


1.27
log
@First crack at enabling the installation of a DUID version of
/etc/fstab, after asking user. Current default is existing behaviour.

Feedback & suggestions deraadt@@, halex@@, jsing@@, todd@@.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.26 2010/08/08 21:06:06 krw Exp $
a89 1
	disklabel -W $_disk >/dev/null 2>&1
@


1.26
log
@Revert auto-enabling of apm. Some security implications were not
fully appreciated, and no time to work through them.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.25 2010/08/08 17:02:14 krw Exp $
d103 1
a103 1
			disklabel -f $_f $_op -A $_disk
d120 1
a120 1
	disklabel -f $_f -E $_disk
@


1.25
log
@Look for MD devices or assurance that apmd would be a useful thing to
run. If found, add "apmd_flags=" installed rc.conf.local. Suggested by
deraadt@@.

i386/apm test by kettenis@@.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.24 2009/06/11 18:52:42 deraadt Exp $
a35 1
MDAPMD=y
@


1.24
log
@Bring this up to the new way of doing the fdisk handling
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.23 2009/06/04 00:44:48 krw Exp $
d36 1
@


1.23
log
@Nuke now superfluous ARCH=ARCH lines in install.md and the sed processing of
those lines in list2sh.awk.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.22 2009/06/02 16:23:45 krw Exp $
d41 1
a41 1
	local _disk=$1
d43 16
a58 4
	ask_yn "Do you want to use *all* of $_disk for OpenBSD?"
	if [[ $resp == y ]]; then
		echo -n "Putting all of $_disk into an active OpenBSD MBR partition (type 'A6')..."
		fdisk -e ${_disk} <<__EOT >/dev/null
d64 5
a68 6
		echo "done."
		return
	fi

	# Manually configure the MBR.
	cat <<__EOT
d72 2
a73 10
must be marked as the only active partition.

The 'manual' command describes all the fdisk commands in detail.

$(fdisk ${_disk})
__EOT
	fdisk -e ${_disk}

	cat <<__EOT
Here is the partition information you chose:
d77 6
@


1.22
log
@Add '-h' flag, and '*' as a unit specifier for 'p' Editor command.
Both cause partition sizes to be displayed using a human readable
format with the units automatically chosen by looking at the smallest
partition in the disk label. Remove forceable humanization in 'A'
code and use '-h' in install scripts.

Prodded & ok deraadt@@, verbiage tweaks from jmc@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.21 2009/05/11 17:13:07 deraadt Exp $
a35 1
ARCH=ARCH
@


1.21
log
@Remind people that mountpoints must now be entered using the disklabel
command; the script does not ask afterwards.  Note I am not adjusting
the macppc or sgi install.md scripts.  I ask their maintainers to clean
them before I will maintain them further.  Please
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.20 2009/04/25 03:21:51 deraadt Exp $
d87 1
a87 1
			disklabel -A $_disk | egrep "^#  |^  [a-p]:"
@


1.20
log
@If the right conditions exist, ask if xdm should be started automatically.
Yes, there are machines where you X needs configuration, but let us be
realistic about it: THAT IS AN X BUG.  And there are machines where getty
and xdm fight: THAT IS A CONSOLE DRIVER BUG.  And this commit is going to
force those bugs to eventually matter enough so that they get fixed.   Just
watch.
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.19 2009/04/12 12:56:02 krw Exp $
d105 1
@


1.19
log
@Tweak pattern used to select partition lines for display so the
'# /dev/r...' line is not selected.

Noticed by deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.18 2009/04/12 01:35:01 krw Exp $
d35 1
@


1.18
log
@No longer need '-f' or '-p' when displaying layout. A few patterns
missed the '# size offset ...' line at the top of the partition
list.
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.17 2009/04/10 23:11:17 krw Exp $
d86 1
a86 1
			disklabel -A $_disk | egrep "^#|^  [a-p]:"
@


1.17
log
@Where appropriate display the auto-allocation layout of the root
disk and ask if the installee wants to use it, edit it, or create
their own custom disklabel. Most one-disk installs will not need
to see fdisk or disklabel.

i386 and macppc by me, adapted for others by deraadt@@.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.16 2008/06/26 05:42:04 ray Exp $
d86 1
a86 1
			disklabel -f $_f -p g -A $_disk | grep "^  [a-p]:"
@


1.16
log
@First pass at removing clauses 3 and 4 from NetBSD licenses.

Not sure what's more surprising: how long it took for NetBSD to
catch up to the rest of the BSDs (including UCB), or the amount of
code that NetBSD has claimed for itself without attributing to the
actual authors.

OK deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.15 2008/03/23 14:03:55 krw Exp $
d77 1
a77 1
	local _disk=$1
d81 18
d110 1
a110 2
	disklabel -W $_disk >/dev/null 2>&1
	disklabel -f /tmp/fstab.$_disk -E $_disk
@


1.15
log
@No point in warning users during install that the disklabel has a
weird number of partitions, doesn't checksum, doesn't exist or was
found at a particular sector. Brings all archs together in omerta by
eliminating use of '-r' and examination of disklabel messages.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.14 2008/03/04 18:09:37 deraadt Exp $
a17 7
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#        This product includes software developed by the NetBSD
#        Foundation, Inc. and its contributors.
# 4. Neither the name of The NetBSD Foundation nor the names of its
#    contributors may be used to endorse or promote products derived
#    from this software without specific prior written permission.
@


1.14
log
@zaurus should set CPROM too, since it handles boot.conf; noted by sthen
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.13 2008/03/04 00:36:38 krw Exp $
a46 14
# $1 is the disk to check
md_checkfordisklabel() {
	local rval=0

	disklabel -r $1 >/dev/null 2>/tmp/checkfordisklabel

	if grep "disk label corrupted" /tmp/checkfordisklabel; then
		rval=2
	fi >/dev/null 2>&1

	rm -f /tmp/checkfordisklabel
	return $rval
}

a97 6

	md_checkfordisklabel $_disk
	case $? in
	2)	echo "WARNING: Label on disk $_disk is corrupted. You will be repairing it.\n"
		;;
	esac
@


1.13
log
@Redo serial console configuration logic. Smaller, easier to
understand.

Add serial console handling for alpha, macppc, zaurus.  No functional
change for i386/amd64.

All archs should now have automatic serial console configuration.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.12 2007/05/31 20:28:23 robert Exp $
d144 1
@


1.12
log
@remove the machdep.ztsscale line from sysctl.conf
because it's not used anymore; ok krw@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.11 2007/05/31 03:51:56 robert Exp $
d136 12
@


1.11
log
@don't try to move a non-existing file to wsconsctl.conf
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.10 2007/05/29 21:13:56 robert Exp $
d131 3
@


1.10
log
@adapt ztsscale and the installer to use wscons ioctls for calibration;
ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.9 2007/02/11 18:59:31 krw Exp $
d128 1
a128 1
		     >/tmp/sysctl.conf
@


1.9
log
@Nuke MDFSTYPE and MDFSOPTS, 'mount -t ...' and giving the user the
option to choose a filesystem type when mounting a disk. Rely on the
filesystem information provided by the disklabel.

When there is only one usable partition on the selected disk, just
mount it without bothering the user with a question.

Ensure that msdos filesystems are mounted with '-s' so that the names
of the install sets will be in lower case and thus visible to the
script.

msdos problems noted by Rodolfo Gouveia, who did a lot of testing and
debugging. 'mount -t ...' silliness pointed out by deraadt@@.
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.8 2006/03/15 16:13:30 deraadt Exp $
d127 1
a127 1
		grep -v '^machdep\.ztsscale.*$' /mnt/etc/sysctl.conf \
d129 2
a130 2
		echo $val "	# see ztsscale(8)" >> /tmp/sysctl.conf
		cp /tmp/sysctl.conf /mnt/etc/sysctl.conf
@


1.8
log
@no more need for aperture
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.7 2005/04/28 16:26:15 deraadt Exp $
a41 1
MDFSTYPE=msdos
@


1.7
log
@put comment on ztsscale line
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.6 2005/04/28 06:48:34 deraadt Exp $
a42 1
MDXAPERTURE=2
@


1.6
log
@whack any previous machdep.ztsscale settings in sysctl.conf, and apply
the new one cleanly.  whee.
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.5 2005/04/24 18:51:00 deraadt Exp $
d131 1
a131 1
		echo $val >> /tmp/sysctl.conf
@


1.5
log
@run ztsscale at md_congrats time, krw ok (still needs testing)
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.4 2005/04/02 14:34:46 krw Exp $
a125 2
	echo 'Time to calibrare the touch screen... press on the cross hairs please'
	sleep 3
d129 4
a132 1
		echo $val >> /mnt/etc/sysctl.conf
@


1.4
log
@Scrounge a few more characters of whitespace, mostly to be consistant.
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.3 2005/03/27 15:13:50 krw Exp $
d126 8
@


1.3
log
@Use new skeleton kbd(8) '-l' to generalize kbd(8) use.  Eliminate
fixed list of available maps and machine dependant md_set_term()
functions.

Any ramdisk with /sbin/kbd present (amd64, cats, i386 at the moment)
will now present list of available keyboard encodings.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.2 2005/01/16 19:24:55 deraadt Exp $
d69 1
a69 1
		fdisk -e ${_disk} << __EOT > /dev/null
d80 1
a80 1
	cat << __EOT
d92 1
a92 1
	cat << __EOT
d104 1
a104 1
	cat << __EOT
@


1.2
log
@more like i386, clone from there
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.1 2004/12/31 00:14:07 drahn Exp $
a44 3

md_set_term() {
}
@


1.1
log
@Ramdisk bits for zaurus
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.5 2004/07/18 01:14:04 deraadt Exp $
d52 3
a54 3
md_prep_disk() {
	local _disk=$1 _resp
	typeset -l _resp
d56 1
a56 3
	cat << __EOT

$_disk must be partitioned using an BSD or an MBR partition table.
d58 3
a60 4
BSD partition table or MBR partition tables can be created by openbsd.
It is more a question of firmware compatiblity disk portability.
(Once we can figure out what filesystems ABLE can boot)
__EOT
d62 2
a63 14
	while : ; do
		ask "Use BSD or MBR partition table?" BSD
		_resp=$resp
		case $_resp in
		m|mbr)	export disklabeltype=MBR
			md_prep_MBR $_disk
			break
			;;
		b|bsd)	export disklabeltype=BSD
			md_prep_BSD $_disk
			break
			;;
		esac
	done
d66 1
a66 1
md_prep_MBR() {
d69 1
a69 12
	if [[ -n $(disklabel -c $_disk 2>/dev/null | grep ' BSD ') ]]; then
		cat << __EOT

WARNING: putting an MBR partition table on $_disk will DESTROY the existing BSD
         partitions and BSD partition table.

__EOT
		ask_yn "Are you *sure* you want an MBR partition table on $_disk?"
		[[ $resp == n ]] && exit
	fi

	ask_yn "Use *all* of $_disk for OpenBSD?"
d71 2
a72 2
		echo -n "Creating Master Boot Record (MBR)..."
		fdisk -e $_disk  >/dev/null 2>&1 << __EOT
a78 6

		echo -n "Formatting 1MB MSDOS boot partition..."
		gunzip < /usr/mdec/msdos1mb.gz | \
		    dd of=/dev/r${_disk}c bs=512 seek=1 >/dev/null 2>&1
		echo "done."

d82 1
a82 2
	# Manual MBR setup. The user is basically on their own. Give a few
	# hints and let the user rip.
d85 3
a87 3
**** NOTE ****

XXX
d89 1
a89 5
**************

Current partition information is:

$(fdisk $_disk)
d91 1
d93 1
a93 2

	fdisk -e $_disk
d96 1
a96 7
Here is the MBR configuration you chose:

$(fdisk $_disk)

Please take note of the offsets and sizes of the DOS partition, the OpenBSD
partition, and any other partitions you want to access from OpenBSD. You will
need this information to fill in the OpenBSD disklabel.
d98 1
d102 1
a102 1
md_prep_BSD() {
d105 2
d109 3
a111 7
No special setup should be required to label using BSD disklabel.
however if the disk has previously been partitioned in another
manner, it may be necessary to wipe existing partition tables
before proceeding.

dd if=/dev/zero of=/${_disk} bs=512 count=10
disklabel -c ${_disk}
d113 2
d118 3
a120 20
}

md_prep_disklabel() {
	local _disk=$1 _q

	md_prep_disk $_disk

	case $disklabeltype in
	BSD)	;;
	MBR)	cat << __EOT

You *MUST* setup the OpenBSD disklabel to include the MSDOS-formatted boot
partition as the 'i' partition. If the 'i' partition is missing or not the
MSDOS-formatted boot partition, then the kernel required to boot
OpenBSD cannot be installed.

__EOT
		;;
	*)	echo "Disk label type ('$disklabeltype') is not 'BSD' or 'MBR'."
		exit
d125 1
a125 1
	disklabel -c -f /tmp/fstab.$_disk -E $_disk
a128 7
	cat << __EOT

Once the machine has rebooted use OpenFirmware to boot into OpenBSD, as
described in the INSTALL.$ARCH document. The command to boot OpenBSD will be
something like 'boot (hd0)bsd'.

__EOT
@

