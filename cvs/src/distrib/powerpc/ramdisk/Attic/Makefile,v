head	1.19;
access;
symbols
	OPENBSD_2_9:1.16.0.2
	OPENBSD_2_9_BASE:1.16
	OPENBSD_2_8:1.14.0.2
	OPENBSD_2_8_BASE:1.14
	OPENBSD_2_7:1.8.0.2
	OPENBSD_2_7_BASE:1.8
	OPENBSD_2_6:1.7.0.4
	OPENBSD_2_6_BASE:1.7
	OPENBSD_2_5:1.7.0.2
	OPENBSD_2_5_BASE:1.7
	OPENBSD_2_4:1.6.0.2
	OPENBSD_2_4_BASE:1.6
	OPENBSD_2_3:1.2.0.4
	OPENBSD_2_3_BASE:1.2
	OPENBSD_2_2:1.2.0.2
	OPENBSD_2_2_BASE:1.2;
locks; strict;
comment	@# @;


1.19
date	2001.09.01.16.47.03;	author drahn;	state dead;
branches;
next	1.18;

1.18
date	2001.07.11.05.23.58;	author drahn;	state Exp;
branches;
next	1.17;

1.17
date	2001.06.17.22.40.44;	author drahn;	state Exp;
branches;
next	1.16;

1.16
date	2001.04.13.01.29.24;	author krw;	state Exp;
branches;
next	1.15;

1.15
date	2001.03.04.22.17.32;	author drahn;	state Exp;
branches;
next	1.14;

1.14
date	2000.10.19.20.54.36;	author drahn;	state Exp;
branches;
next	1.13;

1.13
date	2000.10.19.20.32.48;	author deraadt;	state Exp;
branches;
next	1.12;

1.12
date	2000.10.13.21.05.07;	author deraadt;	state Exp;
branches;
next	1.11;

1.11
date	2000.10.13.19.17.09;	author deraadt;	state Exp;
branches;
next	1.10;

1.10
date	2000.08.08.01.08.07;	author deraadt;	state Exp;
branches;
next	1.9;

1.9
date	2000.06.15.02.49.00;	author rahnds;	state Exp;
branches;
next	1.8;

1.8
date	2000.01.24.03.46.55;	author rahnds;	state Exp;
branches;
next	1.7;

1.7
date	99.03.13.01.52.06;	author rahnds;	state Exp;
branches;
next	1.6;

1.6
date	98.10.20.23.23.49;	author rahnds;	state Exp;
branches;
next	1.5;

1.5
date	98.09.22.02.54.57;	author rahnds;	state Exp;
branches;
next	1.4;

1.4
date	98.09.09.04.32.57;	author rahnds;	state Exp;
branches;
next	1.3;

1.3
date	98.05.29.04.34.19;	author rahnds;	state Exp;
branches;
next	1.2;

1.2
date	97.10.15.14.09.04;	author pefo;	state Exp;
branches;
next	1.1;

1.1
date	97.10.10.10.16.54;	author pefo;	state Exp;
branches;
next	;


desc
@@


1.19
log
@Move the powerpc ramdisk building support from powerpc to macppc.
@
text
@#	$OpenBSD: Makefile,v 1.18 2001/07/11 05:23:58 drahn Exp $

TOP=		${.CURDIR}/..

.include "${TOP}/Makefile.inc"
BSD_RD=		bsd.rd
IMAGE=		mr.fs
CBIN?=		instbin
LISTS=		${.CURDIR}/list
UTILS?=		${.CURDIR}/../../miniroot

MOUNT_POINT=	/mnt
MTREE=		${.CURDIR}/mtree.conf

VND?=		svnd0
VND_DEV=	/dev/${VND}a
VND_RDEV=	/dev/r${VND}a
VND_CRDEV=	/dev/r${VND}c
PID!=		echo $$$$


DISKTYPE=       rdroot
NBLKS=          8192
# minfree, opt, b/i  trks, sects, cpg
NEWFSARGS= -m 0 -o space -c 16 -i 4096

.ifndef DESTDIR
all ${IMAGE}:
	@@echo setenv DESTDIR before making a ramdisk!
	@@false
.else

# mix config is not needed.
all:	${BSD_RD} cd

${BSD_RD}: ${CBIN} ${IMAGE} bsd rdsetroot
	cp bsd ${BSD_RD}
	${.OBJDIR}/rdsetroot ${BSD_RD} < ${IMAGE}

cd: ${BSD_RD}
	-rm -rf ${.OBJDIR}/cd-dir/
	-@@mkdir -p ${.OBJDIR}/cd-dir/${OSREV}/powerpc/
	cp bsd.rd ${.OBJDIR}/cd-dir/${OSREV}/powerpc/bsd.rd
	strip ${.OBJDIR}/cd-dir/${OSREV}/powerpc/bsd.rd
	gzip -9 ${.OBJDIR}/cd-dir/${OSREV}/powerpc/bsd.rd
	mv ${.OBJDIR}/cd-dir/${OSREV}/powerpc/bsd.rd.gz ${.OBJDIR}/cd-dir/${OSREV}/powerpc/bsd.rd
	cp ${DESTDIR}/usr/mdec/ofwboot ${.OBJDIR}/cd-dir/
	mkhybrid -r -part -hfs -o ${.OBJDIR}/cd${OSrev}.fs ${.OBJDIR}/cd-dir


${IMAGE}: rd_setup do_files rd_teardown

.endif

bsd:
	cd ${TOP}/../../sys/arch/powerpc/conf && config RAMDISK
	cd ${TOP}/../../sys/arch/powerpc/compile/RAMDISK && \
	    make clean && make depend && make
	cp ${TOP}/../../sys/arch/powerpc/compile/RAMDISK/bsd bsd

rd_setup: 
	dd if=/dev/zero of=${IMAGE} bs=512 count=${NBLKS}
	vnconfig -v -c ${VND} ${IMAGE}
	disklabel -w -r ${VND} ${DISKTYPE}
	newfs ${NEWFSARGS} ${VND_RDEV}
	fsck ${VND_RDEV}
	mount ${VND_DEV} ${MOUNT_POINT}

rd_teardown:
	@@df -i ${MOUNT_POINT}
	-umount ${MOUNT_POINT}
	-vnconfig -u ${VND}

rdsetroot:	${TOP}/common/rdsetroot.c
	${HOSTCC} -DDEBUG -o rdsetroot ${TOP}/common/rdsetroot.c

unconfig:
	-umount -f ${MOUNT_POINT}
	-vnconfig -u ${VND}

.PRECIOUS:	${IMAGE}

install:
	cp ${BSD_RD} cd${REV}.fs ${DESTDIR}/snapshot/

${CBIN}.mk ${CBIN}.cache ${CBIN}.c: ${CBIN}.conf
	crunchgen -E -D ${.CURDIR}/../../.. -L ${DESTDIR}/usr/lib ${.ALLSRC}

${CBIN}: ${CBIN}.mk ${CBIN}.cache ${CBIN}.c
	make -f ${CBIN}.mk all

do_files:
	mtree -def ${MTREE} -p ${MOUNT_POINT}/ -u
	TOPDIR=${TOP} CURDIR=${.CURDIR} OBJDIR=${.OBJDIR} \
	    REV=${REV} TARGDIR=${MOUNT_POINT} sh ${TOP}/runlist.sh ${LISTS}

clean cleandir:
	/bin/rm -f core ${IMAGE} ${CBIN} ${CBIN}.mk ${CBIN}.cache \
	*.o *.lo *.c bsd ${BSD_RD} \
	rdsetroot

beforeinstall:
	cp ${BSD.RD} cd${REV}.fs ${DESTDIR}/snapshot

.include <bsd.obj.mk>
.include <bsd.subdir.mk>
@


1.18
log
@When rebuilding ramdisk kernel, rebuild dependancies after config RAMDISK
and make clean. If a file has been removed from the source tree, and
the old dependancies still refer to it, the build will break.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.17 2001/06/17 22:40:44 drahn Exp $
@


1.17
log
@Do not remove a CVSed file during the build process.
At one point it was a generated file, but that changed long ago.
Pointed out by krw.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.16 2001/04/13 01:29:24 krw Exp $
d58 1
a58 1
	    make clean && make
@


1.16
log
@Minor typos & cleanup.

Fix a couple of missing closing quotes in the MBR partitioning routine.

Ensure that all questions posed have a space after the closing ']'.

makeing -> making.

ok drahn@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.15 2001/03/04 22:17:32 drahn Exp $
d98 1
a98 1
	/bin/rm -f core ${IMAGE} ${CBIN} ${CBIN}.conf ${CBIN}.mk ${CBIN}.cache \
@


1.15
log
@Use /mnt as the mount point for creating the ramdisk, not /mnt2.
All other ports use /mnt and /mnt2 does not exist by default.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.14 2000/10/19 20:54:36 drahn Exp $
d29 1
a29 1
	@@echo setenv DESTDIR before makeing a ramdisk!
@


1.14
log
@strip and compress the ramdisk kernel on the cd, makes the image much
smaller.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.13 2000/10/19 20:32:48 deraadt Exp $
d12 1
a12 1
MOUNT_POINT=	/mnt2
@


1.13
log
@no /bsd.rd, only /2.8/powerpc/bsd.rd on cd28.fs
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.12 2000/10/13 21:05:07 deraadt Exp $
d44 3
@


1.12
log
@simpler
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.11 2000/10/13 19:17:09 deraadt Exp $
a43 1
	ln ${.OBJDIR}/cd-dir/${OSREV}/powerpc/bsd.rd ${.OBJDIR}/cd-dir/bsd.rd
@


1.11
log
@build a minimal CD boot image (might even work on zip, dale said)
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.10 2000/08/08 01:08:07 deraadt Exp $
a43 1
	-rm ${.OBJDIR}/cd-dir/bsd.rd
@


1.10
log
@use GENERIC and RAMDISK
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.9 2000/06/15 02:49:00 rahnds Exp $
d34 1
a34 1
all:	${BSD_RD}
d40 9
d83 1
a83 1
	cp ${BSD_RD} ${DESTDIR}/snapshot/${BSD_RD}
d102 1
a102 1
	cp ${BSD.RD} ${DESTDIR}/snapshot
@


1.9
log
@Deal with the chgrp chown -> chmod change.
instead of generating a text file from list, just create it
and edit it directly, allows for more control.
Also i386 edits this file directly instead of using awk to generate it.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.8 2000/01/24 03:46:55 rahnds Exp $
d46 2
a47 2
	cd ${TOP}/../../sys/arch/powerpc/conf && config RAMDISKMAC
	cd ${TOP}/../../sys/arch/powerpc/compile/RAMDISKMAC && \
d49 1
a49 1
	cp ${TOP}/../../sys/arch/powerpc/compile/RAMDISKMAC/bsd bsd
@


1.8
log
@For now switch to building PowerPC MAC support, when additional work
is done on PREP based machines those ramdisks can be added back.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.7 1999/03/13 01:52:06 rahnds Exp $
a75 3
${CBIN}.conf: ${LISTS}
	awk -f ${UTILS}/makeconf.awk CBIN=${CBIN} ${LISTS} > ${CBIN}.conf

d77 1
a77 1
	crunchgen -E -D ${.CURDIR}/../../.. -L ${DESTDIR}/usr/lib ${CBIN}.conf
@


1.7
log
@remove legacy "mix" kernel building code, it was not quite completely
commented and would cause error messages during build. Since it is
unused, delete it completely
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.6 1998/10/20 23:23:49 rahnds Exp $
a6 2
BSDOFW_RD=	bsdofw.rd
BSDMIX_RD=	bsdmix.rd
d12 1
a12 1
MOUNT_POINT=	/mnt
d34 1
a34 1
all:	${BSD_RD} ${BSDOFW_RD}
a39 3
${BSDOFW_RD}: ${CBIN} ${IMAGE} bsdofw rdsetroot
	cp bsdofw ${BSDOFW_RD}
	${.OBJDIR}/rdsetroot ${BSDOFW_RD} < ${IMAGE}
d46 2
a47 2
	cd ${.TOP}/../../sys/arch/powerpc/conf && config RAMDISK
	cd ${.TOP}/../../sys/arch/powerpc/compile/RAMDISK && \
d49 1
a49 13
	cp ${.TOP}/../../sys/arch/powerpc/compile/RAMDISK/bsd bsd

bsdofw:
	cd ${.TOP}/../../sys/arch/powerpc/conf && config RAMDISKOFW
	cd ${.TOP}/../../sys/arch/powerpc/compile/RAMDISKOFW && \
	    make clean && make
	cp ${.TOP}/../../sys/arch/powerpc/compile/RAMDISKOFW/bsd bsdofw

bsdmix:
	cd ${.TOP}/../../sys/arch/powerpc/conf && config RAMDISKMIX
	cd ${.TOP}/../../sys/arch/powerpc/compile/RAMDISKMIX && \
	    make clean && make
	cp ${.TOP}/../../sys/arch/powerpc/compile/RAMDISKMIX/bsd bsdmix
a74 1
	cp ${BSDOFW_RD} ${DESTDIR}/snapshot/${BSDOFW_RD}
d92 1
a92 1
	*.o *.lo *.c bsd bsdmix bsdofw ${BSD_RD} ${BSDOFW_RD} ${BSDMIX_RD} \
@


1.6
log
@Mix kernels are no longer necessary, Generic will work sufficiently.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.5 1998/09/22 02:54:57 rahnds Exp $
d36 1
a36 1
all:	${BSD_RD} ${BSDOFW_RD} # ${BSDMIX_RD}
a45 4
${BSDMIX_RD}: ${CBIN} ${IMAGE} bsdmix rdsetroot
	cp bsdmix ${BSDMIX_RD}
	${.OBJDIR}/rdsetroot ${BSDMIX_RD} < ${IMAGE}

a92 1
	cp ${BSDMIX_RD} ${DESTDIR}/snapshot/${BSDMIX_RD}
@


1.5
log
@Remove additional kernels during cleanup, otherwise it can
build with the wrong ramdisk kernel. Soon these multiple configs
need to go away.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.4 1998/09/09 04:32:57 rahnds Exp $
d35 2
a36 1
all:	${BSD_RD} ${BSDOFW_RD} ${BSDMIX_RD}
@


1.4
log
@Support a third boot floppy, Soon this should go to one supported, but not yet.

Use "standard" install.sub file not port specific version.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.3 1998/05/29 04:34:19 rahnds Exp $
d114 1
a114 1
	*.o *.lo *.c bsd ${BSD_RD} ${BSDOFW_RD} ${BSDMIX_RD} ${BSD_RD}.elf \
@


1.3
log
@Deleted files that were not used anymore, this is all of the
inst-common and miniroot files. ramdisk is all that is used.
ramdisk/install.sh and ramdisk/install.sub are actually moved from
miniroot/*.
Makefile was changed to build the ofw versions of the ramdisk kernel.
minor tweaks to leave the MAKEDEV file on the ramdisk, so that new devices
could be generated. Makefile was changed to not create temporary files
that are lost track of and cannot be "make unconfig"ed.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.2 1997/10/15 14:09:04 pefo Exp $
d8 1
d35 1
a35 1
all:	${BSD_RD} ${BSDOFW_RD}
d45 4
d53 6
d65 3
a67 3
bsd:
	cd ${.TOP}/../../sys/arch/powerpc/conf && config RAMDISK
	cd ${.TOP}/../../sys/arch/powerpc/compile/RAMDISK && \
d69 1
a69 1
	cp ${.TOP}/../../sys/arch/powerpc/compile/RAMDISK/bsd bsd
d96 1
d114 2
a115 1
	*.o *.lo *.c bsd ${BSD_RD} ${BSD_RD}.elf rdsetroot
@


1.2
log
@Fix some inconsitencies
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.1 1997/10/10 10:16:54 pefo Exp $
d7 1
a20 1
REALIMAGE!=	echo /var/tmp/image.${PID}
d34 1
a34 1
all:	${BSD_RD}
d39 4
a42 1
	rm ${IMAGE}
d48 6
d61 2
a62 2
	dd if=/dev/zero of=${REALIMAGE} bs=512 count=${NBLKS}
	vnconfig -v -c ${VND} ${REALIMAGE}
a71 2
	cp ${REALIMAGE} ${IMAGE}
	rm ${REALIMAGE}
a78 1
	-/bin/rm -f ${IMAGE}
d84 1
@


1.1
log
@PowerPC ramdisk stuff. "list" and scripts still needs work. This is only the
first "work copy"...
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.8 1997/09/26 02:20:41 millert Exp $
d46 2
a47 2
	cd ${.TOP}/../../sys/arch/power4e/conf && config RAMDISK
	cd ${.TOP}/../../sys/arch/power4e/compile/RAMDISK && \
d49 1
a49 1
	cp ${.TOP}/../../sys/arch/power4e/compile/RAMDISK/bsd bsd
@
