head	1.32;
access;
symbols
	OPENBSD_6_1_BASE:1.32
	OPENBSD_6_0:1.31.0.4
	OPENBSD_6_0_BASE:1.31
	OPENBSD_5_9:1.31.0.2
	OPENBSD_5_9_BASE:1.31
	OPENBSD_5_8:1.30.0.4
	OPENBSD_5_8_BASE:1.30
	OPENBSD_5_7:1.27.0.4
	OPENBSD_5_7_BASE:1.27
	OPENBSD_5_6:1.23.0.6
	OPENBSD_5_6_BASE:1.23
	OPENBSD_5_5:1.23.0.2
	OPENBSD_5_5_BASE:1.23
	OPENBSD_5_4:1.21.0.6
	OPENBSD_5_4_BASE:1.21
	OPENBSD_5_3:1.21.0.4
	OPENBSD_5_3_BASE:1.21
	OPENBSD_5_2:1.21.0.2
	OPENBSD_5_2_BASE:1.21
	OPENBSD_5_1_BASE:1.20
	OPENBSD_5_1:1.20.0.4
	OPENBSD_5_0:1.20.0.2
	OPENBSD_5_0_BASE:1.20
	OPENBSD_4_9:1.18.0.2
	OPENBSD_4_9_BASE:1.18
	OPENBSD_4_8:1.16.0.6
	OPENBSD_4_8_BASE:1.16
	OPENBSD_4_7:1.16.0.2
	OPENBSD_4_7_BASE:1.16
	OPENBSD_4_6:1.16.0.4
	OPENBSD_4_6_BASE:1.16
	OPENBSD_4_5:1.8.0.4
	OPENBSD_4_5_BASE:1.8
	OPENBSD_4_4:1.8.0.2
	OPENBSD_4_4_BASE:1.8
	OPENBSD_4_3:1.7.0.2
	OPENBSD_4_3_BASE:1.7
	OPENBSD_4_2:1.6.0.10
	OPENBSD_4_2_BASE:1.6
	OPENBSD_4_1:1.6.0.8
	OPENBSD_4_1_BASE:1.6
	OPENBSD_4_0:1.6.0.6
	OPENBSD_4_0_BASE:1.6
	OPENBSD_3_9:1.6.0.4
	OPENBSD_3_9_BASE:1.6
	OPENBSD_3_8:1.6.0.2
	OPENBSD_3_8_BASE:1.6
	OPENBSD_3_7:1.5.0.4
	OPENBSD_3_7_BASE:1.5
	OPENBSD_3_6:1.5.0.2
	OPENBSD_3_6_BASE:1.5
	OPENBSD_3_5:1.4.0.2
	OPENBSD_3_5_BASE:1.4
	OPENBSD_3_4:1.1.0.4
	OPENBSD_3_4_BASE:1.1
	OPENBSD_3_3:1.1.0.2
	OPENBSD_3_3_BASE:1.1;
locks; strict;
comment	@# @;


1.32
date	2016.09.04.09.52.03;	author rpe;	state Exp;
branches;
next	1.31;
commitid	MluxzkKaq4wrtv84;

1.31
date	2016.02.08.17.28.08;	author krw;	state Exp;
branches;
next	1.30;
commitid	4nj4L34RoKX0PFN0;

1.30
date	2015.06.02.19.54.06;	author rpe;	state Exp;
branches;
next	1.29;
commitid	zUqrjWrWSBxkCmbI;

1.29
date	2015.05.31.19.40.10;	author rpe;	state Exp;
branches;
next	1.28;
commitid	p6r5f9n0C0WoWNND;

1.28
date	2015.05.04.19.55.26;	author rpe;	state Exp;
branches;
next	1.27;
commitid	NyWrBKI5Tnb4FUEi;

1.27
date	2015.03.08.13.13.48;	author deraadt;	state Exp;
branches;
next	1.26;
commitid	DuXyJnoPGCAMt8Ca;

1.26
date	2015.02.17.18.40.48;	author miod;	state Exp;
branches;
next	1.25;
commitid	70f4IGVOZLMKdydT;

1.25
date	2015.02.08.06.20.22;	author deraadt;	state Exp;
branches;
next	1.24;
commitid	3bfwblthilgepaK0;

1.24
date	2014.08.15.09.45.54;	author rpe;	state Exp;
branches;
next	1.23;
commitid	1ay5nPocSGoegdY3;

1.23
date	2014.02.23.11.08.02;	author jsing;	state Exp;
branches;
next	1.22;

1.22
date	2013.11.16.18.37.27;	author rpe;	state Exp;
branches;
next	1.21;

1.21
date	2012.07.10.14.25.00;	author halex;	state Exp;
branches;
next	1.20;

1.20
date	2011.07.06.20.02.16;	author halex;	state Exp;
branches;
next	1.19;

1.19
date	2011.04.17.20.57.10;	author krw;	state Exp;
branches;
next	1.18;

1.18
date	2011.01.01.17.25.06;	author deraadt;	state Exp;
branches;
next	1.17;

1.17
date	2010.12.31.19.26.46;	author deraadt;	state Exp;
branches;
next	1.16;

1.16
date	2009.06.14.00.12.21;	author deraadt;	state Exp;
branches;
next	1.15;

1.15
date	2009.06.04.00.44.46;	author krw;	state Exp;
branches;
next	1.14;

1.14
date	2009.06.02.16.23.45;	author krw;	state Exp;
branches;
next	1.13;

1.13
date	2009.05.31.17.49.53;	author deraadt;	state Exp;
branches;
next	1.12;

1.12
date	2009.05.11.17.13.05;	author deraadt;	state Exp;
branches;
next	1.11;

1.11
date	2009.04.12.12.56.01;	author krw;	state Exp;
branches;
next	1.10;

1.10
date	2009.04.12.01.35.01;	author krw;	state Exp;
branches;
next	1.9;

1.9
date	2009.04.10.23.11.17;	author krw;	state Exp;
branches;
next	1.8;

1.8
date	2008.03.22.23.28.10;	author krw;	state Exp;
branches;
next	1.7;

1.7
date	2008.03.04.00.36.38;	author krw;	state Exp;
branches;
next	1.6;

1.6
date	2005.03.27.15.13.49;	author krw;	state Exp;
branches;
next	1.5;

1.5
date	2004.08.19.02.03.09;	author mickey;	state Exp;
branches;
next	1.4;

1.4
date	2003.10.12.13.18.37;	author krw;	state Exp;
branches;
next	1.3;

1.3
date	2003.09.21.02.11.42;	author krw;	state Exp;
branches;
next	1.2;

1.2
date	2003.09.18.00.02.42;	author krw;	state Exp;
branches;
next	1.1;

1.1
date	2003.01.30.21.05.00;	author mickey;	state Exp;
branches;
next	;


desc
@@


1.32
log
@Move files created by root during install/upgrade in a subdir of
/tmp with proper permissions so that unprivileged programs can not
tamper with them.

positive feedback from deraadt
OK halex
@
text
@#	$OpenBSD: install.md,v 1.31 2016/02/08 17:28:08 krw Exp $
#
# machine dependent section of installation/upgrade script.
#

MDTERM=vt100
NCPU=$(sysctl -n hw.ncpufound)

((NCPU > 1)) && { DEFAULTSETS="bsd bsd.rd bsd.mp"; SANESETS="bsd bsd.mp"; }

md_installboot() {
	if ! installboot -r /mnt ${1}; then
		echo "\nFailed to install bootblocks."
		echo "You will not be able to boot OpenBSD from ${1}."
		exit
	fi
}

md_prep_disklabel() {
	local _disk=$1 _f=/tmp/i/fstab.$1

	installboot $_disk

	disklabel_autolayout $_disk $_f || return
	[[ -s $_f ]] && return

	# Edit disklabel manually.
	# Abandon all hope, ye who enter here.
	disklabel -F $_f -E $_disk
}

md_congrats() {
}

md_consoleinfo() {
}
@


1.31
log
@If manual disklabel editing is requested during install, don't emit
verbiage explaining what disklabels are.

If you don't know, you should be using (A)uto!

ok rpe@@ halex@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.30 2015/06/02 19:54:06 rpe Exp $
d20 1
a20 1
	local _disk=$1 _f=/tmp/fstab.$1
@


1.30
log
@Remove the $FSTABFLAG variable and use -F directly. The installer
uses disklabel UIDs unconditionally for a while already.

OK krw@@
"looks good" deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.29 2015/05/31 19:40:10 rpe Exp $
d27 2
a28 8
	cat <<__EOT
You will now create a OpenBSD disklabel on the disk.  The disklabel defines
how OpenBSD splits up the disk into OpenBSD partitions in which filesystems
and swap space are created.  You must provide each filesystem's mountpoint
in this program.

__EOT

@


1.29
log
@Replace identical code in the MD scripts of the installer with a new
MI function disklabel_autolayout() which now handles all aspects of
the disklabel auto-layout and autopartitioning case for the root disk.
Remove get_disklabel_template() and merge it with the new function.

"move forward" deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.28 2015/05/04 19:55:26 rpe Exp $
d35 1
a35 1
	disklabel $FSTABFLAG $_f -E $_disk
@


1.28
log
@Add the new template file based autopartitioning feature of disklabel(8)
to the OpenBSD installer. It is available during unattended installation.
The template file is fetched from an url, provided as answer to a new
question in the response file:

    URL to autopartitioning template for disklabel = url

Original diff from and OK henning@@
'no objection' krw@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.27 2015/03/08 13:13:48 deraadt Exp $
d20 1
a20 1
	local _disk=$1 _f _op
d24 3
a26 21
	_f=/tmp/fstab.$_disk
	if [[ $_disk == $ROOTDISK ]]; then
		if $AUTO && get_disklabel_template; then
			disklabel -T /disklabel.auto $FSTABFLAG $_f -w -A $_disk && return
			echo "Autopartitioning failed"
			exit 1
		fi
		while :; do
			echo "The auto-allocated layout for $_disk is:"
			disklabel -h -A $_disk | egrep "^#  |^  [a-p]:"
			ask "Use (A)uto layout, (E)dit auto layout, or create (C)ustom layout?" a
			case $resp in
			a*|A*)	_op=-w ;;
			e*|E*)	_op=-E ;;
			c*|C*)	break ;;
			*)	continue ;;
			esac
			disklabel $FSTABFLAG $_f $_op -A $_disk
			return
		done
	fi
@


1.27
log
@last rev fixed upgrades, but broke installs, sigh.  use on-bsd.rd sdboot
for LIF/header creation, pre-disklabel.  post-install/upgrade, this
gets redone, this time with -r /mnt to pick up the new sdboot file
ok krw jsing miod
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.26 2015/02/17 18:40:48 miod Exp $
d26 5
@


1.26
log
@Revert the first chunk of 1.25.
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.25 2015/02/08 06:20:22 deraadt Exp $
d22 1
a22 1
	md_installboot $_disk
@


1.25
log
@md_prep_disklabel should run disklabel (for fresh disks intended to be
bootable, which do contain a LIF yet).  It should also be run in
md_installboot for the upgrade case.
Diagnosis with jsing and kettenis, buglet spotted by rpe
Testing... waiting for that.
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.24 2014/08/15 09:45:54 rpe Exp $
d12 1
a12 1
	if ! installboot ${1} sdboot; then
@


1.24
log
@Align install.md files with installer style.

- { foo ; bar ; } -> { foo; bar; }
- if foo ; then -> if foo; then

OK halex@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.23 2014/02/23 11:08:02 jsing Exp $
d12 1
a12 1
	if ! installboot -r /mnt ${1}; then
d21 2
@


1.23
log
@Use the new installboot for hppa installs.
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.22 2013/11/16 18:37:27 rpe Exp $
d9 1
a9 1
((NCPU > 1)) && { DEFAULTSETS="bsd bsd.rd bsd.mp" ; SANESETS="bsd bsd.mp" ; }
d12 1
a12 1
	if ! installboot -r /mnt ${1} ; then
@


1.22
log
@Remove AUTOROOT variable which is a leftover of r1.183 of install.sub

diff from Philipp e1c1bac6253dc54a1e89ddc046585792 at osteo dot net

ok krw@@ halex@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.21 2012/07/10 14:25:00 halex Exp $
d12 5
a16 1
	/sbin/disklabel -B $1
a20 2

	md_installboot $_disk
@


1.21
log
@since disklabel -W is no more, zap it from all the install.md's

ok krw@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.20 2011/07/06 20:02:16 halex Exp $
d27 1
a27 1
			a*|A*)	_op=-w ; AUTOROOT=y ;;
@


1.20
log
@As non-mp install.md's neither set NCPU, nor will have a bsd.mp,
we could as well pull the 'mv bsd.mp bsd' and the associated checks
out of there.

ok deraadt@@ "makes sense" todd@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.19 2011/04/17 20:57:10 krw Exp $
a19 1
	disklabel -W $_disk >/dev/null 2>&1
@


1.19
log
@First crack at enabling the installation of a DUID version of
/etc/fstab, after asking user. Current default is existing behaviour.

Feedback & suggestions deraadt@@, halex@@, jsing@@, todd@@.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.18 2011/01/01 17:25:06 deraadt Exp $
a11 6
	if [[ -f /mnt/bsd.mp ]] && ((NCPU > 1)); then
		echo "Multiprocessor machine; using bsd.mp instead of bsd."
		mv /mnt/bsd /mnt/bsd.sp 2>/dev/null
		mv /mnt/bsd.mp /mnt/bsd
	fi

@


1.18
log
@swap kernels without changing directory; other install.md should be modified like this
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.17 2010/12/31 19:26:46 deraadt Exp $
d39 1
a39 1
			disklabel -f $_f $_op -A $_disk
d51 1
a51 1
	disklabel -f $_f -E $_disk
@


1.17
log
@add support for bsd.mp
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.16 2009/06/14 00:12:21 deraadt Exp $
d12 1
a12 2
	cd /mnt
	if [[ -f bsd.mp ]] && ((NCPU > 1)); then
d14 2
a15 2
		mv bsd bsd.sp 2>/dev/null
		mv bsd.mp bsd
@


1.16
log
@We want to install a LIF label on the disk before we run disklabel -A
or disklabel -E.  Otherwise that disk will indicate the wrong bounds.
(nothing at all -> 0;  MBR -> probably 63; LIF -> 256).
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.15 2009/06/04 00:44:46 krw Exp $
d7 3
d12 7
@


1.15
log
@Nuke now superfluous ARCH=ARCH lines in install.md and the sed processing of
those lines in list2sh.awk.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.14 2009/06/02 16:23:45 krw Exp $
d14 2
@


1.14
log
@Add '-h' flag, and '*' as a unit specifier for 'p' Editor command.
Both cause partition sizes to be displayed using a human readable
format with the units automatically chosen by looking at the smallest
partition in the disk label. Remove forceable humanization in 'A'
code and use '-h' in install scripts.

Prodded & ok deraadt@@, verbiage tweaks from jmc@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.13 2009/05/31 17:49:53 deraadt Exp $
a6 1
ARCH=ARCH
@


1.13
log
@Make bootblock installation as silent as possible by default.  While
there, remove a lot of cruft from the various md_installboot functions
ok halex
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.12 2009/05/11 17:13:05 deraadt Exp $
d21 1
a21 1
			disklabel -A $_disk | egrep "^#  |^  [a-p]:"
@


1.12
log
@Remind people that mountpoints must now be entered using the disklabel
command; the script does not ask afterwards.  Note I am not adjusting
the macppc or sgi install.md scripts.  I ask their maintainers to clean
them before I will maintain them further.  Please
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.11 2009/04/12 12:56:01 krw Exp $
a9 1
	echo -n "Installing boot block..."
a10 1
	echo "done."
@


1.11
log
@Tweak pattern used to select partition lines for display so the
'# /dev/r...' line is not selected.

Noticed by deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.10 2009/04/12 01:35:01 krw Exp $
d35 8
@


1.10
log
@No longer need '-f' or '-p' when displaying layout. A few patterns
missed the '# size offset ...' line at the top of the partition
list.
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.9 2009/04/10 23:11:17 krw Exp $
d23 1
a23 1
			disklabel -A $_disk | egrep "^#|^  [a-p]:"
@


1.9
log
@Where appropriate display the auto-allocation layout of the root
disk and ask if the installee wants to use it, edit it, or create
their own custom disklabel. Most one-disk installs will not need
to see fdisk or disklabel.

i386 and macppc by me, adapted for others by deraadt@@.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.8 2008/03/22 23:28:10 krw Exp $
d23 1
a23 1
			disklabel -f $_f -p g -A $_disk | egrep "^#|^  [a-p]:"
@


1.8
log
@No point in checking disklabel output for 'disk label corrupted' message
since it isn't emitted anymore.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.7 2008/03/04 00:36:38 krw Exp $
d16 1
a16 1
	local _disk=$1
d19 17
a35 1
	disklabel -f /tmp/fstab.$_disk -E $_disk
@


1.7
log
@Redo serial console configuration logic. Smaller, easier to
understand.

Add serial console handling for alpha, macppc, zaurus.  No functional
change for i386/amd64.

All archs should now have automatic serial console configuration.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.6 2005/03/27 15:13:49 krw Exp $
a14 14
# $1 is the disk to check
md_checkfordisklabel() {
	local rval=0

	disklabel $1 >/dev/null 2>/tmp/checkfordisklabel

	if grep "disk label corrupted" /tmp/checkfordisklabel; then
		rval=2
	fi >/dev/null 2>&1

	rm -f /tmp/checkfordisklabel
	return $rval
}

a16 6

	md_checkfordisklabel $_disk
	case $? in
	2)	echo "WARNING: Label on disk $_disk is corrupted. You will be repairing it.\n"
		;;
	esac
@


1.6
log
@Use new skeleton kbd(8) '-l' to generalize kbd(8) use.  Eliminate
fixed list of available maps and machine dependant md_set_term()
functions.

Any ramdisk with /sbin/kbd present (amd64, cats, i386 at the moment)
will now present list of available keyboard encodings.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.5 2004/08/19 02:03:09 mickey Exp $
d43 3
@


1.5
log
@fly on defaults for MDDISKDEVS and MDCDDEVS
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.4 2003/10/12 13:18:37 krw Exp $
a7 3

md_set_term() {
}
@


1.4
log
@Cleanup and shrinkage:

1) Eliminate 'WARNING: Disk xxx has no label.' message. When installing OpenBSD
this is a normal condition not worth commenting on. From some discussion on
hackers/icb.

2) Use consistant verbiage and case statement when checking the disklabel.

3) Consistantly suppress output of 'disklabel -W', reducing duplicate messages
like '# using MBR partition ...' which are issued again when the 'disklabel -f
...' command is executed.

4) Usual code rectifications - eliminate extra {}'s, multiple echos
elimination, etc.
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.3 2003/09/21 02:11:42 krw Exp $
a6 2
MDDISKDEVS='/^sd[0-9] /s/ .*//p'
MDCDDEVS='/^cd[0-9] /s/ .*//p'
@


1.3
log
@Fix extraneous display of grep output when searching disklabel output for
error information. Previously things like:

disklabel: no disk label
WARNING: Disk wd0 has no disk label. You will be creating a new one.

would be printed. Now the 'disklabel: no disk label' message is correctly
sent to /dev/null.

Take the opportunity to clean up a bit of code and formatting, making all
the md_checkfordisklabel() functions as identical as possible.
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.2 2003/09/18 00:02:42 krw Exp $
d26 1
a26 3
	if grep "no disk label" /tmp/checkfordisklabel; then
		rval=1
	elif grep "disk label corrupted" /tmp/checkfordisklabel; then
d34 1
a34 2
md_prep_disklabel()
{
d39 1
a39 6
	0)	;;
	1)	echo WARNING: Disk $_disk has no label. You will be creating a new one.
		echo
		;;
	2)	echo WARNING: Label on disk $_disk is corrupted. You will be repairing.
		echo
d43 2
a44 2
	disklabel -W ${_disk}
	disklabel -f /tmp/fstab.${_disk} -E ${_disk}
@


1.2
log
@Excise unneeded, unused code.

ok mickey@@.
@
text
@d1 1
a1 1
#	$OpenBSD: install.md,v 1.1 2003/01/30 21:05:00 mickey Exp $
d20 1
d22 3
a24 2
	# $1 is the disk to check
	local rval
a25 1
	disklabel $1 > /dev/null 2> /tmp/checkfordisklabel
d30 1
a30 3
	else
		rval=0
	fi
@


1.1
log
@this allows to build a ramdiskNN.lif
@
text
@d1 1
a1 1
#	$OpenBSD$
d15 1
a15 19
	local _rawdev _prefix

	if [ -z "$1" ]; then
		echo No disk device specified, you must run installboot manually.
		return
	fi
	_rawdev=/dev/r${1}c

	# use extracted mdec if it exists (may be newer)
	if [ -e /mnt/usr/mdec/boot ]; then
		_prefix=/mnt/usr/mdec
	elif [ -e /usr/mdec/boot ]; then
		_prefix=/usr/mdec
	else
		echo No boot block prototypes found, you must run installboot manually.
		return
	fi

	echo Installing boot block...
d17 1
@

