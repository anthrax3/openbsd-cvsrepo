head	1.18;
access;
symbols
	OPENBSD_4_9:1.14.0.8
	OPENBSD_4_9_BASE:1.14
	OPENBSD_4_8:1.14.0.6
	OPENBSD_4_8_BASE:1.14
	OPENBSD_4_7:1.14.0.2
	OPENBSD_4_7_BASE:1.14
	OPENBSD_4_6:1.14.0.4
	OPENBSD_4_6_BASE:1.14
	OPENBSD_4_5:1.12.0.2
	OPENBSD_4_5_BASE:1.12
	OPENBSD_4_4:1.10.0.4
	OPENBSD_4_4_BASE:1.10
	OPENBSD_4_3:1.10.0.2
	OPENBSD_4_3_BASE:1.10
	OPENBSD_4_2:1.9.0.2
	OPENBSD_4_2_BASE:1.9
	OPENBSD_4_1:1.6.0.20
	OPENBSD_4_1_BASE:1.6
	OPENBSD_4_0:1.6.0.18
	OPENBSD_4_0_BASE:1.6
	OPENBSD_3_9:1.6.0.16
	OPENBSD_3_9_BASE:1.6
	OPENBSD_3_8:1.6.0.14
	OPENBSD_3_8_BASE:1.6
	OPENBSD_3_7:1.6.0.12
	OPENBSD_3_7_BASE:1.6
	OPENBSD_3_6:1.6.0.10
	OPENBSD_3_6_BASE:1.6
	OPENBSD_3_5:1.6.0.8
	OPENBSD_3_5_BASE:1.6
	OPENBSD_3_4:1.6.0.6
	OPENBSD_3_4_BASE:1.6
	OPENBSD_3_3:1.6.0.4
	OPENBSD_3_3_BASE:1.6
	OPENBSD_3_2:1.6.0.2
	OPENBSD_3_2_BASE:1.6
	OPENBSD_3_1:1.1.0.4
	OPENBSD_3_1_BASE:1.1
	OPENBSD_3_0:1.1.0.2
	OPENBSD_3_0_BASE:1.1;
locks; strict;
comment	@# @;


1.18
date	2011.07.07.19.16.43;	author deraadt;	state dead;
branches;
next	1.17;

1.17
date	2011.04.18.16.52.10;	author thib;	state Exp;
branches;
next	1.16;

1.16
date	2011.04.15.03.11.22;	author deraadt;	state Exp;
branches;
next	1.15;

1.15
date	2011.03.14.19.07.46;	author deraadt;	state Exp;
branches;
next	1.14;

1.14
date	2009.04.17.03.58.54;	author deraadt;	state Exp;
branches;
next	1.13;

1.13
date	2009.04.12.16.12.53;	author deraadt;	state Exp;
branches;
next	1.12;

1.12
date	2008.12.02.03.20.57;	author deraadt;	state Exp;
branches;
next	1.11;

1.11
date	2008.12.02.01.01.07;	author deraadt;	state Exp;
branches;
next	1.10;

1.10
date	2008.01.11.10.16.40;	author espie;	state Exp;
branches;
next	1.9;

1.9
date	2007.06.17.00.28.21;	author deraadt;	state Exp;
branches;
next	1.8;

1.8
date	2007.04.13.17.34.40;	author millert;	state Exp;
branches;
next	1.7;

1.7
date	2007.04.09.14.55.11;	author millert;	state Exp;
branches;
next	1.6;

1.6
date	2002.06.09.05.53.54;	author todd;	state Exp;
branches;
next	1.5;

1.5
date	2002.04.30.07.35.01;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	2002.04.28.18.28.34;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	2002.04.28.09.42.49;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	2002.04.25.22.10.28;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	2001.06.26.22.23.25;	author smurph;	state Exp;
branches;
next	;


desc
@@


1.18
log
@remove mvmeppc; it is really rough shape.  ok drahn miod
@
text
@#	$OpenBSD: Makefile,v 1.17 2011/04/18 16:52:10 thib Exp $

TOP=		${.CURDIR}/..

.include "${TOP}/Makefile.inc"
BSD_RD=		bsd.rd
IMAGE=		mr.fs
CBIN?=		instbin
LISTS=		${.CURDIR}/list
UTILS?=		${.CURDIR}/../../miniroot

MOUNT_POINT=	/mnt
MTREE=		${UTILS}/mtree.conf

VND?=		vnd0
VND_DEV=	/dev/${VND}a
VND_RDEV=	/dev/r${VND}a
VND_CRDEV=	/dev/r${VND}c
PID!=		echo $$$$


DISKTYPE=       rdroot
NBLKS=          8192
# minfree, opt, b/i  trks, sects, cpg
NEWFSARGS= -m 0 -o space

.ifndef DESTDIR
all ${IMAGE}:
	@@echo setenv DESTDIR before making a ramdisk!
	@@false
.else

# mix config is not needed.
all:	${BSD_RD} cd

${BSD_RD}: ${CBIN} ${IMAGE} bsd rdsetroot
	cp bsd ${BSD_RD}
	${.OBJDIR}/rdsetroot ${BSD_RD} ${IMAGE}

cd: ${BSD_RD}
	-rm -rf ${.OBJDIR}/cd-dir/
	-@@mkdir -p ${.OBJDIR}/cd-dir/${OSREV}/mvmeppc/
	cp bsd.rd ${.OBJDIR}/cd-dir/${OSREV}/mvmeppc/bsd.rd
	strip ${.OBJDIR}/cd-dir/${OSREV}/mvmeppc/bsd.rd
	gzip -9n ${.OBJDIR}/cd-dir/${OSREV}/mvmeppc/bsd.rd
	mv ${.OBJDIR}/cd-dir/${OSREV}/mvmeppc/bsd.rd.gz ${.OBJDIR}/cd-dir/${OSREV}/mvmeppc/bsd.rd


${IMAGE}: rd_setup do_files rd_teardown

.endif

bsd:
	cd ${TOP}/../../sys/arch/mvmeppc/conf && config RAMDISK
	cd ${TOP}/../../sys/arch/mvmeppc/compile/RAMDISK && \
	    ${MAKE} clean && exec ${MAKE}
	cp ${TOP}/../../sys/arch/mvmeppc/compile/RAMDISK/bsd bsd

rd_setup:
	dd if=/dev/zero of=${IMAGE} bs=512 count=${NBLKS}
	vnconfig -v -c ${VND} ${IMAGE}
	disklabel -w ${VND} ${DISKTYPE}
	newfs ${NEWFSARGS} ${VND_RDEV}
	fsck ${VND_RDEV}
	mount ${VND_DEV} ${MOUNT_POINT}

rd_teardown:
	@@df -i ${MOUNT_POINT}
	-umount ${MOUNT_POINT}
	-vnconfig -u ${VND}

rdsetroot:	${TOP}/../common/elfrdsetroot.c
	${HOSTCC} -o rdsetroot ${TOP}/../common/elfrdsetroot.c

unconfig:
	-umount -f ${MOUNT_POINT}
	-vnconfig -u ${VND}

.PRECIOUS:	${IMAGE}

${CBIN}.mk ${CBIN}.cache ${CBIN}.c: ${CBIN}.conf
	crunchgen -E -D ${.CURDIR}/../../.. -L ${DESTDIR}/usr/lib ${.ALLSRC}

${CBIN}: ${CBIN}.mk ${CBIN}.cache ${CBIN}.c
	${MAKE} -f ${CBIN}.mk all

do_files:
	mtree -def ${MTREE} -p ${MOUNT_POINT}/ -u
	TOPDIR=${TOP} CURDIR=${.CURDIR} OBJDIR=${.OBJDIR} \
	    REV=${REV} TARGDIR=${MOUNT_POINT} UTILS=${UTILS} \
	    RELEASEDIR=${RELEASEDIR} sh ${UTILS}/runlist.sh ${LISTS}
	rm ${MOUNT_POINT}/${CBIN}

clean cleandir:
	/bin/rm -f core ${IMAGE} ${CBIN} ${CBIN}.mk ${CBIN}.cache \
	    *.o *.lo *.c bsd ${BSD_RD} rdsetroot

.ifdef RELEASEDIR
install:
	cp ${BSD.RD} cd${REV}.fs ${RELEASEDIR}
.endif

.include <bsd.obj.mk>
.include <bsd.subdir.mk>
@


1.17
log
@Deprecate vnds in favour of svnds.

In effect, this removes the "old" vndX nodes, and renames
the svndX nodes to vndX.

Old svndX nodes will still continue to work though, for now.

Cleanup accordingly.

ok deraadt@@, todd@@
comments and ok on the man page bits from jmc@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.16 2011/04/15 03:11:22 deraadt Exp $
@


1.16
log
@No need to make depend kernels; ok guenther
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.15 2011/03/14 19:07:46 deraadt Exp $
d15 1
a15 1
VND?=		svnd0
@


1.15
log
@unify a chunk
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.14 2009/04/17 03:58:54 deraadt Exp $
d56 1
a56 1
	    ${MAKE} clean && ${MAKE} depend && ${MAKE}
@


1.14
log
@For SHA256 hashes to be ready to go onto the install media, we must
build the sets before we build the media.  While there we can get rid
of DESTDIR/snapshot too, and simply install straight into RELEASEDIR.
(This also ends up saving an astounding amount of traffic/latency in a nfs
environment)
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.13 2009/04/12 16:12:53 deraadt Exp $
d96 1
a96 2
	*.o *.lo *.c bsd ${BSD_RD} \
	rdsetroot
@


1.13
log
@run make depend for kernel, too; ok miod
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.12 2008/12/02 03:20:57 deraadt Exp $
a80 3
install:
	cp ${BSD_RD} cd${REV}.fs ${DESTDIR}/snapshot/

d91 1
a91 1
	    sh ${TOP}/runlist.sh ${LISTS}
d99 4
a102 2
beforeinstall:
	cp ${BSD.RD} cd${REV}.fs ${DESTDIR}/snapshot
@


1.12
log
@commit with rdsetroot now accepting the filesystem as a 2nd arg
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.11 2008/12/02 01:01:07 deraadt Exp $
d56 1
a56 1
	    ${MAKE} clean && ${MAKE}
@


1.11
log
@no longer need to compile rdsetroot with DEBUG
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.10 2008/01/11 10:16:40 espie Exp $
d38 1
a38 1
	${.OBJDIR}/rdsetroot ${BSD_RD} < ${IMAGE}
@


1.10
log
@cleanup: make -> ${MAKE} consistenly.
zap extra subshells.

okay miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.9 2007/06/17 00:28:21 deraadt Exp $
d73 1
a73 1
	${HOSTCC} -DDEBUG -o rdsetroot ${TOP}/../common/elfrdsetroot.c
@


1.9
log
@Stop using disklabel -r.  The disklabel code does not know all the semantics
for pushing disklabels onto the disk (and besides that, it is buggy and
unreadable crap); thanks for help from krw
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.8 2007/04/13 17:34:40 millert Exp $
d56 1
a56 1
	    make clean && make
d88 1
a88 1
	make -f ${CBIN}.mk all
@


1.8
log
@Update install media generation to the new semantics of the -c flag.
Also replace "newfs -O" with "newfs -O 0" now that -O takes an option.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.7 2007/04/09 14:55:11 millert Exp $
d62 1
a62 1
	disklabel -w -r ${VND} ${DISKTYPE}
@


1.7
log
@Add -n to gzip flags.  Save a few bytes since we no longer save
the uncompressed filename in the gzip header.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.6 2002/06/09 05:53:54 todd Exp $
d25 1
a25 1
NEWFSARGS= -m 0 -o space -c 16 -i 4096
@


1.6
log
@knf
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.5 2002/04/30 07:35:01 deraadt Exp $
d45 1
a45 1
	gzip -9 ${.OBJDIR}/cd-dir/${OSREV}/mvmeppc/bsd.rd
@


1.5
log
@instbin removal was not done; do in Makefile
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.4 2002/04/28 18:28:34 deraadt Exp $
d59 1
a59 1
rd_setup: 
@


1.4
log
@use single shared mtree.conf
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.3 2002/04/28 09:42:49 deraadt Exp $
d95 1
@


1.3
log
@use the shared elfsetroot
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.2 2002/04/25 22:10:28 deraadt Exp $
d13 1
a13 1
MTREE=		${.CURDIR}/mtree.conf
@


1.2
log
@runlist.sh & list2sh.awk unification
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.1 2001/06/26 22:23:25 smurph Exp $
d72 2
a73 2
rdsetroot:	${TOP}/common/rdsetroot.c
	${HOSTCC} -DDEBUG -o rdsetroot ${TOP}/common/rdsetroot.c
@


1.1
log
@Initial import of mvmeppc.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.17 2001/06/17 22:40:44 drahn Exp $
d93 2
a94 1
	    REV=${REV} TARGDIR=${MOUNT_POINT} sh ${TOP}/runlist.sh ${LISTS}
@

