head	1.2;
access;
symbols
	OPENBSD_6_0:1.2.0.10
	OPENBSD_6_0_BASE:1.2
	OPENBSD_5_9:1.2.0.6
	OPENBSD_5_9_BASE:1.2
	OPENBSD_5_8:1.2.0.8
	OPENBSD_5_8_BASE:1.2
	OPENBSD_5_7:1.2.0.2
	OPENBSD_5_7_BASE:1.2
	OPENBSD_5_6:1.2.0.4
	OPENBSD_5_6_BASE:1.2
	OPENBSD_5_5:1.1.0.2
	OPENBSD_5_5_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2014.03.18.14.35.01;	author aoyama;	state Exp;
branches;
next	1.1;

1.1
date	2014.02.27.18.55.39;	author miod;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Correct the location of 'bsd.rd'.

suggested by miod@@
@
text
@#	$OpenBSD: Makefile,v 1.1 2014/02/27 18:55:39 miod Exp $

TOP=	${.CURDIR}/..

.include "${TOP}/Makefile.inc"

TARGET=miniroot${REV}.fs

.ifndef DESTDIR
all ${TARGET}:
	@@echo setenv DESTDIR before creating a miniroot!
	@@false
.else

all: ${TARGET}

${TARGET}: vn_up install_files showit vn_down

vn_up: blank_filesystem
	vnconfig vnd0 ${TARGET}
	disklabel -w vnd0 miniroot
	newfs -m 0 -f 1024 -b 8192 /dev/rvnd0a
	mount /dev/vnd0a /mnt

showit:
	df -ki /mnt

vn_down:
	-umount /mnt
	-vnconfig -u vnd0

install_files: bsd.rd boot

bsd.rd:
	install -c -m 555 -o root -g wheel \
	    ${.OBJDIR}/../ramdisk/bsd.rd /mnt/bsd

boot:
	install -c -m 555 -o root -g wheel \
	    ${DESTDIR}/usr/mdec/boot /mnt/boot
	ln /mnt/boot /mnt/vmunix

blank_filesystem:
	dd if=/dev/zero of=${TARGET} bs=32k count=128	# 4MB

.endif

unconfig:
	-umount -f /mnt
	-vnconfig -u /dev/vnd0a

.ifdef RELEASEDIR
install:
	cp ${TARGET} ${RELEASEDIR}
.endif

clean:
	rm -f ${TARGET}

.include <bsd.own.mk>
.include <bsd.obj.mk>
.include <bsd.subdir.mk>
@


1.1
log
@Build a small miniroot filesystem which can be dumped on a new disk or an
existing swap partition for an easier initial installation.
@
text
@d1 1
a1 1
#	$OpenBSD$
d36 1
a36 1
	    ${.OBJDIR}/../../ramdisk/bsd.rd /mnt/bsd
@

