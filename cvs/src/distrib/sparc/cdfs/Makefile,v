head	1.9;
access;
symbols
	OPENBSD_6_0:1.9.0.22
	OPENBSD_6_0_BASE:1.9
	OPENBSD_5_9:1.9.0.18
	OPENBSD_5_9_BASE:1.9
	OPENBSD_5_8:1.9.0.20
	OPENBSD_5_8_BASE:1.9
	OPENBSD_5_7:1.9.0.14
	OPENBSD_5_7_BASE:1.9
	OPENBSD_5_6:1.9.0.16
	OPENBSD_5_6_BASE:1.9
	OPENBSD_5_5:1.9.0.12
	OPENBSD_5_5_BASE:1.9
	OPENBSD_5_4:1.9.0.10
	OPENBSD_5_4_BASE:1.9
	OPENBSD_5_3:1.9.0.8
	OPENBSD_5_3_BASE:1.9
	OPENBSD_5_2:1.9.0.6
	OPENBSD_5_2_BASE:1.9
	OPENBSD_5_1_BASE:1.9
	OPENBSD_5_1:1.9.0.4
	OPENBSD_5_0:1.9.0.2
	OPENBSD_5_0_BASE:1.9
	OPENBSD_4_9:1.6.0.8
	OPENBSD_4_9_BASE:1.6
	OPENBSD_4_8:1.6.0.6
	OPENBSD_4_8_BASE:1.6
	OPENBSD_4_7:1.6.0.2
	OPENBSD_4_7_BASE:1.6
	OPENBSD_4_6:1.6.0.4
	OPENBSD_4_6_BASE:1.6
	OPENBSD_4_5:1.5.0.18
	OPENBSD_4_5_BASE:1.5
	OPENBSD_4_4:1.5.0.16
	OPENBSD_4_4_BASE:1.5
	OPENBSD_4_3:1.5.0.14
	OPENBSD_4_3_BASE:1.5
	OPENBSD_4_2:1.5.0.12
	OPENBSD_4_2_BASE:1.5
	OPENBSD_4_1:1.5.0.10
	OPENBSD_4_1_BASE:1.5
	OPENBSD_4_0:1.5.0.8
	OPENBSD_4_0_BASE:1.5
	OPENBSD_3_9:1.5.0.6
	OPENBSD_3_9_BASE:1.5
	OPENBSD_3_8:1.5.0.4
	OPENBSD_3_8_BASE:1.5
	OPENBSD_3_7:1.5.0.2
	OPENBSD_3_7_BASE:1.5
	OPENBSD_3_6:1.4.0.2
	OPENBSD_3_6_BASE:1.4
	OPENBSD_3_5:1.3.0.2
	OPENBSD_3_5_BASE:1.3
	OPENBSD_3_4:1.2.0.2
	OPENBSD_3_4_BASE:1.2
	OPENBSD_3_3:1.1.0.2
	OPENBSD_3_3_BASE:1.1;
locks; strict;
comment	@# @;


1.9
date	2011.06.08.19.16.19;	author krw;	state Exp;
branches;
next	1.8;

1.8
date	2011.04.18.16.52.10;	author thib;	state Exp;
branches;
next	1.7;

1.7
date	2011.04.10.20.00.43;	author krw;	state Exp;
branches;
next	1.6;

1.6
date	2009.04.17.03.58.55;	author deraadt;	state Exp;
branches;
next	1.5;

1.5
date	2005.03.11.15.40.59;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	2004.08.11.06.49.35;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	2004.03.11.22.16.50;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	2003.08.12.20.25.01;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	2003.03.05.23.17.22;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.9
log
@Revert fakecdrom elimination pending further testing. ariane@@ pointed
out that sparc64 iso at least does not boot. Retain the svnd -> vnd
changes that happened after the original commit.
@
text
@#	$OpenBSD: Makefile,v 1.8 2011/04/18 16:52:10 thib Exp $

TOP=	${.CURDIR}/..

CDROM=	cd${OSrev}.iso

all: ${CDROM}

${CDROM}:
	-rm -rf ${.OBJDIR}/cd-dir
	mkdir -p ${.OBJDIR}/cd-dir/${OSREV}/sparc
	cp ${.OBJDIR}/../../ramdisk/bsd.rd ${.OBJDIR}/cd-dir/${OSREV}/sparc
	ln ${.OBJDIR}/cd-dir/${OSREV}/sparc/bsd.rd ${.OBJDIR}/cd-dir/bsd.rd
	ln ${.OBJDIR}/cd-dir/bsd.rd ${.OBJDIR}/cd-dir/bsd
	ln ${.OBJDIR}/cd-dir/bsd.rd ${.OBJDIR}/cd-dir/vmunix # for kicks
	cp ${DESTDIR}/usr/mdec/boot ${.OBJDIR}/cd-dir/${OSREV}/sparc
	cp ${DESTDIR}/usr/mdec/bootxx ${.OBJDIR}/cd-dir/${OSREV}/sparc
	(mkhybrid -a -R -v -v -T -L -d -D -N -o ${.OBJDIR}/${CDROM} \
	    -A "OpenBSD ${OSREV} sparc bootonly CD" \
	    -P "Copyright (c) `date +%Y` Theo de Raadt, The OpenBSD project" \
	    -p "Theo de Raadt <deraadt@@openbsd.org>" \
	    -V "OpenBSD/sparc   ${OSREV} boot-only CD" \
	    ${.OBJDIR}/cd-dir 2>&1) | tee log
	vnconfig -v -c vnd0 ${.OBJDIR}/${CDROM}
	mount -t cd9660 /dev/vnd0a /mnt
	/usr/mdec/installboot -v \
	    -s `cat log | grep -v 'Name' | egrep "/cd-dir/${OSREV}/sparc/boot$$" | cut -d' ' -f1` \
	    -e `cat log | grep -v 'Name' | egrep "/cd-dir/${OSREV}/sparc/boot$$" | cut -d' ' -f2` \
	    /mnt/${OSREV}/sparc/boot /usr/mdec/bootxx /dev/rvnd0c
	disklabel -w vnd0 fakecdrom "OpenBSD/sparc   "
	umount /mnt
	vnconfig -u vnd0
	# XXX Some sparc machines fail to load the kernel correctly if the
	# XXX cd image is truncated.  It is not yet known why this happens.
	# XXX For now we pad the image.
	dd if=/dev/zero bs=2k count=200 >> ${.OBJDIR}/${CDROM}

.ifdef RELEASEDIR
install:
	cp ${CDROM} ${RELEASEDIR}
.endif

clean cleandir:
	/bin/rm -f ${CDROM}
	rm -rf cd-dir log

unconfig:
	-umount /mnt
	-vnconfig -u vnd0

.include <bsd.obj.mk>
.include <bsd.subdir.mk>
@


1.8
log
@Deprecate vnds in favour of svnds.

In effect, this removes the "old" vndX nodes, and renames
the svndX nodes to vndX.

Old svndX nodes will still continue to work though, for now.

Cleanup accordingly.

ok deraadt@@, todd@@
comments and ok on the man page bits from jmc@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.7 2011/04/10 20:00:43 krw Exp $
d30 1
@


1.7
log
@'fakecdrom' disktab entry no longer needed, nor is mksuncd mangling of
the boot cd image.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.6 2009/04/17 03:58:55 deraadt Exp $
d24 2
a25 2
	vnconfig -v -c svnd0 ${.OBJDIR}/${CDROM}
	mount -t cd9660 /dev/svnd0a /mnt
d29 1
a29 1
	    /mnt/${OSREV}/sparc/boot /usr/mdec/bootxx /dev/rsvnd0c
d31 1
a31 1
	vnconfig -u svnd0
d48 1
a48 1
	-vnconfig -u svnd0
@


1.6
log
@For SHA256 hashes to be ready to go onto the install media, we must
build the sets before we build the media.  While there we can get rid
of DESTDIR/snapshot too, and simply install straight into RELEASEDIR.
(This also ends up saving an astounding amount of traffic/latency in a nfs
environment)
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.5 2005/03/11 15:40:59 deraadt Exp $
a29 1
	disklabel -w svnd0 fakecdrom "OpenBSD/sparc   "
@


1.5
log
@never worry about the copyright date on the CD layout again, problem
noticed by drahn
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.4 2004/08/11 06:49:35 deraadt Exp $
d38 1
d40 2
a41 1
	cp ${CDROM} ${DESTDIR}/snapshot
@


1.4
log
@pad the iso image; we do not know why this is needed at this time but
maybe someone will figure out why.  Put a big fat comment there about it.
diagnosed by miod and nick; this workaround tested by nick.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.3 2004/03/11 22:16:50 deraadt Exp $
d20 1
a20 1
	    -P "Copyright (c) 2004 Theo de Raadt, The OpenBSD project" \
@


1.3
log
@change copyrights on iso images, spotted by miod
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.2 2003/08/12 20:25:01 deraadt Exp $
d33 4
@


1.2
log
@do not hardcore 3.3 release
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.1 2003/03/05 23:17:22 deraadt Exp $
d20 1
a20 1
	    -P "Copyright (c) 2003 Theo de Raadt, The OpenBSD project" \
@


1.1
log
@cd${REV}.iso for sparc too
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.3 2003/03/04 20:24:49 deraadt Exp $
d27 3
a29 3
	    -s `cat log | grep -v 'Name' | egrep '/cd-dir/3.3/sparc/boot$$' | cut -d' ' -f1` \
	    -e `cat log | grep -v 'Name' | egrep '/cd-dir/3.3/sparc/boot$$' | cut -d' ' -f2` \
	    /mnt/3.3/sparc/boot /usr/mdec/bootxx /dev/rsvnd0c
@

