head	1.7;
access;
symbols
	OPENBSD_6_0:1.7.0.20
	OPENBSD_6_0_BASE:1.7
	OPENBSD_5_9:1.7.0.16
	OPENBSD_5_9_BASE:1.7
	OPENBSD_5_8:1.7.0.18
	OPENBSD_5_8_BASE:1.7
	OPENBSD_5_7:1.7.0.12
	OPENBSD_5_7_BASE:1.7
	OPENBSD_5_6:1.7.0.14
	OPENBSD_5_6_BASE:1.7
	OPENBSD_5_5:1.7.0.10
	OPENBSD_5_5_BASE:1.7
	OPENBSD_5_4:1.7.0.8
	OPENBSD_5_4_BASE:1.7
	OPENBSD_5_3:1.7.0.6
	OPENBSD_5_3_BASE:1.7
	OPENBSD_5_2:1.7.0.4
	OPENBSD_5_2_BASE:1.7
	OPENBSD_5_1_BASE:1.7
	OPENBSD_5_1:1.7.0.2
	OPENBSD_5_0:1.6.0.2
	OPENBSD_5_0_BASE:1.6
	OPENBSD_4_9:1.2.0.6
	OPENBSD_4_9_BASE:1.2
	OPENBSD_4_8:1.2.0.4
	OPENBSD_4_8_BASE:1.2
	OPENBSD_4_7:1.2.0.2
	OPENBSD_4_7_BASE:1.2;
locks; strict;
comment	@# @;


1.7
date	2011.11.14.23.21.27;	author deraadt;	state Exp;
branches;
next	1.6;

1.6
date	2011.07.24.02.08.10;	author deraadt;	state Exp;
branches;
next	1.5;

1.5
date	2011.07.15.16.29.57;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	2011.04.21.03.21.12;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	2011.04.18.16.52.10;	author thib;	state Exp;
branches;
next	1.2;

1.2
date	2010.02.15.22.56.21;	author kettenis;	state Exp;
branches;
next	1.1;

1.1
date	2010.02.15.13.51.07;	author kettenis;	state Exp;
branches;
next	;


desc
@@


1.7
log
@Don't do non-512 writes to vnd.  ok matthew
@
text
@
REV=	${OSrev}
BSD_RD=		bsd.rd

IMAGE=	miniroot${REV}.fs

MOUNT_POINT=	/mnt

VND?=		vnd0
VND_DEV=	/dev/${VND}a
VND_CDEV=	/dev/${VND}c
VND_IDEV=	/dev/${VND}i
VND_IRDEV=	/dev/r${VND}i
VND_RDEV=	/dev/r${VND}a
VND_CRDEV=	/dev/r${VND}c
PID!=		echo $$$$

DISKTYPE=       miniroot
NBLKS=		8064
# minfree, opt, b/i  trks, sects, cpg
NEWFSARGS= -m 0 -o space -i 4096


.ifndef DESTDIR
all ${IMAGE}:
	@@echo setenv DESTDIR before making a ramdisk!
	@@false
.else
all:	${IMAGE}

${IMAGE}: rd_setup do_files rd_teardown

.endif

do_files:
	dd if=${DESTDIR}/usr/mdec/boot.elf of=${VND_IRDEV} conv=osync
	gzip -c < ${.OBJDIR}/../ramdisk/bsd.rd > ${MOUNT_POINT}/bsd.rd
	ln ${MOUNT_POINT}/bsd.rd ${MOUNT_POINT}/bsd

rd_setup:
	dd if=/dev/zero of=${IMAGE} bs=512 count=${NBLKS}
	vnconfig -v -c -t ${DISKTYPE} ${VND} ${IMAGE}
	fdisk -i -y ${VND}
	disklabel -w ${VND} ${DISKTYPE}
	newfs ${NEWFSARGS} ${VND_RDEV}
	fsck ${VND_RDEV}
	mount ${VND_DEV} ${MOUNT_POINT}

rd_teardown:
	@@df -i ${MOUNT_POINT}
	-umount ${MOUNT_POINT}
	-vnconfig -u ${VND}


unconfig:
	-umount -f ${MOUNT_POINT}
	-vnconfig -u ${VND}

.PRECIOUS:	${IMAGE}

.ifdef RELEASEDIR
install:
	cp ${IMAGE} ${RELEASEDIR}
.endif

.include <bsd.obj.mk>
.include <bsd.subdir.mk>
@


1.6
log
@back out conv=sync change; the disk subsystem changes which "required"
this are gone, and halex points out that one of the dd's in use has
no conv= support.
@
text
@d36 1
a36 1
	dd if=${DESTDIR}/usr/mdec/boot.elf of=${VND_IRDEV}
@


1.5
log
@use conv=sync for bootblock install, now that vnd enforces 512 byte writes
@
text
@d36 1
a36 1
	dd if=${DESTDIR}/usr/mdec/boot.elf of=${VND_IRDEV} conv=sync
@


1.4
log
@This dd should be to the raw partition, so fix it.  On the other
hand it has spotted a minor bug in thib's new vnd code, which he
will fix tomorrow.
@
text
@d36 1
a36 1
	dd if=${DESTDIR}/usr/mdec/boot.elf of=${VND_IRDEV}
@


1.3
log
@Deprecate vnds in favour of svnds.

In effect, this removes the "old" vndX nodes, and renames
the svndX nodes to vndX.

Old svndX nodes will still continue to work though, for now.

Cleanup accordingly.

ok deraadt@@, todd@@
comments and ok on the man page bits from jmc@@
@
text
@d13 1
d36 1
a36 1
	dd if=${DESTDIR}/usr/mdec/boot.elf of=${VND_IDEV}
@


1.2
log
@Simplify MBR and install it as /usr/mdec/mbr instead of /usr/mdec/mbr.mini
since it makes a fairly decent template for fdisk -i.  Change the procedure
that makes the rb600 installation miniroot image to use fdisk -i instead of
dd(1) to create the MBR for the image.  Adjust the miniroot disk type in
/etc/disktab to the slightly different layout that fdisk -i creates.
@
text
@d9 1
a9 1
VND?=		svnd0
@


1.1
log
@Create an installation miniroot images for the rb600 that can be dd'ed to CF
which then simply boots the rb600 into the installer.
@
text
@d42 1
a42 1
	dd if=${DESTDIR}/usr/mdec/mbr.mini of=${VND_CDEV}
@

