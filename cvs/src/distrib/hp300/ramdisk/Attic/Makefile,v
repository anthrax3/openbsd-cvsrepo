head	1.31;
access;
symbols
	OPENBSD_5_5:1.30.0.6
	OPENBSD_5_5_BASE:1.30
	OPENBSD_5_4:1.30.0.4
	OPENBSD_5_4_BASE:1.30
	OPENBSD_5_3:1.30.0.2
	OPENBSD_5_3_BASE:1.30
	OPENBSD_5_2:1.29.0.6
	OPENBSD_5_2_BASE:1.29
	OPENBSD_5_1_BASE:1.29
	OPENBSD_5_1:1.29.0.4
	OPENBSD_5_0:1.29.0.2
	OPENBSD_5_0_BASE:1.29
	OPENBSD_4_9:1.27.0.8
	OPENBSD_4_9_BASE:1.27
	OPENBSD_4_8:1.27.0.6
	OPENBSD_4_8_BASE:1.27
	OPENBSD_4_7:1.27.0.2
	OPENBSD_4_7_BASE:1.27
	OPENBSD_4_6:1.27.0.4
	OPENBSD_4_6_BASE:1.27
	OPENBSD_4_5:1.26.0.2
	OPENBSD_4_5_BASE:1.26
	OPENBSD_4_4:1.24.0.4
	OPENBSD_4_4_BASE:1.24
	OPENBSD_4_3:1.24.0.2
	OPENBSD_4_3_BASE:1.24
	OPENBSD_4_2:1.23.0.2
	OPENBSD_4_2_BASE:1.23
	OPENBSD_4_1:1.21.0.2
	OPENBSD_4_1_BASE:1.21
	OPENBSD_4_0:1.20.0.4
	OPENBSD_4_0_BASE:1.20
	OPENBSD_3_9:1.20.0.2
	OPENBSD_3_9_BASE:1.20
	OPENBSD_3_8:1.18.0.14
	OPENBSD_3_8_BASE:1.18
	OPENBSD_3_7:1.18.0.12
	OPENBSD_3_7_BASE:1.18
	OPENBSD_3_6:1.18.0.10
	OPENBSD_3_6_BASE:1.18
	OPENBSD_3_5:1.18.0.8
	OPENBSD_3_5_BASE:1.18
	OPENBSD_3_4:1.18.0.6
	OPENBSD_3_4_BASE:1.18
	OPENBSD_3_3:1.18.0.4
	OPENBSD_3_3_BASE:1.18
	OPENBSD_3_2:1.18.0.2
	OPENBSD_3_2_BASE:1.18
	OPENBSD_3_1:1.15.0.12
	OPENBSD_3_1_BASE:1.15
	OPENBSD_3_0:1.15.0.10
	OPENBSD_3_0_BASE:1.15
	OPENBSD_2_9:1.15.0.8
	OPENBSD_2_9_BASE:1.15
	OPENBSD_2_8:1.15.0.6
	OPENBSD_2_8_BASE:1.15
	OPENBSD_2_7:1.15.0.4
	OPENBSD_2_7_BASE:1.15
	OPENBSD_2_6:1.15.0.2
	OPENBSD_2_6_BASE:1.15
	OPENBSD_2_5:1.13.0.2
	OPENBSD_2_5_BASE:1.13
	OPENBSD_2_4:1.12.0.4
	OPENBSD_2_4_BASE:1.12
	OPENBSD_2_3:1.12.0.2
	OPENBSD_2_3_BASE:1.12
	OPENBSD_2_2:1.9.0.2
	OPENBSD_2_2_BASE:1.9
	OPENBSD_2_1:1.5.0.2
	OPENBSD_2_1_BASE:1.5;
locks; strict;
comment	@# @;


1.31
date	2014.03.18.22.36.28;	author miod;	state dead;
branches;
next	1.30;

1.30
date	2013.02.02.13.34.29;	author miod;	state Exp;
branches;
next	1.29;

1.29
date	2011.04.18.16.52.09;	author thib;	state Exp;
branches;
next	1.28;

1.28
date	2011.04.15.03.11.22;	author deraadt;	state Exp;
branches;
next	1.27;

1.27
date	2009.04.17.03.58.54;	author deraadt;	state Exp;
branches;
next	1.26;

1.26
date	2008.12.02.03.20.57;	author deraadt;	state Exp;
branches;
next	1.25;

1.25
date	2008.12.02.01.01.07;	author deraadt;	state Exp;
branches;
next	1.24;

1.24
date	2008.01.11.10.16.40;	author espie;	state Exp;
branches;
next	1.23;

1.23
date	2007.04.13.17.34.40;	author millert;	state Exp;
branches;
next	1.22;

1.22
date	2007.04.09.14.55.11;	author millert;	state Exp;
branches;
next	1.21;

1.21
date	2007.02.16.16.56.22;	author tsi;	state Exp;
branches;
next	1.20;

1.20
date	2006.02.15.22.00.59;	author pvalchev;	state Exp;
branches;
next	1.19;

1.19
date	2005.11.22.23.10.56;	author miod;	state Exp;
branches;
next	1.18;

1.18
date	2002.05.27.02.58.40;	author deraadt;	state Exp;
branches;
next	1.17;

1.17
date	2002.04.25.22.12.08;	author deraadt;	state Exp;
branches;
next	1.16;

1.16
date	2002.04.25.22.10.27;	author deraadt;	state Exp;
branches;
next	1.15;

1.15
date	99.08.16.09.30.05;	author downsj;	state Exp;
branches;
next	1.14;

1.14
date	99.06.22.13.19.36;	author deraadt;	state Exp;
branches;
next	1.13;

1.13
date	99.04.02.06.17.00;	author millert;	state Exp;
branches;
next	1.12;

1.12
date	98.03.28.23.40.47;	author millert;	state Exp;
branches;
next	1.11;

1.11
date	98.02.13.10.23.34;	author deraadt;	state Exp;
branches;
next	1.10;

1.10
date	97.10.31.05.41.27;	author downsj;	state Exp;
branches;
next	1.9;

1.9
date	97.10.20.04.23.31;	author downsj;	state Exp;
branches
	1.9.2.1;
next	1.8;

1.8
date	97.10.20.03.42.11;	author downsj;	state Exp;
branches;
next	1.7;

1.7
date	97.09.26.02.09.54;	author millert;	state Exp;
branches;
next	1.6;

1.6
date	97.09.05.21.16.48;	author deraadt;	state Exp;
branches;
next	1.5;

1.5
date	97.05.14.18.38.57;	author niklas;	state Exp;
branches;
next	1.4;

1.4
date	97.05.11.20.01.54;	author millert;	state Exp;
branches;
next	1.3;

1.3
date	97.04.21.07.32.11;	author downsj;	state Exp;
branches;
next	1.2;

1.2
date	97.02.23.19.10.50;	author downsj;	state Exp;
branches;
next	1.1;

1.1
date	97.02.16.18.20.00;	author downsj;	state Exp;
branches;
next	;

1.9.2.1
date	97.10.31.05.46.03;	author downsj;	state Exp;
branches;
next	;


desc
@@


1.31
log
@Retire hp300, mvme68k and mvme88k ports. These ports have no users, keeping
this hardware alive is becoming increasingly difficult, and I should heed the
message sent by the three disks which have died on me over the last few days.

Noone sane will mourn these ports anyway. So long, and thanks for the fish.
@
text
@#	$OpenBSD: Makefile,v 1.30 2013/02/02 13:34:29 miod Exp $
#	$NetBSD: Makefile,v 1.1 1995/07/18 04:13:06 briggs Exp $

TOP=		${.CURDIR}/..

.include "${TOP}/Makefile.inc"
IMAGE=		ramdisk-${REV}.fs
CRUNCHCONF?=    ${CBIN}.conf
BASE=		ramdisk

MOUNT_POINT=	/mnt

VND?=		vnd0
VND_DEV=	/dev/${VND}a
VND_RDEV=	/dev/r${VND}a
VND_CRDEV=	/dev/r${VND}c
PID!=		echo $$$$
REALIMAGE!=	echo /var/tmp/image.${PID}

GZIPCMD?=	gzip
GZIPFLAGS?=	-9fn

all: ${CBIN} ${IMAGE} bsd.rd

.ifdef RELEASEDIR
install: bsd.rd
	${GZIPCMD} -c ${GZIPFLAGS} bsd.rd > ${RELEASEDIR}/bsd.rd
.endif

.include "Makefile.inc"

DISKTYPE=       rdroot
NBLKS=          4096
NEWFSARGS= -m 0 -o space -i 3072

bsd.rd:	rdsetroot
.ifndef(NOBUILD)
	cd ${.CURDIR}/../../../sys/arch/hp300/conf && config RAMDISK
	cd ${.CURDIR}/../../../sys/arch/hp300/compile/RAMDISK && \
	    ${MAKE} clean && COPTS=-Os exec ${MAKE}
.endif
	cp ${.CURDIR}/../../../sys/arch/hp300/compile/RAMDISK/bsd bsd.rd
	${.OBJDIR}/rdsetroot bsd.rd ${IMAGE}

${IMAGE}: ${CBIN} rd_setup do_files rd_teardown

rd_setup: ${CBIN}
	dd if=/dev/zero of=${REALIMAGE} bs=512 count=${NBLKS}
	vnconfig -v -c ${VND} ${REALIMAGE}
	disklabel -w ${VND} ${DISKTYPE}
	newfs ${NEWFSARGS} ${VND_RDEV}
	fsck ${VND_RDEV}
	mount ${VND_DEV} ${MOUNT_POINT}

rd_teardown:
	@@df -i ${MOUNT_POINT}
	-umount ${MOUNT_POINT}
	-vnconfig -u ${VND}
	cp ${REALIMAGE} ${IMAGE}
	rm ${REALIMAGE}

rdsetroot:	${TOP}/../common/elfrdsetroot.c
	${HOSTCC} -o rdsetroot \
	    ${TOP}/../common/elfrdsetroot.c ${TOP}/../common/elf32.c \
	    ${TOP}/../common/elf64.c

unconfig:
	-umount -f ${MOUNT_POINT}
	-vnconfig -u ${VND}
	-/bin/rm -f ${IMAGE}

.PRECIOUS:	${IMAGE}
@


1.30
log
@hp300 ELF bits. Requires many device and prom related structs to now be declared
as packed due to them containing 32-bit types at 16-bit but not 32-bit aligned
offsets. The boot block updates (especially mkboot) come straight from NetBSD.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.29 2011/04/18 16:52:09 thib Exp $
@


1.29
log
@Deprecate vnds in favour of svnds.

In effect, this removes the "old" vndX nodes, and renames
the svndX nodes to vndX.

Old svndX nodes will still continue to work though, for now.

Cleanup accordingly.

ok deraadt@@, todd@@
comments and ok on the man page bits from jmc@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.28 2011/04/15 03:11:22 deraadt Exp $
d62 4
a65 2
rdsetroot:	${TOP}/../common/rdsetroot.c
	${HOSTCC} -o rdsetroot ${TOP}/../common/rdsetroot.c
@


1.28
log
@No need to make depend kernels; ok guenther
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.27 2009/04/17 03:58:54 deraadt Exp $
d13 1
a13 1
VND?=		svnd0
@


1.27
log
@For SHA256 hashes to be ready to go onto the install media, we must
build the sets before we build the media.  While there we can get rid
of DESTDIR/snapshot too, and simply install straight into RELEASEDIR.
(This also ends up saving an astounding amount of traffic/latency in a nfs
environment)
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.26 2008/12/02 03:20:57 deraadt Exp $
d40 1
a40 1
	    ${MAKE} clean && ${MAKE} depend && COPTS=-Os ${MAKE}
@


1.26
log
@commit with rdsetroot now accepting the filesystem as a 2nd arg
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.25 2008/12/02 01:01:07 deraadt Exp $
d25 1
d27 2
a28 1
	${GZIPCMD} -c ${GZIPFLAGS} bsd.rd > ${DESTDIR}/snapshot/bsd.rd
@


1.25
log
@no longer need to compile rdsetroot with DEBUG
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.24 2008/01/11 10:16:40 espie Exp $
d41 1
a41 1
	${.OBJDIR}/rdsetroot bsd.rd < ${IMAGE}
@


1.24
log
@cleanup: make -> ${MAKE} consistenly.
zap extra subshells.

okay miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.23 2007/04/13 17:34:40 millert Exp $
d61 1
a61 1
	${HOSTCC} -DDEBUG -o rdsetroot ${TOP}/../common/rdsetroot.c
@


1.23
log
@Update install media generation to the new semantics of the -c flag.
Also replace "newfs -O" with "newfs -O 0" now that -O takes an option.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.22 2007/04/09 14:55:11 millert Exp $
d38 1
a38 1
	    make clean && make depend && COPTS=-Os make
@


1.22
log
@Add -n to gzip flags.  Save a few bytes since we no longer save
the uncompressed filename in the gzip header.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.21 2007/02/16 16:56:22 tsi Exp $
d32 1
a32 1
NEWFSARGS= -m 0 -o space -c 16 -i 3072
@


1.21
log
@s/GZIP/GZIPCMD/g in `make release` structure to avoid conflict with gzip's
use of a GZIP environment variable for extra command flags.

ok deraadt@@, millert@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.20 2006/02/15 22:00:59 pvalchev Exp $
d21 1
a21 1
GZIPFLAGS?=	-9f
@


1.20
log
@build rdsetroot (needed to build bsd.rd), miodski broke it in november!
(tsk tsk) since he uses a non-standard build apparently; noticed by me and theo
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.19 2005/11/22 23:10:56 miod Exp $
d20 1
a20 1
GZIP?=		gzip
d26 1
a26 1
	${GZIP} -c ${GZIPFLAGS} bsd.rd > ${DESTDIR}/snapshot/bsd.rd
@


1.19
log
@- remove HP-IB.geometry which is not useful since a long time (since we put
  real disklabels on HP-IB disks, actually) and will confuse mere mortals.
- install a gzipped version of bsd.rd, boots faster from network and not much
  slower from local disk, and our bootloaders groks gzipped files since a very
  long time already.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.18 2002/05/27 02:58:40 deraadt Exp $
d34 1
a34 1
bsd.rd:
@


1.18
log
@catch up to the new build methods
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.17 2002/04/25 22:12:08 deraadt Exp $
d23 1
a23 1
all: ${CBIN} ${IMAGE} bsd.rd bsd.rd.gz
d26 1
a26 2
	cp bsd.rd ${DESTDIR}/snapshot/bsd.rd
	cp ${.CURDIR}/../common/HP-IB.geometry ${DESTDIR}/snapshot
a33 4
bsd.rd.gz: ${IMAGE} bsd.rd rdsetroot
	${.OBJDIR}/rdsetroot bsd.rd < ${IMAGE}
	${GZIP} -c ${GZIPFLAGS} bsd.rd > bsd.rd.gz

d35 1
d39 1
d41 1
@


1.17
log
@move this into a less visible place
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.16 2002/04/25 22:10:27 deraadt Exp $
d8 1
a8 1
CRUNCHCONF?=    ${.CURDIR}/${CBIN}.conf
@


1.16
log
@runlist.sh & list2sh.awk unification
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.15 1999/08/16 09:30:05 downsj Exp $
d27 1
a27 1
	cp ${.CURDIR}/../HP-IB.geometry ${DESTDIR}/snapshot
@


1.15
log
@bsd.rd is uncompressed, bsd.rd.gz is compressed.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.14 1999/06/22 13:19:36 deraadt Exp $
a23 1
	@@echo "all done"
@


1.14
log
@smaller ramdisk
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.13 1999/04/02 06:17:00 millert Exp $
d23 1
a23 1
all: ${CBIN} ${IMAGE} bsd.rd
d36 3
a38 3
bsd.rd: ${IMAGE} bsd rdsetroot
	${.OBJDIR}/rdsetroot bsd < ${IMAGE}
	${GZIP} -c ${GZIPFLAGS} bsd > bsd.rd
d40 1
a40 1
bsd:
d44 1
a44 1
	cp ${.CURDIR}/../../../sys/arch/hp300/compile/RAMDISK/bsd bsd
@


1.13
log
@Don't delete bsd when we make bsd.rd.  Kernel compiles on hp300 take
a llllooonnnngggg time so we really don't want to do one when we don't
have to do we?  I didn't think so.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.12 1998/03/28 23:40:47 millert Exp $
d43 1
a43 1
	    make clean && make depend && make
@


1.12
log
@Use miniroot install.{sh,sub}.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.11 1998/02/13 10:23:34 deraadt Exp $
a38 1
	rm bsd
@


1.11
log
@make depend
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.10 1997/10/31 05:41:27 downsj Exp $
d9 1
a9 1
BASE=miniroot
d20 3
d38 1
a38 1
	gzip -c9 bsd > bsd.rd
a72 2


@


1.10
log
@Final pass through the ramdisk installer.  Seems to work correctly.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.9 1997/10/20 04:23:31 downsj Exp $
d41 1
a41 1
	    make clean && make
@


1.9
log
@install target.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.8 1997/10/20 03:42:11 downsj Exp $
d49 1
a49 1
	disklabel -w -r ${VND} ${DISKTYPE}
@


1.9.2.1
log
@Pull from trunk, rev 1.10
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.10 1997/10/31 05:41:27 downsj Exp $
d49 1
a49 1
	disklabel -w ${VND} ${DISKTYPE}
@


1.8
log
@Increase inodes, make compressed ramdisk build automatic.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.7 1997/09/26 02:09:54 millert Exp $
d22 4
@


1.7
log
@Fix some newfs usage.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.6 1997/09/05 21:16:48 deraadt Exp $
d20 1
a20 1
all: ${CBIN} ${IMAGE}
d27 1
a27 5
# minfree, opt, b/i  trks, sects, cpg
NEWFSARGS= -m 0 -o space -c 16 -i 4096

bsd.gz: bsd.rd
	gzip -c9 bsd.rd > bsd.gz
d30 3
a32 2
	cp bsd bsd.rd
	${.OBJDIR}/rdsetroot bsd.rd < ${IMAGE}
@


1.6
log
@make depend (in this case) is a total waste of time
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.5 1997/05/14 18:38:57 niklas Exp $
d49 1
a49 1
	newfs ${NEWFSARGS} ${VND_RDEV} ${DISKTYPE}
@


1.5
log
@Use svnds and remove ugly cache flushing
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.4 1997/05/11 20:01:54 millert Exp $
d38 3
a40 3
#	cd ${.CURDIR}/../../../sys/arch/hp300/conf && config RAMDISK
#	cd ${.CURDIR}/../../../sys/arch/hp300/compile/RAMDISK && \
#	    make clean && make depend && make
@


1.4
log
@Build filesystems images in /var/tmp to avoid panic'ing if /tmp is MFS.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.3 1997/04/21 07:32:11 downsj Exp $
d13 1
a13 1
VND?=		vnd0
a54 3
	sync
	cat /*bin/* > /dev/null
	sync
@


1.3
log
@Lots of changes...

* Build via a vnd, ala i386.
* Remove most of the sleep calls and all of the background processing.
* Add the notion of `kernel sets'.
* Add a couple more binaries to the ramdisk.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.2 1997/02/23 19:10:50 downsj Exp $
d18 1
a18 1
REALIMAGE!=	echo /tmp/image.${PID}
@


1.2
log
@Checkpoint.  This should be pretty close now, just gotta fix kernel
bugs.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.1 1997/02/16 18:20:00 downsj Exp $
d7 1
a7 1
IMAGE=		miniroot-${REV}.fs
d11 1
a11 4
MOUNT_POINT=	/mnt1
BDEV=		/dev/rd0a
CDEV=		/dev/rrd0a
RDEV=		/dev/rd0c
d13 6
a18 1
KERNEL=		${SRCSYSDIR}/arch/hp300/compile/RAMDISK/bsd
d27 2
a28 2
# old format, minfree, opt, b/i  trks, sects, cpg
#NEWFSARGS= -t ffs -m 0 -o space -u 32 -c 16
d30 24
a53 34
${IMAGE}:	do_prep do_mount do_files do_umount_copy do_unconfig
	mv -f ${IMAGE}.tmp ${IMAGE}
	if [ -e ${.CURDIR}/${__objdir}/rd.pid ] ; then \
	kill `< ${.CURDIR}/${__objdir}/rd.pid`; \
	rm ${.CURDIR}/${__objdir}/rd.pid;\
	fi

rdsetroot:	${TOP}/common/rdsetroot.c
	${HOSTCC} -o rdsetroot ${TOP}/common/rdsetroot.c

setroot: ${IMAGE} bsd 
	${.CURDIR}/${__objdir}/rdsetroot bsd < ${IMAGE}

bsd:	${KERNEL}
	cp ${KERNEL} bsd

writetape:
	echo rewinding tape < /dev/rst0
	buffer -i /usr/mdec/stboot -o /dev/nrst0
	buffer -i /usr/mdec/bootst -o /dev/nrst0
	buffer -B -p75 -i bsd -o /dev/nrst0
	echo rewinding tape < /dev/rst0


do_prep: ${CBIN} do_unconfig
	sh ${.CURDIR}/start_rdconfig.sh ${RDEV} ${NBLKS}
	disklabel -w -r ${RDEV} ${DISKTYPE}
	
do_mount:
	-newfs ${NEWFSARGS} -s ${NBLKS} ${CDEV} ${DISKTYPE}
	mount ${BDEV} ${MOUNT_POINT}
 
do_umount_copy:
	@@echo ""
d55 3
a57 1
	@@echo ""
d59 11
a69 9
	dd if=${CDEV} of=${IMAGE}.tmp bs=4b count=`expr ${NBLKS} / 4 `

do_unconfig:
	-umount ${MOUNT_POINT}
	if [ -e ${.CURDIR}/${__objdir}/rd.pid ] ; then \
	kill `< ${.CURDIR}/${__objdir}/rd.pid`; \
	rm ${.CURDIR}/${__objdir}/rd.pid; \
	fi

@


1.1
log
@Prelimary addition of the ramdisk-based miniroot.  Still needs work.
(Stolen wholesale from mvme68k.)

The miniroot subdir is obsolete, and subject to removal.
@
text
@d1 1
a1 1
#	$OpenBSD$
d16 1
a16 1
KERNEL=		${SRCSYSDIR}/arch/hp300/compile/MINIROOT/bsd
d30 3
a32 3
	if [ -e rd.pid ] ; then \
	kill `< rd.pid`; \
	rm rd.pid;\
d69 3
a71 3
	if [ -e rd.pid ] ; then \
	kill `< rd.pid`; \
	rm rd.pid; \
@
