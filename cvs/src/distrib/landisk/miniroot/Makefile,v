head	1.16;
access;
symbols
	OPENBSD_6_2:1.16.0.10
	OPENBSD_6_2_BASE:1.16
	OPENBSD_6_1:1.16.0.8
	OPENBSD_6_1_BASE:1.16
	OPENBSD_6_0:1.16.0.4
	OPENBSD_6_0_BASE:1.16
	OPENBSD_5_9:1.16.0.2
	OPENBSD_5_9_BASE:1.16
	OPENBSD_5_8:1.15.0.20
	OPENBSD_5_8_BASE:1.15
	OPENBSD_5_7:1.15.0.14
	OPENBSD_5_7_BASE:1.15
	OPENBSD_5_6:1.15.0.16
	OPENBSD_5_6_BASE:1.15
	OPENBSD_5_5:1.15.0.12
	OPENBSD_5_5_BASE:1.15
	OPENBSD_5_4:1.15.0.10
	OPENBSD_5_4_BASE:1.15
	OPENBSD_5_3:1.15.0.8
	OPENBSD_5_3_BASE:1.15
	OPENBSD_5_2:1.15.0.6
	OPENBSD_5_2_BASE:1.15
	OPENBSD_5_1_BASE:1.15
	OPENBSD_5_1:1.15.0.4
	OPENBSD_5_0:1.15.0.2
	OPENBSD_5_0_BASE:1.15
	OPENBSD_4_9:1.14.0.8
	OPENBSD_4_9_BASE:1.14
	OPENBSD_4_8:1.14.0.6
	OPENBSD_4_8_BASE:1.14
	OPENBSD_4_7:1.14.0.2
	OPENBSD_4_7_BASE:1.14
	OPENBSD_4_6:1.14.0.4
	OPENBSD_4_6_BASE:1.14
	OPENBSD_4_5:1.12.0.4
	OPENBSD_4_5_BASE:1.12
	OPENBSD_4_4:1.12.0.2
	OPENBSD_4_4_BASE:1.12
	OPENBSD_4_3:1.11.0.4
	OPENBSD_4_3_BASE:1.11
	OPENBSD_4_2:1.11.0.2
	OPENBSD_4_2_BASE:1.11
	OPENBSD_4_1:1.9.0.2
	OPENBSD_4_1_BASE:1.9;
locks; strict;
comment	@# @;


1.16
date	2015.10.05.04.31.21;	author miod;	state Exp;
branches;
next	1.15;
commitid	rv63rMuhvBrBmnEZ;

1.15
date	2011.04.18.16.52.09;	author thib;	state Exp;
branches;
next	1.14;

1.14
date	2009.04.17.03.58.54;	author deraadt;	state Exp;
branches;
next	1.13;

1.13
date	2009.03.28.16.34.24;	author krw;	state Exp;
branches;
next	1.12;

1.12
date	2008.08.17.15.14.44;	author krw;	state Exp;
branches;
next	1.11;

1.11
date	2007.06.17.00.28.21;	author deraadt;	state Exp;
branches;
next	1.10;

1.10
date	2007.04.13.17.34.40;	author millert;	state Exp;
branches;
next	1.9;

1.9
date	2007.02.23.20.01.51;	author deraadt;	state Exp;
branches;
next	1.8;

1.8
date	2006.11.13.20.36.21;	author deraadt;	state Exp;
branches;
next	1.7;

1.7
date	2006.11.09.15.36.03;	author drahn;	state Exp;
branches;
next	1.6;

1.6
date	2006.11.09.00.36.41;	author drahn;	state Exp;
branches;
next	1.5;

1.5
date	2006.11.08.23.58.03;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	2006.11.08.23.52.30;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	2006.11.08.23.45.17;	author drahn;	state Exp;
branches;
next	1.2;

1.2
date	2006.11.08.23.26.16;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	2006.11.08.23.08.46;	author drahn;	state Exp;
branches;
next	;


desc
@@


1.16
log
@Use MI installboot instead of disklabel -B to put boot blocks on installation
media.
@
text
@
REV=	${OSrev}
BSD_RD=		bsd.rd

IMAGE=	miniroot${REV}.fs

MOUNT_POINT=	/mnt

VND?=		vnd0
VND_DEV=	/dev/${VND}a
VND_RDEV=	/dev/r${VND}a
VND_CRDEV=	/dev/r${VND}c
PID!=		echo $$$$

DISKTYPE=       miniroot2.5M
#NBLKS=		8192
NBLKS=		5120
# minfree, opt, b/i  trks, sects, cpg
NEWFSARGS= -m 0 -o space -i 4096


.ifndef DESTDIR
all ${IMAGE}:
	@@echo setenv DESTDIR before making a ramdisk!
	@@false
.else
all:	${IMAGE}

${IMAGE}: rd_setup do_files rd_teardown

.endif

do_files:
	installboot -vr ${MOUNT_POINT} ${VND} \
	    ${DESTDIR}/usr/mdec/xxboot ${DESTDIR}/usr/mdec/boot
	gzip -c < ${.OBJDIR}/../ramdisk/bsd.rd > ${MOUNT_POINT}/bsd.rd
	ln ${MOUNT_POINT}/bsd.rd ${MOUNT_POINT}/bsd

rd_setup:
	dd if=/dev/zero of=${IMAGE} bs=512 count=${NBLKS}
	vnconfig -v -c -t ${DISKTYPE} ${VND} ${IMAGE}
	fdisk -i -y ${VND}
	fdisk -u -y -f ${DESTDIR}/usr/mdec/mbr ${VND}
	disklabel -w ${VND} ${DISKTYPE}
	newfs ${NEWFSARGS} ${VND_RDEV}
	mount ${VND_DEV} ${MOUNT_POINT}

rd_teardown:
	@@df -i ${MOUNT_POINT}
	-umount ${MOUNT_POINT}
	-vnconfig -u ${VND}


unconfig:
	-umount -f ${MOUNT_POINT}
	-vnconfig -u ${VND}

.PRECIOUS:	${IMAGE}

.ifdef RELEASEDIR
install:
	cp ${IMAGE} ${RELEASEDIR}
.endif

.include <bsd.obj.mk>
.include <bsd.subdir.mk>
@


1.15
log
@Deprecate vnds in favour of svnds.

In effect, this removes the "old" vndX nodes, and renames
the svndX nodes to vndX.

Old svndX nodes will still continue to work though, for now.

Cleanup accordingly.

ok deraadt@@, todd@@
comments and ok on the man page bits from jmc@@
@
text
@d34 2
a35 1
	cp ${DESTDIR}/usr/mdec/boot ${MOUNT_POINT}/boot
a44 1
	disklabel -v -B -b ${DESTDIR}/usr/mdec/xxboot ${VND} 
a45 1
	fsck ${VND_RDEV}
@


1.14
log
@For SHA256 hashes to be ready to go onto the install media, we must
build the sets before we build the media.  While there we can get rid
of DESTDIR/snapshot too, and simply install straight into RELEASEDIR.
(This also ends up saving an astounding amount of traffic/latency in a nfs
environment)
@
text
@d9 1
a9 1
VND?=		svnd0
@


1.13
log
@Use vnconfig's -t capability to avoid specifying geometry info to
fdisk while building media.

ok deraadt@@
@
text
@d61 1
d63 2
a64 1
	cp ${IMAGE} ${DESTDIR}/snapshot/
@


1.12
log
@Force fdisk to use the same geometry as the miniroot2.5M disktab
entry, the one that the disklabel will use, rather than the vnd
default geometry. Lets the generated miniroot44.fs boot again.

Problem found by Diana Eichart. Suggestions from drahn@@.

ok deraadt@@
@
text
@d40 3
a42 3
	vnconfig -v -c ${VND} ${IMAGE}
	fdisk -i -y -c 160 -h 2 -s 16 ${VND}
	fdisk -u -y -c 160 -h 2 -s 16 -f ${DESTDIR}/usr/mdec/mbr ${VND}
@


1.11
log
@Stop using disklabel -r.  The disklabel code does not know all the semantics
for pushing disklabels onto the disk (and besides that, it is buggy and
unreadable crap); thanks for help from krw
@
text
@d41 2
a42 3
	disklabel -w ${VND} ${DISKTYPE}
	fdisk -i -y ${VND}
	fdisk -u -f ${DESTDIR}/usr/mdec/mbr -y ${VND}
@


1.10
log
@Update install media generation to the new semantics of the -c flag.
Also replace "newfs -O" with "newfs -O 0" now that -O takes an option.
@
text
@d41 1
a41 1
	disklabel -w -r ${VND} ${DISKTYPE}
d44 1
a44 1
	disklabel -w -r ${VND} ${DISKTYPE}
@


1.9
log
@how about we use a release-specific output filename....
@
text
@d19 1
a19 1
NEWFSARGS= -m 0 -o space -c 16 -i 4096
@


1.8
log
@link bsd to bsd.rd to make it autoboot
@
text
@d5 1
a5 1
IMAGE=	miniroot40.fs
@


1.7
log
@build something by default.
@
text
@d36 1
@


1.6
log
@fdisk/disklabel jig to make the label come out right.
@
text
@d27 1
@


1.5
log
@now that fdisk knows landisk machines have a /usr/mdec/mbr, no need to use -f
@
text
@d15 1
a15 1
DISKTYPE=       rdroot2.5M
d39 3
a41 1
	fdisk -i -u -y ${VND}
@


1.4
log
@install the landisk mbr, not the builtin i386 mbr
@
text
@d39 1
a39 2
	fdisk -i -y ${VND}
	fdisk -u -f ${DESTDIR}/usr/mdec/mbr -y ${VND}
@


1.3
log
@For now, -i and -u need to be different invocations. ie fix bug in fdisk
@
text
@d40 1
a40 1
	fdisk -u -y ${VND}
@


1.2
log
@verbose disklabel -B, and fdisk -u and -y
@
text
@d39 2
a40 1
	fdisk -i -u -y ${VND}
@


1.1
log
@Build miniroot filesystem (for dding onto CF)
@
text
@d39 1
a39 1
	fdisk -i ${VND}
d41 1
a41 1
	disklabel -B -b ${DESTDIR}/usr/mdec/xxboot ${VND} 
@

