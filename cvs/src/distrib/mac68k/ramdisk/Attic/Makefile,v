head	1.17;
access;
symbols
	OPENBSD_5_1_BASE:1.16
	OPENBSD_5_1:1.16.0.4
	OPENBSD_5_0:1.16.0.2
	OPENBSD_5_0_BASE:1.16
	OPENBSD_4_9:1.13.0.8
	OPENBSD_4_9_BASE:1.13
	OPENBSD_4_8:1.13.0.6
	OPENBSD_4_8_BASE:1.13
	OPENBSD_4_7:1.13.0.2
	OPENBSD_4_7_BASE:1.13
	OPENBSD_4_6:1.13.0.4
	OPENBSD_4_6_BASE:1.13
	OPENBSD_4_5:1.12.0.2
	OPENBSD_4_5_BASE:1.12
	OPENBSD_4_4:1.10.0.4
	OPENBSD_4_4_BASE:1.10
	OPENBSD_4_3:1.10.0.2
	OPENBSD_4_3_BASE:1.10
	OPENBSD_4_2:1.9.0.2
	OPENBSD_4_2_BASE:1.9
	OPENBSD_4_1:1.8.0.6
	OPENBSD_4_1_BASE:1.8
	OPENBSD_4_0:1.8.0.4
	OPENBSD_4_0_BASE:1.8
	OPENBSD_3_9:1.8.0.2
	OPENBSD_3_9_BASE:1.8
	OPENBSD_3_8:1.7.0.4
	OPENBSD_3_8_BASE:1.7
	OPENBSD_3_7:1.7.0.2
	OPENBSD_3_7_BASE:1.7
	OPENBSD_3_6:1.5.0.10
	OPENBSD_3_6_BASE:1.5
	OPENBSD_3_5:1.5.0.8
	OPENBSD_3_5_BASE:1.5
	OPENBSD_3_4:1.5.0.6
	OPENBSD_3_4_BASE:1.5
	OPENBSD_3_3:1.5.0.4
	OPENBSD_3_3_BASE:1.5
	OPENBSD_3_2:1.5.0.2
	OPENBSD_3_2_BASE:1.5
	OPENBSD_3_1:1.1.0.12
	OPENBSD_3_1_BASE:1.1
	OPENBSD_3_0:1.1.0.10
	OPENBSD_3_0_BASE:1.1
	OPENBSD_2_9:1.1.0.8
	OPENBSD_2_9_BASE:1.1
	OPENBSD_2_8:1.1.0.6
	OPENBSD_2_8_BASE:1.1
	OPENBSD_2_7:1.1.0.4
	OPENBSD_2_7_BASE:1.1
	OPENBSD_2_6:1.1.0.2
	OPENBSD_2_6_BASE:1.1;
locks; strict;
comment	@# @;


1.17
date	2012.06.20.18.45.44;	author matthew;	state dead;
branches;
next	1.16;

1.16
date	2011.04.18.16.52.09;	author thib;	state Exp;
branches;
next	1.15;

1.15
date	2011.04.15.03.11.22;	author deraadt;	state Exp;
branches;
next	1.14;

1.14
date	2011.03.14.19.07.46;	author deraadt;	state Exp;
branches;
next	1.13;

1.13
date	2009.04.17.03.58.54;	author deraadt;	state Exp;
branches;
next	1.12;

1.12
date	2008.12.02.03.20.57;	author deraadt;	state Exp;
branches;
next	1.11;

1.11
date	2008.12.02.01.01.07;	author deraadt;	state Exp;
branches;
next	1.10;

1.10
date	2008.01.11.10.16.40;	author espie;	state Exp;
branches;
next	1.9;

1.9
date	2007.04.13.17.34.40;	author millert;	state Exp;
branches;
next	1.8;

1.8
date	2006.02.28.19.24.43;	author miod;	state Exp;
branches;
next	1.7;

1.7
date	2004.12.11.14.04.11;	author martin;	state Exp;
branches;
next	1.6;

1.6
date	2004.12.03.06.37.48;	author miod;	state Exp;
branches;
next	1.5;

1.5
date	2002.04.30.09.18.20;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	2002.04.28.18.28.34;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	2002.04.25.22.10.27;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	2002.04.24.22.33.41;	author miod;	state Exp;
branches;
next	1.1;

1.1
date	99.06.13.10.33.31;	author downsj;	state Exp;
branches;
next	;


desc
@@


1.17
log
@more mac68k bits for the attic
@
text
@#	$OpenBSD: Makefile,v 1.16 2011/04/18 16:52:09 thib Exp $

TOP=		${.CURDIR}/..

.include "${TOP}/Makefile.inc"
BSD_RD=		bsd.rd
BSDSBC_RD=	bsdsbc.rd
IMAGE=		mr.fs
CBIN?=		instbin
LISTS=		${.CURDIR}/list
UTILS?=		${.CURDIR}/../../miniroot

MOUNT_POINT=	/mnt
MTREE=		${UTILS}/mtree.conf

VND?=		vnd0
VND_DEV=	/dev/${VND}a
VND_RDEV=	/dev/r${VND}a
VND_CRDEV=	/dev/r${VND}c
PID!=		echo $$$$

DISKTYPE=	rdroot
NBLKS=		2880
NEWFSARGS= -t ffs -m 0 -o space -b 4096

all:	${BSD_RD}

${BSD_RD}: ${CBIN} ${IMAGE} bsd rdsetroot
	cp bsd ${BSD_RD}
	${.OBJDIR}/rdsetroot ${BSD_RD} ${IMAGE}

${IMAGE}: rd_setup do_files rd_teardown

bsd:
.ifndef(NOBUILD)
	cd ${.CURDIR}/../../../sys/arch/mac68k/conf && config RAMDISK
	cd ${.CURDIR}/../../../sys/arch/mac68k/compile/RAMDISK && \
	    ${MAKE} clean && exec ${MAKE}
.endif
	cp ${.CURDIR}/../../../sys/arch/mac68k/compile/RAMDISK/bsd bsd

rd_setup:
	dd if=/dev/zero of=${IMAGE} bs=512 count=${NBLKS}
	vnconfig -v -c ${VND} ${IMAGE}
	disklabel -w ${VND} ${DISKTYPE}
	newfs ${NEWFSARGS} ${VND_RDEV}
	fsck ${VND_RDEV}
	mount ${VND_DEV} ${MOUNT_POINT}

rd_teardown:
	@@df -i ${MOUNT_POINT}
	-umount ${MOUNT_POINT}
	-vnconfig -u ${VND}

rdsetroot:	${TOP}/../common/rdsetroot.c
	${HOSTCC} -o rdsetroot ${TOP}/../common/rdsetroot.c

unconfig:
	-umount -f ${MOUNT_POINT}
	-vnconfig -u ${VND}

.PRECIOUS:	${IMAGE}

.ifdef RELEASEDIR
install:
	cp ${BSD_RD} ${RELEASEDIR}/${BSD_RD}
	printf "disable ncrscsi\nenable sbc\nquit" | config -e \
	    -o ${RELEASEDIR}/${BSDSBC_RD} ${RELEASEDIR}/${BSD_RD}
.endif

${CBIN}.conf: ${LISTS}
	awk -f ${UTILS}/makeconf.awk CBIN=${CBIN} ${LISTS} > ${CBIN}.conf

${CBIN}.mk ${CBIN}.cache ${CBIN}.c: ${CBIN}.conf
	crunchgen -D ${.CURDIR}/../../.. -L ${DESTDIR}/usr/lib ${CBIN}.conf

${CBIN}: ${CBIN}.mk ${CBIN}.cache ${CBIN}.c
	${MAKE} -f ${CBIN}.mk all

do_files:
	mtree -def ${MTREE} -p ${MOUNT_POINT}/ -u
	TOPDIR=${TOP} CURDIR=${.CURDIR} OBJDIR=${.OBJDIR} \
	    REV=${REV} TARGDIR=${MOUNT_POINT} UTILS=${UTILS} \
	    RELEASEDIR=${RELEASEDIR} sh ${UTILS}/runlist.sh ${LISTS}
	rm ${MOUNT_POINT}/${CBIN}

clean cleandir:
	/bin/rm -f core ${IMAGE} ${CBIN} ${CBIN}.conf ${CBIN}.mk ${CBIN}.cache \
	    *.o *.lo *.c bsd ${BSD_RD} rdsetroot

.include <bsd.obj.mk>
.include <bsd.subdir.mk>
@


1.16
log
@Deprecate vnds in favour of svnds.

In effect, this removes the "old" vndX nodes, and renames
the svndX nodes to vndX.

Old svndX nodes will still continue to work though, for now.

Cleanup accordingly.

ok deraadt@@, todd@@
comments and ok on the man page bits from jmc@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.15 2011/04/15 03:11:22 deraadt Exp $
@


1.15
log
@No need to make depend kernels; ok guenther
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.14 2011/03/14 19:07:46 deraadt Exp $
d16 1
a16 1
VND?=		svnd0
@


1.14
log
@unify a chunk
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.13 2009/04/17 03:58:54 deraadt Exp $
d38 1
a38 1
	    ${MAKE} clean && ${MAKE} depend && ${MAKE}
@


1.13
log
@For SHA256 hashes to be ready to go onto the install media, we must
build the sets before we build the media.  While there we can get rid
of DESTDIR/snapshot too, and simply install straight into RELEASEDIR.
(This also ends up saving an astounding amount of traffic/latency in a nfs
environment)
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.12 2008/12/02 03:20:57 deraadt Exp $
d89 1
a89 2
	*.o *.lo *.c bsd ${BSD_RD} \
	rdsetroot
@


1.12
log
@commit with rdsetroot now accepting the filesystem as a 2nd arg
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.11 2008/12/02 01:01:07 deraadt Exp $
d64 1
d66 1
a66 1
	cp ${BSD_RD} ${DESTDIR}/snapshot/${BSD_RD}
d68 2
a69 1
	    -o ${DESTDIR}/snapshot/${BSDSBC_RD} ${DESTDIR}/snapshot/${BSD_RD}
d84 1
a84 1
	    sh ${UTILS}/runlist.sh ${LISTS}
@


1.11
log
@no longer need to compile rdsetroot with DEBUG
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.10 2008/01/11 10:16:40 espie Exp $
d30 1
a30 1
	${.OBJDIR}/rdsetroot ${BSD_RD} < ${IMAGE}
@


1.10
log
@cleanup: make -> ${MAKE} consistenly.
zap extra subshells.

okay miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.9 2007/04/13 17:34:40 millert Exp $
d56 1
a56 1
	${HOSTCC} -DDEBUG -o rdsetroot ${TOP}/../common/rdsetroot.c
@


1.9
log
@Update install media generation to the new semantics of the -c flag.
Also replace "newfs -O" with "newfs -O 0" now that -O takes an option.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.8 2006/02/28 19:24:43 miod Exp $
d38 1
a38 1
	    make clean && make depend && make
d76 1
a76 1
	make -f ${CBIN}.mk all
@


1.8
log
@BROKEN_NMAGIC is not necessary anymore when building rdsetroot, found the hard
way by martin@@; ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.7 2004/12/11 14:04:11 martin Exp $
d24 1
a24 1
NEWFSARGS= -t ffs -m 0 -o space -u 32 -c 16 -b 4096
@


1.7
log
@don't clean bsdmix and bsdofw

'feel free to remove' miod@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.6 2004/12/03 06:37:48 miod Exp $
d56 1
a56 1
	${HOSTCC} -DBROKEN_NMAGIC -DDEBUG -o rdsetroot ${TOP}/../common/rdsetroot.c
@


1.6
log
@Kill mac68k *SBC kernels. Instead, build kernels with both sbc scsi flavours
compiled in, but one disabled, and use config -e to swap them and build
the other kernels; saves valuable compile time.

Add ramdisks into the build (at release time). Since we are moving to a
bsd.rd installation, it is not necessary to put kernels in .tgz files
anymore, so don't bother, and adjust installation script sets information
accordingly.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.5 2002/04/30 09:18:20 deraadt Exp $
d87 1
a87 1
	*.o *.lo *.c bsd bsdmix bsdofw ${BSD_RD} \
@


1.5
log
@use makeconf.awk throughout, delete instbin in Makefile
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.4 2002/04/28 18:28:34 deraadt Exp $
d26 1
a26 1
all:	${BSD_RD} ${BSDSBC_RD}
a31 4
${BSDSBC_RD}: ${CBIN} ${IMAGE} bsdsbc rdsetroot
	cp bsdsbc ${BSDSBC_RD}
	${.OBJDIR}/rdsetroot ${BSDSBC_RD} < ${IMAGE}

a41 8
bsdsbc:
.ifndef(NOBUILD)
	cd ${.CURDIR}/../../../sys/arch/mac68k/conf && config RAMDISKSBC
	cd ${.CURDIR}/../../../sys/arch/mac68k/compile/RAMDISKSBC && \
	    make clean && make depend && make
.endif
	cp ${.CURDIR}/../../../sys/arch/mac68k/compile/RAMDISKSBC/bsd bsdsbc

d66 2
a67 1
	cp ${BSDSBC_RD} ${DESTDIR}/snapshot/${BSDSBC_RD}
d87 1
a87 1
	*.o *.lo *.c bsd bsdmix bsdofw ${BSD_RD} ${BSDSBC_RD} \
@


1.4
log
@use single shared mtree.conf
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.3 2002/04/25 22:10:27 deraadt Exp $
d94 1
@


1.3
log
@runlist.sh & list2sh.awk unification
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.2 2002/04/24 22:33:41 miod Exp $
d14 1
a14 1
MTREE=		${.CURDIR}/mtree.conf
@


1.2
log
@The beginnings of decent mac68k installation media, as two bsd.rd images.
Currently, the building of this is not enabled in "make release", however.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.1 1999/06/13 10:33:31 downsj Exp $
d92 2
a93 1
	    REV=${REV} TARGDIR=${MOUNT_POINT} sh ${TOP}/runlist.sh ${LISTS}
@


1.1
log
@New ramdisk framework for mac68k.  Not tested yet.

This is only a portion of it, and isn't even buildable on mac68k itself.
(It requires an hp300.)
@
text
@d1 1
a1 2
#	$OpenBSD: Makefile,v 1.13 1999/04/02 06:17:00 millert Exp $
#	$NetBSD: Makefile,v 1.1 1995/07/18 04:13:06 briggs Exp $
d6 6
a11 3
IMAGE=		ramdisk-${REV}.fs
CRUNCHCONF?=    ${.CURDIR}/${CBIN}.conf
BASE=		ramdisk
d14 1
a20 1
REALIMAGE!=	echo /var/tmp/image.${PID}
d22 3
a24 2
GZIP?=		gzip
GZIPFLAGS?=	-9f
d26 1
a26 2
all: ${CBIN} ${IMAGE} bsd.rd
	@@echo "all done"
d28 3
a30 3
install: bsd.rd
	cp bsd.rd ${DESTDIR}/snapshot/bsd.rd
	cp bsdsbc.rd ${DESTDIR}/snapshot/bsdsbc.rd
d32 3
a34 1
.include "Makefile.inc"
d36 1
a36 7
DISKTYPE=       rdroot
NBLKS=          4096
NEWFSARGS= -m 0 -o space -c 16 -i 3072

bsd.rd: ${IMAGE} bsd rdsetroot
	${.OBJDIR}/rdsetroot bsd < ${IMAGE}
	${GZIP} -c ${GZIPFLAGS} bsd > bsd.rd
d39 1
d43 1
a45 4
bsdsbc.rd: ${IMAGE} bsdsbc rdsetroot
	${.OBJDIR}/rdsetroot bsdsbc < ${IMAGE}
	${GZIP} -c ${GZIPFLAGS} bsdsbc > bsdsbc.rd

d47 1
d51 1
d54 3
a56 5
${IMAGE}: ${CBIN} rd_setup do_files rd_teardown

rd_setup: ${CBIN}
	dd if=/dev/zero of=${REALIMAGE} bs=512 count=${NBLKS}
	vnconfig -v -c ${VND} ${REALIMAGE}
a65 2
	cp ${REALIMAGE} ${IMAGE}
	rm ${REALIMAGE}
d68 1
a68 1
	${HOSTCC} -DDEBUG -o rdsetroot ${TOP}/../common/rdsetroot.c
a72 1
	-/bin/rm -f ${IMAGE}
d75 26
@

