head	1.8;
access;
symbols
	OPENBSD_6_2:1.8.0.28
	OPENBSD_6_2_BASE:1.8
	OPENBSD_6_1:1.8.0.26
	OPENBSD_6_1_BASE:1.8
	OPENBSD_6_0:1.8.0.22
	OPENBSD_6_0_BASE:1.8
	OPENBSD_5_9:1.8.0.18
	OPENBSD_5_9_BASE:1.8
	OPENBSD_5_8:1.8.0.20
	OPENBSD_5_8_BASE:1.8
	OPENBSD_5_7:1.8.0.14
	OPENBSD_5_7_BASE:1.8
	OPENBSD_5_6:1.8.0.16
	OPENBSD_5_6_BASE:1.8
	OPENBSD_5_5:1.8.0.12
	OPENBSD_5_5_BASE:1.8
	OPENBSD_5_4:1.8.0.10
	OPENBSD_5_4_BASE:1.8
	OPENBSD_5_3:1.8.0.8
	OPENBSD_5_3_BASE:1.8
	OPENBSD_5_2:1.8.0.6
	OPENBSD_5_2_BASE:1.8
	OPENBSD_5_1_BASE:1.8
	OPENBSD_5_1:1.8.0.4
	OPENBSD_5_0:1.8.0.2
	OPENBSD_5_0_BASE:1.8
	OPENBSD_4_9:1.7.0.2
	OPENBSD_4_9_BASE:1.7
	OPENBSD_4_8:1.6.0.6
	OPENBSD_4_8_BASE:1.6
	OPENBSD_4_7:1.6.0.2
	OPENBSD_4_7_BASE:1.6
	OPENBSD_4_6:1.6.0.4
	OPENBSD_4_6_BASE:1.6
	OPENBSD_4_5:1.5.0.6
	OPENBSD_4_5_BASE:1.5
	OPENBSD_4_4:1.5.0.4
	OPENBSD_4_4_BASE:1.5
	OPENBSD_4_3:1.5.0.2
	OPENBSD_4_3_BASE:1.5
	OPENBSD_4_2:1.4.0.12
	OPENBSD_4_2_BASE:1.4
	OPENBSD_4_1:1.4.0.10
	OPENBSD_4_1_BASE:1.4
	OPENBSD_4_0:1.4.0.8
	OPENBSD_4_0_BASE:1.4
	OPENBSD_3_9:1.4.0.6
	OPENBSD_3_9_BASE:1.4
	OPENBSD_3_8:1.4.0.4
	OPENBSD_3_8_BASE:1.4
	OPENBSD_3_7:1.4.0.2
	OPENBSD_3_7_BASE:1.4
	OPENBSD_3_6:1.3.0.4
	OPENBSD_3_6_BASE:1.3
	OPENBSD_3_5:1.3.0.2
	OPENBSD_3_5_BASE:1.3
	OPENBSD_3_4:1.2.0.2
	OPENBSD_3_4_BASE:1.2
	OPENBSD_3_3:1.1.0.2
	OPENBSD_3_3_BASE:1.1;
locks; strict;
comment	@# @;


1.8
date	2011.04.18.16.52.09;	author thib;	state Exp;
branches;
next	1.7;

1.7
date	2010.08.26.01.35.44;	author krw;	state Exp;
branches;
next	1.6;

1.6
date	2009.04.17.03.58.54;	author deraadt;	state Exp;
branches;
next	1.5;

1.5
date	2008.03.05.21.29.13;	author deraadt;	state Exp;
branches;
next	1.4;

1.4
date	2005.03.11.15.40.55;	author deraadt;	state Exp;
branches;
next	1.3;

1.3
date	2004.03.11.22.16.50;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	2003.08.12.03.58.28;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	2003.03.06.00.02.05;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.8
log
@Deprecate vnds in favour of svnds.

In effect, this removes the "old" vndX nodes, and renames
the svndX nodes to vndX.

Old svndX nodes will still continue to work though, for now.

Cleanup accordingly.

ok deraadt@@, todd@@
comments and ok on the man page bits from jmc@@
@
text
@#	$OpenBSD: Makefile,v 1.7 2010/08/26 01:35:44 krw Exp $

TOP=	${.CURDIR}/..

.include "${TOP}/Makefile.inc"

CDROM=		cd${OSrev}.iso

all: ${CDROM}

${CDROM}:
	-rm -rf ${.OBJDIR}/cd-dir
	mkdir -p ${.OBJDIR}/cd-dir/${OSREV}/${MACHINE}

	cp ${.OBJDIR}/../bsd.rd/bsd.rd ${.OBJDIR}/cd-dir/${OSREV}/${MACHINE}

	# make sure right kernel is in /
	ln ${.OBJDIR}/cd-dir/${OSREV}/${MACHINE}/bsd.rd ${.OBJDIR}/cd-dir/bsd.rd
	ln ${.OBJDIR}/cd-dir/bsd.rd ${.OBJDIR}/cd-dir/bsd

	cp ${DESTDIR}/usr/mdec/boot ${.OBJDIR}/cd-dir/${OSREV}/${MACHINE}
	cp ${DESTDIR}/usr/mdec/bootxx ${.OBJDIR}/cd-dir/${OSREV}/${MACHINE}

	(mkhybrid -a -R -v -v -T -L -d -D -N -o ${.OBJDIR}/${CDROM} \
	    -A "OpenBSD ${OSREV} ${MACHINE} bootonly CD" \
	    -P "Copyright (c) `date +%Y` Theo de Raadt, The OpenBSD project" \
	    -p "Theo de Raadt <deraadt@@openbsd.org>" \
	    -V "OpenBSD/${MACHINE}   ${OSREV} boot-only CD" \
	    ${.OBJDIR}/cd-dir 2>&1) | tee log
	vnconfig -v -c vnd0 ${.OBJDIR}/${CDROM}
	mount -t cd9660 /dev/vnd0a /mnt
	/usr/mdec/installboot -v \
	    -s `cat log | grep -v 'Name' | egrep "/cd-dir/${OSREV}/${MACHINE}/boot$$" | cut -d' ' -f1` \
	    -e `cat log | grep -v 'Name' | egrep "/cd-dir/${OSREV}/${MACHINE}/boot$$" | cut -d' ' -f2` \
	    /mnt/${OSREV}/${MACHINE}/boot /usr/mdec/bootxx /dev/rvnd0c
	umount /mnt
	vnconfig -u vnd0

.ifdef RELEASEDIR
install:
	cp ${CDROM} ${RELEASEDIR}
.endif

clean cleandir:
	/bin/rm -f ${CDROM}
	rm -rf cd-dir log

unconfig:
	-umount /mnt
	-vnconfig -u vnd0

.include <bsd.obj.mk>
.include <bsd.subdir.mk>
@


1.7
log
@Since Aug 2008, the kernel can successfully read the 1 block (512
byte) disklabels even in the midst of a larger sector. E.g. in bytes
512 - 1023 of the first 2048 byte sector on a CD.

On hppa we plopped down such a disklabel on cdXX.iso and installXX.iso.
Once accessible it took precedence over the spoofed label of the CD. Chaos
ensued. Since there is currently no reason for this label on hppa
cd's, eradicate it and its disktab entry. cdXX.iso/installXX.iso can now
be mounted on hppa again.

Also remove a commented out label plopping on Alpha, which references a
non-existant disktab entry.

Problem noted and exact diff creating problem discovered by marco@@.

ok deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.6 2009/04/17 03:58:54 deraadt Exp $
d30 2
a31 2
	vnconfig -v -c svnd0 ${.OBJDIR}/${CDROM}
	mount -t cd9660 /dev/svnd0a /mnt
d35 1
a35 1
	    /mnt/${OSREV}/${MACHINE}/boot /usr/mdec/bootxx /dev/rsvnd0c
d37 1
a37 1
	vnconfig -u svnd0
d50 1
a50 1
	-vnconfig -u svnd0
@


1.6
log
@For SHA256 hashes to be ready to go onto the install media, we must
build the sets before we build the media.  While there we can get rid
of DESTDIR/snapshot too, and simply install straight into RELEASEDIR.
(This also ends up saving an astounding amount of traffic/latency in a nfs
environment)
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.5 2008/03/05 21:29:13 deraadt Exp $
a35 1
	#disklabel -w svnd0 fakecdrom "OpenBSD/${MACHINE}   "
@


1.5
log
@syncronize the guts to the other ISO file, to know that it is correct
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.4 2005/03/11 15:40:55 deraadt Exp $
d40 1
d42 2
a43 1
	cp ${CDROM} ${DESTDIR}/snapshot
@


1.4
log
@never worry about the copyright date on the CD layout again, problem
noticed by drahn
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.3 2004/03/11 22:16:50 deraadt Exp $
d5 3
a7 1
CDROM=	cd${OSrev}.iso
d13 6
a18 3
	mkdir -p ${.OBJDIR}/cd-dir/${OSREV}/alpha
	cp ${.OBJDIR}/../bsd.rd/bsd.rd ${.OBJDIR}/cd-dir/${OSREV}/alpha
	ln ${.OBJDIR}/cd-dir/${OSREV}/alpha/bsd.rd ${.OBJDIR}/cd-dir/bsd.rd
d20 4
a23 2
	cp ${DESTDIR}/usr/mdec/boot ${.OBJDIR}/cd-dir/${OSREV}/alpha
	cp ${DESTDIR}/usr/mdec/bootxx ${.OBJDIR}/cd-dir/${OSREV}/alpha
d25 1
a25 1
	    -A "OpenBSD ${OSREV} alpha bootonly CD" \
d28 1
a28 1
	    -V "OpenBSD/alpha   ${OSREV} boot-only CD" \
d33 4
a36 4
	    -s `cat log | grep -v 'Name' | egrep "/cd-dir/${OSREV}/alpha/boot$$" | cut -d' ' -f1` \
	    -e `cat log | grep -v 'Name' | egrep "/cd-dir/${OSREV}/alpha/boot$$" | cut -d' ' -f2` \
	    /mnt/${OSREV}/alpha/boot /usr/mdec/bootxx /dev/rsvnd0c
	#disklabel -w svnd0 fakecdrom "OpenBSD/alpha   "
@


1.3
log
@change copyrights on iso images, spotted by miod
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.2 2003/08/12 03:58:28 deraadt Exp $
d19 1
a19 1
	    -P "Copyright (c) 2004 Theo de Raadt, The OpenBSD project" \
@


1.2
log
@correctly put OSREV in there
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.1 2003/03/06 00:02:05 deraadt Exp $
d19 1
a19 1
	    -P "Copyright (c) 2003 Theo de Raadt, The OpenBSD project" \
@


1.1
log
@cd${rev}.iso for alpha too
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.3 2003/03/04 20:24:49 deraadt Exp $
d26 3
a28 3
	    -s `cat log | grep -v 'Name' | egrep '/cd-dir/3.3/alpha/boot$$' | cut -d' ' -f1` \
	    -e `cat log | grep -v 'Name' | egrep '/cd-dir/3.3/alpha/boot$$' | cut -d' ' -f2` \
	    /mnt/3.3/alpha/boot /usr/mdec/bootxx /dev/rsvnd0c
@

