head	1.3;
access;
symbols
	OPENBSD_6_2:1.3.0.6
	OPENBSD_6_2_BASE:1.3
	OPENBSD_6_1:1.3.0.8
	OPENBSD_6_1_BASE:1.3
	OPENBSD_6_0:1.3.0.4
	OPENBSD_6_0_BASE:1.3
	OPENBSD_5_9:1.3.0.2
	OPENBSD_5_9_BASE:1.3;
locks; strict;
comment	@# @;


1.3
date	2015.09.19.10.44.43;	author miod;	state Exp;
branches;
next	1.2;
commitid	yV86ZWWKmifEmvRG;

1.2
date	2015.08.29.17.21.28;	author deraadt;	state Exp;
branches;
next	1.1;
commitid	jlYY3KMpKsstwjbe;

1.1
date	2015.08.29.16.52.41;	author deraadt;	state Exp;
branches;
next	;
commitid	0golNwfcQvtQcUi1;


desc
@@


1.3
log
@Create the filesystem image with the same size as its `c' slice from disktab.
@
text
@#	$OpenBSD: Makefile,v 1.2 2015/08/29 17:21:28 deraadt Exp $

TOP=	${.CURDIR}/..

.include "${TOP}/Makefile.inc"

TARGET=miniroot${REV}.fs

.ifndef DESTDIR
all ${TARGET}:
	@@echo setenv DESTDIR before making a ramdisk!
	@@false
.else

all: ${TARGET}

${TARGET}: vn_up install_files installboot showit vn_down

vn_up: blank_filesystem
	vnconfig vnd0 ${TARGET}
	disklabel -w vnd0 fakeramdisk
	newfs -m 0 /dev/rvnd0a
	mount /dev/vnd0a /mnt

showit:
	df -ki /mnt

vn_down:
	-umount /mnt
	-vnconfig -u vnd0

install_files: bsd.rd boot

bsd.rd:
	install -c -m 555 -o root -g wheel \
	    ${.OBJDIR}/../bsd.rd/bsd.rd /mnt/bsd

boot:
	install -c -m 555 -o root -g wheel \
	    ${DESTDIR}/usr/mdec/boot /mnt/boot

installboot:
	/usr/mdec/installboot -v /mnt/boot ${DESTDRIR}/usr/mdec/bootxx /dev/rvnd0c

blank_filesystem:
	dd if=/dev/zero of=${TARGET} bs=512 count=5760

.endif

unconfig:
	-umount -f /mnt
	-vnconfig -u /dev/vnd0a

.ifdef RELEASEDIR
install:
	cp ${TARGET} ${RELEASEDIR}
.endif

clean:
	rm -f ${TARGET}

.include <bsd.own.mk>
.include <bsd.obj.mk>
.include <bsd.subdir.mk>
@


1.2
log
@use correct installboot command; from miod.
And use $DESTDIR to find the bootxx
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.8 2015/03/12 21:41:56 naddy Exp $
d32 1
a32 1
install_files: bsd.rd ofwboot
d38 1
a38 1
ofwboot:
d46 1
a46 1
	dd if=/dev/zero of=${TARGET} bs=512 count=5744
@


1.1
log
@create an alpha miniroot
(miod must fix the installboot in it next)
@
text
@d43 1
a43 1
	installboot -v vnd0
@

