head	1.5;
access;
symbols
	OPENBSD_3_2:1.4.0.2
	OPENBSD_3_2_BASE:1.4
	OPENBSD_3_1:1.3.0.6
	OPENBSD_3_1_BASE:1.3
	OPENBSD_3_0:1.3.0.4
	OPENBSD_3_0_BASE:1.3
	OPENBSD_2_9:1.3.0.2
	OPENBSD_2_9_BASE:1.3
	OPENBSD_2_8:1.1.0.8
	OPENBSD_2_8_BASE:1.1
	OPENBSD_2_7:1.1.0.6
	OPENBSD_2_7_BASE:1.1
	OPENBSD_2_6:1.1.0.4
	OPENBSD_2_6_BASE:1.1
	OPENBSD_2_5:1.1.0.2
	OPENBSD_2_5_BASE:1.1;
locks; strict;
comment	@ * @;


1.5
date	2003.03.13.00.33.47;	author deraadt;	state dead;
branches;
next	1.4;

1.4
date	2002.06.09.08.13.08;	author todd;	state Exp;
branches;
next	1.3;

1.3
date	2001.01.28.22.45.14;	author niklas;	state Exp;
branches;
next	1.2;

1.2
date	2000.12.15.02.50.39;	author provos;	state Exp;
branches;
next	1.1;

1.1
date	98.11.14.23.37.27;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.5
log
@thought we had already deleted this
@
text
@/*	$OpenBSD: photuris_spi_needed.c,v 1.4 2002/06/09 08:13:08 todd Exp $	*/

/*
 * Copyright 1997-2000 Niels Provos <provos@@citi.umich.edu>
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *      This product includes software developed by Niels Provos.
 * 4. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
/*
 * photuris_spi_needed:
 *
 */

#ifndef lint
static char rcsid[] = "$OpenBSD: photuris_spi_needed.c,v 1.4 2002/06/09 08:13:08 todd Exp $";
#endif

#include <stdio.h>
#include <string.h>
#include "config.h"
#include "packets.h"
#include "state.h"
#include "validity.h"
#include "encrypt.h"

int
photuris_spi_needed(struct stateob *st, u_char *buffer, int *size,
		    u_int8_t *attributes, u_int16_t attribsize)
{
        struct spi_needed *header;
        u_int16_t rsize, asize, tmp;
        u_int8_t *p;

        rsize = *size;
        if (rsize < SPI_NEEDED_MIN)
          return -1;    /* buffer not large enough */

	asize = SPI_NEEDED_MIN;                     /* Actual size */
        rsize -= asize;                             /* Remaining size */

        header = (struct spi_needed *) buffer;
        header->type = SPI_NEEDED;

	bzero(header->reserved, sizeof(header->reserved));

        /* Copy the cookies */
        bcopy(st->icookie, header->icookie, COOKIE_SIZE);
        bcopy(st->rcookie, header->rcookie, COOKIE_SIZE);

	p = SPI_NEEDED_VERIFICATION(header);

        /* Leave space for verification data */
        tmp = get_validity_verification_size(st);

        if (rsize < tmp)
          return -1; /* buffer not large enough */

        p += tmp; asize += tmp; rsize -= tmp;

        if (rsize < attribsize)
          return -1; /* buffer not large enough */

        /* Copy attributes and padding */
        bcopy(attributes, p, attribsize);
        asize += attribsize;
	rsize -= attribsize;
	p += attribsize;

	tmp = rsize;
        if(packet_create_padding(st, asize - SPI_NEEDED_MIN, p, &tmp) == -1)
	     return -1;

        p += tmp; asize += tmp; rsize -= tmp;

        /* Create verification data */
        create_validity_verification(st,SPI_UPDATE_VERIFICATION(header),
				     (u_int8_t *)header,asize);

        /* Encrypt the packet after header if wished for */
        packet_encrypt(st, SPI_NEEDED_VERIFICATION(header),
                       asize - SPI_NEEDED_MIN);

        *size = asize;
        return 0;
}
@


1.4
log
@rm trailing whitespace
@
text
@d1 1
a1 1
/*	$OpenBSD: photuris_spi_needed.c,v 1.3 2001/01/28 22:45:14 niklas Exp $	*/
d38 1
a38 1
static char rcsid[] = "$OpenBSD: photuris_spi_needed.c,v 1.3 2001/01/28 22:45:14 niklas Exp $";
@


1.3
log
@$OpenBSD$
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d34 1
a34 1
 * 
d38 1
a38 1
static char rcsid[] = "$OpenBSD: photuris_spi_needed.c,v 1.2 2000/12/15 02:50:39 provos Exp $";
d56 1
a56 1
 
d63 1
a63 1
 
d68 1
a68 1
 
d75 6
a80 6
        /* Leave space for verification data */ 
        tmp = get_validity_verification_size(st); 
 
        if (rsize < tmp) 
          return -1; /* buffer not large enough */ 
 
d82 1
a82 1
 
d85 1
a85 1
 
d91 1
a91 1
 
d93 2
a94 4
        if(packet_create_padding(st, asize - SPI_NEEDED_MIN, p, &tmp) == -1)  
	     return -1;  
  
        p += tmp; asize += tmp; rsize -= tmp;  
d96 3
a98 1
        /* Create verification data */ 
d100 2
a101 2
				     (u_int8_t *)header,asize); 
 
d105 1
a105 1
 
@


1.2
log
@update email address in copyright.
@
text
@d1 2
d38 1
a38 1
static char rcsid[] = "$Id: photuris_spi_needed.c,v 1.1 1998/11/14 23:37:27 deraadt Exp $";
@


1.1
log
@move ipsec tools into .
@
text
@d2 1
a2 1
 * Copyright 1997 Niels Provos <provos@@physnet.uni-hamburg.de>
d36 1
a36 1
static char rcsid[] = "$Id: photuris_spi_needed.c,v 1.1.1.1 1997/07/18 22:48:49 provos Exp $";
@

