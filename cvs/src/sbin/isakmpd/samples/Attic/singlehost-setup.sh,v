head	1.6;
access;
symbols
	OPENBSD_4_1:1.5.0.16
	OPENBSD_4_1_BASE:1.5
	OPENBSD_4_0:1.5.0.14
	OPENBSD_4_0_BASE:1.5
	OPENBSD_3_9:1.5.0.12
	OPENBSD_3_9_BASE:1.5
	OPENBSD_3_8:1.5.0.10
	OPENBSD_3_8_BASE:1.5
	OPENBSD_3_7:1.5.0.8
	OPENBSD_3_7_BASE:1.5
	OPENBSD_3_6:1.5.0.6
	OPENBSD_3_6_BASE:1.5
	OPENBSD_3_5:1.5.0.4
	OPENBSD_3_5_BASE:1.5
	OPENBSD_3_4:1.5.0.2
	OPENBSD_3_4_BASE:1.5
	OPENBSD_3_3:1.4.0.4
	OPENBSD_3_3_BASE:1.4
	OPENBSD_3_2:1.4.0.2
	OPENBSD_3_2_BASE:1.4
	OPENBSD_3_1:1.2.0.6
	OPENBSD_3_1_BASE:1.2
	OPENBSD_3_0:1.2.0.4
	OPENBSD_3_0_BASE:1.2
	OPENBSD_2_9:1.2.0.2
	OPENBSD_2_9_BASE:1.2
	OPENBSD_2_8:1.1.0.8
	OPENBSD_2_8_BASE:1.1
	OPENBSD_2_7:1.1.0.6
	OPENBSD_2_7_BASE:1.1
	OPENBSD_2_6:1.1.0.4
	OPENBSD_2_6_BASE:1.1
	OPENBSD_2_5:1.1.0.2
	OPENBSD_2_5_BASE:1.1;
locks; strict;
comment	@# @;


1.6
date	2007.05.23.07.28.15;	author hshoexer;	state dead;
branches;
next	1.5;

1.5
date	2003.08.18.09.41.40;	author markus;	state Exp;
branches;
next	1.4;

1.4
date	2002.06.17.12.23.31;	author ho;	state Exp;
branches;
next	1.3;

1.3
date	2002.06.12.21.32.43;	author ho;	state Exp;
branches;
next	1.2;

1.2
date	2000.11.23.12.56.25;	author niklas;	state Exp;
branches;
next	1.1;

1.1
date	99.03.31.23.45.53;	author niklas;	state Exp;
branches
	1.1.8.1;
next	;

1.1.8.1
date	2001.05.08.12.45.28;	author ho;	state Exp;
branches;
next	;


desc
@@


1.6
log
@Get rid of some obsolete exampels.

ok and prodding @@jmc
@
text
@#!/bin/sh
#	$OpenBSD: singlehost-setup.sh,v 1.5 2003/08/18 09:41:40 markus Exp $
#	$EOM: singlehost-setup.sh,v 1.3 2000/11/23 12:24:43 niklas Exp $

# A script to test single-host VPNs

# For the 'pf' variable
. /etc/rc.conf

# Default paths
PFCTL=/sbin/pfctl
ISAKMPD=/sbin/isakmpd

do_routes()
{
    /sbin/route $1 -net 192.168.11.0/24 192.168.11.1 -iface >/dev/null
    /sbin/route $1 -net 192.168.12.0/24 192.168.12.1 -iface >/dev/null
    /sbin/route $1 -net 10.1.0.0/16     10.1.0.11    -iface >/dev/null
}

# Called on script exit
cleanup () {
    if [ "x${pf}" = "xYES" -a -f ${pf_rules} ]; then
	${PFCTL} -R -f ${pf_rules}
    else
	${PFCTL} -qd
    fi

    USER=`id -p | grep ^login | cut -f2`
    chown $USER singlehost-east.conf singlehost-west.conf policy
    chmod 644   singlehost-east.conf singlehost-west.conf policy

    [ -p east.fifo ] && echo "Q" >> east.fifo
    [ -p west.fifo ] && echo "Q" >> west.fifo
    rm -f east.fifo west.fifo

    do_routes delete
}

# Start by initializing interfaces
/sbin/ifconfig lo2 192.168.11.1 netmask 0xffffff00 up
/sbin/ifconfig lo3 192.168.12.1 netmask 0xffffff00 up
/sbin/ifconfig lo4 10.1.0.11 netmask 0xffff0000 up
/sbin/ifconfig lo5 10.1.0.12 netmask 0xffff0000 up
# ... and by adding the required routes
do_routes add

# Add rules
(
    cat <<EOF
pass out quick on lo2 proto 50 all
pass out quick on lo2 from 192.168.11.0/24 to any
pass out quick on lo3 proto 50 all
pass out quick on lo3 from 192.168.12.0/24 to any
block out on lo2 all
block out on lo3 all
EOF
    if [ "x${pf}" = "xYES" -a -f ${pf_rules} ]; then
	cat ${pf_rules} | egrep -v '^(scrub|rdr|binat|nat)'
    else
	pfctl -qe >/dev/null
    fi
) | pfctl -R -f -

trap cleanup 1 2 3 15

# The configuration files needs proper owners and modes
USER=`id -p | grep ^uid | cut -f2`
chown $USER singlehost-east.conf singlehost-west.conf policy
chmod 600   singlehost-east.conf singlehost-west.conf policy

# Start the daemons
rm -f east.fifo west.fifo
${ISAKMPD} -c singlehost-east.conf -f east.fifo "$@@"
${ISAKMPD} -c singlehost-west.conf -f west.fifo "$@@"

# Give them some time to negotiate their stuff...
SECS=3
echo "Waiting $SECS seconds..."
sleep $SECS
echo "Running 'ping', using the tunnel..."
ping -I 192.168.11.1 -c 5 192.168.12.1

cleanup
@


1.5
log
@typos; ho@@
note that ping is still not working on -current; however,
SA/SPD/flow setup works for testing isakmpd/ipsec on
a signle machine.
@
text
@d2 1
a2 1
#	$OpenBSD: singlehost-setup.sh,v 1.4 2002/06/17 12:23:31 ho Exp $
@


1.4
log
@A bit better. Remove debug cruft.
@
text
@d2 1
a2 1
#	$OpenBSD: singlehost-setup.sh,v 1.3 2002/06/12 21:32:43 ho Exp $
a10 1
PF_CONF=/etc/pf.conf
d23 2
a24 2
    if [ "X${pf}" = "xYES" -a -f ${PF_CONF} ]; then
	${PFCTL} -R -f ${PF_CONF}
d58 2
a59 2
    if [ "X${pf}" = "xYES" -a -f ${PF_CONF} ]; then
	cat ${PF_CONF} | egrep -v '^(scrub|rdr|binat|nat)'
@


1.3
log
@Rewrite for pf, plus some other small stuff
@
text
@d2 1
a2 1
#	$OpenBSD: singlehost-setup.sh,v 1.2 2000/11/23 12:56:25 niklas Exp $
d15 7
d34 5
a38 3
    [ -f east.pid ] && kill `cat east.pid`
    [ -f west.pid ] && kill `cat west.pid`
    rm -f east.pid west.pid east.fifo west.fifo
d46 2
d64 1
a64 1
) | tee /tmp/aa | pfctl -R -f -
d74 3
a76 3
rm -f east.pid west.pid east.fifo west.fifo
${ISAKMPD} -c singlehost-east.conf -f east.fifo -i east.pid "$@@"
${ISAKMPD} -c singlehost-west.conf -f west.fifo -i west.pid "$@@"
d79 5
a83 2
sleep 10
ping -I 192.168.11.1 -c 30 192.168.12.1
@


1.2
log
@samples/singlehost-east.conf: Merge with EOM 1.10
samples/singlehost-west.conf: Merge with EOM 1.10
samples/singlehost-setup.sh: Merge with EOM 1.3

author: niklas
use networks that fits me better
@
text
@d2 1
a2 1
#	$OpenBSD: singlehost-setup.sh,v 1.1 1999/03/31 23:45:53 niklas Exp $
d7 9
d17 13
a29 8
  ipf -r -f - <<'  EOF'
  pass out quick on lo2 proto 50 all
  pass out quick on lo2 from 192.168.11.0/24 to any
  pass out quick on lo3 proto 50 all
  pass out quick on lo3 from 192.168.12.0/24 to any
  block out on lo2
  block out on lo3
  EOF
d32 9
a40 6
ifconfig lo2 192.168.11.1 netmask 0xffffff00
ifconfig lo3 192.168.12.1 netmask 0xffffff00
ifconfig lo4 10.1.0.11 netmask 0xffff0000
ifconfig lo5 10.1.0.12 netmask 0xffff0000

ipf -E -f - <<EOF
d45 2
a46 2
block out on lo2
block out on lo3
d48 6
d57 9
a65 4
isakmpd -c singlehost-east.conf -f east.fifo "$@@"
isakmpd -c singlehost-west.conf -f west.fifo "$@@"

# Give them some slack...
d67 1
@


1.1
log
@Single-host VPN test files
@
text
@d2 2
a3 2
#	$OpenBSD: singlehost-setup.sh,v 1.1 1999/03/31 23:36:51 niklas Exp $
#	$EOM: singlehost-setup.sh,v 1.2 1999/03/31 23:45:16 niklas Exp $
d9 4
a12 4
  pass out quick on lo2 proto 50
  pass out quick on lo2 from 192.168.1.0/24 to any
  pass out quick on lo3 proto 50
  pass out quick on lo3 from 192.168.2.0/24 to any
d18 4
a21 4
ifconfig lo2 192.168.1.1 netmask 0xffffff00
ifconfig lo3 192.168.2.1 netmask 0xffffff00
ifconfig lo4 10.1.0.1 netmask 0xffff0000
ifconfig lo5 10.1.0.2 netmask 0xffff0000
d24 4
a27 4
pass out quick on lo2 proto 50
pass out quick on lo2 from 192.168.1.0/24 to any
pass out quick on lo3 proto 50
pass out quick on lo3 from 192.168.2.0/24 to any
d40 1
a40 1
ping -I 192.168.1.1 -c 30 192.168.2.1
@


1.1.8.1
log
@Pull in isakmpd from 2.9 to 2.8 branch.
@
text
@d2 2
a3 2
#	$OpenBSD: singlehost-setup.sh,v 1.2 2000/11/23 12:56:25 niklas Exp $
#	$EOM: singlehost-setup.sh,v 1.3 2000/11/23 12:24:43 niklas Exp $
d9 4
a12 4
  pass out quick on lo2 proto 50 all
  pass out quick on lo2 from 192.168.11.0/24 to any
  pass out quick on lo3 proto 50 all
  pass out quick on lo3 from 192.168.12.0/24 to any
d18 4
a21 4
ifconfig lo2 192.168.11.1 netmask 0xffffff00
ifconfig lo3 192.168.12.1 netmask 0xffffff00
ifconfig lo4 10.1.0.11 netmask 0xffff0000
ifconfig lo5 10.1.0.12 netmask 0xffff0000
d24 4
a27 4
pass out quick on lo2 proto 50 all
pass out quick on lo2 from 192.168.11.0/24 to any
pass out quick on lo3 proto 50 all
pass out quick on lo3 from 192.168.12.0/24 to any
d40 1
a40 1
ping -I 192.168.11.1 -c 30 192.168.12.1
@


