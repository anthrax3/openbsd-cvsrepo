head	1.21;
access;
symbols
	OPENBSD_6_1:1.21.0.8
	OPENBSD_6_1_BASE:1.21
	OPENBSD_6_0:1.21.0.4
	OPENBSD_6_0_BASE:1.21
	OPENBSD_5_9:1.21.0.2
	OPENBSD_5_9_BASE:1.21
	OPENBSD_5_8:1.19.0.4
	OPENBSD_5_8_BASE:1.19
	OPENBSD_5_7:1.16.0.2
	OPENBSD_5_7_BASE:1.16
	OPENBSD_5_6:1.16.0.4
	OPENBSD_5_6_BASE:1.16
	OPENBSD_5_5:1.11.0.16
	OPENBSD_5_5_BASE:1.11
	OPENBSD_5_4:1.11.0.14
	OPENBSD_5_4_BASE:1.11
	OPENBSD_5_3:1.11.0.10
	OPENBSD_5_3_BASE:1.11
	OPENBSD_5_2:1.11.0.12
	OPENBSD_5_2_BASE:1.11
	OPENBSD_5_1_BASE:1.11
	OPENBSD_5_1:1.11.0.8
	OPENBSD_5_0:1.11.0.6
	OPENBSD_5_0_BASE:1.11
	OPENBSD_4_9:1.11.0.4
	OPENBSD_4_9_BASE:1.11
	OPENBSD_4_8:1.11.0.2
	OPENBSD_4_8_BASE:1.11
	OPENBSD_4_7:1.10.0.4
	OPENBSD_4_7_BASE:1.10
	OPENBSD_4_6:1.10.0.6
	OPENBSD_4_6_BASE:1.10
	OPENBSD_4_5:1.10.0.2
	OPENBSD_4_5_BASE:1.10
	OPENBSD_4_4:1.9.0.6
	OPENBSD_4_4_BASE:1.9
	OPENBSD_4_3:1.9.0.4
	OPENBSD_4_3_BASE:1.9
	OPENBSD_4_2:1.9.0.2
	OPENBSD_4_2_BASE:1.9
	OPENBSD_4_1:1.8.0.12
	OPENBSD_4_1_BASE:1.8
	OPENBSD_4_0:1.8.0.10
	OPENBSD_4_0_BASE:1.8
	OPENBSD_3_9:1.8.0.8
	OPENBSD_3_9_BASE:1.8
	OPENBSD_3_8:1.8.0.6
	OPENBSD_3_8_BASE:1.8
	OPENBSD_3_7:1.8.0.4
	OPENBSD_3_7_BASE:1.8
	OPENBSD_3_6:1.8.0.2
	OPENBSD_3_6_BASE:1.8
	OPENBSD_3_5:1.7.0.4
	OPENBSD_3_5_BASE:1.7
	OPENBSD_3_4:1.7.0.2
	OPENBSD_3_4_BASE:1.7
	OPENBSD_3_3:1.6.0.6
	OPENBSD_3_3_BASE:1.6
	OPENBSD_3_2:1.6.0.4
	OPENBSD_3_2_BASE:1.6
	OPENBSD_3_1:1.6.0.2
	OPENBSD_3_1_BASE:1.6
	OPENBSD_3_0:1.4.0.2
	OPENBSD_3_0_BASE:1.4
	OPENBSD_2_9:1.3.0.16
	OPENBSD_2_9_BASE:1.3
	OPENBSD_2_8:1.3.0.14
	OPENBSD_2_8_BASE:1.3
	OPENBSD_2_7:1.3.0.12
	OPENBSD_2_7_BASE:1.3
	OPENBSD_2_6:1.3.0.10
	OPENBSD_2_6_BASE:1.3
	OPENBSD_2_5:1.3.0.8
	OPENBSD_2_5_BASE:1.3
	OPENBSD_2_4:1.3.0.6
	OPENBSD_2_4_BASE:1.3
	OPENBSD_2_3:1.3.0.4
	OPENBSD_2_3_BASE:1.3
	OPENBSD_2_2:1.3.0.2
	OPENBSD_2_2_BASE:1.3;
locks; strict;
comment	@ * @;


1.21
date	2015.12.12.02.49.50;	author krw;	state Exp;
branches;
next	1.20;
commitid	oF2xrlPNdHxVB5pd;

1.20
date	2015.11.13.02.27.17;	author krw;	state Exp;
branches;
next	1.19;
commitid	4K9a6NDKqAi1JXz9;

1.19
date	2015.03.30.17.11.49;	author krw;	state Exp;
branches;
next	1.18;
commitid	PQWtQHYSt0QI2mGM;

1.18
date	2015.03.16.23.51.50;	author krw;	state Exp;
branches;
next	1.17;
commitid	JG85Pc2Xt4lLAJpr;

1.17
date	2015.03.14.15.21.53;	author krw;	state Exp;
branches;
next	1.16;
commitid	aPXwn1AfAIMw4FVu;

1.16
date	2014.03.17.16.40.00;	author krw;	state Exp;
branches;
next	1.15;

1.15
date	2014.03.17.13.15.44;	author krw;	state Exp;
branches;
next	1.14;

1.14
date	2014.03.14.15.41.33;	author krw;	state Exp;
branches;
next	1.13;

1.13
date	2014.03.13.12.02.28;	author krw;	state Exp;
branches;
next	1.12;

1.12
date	2014.03.07.21.56.13;	author krw;	state Exp;
branches;
next	1.11;

1.11
date	2010.06.30.22.53.41;	author krw;	state Exp;
branches;
next	1.10;

1.10
date	2009.02.08.18.03.18;	author krw;	state Exp;
branches;
next	1.9;

1.9
date	2007.04.26.22.42.11;	author krw;	state Exp;
branches;
next	1.8;

1.8
date	2004.08.03.09.22.03;	author otto;	state Exp;
branches;
next	1.7;

1.7
date	2003.06.03.01.13.19;	author weingart;	state Exp;
branches;
next	1.6;

1.6
date	2002.02.16.21.27.34;	author millert;	state Exp;
branches;
next	1.5;

1.5
date	2002.01.18.08.38.26;	author kjell;	state Exp;
branches;
next	1.4;

1.4
date	2001.08.12.12.03.01;	author heko;	state Exp;
branches;
next	1.3;

1.3
date	97.10.16.01.47.10;	author deraadt;	state Exp;
branches;
next	1.2;

1.2
date	97.09.29.23.33.34;	author mickey;	state Exp;
branches;
next	1.1;

1.1
date	97.09.29.22.58.15;	author weingart;	state Exp;
branches;
next	;


desc
@@


1.21
log
@Open disk READONLY if none of i, e or u are specified.

Suggestion, original diff and ok naddy@@
@
text
@/*	$OpenBSD: disk.h,v 1.20 2015/11/13 02:27:17 krw Exp $	*/

/*
 * Copyright (c) 1997 Tobias Weingartner
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#ifndef _DISK_H
#define _DISK_H

struct disk {
	char	 *name;
	int	  fd;
	u_int32_t cylinders;
	u_int32_t heads;
	u_int32_t sectors;
	u_int32_t size;
};

void  DISK_open(int);
int  DISK_printgeometry(char *);
char *DISK_readsector(off_t);
int DISK_writesector(char *, off_t);

extern struct disk disk;
extern struct disklabel dl;

#endif /* _DISK_H */
@


1.20
log
@Move from opening/closing disk for every i/o to opening the disk once
and saving the fd in the global 'disk' structure. Stop passing around
fd's and just use the global.

Makes pledge() feasible.

Prompted by and ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.19 2015/03/30 17:11:49 krw Exp $	*/
d31 1
a31 1
void  DISK_open(void);
@


1.19
log
@Even better -- readsector() and writesector() become DISK_readsector() and
DISK_writesector() and live in disk.[ch].
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.18 2015/03/16 23:51:50 krw Exp $	*/
d23 2
a24 1
	char *name;
d31 1
a31 2
int  DISK_open(char *, int);
void DISK_getlabelgeometry(void);
d33 2
a34 2
char *DISK_readsector(int, off_t);
int DISK_writesector(int, char *, off_t);
@


1.18
log
@Stop passing around a pointer to the stack variable 'disk' in main().
There is only one disk being worked on, so just make it a global.

Fewer parameters, less confusion, no functional change.
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.17 2015/03/14 15:21:53 krw Exp $	*/
d33 2
@


1.17
log
@Switch all the license blocks to the standard OpenBSD/ISC license.

With the permission of Toby.

ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.16 2014/03/17 16:40:00 krw Exp $	*/
d31 2
a32 2
void DISK_getlabelgeometry(struct disk *);
int  DISK_printgeometry(struct disk *, char *);
d34 1
@


1.16
log
@Nuke pointless blank lines, defines, comments and casts. Eliminate
#include in *.h files in favour of listing them as required in the *.c
files. Fix error message to correctly state that 64 is the minimum
value for -l. Use errx() where errno is not relevant. Use 'continue'
rather than a label to go back to start of a loop.

No intentional functional change.
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.15 2014/03/17 13:15:44 krw Exp $	*/
a4 1
 * All rights reserved.
d6 3
a8 8
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
d10 7
a16 10
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
@


1.15
log
@Un-revert, being careful to not break snap building. Add paranoia check
for any missing geometry.
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.14 2014/03/14 15:41:33 krw Exp $	*/
a30 1
/* Data types */
a38 1
/* Prototypes */
@


1.14
log
@Revert last -- broke building snaps.
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.13 2014/03/13 12:02:28 krw Exp $	*/
d32 2
a33 1
struct DISK_metrics {
a39 6
struct disk {
	char *name;
	struct DISK_metrics *label;
	struct DISK_metrics *real;
};

d41 3
a43 3
int DISK_open(char *, int);
int DISK_getmetrics(struct disk *, struct DISK_metrics *);
int DISK_printmetrics(struct disk *, char *);
@


1.13
log
@Merge 'struct DISK_metrics' and 'struct disk' into one, since we don't
need to record two sets of metric/geometry data. Use 'geometry'
instead of 'metrics' in names and comments. Eliminate
DISK_getmetrics().

While here, make 64 the minimal valid value for '-l' instead of 1. This
avoids the possibility of having 0 cylinders.

No intentional functional change.

Feedback & tweak from chris@@
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.12 2014/03/07 21:56:13 krw Exp $	*/
d32 1
a32 2
struct disk {
	char *name;
d39 6
d46 3
a48 3
int  DISK_open(char *, int);
void DISK_getlabelgeometry(struct disk *);
int  DISK_printgeometry(struct disk *, char *);
@


1.12
log
@Relieve the code of an overburden of unnecessary typedef
abstraction. Call a 'struct' a 'struct' and not a pony.

No functional change.

idea ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.11 2010/06/30 22:53:41 krw Exp $	*/
d32 2
a33 1
struct DISK_metrics {
a39 6
struct disk {
	char *name;
	struct DISK_metrics *label;
	struct DISK_metrics *real;
};

d41 3
a43 3
int DISK_open(char *, int);
int DISK_getmetrics(struct disk *, struct DISK_metrics *);
int DISK_printmetrics(struct disk *, char *);
@


1.11
log
@Make 'fdisk -i' start the OpenBSD partition on a power of 2 512-byte
block boundary. In most modern (i.e. 'faked' geometry) situations
this will start it at (0-based) block[64] rather than block[63] as
now. This should help performance on disks which really have 4K
sectors but report 512-byte sectors.

Power of 2 idea from deraadt@@.

ok toby@@ deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.10 2009/02/08 18:03:18 krw Exp $	*/
d32 1
a32 1
typedef struct _DISK_metrics {
d37 1
a37 1
} DISK_metrics;
d39 1
a39 1
typedef struct _disk_t {
d41 3
a43 3
	DISK_metrics *label;
	DISK_metrics *real;
} disk_t;
d47 2
a48 2
int DISK_getmetrics(disk_t *, DISK_metrics *);
int DISK_printmetrics(disk_t *, char *);
@


1.10
log
@Eliminate excessive verbiage for 'fdisk -i' and 'fdisk -u'. Especially
the multi-line banner announcing that the MBR is being changed.
Also the listing of the partition table in 'fdisk -u'. Display a
consistant message when the MBR is written.

While here cleanup and shrink code without changing any semantics.
Started with a diff posted on tech@@ by Tobias Ulmer.

"I like it" marco@@ ok jsing@@
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.9 2007/04/26 22:42:11 krw Exp $	*/
d49 2
@


1.9
log
@Eliminate CPU_BIOS from userland and wd(4) by always using the BIOS
geometry in the disklabel when there is a BIOS geometry to provide.
This removes the option to set a disklabel to 'BIOS' geometry via the
'g b' command in the editor.

Makes reported geometry more consistant and moves MD code to MD land
where it should be.

Doc help from jmc@@, Feedback from millert@@, marco@@, weingart@@,
kettenis@@.

ok deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.8 2004/08/03 09:22:03 otto Exp $	*/
a46 1
int DISK_close(int);
a50 1

@


1.8
log
@Handle geometry parameters as unsigned quantities, getting rid of negative
number of sectors on large disks and other similar problems.

ok toby@@ tom@@ deraadt@@
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.7 2003/06/03 01:13:19 weingart Exp $	*/
a40 1
	DISK_metrics *bios;
@


1.7
log
@Nuke terms 3 & 4.
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.6 2002/02/16 21:27:34 millert Exp $	*/
d33 4
a36 4
	int cylinders;
	int heads;
	int sectors;
	int size;
@


1.6
log
@Part one of userland __P removal.  Done with a simple regexp with some minor hand editing to make comments line up correctly.  Another pass is forthcoming that handles the cases that could not be done automatically.
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.5 2002/01/18 08:38:26 kjell Exp $	*/
a14 5
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *    This product includes software developed by Tobias Weingartner.
 * 4. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
@


1.5
log
@Allow size values to be displayed in the user's choice of units.
Idea borrowed from disklabel. i.e. Users can now type "print M"
and be rewarded with partition sizes in Megs
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.4 2001/08/12 12:03:01 heko Exp $	*/
d52 4
a55 4
int DISK_open __P((char *, int));
int DISK_close __P((int));
int DISK_getmetrics __P((disk_t *, DISK_metrics *));
int DISK_printmetrics __P((disk_t *, char *));
@


1.4
log
@#(endif|else) foo is incorrect, make it #endif /* foo */
deraadt@@ ok
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.3 1997/10/16 01:47:10 deraadt Exp $	*/
d55 1
a55 1
int DISK_printmetrics __P((disk_t *));
@


1.3
log
@a bunch of improvements by weingart & I
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.2 1997/09/29 23:33:34 mickey Exp $	*/
d57 1
a57 1
#endif _DISK_H
@


1.2
log
@ID in the first line w/ tabs
@
text
@d1 1
a1 1
/*	$OpenBSD: disk.h,v 1.1 1997/09/29 22:58:15 weingart Exp $	*/
d47 1
d54 1
a54 1
int DISK_getmetrics __P((disk_t *));
@


1.1
log
@New fdisk code with interactive (command line type)
editing code.  Rewrite from the ground up, save about
20 lines of code.  Seems to create valid partition
tables on i386 and alphas.
@
text
@d1 1
a1 2

/* $OpenBSD$ */
@
