head	1.3;
access;
symbols
	OPENBSD_3_5:1.2.0.32
	OPENBSD_3_5_BASE:1.2
	OPENBSD_3_4:1.2.0.30
	OPENBSD_3_4_BASE:1.2
	OPENBSD_3_3:1.2.0.28
	OPENBSD_3_3_BASE:1.2
	OPENBSD_3_2:1.2.0.26
	OPENBSD_3_2_BASE:1.2
	OPENBSD_3_1:1.2.0.24
	OPENBSD_3_1_BASE:1.2
	OPENBSD_3_0:1.2.0.22
	OPENBSD_3_0_BASE:1.2
	OPENBSD_2_9:1.2.0.20
	OPENBSD_2_9_BASE:1.2
	OPENBSD_2_8:1.2.0.18
	OPENBSD_2_8_BASE:1.2
	OPENBSD_2_7:1.2.0.16
	OPENBSD_2_7_BASE:1.2
	new-binutils:1.2.0.14
	OPENBSD_2_6:1.2.0.12
	OPENBSD_2_6_BASE:1.2
	OPENBSD_2_5:1.2.0.10
	OPENBSD_2_5_BASE:1.2
	OPENBSD_2_4:1.2.0.8
	OPENBSD_2_4_BASE:1.2
	OPENBSD_2_3:1.2.0.6
	OPENBSD_2_3_BASE:1.2
	OPENBSD_2_2:1.2.0.4
	OPENBSD_2_2_BASE:1.2
	OPENBSD_2_1:1.2.0.2
	OPENBSD_2_1_BASE:1.2
	CYGNUS-961112:1.1.2.1
	CYGNUS:1.1.0.2;
locks; strict;
comment	@// @;


1.3
date	2004.05.21.20.23.31;	author kettenis;	state dead;
branches;
next	1.2;

1.2
date	96.11.23.03.47.09;	author niklas;	state Exp;
branches;
next	1.1;

1.1
date	96.11.19.14.31.18;	author niklas;	state dead;
branches
	1.1.2.1;
next	;

1.1.2.1
date	96.11.19.14.31.19;	author niklas;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Resolve conflicts for GDB 6.1.  Add local patches.
ok deraadt@@
@
text
@#if 0
// srcbrows.cpp : implementation file
//

#include "stdafx.h"
#include "resource.h"
#include "browserl.h"
#include "srcbrows.h"

/////////////////////////////////////////////////////////////////////////////
// CSrcBrowser

IMPLEMENT_DYNCREATE(CSrcBrowser, CFormView)

CSrcBrowser::CSrcBrowser()
	: CFormView(CSrcBrowser::IDD)
{
  //{{AFX_DATA_INIT(CSrcBrowser)
  m_filter = _T("");
  //}}AFX_DATA_INIT
  m_explode.SetWindowText("&Implode");
}

CSrcBrowser::~CSrcBrowser()
{
}

void CSrcBrowser::DoDataExchange(CDataExchange* pDX)
{
  CFormView::DoDataExchange(pDX);
  //{{AFX_DATA_MAP(CSrcBrowser)
  DDX_Control(pDX, ID_CMD_BUTTON_EXPLODE, m_explode);
  DDX_Control(pDX, ID_CMD_BUTTON_BROWSE_LIST, m_listbox);
  DDX_Text(pDX, ID_CMD_BUTTON_FILTER, m_filter);
  DDV_MaxChars(pDX, m_filter, 40);
  //}}AFX_DATA_MAP
}


BEGIN_MESSAGE_MAP(CSrcBrowser, CFormView)
     //{{AFX_MSG_MAP(CSrcBrowser)
     ON_LBN_DBLCLK(ID_CMD_BUTTON_BROWSE_LIST, OnDblclkBrowseList)
     ON_BN_CLICKED(ID_CMD_BUTTON_GOTO, OnGoto)
     ON_BN_CLICKED(ID_CMD_BUTTON_BREAKPOINT, OnBreakpoint)
     ON_BN_CLICKED(ID_REAL_CMD_BUTTON_SET_FONT, OnSetFont)
     ON_BN_CLICKED(ID_CMD_BUTTON_EXPLODE, OnExplode)
     ON_EN_CHANGE(ID_CMD_BUTTON_FILTER, OnChangeFilter)
     ON_WM_DESTROY()
     //}}AFX_MSG_MAP
     END_MESSAGE_MAP()
     
     
     
     
     /////////////////////////////////////////////////////////////////////////////
     // CSrcBrowser message handlers
     void CSrcBrowser::Initialize()
{
}
void CSrcBrowser::Terminate()
{
}
void CSrcBrowser::OnInitialUpdate() 
{
  // TODO: Add your specialized code here and/or call the base class
  ResizeParentToFit();	
  CFormView::OnInitialUpdate();
  Rethink();
  load_where(GetParentFrame(),"SrcBrowser");
}

void CSrcBrowser::Rethink()
{
  CString bname;
  static   struct gui_symtab_file *p = 0;
  int prev_top = m_listbox.GetTopIndex();
  int prev_sel = m_listbox.GetCurSel();

  
  const char *fs;
  if (m_filter.IsEmpty())
    fs = 0;
  else 
    fs = (const char *)m_filter;
  if (!p)  
    p = gdbwin_list_symbols(0, 1);
  
  int regex = fs ? ! re_comp (fs) : 0;


  m_explode.GetWindowText(bname);
  int  m_showall = bname[1] == 'I';
  m_explode.EnableWindow(m_filter.IsEmpty());
  struct gui_symtab_file *i ;
  m_listbox.ResetContent();
  struct gui_symtab_item *items ;  
  int line_count = 0;
  
  if (regex) 
    {
      for (i = p; i; i = i->next_file) 
	{	
	  int donefile = 0;
	  for (items = i->items; items; items = items->next_item)
	    {
	      if (re_exec(items->sym->GetName()))
		{
		  if (!donefile)
		    {
		      /* Only print the owning file if selected */
		      m_listbox.AddString ((char *)i);
		      line_count ++;
		      donefile = 1;
		    }
		  
		  m_listbox.AddString((char *)items);
		  line_count ++;
		}
	    }
	}
    }
  else 
    {
      for (i = p; i; i = i->next_file) 
	{
	  m_listbox.AddString ((char *)i);
	  line_count ++;
	  if (i->opened || m_showall)
	    {
	      for (items = i->items; items; items = items->next_item)
		{
		  m_listbox.AddString((char *)items);
		  line_count ++;
		}
	    }
	}
    }
  m_listbox.SetTopIndex(line_count < prev_top ? line_count -1 : prev_top);
  m_listbox.SetCurSel(line_count < prev_sel ? line_count -1 : prev_sel);
}

void CSrcBrowser::OnUpdate(CView* pSender, LPARAM lHint, CObject* pHint) 
{
  
  Rethink();
}

void CSrcBrowser::OnDblclkBrowseList() 
{
  // Find what was clicked
  int sel = m_listbox.GetCurSel();
  if (sel >= 0) {
    union gui_symtab *p = (union gui_symtab *) m_listbox.GetItemData(sel);
    if (p->type == GUI_FILE) 
      {
	p->as_file.opened = !p->as_file.opened;
	CDocument* pDoc = GetDocument();
	//	pDoc->SetModifiedFlag();
	pDoc->UpdateAllViews(NULL);
      }
    else 
      {
	/* Double click on item, goto it if possible */
	theApp_show_at (p->as_item.sym->GetValue());
      }
  }
}
void CSrcBrowser::OnGoto()
{
  OnDblclkBrowseList();
}


extern CGuiApp theApp;

void CSrcBrowser::OnBreakpoint() 
{
  // Find what was clicked
  int sel = m_listbox.GetCurSel();
  if (sel >= 0) 
    {
      union gui_symtab *p = (union gui_symtab *) m_listbox.GetItemData(sel);
      if (p->type == GUI_ITEM)
	{
	  char buf[200];
	  sprintf(buf,"%s:%s",
		  p->as_item.parent->tab->filename,
		  p->as_item.sym->GetName());
	  togdb_bpt_set(buf);
	}
    }
}





static void redraw_allsnoopwins()
{ 
  redraw_allwins(theApp.m_srcbrowserTemplate);
}

CFontInfo  browser_fontinfo ("Snoop",redraw_allsnoopwins);
void CSrcBrowser::OnSetFont() 
{
  
  browser_fontinfo.OnChooseFont();
  
}

void CSrcBrowser::OnExplode() 
{
  Rethink();
}


void CSrcBrowser::OnChangeFilter() 
{
  Rethink();
}

void CSrcBrowser::OnDestroy() 
{
  save_where(GetParentFrame(),"SrcBrowser");
  CFormView::OnDestroy();
  
}
#endif
@


1.2
log
@Merge to Cygnus 961112 + add some support (not ready) for shared libs
@
text
@@


1.1
log
@file srcbrows.cpp was initially added on branch CYGNUS.
@
text
@d1 228
@


1.1.2.1
log
@Import of 961112 Cygnus binutils+gas+ld+gdb+gprof
@
text
@a0 228
#if 0
// srcbrows.cpp : implementation file
//

#include "stdafx.h"
#include "resource.h"
#include "browserl.h"
#include "srcbrows.h"

/////////////////////////////////////////////////////////////////////////////
// CSrcBrowser

IMPLEMENT_DYNCREATE(CSrcBrowser, CFormView)

CSrcBrowser::CSrcBrowser()
	: CFormView(CSrcBrowser::IDD)
{
  //{{AFX_DATA_INIT(CSrcBrowser)
  m_filter = _T("");
  //}}AFX_DATA_INIT
  m_explode.SetWindowText("&Implode");
}

CSrcBrowser::~CSrcBrowser()
{
}

void CSrcBrowser::DoDataExchange(CDataExchange* pDX)
{
  CFormView::DoDataExchange(pDX);
  //{{AFX_DATA_MAP(CSrcBrowser)
  DDX_Control(pDX, ID_CMD_BUTTON_EXPLODE, m_explode);
  DDX_Control(pDX, ID_CMD_BUTTON_BROWSE_LIST, m_listbox);
  DDX_Text(pDX, ID_CMD_BUTTON_FILTER, m_filter);
  DDV_MaxChars(pDX, m_filter, 40);
  //}}AFX_DATA_MAP
}


BEGIN_MESSAGE_MAP(CSrcBrowser, CFormView)
     //{{AFX_MSG_MAP(CSrcBrowser)
     ON_LBN_DBLCLK(ID_CMD_BUTTON_BROWSE_LIST, OnDblclkBrowseList)
     ON_BN_CLICKED(ID_CMD_BUTTON_GOTO, OnGoto)
     ON_BN_CLICKED(ID_CMD_BUTTON_BREAKPOINT, OnBreakpoint)
     ON_BN_CLICKED(ID_REAL_CMD_BUTTON_SET_FONT, OnSetFont)
     ON_BN_CLICKED(ID_CMD_BUTTON_EXPLODE, OnExplode)
     ON_EN_CHANGE(ID_CMD_BUTTON_FILTER, OnChangeFilter)
     ON_WM_DESTROY()
     //}}AFX_MSG_MAP
     END_MESSAGE_MAP()
     
     
     
     
     /////////////////////////////////////////////////////////////////////////////
     // CSrcBrowser message handlers
     void CSrcBrowser::Initialize()
{
}
void CSrcBrowser::Terminate()
{
}
void CSrcBrowser::OnInitialUpdate() 
{
  // TODO: Add your specialized code here and/or call the base class
  ResizeParentToFit();	
  CFormView::OnInitialUpdate();
  Rethink();
  load_where(GetParentFrame(),"SrcBrowser");
}

void CSrcBrowser::Rethink()
{
  CString bname;
  static   struct gui_symtab_file *p = 0;
  int prev_top = m_listbox.GetTopIndex();
  int prev_sel = m_listbox.GetCurSel();

  
  const char *fs;
  if (m_filter.IsEmpty())
    fs = 0;
  else 
    fs = (const char *)m_filter;
  if (!p)  
    p = gdbwin_list_symbols(0, 1);
  
  int regex = fs ? ! re_comp (fs) : 0;


  m_explode.GetWindowText(bname);
  int  m_showall = bname[1] == 'I';
  m_explode.EnableWindow(m_filter.IsEmpty());
  struct gui_symtab_file *i ;
  m_listbox.ResetContent();
  struct gui_symtab_item *items ;  
  int line_count = 0;
  
  if (regex) 
    {
      for (i = p; i; i = i->next_file) 
	{	
	  int donefile = 0;
	  for (items = i->items; items; items = items->next_item)
	    {
	      if (re_exec(items->sym->GetName()))
		{
		  if (!donefile)
		    {
		      /* Only print the owning file if selected */
		      m_listbox.AddString ((char *)i);
		      line_count ++;
		      donefile = 1;
		    }
		  
		  m_listbox.AddString((char *)items);
		  line_count ++;
		}
	    }
	}
    }
  else 
    {
      for (i = p; i; i = i->next_file) 
	{
	  m_listbox.AddString ((char *)i);
	  line_count ++;
	  if (i->opened || m_showall)
	    {
	      for (items = i->items; items; items = items->next_item)
		{
		  m_listbox.AddString((char *)items);
		  line_count ++;
		}
	    }
	}
    }
  m_listbox.SetTopIndex(line_count < prev_top ? line_count -1 : prev_top);
  m_listbox.SetCurSel(line_count < prev_sel ? line_count -1 : prev_sel);
}

void CSrcBrowser::OnUpdate(CView* pSender, LPARAM lHint, CObject* pHint) 
{
  
  Rethink();
}

void CSrcBrowser::OnDblclkBrowseList() 
{
  // Find what was clicked
  int sel = m_listbox.GetCurSel();
  if (sel >= 0) {
    union gui_symtab *p = (union gui_symtab *) m_listbox.GetItemData(sel);
    if (p->type == GUI_FILE) 
      {
	p->as_file.opened = !p->as_file.opened;
	CDocument* pDoc = GetDocument();
	//	pDoc->SetModifiedFlag();
	pDoc->UpdateAllViews(NULL);
      }
    else 
      {
	/* Double click on item, goto it if possible */
	theApp_show_at (p->as_item.sym->GetValue());
      }
  }
}
void CSrcBrowser::OnGoto()
{
  OnDblclkBrowseList();
}


extern CGuiApp theApp;

void CSrcBrowser::OnBreakpoint() 
{
  // Find what was clicked
  int sel = m_listbox.GetCurSel();
  if (sel >= 0) 
    {
      union gui_symtab *p = (union gui_symtab *) m_listbox.GetItemData(sel);
      if (p->type == GUI_ITEM)
	{
	  char buf[200];
	  sprintf(buf,"%s:%s",
		  p->as_item.parent->tab->filename,
		  p->as_item.sym->GetName());
	  togdb_bpt_set(buf);
	}
    }
}





static void redraw_allsnoopwins()
{ 
  redraw_allwins(theApp.m_srcbrowserTemplate);
}

CFontInfo  browser_fontinfo ("Snoop",redraw_allsnoopwins);
void CSrcBrowser::OnSetFont() 
{
  
  browser_fontinfo.OnChooseFont();
  
}

void CSrcBrowser::OnExplode() 
{
  Rethink();
}


void CSrcBrowser::OnChangeFilter() 
{
  Rethink();
}

void CSrcBrowser::OnDestroy() 
{
  save_where(GetParentFrame(),"SrcBrowser");
  CFormView::OnDestroy();
  
}
#endif
@
