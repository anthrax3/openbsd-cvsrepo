head	1.5;
access;
symbols
	OPENBSD_3_2:1.4.0.6
	OPENBSD_3_2_BASE:1.4
	OPENBSD_3_1:1.4.0.4
	OPENBSD_3_1_BASE:1.4
	OPENBSD_3_0:1.4.0.2
	OPENBSD_3_0_BASE:1.4
	PERL_5_6_1:1.1.1.3
	OPENBSD_2_9:1.3.0.6
	OPENBSD_2_9_BASE:1.3
	OPENBSD_2_8:1.3.0.4
	OPENBSD_2_8_BASE:1.3
	OPENBSD_2_7:1.3.0.2
	OPENBSD_2_7_BASE:1.3
	PERL_5_6_0:1.1.1.2
	OPENBSD_2_6:1.2.0.2
	OPENBSD_2_6_BASE:1.2
	PERL_500503:1.1.1.1
	CPAN:1.1.1
	OPENBSD_2_5:1.1.0.6
	OPENBSD_2_5_BASE:1.1
	OPENBSD_2_4:1.1.0.4
	OPENBSD_2_4_BASE:1.1
	OPENBSD_2_3:1.1.0.2
	OPENBSD_2_3_BASE:1.1;
locks; strict;
comment	@# @;


1.5
date	2002.10.27.22.25.36;	author millert;	state dead;
branches;
next	1.4;

1.4
date	2001.05.24.18.36.10;	author millert;	state Exp;
branches;
next	1.3;

1.3
date	2000.04.06.17.08.09;	author millert;	state Exp;
branches;
next	1.2;

1.2
date	99.04.29.22.52.30;	author millert;	state Exp;
branches;
next	1.1;

1.1
date	97.11.30.08.00.28;	author millert;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	99.04.29.22.41.34;	author millert;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2000.04.06.16.10.42;	author millert;	state Exp;
branches;
next	1.1.1.3;

1.1.1.3
date	2001.05.24.18.25.14;	author millert;	state Exp;
branches;
next	;


desc
@perl 5.004_04
@


1.5
log
@Resolve conflicts, remove old files, merge local changes
@
text
@####!./perl


my %Expect;
my $symlink_exists = eval { symlink("",""); 1 };

BEGIN {
    chdir 't' if -d 't';
    @@INC = '../lib';
}

if ( $symlink_exists ) { print "1..117\n"; }
else                   { print "1..61\n"; }

use File::Find;

find(sub { print "ok 1\n" if $_ eq 'filefind.t'; }, ".");
finddepth(sub { print "ok 2\n" if $_ eq 'filefind.t'; }, ".");


my $case = 2;
my $FastFileTests_OK = 0;

END {
    unlink 'fa/fa_ord','fa/fsl','fa/faa/faa_ord',
	   'fa/fab/fab_ord','fa/fab/faba/faba_ord','fb/fb_ord','fb/fba/fba_ord';
    rmdir 'fa/faa';
    rmdir 'fa/fab/faba';
    rmdir 'fa/fab';
    rmdir 'fa';
    rmdir 'fb/fba';
    rmdir 'fb';
    chdir '..';
    rmdir 'for_find';
}

sub Check($) {
  $case++;
  if ($_[0]) { print "ok $case\n"; }
  else       { print "not ok $case\n"; }
}

sub CheckDie($) {
  $case++;
  if ($_[0]) { print "ok $case\n"; }
  else { print "not ok $case\n $!\n"; exit 0; }
}

sub touch {
  CheckDie( open(my $T,'>',$_[0]) );
}

sub MkDir($$) {
  CheckDie( mkdir($_[0],$_[1]) );
}

sub wanted {
  print "# '$_' => 1\n";
  s#\.$## if ($^O eq 'VMS' && $_ ne '.');
  Check( $Expect{$_} );
  if ( $FastFileTests_OK ) {
    delete $Expect{$_} 
      unless ( $Expect_Dir{$_} && ! -d _ );
  } else {
    delete $Expect{$_} 
      unless ( $Expect_Dir{$_} && ! -d $_ );
  }
  $File::Find::prune=1 if  $_ eq 'faba';
  
}

sub dn_wanted {
  my $n = $File::Find::name;
  $n =~ s#\.$## if ($^O eq 'VMS' && $n ne '.');
  print "# '$n' => 1\n";
  my $i = rindex($n,'/');
  my $OK = exists($Expect{$n});
  if ( $OK ) {
      $OK= exists($Expect{substr($n,0,$i)})  if $i >= 0;
  }
  Check($OK);
  delete $Expect{$n};
}

sub d_wanted {
  print "# '$_' => 1\n";
  s#\.$## if ($^O eq 'VMS' && $_ ne '.');
  my $i = rindex($_,'/');
  my $OK = exists($Expect{$_});
  if ( $OK ) {
      $OK= exists($Expect{substr($_,0,$i)})  if $i >= 0;
  }
  Check($OK);
  delete $Expect{$_};
}

MkDir( 'for_find',0770 );
CheckDie(chdir(for_find));
MkDir( 'fa',0770 );
MkDir( 'fb',0770  );
touch('fb/fb_ord');
MkDir( 'fb/fba',0770  );
touch('fb/fba/fba_ord');
CheckDie( symlink('../fb','fa/fsl') ) if $symlink_exists;
touch('fa/fa_ord');

MkDir( 'fa/faa',0770  );
touch('fa/faa/faa_ord');
MkDir( 'fa/fab',0770  );
touch('fa/fab/fab_ord');
MkDir( 'fa/fab/faba',0770  );
touch('fa/fab/faba/faba_ord');

%Expect = ('.' => 1, 'fsl' => 1, 'fa_ord' => 1, 'fab' => 1, 'fab_ord' => 1,
	   'faba' => 1, 'faa' => 1, 'faa_ord' => 1);
delete $Expect{'fsl'} unless $symlink_exists;
%Expect_Dir = ('fa' => 1, 'faa' => 1, 'fab' => 1, 'faba' => 1, 
               'fb' => 1, 'fba' => 1);
delete @@Expect_Dir{'fb','fba'} unless $symlink_exists;
File::Find::find( {wanted => \&wanted, },'fa' );
Check( scalar(keys %Expect) == 0 );

%Expect=('fa' => 1, 'fa/fsl' => 1, 'fa/fa_ord' => 1, 'fa/fab' => 1,
	 'fa/fab/fab_ord' => 1, 'fa/fab/faba' => 1,
	 'fa/fab/faba/faba_ord' => 1, 'fa/faa' => 1, 'fa/faa/faa_ord' => 1);
delete $Expect{'fa/fsl'} unless $symlink_exists;
%Expect_Dir = ('fa' => 1, 'fa/faa' => 1, '/fa/fab' => 1, 'fa/fab/faba' => 1, 
               'fb' => 1, 'fb/fba' => 1);
delete @@Expect_Dir{'fb','fb/fba'} unless $symlink_exists;
File::Find::find( {wanted => \&wanted, no_chdir => 1},'fa' );

Check( scalar(keys %Expect) == 0 );

%Expect=('.' => 1, './fa' => 1, './fa/fsl' => 1, './fa/fa_ord' => 1, './fa/fab' => 1,
         './fa/fab/fab_ord' => 1, './fa/fab/faba' => 1,
         './fa/fab/faba/faba_ord' => 1, './fa/faa' => 1, './fa/faa/faa_ord' => 1,
         './fb' => 1, './fb/fba' => 1, './fb/fba/fba_ord' => 1, './fb/fb_ord' => 1);
delete $Expect{'./fa/fsl'} unless $symlink_exists;
%Expect_Dir = ('./fa' => 1, './fa/faa' => 1, '/fa/fab' => 1, './fa/fab/faba' => 1, 
               './fb' => 1, './fb/fba' => 1);
delete @@Expect_Dir{'./fb','./fb/fba'} unless $symlink_exists;
File::Find::finddepth( {wanted => \&dn_wanted },'.' );
Check( scalar(keys %Expect) == 0 );

%Expect=('.' => 1, './fa' => 1, './fa/fsl' => 1, './fa/fa_ord' => 1, './fa/fab' => 1,
         './fa/fab/fab_ord' => 1, './fa/fab/faba' => 1,
         './fa/fab/faba/faba_ord' => 1, './fa/faa' => 1, './fa/faa/faa_ord' => 1,
         './fb' => 1, './fb/fba' => 1, './fb/fba/fba_ord' => 1, './fb/fb_ord' => 1);
delete $Expect{'./fa/fsl'} unless $symlink_exists;
%Expect_Dir = ('./fa' => 1, './fa/faa' => 1, '/fa/fab' => 1, './fa/fab/faba' => 1, 
               './fb' => 1, './fb/fba' => 1);
delete @@Expect_Dir{'./fb','./fb/fba'} unless $symlink_exists;
File::Find::finddepth( {wanted => \&d_wanted, no_chdir => 1 },'.' );
Check( scalar(keys %Expect) == 0 );

if ( $symlink_exists ) {
  $FastFileTests_OK= 1;
  %Expect=('.' => 1, 'fa_ord' => 1, 'fsl' => 1, 'fb_ord' => 1, 'fba' => 1,
           'fba_ord' => 1, 'fab' => 1, 'fab_ord' => 1, 'faba' => 1, 'faa' => 1,
           'faa_ord' => 1);
  %Expect_Dir = ('fa' => 1, 'fa/faa' => 1, '/fa/fab' => 1, 'fa/fab/faba' => 1, 
                 'fb' => 1, 'fb/fba' => 1);

  File::Find::find( {wanted => \&wanted, follow_fast => 1},'fa' );
  Check( scalar(keys %Expect) == 0 );

  %Expect=('fa' => 1, 'fa/fa_ord' => 1, 'fa/fsl' => 1, 'fa/fsl/fb_ord' => 1,
           'fa/fsl/fba' => 1, 'fa/fsl/fba/fba_ord' => 1, 'fa/fab' => 1,
           'fa/fab/fab_ord' => 1, 'fa/fab/faba' => 1, 'fa/fab/faba/faba_ord' => 1,
           'fa/faa' => 1, 'fa/faa/faa_ord' => 1);
  %Expect_Dir = ('fa' => 1, 'fa/faa' => 1, '/fa/fab' => 1, 'fa/fab/faba' => 1, 
                 'fb' => 1, 'fb/fba' => 1);
  File::Find::find( {wanted => \&wanted, follow_fast => 1, no_chdir => 1},'fa' );
  Check( scalar(keys %Expect) == 0 );

  %Expect=('fa' => 1, 'fa/fa_ord' => 1, 'fa/fsl' => 1, 'fa/fsl/fb_ord' => 1,
           'fa/fsl/fba' => 1, 'fa/fsl/fba/fba_ord' => 1, 'fa/fab' => 1,
           'fa/fab/fab_ord' => 1, 'fa/fab/faba' => 1, 'fa/fab/faba/faba_ord' => 1,
           'fa/faa' => 1, 'fa/faa/faa_ord' => 1);
  %Expect_Dir = ('fa' => 1, 'fa/faa' => 1, '/fa/fab' => 1, 'fa/fab/faba' => 1, 
                 'fb' => 1, 'fb/fba' => 1);

  File::Find::finddepth( {wanted => \&dn_wanted, follow_fast => 1},'fa' );
  Check( scalar(keys %Expect) == 0 );

  %Expect=('fa' => 1, 'fa/fa_ord' => 1, 'fa/fsl' => 1, 'fa/fsl/fb_ord' => 1,
           'fa/fsl/fba' => 1, 'fa/fsl/fba/fba_ord' => 1, 'fa/fab' => 1,
           'fa/fab/fab_ord' => 1, 'fa/fab/faba' => 1, 'fa/fab/faba/faba_ord' => 1,
           'fa/faa' => 1, 'fa/faa/faa_ord' => 1);
  %Expect_Dir = ('fa' => 1, 'fa/faa' => 1, '/fa/fab' => 1, 'fa/fab/faba' => 1, 
                 'fb' => 1, 'fb/fba' => 1);

  File::Find::finddepth( {wanted => \&d_wanted, follow_fast => 1, no_chdir => 1},'fa' );
  Check( scalar(keys %Expect) == 0 );
}

print "# of cases: $case\n";
@


1.4
log
@merge in perl 5.6.1 with our local changes
@
text
@@


1.3
log
@perl-5.6.0 + local changes
@
text
@d9 1
a9 1
    unshift @@INC, '../lib';
d22 1
d61 7
a67 1
  delete $Expect{$_};
d69 1
d117 3
d127 3
d139 3
d150 3
d157 1
d161 2
d171 2
d180 2
d190 2
@


1.2
log
@perl5.005_03 (stock)
@
text
@d1 5
a5 1
#!./perl
d9 1
a9 1
    @@INC = '../lib';
d12 2
a13 1
print "1..2\n";
a16 1
# hope we will eventually find ourself
d19 150
@


1.1
log
@perl 5.004_04
@
text
@d8 1
a8 1
print "1..1\n";
d14 1
@


1.1.1.1
log
@perl5.005_03
@
text
@d8 1
a8 1
print "1..2\n";
a13 1
finddepth(sub { print "ok 2\n" if $_ eq 'filefind.t'; }, ".");
@


1.1.1.2
log
@virgin perl 5.6.0
@
text
@d1 1
a1 5
####!./perl


my %Expect;
my $symlink_exists = eval { symlink("",""); 1 };
d5 1
a5 1
    unshift @@INC, '../lib';
d8 1
a8 2
if ( $symlink_exists ) { print "1..117\n"; }
else                   { print "1..61\n"; }
d12 1
a14 150


my $case = 2;

END {
    unlink 'fa/fa_ord','fa/fsl','fa/faa/faa_ord',
	   'fa/fab/fab_ord','fa/fab/faba/faba_ord','fb/fb_ord','fb/fba/fba_ord';
    rmdir 'fa/faa';
    rmdir 'fa/fab/faba';
    rmdir 'fa/fab';
    rmdir 'fa';
    rmdir 'fb/fba';
    rmdir 'fb';
    chdir '..';
    rmdir 'for_find';
}

sub Check($) {
  $case++;
  if ($_[0]) { print "ok $case\n"; }
  else       { print "not ok $case\n"; }
}

sub CheckDie($) {
  $case++;
  if ($_[0]) { print "ok $case\n"; }
  else { print "not ok $case\n $!\n"; exit 0; }
}

sub touch {
  CheckDie( open(my $T,'>',$_[0]) );
}

sub MkDir($$) {
  CheckDie( mkdir($_[0],$_[1]) );
}

sub wanted {
  print "# '$_' => 1\n";
  s#\.$## if ($^O eq 'VMS' && $_ ne '.');
  Check( $Expect{$_} );
  delete $Expect{$_};
  $File::Find::prune=1 if  $_ eq 'faba';
}

sub dn_wanted {
  my $n = $File::Find::name;
  $n =~ s#\.$## if ($^O eq 'VMS' && $n ne '.');
  print "# '$n' => 1\n";
  my $i = rindex($n,'/');
  my $OK = exists($Expect{$n});
  if ( $OK ) {
      $OK= exists($Expect{substr($n,0,$i)})  if $i >= 0;
  }
  Check($OK);
  delete $Expect{$n};
}

sub d_wanted {
  print "# '$_' => 1\n";
  s#\.$## if ($^O eq 'VMS' && $_ ne '.');
  my $i = rindex($_,'/');
  my $OK = exists($Expect{$_});
  if ( $OK ) {
      $OK= exists($Expect{substr($_,0,$i)})  if $i >= 0;
  }
  Check($OK);
  delete $Expect{$_};
}

MkDir( 'for_find',0770 );
CheckDie(chdir(for_find));
MkDir( 'fa',0770 );
MkDir( 'fb',0770  );
touch('fb/fb_ord');
MkDir( 'fb/fba',0770  );
touch('fb/fba/fba_ord');
CheckDie( symlink('../fb','fa/fsl') ) if $symlink_exists;
touch('fa/fa_ord');

MkDir( 'fa/faa',0770  );
touch('fa/faa/faa_ord');
MkDir( 'fa/fab',0770  );
touch('fa/fab/fab_ord');
MkDir( 'fa/fab/faba',0770  );
touch('fa/fab/faba/faba_ord');

%Expect = ('.' => 1, 'fsl' => 1, 'fa_ord' => 1, 'fab' => 1, 'fab_ord' => 1,
	   'faba' => 1, 'faa' => 1, 'faa_ord' => 1);
delete $Expect{'fsl'} unless $symlink_exists;
File::Find::find( {wanted => \&wanted, },'fa' );
Check( scalar(keys %Expect) == 0 );

%Expect=('fa' => 1, 'fa/fsl' => 1, 'fa/fa_ord' => 1, 'fa/fab' => 1,
	 'fa/fab/fab_ord' => 1, 'fa/fab/faba' => 1,
	 'fa/fab/faba/faba_ord' => 1, 'fa/faa' => 1, 'fa/faa/faa_ord' => 1);
delete $Expect{'fa/fsl'} unless $symlink_exists;
File::Find::find( {wanted => \&wanted, no_chdir => 1},'fa' );

Check( scalar(keys %Expect) == 0 );

%Expect=('.' => 1, './fa' => 1, './fa/fsl' => 1, './fa/fa_ord' => 1, './fa/fab' => 1,
         './fa/fab/fab_ord' => 1, './fa/fab/faba' => 1,
         './fa/fab/faba/faba_ord' => 1, './fa/faa' => 1, './fa/faa/faa_ord' => 1,
         './fb' => 1, './fb/fba' => 1, './fb/fba/fba_ord' => 1, './fb/fb_ord' => 1);
delete $Expect{'./fa/fsl'} unless $symlink_exists;
File::Find::finddepth( {wanted => \&dn_wanted },'.' );
Check( scalar(keys %Expect) == 0 );

%Expect=('.' => 1, './fa' => 1, './fa/fsl' => 1, './fa/fa_ord' => 1, './fa/fab' => 1,
         './fa/fab/fab_ord' => 1, './fa/fab/faba' => 1,
         './fa/fab/faba/faba_ord' => 1, './fa/faa' => 1, './fa/faa/faa_ord' => 1,
         './fb' => 1, './fb/fba' => 1, './fb/fba/fba_ord' => 1, './fb/fb_ord' => 1);
delete $Expect{'./fa/fsl'} unless $symlink_exists;
File::Find::finddepth( {wanted => \&d_wanted, no_chdir => 1 },'.' );
Check( scalar(keys %Expect) == 0 );

if ( $symlink_exists ) {
  %Expect=('.' => 1, 'fa_ord' => 1, 'fsl' => 1, 'fb_ord' => 1, 'fba' => 1,
           'fba_ord' => 1, 'fab' => 1, 'fab_ord' => 1, 'faba' => 1, 'faa' => 1,
           'faa_ord' => 1);

  File::Find::find( {wanted => \&wanted, follow_fast => 1},'fa' );
  Check( scalar(keys %Expect) == 0 );

  %Expect=('fa' => 1, 'fa/fa_ord' => 1, 'fa/fsl' => 1, 'fa/fsl/fb_ord' => 1,
           'fa/fsl/fba' => 1, 'fa/fsl/fba/fba_ord' => 1, 'fa/fab' => 1,
           'fa/fab/fab_ord' => 1, 'fa/fab/faba' => 1, 'fa/fab/faba/faba_ord' => 1,
           'fa/faa' => 1, 'fa/faa/faa_ord' => 1);
  File::Find::find( {wanted => \&wanted, follow_fast => 1, no_chdir => 1},'fa' );
  Check( scalar(keys %Expect) == 0 );

  %Expect=('fa' => 1, 'fa/fa_ord' => 1, 'fa/fsl' => 1, 'fa/fsl/fb_ord' => 1,
           'fa/fsl/fba' => 1, 'fa/fsl/fba/fba_ord' => 1, 'fa/fab' => 1,
           'fa/fab/fab_ord' => 1, 'fa/fab/faba' => 1, 'fa/fab/faba/faba_ord' => 1,
           'fa/faa' => 1, 'fa/faa/faa_ord' => 1);

  File::Find::finddepth( {wanted => \&dn_wanted, follow_fast => 1},'fa' );
  Check( scalar(keys %Expect) == 0 );

  %Expect=('fa' => 1, 'fa/fa_ord' => 1, 'fa/fsl' => 1, 'fa/fsl/fb_ord' => 1,
           'fa/fsl/fba' => 1, 'fa/fsl/fba/fba_ord' => 1, 'fa/fab' => 1,
           'fa/fab/fab_ord' => 1, 'fa/fab/faba' => 1, 'fa/fab/faba/faba_ord' => 1,
           'fa/faa' => 1, 'fa/faa/faa_ord' => 1);

  File::Find::finddepth( {wanted => \&d_wanted, follow_fast => 1, no_chdir => 1},'fa' );
  Check( scalar(keys %Expect) == 0 );
}

print "# of cases: $case\n";
@


1.1.1.3
log
@stock perl 5.6.1
@
text
@d9 1
a9 1
    @@INC = '../lib';
a21 1
my $FastFileTests_OK = 0;
d60 1
a60 7
  if ( $FastFileTests_OK ) {
    delete $Expect{$_} 
      unless ( $Expect_Dir{$_} && ! -d _ );
  } else {
    delete $Expect{$_} 
      unless ( $Expect_Dir{$_} && ! -d $_ );
  }
a61 1
  
a108 3
%Expect_Dir = ('fa' => 1, 'faa' => 1, 'fab' => 1, 'faba' => 1, 
               'fb' => 1, 'fba' => 1);
delete @@Expect_Dir{'fb','fba'} unless $symlink_exists;
a115 3
%Expect_Dir = ('fa' => 1, 'fa/faa' => 1, '/fa/fab' => 1, 'fa/fab/faba' => 1, 
               'fb' => 1, 'fb/fba' => 1);
delete @@Expect_Dir{'fb','fb/fba'} unless $symlink_exists;
a124 3
%Expect_Dir = ('./fa' => 1, './fa/faa' => 1, '/fa/fab' => 1, './fa/fab/faba' => 1, 
               './fb' => 1, './fb/fba' => 1);
delete @@Expect_Dir{'./fb','./fb/fba'} unless $symlink_exists;
a132 3
%Expect_Dir = ('./fa' => 1, './fa/faa' => 1, '/fa/fab' => 1, './fa/fab/faba' => 1, 
               './fb' => 1, './fb/fba' => 1);
delete @@Expect_Dir{'./fb','./fb/fba'} unless $symlink_exists;
a136 1
  $FastFileTests_OK= 1;
a139 2
  %Expect_Dir = ('fa' => 1, 'fa/faa' => 1, '/fa/fab' => 1, 'fa/fab/faba' => 1, 
                 'fb' => 1, 'fb/fba' => 1);
a147 2
  %Expect_Dir = ('fa' => 1, 'fa/faa' => 1, '/fa/fab' => 1, 'fa/fab/faba' => 1, 
                 'fb' => 1, 'fb/fba' => 1);
a154 2
  %Expect_Dir = ('fa' => 1, 'fa/faa' => 1, '/fa/fab' => 1, 'fa/fab/faba' => 1, 
                 'fb' => 1, 'fb/fba' => 1);
a162 2
  %Expect_Dir = ('fa' => 1, 'fa/faa' => 1, '/fa/fab' => 1, 'fa/fab/faba' => 1, 
                 'fb' => 1, 'fb/fba' => 1);
@


