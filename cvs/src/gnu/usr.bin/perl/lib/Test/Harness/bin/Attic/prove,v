head	1.2;
access;
symbols
	OPENBSD_4_6:1.1.1.4.0.6
	OPENBSD_4_6_BASE:1.1.1.4
	OPENBSD_4_5:1.1.1.4.0.2
	OPENBSD_4_5_BASE:1.1.1.4
	PERL_5_10_0:1.1.1.4
	OPENBSD_4_4:1.1.1.3.0.10
	OPENBSD_4_4_BASE:1.1.1.3
	OPENBSD_4_3:1.1.1.3.0.8
	OPENBSD_4_3_BASE:1.1.1.3
	OPENBSD_4_2:1.1.1.3.0.6
	OPENBSD_4_2_BASE:1.1.1.3
	OPENBSD_4_1:1.1.1.3.0.4
	OPENBSD_4_1_BASE:1.1.1.3
	OPENBSD_4_0:1.1.1.3.0.2
	OPENBSD_4_0_BASE:1.1.1.3
	PERL_5_8_8:1.1.1.3
	OPENBSD_3_9:1.1.1.2.0.8
	OPENBSD_3_9_BASE:1.1.1.2
	OPENBSD_3_8:1.1.1.2.0.6
	OPENBSD_3_8_BASE:1.1.1.2
	OPENBSD_3_7:1.1.1.2.0.4
	OPENBSD_3_7_BASE:1.1.1.2
	PERL_5_8_6:1.1.1.2
	OPENBSD_3_6:1.1.1.2.0.2
	OPENBSD_3_6_BASE:1.1.1.2
	PERL_5_8_5:1.1.1.2
	PERL_5_8_3:1.1.1.1
	CPAN:1.1.1;
locks; strict;
comment	@# @;


1.2
date	2009.10.12.18.24.43;	author millert;	state dead;
branches;
next	1.1;

1.1
date	2004.04.07.21.13.22;	author millert;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2004.04.07.21.13.22;	author millert;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2004.08.09.17.47.23;	author millert;	state Exp;
branches;
next	1.1.1.3;

1.1.1.3
date	2006.03.28.18.48.58;	author millert;	state Exp;
branches;
next	1.1.1.4;

1.1.1.4
date	2008.09.29.17.18.43;	author millert;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Merge in perl 5.10.1
@
text
@#!/usr/bin/perl -w

use strict;

use Test::Harness;
use Getopt::Long;
use Pod::Usage 1.12;
use File::Spec;

use vars qw( $VERSION );
$VERSION = "1.04";

my @@ext = ();
my $shuffle = 0;
my $dry = 0;
my $blib = 0;
my $lib = 0;
my $recurse = 0;
my @@includes = ();
my @@switches = ();

# Allow cuddling the paths with the -I
@@ARGV = map { /^(-I)(.+)/ ? ($1,$2) : $_ } @@ARGV;

# Stick any default switches at the beginning, so they can be overridden
# by the command line switches.
unshift @@ARGV, split( " ", $ENV{PROVE_SWITCHES} ) if defined $ENV{PROVE_SWITCHES};

Getopt::Long::Configure( "no_ignore_case" );
Getopt::Long::Configure( "bundling" );
GetOptions(
    'b|blib'        => \$blib,
    'd|debug'	    => \$Test::Harness::debug,
    'D|dry'         => \$dry,
    'h|help|?'      => sub {pod2usage({-verbose => 1, -input => \*DATA}); exit},
    'H|man'         => sub {pod2usage({-verbose => 2, -input => \*DATA}); exit},
    'I=s@@'          => \@@includes,
    'l|lib'	    => \$lib,
    'r|recurse'     => \$recurse,
    's|shuffle'     => \$shuffle,
    't'		    => sub { unshift @@switches, "-t" }, # Always want -t up front
    'T'		    => sub { unshift @@switches, "-T" }, # Always want -T up front
    'v|verbose'     => \$Test::Harness::verbose,
    'V|version'     => sub { print_version(); exit; },
    'ext=s@@'        => \@@ext,
) or exit 1;

# Build up extensions regex
@@ext = map { split /,/ } @@ext;
s/^\.// foreach @@ext;
@@ext = ("t") unless @@ext;
my $ext_regex = join( "|", map { quotemeta } @@ext );
$ext_regex = qr/\.($ext_regex)$/;

# Handle blib includes
if ( $blib ) {
    my @@blibdirs = blibdirs();
    if ( @@blibdirs ) {
	unshift @@includes, @@blibdirs;
    } else {
	warn "No blib directories found.\n";
    }
}

# Handle lib includes
if ( $lib ) {
    unshift @@includes, "lib";
}

# Build up TH switches
push( @@switches, map { /\s/ && !/^".*"$/ ? qq["-I$_"] : "-I$_" } @@includes );
$Test::Harness::Switches = join( " ", @@switches );
print "# \$Test::Harness::Switches: $Test::Harness::Switches\n" if $Test::Harness::debug;

my @@tests;
@@ARGV = File::Spec->curdir unless @@ARGV;
push( @@tests, -d $_ ? all_in( $_ ) : $_ ) for @@ARGV;

if ( @@tests ) {
    shuffle(@@tests) if $shuffle;
    if ( $dry ) {
        print join( "\n", @@tests, "" );
    } else {
	print "# ", scalar @@tests, " tests to run\n" if $Test::Harness::debug;
        runtests(@@tests);
    }
}

sub all_in {
    my $start = shift;

    my @@hits = ();

    local *DH;
    if ( opendir( DH, $start ) ) {
        while ( my $file = readdir DH ) {
            next if $file eq File::Spec->updir || $file eq File::Spec->curdir;
            next if $file eq ".svn";
            next if $file eq "CVS";

            my $currfile = File::Spec->catfile( $start, $file );
            if ( -d $currfile ) {
                push( @@hits, all_in( $currfile ) ) if $recurse;
            } else {
                push( @@hits, $currfile ) if $currfile =~ $ext_regex;
            }
        }
    } else {
        warn "$start: $!\n";
    }

    return @@hits;
}

sub shuffle {
    # Fisher-Yates shuffle
    my $i = @@_;
    while ($i) {
        my $j = rand $i--;
        @@_[$i, $j] = @@_[$j, $i];
    }
}

sub print_version {
    printf( "prove v%s, using Test::Harness v%s and Perl v%vd\n",
	$VERSION, $Test::Harness::VERSION, $^V );
}

# Stolen directly from blib.pm
sub blibdirs {
    my $dir = File::Spec->curdir;
    if ($^O eq 'VMS') {
	($dir = VMS::Filespec::unixify($dir)) =~ s-/\z--;
    }
    my $archdir = "arch";
    if ( $^O eq "MacOS" ) {
	# Double up the MP::A so that it's not used only once.
	$archdir = $MacPerl::Architecture = $MacPerl::Architecture;
    }

    my $i = 5;
    while ($i--) {
        my $blib      = File::Spec->catdir( $dir, "blib" );
        my $blib_lib  = File::Spec->catdir( $blib, "lib" );
        my $blib_arch = File::Spec->catdir( $blib, $archdir );

	if ( -d $blib && -d $blib_arch && -d $blib_lib ) {
	    return ($blib_arch,$blib_lib);
	}
	$dir = File::Spec->catdir($dir, File::Spec->updir);
    }
    warn "$0: Cannot find blib\n";
    return;
}

__END__

=head1 NAME

prove -- A command-line tool for running tests against Test::Harness

=head1 SYNOPSIS

prove [options] [files/directories]

Options:

    -b, --blib      Adds blib/lib to the path for your tests, a la "use blib".
    -d, --debug	    Includes extra debugging information.
    -D, --dry       Dry run: Show the tests to run, but don't run them.
        --ext=x     Extensions (defaults to .t)
    -h, --help      Display this help
    -H, --man       Longer manpage for prove
    -I              Add libraries to @@INC, as Perl's -I
    -l, --lib	    Add lib to the path for your tests.
    -r, --recurse   Recursively descend into directories.
    -s, --shuffle   Run the tests in a random order.
    -T	 	    Enable tainting checks
    -t		    Enable tainting warnings
    -v, --verbose   Display standard output of test scripts while running them.
    -V, --version   Display version info

Single-character options may be stacked.  Default options may be set by
specifying the PROVE_SWITCHES environment variable.

=head1 OVERVIEW

F<prove> is a command-line interface to the test-running functionality
of C<Test::Harness>.  With no arguments, it will run all tests in the
current directory.

Shell metacharacters may be used with command lines options and will be exanded 
via C<glob>.

=head1 PROVE VS. "MAKE TEST"

F<prove> has a number of advantages over C<make test> when doing development.

=over 4

=item * F<prove> is designed as a development tool

Perl users typically run the test harness through a makefile via
C<make test>.  That's fine for module distributions, but it's
suboptimal for a test/code/debug development cycle.

=item * F<prove> is granular 

F<prove> lets your run against only the files you want to check.
Running C<prove t/live/ t/master.t> checks every F<*.t> in F<t/live>,
plus F<t/master.t>.

=item * F<prove> has an easy verbose mode

F<prove> has a C<-v> option to see the raw output from the tests.
To do this with C<make test>, you must set C<HARNESS_VERBOSE=1> in
the environment.

=item * F<prove> can run under taint mode

F<prove>'s C<-T> runs your tests under C<perl -T>, and C<-t> runs them
under C<perl -t>.

=item * F<prove> can shuffle tests

You can use F<prove>'s C<--shuffle> option to try to excite problems
that don't show up when tests are run in the same order every time.

=item * F<prove> doesn't rely on a make tool

Not everyone wants to write a makefile, or use L<ExtUtils::MakeMaker>
to do so.  F<prove> has no external dependencies.

=item * Not everything is a module

More and more users are using Perl's testing tools outside the
context of a module distribution, and may not even use a makefile
at all.

=back

=head1 COMMAND LINE OPTIONS

=head2 -b, --blib

Adds blib/lib to the path for your tests, a la "use blib".

=head2 -d, --debug

Include debug information about how F<prove> is being run.  This
option doesn't show the output from the test scripts.  That's handled
by -v,--verbose.

=head2 -D, --dry

Dry run: Show the tests to run, but don't run them.

=head2 --ext=extension

Specify extensions of the test files to run.  By default, these are .t,
but you may have other non-.t test files, most likely .sh shell scripts.
The --ext is repeatable.

=head2 -I

Add libraries to @@INC, as Perl's -I.

=head2 -l, --lib

Add C<lib> to @@INC.  Equivalent to C<-Ilib>.

=head2 -r, --recurse

Descends into subdirectories of any directories specified, looking for tests.

=head2 -s, --shuffle

Sometimes tests are accidentally dependent on tests that have been
run before.  This switch will shuffle the tests to be run prior to
running them, thus ensuring that hidden dependencies in the test
order are likely to be revealed.  The author hopes the run the
algorithm on the preceding sentence to see if he can produce something
slightly less awkward.

=head2 -t

Runs test programs under perl's -t taint warning mode.

=head2 -T

Runs test programs under perl's -T taint mode.

=head2 -v, --verbose

Display standard output of test scripts while running them.

=head2 -V, --version

Display version info.

=head1 BUGS

Please use the CPAN bug ticketing system at L<http://rt.cpan.org/>.
You can also mail bugs, fixes and enhancements to 
C<< <bug-test-harness@@rt.cpan.org> >>.

=head1 TODO

=over 4

=item *

Shuffled tests must be recreatable

=back

=head1 AUTHORS

Andy Lester C<< <andy@@petdance.com> >>

=head1 COPYRIGHT

Copyright 2003 by Andy Lester C<< <andy@@petdance.com> >>.

This program is free software; you can redistribute it and/or 
modify it under the same terms as Perl itself.

See L<http://www.perl.com/perl/misc/Artistic.html>.

=cut
@


1.1
log
@Initial revision
@
text
@@


1.1.1.1
log
@perl 5.8.3 from CPAN
@
text
@@


1.1.1.2
log
@Import of stock perl 5.8.5
@
text
@d33 1
a33 1
    'd|debug'       => \$Test::Harness::debug,
d38 1
a38 1
    'l|lib'         => \$lib,
d41 2
a42 2
    't'             => sub { unshift @@switches, "-t" }, # Always want -t up front
    'T'             => sub { unshift @@switches, "-T" }, # Always want -T up front
a47 2
$ENV{TEST_VERBOSE} = 1 if $Test::Harness::verbose;

d59 1
a59 1
        unshift @@includes, @@blibdirs;
d61 1
a61 1
        warn "No blib directories found.\n";
d77 1
a77 1
push( @@tests, -d $_ ? all_in( $_ ) : $_ ) for map { glob } @@ARGV;
d84 1
a84 1
        print "# ", scalar @@tests, " tests to run\n" if $Test::Harness::debug;
d126 1
a126 1
        $VERSION, $Test::Harness::VERSION, $^V );
d133 1
a133 1
        ($dir = VMS::Filespec::unixify($dir)) =~ s-/\z--;
d137 2
a138 2
        # Double up the MP::A so that it's not used only once.
        $archdir = $MacPerl::Architecture = $MacPerl::Architecture;
d147 4
a150 4
        if ( -d $blib && -d $blib_arch && -d $blib_lib ) {
            return ($blib_arch,$blib_lib);
        }
        $dir = File::Spec->catdir($dir, File::Spec->updir);
d169 1
a169 1
    -d, --debug     Includes extra debugging information.
d175 1
a175 1
    -l, --lib       Add lib to the path for your tests.
d178 2
a179 2
    -T              Enable tainting checks
    -t              Enable tainting warnings
d295 1
a295 2
Display standard output of test scripts while running them.  Also sets
TEST_VERBOSE in case your tests rely on them.
@


1.1.1.3
log
@perl 5.8.8 import
@
text
@d35 2
a36 2
    'h|help|?'      => sub {pod2usage({-verbose => 1}); exit},
    'H|man'         => sub {pod2usage({-verbose => 2}); exit},
a42 1
    'timer'         => \$Test::Harness::Timer,
d98 1
a98 3
        my @@files = sort readdir DH;
        closedir DH;
        for my $file ( @@files ) {
a181 1
        --timer     Print elapsed time after each test file
a294 4
=head2 --timer

Print elapsed time after each test file

d326 1
a326 1
Copyright 2005 by Andy Lester C<< <andy@@petdance.com> >>.
@


1.1.1.4
log
@import perl 5.10.0 from CPAN
@
text
@a5 2
use Test::Harness::Util qw( all_in blibdirs shuffle );

d11 1
a11 1
$VERSION = '2.64';
d13 1
d27 1
a27 1
unshift @@ARGV, split( ' ', $ENV{PROVE_SWITCHES} ) if defined $ENV{PROVE_SWITCHES};
d29 2
a30 2
Getopt::Long::Configure( 'no_ignore_case' );
Getopt::Long::Configure( 'bundling' );
a38 1
    'perl=s'        => \$ENV{HARNESS_PERL},
d41 2
a42 5
    't'             => sub { unshift @@switches, '-t' }, # Always want -t up front
    'T'             => sub { unshift @@switches, '-T' }, # Always want -T up front
    'w'             => sub { push @@switches, '-w' },
    'W'             => sub { push @@switches, '-W' },
    'strap=s'       => \$ENV{HARNESS_STRAP_CLASS},
d46 1
d51 7
d63 1
a63 2
    }
    else {
d70 1
a70 1
    unshift @@includes, 'lib';
d75 1
a75 1
$Test::Harness::Switches = join( ' ', @@switches );
d78 1
d80 1
a80 13
my @@argv_globbed;
my @@tests;
if ( $] >= 5.006001 ) {
    require File::Glob;
    @@argv_globbed = map { File::Glob::bsd_glob($_) } @@ARGV;
}
else {
    @@argv_globbed = map { glob } @@ARGV;
}

for ( @@argv_globbed ) {
    push( @@tests, -d $_ ? all_in( { recurse => $recurse, start => $_ } ) : $_ )
}
d85 2
a86 3
        print join( "\n", @@tests, '' );
    }
    else {
d92 37
d134 27
d171 1
a171 1
=head1 OPTIONS
d173 4
a176 3
    -b, --blib      Adds blib/lib to the path for your tests, a la "use blib"
    -d, --debug     Includes extra debugging information
    -D, --dry       Dry run: Show the tests to run, but don't run them
d180 3
a182 5
    -l, --lib       Add lib to the path for your tests
        --perl      Sets the name of the Perl executable to use
    -r, --recurse   Recursively descend into directories
    -s, --shuffle   Run the tests in a random order
        --strap     Define strap class to use
d186 1
a186 1
    -v, --verbose   Display standard output of test scripts while running them
d199 1
a199 1
via C<File::Glob::bsd_glob>.
d264 6
a277 5
=head2 --perl

Sets the C<HARNESS_PERL> environment variable, which controls what
Perl executable will run the tests.

a290 5
=head2 --strap

Sets the HARNESS_STRAP_CLASS variable to set which Test::Harness::Straps
variable to use in running the tests.

d330 1
a330 1
Andy Lester C<< <andy at petdance.com> >>
d334 1
a334 1
Copyright 2004-2006 by Andy Lester C<< <andy at petdance.com> >>.
@


