head	1.2;
access;
symbols
	PERL_5_24_2:1.1.1.2
	OPENBSD_6_1:1.2.0.4
	OPENBSD_6_1_BASE:1.2
	OPENBSD_6_0:1.1.1.1.0.10
	OPENBSD_6_0_BASE:1.1.1.1
	OPENBSD_5_9:1.1.1.1.0.4
	OPENBSD_5_9_BASE:1.1.1.1
	OPENBSD_5_8:1.1.1.1.0.6
	OPENBSD_5_8_BASE:1.1.1.1
	PERL_5_20_2:1.1.1.1
	OPENBSD_5_7:1.1.1.1.0.2
	OPENBSD_5_7_BASE:1.1.1.1
	PERL_5_20_1:1.1.1.1
	PERL:1.1.1;
locks; strict;
comment	@# @;
expand	@b@;


1.2
date	2017.02.05.00.32.06;	author afresh1;	state Exp;
branches;
next	1.1;
commitid	cxJ08BvJA9Pt2PTM;

1.1
date	2014.11.17.20.52.41;	author afresh1;	state Exp;
branches
	1.1.1.1;
next	;
commitid	B31cAbBIXiCqnL97;

1.1.1.1
date	2014.11.17.20.52.41;	author afresh1;	state Exp;
branches;
next	1.1.1.2;
commitid	B31cAbBIXiCqnL97;

1.1.1.2
date	2017.08.14.13.45.32;	author afresh1;	state Exp;
branches;
next	;
commitid	fAzrs78vdW2Yfc6A;


desc
@@


1.2
log
@Fix merge issues, remove excess files - match perl-5.24.1 dist
@
text
@#!/usr/bin/perl -w

# Test that open still honors the open pragma.

use strict;
use warnings;

use autodie;

use Fcntl;
use File::Temp;
use Test::More;

if( $] < '5.01000' ) {
    plan skip_all => "autodie does not honor the open pragma before 5.10";
}
else {
    plan "no_plan";
}

# Test with an open pragma on
{
    use open IN => ':encoding(utf8)', OUT => ':utf8';

    # Test the standard handles and all newly opened handles are utf8
    my $file = File::Temp->new;
    my $txt = "autodie is MËTÁŁ";

    # open for writing
    {
        open my $fh, ">", $file;

        my @@layers = PerlIO::get_layers($fh);
        ok( (grep { $_ eq 'utf8' } @@layers), "open write honors open pragma" ) or diag join ", ", @@layers;

        print $fh $txt;
        close $fh;
    }

    # open for reading, explicit
    {
        open my $fh, "<", $file;

        my @@layers = PerlIO::get_layers($fh);
        ok( (grep { $_ eq 'encoding(utf8)' } @@layers), "open read honors open pragma" ) or diag join ", ", @@layers;

        is join("\n", <$fh>), $txt;
    }

    # open for reading, implicit
    {
        open my($fh), $file;

        my @@layers = PerlIO::get_layers($fh);
        ok( (grep { $_ eq 'encoding(utf8)' } @@layers), "open implicit read honors open pragma" ) or diag join ", ", @@layers;

        is join("\n", <$fh>), $txt;
    }

    # open for read/write
    {
        open my $fh, "+>", $file;

        my @@layers = PerlIO::get_layers($fh);
        ok( (grep { $_ eq 'utf8' } @@layers), "open implicit read honors open pragma" ) or diag join ", ", @@layers;
    }

    # open for append
    {
        open my $fh, ">>", $file;

        my @@layers = PerlIO::get_layers($fh);
        ok( (grep { $_ eq 'utf8' } @@layers), "open implicit read honors open pragma" ) or diag join ", ", @@layers;
    }

    # raw
    {
        open my $fh, ">:raw", $file;

        my @@layers = PerlIO::get_layers($fh);

        ok( !(grep { $_ eq 'utf8' } @@layers), 'open pragma is not used if raw is specified' ) or diag join ", ", @@layers;
    }
}


# Test without open pragma
{
    my $file = File::Temp->new;
    open my $fh, ">", $file;

    my @@layers = PerlIO::get_layers($fh);
    ok( grep(!/utf8/, @@layers), "open pragma remains lexical" ) or diag join ", ", @@layers;
}


# sysopen
{
    use open IN => ':encoding(utf8)', OUT => ':utf8';

    # Test the standard handles and all newly opened handles are utf8
    my $file = File::Temp->new;
    my $txt = "autodie is MËTÁŁ";

    # open for writing only
    {
        sysopen my $fh, $file, O_CREAT|O_TRUNC|O_WRONLY;

        my @@layers = PerlIO::get_layers($fh);
        ok( (grep { $_ eq 'utf8' } @@layers), "open write honors open pragma" ) or diag join ", ", @@layers;

        print $fh $txt;
        close $fh;
    }

    # open for reading only
    {
        sysopen my $fh, $file, O_RDONLY;

        my @@layers = PerlIO::get_layers($fh);
        ok( (grep { $_ eq 'encoding(utf8)' } @@layers), "open read honors open pragma" ) or diag join ", ", @@layers;

        is join("\n", <$fh>), $txt;
    }

    # open for reading and writing
    {
        sysopen my $fh, $file, O_RDWR;

        my @@layers = PerlIO::get_layers($fh);
        ok( (grep { $_ eq 'utf8' } @@layers), "open read/write honors open write pragma" ) or diag join ", ", @@layers;

        is join("\n", <$fh>), $txt;
    }
}
@


1.1
log
@Initial revision
@
text
@a11 1

d74 9
@


1.1.1.1
log
@Import perl-5.20.1
@
text
@@


1.1.1.2
log
@Import perl-5.24.2
@
text
@d12 1
a74 9
    }

    # raw
    {
        open my $fh, ">:raw", $file;

        my @@layers = PerlIO::get_layers($fh);

        ok( !(grep { $_ eq 'utf8' } @@layers), 'open pragma is not used if raw is specified' ) or diag join ", ", @@layers;
@

