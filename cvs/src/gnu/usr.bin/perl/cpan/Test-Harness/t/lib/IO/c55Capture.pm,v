head	1.1;
branch	1.1.1;
access;
symbols
	OPENBSD_6_1:1.1.1.1.0.28
	OPENBSD_6_1_BASE:1.1.1.1
	OPENBSD_6_0:1.1.1.1.0.26
	OPENBSD_6_0_BASE:1.1.1.1
	OPENBSD_5_9:1.1.1.1.0.20
	OPENBSD_5_9_BASE:1.1.1.1
	OPENBSD_5_8:1.1.1.1.0.22
	OPENBSD_5_8_BASE:1.1.1.1
	PERL_5_20_2:1.1.1.1
	OPENBSD_5_7:1.1.1.1.0.14
	OPENBSD_5_7_BASE:1.1.1.1
	PERL_5_20_1:1.1.1.1
	OPENBSD_5_6:1.1.1.1.0.18
	OPENBSD_5_6_BASE:1.1.1.1
	PERL_5_18_2:1.1.1.1
	PERL:1.1.1
	OPENBSD_5_5:1.1.1.1.0.16
	OPENBSD_5_5_BASE:1.1.1.1
	OPENBSD_5_4:1.1.1.1.0.12
	OPENBSD_5_4_BASE:1.1.1.1
	PERL_5_16_3:1.1.1.1
	OPENBSD_5_3:1.1.1.1.0.10
	OPENBSD_5_3_BASE:1.1.1.1
	OPENBSD_5_2:1.1.1.1.0.8
	OPENBSD_5_2_BASE:1.1.1.1
	OPENBSD_5_1_BASE:1.1.1.1
	OPENBSD_5_1:1.1.1.1.0.6
	OPENBSD_5_0:1.1.1.1.0.4
	OPENBSD_5_0_BASE:1.1.1.1
	OPENBSD_4_9:1.1.1.1.0.2
	OPENBSD_4_9_BASE:1.1.1.1
	PERL_5_12_2:1.1.1.1
	CPAN:1.1.1;
locks; strict;
comment	@# @;
expand	@o@;


1.1
date	2010.09.24.14.49.00;	author millert;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2010.09.24.14.49.00;	author millert;	state Exp;
branches;
next	;


desc
@@


1.1
log
@Initial revision
@
text
@package IO::c55Capture;

use IO::Handle;

=head1 Name

t/lib/IO::c55Capture - a wafer-thin test support package

=head1 Why!?

Compatibility with 5.5.3 and no external dependencies.

=head1 Usage

Works with a global filehandle:

    # set a spool to write to
    tie local *STDOUT, 'IO::c55Capture';
    ...
    # clear and retrieve buffer list
    my @@spooled = tied(*STDOUT)->dump();

Or, a lexical (and autocreated) filehandle:

    my $capture = IO::c55Capture->new_handle;
    ...
    my @@output = tied($$capture)->dump;

Note the '$$' dereference.

=cut

# XXX actually returns an IO::Handle :-/
sub new_handle {
    my $class  = shift;
    my $handle = IO::Handle->new;
    tie $$handle, $class;
    return ($handle);
}

sub TIEHANDLE {
    return bless [], __PACKAGE__;
}

sub PRINT {
    my $self = shift;

    push @@$self, @@_;
}

sub PRINTF {
    my $self = shift;
    push @@$self, sprintf(@@_);
}

sub dump {
    my $self = shift;
    my @@got  = @@$self;
    @@$self = ();
    return @@got;
}

package util;

use IO::File;

# mostly stolen from Module::Build MBTest.pm

{    # backwards compatible temp filename recipe adapted from perlfaq
    my $tmp_count = 0;
    my $tmp_base_name = sprintf( "%d-%d", $$, time() );

    sub temp_file_name {
        sprintf( "%s-%04d", $tmp_base_name, ++$tmp_count );
    }
}
########################################################################

sub save_handle {
    my ( $handle, $subr ) = @@_;
    my $outfile = temp_file_name();

    local *SAVEOUT;
    open SAVEOUT, ">&" . fileno($handle)
      or die "Can't save output handle: $!";
    open $handle, "> $outfile" or die "Can't create $outfile: $!";

    eval { $subr->() };
    my $err = $@@;
    open $handle, ">&SAVEOUT" or die "Can't restore output: $!";

    my $ret = slurp($outfile);
    1 while unlink $outfile;
    $err and die $err;
    return $ret;
}

sub stdout_of { save_handle( \*STDOUT, @@_ ) }
sub stderr_of { save_handle( \*STDERR, @@_ ) }

sub stdout_stderr_of {
    my $subr = shift;
    my ( $stdout, $stderr );
    $stdout = stdout_of(
        sub {
            $stderr = stderr_of($subr);
        }
    );
    return ( $stdout, $stderr );
}

sub slurp {
    my $fh = IO::File->new( $_[0] ) or die "Can't open $_[0]: $!";
    local $/;
    return scalar <$fh>;
}

1;

# vim:ts=4:sw=4:et:sta
@


1.1.1.1
log
@Perl 5.12.2 from CPAN
@
text
@@
