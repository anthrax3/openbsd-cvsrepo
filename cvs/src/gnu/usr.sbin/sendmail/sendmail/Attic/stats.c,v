head	1.12;
access;
symbols
	OPENBSD_5_6:1.11.0.6
	OPENBSD_5_6_BASE:1.11
	OPENBSD_5_5:1.11.0.4
	OPENBSD_5_5_BASE:1.11
	OPENBSD_5_4:1.10.0.28
	OPENBSD_5_4_BASE:1.10
	OPENBSD_5_3:1.10.0.26
	OPENBSD_5_3_BASE:1.10
	OPENBSD_5_2:1.10.0.24
	OPENBSD_5_2_BASE:1.10
	OPENBSD_5_1_BASE:1.10
	OPENBSD_5_1:1.10.0.22
	OPENBSD_5_0:1.10.0.20
	OPENBSD_5_0_BASE:1.10
	OPENBSD_4_9:1.10.0.18
	OPENBSD_4_9_BASE:1.10
	OPENBSD_4_8:1.10.0.16
	OPENBSD_4_8_BASE:1.10
	OPENBSD_4_7:1.10.0.12
	OPENBSD_4_7_BASE:1.10
	OPENBSD_4_6:1.10.0.14
	OPENBSD_4_6_BASE:1.10
	OPENBSD_4_5:1.10.0.10
	OPENBSD_4_5_BASE:1.10
	OPENBSD_4_4:1.10.0.8
	OPENBSD_4_4_BASE:1.10
	OPENBSD_4_3:1.10.0.6
	OPENBSD_4_3_BASE:1.10
	OPENBSD_4_2:1.10.0.4
	OPENBSD_4_2_BASE:1.10
	OPENBSD_4_1:1.10.0.2
	OPENBSD_4_1_BASE:1.10
	OPENBSD_4_0:1.9.0.10
	OPENBSD_4_0_BASE:1.9
	OPENBSD_3_9:1.9.0.8
	OPENBSD_3_9_BASE:1.9
	OPENBSD_3_8:1.9.0.6
	OPENBSD_3_8_BASE:1.9
	OPENBSD_3_7:1.9.0.4
	OPENBSD_3_7_BASE:1.9
	OPENBSD_3_6:1.9.0.2
	OPENBSD_3_6_BASE:1.9
	OPENBSD_3_5:1.8.0.8
	OPENBSD_3_5_BASE:1.8
	OPENBSD_3_4:1.8.0.4
	OPENBSD_3_4_BASE:1.8
	OPENBSD_3_3:1.8.0.6
	OPENBSD_3_3_BASE:1.8
	OPENBSD_3_2:1.8.0.2
	OPENBSD_3_2_BASE:1.8
	OPENBSD_3_1:1.6.0.2
	OPENBSD_3_1_BASE:1.6
	OPENBSD_3_0:1.5.0.2
	OPENBSD_3_0_BASE:1.5
	SENDMAIL_8_12_0:1.1.1.3
	OPENBSD_2_9:1.3.0.2
	OPENBSD_2_9_BASE:1.3
	SENDMAIL_8_11_2:1.1.1.2
	OPENBSD_2_8:1.1.1.1.0.4
	OPENBSD_2_8_BASE:1.1.1.1
	OPENBSD_2_7:1.1.1.1.0.2
	OPENBSD_2_7_BASE:1.1.1.1
	SENDMAIL_8_10_0:1.1.1.1
	SENDMAIL_INC:1.1.1;
locks; strict;
comment	@ * @;


1.12
date	2014.09.17.18.49.52;	author matthieu;	state dead;
branches;
next	1.11;
commitid	M7i5giHIoz3DMlTU;

1.11
date	2014.02.07.21.25.00;	author millert;	state Exp;
branches;
next	1.10;

1.10
date	2007.02.04.13.17.35;	author millert;	state Exp;
branches;
next	1.9;

1.9
date	2004.06.24.03.59.28;	author millert;	state Exp;
branches;
next	1.8;

1.8
date	2002.06.03.17.25.47;	author millert;	state Exp;
branches;
next	1.7;

1.7
date	2002.04.18.00.49.29;	author millert;	state Exp;
branches;
next	1.6;

1.6
date	2002.01.14.03.21.40;	author millert;	state Exp;
branches;
next	1.5;

1.5
date	2001.10.01.17.18.30;	author millert;	state Exp;
branches;
next	1.4;

1.4
date	2001.09.11.19.02.50;	author millert;	state Exp;
branches;
next	1.3;

1.3
date	2001.02.28.02.43.55;	author millert;	state Exp;
branches;
next	1.2;

1.2
date	2001.01.15.21.09.10;	author millert;	state Exp;
branches;
next	1.1;

1.1
date	2000.04.02.19.05.48;	author millert;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2000.04.02.19.05.48;	author millert;	state Exp;
branches
	1.1.1.1.4.1;
next	1.1.1.2;

1.1.1.2
date	2001.01.15.20.52.18;	author millert;	state Exp;
branches;
next	1.1.1.3;

1.1.1.3
date	2001.09.11.18.55.51;	author millert;	state Exp;
branches;
next	;

1.1.1.1.4.1
date	2001.05.31.00.31.44;	author miod;	state Exp;
branches;
next	;


desc
@@


1.12
log
@Bye.
@
text
@/*
 * Copyright (c) 1998-2002 Proofpoint, Inc. and its suppliers.
 *	All rights reserved.
 * Copyright (c) 1983, 1995-1997 Eric P. Allman.  All rights reserved.
 * Copyright (c) 1988, 1993
 *	The Regents of the University of California.  All rights reserved.
 *
 * By using this file, you agree to the terms and conditions set
 * forth in the LICENSE file which can be found at the top level of
 * the sendmail distribution.
 *
 */

#include <sendmail.h>

SM_RCSID("@@(#)$Sendmail: stats.c,v 8.58 2013/11/22 20:51:56 ca Exp $")

#include <sendmail/mailstats.h>

static struct statistics	Stat;

static bool	GotStats = false;	/* set when we have stats to merge */

/* See http://physics.nist.gov/cuu/Units/binary.html */
#define ONE_K		1000		/* one thousand (twenty-four?) */
#define KBYTES(x)	(((x) + (ONE_K - 1)) / ONE_K)
/*
**  MARKSTATS -- mark statistics
**
**	Parameters:
**		e -- the envelope.
**		to -- to address.
**		type -- type of stats this represents.
**
**	Returns:
**		none.
**
**	Side Effects:
**		changes static Stat structure
*/

void
markstats(e, to, type)
	register ENVELOPE *e;
	register ADDRESS *to;
	int type;
{
	switch (type)
	{
	  case STATS_QUARANTINE:
		if (e->e_from.q_mailer != NULL)
			Stat.stat_nq[e->e_from.q_mailer->m_mno]++;
		break;

	  case STATS_REJECT:
		if (e->e_from.q_mailer != NULL)
		{
			if (bitset(EF_DISCARD, e->e_flags))
				Stat.stat_nd[e->e_from.q_mailer->m_mno]++;
			else
				Stat.stat_nr[e->e_from.q_mailer->m_mno]++;
		}
		Stat.stat_cr++;
		break;

	  case STATS_CONNECT:
		if (to == NULL)
			Stat.stat_cf++;
		else
			Stat.stat_ct++;
		break;

	  case STATS_NORMAL:
		if (to == NULL)
		{
			if (e->e_from.q_mailer != NULL)
			{
				Stat.stat_nf[e->e_from.q_mailer->m_mno]++;
				Stat.stat_bf[e->e_from.q_mailer->m_mno] +=
					KBYTES(e->e_msgsize);
			}
		}
		else
		{
			Stat.stat_nt[to->q_mailer->m_mno]++;
			Stat.stat_bt[to->q_mailer->m_mno] += KBYTES(e->e_msgsize);
		}
		break;

	  default:
		/* Silently ignore bogus call */
		return;
	}


	GotStats = true;
}
/*
**  CLEARSTATS -- clear statistics structure
**
**	Parameters:
**		none.
**
**	Returns:
**		none.
**
**	Side Effects:
**		clears the Stat structure.
*/

void
clearstats()
{
	/* clear the structure to avoid future disappointment */
	memset(&Stat, '\0', sizeof(Stat));
	GotStats = false;
}
/*
**  POSTSTATS -- post statistics in the statistics file
**
**	Parameters:
**		sfile -- the name of the statistics file.
**
**	Returns:
**		none.
**
**	Side Effects:
**		merges the Stat structure with the sfile file.
*/

void
poststats(sfile)
	char *sfile;
{
	int fd;
	static bool entered = false;
	long sff = SFF_REGONLY|SFF_OPENASROOT;
	struct statistics stats;
	extern off_t lseek();

	if (sfile == NULL || *sfile == '\0' || !GotStats || entered)
		return;
	entered = true;

	(void) time(&Stat.stat_itime);
	Stat.stat_size = sizeof(Stat);
	Stat.stat_magic = STAT_MAGIC;
	Stat.stat_version = STAT_VERSION;

	if (!bitnset(DBS_WRITESTATSTOSYMLINK, DontBlameSendmail))
		sff |= SFF_NOSLINK;
	if (!bitnset(DBS_WRITESTATSTOHARDLINK, DontBlameSendmail))
		sff |= SFF_NOHLINK;

	fd = safeopen(sfile, O_RDWR, 0600, sff);
	if (fd < 0)
	{
		if (LogLevel > 12)
			sm_syslog(LOG_INFO, NOQID, "poststats: %s: %s",
				  sfile, sm_errstring(errno));
		errno = 0;
		entered = false;
		return;
	}
	if (read(fd, (char *) &stats, sizeof(stats)) == sizeof(stats) &&
	    stats.stat_size == sizeof(stats) &&
	    stats.stat_magic == Stat.stat_magic &&
	    stats.stat_version == Stat.stat_version)
	{
		/* merge current statistics into statfile */
		register int i;

		for (i = 0; i < MAXMAILERS; i++)
		{
			stats.stat_nf[i] += Stat.stat_nf[i];
			stats.stat_bf[i] += Stat.stat_bf[i];
			stats.stat_nt[i] += Stat.stat_nt[i];
			stats.stat_bt[i] += Stat.stat_bt[i];
			stats.stat_nr[i] += Stat.stat_nr[i];
			stats.stat_nd[i] += Stat.stat_nd[i];
			stats.stat_nq[i] += Stat.stat_nq[i];
		}
		stats.stat_cr += Stat.stat_cr;
		stats.stat_ct += Stat.stat_ct;
		stats.stat_cf += Stat.stat_cf;
	}
	else
		memmove((char *) &stats, (char *) &Stat, sizeof(stats));

	/* write out results */
	(void) lseek(fd, (off_t) 0, 0);
	(void) write(fd, (char *) &stats, sizeof(stats));
	(void) close(fd);

	/* clear the structure to avoid future disappointment */
	clearstats();
	entered = false;
}
@


1.11
log
@Update to sendmail 8.14.8.  This touches a lot of files due to the
Sendmail, Inc -> Proofpoint name change.  See RELEASE_NOTES for
actual changes.
@
text
@@


1.10
log
@Update to sendmail-8.14.0.  OK mbalmer@@
@
text
@d2 1
a2 1
 * Copyright (c) 1998-2002 Sendmail, Inc. and its suppliers.
d16 1
a16 1
SM_RCSID("@@(#)$Sendmail: stats.c,v 8.57 2006/08/15 23:24:58 ca Exp $")
@


1.9
log
@Update to sendmail.8.13.0
@
text
@d16 1
a16 1
SM_RCSID("@@(#)$Sendmail: stats.c,v 8.56 2002/06/27 22:47:37 gshapiro Exp $")
d115 1
a115 1
	memset(&Stat, '\0', sizeof Stat);
d146 1
a146 1
	Stat.stat_size = sizeof Stat;
d165 2
a166 2
	if (read(fd, (char *) &stats, sizeof stats) == sizeof stats &&
	    stats.stat_size == sizeof stats &&
d188 1
a188 1
		memmove((char *) &stats, (char *) &Stat, sizeof stats);
d192 1
a192 1
	(void) write(fd, (char *) &stats, sizeof stats);
@


1.8
log
@Update to sendmail-8.12.4
@
text
@d16 1
a16 1
SM_RCSID("@@(#)$Sendmail: stats.c,v 8.55 2002/05/21 22:28:52 gshapiro Exp $")
a49 1
#if _FFR_QUARANTINE
a53 1
#endif /* _FFR_QUARANTINE */
a180 1
#if _FFR_QUARANTINE
a181 1
#endif /* _FFR_QUARANTINE */
@


1.7
log
@update to sendmail 8.12.3
@
text
@d16 1
a16 1
SM_RCSID("@@(#)$Sendmail: stats.c,v 8.54 2002/03/19 00:23:28 gshapiro Exp $")
d157 1
a157 1
	fd = safeopen(sfile, O_RDWR, 0644, sff);
@


1.6
log
@update to sendmail-8.12.2
@
text
@d2 1
a2 1
 * Copyright (c) 1998-2001 Sendmail, Inc. and its suppliers.
d16 1
a16 1
SM_RCSID("@@(#)$Sendmail: stats.c,v 8.52 2001/11/21 13:39:14 gshapiro Exp $")
d68 7
a77 1
			Stat.stat_cf++;
a86 1
			Stat.stat_ct++;
@


1.5
log
@Update to sendmail 8.12.1.

A potential security problem has been uncovered in 8.12.0 which might
be exploited locally by malicious users to gain access to the client
mail queue.  However, as long as the MTA accepts local connections,
the possible consequences of this potential local exploit are small.
Notice: some operating systems don't provide a way to completely drop
privileges from a set-group-ID program.  In that case sendmail refuses
to run if unsafe options are given.
@
text
@d16 1
a16 1
SM_RCSID("@@(#)$Sendmail: stats.c,v 8.50 2001/09/11 04:05:17 gshapiro Exp $")
d33 1
a33 1
**		reject -- whether this is a rejection.
d43 1
a43 1
markstats(e, to, reject)
d46 1
a46 1
	bool reject;
d48 1
a48 1
	if (reject)
d50 8
d66 14
a79 5
	}
	else if (to == NULL)
	{
		Stat.stat_cf++;
		if (e->e_from.q_mailer != NULL)
d81 3
a83 3
			Stat.stat_nf[e->e_from.q_mailer->m_mno]++;
			Stat.stat_bf[e->e_from.q_mailer->m_mno] +=
				KBYTES(e->e_msgsize);
d85 5
a89 6
	}
	else
	{
		Stat.stat_ct++;
		Stat.stat_nt[to->q_mailer->m_mno]++;
		Stat.stat_bt[to->q_mailer->m_mno] += KBYTES(e->e_msgsize);
d178 3
@


1.4
log
@merge in sendmail 8.12.0 with BSD Makefiles and mdoc man pages
@
text
@d16 1
a16 1
SM_RCSID("@@(#)$Sendmail: stats.c,v 8.47 2001/08/24 17:01:47 ca Exp $")
d27 1
a27 1
/*
d79 1
a79 1
/*
d99 1
a99 1
/*
@


1.3
log
@Update to sendmail 8.11.3.  This is a maintenance release which
contains bug fixes for problems found after 8.11.2 was released.
Systems which use buffered file I/O (like OpenBSD) were not properly
fsync()'ing the data (df) file.  Although there is little chance
of data loss, this is an important fix.
@
text
@d14 3
a16 3
#ifndef lint
static char id[] = "@@(#)$Sendmail: stats.c,v 8.36.14.5 2001/02/14 04:07:30 gshapiro Exp $";
#endif /* ! lint */
a17 1
#include <sendmail.h>
a19 1

d22 1
a22 1
static bool	GotStats = FALSE;	/* set when we have stats to merge */
d77 1
a77 1
	GotStats = TRUE;
d97 1
a97 1
	GotStats = FALSE;
d116 2
a117 1
	register int fd;
d122 1
a122 1
	if (sfile == NULL || !GotStats)
d124 1
d141 1
a141 1
				  sfile, errstring(errno));
d143 1
d177 1
@


1.2
log
@sendmail 8.11.2 with BSD Makefiles
@
text
@d2 1
a2 1
 * Copyright (c) 1998-2000 Sendmail, Inc. and its suppliers.
d15 1
a15 1
static char id[] = "@@(#)$Sendmail: stats.c,v 8.36.14.3 2000/09/17 17:04:27 gshapiro Exp $";
@


1.1
log
@Initial revision
@
text
@d2 1
a2 1
 * Copyright (c) 1998, 1999 Sendmail, Inc. and its suppliers.
d15 1
a15 1
static char id[] = "@@(#)$Sendmail: stats.c,v 8.36 1999/12/06 21:17:02 ca Exp $";
d21 1
d26 1
d77 2
@


1.1.1.1
log
@stock sendmail 8.10.0 with $Id -> $Sendmail
@
text
@@


1.1.1.1.4.1
log
@Pull in patch from current:
Errata(028):
The signal handlers in sendmail contain code that is unsafe in the
context of a signal handler.  This leads to potentially serious race
conditions.  At the moment this is a theoretical attack only and can
only be exploited on the local host (if at all).
Fix(millert):
Update to sendmail 8.11.4:
8.11.4 revamps signal handling within the MTA in order to reduce
the likelihood of a race condition that can lead to heap
corruption as described in Michal Zalewski's advisory.  The
problems discussed in the advisory are not currently known to
be exploitable but we recommend upgrading to 8.11.4 in case a
method is found to exploit the signal handling race condition.
8.11.4 also fixes other bugs found since the release of 8.11.3.

See the RELEASE_NOTES file for more details.
@
text
@d2 1
a2 1
 * Copyright (c) 1998-2001 Sendmail, Inc. and its suppliers.
d15 1
a15 1
static char id[] = "@@(#)$Sendmail: stats.c,v 8.36.14.5 2001/02/14 04:07:30 gshapiro Exp $";
a20 1

a24 1
/* See http://physics.nist.gov/cuu/Units/binary.html */
a74 2


@


1.1.1.2
log
@sendmail 8.11.2
@
text
@d2 1
a2 1
 * Copyright (c) 1998-2000 Sendmail, Inc. and its suppliers.
d15 1
a15 1
static char id[] = "@@(#)$Id: stats.c,v 8.36.14.3 2000/09/17 17:04:27 gshapiro Exp $";
a20 1

a24 1
/* See http://physics.nist.gov/cuu/Units/binary.html */
a74 2


@


1.1.1.3
log
@sendmail 8.12.0 with $Id tags converted to $Sendmail
@
text
@d2 1
a2 1
 * Copyright (c) 1998-2001 Sendmail, Inc. and its suppliers.
d14 4
d19 1
a20 3
SM_RCSID("@@(#)$Sendmail: stats.c,v 8.47 2001/08/24 17:01:47 ca Exp $")

#include <sendmail/mailstats.h>
d24 1
a24 1
static bool	GotStats = false;	/* set when we have stats to merge */
d79 1
a79 1
	GotStats = true;
d99 1
a99 1
	GotStats = false;
d118 1
a118 2
	int fd;
	static bool entered = false;
d123 1
a123 1
	if (sfile == NULL || *sfile == '\0' || !GotStats || entered)
a124 1
	entered = true;
d141 1
a141 1
				  sfile, sm_errstring(errno));
a142 1
		entered = false;
a175 1
	entered = false;
@


