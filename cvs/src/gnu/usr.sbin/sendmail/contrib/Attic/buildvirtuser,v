head	1.9;
access;
symbols
	OPENBSD_5_6:1.8.0.28
	OPENBSD_5_6_BASE:1.8
	OPENBSD_5_5:1.8.0.26
	OPENBSD_5_5_BASE:1.8
	OPENBSD_5_4:1.8.0.22
	OPENBSD_5_4_BASE:1.8
	OPENBSD_5_3:1.8.0.20
	OPENBSD_5_3_BASE:1.8
	OPENBSD_5_2:1.8.0.18
	OPENBSD_5_2_BASE:1.8
	OPENBSD_5_1_BASE:1.8
	OPENBSD_5_1:1.8.0.16
	OPENBSD_5_0:1.8.0.14
	OPENBSD_5_0_BASE:1.8
	OPENBSD_4_9:1.8.0.12
	OPENBSD_4_9_BASE:1.8
	OPENBSD_4_8:1.8.0.10
	OPENBSD_4_8_BASE:1.8
	OPENBSD_4_7:1.8.0.6
	OPENBSD_4_7_BASE:1.8
	OPENBSD_4_6:1.8.0.8
	OPENBSD_4_6_BASE:1.8
	OPENBSD_4_5:1.8.0.4
	OPENBSD_4_5_BASE:1.8
	OPENBSD_4_4:1.8.0.2
	OPENBSD_4_4_BASE:1.8
	OPENBSD_4_3:1.7.0.16
	OPENBSD_4_3_BASE:1.7
	OPENBSD_4_2:1.7.0.14
	OPENBSD_4_2_BASE:1.7
	OPENBSD_4_1:1.7.0.12
	OPENBSD_4_1_BASE:1.7
	OPENBSD_4_0:1.7.0.10
	OPENBSD_4_0_BASE:1.7
	OPENBSD_3_9:1.7.0.8
	OPENBSD_3_9_BASE:1.7
	OPENBSD_3_8:1.7.0.6
	OPENBSD_3_8_BASE:1.7
	OPENBSD_3_7:1.7.0.4
	OPENBSD_3_7_BASE:1.7
	OPENBSD_3_6:1.7.0.2
	OPENBSD_3_6_BASE:1.7
	OPENBSD_3_5:1.6.0.6
	OPENBSD_3_5_BASE:1.6
	OPENBSD_3_4:1.6.0.4
	OPENBSD_3_4_BASE:1.6
	OPENBSD_3_3:1.6.0.2
	OPENBSD_3_3_BASE:1.6
	OPENBSD_3_2:1.5.0.2
	OPENBSD_3_2_BASE:1.5
	OPENBSD_3_1:1.4.0.4
	OPENBSD_3_1_BASE:1.4
	OPENBSD_3_0:1.4.0.2
	OPENBSD_3_0_BASE:1.4
	SENDMAIL_8_12_0:1.1.1.2
	OPENBSD_2_9:1.3.0.2
	OPENBSD_2_9_BASE:1.3
	SENDMAIL_8_11_2:1.1.1.1
	SENDMAIL_INC:1.1.1;
locks; strict;
comment	@# @;


1.9
date	2014.09.17.18.49.50;	author matthieu;	state dead;
branches;
next	1.8;
commitid	M7i5giHIoz3DMlTU;

1.8
date	2008.05.04.18.34.04;	author millert;	state Exp;
branches;
next	1.7;

1.7
date	2004.06.24.03.59.24;	author millert;	state Exp;
branches;
next	1.6;

1.6
date	2003.03.29.19.44.00;	author millert;	state Exp;
branches;
next	1.5;

1.5
date	2002.04.18.00.49.26;	author millert;	state Exp;
branches;
next	1.4;

1.4
date	2001.09.11.19.02.48;	author millert;	state Exp;
branches;
next	1.3;

1.3
date	2001.02.28.02.43.50;	author millert;	state Exp;
branches;
next	1.2;

1.2
date	2001.01.15.21.09.00;	author millert;	state Exp;
branches;
next	1.1;

1.1
date	2001.01.15.20.52.40;	author millert;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2001.01.15.20.52.40;	author millert;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2001.09.11.18.55.52;	author millert;	state Exp;
branches;
next	;


desc
@@


1.9
log
@Bye.
@
text
@#!/usr/bin/perl -w

# Copyright (c) 1999-2004, 2007 Gregory Neil Shapiro.  All Rights Reserved.
# 
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
#
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. Neither the name of the author nor the names of its contributors
#    may be used to endorse or promote products derived from this software
#    without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.

# $Sendmail: buildvirtuser,v 1.8 2007/10/08 18:44:15 gshapiro Exp $

=head1 NAME

buildvirtuser - Build virtusertable support from a directory of files

=head1 SYNOPSIS

    buildvirtuser [-f] [-t]

=head1 DESCRIPTION

buildvirtuser will build /etc/mail/virtusertable.db and /etc/mail/virthosts
based on the contents of the directory /etc/mail/virtusers/.  That
directory should contain one file per virtual domain with the filename
matching the virtual domain name and the contents containing a list of
usernames on the left and the actual address for that username on the
right.  An empty left column translates to the default for that domain.
Blank lines and lines beginning with '#' are ignored.  Occurrences of
$DOMAIN in the file are replaced by the current domain being processed.
Occurrences of $LHS in the right hand side are replaced by the address on
the left hand side.

The -f option forces the database to be rebuilt regardless of whether
any file changes were detected.

The -t option instructs the program to build a text file instead of a
database.  The text file can then be used with makemap.

=head1 CONFIGURATION

In order to function properly, sendmail must be configured to use these
files with:

	FEATURE(`virtusertable')dnl
	VIRTUSER_DOMAIN_FILE(`/etc/mail/virthosts')dnl

If a new domain is added (i.e., by adding a new file to
/etc/mail/virtusers/), the sendmail daemon must be restarted for the change
to take affect.

=head1 EXAMPLES

Here is an example file from the /etc/mail/virtusers/ directory:

=head2 /etc/mail/virtusers/example.org:

 # Services
 MAILER-DAEMON	gshapiro+bounce.$DOMAIN@@example.net
 postmaster	gshapiro+$LHS.$DOMAIN@@example.net
 webmaster	gshapiro+$LHS.$DOMAIN@@example.net
 
 # Defaults
 		error:nouser No such user
 
 # Users
 gshapiro	gshapiro+$DOMAIN@@example.net
 zoe		zoe@@example.com

=head1 AUTHOR

Gregory Neil Shapiro E<lt>F<gshapiro@@gshapiro.net>E<gt>

=cut

use strict;
use File::stat;
use Getopt::Std;

my $makemap = "/usr/sbin/makemap";
my $dbtype = "hash";
my $maildir = "/etc/mail";
my $virthosts = "$maildir/virthosts";
my $newvirthosts = "$maildir/virthosts.new";
my $virts = "$maildir/virtusers";
my $newvirt = "$maildir/virtusertable.new.db";
my $virt = "$maildir/virtusertable.db";
my %virt = ();
my $newest = 0;
my ($lhs, $domain, $key, $value);
my $opts = {};

sub preserve_perms ($$)
{
	my $old = shift;
	my $new = shift;
	my $st;

	$st = stat($old);
	return if (!defined($st));
	chmod($st->mode, $new) || warn "Could not chmod($st->mode, $new): $!\n";
	chown($st->uid, $st->gid, $new) || warn "Could not chmod($st->uid, $st->gid, $new): $!\n";
}

getopts('ft', $opts) || die "Usage: $0 [-f] [-t]\n";

if ($opts->{t})
{
	$newvirt = "$maildir/virtusertable.new";
	$virt = "$maildir/virtusertable";
}

opendir(VIRTS, $virts) || die "Could not open directory $virts: $!\n";
my @@virts = grep { -f "$virts/$_" } readdir(VIRTS);
closedir(VIRTS) || die "Could not close directory $virts: $!\n";

foreach $domain (@@virts)
{
	next if ($domain =~ m/^\./);
	open(DOMAIN, "$virts/$domain") || die "Could not open file $virts/$domain: $!\n";
	my $line = 0;
	my $mtime = 0;
	my $st = stat("$virts/$domain");
	$mtime = $st->mtime if (defined($st));
	if ($mtime > $newest)
	{
		$newest = $mtime;
	}
LINE:	while (<DOMAIN>)
	{
		chomp;
		$line++;
		next LINE if /^#/;
		next LINE if /^$/;
		if (m/^([^\t ]*)[\t ]+(.*)$/)
		{
			if (defined($1))
			{
				$lhs = "$1";
				$key = "$1\@@$domain";
			}
			else
			{
				$lhs = "";
				$key = "\@@$domain";
			}
			$value = $2;
		}
		else
		{
			warn "Bogus line $line in $virts/$domain\n";
		}

		# Variable subsitution
		$key =~ s/\$DOMAIN/$domain/g;
		$value =~ s/\$DOMAIN/$domain/g;
		$value =~ s/\$LHS/$lhs/g;
		$virt{$key} = $value;
	}
	close(DOMAIN) || die "Could not close $virts/$domain: $!\n";
}

my $virtmtime = 0;
my $st = stat($virt);
$virtmtime = $st->mtime if (defined($st));
if ($opts->{f} || $virtmtime < $newest)
{
	print STDOUT "Rebuilding $virt\n";
# logger -s -t ${prog} -p mail.info "Rebuilding ${basedir}/virtusertable"
	if ($opts->{t})
	{
		open(MAKEMAP, ">$newvirt") || die "Could not open $newvirt: $!\n";
	}
	else
	{
		open(MAKEMAP, "|$makemap $dbtype $newvirt") || die "Could not start makemap: $!\n";
	}

	foreach $key (keys %virt)
	{
		print MAKEMAP "$key\t\t$virt{$key}\n";
	}
	close(MAKEMAP) || die "Could not close makemap ($?): $!\n";
	preserve_perms($virt, $newvirt);
	rename($newvirt, $virt) || die "Could not rename $newvirt to $virt: $!\n";

	open(VIRTHOST, ">$newvirthosts") || die "Could not open file $newvirthosts: $!\n";
	foreach $domain (sort @@virts)
	{
		next if ($domain =~ m/^\./);
		print VIRTHOST "$domain\n";
	}
	close(VIRTHOST) || die "Could not close $newvirthosts: $!\n";
	preserve_perms($virthosts, $newvirthosts);
	rename($newvirthosts, $virthosts) || die "Could not rename $newvirthosts to $virthosts: $!\n";
}
exit 0;
@


1.8
log
@Update to sendmail-8.14.3
@
text
@@


1.7
log
@Update to sendmail.8.13.0
@
text
@d3 1
a3 1
# Copyright (c) 1999-2003 Gregory Neil Shapiro.  All Rights Reserved.
d30 1
a30 1
# $Sendmail: buildvirtuser,v 1.6 2003/03/15 23:30:09 gshapiro Exp $
d73 1
a73 1
Here are some example files from the /etc/mail/virtusers/ directory:
d75 1
a75 1
=head2 /etc/mail/virtusers/bsdunix.org:
d78 3
a80 3
 MAILER-DAEMON	gshapiro+bounce.$DOMAIN@@gshapiro.net
 postmaster	gshapiro+$LHS.$DOMAIN@@gshapiro.net
 webmaster	gshapiro+$LHS.$DOMAIN@@gshapiro.net
d86 2
a87 11
 gshapiro	gshapiro+$DOMAIN@@gshapiro.net
 bob		robert@@smtp.org

=head2 /etc/mail/virtusers/smtp.org:

 # Defaults
 		gshapiro+$DOMAIN@@gshapiro.net
 
 # Users
 john		john@@wookie.org
 nancy		n@@milter.com
d96 1
d112 12
d138 1
d141 3
a143 1
	my $mtime = (stat(DOMAIN))[9] || 0;
d170 1
a170 1
			die "Bogus line $line in $virts/$domain\n";
d182 3
a184 1
my $virtmtime = (stat($virt))[9] || 0;
d203 1
d209 1
d213 1
@


1.6
log
@Update to sendmail 8.12.9; fixes a buffer overflow in address parsing
due to a char to int conversion problem which is potentially remotely
exploitable.
@
text
@d30 1
a30 1
# $Sendmail: buildvirtuser,v 1.5.2.1 2003/03/15 23:30:26 gshapiro Exp $
@


1.5
log
@update to sendmail 8.12.3
@
text
@d3 1
a3 1
# Copyright (c) 1999-2002 Gregory Neil Shapiro.  All Rights Reserved.
d30 1
a30 1
# $Sendmail: buildvirtuser,v 1.5 2002/02/08 08:10:59 gshapiro Exp $
d38 1
a38 1
    buildvirtuser [-f]
d56 3
d120 7
a126 1
getopts('f', $opts) || die "Usage: $0 [-f]\n";
d180 9
a188 1
	open(MAKEMAP, "|$makemap $dbtype $newvirt") || die "Could not start makemap: $!\n";
@


1.4
log
@merge in sendmail 8.12.0 with BSD Makefiles and mdoc man pages
@
text
@d3 1
a3 1
# Copyright (c) 1999-2001 Gregory Neil Shapiro.  All Rights Reserved.
d30 1
a30 1
# $Sendmail: buildvirtuser,v 1.3 2001/02/12 02:58:20 gshapiro Exp $
d38 1
a38 1
    buildvirtuser
d53 3
d102 1
d115 3
d167 1
a167 1
if ($virtmtime < $newest)
@


1.3
log
@Update to sendmail 8.11.3.  This is a maintenance release which
contains bug fixes for problems found after 8.11.2 was released.
Systems which use buffered file I/O (like OpenBSD) were not properly
fsync()'ing the data (df) file.  Although there is little chance
of data loss, this is an important fix.
@
text
@d30 1
a30 1
# $Sendmail: buildvirtuser,v 1.1.2.3 2001/02/12 02:57:13 gshapiro Exp $
@


1.2
log
@sendmail 8.11.2 with BSD Makefiles
@
text
@d3 1
a3 1
# Copyright (c) 1999-2000 Gregory Neil Shapiro.  All Rights Reserved.
d30 1
a30 1
# $Sendmail: buildvirtuser,v 1.1.2.1 2000/10/26 22:51:03 gshapiro Exp $
d48 4
a51 1
Blank lines and lines beginning with '#' are ignored.
d72 3
a74 3
 MAILER-DAEMON	gshapiro+MAILER-DAEMON.bsdunix.org@@gshapiro.net
 postmaster	gshapiro+postmaster.bsdunix.org@@gshapiro.net
 webmaster	gshapiro+webmaster.bsdunix.org@@gshapiro.net
d80 1
a80 1
 gshapiro	gshapiro+bsdunix.org@@gshapiro.net
d86 1
a86 1
 		gshapiro+smtp.org@@gshapiro.net
d98 2
d110 1
d135 1
d140 1
d149 5
@


1.1
log
@Initial revision
@
text
@d30 1
a30 1
# $Id: buildvirtuser,v 1.1.2.1 2000/10/26 22:51:03 gshapiro Exp $
@


1.1.1.1
log
@sendmail 8.11.2
@
text
@@


1.1.1.2
log
@sendmail 8.12.0 with $Id tags converted to $Sendmail
@
text
@d3 1
a3 1
# Copyright (c) 1999-2001 Gregory Neil Shapiro.  All Rights Reserved.
d30 1
a30 1
# $Sendmail: buildvirtuser,v 1.3 2001/02/12 02:58:20 gshapiro Exp $
d48 1
a48 4
Blank lines and lines beginning with '#' are ignored.  Occurrences of
$DOMAIN in the file are replaced by the current domain being processed.
Occurrences of $LHS in the right hand side are replaced by the address on
the left hand side.
d69 3
a71 3
 MAILER-DAEMON	gshapiro+bounce.$DOMAIN@@gshapiro.net
 postmaster	gshapiro+$LHS.$DOMAIN@@gshapiro.net
 webmaster	gshapiro+$LHS.$DOMAIN@@gshapiro.net
d77 1
a77 1
 gshapiro	gshapiro+$DOMAIN@@gshapiro.net
d83 1
a83 1
 		gshapiro+$DOMAIN@@gshapiro.net
a94 2
use strict;

a104 1
my ($lhs, $domain, $key, $value);
a128 1
				$lhs = "$1";
a132 1
				$lhs = "";
a140 5

		# Variable subsitution
		$key =~ s/\$DOMAIN/$domain/g;
		$value =~ s/\$DOMAIN/$domain/g;
		$value =~ s/\$LHS/$lhs/g;
@

