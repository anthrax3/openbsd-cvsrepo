head	1.15;
access;
symbols
	OPENBSD_5_6:1.14.0.34
	OPENBSD_5_6_BASE:1.14
	OPENBSD_5_5:1.14.0.32
	OPENBSD_5_5_BASE:1.14
	OPENBSD_5_4:1.14.0.28
	OPENBSD_5_4_BASE:1.14
	OPENBSD_5_3:1.14.0.26
	OPENBSD_5_3_BASE:1.14
	OPENBSD_5_2:1.14.0.24
	OPENBSD_5_2_BASE:1.14
	OPENBSD_5_1_BASE:1.14
	OPENBSD_5_1:1.14.0.22
	OPENBSD_5_0:1.14.0.20
	OPENBSD_5_0_BASE:1.14
	OPENBSD_4_9:1.14.0.18
	OPENBSD_4_9_BASE:1.14
	OPENBSD_4_8:1.14.0.16
	OPENBSD_4_8_BASE:1.14
	OPENBSD_4_7:1.14.0.12
	OPENBSD_4_7_BASE:1.14
	OPENBSD_4_6:1.14.0.14
	OPENBSD_4_6_BASE:1.14
	OPENBSD_4_5:1.14.0.10
	OPENBSD_4_5_BASE:1.14
	OPENBSD_4_4:1.14.0.8
	OPENBSD_4_4_BASE:1.14
	OPENBSD_4_3:1.14.0.6
	OPENBSD_4_3_BASE:1.14
	OPENBSD_4_2:1.14.0.4
	OPENBSD_4_2_BASE:1.14
	OPENBSD_4_1:1.14.0.2
	OPENBSD_4_1_BASE:1.14
	OPENBSD_4_0:1.13.0.2
	OPENBSD_4_0_BASE:1.13
	OPENBSD_3_9:1.12.0.8
	OPENBSD_3_9_BASE:1.12
	OPENBSD_3_8:1.12.0.6
	OPENBSD_3_8_BASE:1.12
	OPENBSD_3_7:1.12.0.4
	OPENBSD_3_7_BASE:1.12
	OPENBSD_3_6:1.12.0.2
	OPENBSD_3_6_BASE:1.12
	OPENBSD_3_5:1.11.0.2
	OPENBSD_3_5_BASE:1.11
	OPENBSD_3_4:1.10.0.2
	OPENBSD_3_4_BASE:1.10
	OPENBSD_3_3:1.10.0.4
	OPENBSD_3_3_BASE:1.10
	OPENBSD_3_2:1.9.0.4
	OPENBSD_3_2_BASE:1.9
	OPENBSD_3_1:1.9.0.2
	OPENBSD_3_1_BASE:1.9
	OPENBSD_3_0:1.8.0.2
	OPENBSD_3_0_BASE:1.8
	SENDMAIL_8_12_0:1.1.1.3
	OPENBSD_2_9:1.5.0.2
	OPENBSD_2_9_BASE:1.5
	SENDMAIL_8_11_2:1.1.1.2
	OPENBSD_2_8:1.3.0.4
	OPENBSD_2_8_BASE:1.3
	OPENBSD_2_7:1.3.0.2
	OPENBSD_2_7_BASE:1.3
	SENDMAIL_8_10_0:1.1.1.1
	SENDMAIL_INC:1.1.1;
locks; strict;
comment	@# @;


1.15
date	2014.09.17.18.49.50;	author matthieu;	state dead;
branches;
next	1.14;
commitid	M7i5giHIoz3DMlTU;

1.14
date	2007.02.04.13.17.35;	author millert;	state Exp;
branches;
next	1.13;

1.13
date	2006.03.22.18.43.54;	author millert;	state Exp;
branches;
next	1.12;

1.12
date	2004.06.24.03.59.25;	author millert;	state Exp;
branches;
next	1.11;

1.11
date	2003.09.17.17.31.39;	author millert;	state Exp;
branches;
next	1.10;

1.10
date	2003.01.01.19.59.21;	author millert;	state Exp;
branches;
next	1.9;

1.9
date	2002.01.14.03.21.40;	author millert;	state Exp;
branches;
next	1.8;

1.8
date	2001.09.11.19.02.49;	author millert;	state Exp;
branches;
next	1.7;

1.7
date	2001.08.01.01.01.40;	author millert;	state Exp;
branches;
next	1.6;

1.6
date	2001.05.29.01.31.12;	author millert;	state Exp;
branches;
next	1.5;

1.5
date	2001.02.28.02.43.51;	author millert;	state Exp;
branches
	1.5.2.1;
next	1.4;

1.4
date	2001.01.15.21.09.02;	author millert;	state Exp;
branches;
next	1.3;

1.3
date	2000.04.07.19.20.34;	author millert;	state Exp;
branches
	1.3.4.1;
next	1.2;

1.2
date	2000.04.02.19.48.31;	author millert;	state Exp;
branches;
next	1.1;

1.1
date	2000.04.02.19.05.58;	author millert;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2000.04.02.19.05.58;	author millert;	state Exp;
branches;
next	1.1.1.2;

1.1.1.2
date	2001.01.15.20.52.42;	author millert;	state Exp;
branches;
next	1.1.1.3;

1.1.1.3
date	2001.09.11.18.55.52;	author millert;	state Exp;
branches;
next	;

1.3.4.1
date	2001.05.31.00.28.49;	author miod;	state Exp;
branches;
next	;

1.5.2.1
date	2001.05.31.01.47.53;	author jason;	state Exp;
branches;
next	;


desc
@@


1.15
log
@Bye.
@
text
@This directory contains the source files for libmilter.

The sendmail Mail Filter API (Milter) is designed to allow third-party
programs access to mail messages as they are being processed in order to
filter meta-information and content.

This README file describes the steps needed to compile and run a filter,
through reference to a sample filter which is attached at the end of this
file.  It is necessary to first build libmilter.a, which can be done by
issuing the './Build' command in SRCDIR/libmilter .

Starting with 8.13 sendmail is compiled by default with support for
the milter API.

Note: if you want to write a milter in Java, then see
http://sendmail-jilter.sourceforge.net/

+----------------+
| SECURITY HINTS |
+----------------+

Note: we strongly recommend not to run any milter as root.  Libmilter
does not need root access to communicate with sendmail.  It is a
good security practice to run a program only with root privileges
if really necessary.  A milter should probably check first whether
it runs as root and refuse to start in that case.  libmilter will
not unlink a socket when running as root.

+----------------------+
| CONFIGURATION MACROS |
+----------------------+

Libmilter uses a set of C preprocessor macros to specify platform specific
features of the C compiler and standard C libraries.

SM_CONF_POLL
	Set to 1 if poll(2) should be used instead of select(2).

+-------------------+
| BUILDING A FILTER |
+-------------------+

The following command presumes that the sample code from the end of this
README is saved to a file named 'sample.c' and built in the local platform-
specific build subdirectory (SRCDIR/obj.*/libmilter).

	cc -I../../include -o sample sample.c libmilter.a ../libsm/libsm.a -pthread

It is recommended that you build your filters in a location outside of
the sendmail source tree.  Modify the compiler include references (-I)
and the library locations accordingly.  Also, some operating systems may
require additional libraries.  For example, SunOS 5.X requires '-lresolv
-lsocket -lnsl'.  Depending on your operating system you may need a library
instead of the option -pthread, e.g., -lpthread.

Filters must be thread-safe!  Many operating systems now provide support for
POSIX threads in the standard C libraries.  The compiler flag to link with
threading support differs according to the compiler and linker used.  Check
the Makefile in your appropriate obj.*/libmilter build subdirectory if you
are unsure of the local flag used.

Note that since filters use threads, it may be necessary to alter per
process limits in your filter.  For example, you might look at using
setrlimit() to increase the number of open file descriptors if your filter
is going to be busy.


+----------------------------------------+
| SPECIFYING FILTERS IN SENDMAIL CONFIGS |
+----------------------------------------+

Filters are specified with a key letter ``X'' (for ``eXternal'').

For example:

	Xfilter1, S=local:/var/run/f1.sock, F=R
	Xfilter2, S=inet6:999@@localhost, F=T, T=C:10m;S:1s;R:1s;E:5m
	Xfilter3, S=inet:3333@@localhost

specifies three filters.  Filters can be specified in your .mc file using
the following:

	INPUT_MAIL_FILTER(`filter1', `S=local:/var/run/f1.sock, F=R')
	INPUT_MAIL_FILTER(`filter2', `S=inet6:999@@localhost, F=T, T=C:10m;S:1s;R:1s;E:5m')
	INPUT_MAIL_FILTER(`filter3', `S=inet:3333@@localhost')

The first attaches to a Unix-domain socket in the /var/run directory; the
second uses an IPv6 socket on port 999 of localhost, and the third uses an
IPv4 socket on port 3333 of localhost.  The current flags (F=) are:

	R		Reject connection if filter unavailable
	T		Temporary fail connection if filter unavailable
	4		Shut down connection if filter unavailable
			(with a 421 temporary error).

If none of these is specified, the message is passed through sendmail
in case of filter errors as if the failing filters were not present.

Finally, you can override the default timeouts used by sendmail when
talking to the filters using the T= equate.  There are four fields inside
of the T= equate:

Letter		Meaning
  C		Timeout for connecting to a filter (if 0, use system timeout)
  S		Timeout for sending information from the MTA to a filter
  R		Timeout for reading reply from the filter
  E		Overall timeout between sending end-of-message to filter
		and waiting for the final acknowledgment

Note the separator between each is a ';' as a ',' already separates equates
and therefore can't separate timeouts.  The default values (if not set in
the config) are:

T=C:5m;S:10s;R:10s;E:5m

where 's' is seconds and 'm' is minutes.

Which filters are invoked and their sequencing is handled by the 
InputMailFilters option. Note: if InputMailFilters is not defined no filters
will be used.

	O InputMailFilters=filter1, filter2, filter3

This is is set automatically according to the order of the
INPUT_MAIL_FILTER commands in your .mc file.  Alternatively, you can
reset its value by setting confINPUT_MAIL_FILTERS in your .mc file.
This options causes the three filters to be called in the same order
they were specified.  It allows for possible future filtering on output
(although this is not intended for this release).

Also note that a filter can be defined without adding it to the input
filter list by using MAIL_FILTER() instead of INPUT_MAIL_FILTER() in your
.mc file.

To test sendmail with the sample filter, the following might be added (in
the appropriate locations) to your .mc file:

	INPUT_MAIL_FILTER(`sample', `S=local:/var/run/f1.sock')


+------------------+
| TESTING A FILTER |
+------------------+

Once you have compiled a filter, modified your .mc file and restarted
the sendmail process, you will want to test that the filter performs as
intended.

The sample filter takes one argument -p, which indicates the local port
on which to create a listening socket for the filter.  Maintaining
consistency with the suggested options for sendmail.cf, this would be the
UNIX domain socket located in /var/run/f1.sock.

	% ./sample -p local:/var/run/f1.sock

If the sample filter returns immediately to a command line, there was either
an error with your command or a problem creating the specified socket.
Further logging can be captured through the syslogd daemon.  Using the
'netstat -a' command can ensure that your filter process is listening on
the appropriate local socket.

Email messages must be injected via SMTP to be filtered.  There are two
simple means of doing this; either using the 'sendmail -bs' command, or
by telnetting to port 25 of the machine configured for milter.  Once
connected via one of these options, the session can be continued through
the use of standard SMTP commands.

% sendmail -bs
220 test.sendmail.com ESMTP Sendmail 8.14.0/8.14.0; Thu, 22 Jun 2006 13:05:23 -0500 (EST)
HELO localhost
250 test.sendmail.com Hello testy@@localhost, pleased to meet you
MAIL From:<testy>
250 2.1.0 <testy>... Sender ok
RCPT To:<root>
250 2.1.5 <root>... Recipient ok
DATA
354 Enter mail, end with "." on a line by itself
From: testy@@test.sendmail.com
To: root@@test.sendmail.com
Subject: testing sample filter

Sample body
.
250 2.0.0 dB73Zxi25236 Message accepted for delivery
QUIT
221 2.0.0 test.sendmail.com closing connection

In the above example, the lines beginning with numbers are output by the
mail server, and those without are your input.  If everything is working
properly, you will find a file in /tmp by the name of msg.XXXXXXXX (where
the Xs represent any combination of letters and numbers).  This file should
contain the message body and headers from the test email entered above.

If the sample filter did not log your test email, there are a number of
methods to narrow down the source of the problem.  Check your system
logs written by syslogd and see if there are any pertinent lines.  You
may need to reconfigure syslogd to capture all relevant data.  Additionally,
the logging level of sendmail can be raised with the LogLevel option.
See the sendmail(8) manual page for more information.


+--------------+
| REQUIREMENTS |
+--------------+

libmilter requires pthread support in the operating system.  Moreover, it
requires that the library functions it uses are thread safe; which is true
for the operating systems libmilter has been developed and tested on.  On
some operating systems this requires special compile time options (e.g.,
not just -pthread).  libmilter is currently known to work on (modulo problems
in the pthread support of some specific versions):

FreeBSD 3.x, 4.x
SunOS 5.x (x >= 5)
AIX 4.3.x
HP UX 11.x
Linux (recent versions/distributions)

libmilter is currently not supported on:

IRIX 6.x
Ultrix

Feedback about problems (and possible fixes) is welcome.

+--------------------------+
| SOURCE FOR SAMPLE FILTER |
+--------------------------+

Note that the filter example.c may not be thread safe on some operating
systems.  You should check your system man pages for the functions used
below to verify the functions are thread safe.

$Revision: 1.14 $, Last updated $Date: 2007/02/04 13:17:35 $
@


1.14
log
@Update to sendmail-8.14.0.  OK mbalmer@@
@
text
@d234 1
a234 1
$Revision: 8.42 $, Last updated $Date: 2006/06/29 17:10:16 $
@


1.13
log
@Update to sendmail 8.13.6
@
text
@d93 2
d96 1
a96 1
If neither F=R nor F=T is specified, the message is passed through sendmail
d169 1
a169 1
220 test.sendmail.com ESMTP Sendmail 8.11.0/8.11.0; Tue, 10 Nov 1970 13:05:23 -0500 (EST)
d230 1
a230 1
Note that the filter below may not be thread safe on some operating
d234 1
a234 241
/* A trivial filter that logs all email to a file. */

#include <sys/types.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sysexits.h>
#include <unistd.h>

#include "libmilter/mfapi.h"

#ifndef true
typedef int bool;
# define false	0
# define true	1
#endif /* ! true */

struct mlfiPriv
{
	char	*mlfi_fname;
	FILE	*mlfi_fp;
};

#define MLFIPRIV	((struct mlfiPriv *) smfi_getpriv(ctx))

extern sfsistat	 mlfi_cleanup(SMFICTX *, bool);

sfsistat
mlfi_envfrom(ctx, envfrom)
	SMFICTX *ctx;
	char **envfrom;
{
	struct mlfiPriv *priv;
	int fd = -1;

	/* allocate some private memory */
	priv = malloc(sizeof *priv);
	if (priv == NULL)
	{
		/* can't accept this message right now */
		return SMFIS_TEMPFAIL;
	}
	memset(priv, '\0', sizeof *priv);

	/* open a file to store this message */
	priv->mlfi_fname = strdup("/tmp/msg.XXXXXXXX");
	if (priv->mlfi_fname == NULL)
	{
		free(priv);
		return SMFIS_TEMPFAIL;
	}
	if ((fd = mkstemp(priv->mlfi_fname)) < 0 ||
	    (priv->mlfi_fp = fdopen(fd, "w+")) == NULL)
	{
		if (fd >= 0)
			(void) close(fd);
		free(priv->mlfi_fname);
		free(priv);
		return SMFIS_TEMPFAIL;
	}

	/* save the private data */
	smfi_setpriv(ctx, priv);

	/* continue processing */
	return SMFIS_CONTINUE;
}

sfsistat
mlfi_header(ctx, headerf, headerv)
	SMFICTX *ctx;
	char *headerf;
	char *headerv;
{
	/* write the header to the log file */
	fprintf(MLFIPRIV->mlfi_fp, "%s: %s\r\n", headerf, headerv);

	/* continue processing */
	return SMFIS_CONTINUE;
}

sfsistat
mlfi_eoh(ctx)
	SMFICTX *ctx;
{
	/* output the blank line between the header and the body */
	fprintf(MLFIPRIV->mlfi_fp, "\r\n");

	/* continue processing */
	return SMFIS_CONTINUE;
}

sfsistat
mlfi_body(ctx, bodyp, bodylen)
	SMFICTX *ctx;
	u_char *bodyp;
	size_t bodylen;
{
	/* output body block to log file */
	if (fwrite(bodyp, bodylen, 1, MLFIPRIV->mlfi_fp) <= 0)
	{
		/* write failed */
		(void) mlfi_cleanup(ctx, false);
		return SMFIS_TEMPFAIL;
	}

	/* continue processing */
	return SMFIS_CONTINUE;
}

sfsistat
mlfi_eom(ctx)
	SMFICTX *ctx;
{
	return mlfi_cleanup(ctx, true);
}

sfsistat
mlfi_close(ctx)
	SMFICTX *ctx;
{
	return SMFIS_ACCEPT;
}

sfsistat
mlfi_abort(ctx)
	SMFICTX *ctx;
{
	return mlfi_cleanup(ctx, false);
}

sfsistat
mlfi_cleanup(ctx, ok)
	SMFICTX *ctx;
	bool ok;
{
	sfsistat rstat = SMFIS_CONTINUE;
	struct mlfiPriv *priv = MLFIPRIV;
	char *p;
	char host[512];
	char hbuf[1024];

	if (priv == NULL)
		return rstat;

	/* close the archive file */
	if (priv->mlfi_fp != NULL && fclose(priv->mlfi_fp) == EOF)
	{
		/* failed; we have to wait until later */
		rstat = SMFIS_TEMPFAIL;
		(void) unlink(priv->mlfi_fname);
	}
	else if (ok)
	{
		/* add a header to the message announcing our presence */
		if (gethostname(host, sizeof host) < 0)
			snprintf(host, sizeof host, "localhost");
		p = strrchr(priv->mlfi_fname, '/');
		if (p == NULL)
			p = priv->mlfi_fname;
		else
			p++;
		snprintf(hbuf, sizeof hbuf, "%s@@%s", p, host);
		smfi_addheader(ctx, "X-Archived", hbuf);
	}
	else
	{
		/* message was aborted -- delete the archive file */
		(void) unlink(priv->mlfi_fname);
	}

	/* release private memory */
	free(priv->mlfi_fname);
	free(priv);
	smfi_setpriv(ctx, NULL);

	/* return status */
	return rstat;
}

struct smfiDesc smfilter =
{
	"SampleFilter",	/* filter name */
	SMFI_VERSION,	/* version code -- do not change */
	SMFIF_ADDHDRS,	/* flags */
	NULL,		/* connection info filter */
	NULL,		/* SMTP HELO command filter */
	mlfi_envfrom,	/* envelope sender filter */
	NULL,		/* envelope recipient filter */
	mlfi_header,	/* header filter */
	mlfi_eoh,	/* end of header */
	mlfi_body,	/* body block filter */
	mlfi_eom,	/* end of message */
	mlfi_abort,	/* message aborted */
	mlfi_close	/* connection cleanup */
};


int
main(argc, argv)
	int argc;
	char *argv[];
{
	bool setconn = false;
	int c;
	const char *args = "p:";

	/* Process command line options */
	while ((c = getopt(argc, argv, args)) != -1)
	{
		switch (c)
		{
		  case 'p':
			if (optarg == NULL || *optarg == '\0')
			{
				(void) fprintf(stderr, "Illegal conn: %s\n",
					       optarg);
				exit(EX_USAGE);
			}
			(void) smfi_setconn(optarg);
			setconn = true;
			break;

		}
	}
	if (!setconn)
	{
		fprintf(stderr, "%s: Missing required -p argument\n", argv[0]);
		exit(EX_USAGE);
	}
	if (smfi_register(smfilter) == MI_FAILURE)
	{
		fprintf(stderr, "smfi_register failed\n");
		exit(EX_UNAVAILABLE);
	}
	return smfi_main();
}

/* eof */

$Revision: 8.41 $, Last updated $Date: 2005/04/27 22:47:42 $
@


1.12
log
@Update to sendmail.8.13.0
@
text
@d15 3
d472 1
a472 1
$Revision: 1.11 $, Last updated $Date: 2003/09/17 17:31:39 $
@


1.11
log
@Update to sendmail-8.12.10.  This includes a fix for a buffer overflow
in address parsing.  That fix (but not all of sendmail-8.12.10) has
been applied to OpenBSD 3.4 and the 3.2 and 3.2 -stable branches.
@
text
@d12 2
a13 5
NOTE: If you intend to use filters in sendmail, you must compile sendmail
with -DMILTER defined.  You can do this by adding the following to
your devtools/Site/site.config.m4 file:

	APPENDDEF(`conf_sendmail_ENVDEF', `-DMILTER')
d23 6
a28 4
it runs as root and refuse to start in that case.  There is a
compile time option _FFR_MILTER_ROOT_UNSAFE which keeps libmilter
from unlinking a socket when running as root.  It is recommended
to turn on this option:
d30 2
a31 1
	APPENDDEF(`conf_libmilter_ENVDEF', `-D_FFR_MILTER_ROOT_UNSAFE ')
d33 2
d469 1
a469 1
$Revision: 8.35.2.2 $, Last updated $Date: 2003/05/26 04:10:06 $
@


1.10
log
@update to sendmail 8.12.7
@
text
@d430 1
d447 1
d452 5
d467 1
a467 1
$Revision: 1.9 $, Last updated $Date: 2002/01/14 03:21:40 $
@


1.9
log
@update to sendmail-8.12.2
@
text
@d42 1
a42 1
	cc -I../../sendmail -I../../include -o sample sample.c libmilter.a ../libsm/libsm.a -pthread
d460 1
a460 1
$Revision: 1.8 $, Last updated $Date: 2001/09/11 19:02:49 $
@


1.8
log
@merge in sendmail 8.12.0 with BSD Makefiles and mdoc man pages
@
text
@d18 16
d90 1
a90 1
as if the filter were not present.
d460 1
a460 1
$Revision: 8.33 $, Last updated $Date: 2001/07/19 21:18:14 $
@


1.7
log
@update to sendmail 8.11.5
@
text
@d12 3
a14 8
NOTE: Both libmilter and the callouts in sendmail are marked as an FFR (For
Future Release).  If you intend to use them in 8.11.X, you must compiled
both libmilter and sendmail with -D_FFR_MILTER defined.  You can do this by
adding the following to your devtools/Site/site.config.m4 file:

	dnl Milter
	APPENDDEF(`conf_sendmail_ENVDEF', `-D_FFR_MILTER=1')
	APPENDDEF(`conf_libmilter_ENVDEF', `-D_FFR_MILTER=1') 
d16 1
a16 2
You will also need to define _FFR_MILTER when building your .cf file using
m4.
d26 1
a26 1
	cc -I../../sendmail -I../../include -o sample sample.c libmilter.a ../libsmutil/libsmutil.a -pthread
d32 2
a33 2
-lsocket -lnsl'.  Depending on your OS you may need a library instead
of the option -pthread, e.g., -lpthread.
d80 1
a80 1
Letter          Meaning
d91 1
a91 1
T=C:0m;S:10s;R:10s;E:5m
d179 24
d222 1
d224 3
a226 7

#ifndef FALSE
# define FALSE	0
#endif /* ! FALSE*/
#ifndef TRUE
# define TRUE	1
#endif /* ! TRUE*/
d313 1
a313 1
		(void) mlfi_cleanup(ctx, FALSE);
d325 1
a325 1
	return mlfi_cleanup(ctx, TRUE);
d339 1
a339 1
	return mlfi_cleanup(ctx, FALSE);
d367 1
a367 1
			strlcpy(host, "localhost", sizeof host);
d444 1
a444 1
$Revision: 8.9.2.1.2.19 $, Last updated $Date: 2001/06/28 22:25:14 $
@


1.6
log
@Update to sendmail 8.11.4:
    8.11.4 revamps signal handling within the MTA in order to reduce
    the likelihood of a race condition that can lead to heap
    corruption as described in Michal Zalewski's advisory.  The
    problems discussed in the advisory are not currently known to
    be exploitable but we recommend upgrading to 8.11.4 in case a
    method is found to exploit the signal handling race condition.
    8.11.4 also fixes other bugs found since the release of 8.11.3.

See the RELEASE_NOTES file for more details.
@
text
@d62 1
a62 1
	Xfilter2, S=inet6:999@@localhost, F=T, T=S:1s;R:1s;E:5m
d69 1
a69 1
	INPUT_MAIL_FILTER(`filter2', `S=inet6:999@@localhost, F=T, T=S:1s;R:1s;E:5m')
d83 1
a83 1
talking to the filters using the T= equate.  There are three fields inside
d87 5
a91 4
  S             Timeout for sending information from the MTA to a filter
  R             Timeout for reading reply from the filter
  E             Overall timeout between sending end-of-message to filter
                and waiting for the final acknowledgment
d94 2
a95 1
and therefore can't separate timeouts.  The default values (if not set in the config) are:
d97 1
a97 1
T=S:10s;R:10s;E:5m
d429 1
a429 1
$Revision: 1.5 $, Last updated $Date: 2001/02/28 02:43:51 $
@


1.5
log
@Update to sendmail 8.11.3.  This is a maintenance release which
contains bug fixes for problems found after 8.11.2 was released.
Systems which use buffered file I/O (like OpenBSD) were not properly
fsync()'ing the data (df) file.  Although there is little chance
of data loss, this is an important fix.
@
text
@d13 1
a13 1
Future Release).  If you intend to use them in 8.10.X, you must compiled
d100 2
a101 1
InputMailFilters option.
d227 1
a227 1
	int fd;
d248 2
d427 1
a427 1
$Revision: 1.4 $, Last updated $Date: 2001/01/15 21:09:02 $
@


1.5.2.1
log
@Pull in patch from current:
Fix (millert), Errata 001:
Update to sendmail 8.11.4:
    8.11.4 revamps signal handling within the MTA in order to reduce
    the likelihood of a race condition that can lead to heap
    corruption as described in Michal Zalewski's advisory.  The
    problems discussed in the advisory are not currently known to
    be exploitable but we recommend upgrading to 8.11.4 in case a
    method is found to exploit the signal handling race condition.
    8.11.4 also fixes other bugs found since the release of 8.11.3.

See the RELEASE_NOTES file for more details.
@
text
@d13 1
a13 1
Future Release).  If you intend to use them in 8.11.X, you must compiled
d100 1
a100 2
InputMailFilters option. Note: if InputMailFilters is not defined no filters
will be used.
d226 1
a226 1
	int fd = -1;
a246 2
		if (fd >= 0)
			(void) close(fd);
d424 1
a424 1
$Revision: 1.6 $, Last updated $Date: 2001/05/29 01:31:12 $
@


1.4
log
@sendmail 8.11.2 with BSD Makefiles
@
text
@d47 5
d424 1
a424 1
$Revision: 8.9.2.1.2.13 $, Last updated $Date: 2000/12/29 18:55:23 $
@


1.3
log
@Update to sendmail-8.10.1
@
text
@d21 3
d38 2
a39 1
-lsocket -lnsl'.
d56 1
a56 1
	Xfilter1, S=unix:/var/run/f1.sock, F=R
d63 1
a63 1
	INPUT_MAIL_FILTER(`filter1', `S=unix:/var/run/f1.sock, F=R')
d74 3
d94 11
a104 7
Actual sequencing is handled by the InputMailFilters option which is set
automatically according to the order of the INPUT_MAIL_FILTER commands
in your .mc file.  Alternatively, you can reset it's value by setting
confINPUT_MAIL_FILTERS in your .mc file.  This options causes the three
filters to be called in the same order they were specified.  It allows
for possible future filtering on output (although this is not intended
for this release).
d113 1
a113 1
	INPUT_MAIL_FILTER(`sample', `S=unix:/var/run/f1.sock')
d129 1
a129 1
	% ./sample -p unix:/var/run/f1.sock
d144 1
a144 1
220 test.sendmail.com ESMTP Sendmail 8.10.0.Beta8/8.10.0.Beta8; Mon, 6 Dec 1999 19:34:23 -0800 (PST)
d181 4
d187 7
d196 9
d370 1
a370 1
	SMFIF_MODHDRS,	/* flags */
d389 1
a389 1
	char c;
d419 1
a419 1
$Revision: 1.2 $, Last updated $Date: 2000/04/02 19:48:31 $
@


1.3.4.1
log
@Pull in patch from current:
Errata(028):
The signal handlers in sendmail contain code that is unsafe in the
context of a signal handler.  This leads to potentially serious race
conditions.  At the moment this is a theoretical attack only and can
only be exploited on the local host (if at all).
Fix(millert):
Update to sendmail 8.11.4:
8.11.4 revamps signal handling within the MTA in order to reduce
the likelihood of a race condition that can lead to heap
corruption as described in Michal Zalewski's advisory.  The
problems discussed in the advisory are not currently known to
be exploitable but we recommend upgrading to 8.11.4 in case a
method is found to exploit the signal handling race condition.
8.11.4 also fixes other bugs found since the release of 8.11.3.

See the RELEASE_NOTES file for more details.
@
text
@d13 1
a13 1
Future Release).  If you intend to use them in 8.11.X, you must compiled
a20 3
You will also need to define _FFR_MILTER when building your .cf file using
m4.

d35 1
a35 2
-lsocket -lnsl'.  Depending on your OS you may need a library instead
of the option -pthread, e.g., -lpthread.
a42 5
Note that since filters use threads, it may be necessary to alter per
process limits in your filter.  For example, you might look at using
setrlimit() to increase the number of open file descriptors if your filter
is going to be busy.

d52 1
a52 1
	Xfilter1, S=local:/var/run/f1.sock, F=R
d59 1
a59 1
	INPUT_MAIL_FILTER(`filter1', `S=local:/var/run/f1.sock, F=R')
a69 3
If neither F=R nor F=T is specified, the message is passed through sendmail
as if the filter were not present.

d87 7
a93 12
Which filters are invoked and their sequencing is handled by the 
InputMailFilters option. Note: if InputMailFilters is not defined no filters
will be used.

	O InputMailFilters=filter1, filter2, filter3

This is is set automatically according to the order of the
INPUT_MAIL_FILTER commands in your .mc file.  Alternatively, you can
reset its value by setting confINPUT_MAIL_FILTERS in your .mc file.
This options causes the three filters to be called in the same order
they were specified.  It allows for possible future filtering on output
(although this is not intended for this release).
d102 1
a102 1
	INPUT_MAIL_FILTER(`sample', `S=local:/var/run/f1.sock')
d118 1
a118 1
	% ./sample -p local:/var/run/f1.sock
d133 1
a133 1
220 test.sendmail.com ESMTP Sendmail 8.11.0/8.11.0; Tue, 10 Nov 1970 13:05:23 -0500 (EST)
a169 4
Note that the filter below may not be thread safe on some operating
systems.  You should check your system man pages for the functions used
below to verify the functions are thread safe.

a171 7
#include <sys/types.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sysexits.h>
#include <unistd.h>

a173 9
typedef int bool;

#ifndef FALSE
# define FALSE	0
#endif /* ! FALSE*/
#ifndef TRUE
# define TRUE	1
#endif /* ! TRUE*/

d190 1
a190 1
	int fd = -1;
a210 2
		if (fd >= 0)
			(void) close(fd);
d339 1
a339 1
	SMFIF_ADDHDRS,	/* flags */
d358 1
a358 1
	int c;
d388 1
a388 1
$Revision: 1.6 $, Last updated $Date: 2001/05/29 01:31:12 $
@


1.2
log
@Remove sendmail's `Build' scaffolding and add real Makefiles
praliases should be in section 1, not 8
Use arc4random(3) instead of random(3)
Add some sample OpenBSD .mc files
@
text
@d12 8
d29 1
a29 1
	cc -I../../sendmail -I../../include -o sample sample.c -L. -lmilter -pthread
d33 3
a35 1
and linker library locations (-L) accordingly.
d187 1
a187 1
	char *envfrom;
d227 1
a227 1
	u_char *headerv;
d230 1
a230 1
	fprintf(MLFIPRIV->mlfi_fp, "%s: %s\n", headerf, headerv);
d241 1
a241 1
	fprintf(MLFIPRIV->mlfi_fp, "\n");
d388 1
a388 1
$Revision: 8.6 $, Last updated $Date: 2000/02/11 02:39:09 $
@


1.1
log
@Initial revision
@
text
@@


1.1.1.1
log
@stock sendmail 8.10.0 with $Id -> $Sendmail
@
text
@@


1.1.1.2
log
@sendmail 8.11.2
@
text
@a11 11
NOTE: Both libmilter and the callouts in sendmail are marked as an FFR (For
Future Release).  If you intend to use them in 8.10.X, you must compiled
both libmilter and sendmail with -D_FFR_MILTER defined.  You can do this by
adding the following to your devtools/Site/site.config.m4 file:

	dnl Milter
	APPENDDEF(`conf_sendmail_ENVDEF', `-D_FFR_MILTER=1')
	APPENDDEF(`conf_libmilter_ENVDEF', `-D_FFR_MILTER=1') 

You will also need to define _FFR_MILTER when building your .cf file using
m4.
d21 1
a21 1
	cc -I../../sendmail -I../../include -o sample sample.c libmilter.a ../libsmutil/libsmutil.a -pthread
d25 1
a25 4
and the library locations accordingly.  Also, some operating systems may
require additional libraries.  For example, SunOS 5.X requires '-lresolv
-lsocket -lnsl'.  Depending on your OS you may need a library instead
of the option -pthread, e.g., -lpthread.
d42 1
a42 1
	Xfilter1, S=local:/var/run/f1.sock, F=R
d49 1
a49 1
	INPUT_MAIL_FILTER(`filter1', `S=local:/var/run/f1.sock, F=R')
a59 3
If neither F=R nor F=T is specified, the message is passed through sendmail
as if the filter were not present.

d77 7
a83 11
Which filters are invoked and their sequencing is handled by the 
InputMailFilters option.

	O InputMailFilters=filter1, filter2, filter3

This is is set automatically according to the order of the
INPUT_MAIL_FILTER commands in your .mc file.  Alternatively, you can
reset its value by setting confINPUT_MAIL_FILTERS in your .mc file.
This options causes the three filters to be called in the same order
they were specified.  It allows for possible future filtering on output
(although this is not intended for this release).
d92 1
a92 1
	INPUT_MAIL_FILTER(`sample', `S=local:/var/run/f1.sock')
d108 1
a108 1
	% ./sample -p local:/var/run/f1.sock
d123 1
a123 1
220 test.sendmail.com ESMTP Sendmail 8.11.0/8.11.0; Tue, 10 Nov 1970 13:05:23 -0500 (EST)
a159 4
Note that the filter below may not be thread safe on some operating
systems.  You should check your system man pages for the functions used
below to verify the functions are thread safe.

a161 7
#include <sys/types.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sysexits.h>
#include <unistd.h>

a163 9
typedef int bool;

#ifndef FALSE
# define FALSE	0
#endif /* ! FALSE*/
#ifndef TRUE
# define TRUE	1
#endif /* ! TRUE*/

d177 1
a177 1
	char **envfrom;
d217 1
a217 1
	char *headerv;
d220 1
a220 1
	fprintf(MLFIPRIV->mlfi_fp, "%s: %s\r\n", headerf, headerv);
d231 1
a231 1
	fprintf(MLFIPRIV->mlfi_fp, "\r\n");
d329 1
a329 1
	SMFIF_ADDHDRS,	/* flags */
d348 1
a348 1
	int c;
d378 1
a378 1
$Revision: 8.9.2.1.2.13 $, Last updated $Date: 2000/12/29 18:55:23 $
@


1.1.1.3
log
@sendmail 8.12.0 with $Id tags converted to $Sendmail
@
text
@d12 8
a19 3
NOTE: If you intend to use filters in sendmail, you must compile sendmail
with -DMILTER defined.  You can do this by adding the following to
your devtools/Site/site.config.m4 file:
d21 2
a22 1
	APPENDDEF(`conf_sendmail_ENVDEF', `-DMILTER')
d32 1
a32 1
	cc -I../../sendmail -I../../include -o sample sample.c libmilter.a ../libsm/libsm.a -pthread
d38 2
a39 2
-lsocket -lnsl'.  Depending on your operating system you may need a library
instead of the option -pthread, e.g., -lpthread.
a46 5
Note that since filters use threads, it may be necessary to alter per
process limits in your filter.  For example, you might look at using
setrlimit() to increase the number of open file descriptors if your filter
is going to be busy.

d57 1
a57 1
	Xfilter2, S=inet6:999@@localhost, F=T, T=C:10m;S:1s;R:1s;E:5m
d64 1
a64 1
	INPUT_MAIL_FILTER(`filter2', `S=inet6:999@@localhost, F=T, T=C:10m;S:1s;R:1s;E:5m')
d78 1
a78 1
talking to the filters using the T= equate.  There are four fields inside
d81 5
a85 6
Letter		Meaning
  C		Timeout for connecting to a filter (if 0, use system timeout)
  S		Timeout for sending information from the MTA to a filter
  R		Timeout for reading reply from the filter
  E		Overall timeout between sending end-of-message to filter
		and waiting for the final acknowledgment
d88 1
a88 2
and therefore can't separate timeouts.  The default values (if not set in
the config) are:
d90 1
a90 1
T=C:5m;S:10s;R:10s;E:5m
d95 1
a95 2
InputMailFilters option. Note: if InputMailFilters is not defined no filters
will be used.
a176 24
+--------------+
| REQUIREMENTS |
+--------------+

libmilter requires pthread support in the operating system.  Moreover, it
requires that the library functions it uses are thread safe; which is true
for the operating systems libmilter has been developed and tested on.  On
some operating systems this requires special compile time options (e.g.,
not just -pthread).  libmilter is currently known to work on (modulo problems
in the pthread support of some specific versions):

FreeBSD 3.x, 4.x
SunOS 5.x (x >= 5)
AIX 4.3.x
HP UX 11.x
Linux (recent versions/distributions)

libmilter is currently not supported on:

IRIX 6.x
Ultrix

Feedback about problems (and possible fixes) is welcome.

a195 1
#ifndef true
d197 7
a203 3
# define false	0
# define true	1
#endif /* ! true */
d221 1
a221 1
	int fd = -1;
a241 2
		if (fd >= 0)
			(void) close(fd);
d288 1
a288 1
		(void) mlfi_cleanup(ctx, false);
d300 1
a300 1
	return mlfi_cleanup(ctx, true);
d314 1
a314 1
	return mlfi_cleanup(ctx, false);
d342 1
a342 1
			snprintf(host, sizeof host, "localhost");
d419 1
a419 1
$Revision: 8.33 $, Last updated $Date: 2001/07/19 21:18:14 $
@


