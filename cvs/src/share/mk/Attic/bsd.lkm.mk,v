head	1.26;
access;
symbols
	OPENBSD_5_6:1.25.0.6
	OPENBSD_5_6_BASE:1.25
	OPENBSD_5_5:1.25.0.4
	OPENBSD_5_5_BASE:1.25
	OPENBSD_5_4:1.24.0.2
	OPENBSD_5_4_BASE:1.24
	OPENBSD_5_3:1.23.0.4
	OPENBSD_5_3_BASE:1.23
	OPENBSD_5_2:1.23.0.2
	OPENBSD_5_2_BASE:1.23
	OPENBSD_5_1_BASE:1.22
	OPENBSD_5_1:1.22.0.4
	OPENBSD_5_0:1.22.0.2
	OPENBSD_5_0_BASE:1.22
	OPENBSD_4_9:1.21.0.14
	OPENBSD_4_9_BASE:1.21
	OPENBSD_4_8:1.21.0.12
	OPENBSD_4_8_BASE:1.21
	OPENBSD_4_7:1.21.0.8
	OPENBSD_4_7_BASE:1.21
	OPENBSD_4_6:1.21.0.10
	OPENBSD_4_6_BASE:1.21
	OPENBSD_4_5:1.21.0.6
	OPENBSD_4_5_BASE:1.21
	OPENBSD_4_4:1.21.0.4
	OPENBSD_4_4_BASE:1.21
	OPENBSD_4_3:1.21.0.2
	OPENBSD_4_3_BASE:1.21
	OPENBSD_4_2:1.20.0.8
	OPENBSD_4_2_BASE:1.20
	OPENBSD_4_1:1.20.0.6
	OPENBSD_4_1_BASE:1.20
	OPENBSD_4_0:1.20.0.4
	OPENBSD_4_0_BASE:1.20
	OPENBSD_3_9:1.20.0.2
	OPENBSD_3_9_BASE:1.20
	OPENBSD_3_8:1.19.0.10
	OPENBSD_3_8_BASE:1.19
	OPENBSD_3_7:1.19.0.8
	OPENBSD_3_7_BASE:1.19
	OPENBSD_3_6:1.19.0.6
	OPENBSD_3_6_BASE:1.19
	OPENBSD_3_5:1.19.0.4
	OPENBSD_3_5_BASE:1.19
	OPENBSD_3_4:1.19.0.2
	OPENBSD_3_4_BASE:1.19
	OPENBSD_3_3:1.18.0.2
	OPENBSD_3_3_BASE:1.18
	OPENBSD_3_2:1.17.0.6
	OPENBSD_3_2_BASE:1.17
	OPENBSD_3_1:1.17.0.4
	OPENBSD_3_1_BASE:1.17
	OPENBSD_3_0:1.17.0.2
	OPENBSD_3_0_BASE:1.17
	OPENBSD_2_9:1.16.0.2
	OPENBSD_2_9_BASE:1.16
	OPENBSD_2_8:1.15.0.2
	OPENBSD_2_8_BASE:1.15
	OPENBSD_2_7:1.14.0.6
	OPENBSD_2_7_BASE:1.14
	OPENBSD_2_6:1.14.0.4
	OPENBSD_2_6_BASE:1.14
	OPENBSD_2_5:1.14.0.2
	OPENBSD_2_5_BASE:1.14
	OPENBSD_2_4:1.12.0.8
	OPENBSD_2_4_BASE:1.12
	OPENBSD_2_3:1.12.0.6
	OPENBSD_2_3_BASE:1.12
	OPENBSD_2_2:1.12.0.4
	OPENBSD_2_2_BASE:1.12
	OPENBSD_2_1:1.12.0.2
	OPENBSD_2_1_BASE:1.12
	OPENBSD_2_0:1.9.0.2
	OPENBSD_2_0_BASE:1.9;
locks; strict;
comment	@# @;


1.26
date	2014.10.09.04.44.09;	author tedu;	state dead;
branches;
next	1.25;
commitid	fIvQzqJlAnvj9ktq;

1.25
date	2013.10.15.22.40.00;	author deraadt;	state Exp;
branches;
next	1.24;

1.24
date	2013.03.14.12.56.58;	author mikeb;	state Exp;
branches;
next	1.23;

1.23
date	2012.04.08.15.56.28;	author jsg;	state Exp;
branches;
next	1.22;

1.22
date	2011.07.16.23.34.21;	author guenther;	state Exp;
branches;
next	1.21;

1.21
date	2007.11.04.00.06.19;	author mikeb;	state Exp;
branches;
next	1.20;

1.20
date	2005.09.15.07.12.18;	author espie;	state Exp;
branches;
next	1.19;

1.19
date	2003.05.20.22.49.13;	author millert;	state Exp;
branches;
next	1.18;

1.18
date	2003.03.04.22.30.37;	author mickey;	state Exp;
branches;
next	1.17;

1.17
date	2001.07.18.13.23.03;	author espie;	state Exp;
branches;
next	1.16;

1.16
date	2001.04.03.23.00.09;	author espie;	state Exp;
branches;
next	1.15;

1.15
date	2000.06.18.23.21.47;	author assar;	state Exp;
branches;
next	1.14;

1.14
date	98.12.31.23.49.45;	author millert;	state Exp;
branches;
next	1.13;

1.13
date	98.12.19.19.07.33;	author millert;	state Exp;
branches;
next	1.12;

1.12
date	97.04.27.21.38.29;	author millert;	state Exp;
branches;
next	1.11;

1.11
date	96.12.08.14.42.29;	author downsj;	state Exp;
branches;
next	1.10;

1.10
date	96.11.14.14.21.22;	author mickey;	state Exp;
branches;
next	1.9;

1.9
date	96.08.01.11.35.45;	author niklas;	state Exp;
branches;
next	1.8;

1.8
date	96.08.01.10.17.53;	author niklas;	state Exp;
branches;
next	1.7;

1.7
date	96.06.03.04.01.15;	author mickey;	state Exp;
branches;
next	1.6;

1.6
date	96.05.27.08.20.11;	author tholo;	state Exp;
branches;
next	1.5;

1.5
date	96.04.18.11.21.03;	author mickey;	state Exp;
branches;
next	1.4;

1.4
date	96.04.18.11.11.07;	author mickey;	state Exp;
branches;
next	1.3;

1.3
date	96.03.05.11.12.45;	author mickey;	state Exp;
branches;
next	1.2;

1.2
date	96.03.02.21.01.23;	author tholo;	state Exp;
branches;
next	1.1;

1.1
date	96.02.25.19.02.33;	author mickey;	state Exp;
branches;
next	;


desc
@@


1.26
log
@no more lkm
@
text
@#	$OpenBSD: bsd.lkm.mk,v 1.25 2013/10/15 22:40:00 deraadt Exp $

.if exists(${.CURDIR}/../Makefile.inc)
.include "${.CURDIR}/../Makefile.inc"
.endif

.include <bsd.own.mk>

.SUFFIXES: .out .o .c .cc .C .y .l .s .8 .7 .6 .5 .4 .3 .2 .1 .0

# XXX In order to at least diminish the brokenness of trusting /sys to point
# to the tree we're actually belonging to we check BSDSRCDIR.  On multi-tree
# machines /sys isn't always a link to the correct tree.
.if defined(BSDSRCDIR)
CFLAGS+=	${COPTS} -D_KERNEL -D_LKM -I${BSDSRCDIR}/sys -I${BSDSRCDIR}/sys/arch
.else
CFLAGS+=	${COPTS} -D_KERNEL -D_LKM -I/sys -I/sys/arch
.endif
.if ${WARNINGS:L} == "yes"
CFLAGS+=	${CDIAGFLAGS}
.endif

.if ${MACHINE} == "amd64"
CFLAGS+=	-mcmodel=kernel
.endif

CFLAGS+=	${NOPIE_FLAGS}
AFLAGS+=	${NOPIE_FLAGS}
LDFLAGS+=	${NOPIE_LDFLAGS}

LDFLAGS+= -r
.if defined(LKM)
SRCS?=	${LKM}.c
.if !empty(SRCS:N*.h:N*.sh)
OBJS+=	${SRCS:N*.h:N*.sh:R:S/$/.o/}
.endif
COMBINED?=combined.o
.if !defined(POSTINSTALL)
POSTINSTALL= ${LKM}install
.endif

.if defined(OBJS) && !empty(OBJS)

${COMBINED}: ${OBJS} ${DPADD}
	${LD} ${LDFLAGS} -o ${.TARGET} ${OBJS} ${LDADD}

.endif	# defined(OBJS) && !empty(OBJS)

.if	!defined(MAN)
MAN=	${LKM}.1
.endif	# !defined(MAN)
.endif	# defined(LKM)

.MAIN: all
all: ${COMBINED} _SUBDIRUSE

.if !target(clean)
clean: _SUBDIRUSE
	rm -f a.out [Ee]rrs mklog *.core \
	    ${LKM} ${COMBINED} ${OBJS} ${CLEANFILES}
.endif

cleandir: _SUBDIRUSE clean

.if !target(install)
.if !target(beforeinstall)
beforeinstall:
.endif
.if !target(afterinstall)
afterinstall:
.endif

.if !target(realinstall)
realinstall:
.if defined(LKM)
	${INSTALL} ${INSTALL_COPY} -o ${LKMOWN} -g ${LKMGRP} -m ${LKMMODE} \
	    ${COMBINED} ${DESTDIR}${LKMDIR}/${LKM}.o
.if exists(${.CURDIR}/${POSTINSTALL})
	${INSTALL} ${INSTALL_COPY} -o ${LKMOWN} -g ${LKMGRP} -m 555 \
	    ${.CURDIR}/${POSTINSTALL} ${DESTDIR}${LKMDIR}
.endif
.endif
.if defined(LINKS) && !empty(LINKS)
.  for lnk file in ${LINKS}
	@@l=${DESTDIR}${LKMDIR}${lnk}; \
	 t=${DESTDIR}${LKMDIR}${file}; \
	 echo $$t -\> $$l; \
	 rm -f $$t; ln $$l $$t
.  endfor
.endif
.endif


load:	${COMBINED}
	if [ -x ${.CURDIR}/${POSTINSTALL} ]; then \
		modload -d -o ${LKM} -e${LKM}_lkmentry \
		    -p${.CURDIR}/${POSTINSTALL} ${COMBINED}; \
	else \
		modload -d -o ${LKM} -e${LKM}_lkmentry ${COMBINED}; \
	fi

unload:
	modunload -n ${LKM}

install: maninstall _SUBDIRUSE

maninstall: afterinstall
afterinstall: realinstall
realinstall: beforeinstall
.endif

.if !defined(NOMAN)
.include <bsd.man.mk>
.endif

.if !defined(NONLS)
.include <bsd.nls.mk>
.endif

.include <bsd.obj.mk>
.include <bsd.dep.mk>
.include <bsd.subdir.mk>
.include <bsd.sys.mk>

.PHONY: load unload
@


1.25
log
@We do not produce "core" files, so they do not need to be deleted.  they
have been *.core files for a very long time.  That's a lot of unlink()
calls saved.
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.24 2013/03/14 12:56:58 mikeb Exp $
@


1.24
log
@disable pie for kernel modules; from dinar talypov, ok deraadt, pascal
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.23 2012/04/08 15:56:28 jsg Exp $
d59 1
a59 1
	rm -f a.out [Ee]rrs mklog core *.core \
@


1.23
log
@unhook lint from the tree.  The parser is incomplete and difficult
to fix and there are several alternatives that don't tell quite so many
dangerous lies.

enthusiastic agreement from a bunch of people
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.22 2011/07/16 23:34:21 guenther Exp $
d26 4
@


1.22
log
@The /g flag is unneeded when the pattern in ${var:S/pattern/sub/g} can
only match once per word, such as when it's anchored with '$'

ok espie@@
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.21 2007/11/04 00:06:19 mikeb Exp $
a31 1
LOBJS+=	${LSRCS:.c=.ln} ${SRCS:M*.c:.c=.ln}
d56 1
a56 1
	    ${LKM} ${COMBINED} ${OBJS} ${LOBJS} ${CLEANFILES}
a105 7
.endif

.if !target(lint)
lint: ${LOBJS}
.if defined(LOBJS) && !empty(LOBJS)
	@@${LINT} ${LINTFLAGS} ${LDFLAGS:M-L*} ${LOBJS} ${LDADD}
.endif
@


1.21
log
@Always compile modules with -mcmodel=kernel on amd64.
Fix parentheses while here.

Reminded by deraadt@@
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.20 2005/09/15 07:12:18 espie Exp $
d31 1
a31 1
OBJS+=	${SRCS:N*.h:N*.sh:R:S/$/.o/g}
@


1.20
log
@uniformize LINKS, so that it gets handled in realinstall all the time
(and the same way).

okay otto@@
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.19 2003/05/20 22:49:13 millert Exp $
d23 4
d93 2
a94 1
		modload -d -o $(LKM) -e$(LKM) -p${.CURDIR}/${POSTINSTALL} $(COMBINED); \
d96 1
a96 1
		modload -d -o $(LKM) -e$(LKM) $(COMBINED); \
d100 1
a100 1
	modunload -n $(LKM)
@


1.19
log
@Modules should build w/ propolice now; noticed by Jan Johansson
deraadt@@ OK
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.18 2003/03/04 22:30:37 mickey Exp $
d76 8
a97 12
.if defined(LINKS) && !empty(LINKS)
	@@set ${LINKS}; \
	while test $$# -ge 2; do \
		l=${DESTDIR}${LKMDIR}/$$1; \
		shift; \
		t=${DESTDIR}${LKMDIR}/$$1; \
		shift; \
		echo $$t -\> $$l; \
		rm -f $$t; \
		ln $$l $$t; \
	done; true
.endif
@


1.18
log
@need to disable pp for lkm too; from lha@@stacken.kth.se
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.17 2001/07/18 13:23:03 espie Exp $
a21 1
CFLAGS+=	-fno-stack-protector 
@


1.17
log
@CDIAGFLAGS, added to CFLAGS if WARNINGS=Yes
Symetrize C++ situation: add CXXOPTS, CXXDIAGFLAGS.
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.16 2001/04/03 23:00:09 espie Exp $
d22 1
@


1.16
log
@Minor clean-ups:
- document some more things (MANPS, make oddities)
- put all PHONY targets in bsd.own.mk, since it's included by everything
that uses it.
- remove them from bsd.lib.mk, since it includes bsd.own.mk.
- ... except for load/unload, which are only in bsd.lkm.mk.
- fix spell target, so that it actually depends on the generated file.

okay niklas@@
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.15 2000/06/18 23:21:47 assar Exp $
d18 3
@


1.15
log
@(CFLAGS): add _LKM so kernel header files behave nicely.
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.14 1998/12/31 23:49:45 millert Exp $
d124 2
@


1.14
log
@Add ${PIPE} in sys.mk so we do no need to add all over the places; evanc@@concer.to
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.13 1998/12/19 19:07:33 millert Exp $
d15 1
a15 1
CFLAGS+=	${COPTS} -D_KERNEL -I${BSDSRCDIR}/sys -I${BSDSRCDIR}/sys/arch
d17 1
a17 1
CFLAGS+=	${COPTS} -D_KERNEL -I/sys -I/sys/arch
@


1.13
log
@add PIPE variable, suitable for /etc/mk.conf, to enable gcc -pipe mode
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.12 1997/04/27 21:38:29 millert Exp $
d15 1
a15 1
CFLAGS+=	${COPTS} ${PIPE} -D_KERNEL -I${BSDSRCDIR}/sys -I${BSDSRCDIR}/sys/arch
d17 1
a17 1
CFLAGS+=	${COPTS} ${PIPE} -D_KERNEL -I/sys -I/sys/arch
@


1.12
log
@COPY -> INSTALL_COPY and STRIP -> INSTALL_STRIP changes.
For some reason the previous commit did not grab these.
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.11 1996/12/08 14:42:29 downsj Exp $
d15 1
a15 1
CFLAGS+=	${COPTS} -D_KERNEL -I${BSDSRCDIR}/sys -I${BSDSRCDIR}/sys/arch
d17 1
a17 1
CFLAGS+=	${COPTS} -D_KERNEL -I/sys -I/sys/arch
@


1.11
log
@install -> ${INSTALL}, -c -> ${COPY}
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.10 1996/11/14 14:21:22 mickey Exp $
d66 1
a66 1
	${INSTALL} ${COPY} -o ${LKMOWN} -g ${LKMGRP} -m ${LKMMODE} \
d69 1
a69 1
	${INSTALL} ${COPY} -o ${LKMOWN} -g ${LKMGRP} -m 555 \
@


1.10
log
@correct LINKS usage
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.9 1996/08/01 11:35:45 niklas Exp $
d66 1
a66 1
	install ${COPY} -o ${LKMOWN} -g ${LKMGRP} -m ${LKMMODE} \
d69 2
a70 2
	install -c -o ${LKMOWN} -g ${LKMGRP} -m 555 ${.CURDIR}/${POSTINSTALL} \
	    ${DESTDIR}${LKMDIR}
@


1.9
log
@Comment my recent change
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.8 1996/08/01 10:17:53 niklas Exp $
d90 1
a90 1
		l=${DESTDIR}$$1; \
d92 1
a92 1
		t=${DESTDIR}$$1; \
@


1.8
log
@Support BSDSRCDIR setups
@
text
@d1 1
a1 2
#	$OpenBSD: bsd.lkm.mk,v 1.7 1996/06/03 04:01:15 mickey Exp $
#	from @@(#)bsd.prog.mk	5.26 (Berkeley) 6/25/91
d11 3
@


1.7
log
@always instal ${POSTINSTALL} program, if there is one.
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.6 1996/05/27 08:20:11 tholo Exp $
d12 3
d16 1
@


1.6
log
@Stripping lkm's on install is a bad idea.  Don't do it.
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.3 1996/03/05 11:12:45 mickey Exp $
d62 4
@


1.5
log
@Revert last fix. a couple of hot mkdir,chmod,chown could
not replace good old mtree anyway.
@
text
@d60 1
a60 1
	install ${COPY} ${STRIP} -o ${LKMOWN} -g ${LKMGRP} -m ${LKMMODE} \
@


1.4
log
@Add ${LKMDIR} automatic creation (just in case mtree not ran).
@
text
@a51 1
	@@-[ -d ${DESTDIR}${LKMDIR} ] || mkdir ${DESTDIR}${LKMDIR}
@


1.3
log
@Labeling style changed ($OpenBSD$).
POSTINSTALL added to the <bsd.lkm.mk> (see bsd.README for details).
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.2 1996/03/02 21:01:23 tholo Exp $
d52 1
@


1.2
log
@Define directory and modes for LKM installs
Correct installation rule for LKM installs
@
text
@d1 2
a2 2
#	$OpenBSD: bsd.lkm.mk,v 1.1 1996/02/25 19:02:33 mickey Exp $
#	@@(#)bsd.prog.mk	5.26 (Berkeley) 6/25/91
d22 3
d67 5
a71 1
	modload -d -o $(LKM) -e$(LKM) $(COMBINED)
@


1.1
log
@Added <bsd.lkm.mk> file. Correspondent changes made to the bsd.README.
All the rest changed to be $OpenBSD$.
Dedicated to Suzi Quatro (she must be alive still, so best wishes to here).
@
text
@d1 1
a1 1
#	$OpenBSD: bsd.lkm.mk,v 1.1 1995/10/22 00:45:57 christos Exp $
d58 1
a58 1
	    ${LKM} ${DESTDIR}${BINDIR}
@
