head	1.15;
access;
symbols
	OPENBSD_6_2:1.15.0.2
	OPENBSD_6_2_BASE:1.15
	OPENBSD_6_1:1.11.0.4
	OPENBSD_6_1_BASE:1.11
	OPENBSD_6_0:1.9.0.4
	OPENBSD_6_0_BASE:1.9
	OPENBSD_5_9:1.9.0.2
	OPENBSD_5_9_BASE:1.9
	OPENBSD_5_8:1.8.0.4
	OPENBSD_5_8_BASE:1.8
	OPENBSD_5_7:1.7.0.4
	OPENBSD_5_7_BASE:1.7
	OPENBSD_5_6:1.7.0.8
	OPENBSD_5_6_BASE:1.7
	OPENBSD_5_5:1.7.0.6
	OPENBSD_5_5_BASE:1.7
	OPENBSD_5_4:1.7.0.2
	OPENBSD_5_4_BASE:1.7
	OPENBSD_5_3:1.5.0.24
	OPENBSD_5_3_BASE:1.5
	OPENBSD_5_2:1.5.0.22
	OPENBSD_5_2_BASE:1.5
	OPENBSD_5_1_BASE:1.5
	OPENBSD_5_1:1.5.0.20
	OPENBSD_5_0:1.5.0.18
	OPENBSD_5_0_BASE:1.5
	OPENBSD_4_9:1.5.0.16
	OPENBSD_4_9_BASE:1.5
	OPENBSD_4_8:1.5.0.14
	OPENBSD_4_8_BASE:1.5
	OPENBSD_4_7:1.5.0.10
	OPENBSD_4_7_BASE:1.5
	OPENBSD_4_6:1.5.0.12
	OPENBSD_4_6_BASE:1.5
	OPENBSD_4_5:1.5.0.8
	OPENBSD_4_5_BASE:1.5
	OPENBSD_4_4:1.5.0.6
	OPENBSD_4_4_BASE:1.5
	OPENBSD_4_3:1.5.0.4
	OPENBSD_4_3_BASE:1.5
	OPENBSD_4_2:1.5.0.2
	OPENBSD_4_2_BASE:1.5
	OPENBSD_4_1:1.4.0.16
	OPENBSD_4_1_BASE:1.4
	OPENBSD_4_0:1.4.0.14
	OPENBSD_4_0_BASE:1.4
	OPENBSD_3_9:1.4.0.12
	OPENBSD_3_9_BASE:1.4
	OPENBSD_3_8:1.4.0.10
	OPENBSD_3_8_BASE:1.4
	OPENBSD_3_7:1.4.0.8
	OPENBSD_3_7_BASE:1.4
	OPENBSD_3_6:1.4.0.6
	OPENBSD_3_6_BASE:1.4
	OPENBSD_3_5:1.4.0.4
	OPENBSD_3_5_BASE:1.4
	OPENBSD_3_4:1.4.0.2
	OPENBSD_3_4_BASE:1.4
	OPENBSD_3_3:1.3.0.4
	OPENBSD_3_3_BASE:1.3
	OPENBSD_3_2:1.3.0.2
	OPENBSD_3_2_BASE:1.3;
locks; strict;
comment	@.\" @;


1.15
date	2017.08.11.16.51.50;	author rob;	state Exp;
branches;
next	1.14;
commitid	1RYmAZBtbpS6IqlA;

1.14
date	2017.07.03.18.19.55;	author bluhm;	state Exp;
branches;
next	1.13;
commitid	DBhhLSUFgUy3oGv6;

1.13
date	2017.05.30.12.14.38;	author jmc;	state Exp;
branches;
next	1.12;
commitid	RvWURNG9iSpQN8HE;

1.12
date	2017.05.29.20.35.47;	author bluhm;	state Exp;
branches;
next	1.11;
commitid	IOfKUbwoaLf8KoZb;

1.11
date	2017.01.16.07.00.03;	author jmc;	state Exp;
branches;
next	1.10;
commitid	fQT0gGKvhIcPG4kh;

1.10
date	2017.01.15.22.41.50;	author bluhm;	state Exp;
branches;
next	1.9;
commitid	imYnLodpgUWcEeN0;

1.9
date	2015.09.23.01.11.13;	author schwarze;	state Exp;
branches;
next	1.8;
commitid	vsGAfUK2RNph2US5;

1.8
date	2015.07.30.08.03.50;	author jmc;	state Exp;
branches;
next	1.7;
commitid	jvvdSOl8gxNBg4aJ;

1.7
date	2013.06.17.11.57.10;	author schwarze;	state Exp;
branches;
next	1.6;

1.6
date	2013.06.14.22.38.50;	author halex;	state Exp;
branches;
next	1.5;

1.5
date	2007.05.31.19.19.58;	author jmc;	state Exp;
branches;
next	1.4;

1.4
date	2003.06.06.13.28.13;	author jmc;	state Exp;
branches;
next	1.3;

1.3
date	2002.09.02.19.56.55;	author avsm;	state Exp;
branches;
next	1.2;

1.2
date	2002.08.30.11.59.39;	author mpech;	state Exp;
branches;
next	1.1;

1.1
date	2002.08.26.22.12.11;	author avsm;	state Exp;
branches;
next	;


desc
@@


1.15
log
@Typo fix.

Ok benno@@, tb@@, tj@@, jmc@@, schwarze@@, phessler@@
@
text
@.\" $OpenBSD: bsd.regress.mk.5,v 1.14 2017/07/03 18:19:55 bluhm Exp $
.\"
.\" Copyright (c) 2002 Anil Madhavapeddy
.\" Copyright (c) 2000 Marc Espie
.\"
.\" All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE DEVELOPERS ``AS IS'' AND ANY EXPRESS OR
.\" IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
.\" OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
.\" IN NO EVENT SHALL THE DEVELOPERS BE LIABLE FOR ANY DIRECT, INDIRECT,
.\" INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
.\" NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
.\" DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
.\" THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
.\" (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
.\" THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
.\"
.Dd $Mdocdate: July 3 2017 $
.Dt BSD.REGRESS.MK 5
.Os
.Sh NAME
.Nm bsd.regress.mk
.Nd regression test master Makefile fragment
.Sh SYNOPSIS
.Fd .include <bsd.regress.mk>
.Sh DESCRIPTION
.Nm
holds the standard routines used by the source regression tests.
Some variables and targets are for its internal use only.
The rest are documented here.
.Pp
Since this file also includes
.Nm bsd.prog.mk ,
all of the usual
.Ox
Makefile variables may be used to build the regression
test programs.
.Sh TARGETS
.Bl -tag -width regress
.It Cm depend
Build any dependencies required to carry out the current set
of regression tests.
.It Cm regress
Executes all of the regression targets defined in the Makefile.
If one of the tests fails, the line
.Qq FAILED
is printed to the standard output.
By default, execution continues with the next test and, after running
all the tests,
.Sy make Cm regress
exits with an exit status of 0 even if some of the tests failed.
.It Cm run-regress-*
Runs an individual regression test.
If the exit status of the program indicates an error or timeout,
then a failure is logged, otherwise the test is marked as a success.
.El
.Sh VARIABLES
.Bl -tag -width Ds
.It Ev REGRESS_FAIL_EARLY
If this variable is set to anything but
.Dq no ,
the
.Cm regress
target will abort as soon as a test fails.
.It Ev REGRESS_LOG
Points to the fully-qualified path of a file to which regression
results are appended.
Defaults to
.Pa /dev/null .
.It Ev REGRESS_MAXTIME
Maximum limit of CPU seconds to spend on the regression test.
Exceeding this time will result in a failure being logged.
.It Ev REGRESS_ROOT_TARGETS
Targets for which root access is required to run the test.
The
.Ev SUDO
variable is invoked for these targets.
See also
.Ev SUDO .
.It Ev REGRESS_SKIP_SLOW
If this variable is not empty, skip over all the regression
tests which have been marked as being 'slow' using the
.Ev REGRESS_SLOW_TARGETS
variable.
.It Ev REGRESS_SLOW_TARGETS
Targets which are defined as 'slow'.
All of these tests can be skipped by setting the
.Ev REGRESS_SKIP_SLOW
variable.
.It Ev REGRESS_TARGETS
Targets which are invoked to run the set of regression tests
for this Makefile.
Defaults to
.Cm run-regress-${PROG} .
.It Ev SUDO
Location of a command used to switch to root for certain
test targets which require it.
See
.Xr doas 1 .
.El
.Pp
Some variables are intended to be set at runtime in the environment
or in
.Xr mk.conf 5 ,
but not in the regress Makefile itself.
.Sh GUIDELINES
If an individual test passes,
.Sy make Ar testname
should return with an exit status of 0.
If it fails, it should return with a non-zero exit status.
.Pp
If a test cannot be executed because a package is not installed or
some environment variable is not set,
.Sy make Ar testname
should print
.Qq SKIPPED
to stdout and exit with status 0.
To skip everything, implement the
.Cm regress
target with a command that prints
.Qq SKIPPED .
.Pp
Some tests may require a special setup on the test machine that has
to be done manually before testing.
This requirement has to be documented in the Makefile or in a
.Pa README
file.
The test should find out whether the setup exists before running
and print
.Qq SKIPPED
and exit if it is missing.
.Pp
Tests should not fail because an intended feature has not been
implemented yet.
To avoid such false failures, a test should show the reason, print
.Qq DISABLED
to stdout and exit with status 0.
.Pp
Tests must be able to run with an
.Pa obj
directory.
In case the test is not linked to the build or the tester forgot
to run
.Sy make Cm obj
before, this directory or symlink may not exist.
Then the test should run anyway.
.Pp
Tests are executed with
.Sy make Cm regress ,
but running
.Sy make Cm all
or
.Sy make
should have the same effect.
Tests must be runnable by root, and may also succeed when run as a
regular user.
Tests must not assume they have a controlling tty,
to allow them to be run by
.Xr cron 8 .
An individual regress test may create a pseudo tty if it needs one.
.Pp
Tests should use the binaries installed and the kernel running on
the local system.
They may use environment variables to test alternative binaries or
remote kernels running on other machines.
In some cases a test may need binaries or libraries or object files
to be present in
.Pa /usr/obj/
that exist only after
.Sy make Cm build
was run in
.Pa /usr/src/ .
The test must not assume that they have already been built, but
should run
.Sy make
in the appropriate source directory as a dependency.
For missing generated source or header files a target called
.Sy make Cm generated
is common.
The
.Pa /usr/src/
tree can be found with a relative path or with the
.Ev BSDSRCDIR
variable.
.Sh SEE ALSO
.Xr bsd.port.mk 5
.Sh HISTORY
The regression system originally came from
.Nx ,
with many tests added by
.Ox
since.
The current Makefile framework was written by Artur Grabowski
and Marc Espie for
.Ox 3.1 .
.Sh BUGS AND LIMITATIONS
The build system is unable to distinguish between timeouts due to
.Ev REGRESS_MAXTIME
being exceeded, or a genuine failure occurring.
@


1.14
log
@Generate source and header files for regress on demand.
OK espie@@
@
text
@d1 1
a1 1
.\" $OpenBSD: bsd.regress.mk.5,v 1.13 2017/05/30 12:14:38 jmc Exp $
d28 1
a28 1
.Dd $Mdocdate: May 30 2017 $
d158 1
a158 1
Test are executed with
@


1.13
log
@tweak previous; ok bluhm
@
text
@d1 1
a1 1
.\" $OpenBSD: bsd.regress.mk.5,v 1.12 2017/05/29 20:35:47 bluhm Exp $
d28 1
a28 1
.Dd $Mdocdate: May 29 2017 $
d187 3
@


1.12
log
@Add more regress guidelines to bsd.regress.mk(5) man page.
input schwarze@@ jmc@@; OK henning@@ benno@@
@
text
@d1 1
a1 1
.\" $OpenBSD: bsd.regress.mk.5,v 1.11 2017/01/16 07:00:03 jmc Exp $
d28 1
a28 1
.Dd $Mdocdate: January 16 2017 $
d167 3
a169 3
To run tests automatically with
.Xr cron 8
they must not assume to have a controlling tty.
@


1.11
log
@tweak previous;
@
text
@d1 1
a1 1
.\" $OpenBSD: bsd.regress.mk.5,v 1.10 2017/01/15 22:41:50 bluhm Exp $
d28 1
a28 1
.Dd $Mdocdate: January 15 2017 $
a74 4
This variable is intended to be set at runtime in the environment
or in
.Pa /etc/mk.conf ,
but not in the test's Makefile itself.
d111 5
d133 10
d165 6
@


1.10
log
@Add some guidelines how to write regression tests to the bsd.regress.mk(5)
man page.  The goal is that all tests behave alike to make automatic
testing easy.
input and OK schwarze@@
@
text
@d1 1
a1 1
.\" $OpenBSD: bsd.regress.mk.5,v 1.9 2015/09/23 01:11:13 schwarze Exp $
d28 1
a28 1
.Dd $Mdocdate: September 23 2015 $
d58 1
a58 1
By default, execution continues with the next test, and after running
d116 1
a116 1
If an indivual test passes,
@


1.9
log
@Obviously, .Ar is the wrong macro for Makefile targets - .Ar is for
placeholders to be replaced by something else by the user.
As these are fixed strings passed on the make(1) command line, use .Cm.
Trim some excessive indentation while here.
@
text
@d1 1
a1 1
.\" $OpenBSD: bsd.regress.mk.5,v 1.8 2015/07/30 08:03:50 jmc Exp $
d28 1
a28 1
.Dd $Mdocdate: July 30 2015 $
d55 7
d75 4
d115 60
@


1.8
log
@switch references from sudo to doas;
ok deraadt
@
text
@d1 1
a1 1
.\" $OpenBSD: bsd.regress.mk.5,v 1.7 2013/06/17 11:57:10 schwarze Exp $
d28 1
a28 1
.Dd $Mdocdate: June 17 2013 $
d50 1
a50 1
.It Ar depend
d53 1
a53 1
.It Ar regress
d55 1
a55 1
.It Ar run-regress-*
d61 1
a61 1
.Bl -tag -width REGRESS_LOG
d66 1
a66 1
.Ar regress
d97 1
a97 1
.Ar run-regress-${PROG} .
@


1.7
log
@tweak previous: trim trailing whitespace
@
text
@d1 1
a1 1
.\" $OpenBSD: bsd.regress.mk.5,v 1.6 2013/06/14 22:38:50 halex Exp $
d28 1
a28 1
.Dd $Mdocdate: June 14 2013 $
d99 1
a99 1
Location of the sudo command, used to switch to root for certain
d101 2
@


1.6
log
@introduce REGRESS_FAIL_EARLY to stop regression tests at first
encountered failure

ok phessler@@ bluhm@@
@
text
@d1 1
a1 1
.\" $OpenBSD: bsd.regress.mk.5,v 1.5 2007/05/31 19:19:58 jmc Exp $
d28 1
a28 1
.Dd $Mdocdate: May 31 2007 $
d65 1
a65 1
the 
@


1.5
log
@convert to new .Dd format;
@
text
@d1 1
a1 1
.\" $OpenBSD: bsd.regress.mk.5,v 1.4 2003/06/06 13:28:13 jmc Exp $
d28 1
a28 1
.Dd $Mdocdate$
d62 6
@


1.4
log
@- section reorder
- macro fixes
- kill whitespace at EOL
@
text
@d1 1
a1 1
.\" $OpenBSD: bsd.regress.mk.5,v 1.3 2002/09/02 19:56:55 avsm Exp $
d28 1
a28 1
.Dd August 24, 2002
@


1.3
log
@- Precede internal bsd.regress.mk variables with a _
- Rename old variables to be easier to read, and deprecate old
variables.  The old variables will still work, but emit warnings.
- REGRESS_SKIP_SLOW only needs to be non-empty now, not explicitly
set to 'yes'
- REGRESS_LOG can contain more than one file to append results to
- ERRORS variable can be set in Makefile to emit warnings or indicate
fatal errors.
- Add REGRESS_MAIL variable which can be set to an email address to
send results to.  Currently this only works for a full regression
run, since art doesnt want partial run results
- sync bsd.regress.mk(5) with these changes

ok art@@ , also looked over by miod@@
@
text
@d1 1
a1 1
.\" $OpenBSD: bsd.regress.mk.5,v 1.2 2002/08/30 11:59:39 mpech Exp $
d59 1
a59 1
.El 
d78 1
a78 1
If this variable is not empty, skip over all the regression 
d84 2
a85 2
All of these tests can be skipped by setting the 
.Ev REGRESS_SKIP_SLOW 
d90 1
a90 1
Defaults to 
d96 2
a97 4
.Sh BUGS AND LIMITATIONS
The build system is unable to distinguish between timeouts due to 
.Ev REGRESS_MAXTIME
being exceeded, or a genuine failure occurring.
d102 1
a102 1
.Ox 
d105 1
a105 1
and Marc Espie for 
d107 4
a110 2
.Sh SEE ALSO
.Xr bsd.port.mk 5
@


1.2
log
@o) start new sentence on a new line;
o) close .Bl;

avsm@@ ok
@
text
@d1 1
a1 1
.\" $OpenBSD: bsd.regress.mk.5,v 1.1 2002/08/26 22:12:11 avsm Exp $
d61 2
a62 2
.Bl -tag -width REGRESSLOG
.It Ev REGRESSLOG
d67 1
a67 1
.It Ev REGRESSMAXTIME
d70 1
a70 1
.It Ev REGRESSROOTTARGETS
d77 4
a80 4
.It Ev REGRESSSKIPSLOW
Skip over all the regression tests which have been marked as
being 'slow' using the
.Ev REGRESSSLOWTARGETS
d82 1
a82 1
.It Ev REGRESSSLOWTARGETS
d85 1
a85 1
.Ev REGRESSSKIPSLOW 
d87 1
a87 1
.It Ev REGRESSTARGETS
d98 1
a98 1
.Ev REGRESSMAXTIME
@


1.1
log
@add man page for bsd.regress.mk, based on bsd.port.mk

art@@ ok
@
text
@d1 1
a1 1
.\" $OpenBSD$
d56 4
a59 3
Runs an individual regression test.  If the exit status of the
program indicates an error or timeout, then a failure is logged,
otherwise the test is marked as a success.
d64 3
a66 1
results are appended.  Defaults to /dev/null.
d71 2
a72 1
Targets for which root access is required to run the test. The
d74 2
a75 1
variable is invoked for these targets.  See also
d83 2
a84 2
Targets which are defined as 'slow'.  All of these tests
can be skipped by setting the 
d89 2
a90 1
for this Makefile.  Defaults to 
d95 1
@

