head	1.5;
access;
symbols
	OPENBSD_3_2:1.4.0.18
	OPENBSD_3_2_BASE:1.4
	OPENBSD_3_1:1.4.0.16
	OPENBSD_3_1_BASE:1.4
	OPENBSD_3_0:1.4.0.14
	OPENBSD_3_0_BASE:1.4
	OPENBSD_2_9:1.4.0.12
	OPENBSD_2_9_BASE:1.4
	OPENBSD_2_8:1.4.0.10
	OPENBSD_2_8_BASE:1.4
	OPENBSD_2_7:1.4.0.8
	OPENBSD_2_7_BASE:1.4
	OPENBSD_2_6:1.4.0.6
	OPENBSD_2_6_BASE:1.4
	OPENBSD_2_5:1.4.0.4
	OPENBSD_2_5_BASE:1.4
	OPENBSD_2_4:1.4.0.2
	OPENBSD_2_4_BASE:1.4
	OPENBSD_2_3:1.2.0.8
	OPENBSD_2_3_BASE:1.2
	OPENBSD_2_2:1.2.0.6
	OPENBSD_2_2_BASE:1.2
	OPENBSD_2_1:1.2.0.4
	OPENBSD_2_1_BASE:1.2
	OPENBSD_2_0:1.2.0.2
	OPENBSD_2_0_BASE:1.2
	netbsd_1_1:1.1.1.1;
locks; strict;
comment	@ * @;


1.5
date	2003.03.11.09.29.28;	author deraadt;	state dead;
branches;
next	1.4;

1.4
date	98.10.01.05.31.38;	author pjanzen;	state Exp;
branches;
next	1.3;

1.3
date	98.09.15.05.12.31;	author pjanzen;	state Exp;
branches;
next	1.2;

1.2
date	96.06.10.04.45.28;	author deraadt;	state Exp;
branches;
next	1.1;

1.1
date	95.10.18.08.49.04;	author deraadt;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	95.10.18.08.49.04;	author deraadt;	state Exp;
branches;
next	;


desc
@@


1.5
log
@OK, this is a strange case.  At least some parts of this software is
copyrighted, and then marked "Copying for Profit is Prohibited", but
the author has passed away.  A number of people have tried to make
some sort of effort at trying to contact his estate, and have failed.
Therefore, lacking the ability to correct this copyright, we must
delete it.  I would bet strongly that this is not what the author
would have intended, but until we can get this resolved, this is the
action we must take.
@
text
@/*	$OpenBSD: bill.c,v 1.4 1998/10/01 05:31:38 pjanzen Exp $	*/
/*	$NetBSD: bill.c,v 1.5 1997/10/18 20:03:06 christos Exp $	 */

/*-
 * Copyright (c) 1991 The Regents of the University of California.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by the University of
 *	California, Berkeley and its contributors.
 * 4. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */

#ifndef lint
#if 0
static char sccsid[] = "@@(#)bill.c	5.2 (Berkeley) 5/28/91";
#else
static char rcsid[] = "$OpenBSD: bill.c,v 1.4 1998/10/01 05:31:38 pjanzen Exp $";
#endif
#endif /* not lint */

#include <sys/file.h>
#include <sys/wait.h>
#include <string.h>
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include "header.h"
#include "extern.h"
#include "pathnames.h"

/* bill.c		 Larn is copyrighted 1986 by Noah Morgan. */

#ifndef NOSPAM
char *mail[] = {
	"Undeclared Income",
	"From: The LRS (Larn Revenue Service)\n",
	"\n   We have heard you survived the caverns of Larn.  Let us be the",
	"\nfirst to congratulate you on your success.  It was quite a feat.",
	"\nIt was also very profitable for you...",
	"\n\n   The Dungeon Master has informed us that you brought",
	"1",
	"\ncounty of Larn is in dire need of funds, we have wasted no time",
	"2",
	"\nof this notice, due within 5 days.  Failure to pay will",
	"\nmean penalties.  Once again, congratulations.  We look forward",
	"\nto your future successful expeditions.\n",
	NULL,
	"A Noble Deed",
	"From: His Majesty King Wilfred of Larndom\n",
	"\n   I have heard of your magnificent feat, and I, King Wilfred,",
	"\nforthwith declare today to be a national holiday.  Furthermore,",
	"\nthree days hence be ye invited to the castle to receive the",
	"\nhonour of Knight of the Realm.  Upon thy name shall it be written...",
	"\n\nBravery and courage be yours.",
	"\n\nMay you live in happiness forevermore...\n",
	NULL,
	"You Bastard!",
	"From: Count Endelford\n",
	"\n   I have heard (from sources) of your journey.  Congratulations!",
	"\nYou Bastard!  With several attempts I have yet to endure the",
	" caves,\nand you, a nobody, make the journey!  From this time",
	" onward, bewarned -- \nupon our meeting you shall pay the price!\n",
	NULL,
	"High Praise",
	"From: Mainair, Duke of Larnty\n",
	"\n   With certainty, a hero I declare to be amongst us!  A nod of",
	"\nfavour I send to thee.  Me thinks Count Endelford this day of",
	"\nright breath'eth fire as of dragon of whom ye are slayer.  I",
	"\nyearn to behold his anger and jealousy.  Should ye choose to",
	"\nunleash some of thy wealth upon those who be unfortunate, I,",
	"\nDuke Mainair, shall equal thy gift also.\n",
	NULL,
	"these poor children",
	"From: St. Mary's Children's Home\n",
	"\n   News of your great conquests has spread to all of Larndom.",
	"\nMight I have a moment of a great adventurer's time?  We here at",
	"\nSt. Mary's Children's Home are very poor, and many children are",
	"\nstarving.  Disease is widespread and very often fatal without",
	"\ngood food.  Could you possibly find it in your heart to help us",
	"\nin our plight?  Whatever you could give will help much.",
	"\n(your gift is tax deductible)\n",
	NULL,
	"hope",
	"From: The National Cancer Society of Larn\n",
	"\nCongratulations on your successful expedition.  We are sure much",
	"\ncourage and determination were needed on your quest.  There are",
	"\nmany though, that could never hope to undertake such a journey",
	"\ndue to an enfeebling disease -- cancer.  We at the National",
	"\nCancer Society of Larn wish to appeal to your philanthropy in",
	"\norder to save many good people -- possibly even yourself a few",
	"\nyears from now.  Much work needs to be done in researching this",
	"\ndreaded disease, and you can help today.  Could you please see it",
	"\nin your heart to give generously?  Your continued good health",
	"\ncan be your everlasting reward.\n",
	NULL,
	NULL
};
#endif

/*
 * function to mail the letters to the player if a winner
 */

void
mailbill()
{
#ifndef NOSPAM
	int	i;
	char	buf[128];
	char	**cp;
	int	fd[2];
	pid_t	pid;

	/* This is the last thing that gets run.  We don't care if it
	 * fails, so exit on any failure.  Drop privs. */
	setegid(gid);
	setgid(gid);
	wait(0);
	resetscroll();
	cp = mail;
	for (i = 0; i < 6; i++) {
		if (pipe(fd) < 0)
			exit(0);
		if ((pid = fork()) < 0)
			exit(0);
		else if (pid > 0) { /* parent */
			close(fd[0]);
			while (*++cp != NULL) {
				if (*cp[0] == '1')
					sprintf(buf, "\n%ld gold pieces back with you from your journey.  As the",
						(long) c[GOLD]);
				else if (*cp[0] == '2')
					sprintf(buf, "\nin preparing your tax bill.  You owe %ld gold pieces as", (long) c[GOLD] * TAXRATE);
				else
					sprintf(buf, *cp);
				if (write(fd[1], buf, strlen(buf)) != strlen(buf))
					exit(0);
			}
			cp++;
			close(fd[1]);
			if (waitpid(pid, NULL, 0) < 0)
				exit(0);
		} else {	/* child */
			close(fd[1]);
			if (fd[0] != STDIN_FILENO) {
				if (dup2(fd[0], STDIN_FILENO) != STDIN_FILENO)
					exit(0);
				close(fd[0]);
			}
			if (execl(_PATH_MAIL, "mail", "-s", *cp, loginname,
			    (char *) NULL) < 0)
				exit(0);
		}
	}
#endif
	exit(0);
}
@


1.4
log
@'Spam' winners a bit more safely
@
text
@d1 1
a1 1
/*	$OpenBSD: bill.c,v 1.3 1998/09/15 05:12:31 pjanzen Exp $	*/
d41 1
a41 1
static char rcsid[] = "$OpenBSD: bill.c,v 1.3 1998/09/15 05:12:31 pjanzen Exp $";
@


1.3
log
@NetBSD merge; also renamed some functions so as not to conflict with curses
@
text
@d1 1
a1 1
/*	$OpenBSD$	*/
d41 1
a41 1
static char rcsid[] = "$OpenBSD$";
d53 1
d57 1
d59 1
a60 1
	"~s Undeclared Income\n",
d72 1
a73 1
	"~s A Noble Deed\n",
d81 1
a82 1
	"~s You Bastard!\n",
d88 1
a89 1
	"~s High Praise\n",
d97 1
a98 1
	"~s these poor children\n",
d107 1
a108 1
	"~s hope\n",
d119 1
d122 1
d131 1
a132 1
	char	fname[32];
d135 2
a136 1
	int	fd;
d138 4
d143 11
a153 10
	if (fork() == 0) {
		resetscroll();
		cp = mail;
		sprintf(fname, "/tmp/#%dlarnmail", getpid());
		for (i = 0; i < 6; i++) {
			if ((fd = open(fname, O_WRONLY | O_TRUNC | O_CREAT,
					0666)) == -1)
				exit(0);
			while (*cp != NULL) {
				if (*cp[0] == '1') {
d156 1
a156 2
					write(fd, buf, strlen(buf));
				} else if (*cp[0] == '2') {
d158 4
a161 4
					write(fd, buf, strlen(buf));
				} else
					write(fd, *cp, strlen(*cp));
				cp++;
d164 13
a176 6

			close(fd);
			sprintf(buf, "mail -I %s < %s > /dev/null",
				loginname, fname);
			system(buf);
			unlink(fname);
d179 1
@


1.2
log
@security fixes
@
text
@d1 2
a2 1
/*	$NetBSD: bill.c,v 1.3.6.1 1996/05/27 15:54:11 mrg Exp $	*/
d41 1
a41 1
static char rcsid[] = "$NetBSD: bill.c,v 1.3.6.1 1996/05/27 15:54:11 mrg Exp $";
d52 1
d57 3
a59 3
	"From: the LRS (Larn Revenue Service)\n",
	"~s undeclared income\n",
	"\n   We have heard you survived the caverns of Larn.  Let me be the",
d64 1
a64 1
	"\ncounty of Larn is in dire need of funds, we have spared no time",
d66 2
a67 2
	"\nof this notice, and is due within 5 days.  Failure to pay will",
	"\nmean penalties.  Once again, congratulations, We look forward",
d71 1
a71 1
	"~s a noble deed\n",
d74 2
a75 2
	"\nhence three days, ye be invited to the castle to receive the",
	"\nhonour of Knight of the realm.  Upon thy name shall it be written...",
d83 2
a84 2
	" caves,\nand you, a nobody, makes the journey!  From this time",
	" onward, bewarned\nupon our meeting you shall pay the price!\n",
d91 1
a91 1
	"\nyearn to behold his anger and jealously.  Should ye choose to",
d98 1
a98 1
	"\nMight I have a moment of a great adventurers's time?  We here at",
d121 1
a121 1
 *	function to mail the letters to the player if a winner
d127 5
a131 5
	register int i;
	char fname[32];
	char buf[128];
	char **cp;
	int fd;
d140 1
a140 1
			    0666)) == -1)
d144 2
a145 2
					sprintf(buf, "\n%d gold pieces back with you from your journey.  As the",
					    (long)c[GOLD]);
d148 1
a148 1
					sprintf(buf, "\nin preparing your tax bill.  You owe %d gold pieces as", (long)c[GOLD]*TAXRATE);
d158 1
a158 1
			    loginname, fname);
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
/*	$NetBSD: bill.c,v 1.3 1995/03/23 08:33:10 cgd Exp $	*/
d40 1
a40 1
static char rcsid[] = "$NetBSD: bill.c,v 1.3 1995/03/23 08:33:10 cgd Exp $";
d137 2
a138 2
			if ((fd = open(fname, O_WRONLY | O_TRUNC | O_CREAT),
			    0666) == -1)
@


1.1.1.1
log
@initial import of NetBSD tree
@
text
@@
