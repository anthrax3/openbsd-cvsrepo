head	1.42;
access;
symbols;
locks; strict;
comment	@# @;


1.42
date	2014.04.01.17.03.08;	author nick;	state dead;
branches;
next	1.41;

1.41
date	2004.01.04.22.23.56;	author horacio;	state Exp;
branches;
next	1.40;

1.40
date	2003.07.27.15.30.08;	author jufi;	state Exp;
branches;
next	1.39;

1.39
date	2003.07.04.22.42.26;	author jufi;	state Exp;
branches;
next	1.38;

1.38
date	2003.06.27.20.55.49;	author jufi;	state Exp;
branches;
next	1.37;

1.37
date	2003.06.15.12.25.02;	author jufi;	state Exp;
branches;
next	1.36;

1.36
date	2003.05.03.11.20.40;	author jufi;	state Exp;
branches;
next	1.35;

1.35
date	2003.04.07.22.04.57;	author jufi;	state Exp;
branches;
next	1.34;

1.34
date	2003.04.02.09.34.35;	author jufi;	state Exp;
branches;
next	1.33;

1.33
date	2003.03.26.16.35.57;	author jufi;	state Exp;
branches;
next	1.32;

1.32
date	2003.03.19.19.00.47;	author jufi;	state Exp;
branches;
next	1.31;

1.31
date	2003.03.01.18.08.38;	author jufi;	state Exp;
branches;
next	1.30;

1.30
date	2003.02.25.20.13.04;	author jufi;	state Exp;
branches;
next	1.29;

1.29
date	2003.01.21.15.11.52;	author jufi;	state Exp;
branches;
next	1.28;

1.28
date	2003.01.06.22.01.41;	author jufi;	state Exp;
branches;
next	1.27;

1.27
date	2002.11.29.17.56.41;	author jufi;	state Exp;
branches;
next	1.26;

1.26
date	2002.11.07.09.45.43;	author jufi;	state Exp;
branches;
next	1.25;

1.25
date	2002.09.29.14.05.56;	author jufi;	state Exp;
branches;
next	1.24;

1.24
date	2002.07.14.12.24.28;	author jufi;	state Exp;
branches;
next	1.23;

1.23
date	2002.07.09.10.51.11;	author jufi;	state Exp;
branches;
next	1.22;

1.22
date	2002.07.05.07.30.01;	author jufi;	state Exp;
branches;
next	1.21;

1.21
date	2002.06.29.17.50.51;	author jufi;	state Exp;
branches;
next	1.20;

1.20
date	2002.06.06.18.39.59;	author jufi;	state Exp;
branches;
next	1.19;

1.19
date	2002.05.14.20.03.55;	author jufi;	state Exp;
branches;
next	1.18;

1.18
date	2002.03.30.11.49.55;	author jufi;	state Exp;
branches;
next	1.17;

1.17
date	2002.03.23.10.16.59;	author jufi;	state Exp;
branches;
next	1.16;

1.16
date	2002.02.23.17.35.42;	author jufi;	state Exp;
branches;
next	1.15;

1.15
date	2002.01.28.19.21.45;	author jufi;	state Exp;
branches;
next	1.14;

1.14
date	2002.01.26.11.46.28;	author jufi;	state Exp;
branches;
next	1.13;

1.13
date	2002.01.19.09.12.50;	author jufi;	state Exp;
branches;
next	1.12;

1.12
date	2001.12.30.11.48.26;	author jufi;	state Exp;
branches;
next	1.11;

1.11
date	2001.10.21.09.15.45;	author jufi;	state Exp;
branches;
next	1.10;

1.10
date	2001.09.20.05.08.52;	author jufi;	state Exp;
branches;
next	1.9;

1.9
date	2001.04.07.07.58.54;	author jufi;	state Exp;
branches;
next	1.8;

1.8
date	2001.02.26.15.24.13;	author jufi;	state Exp;
branches;
next	1.7;

1.7
date	2001.02.25.20.15.34;	author jufi;	state Exp;
branches;
next	1.6;

1.6
date	2000.12.28.22.00.24;	author jufi;	state Exp;
branches;
next	1.5;

1.5
date	2000.10.24.18.39.27;	author jufi;	state Exp;
branches;
next	1.4;

1.4
date	2000.09.29.07.00.04;	author jufi;	state Exp;
branches;
next	1.3;

1.3
date	2000.06.02.22.54.24;	author wvdputte;	state Exp;
branches;
next	1.2;

1.2
date	2000.04.30.20.30.15;	author wvdputte;	state Exp;
branches;
next	1.1;

1.1
date	2000.04.26.17.03.26;	author wvdputte;	state Exp;
branches;
next	;


desc
@@


1.42
log
@
Abandon translations, per deraadt@@ and ajacoutot@@.
Thanks to all those that did the translation work, and my appologies to
those who had to translate my writing!
@
text
@<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>13 - Uso de IPsec</title>
<link rev="made" href="mailto:www@@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta http-equiv="Content-Language" content="es">
<meta name="resource-type" content="documento">
<meta name="description"   content="Preguntas Frecuentes de OpenBSD FAQ">
<meta name="keywords"      content="openbsd,faq,documentación">
<meta name="distribution"  content="global">
<meta name="copyright"     content="Este documento es copyright 2000-2004 de OpenBSD">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- máx. 72 caracteres por línea -->

<img alt="[OpenBSD]" height="30" width="141" src="../../images/smalltitle.gif">
<p>
<font color="#0000e0">
<a href="index.html">[&Iacute;ndice de documentos]</a>
<a href="faq12.html">[Secci&oacute;n 12 - Para usuarios avanzados]</a>
<a href="faq14.html">[Secci&oacute;n 14 - Uso de discos en OpenBSD]</a>
</font>

<h1><font color="#e00000">13 - Uso de IPsec (Protocolo de Seguridad
IP)</font></h1>

<hr>

<p>

<font color="#0000e0">
<a href="index.html">[&Iacute;ndice de documentos]</a>
<a href="faq12.html">[Secci&oacute;n 12 - Para usuarios avanzados]</a>
<a href="faq14.html">[Secci&oacute;n 14 - Uso de discos en OpenBSD]</a>
</font>
<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../images/back.gif" border="0" alt="[&iacute;ndice]"></a>
<a href="mailto:www@@openbsd.org">www@@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: faq13.html,v 1.81 ]<br>
$Translation: faq13.html,v 1.43 2004/01/04 19:59:58 horacio Exp $<br>
$OpenBSD: faq13.html,v 1.41 2004/01/04 22:23:56 horacio Exp $
</small>
</body>
</html>
@


1.41
log
@Sync with Steelix CVS
@
text
@d46 1
a46 1
$OpenBSD$
@


1.40
log
@sync with steelix translation CVS
@
text
@d12 1
a12 1
<meta name="copyright"     content="Este documento es copyright 2000-2003 de OpenBSD">
d44 2
a45 2
Originally [OpenBSD: faq13.html,v 1.80 2003/07/25 19:55:38 nick Exp ]<br>
$Translation: faq13.html,v 1.42 2003/07/26 16:34:03 horacio Exp $<br>
@


1.39
log
@sync with steelix translation CVS
@
text
@a31 2477
<h3>&Iacute;ndice de contenidos</h3>
<ul>
<li><a href="#What">13.1 - &iquest;Qu&eacute; es IPsec?</a>
<li><a href="#Why">13.2 - Muy bien pero, &iquest;para qu&eacute;
querr&iacute;a usar IPsec?</a>
<li><a href="#Protocols">13.3 - &iquest;Cu&aacute;les son los protocolos
que conforman IPsec?</a>
<li><a href="#Wire">13.4 - Sobre el formato &quot;wire&quot;</a>
<li><a href="#Config">13.5 - Configuraci&oacute;n de IPsec</a>
<li><a href="#ManKey">13.6 - &iquest;C&oacute;mo configuro IPsec con el
sistema de &laquo;claves manuales&raquo;?</a>
<li><a href="#isakmpd">13.7 - &iquest;C&oacute;mo configuro isakmpd?</a>
<li><a href="#x509">13.8 - &iquest;C&oacute;mo uso isakmpd con
certificados X.509?</a>
<li><a href="#IKEcl">13.9 - &iquest;Qu&eacute; clientes IKE son
compatibles con isakmpd?</a>
<li><a href="#Trouble">13.10 - Resoluci&oacute;n de problemas de
IPsec/VPN</a>
<li><a href="#SeeAlso">13.11 - Documentaci&oacute;n relacionada</a>
</ul>
<p>
<font size="-1">
Partes de este contenido han sido extra&iacute;das de:
</font>
<ul style="font-size: small">
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&amp;sektion=4">ipsec(4)</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&amp;sektion=8">vpn(8)</a>
<li><a href="http://www.freebsd.org/~julian/IPSEC_4_Dummies.html">IPsec for Dummies</a>, por Julian Elischer
<li><a href="http://www.secureops.com/vpn/vpn.html">ISAKMP Howto</a>, por Patrick Ethier
<li><a href="http://hem.passagen.se/hojg/isakmpd/">X.509v3 certificates with isakmpd</a>, por J&ouml;rgen Granstam
</ul>

<hr>


<p>
<a name="What"></a>
<a name="13.1"></a>
<h2>13.1 - &iquest;Qu&eacute; es IPsec?</h2>

<p>
IPsec es un grupo de extensiones de la familia del protocolo IP.  IPsec
provee servicios criptogr&aacute;ficos de seguridad.  Estos servicios
permiten la autenticaci&oacute;n, integridad, control de acceso, y
confidencialidad.  IPsec provee servicios similares a SSL, pero a nivel
de redes, de un modo que es completamente transparente para sus
aplicaciones y mucho m&aacute;s robusto.  Es transparente porque sus
aplicaciones no necesitan tener ning&uacute;n conocimiento de IPsec para
poder usarlo.  Se puede usar
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/protocols?rev=1.13">cualquier protocolo IP</a>
sobre IPsec.  Se pueden crear t&uacute;neles cifrados (VPN), o simple
cifrado entre computadoras (ordenadores).  Debido a que dispone de
tantas opciones, IPsec es m&aacute;s bien complejo (&iexcl;mucho
m&aacute;s que SSL!).

<p>
Antes de empezar a usar IPsec es absolutamente necesario repasar la
&laquo;lectura recomendada&raquo; de la 
<a href="faq6.html">secci&oacute;n 6</a> de las preguntas
frecuentes.  En particular, si todav&iacute;a no se entiende el
funcionamiento de Internet, el documento 
<a href="http://www.3com.com/corpinfo/en_US/technology/tech_paper.jsp?DOC_ID=135">Understanding IP Addressing</a>
es muy recomendable (tambi&eacute;n disponible desde
<a href="http://www.3com.com/other/pdfs/infra/corpinfo/en_US/501302.pdf">
este enlace</a>).

<p>
De un modo l&oacute;gico, IPsec funciona en cualquiera de estos tres
modos:

<ul>
<li>Anfitri&oacute;n-a-Anfitri&oacute;n
<li>Anfitri&oacute;n-a-Red
<li>Red-a-Red
</ul>

<p>
En cualquier escenario en el que haya una red, el concepto de enrutador
est&aacute; impl&iacute;cito, como en Anfitri&oacute;n-a-Enrutador (y
este enrutador controla y cifra el tr&aacute;fico para una <i>Red</i>
particular).

<p>
Como se puede ver, IPsec se puede usar como t&uacute;nel de
tr&aacute;fico para conexiones de &laquo;redes privadas virtuales&raquo;
(VPN, <i>Virtual Private Networks</i>).  Sin embargo, su utilidad va
m&aacute;s all&aacute; de las VPN.  Con un registro central de
&laquo;intercambio de claves de Internet&raquo; (IKE, <i>Internet Key
Exchange</i>), cada m&aacute;quina en Internet podr&iacute;a comunicarse
con otra y usar cifrado y autenticaci&oacute;n de alto grado.


<p>
<a name="Why"></a>
<a name="13.2"></a>
<h1>13.2 - Muy bien pero, &iquest;para qu&eacute; querr&iacute;a usar
IPsec?</h1>

<p>
El protocolo de Internet, IP, tambi&eacute;n conocido como IPv4, no
provee por s&iacute; mismo de ninguna protecci&oacute;n a las
transferencias de datos.  Ni siquiera puede garantizar que el remitente
sea quien dice ser.  IPsec intenta remediarlo.  Estos servicios vienen
tratados como dos servicios distintos, pero IPsec ofrece soporte para
ambos de un modo uniforme.

<p>
<h4>Confidencialidad</h4>

Es necesario asegurarse de que los datos enviados sean dif&iacute;ciles
de comprender para todos excepto para el receptor.  Por ejemplo, hay que
estar seguro de que las contrase&ntilde;as que se usan al ingresar en
una m&aacute;quina remota a trav&eacute;s de Internet se mantienen en
secreto.

<p>
<h4>Integridad</h4>

Hay que garantizar que los datos no puedan ser cambiados durante el
trayecto.  Si alguien se encuentra en una l&iacute;nea que lleve datos
sobre facturaci&oacute;n, querr&aacute; estar seguro de que las
cantidades y cifras de contabilidad son las correctas, y que no han
podido ser alteradas durante el tr&aacute;nsito.

<p>
<h4>Autenticidad</h4>

Los datos deben firmarse para que otros puedan verificar qui&eacute;n es
realmente quien los ha enviado.  Es agradable saber que los documentos
no son falsos.

<p>
<h4>Protecci&oacute;n a la r&eacute;plica</h4>

Necesitamos modos para asegurarnos de que unos datos enviados se
procesan una sola vez, al margen del n&uacute;mero de veces que se
reciban.  O sea, que un atacante no pueda registrar una
transacci&oacute;n (como por ejemplo una transacci&oacute;n bancaria) y
m&aacute;s tarde replicarla al pie de la letra de modo que la otra parte
de la conexi&oacute;n piense que se ha recibido un nuevo mensaje (una
nueva transacci&oacute;n).  <i>AVISO: seg&uacute;n se especifica en los
est&aacute;ndares, la protecci&oacute;n a la r&eacute;plica no se
realizar&aacute; cuando se use el sistema de claves manuales de IPsec
(v.g., cuando se est&eacute; usando 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&amp;sektion=8">ipsecadm(8)</a>)</i>.


<p>
<a name="Protocols"></a>
<a name="13.3"></a>
<h2>13.3 - &iquest;Cu&aacute;les son los protocolos que conforman
IPsec?</h2>

<p>
IPsec provee confidencialidad, integridad, autenticidad, y
protecci&oacute;n a la r&eacute;plica a trav&eacute;s de dos nuevos
protocolos.  Estos protocolos se llaman &laquo;Cabecera de
Autenticaci&oacute;n&raquo; (AH, <i>Authentication Header</i>) y
&laquo;Carga &Uacute;til de Seguridad Encapsulada&raquo; (ESP,
<i>Encapsulating Security Payload</i>).

<p>
AH provee auntenticaci&oacute;n, integridad, y protecci&oacute;n a la
r&eacute;plica (pero no confidencialidad).  La diferencia principal
entre las funcionalidades de autenticaci&oacute;n de AH y ESP es que AH
siempre autentica partes de la cabecera IP del paquete (como las
direcciones de origen/destino).  ESP s&oacute;lo autentica la carga
&uacute;til (<i>payload</i>) del paquete.

<p>
ESP puede proveer autenticaci&oacute;n, integridad, protecci&oacute;n a
la r&eacute;plica, y confidencialidad de los datos (asegura todo lo que
sigue a la cabecera en el paquete).  La protecci&oacute;n a la
r&eacute;plica requiere autenticaci&oacute;n e integridad (estas dos van
siempre juntas).  La confidencialidad (cifrado) se puede usar con o sin
autenticaci&oacute;n y/o integridad.  Del mismo modo, se puede usar la
autenticaci&oacute;n y/o la integridad con o sin la confidencialidad.

<p>
En la pr&aacute;ctica, se recomienda que se use ESP para la
mayor&iacute;a de aplicaciones.

<p>
<a name="Wire"></a>
<a name="13.4"></a>
<h2>13.4 - Sobre el formato &quot;wire&quot;</h2>

<p>
La <b>Cabecera de Autenticaci&oacute;n</b> (AH) viene de la cabecera
b&aacute;sica IP y contiene res&uacute;menes criptogr&aacute;ficos
(<i>hash</i>) de los datos e informaci&oacute;n de
identificaci&oacute;n.  Los res&uacute;menes criptogr&aacute;ficos
tambi&eacute;n pueden cubrir las partes invariables de la misma cabecera
de IP.  Hay varios RFC diferentes que ofrecen una elecci&oacute;n de
algoritmos para AH, sin embargo todos deben seguir las l&iacute;neas
especificadas en el
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2402.html">
RFC2402</a>.

<p>
La cabecera de la <b>Carga &Uacute;til de Seguridad Encapsulada</b>
(<i>Encapsulated Security Payload</i>, ESP) permite reescribir la carga
&uacute;til de forma cifrada.  La cabecera ESP no considera los campos
de la cabecera IP que van delante, y por lo tanto no garantiza nada
excepto la carga &uacute;til del paquete.  Los distintos tipos de ESP
aplicables deben ser conformes con el
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">
RFC2406</a>.  Una cabecera ESP tambi&eacute;n puede proveer
autenticaci&oacute;n para el carga &uacute;til (pero no la cabecera
exterior).

<p>
Una divisi&oacute;n ortogonal (en su mayor parte) de funcionalidad de
IPsec se aplica dependiendo de si el extremo que est&aacute; llevando a
cabo la encapsulaci&oacute;n IPsec es la fuente original de los datos o
una pasarela:

<ul>
<li>El modo <b>transporte</b> es el que usa un anfitri&oacute;n que
genera los paquetes.  En modo transporte, las cabeceras de seguridad se
a&ntilde;aden antes que las cabeceras de la capa de transporte (v.g.,
TCP, UDP), antes de que la cabecera IP sea a&ntilde;adida al paquete.
En otras palabras, un AH a&ntilde;adido al paquete cubrir&aacute; el
resumen criptogr&aacute;fico de la cabecera TCP y algunos campos de la
cabecera IP de extremo a extremo, y una cabecera ESP cubrir&aacute; el
cifrado de la cabecera TCP y los datos, pero no la cabecera IP de
extremo a extremo.

<li>El modo <b>T&uacute;nel</b> se usa cuando la cabecera IP de extremo
a extremo ya ha sido adjuntada al paquete, y uno de los extremos de la
conexi&oacute;n segura es solamente una pasarela.  En este modo, las
cabeceras AH y ESP se usan para cubrir todo el paquete, incluida la
cabecera de extremo a extremo, y se a&ntilde;ade una nueva cabecera IP
al paquete que cubre s&oacute;lo el salto al otro extremo de la
conexi&oacute;n segura (aunque eso puedan ser varios saltos de
distancia).
</ul>

<p>
Los enlaces seguros de IPsec se definen en t&eacute;rminos de
&laquo;Asociaciones de Seguridad&raquo; (<b>SA</b>s).  Cada SA viene
definida por un &uacute;nico flujo unidireccional de datos, y por regla
general (ignorando multicast) desde un &uacute;nico punto hasta otro,
cubriendo el tr&aacute;fico que se distingue por alg&uacute;n
&laquo;selector &uacute;nico&raquo;.  Todo el flujo de tr&aacute;fico
sobre un &uacute;nico SA se trata del mismo modo.  Algo del
tr&aacute;fico puede estar sujeto a varios SAs, cada uno de los cuales
aplica alg&uacute;n tipo de transformaci&oacute;n criptogr&aacute;fica.
Un grupo de SAs se conoce como un &laquo;Haz&raquo; (&quot;SA
Bundle&quot;).  Los paquetes entrantes se pueden asignar a un SA
particular por medio de los tres campos de definici&oacute;n:

<ul>
<li>&laquo;Direcci&oacute;n IP de destino&raquo; (&quot;destination IP
address&quot;)
<li>&laquo;&Iacute;ndice del Par&aacute;metro de Seguridad&raquo; (SPI,
&quot;Security Parameter Index&quot;)
<li>&laquo;Protocolo de seguridad&raquo; (&quot;security protocol&quot;)
</ul>

<p>
SPI se puede considerar como un &quot;cookie&quot; manejado por el
receptor del SA, cuando se negocian los par&aacute;metros de la
conexi&oacute;n.  El protocolo de seguridad debe ser AH o ESP.  Debido a
que la direcci&oacute;n IP del receptor es parte del tr&iacute;o,
&eacute;sta es un valor &uacute;nico garantizado.  Se pueden encontrar
desde la cabecera IP exterior y la primera cabecera de seguridad (que
contiene el SPI y el protocolo de seguridad).

<p>
Un ejemplo de un paquete AH en modo t&uacute;nel es:

<p>
<table border="1">
<tr>
<td><b>IPhdr</b></td>
<td><b>AH</b></td>
<td>IPhdr2</td>
<td>TCPhdr</td>
<td>datos</td>
</tr>
</table>

<p>
Un ejemplo de un paquete AH en modo transporte es:

<p>
<table border="1">
<tr>
<td><b>IPhdr</b></td>
<td><b>AH</b></td>
<td>TCPhdr</td>
<td>datos</td>
</tr>
</table>

<p>
Debido a que una cabecera ESP no puede autenticar la cabecera IP
exterior, es &uacute;til combinar una cabecera AH y una ESP para obtener
lo siguiente:

<p>
<table border="1">
<tr>
<td><b>IPhdr</b></td>
<td><b>AH</b></td>
<td><b>ESP</b></td>
<td><i>TCPhdr</i></td>
<td><i>datos</i></td>
</tr>
</table>

<p>
Esto se conoce como &laquo;Adyacencia de Transporte&raquo;.  La
versi&oacute;n del t&uacute;nel ser&iacute;a algo as&iacute;:

<p>
<table border="1">
<tr>
<td><b>IPhdr</b></td>
<td><b>AH</b></td>
<td><b>ESP</b></td>
<td><i>IPhdr2</i></td>
<td><i>TCPhdr</i></td>
<td><i>datos</i></td>
</tr>
</table>

<p>
Sin embargo no se menciona en el RFC.  Como ocurre con la Adyacencia de
Transporte, esto autenticar&iacute;a todo el paquete excepto unas
cuantas cabeceras de la cabecera IP, y tambi&eacute;n cifrar&iacute;a la
carga (en el ejemplo, en bastardilla).  Cuando una cabecera AH y una ESP
se aplican juntas directamente como en este caso, el orden de las
cabeceras deber&iacute;a ser que el que se muestra en el ejemplo.  En
modo t&uacute;nel es posible hacer encapsulaci&oacute;n recursiva
arbitraria para que no se especifique el orden.


<p>
<a name="Config"></a>
<a name="13.5"></a>
<h2>13.5 - Configuraci&oacute;n de IPsec</h2>

<p>
La forma en la que se configuran los sistemas IPsec y las pasarelas es,
hasta un cierto punto, trabajo del diseñador; sin embargo, el RFC
contiene algunas recomendaciones importantes sobre c&oacute;mo se
deber&iacute;a implementar para evitar al m&aacute;ximo la
confusi&oacute;n.

<p>
Existen dos entidades administrativas que controlan lo que le ocurre a
un paquete.  Una es la &laquo;Base de Datos de Asociaci&oacute;n de la
Seguridad&raquo; (SAD, <i>Security Association Database</i>, llamado TDB
o tabla TDB en el c&oacute;digo fuente de IPsec de OpenBSD), y el otro
es la &laquo;Base de Datos de Pol&iacute;tica de la Seguridad&raquo;
(SPD, <i>Security Policy Database</i>).

<p>
Las dos se parecen en que, dado un n&uacute;mero de selectores que
describan algo de tr&aacute;fico, entregar&aacute;n una entrada que
describa el proceso necesario.  Sin embargo, SPD se elimina a dos pasos
del proceso:  SPD se usa para paquetes salientes, para decidir
qu&eacute; entradas SAD se deben usar, y qu&eacute; entradas SAD
describen el proceso y sus par&aacute;metros.  Las entradas SPD
especifican las entradas SAD existentes a usar (si es un
&laquo;haz&raquo; puede haber m&aacute;s de una), pero si no hay una que
se pueda usar, entonces se usa para crear otras nuevas.  Los campos de
SA que se crean se pueden tomar de la entrada SPD o del paquete que
inici&oacute; la creaci&oacute;n.

<p>
Los paquetes salientes van desde la entrada SPD a la especificada de SA,
para obtener par&aacute;metros de codificaci&oacute;n.  Los paquetes
entrantes obtienen la SA correcta directamente, usando el tr&iacute;o
SPI/DestIP/Protocolo, y de ah&iacute; van a la entrada SPD.

<p>
SPD tambi&eacute;n puede especificar qu&eacute; tr&aacute;fico
deber&iacute;a circunvalar IPsec, y cu&aacute;l se deber&iacute;a dejar
caer, as&iacute; que tambi&eacute;n debe ser consultado para
tr&aacute;fico no IPsec entrante.  Las entradas SPD se deben ordenar de
forma expl&iacute;cita, ya que varias podr&iacute;an coincidir con un
paquete particular, y el proceso debe ser reproducible.

<p>
Se puede pensar en SPD como algo parecido a un filtro de paquetes, en el
que las acciones que se deciden son la activaci&oacute;n de procesos SA.
Los selectores pueden incluir direcciones de origen y destino,
n&uacute;meros de puertos si fueran relevantes, nombres de anfitriones,
niveles de sensibilidad de seguridad, protocolos, etc...

<p>
Una entrada SAD incluye:

<ul>
<li>Direcci&oacute;n IP de destino
<li>Protocolo IPsec (AH o ESP)
<li>SPI (cookie)
<li>Contador de secuencias
<li>Indicador de secuencia O/F
<li>Ventana de informaci&oacute;n anti-r&eacute;plica
<li>Tipo de AH e informaci&oacute;n
<li>Tipo de ESP e informaci&oacute;n
<li>Informaci&oacute;n sobre el tiempo de vida
<li>Indicadores de modos t&uacute;nel/transporte
<li>Informaci&oacute;n sobre el camino MTU
</ul>

<p>
Una entrada SPD contiene:

<ul>
<li>Puntero a SAs activas
<li>Campos de selector
</ul>

<p>
Cada SA puede definir una cabecera ESP y una cabecera AH.  Una
sesi&oacute;n de IPsec debe tener una de las dos o ambas, pero no se
puede definir sin ninguna de las dos (en caso contrario no habr&iacute;a
cabeceras para especificar el SPI que deba buscar la SA).  El RFC no
dice qu&eacute; suceder&iacute;a si las cabeceras AH y ESP estuvieran en
desacuerdo sobre el valor de SPI.  Se puede pensar que esto
implicar&iacute;a m&uacute;ltiples SAs en un haz.

<p>
En OpenBSD, SPD se gestiona a trav&eacute;s de la orden <tt>ipsecadm
flow</tt> (s&oacute;lo se cambiar&iacute;a si estuviera usando el
sistema de claves manual).  Las entradas de SAD se pueden configurar
manualmente con
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&amp;sektion=8">ipsecadm(8)</a>,
sin embargo el IETF tambi&eacute;n ha definido mecanismos
autom&aacute;ticos para la iniciaci&oacute;n de sesiones y otras cosas
como el intercambio de claves.  OpenBSD implementa el intercambio
autom&aacute;tico de claves ISAKMP
(<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2407.html">RFC2407</a>,
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2408.html">RFC2408,</a> y
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2409.html">RFC2409</a>)
en el d&aelig;mon
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&amp;sektion=8">isakmpd(8)</a>.


<p>
<a name="ManKey"></a>
<a name="13.6"></a>
<h2>13.6 - &iquest;C&oacute;mo configuro IPsec con el sistema de
&laquo;claves manuales&raquo;?</h2>

<p>
El sistema de claves manuales es el m&aacute;s sencillo para empezar con
IPsec.  Con este m&eacute;todo puede activar los sistemas
criptogr&aacute;ficos de cifrado entre redes y crear una VPN.
Despu&eacute;s de leer esta secci&oacute;n se puede investigar
c&oacute;mo configurarlo de forma autom&aacute;tica mediante el uso de
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/rc.vpn?rev=1.15">/usr/share/ipsec/rc.vpn</a>.

<p>
Antes que nada hay que asegurarse de que el protocolo ESP IP est&aacute;
activado en el n&uacute;cleo de OpenBSD.  Aunque se encuentra activado
por definici&oacute;n, es aconsejable verificarlo del modo siguiente:

<blockquote><tt>
# <b>sysctl net.inet.esp.enable</b><br>
net.inet.esp.enable = 1<br>
</tt></blockquote>
 
<p>
De igual modo, si se requiere AH, tambi&eacute;n se verificar&aacute;
que est&eacute; activado:

<blockquote><tt>
# <b>sysctl net.inet.ah.enable</b><br>
net.inet.ah.enable = 1
</tt></blockquote>

<p>
Si fuera necesario, estos protocolos se pueden activar usando la
opci&oacute;n <i>-w</i> con la orden
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=8">sysctl(8)</a>.

<p>
Tambi&eacute;n se puede modificar directamente el fichero
<tt>/etc/sysctl.conf</tt> para activarlos (o desactivarlos) durante el
arranque.  Para ello hay que eliminar la marca <i>#</i> que aparece
delante de la l&iacute;nea <i>net.inet.esp.enable</i> y/o la
l&iacute;nea <i>net.inet.ah.enable</i> (dependiendo de cu&aacute;l se va
a usar) y asegurarse de que est&aacute;n configuradas con el valor 1.


<p>
N&oacute;tese que en la mayor&iacute;a de casos, como en el gui&oacute;n
<i>rc.vpn</i> o en el ejemplo de m&aacute;s abajo, s&oacute;lo se
requiere ESP.  En estos casos <i>no es necesario activar AH</i>.  De
hecho pueden existir problemas de seguridad relacionados con la
activaci&oacute;n de AH si no se est&aacute; utilizando.

<p>
A continuaci&oacute;n habr&aacute; que generar las claves manuales.
Como la seguridad del VPN se basa en que estas claves no se puedan
&laquo;adivinar&raquo;, es muy importante escoger las claves usando una
fuente aleatoria fuerte.  Un m&eacute;todo pr&aacute;ctico de generarlas
es usar el dispositivo
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=random&amp;sektion=4">random(4)</a>.
Por ejemplo, para producir 160 bits (20 bytes) de aleatoriedad:

<blockquote><tt>
# <b>openssl rand 20 | hexdump -e '20/1 "%02x"'</b>
</tt></blockquote>

<p>
El n&uacute;mero de bits producidos es importante.  Tipos de cifrado
diferentes pueden requerir claves de tama&ntilde;os tambi&eacute;n
diferentes.

<pre>
Algoritmo	Tama&ntilde;o
de cifrado	de la Clave
----------	-----------
DES		56 bits
3DES      	168 bits
BLF	        Variable (160 bits recommended)
CAST    	Variable (40-128 bits recommended)
SKIPJACK  	80 bits
</pre>

<p>
Ahora hay que configurar las SAs (&laquo;Asociaciones de
Seguridad&raquo;).  Una SA es una combinaci&oacute;n de las direcciones
IP, un SPI, y del protocolo de seguridad (AH y/o ESP).  Las direcciones
IP ser&aacute;n la de origen (la nuestra) y la de su destino.  El SPI
(&laquo;&Iacute;ndice del Par&aacute;metro de Seguridad&raquo;) es un
n&uacute;mero que OpenBSD usa para clasificar distintas SAs.

<p>
<i>En estos ejemplos s&oacute;lo se usa ESP para cifrar su
tr&aacute;fico.  ESP incluye la autenticaci&oacute;n de los datos
cifrados contenidos, pero no autentica la cabecera IP a su alrededor.
Esta &laquo;autenticaci&oacute;n limitada&raquo; es, sin embargo,
suficiente para la mayor&iacute;a de casos, especialmente para ESP en un
entorno de t&uacute;neles.</i>

<blockquote><tt>
# <b>ipsecadm new esp -spi SPI_OUT -src MY_EXTERNAL_IP -dst PEER_EXTERNAL_IP -forcetunnel -enc blf -auth sha1 -key ENC_KEY -authkey AUTH_KEY</b>
</tt></blockquote>

<p>
Llev&eacute;moslo a la pr&aacute;ctica con dos enrutadores, 192.168.5.1
y 192.168.25.9.

<p>
En el anfitri&oacute;n 192.168.5.1:

<blockquote><tt>
# <b>ipsecadm new esp -spi 1000 -src 192.168.5.1 -dst 192.168.25.9 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b>
<br>
# <b>ipsecadm new esp -spi 1001 -dst 192.168.5.1 -src 192.168.25.9 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b>
</tt></blockquote>

<p>
En el anfitri&oacute;n 192.168.25.9:

<blockquote><tt>
# <b>ipsecadm new esp -spi 1001 -src 192.168.25.9 -dst 192.168.5.1 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b>
<br>
# <b>ipsecadm new esp -spi 1000 -dst 192.168.25.9 -src 192.168.5.1 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b>
</tt></blockquote>

<p>
N&oacute;tese que los SPI son distintos.  V&eacute;se la secci&oacute;n
sobre el <a href="#Wire">formato &quot;wire&quot;</a> para una
descripci&oacute;n completa sobre qu&eacute; es el SPI y sobre
d&oacute;nde se est&aacute; usando.

<p>
Ahora que ya tenemos las Asociaciones de Seguridad en su sitio;  pasemos
a configurar los flujos.

<p>
En 192.168.5.1:

<p>
Aqu&iacute; se crear&aacute;n <b>dos</b> flujos, uno ser&aacute; la
direcci&oacute;n de origen local, que cubrir&aacute; todos los paquetes
que originen del anfitri&oacute;n local hacia el destino, y el otro
ser&aacute; el flujo de vuelta desde el destino hasta el
anfitri&oacute;n local.

<blockquote><tt>
# <b>ipsecadm flow -proto esp -dst 192.168.25.9 -spi 1000 -addr 192.168.5.1 255.255.255.255 192.168.25.9 255.255.255.255</b>
</tt></blockquote>

En 192.168.25.9:

<blockquote><tt>
# <b>ipsecadm flow -proto esp -dst 192.168.5.1 -spi 1001 -addr 192.168.25.9 255.255.255.255 192.168.5.1 255.255.255.255</b>
</tt></blockquote>

<p>
Si no se necesita tanta carga en las VPN Hu&eacute;sped-a-Hu&eacute;sped
se puede crear el SPI sin <tt>-forcetunnel</tt>, lo que le
permitir&aacute; usar el modo de transporte (mientras que
<tt>-forcetunnel</tt> asegura que todo en el paquete IP, incluida la
cabecera IP, sea encapsulado por SPI).  Si el origen o el destino es una
red, ser&aacute; necesario usar el modo de t&uacute;nel.  Crear una SA
hacia o desde una red asegurar&aacute; autom&aacute;ticamente que se
est&eacute;n creando los SPI en modo t&uacute;nel.

<p>
&Eacute;ste es un m&eacute;todo simple para empezar a usar IPsec.

<p>
Se puede usar IPsec para pasar los espacios de direcciones IP privados
por t&uacute;neles en Internet.  He aqu&iacute; un buen ejemplo:
Queremos pasar 192.168.99.0/24 (que se encuentra detr&aacute;s de
208.1.1.1) por t&uacute;neles a 208.1.2.0/24 y 208.1.5.0/24 (que
est&aacute;n detr&aacute;s de 208.2.2.2).  Estos ejemplos se han
generado usando el gui&oacute;n de ejecuci&oacute;n
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/rc.vpn?rev=1.3">rc.vpn</a>.

<p>
Como se puede ver, cuando se usa el sistema de claves manuales con IPsec
hay que especificar <b>con exactitud</b> lo que se desea hacer.  No lo
adivinar&aacute; por nosotros.  V&eacute;anse los siguientes ejemplos:


<p>
<h2>En 208.1.1.1:</h2>

<p>
Primero configuramos las asociaciones de seguridad (SA):<br>
(esto configura los SPI, m&eacute;todos de cifrado y claves)

<blockquote><tt>
# <b>ipsecadm new esp -src 208.1.1.1 -dst 208.2.2.2 -forcetunnel -spi 1001 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b>
<br>
# <b>ipsecadm new esp -src 208.2.2.2 -dst 208.1.1.1 -forcetunnel -spi 1000 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b>
</tt></blockquote>

<p>
A continuaci&oacute;n configuramos un flujo desde 208.1.1.1 hasta
208.2.2.2

<blockquote><tt>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 208.1.1.1 255.255.255.255 208.2.2.2 255.255.255.255</b>
</tt></blockquote>

Luego configuramos un flujo desde 208.1.2.0/24 (que est&aacute;
detr&aacute;s de 208.2.2.2) hasta 192.168.99.0/24

<blockquote><tt>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 192.168.99.0 255.255.255.0 208.1.2.0 255.255.255.0</b>
</tt></blockquote>

<p>
Despu&eacute;s un flujo desde 208.1.5.0/24 (que est&aacute;
detr&aacute;s de 208.2.2.2) hasta 192.168.99.0/24

<blockquote><tt>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 192.168.99.0 255.255.255.0 208.1.5.0 255.255.255.0</b>
</tt></blockquote>

Despu&eacute;s un un flujo desde 208.1.2.0/24 (que est&aacute;
detr&aacute;s de 208.2.2.2) hasta el enrutador 208.1.1.1

<blockquote><tt>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 208.1.1.1 255.255.255.255 208.1.2.0 255.255.255.0</b>
</tt></blockquote>

<p>
Despu&eacute;s un un flujo desde 208.1.5.0/24 (que est&aacute;
detr&aacute;s de 208.2.2.2) hasta el enrutador 208.1.1.1

<blockquote><tt>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 208.1.1.1 255.255.255.255 208.1.5.0 255.255.255.0</b>
</tt></blockquote>

<p>
Y finalmente configuramos un flujo desde el enrutador 208.2.2.2 hasta el
192.168.99.0/24

<blockquote><tt>
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 192.168.99.0 255.255.255.0 208.2.2.2 255.255.255.255</b>
</tt></blockquote>


<p>
<h2>En 208.2.2.2:</h2>

<p>
Al igual que antes, configuramos las SA...

<blockquote><tt>
# <b>ipsecadm new esp -src 208.2.2.2 -dst 208.1.1.1 -forcetunnel -spi 1000 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b>
<br>
# <b>ipsecadm new esp -src 208.1.1.1 -dst 208.2.2.2 -forcetunnel -spi 1001 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b>
</tt></blockquote>

Ahora, &eacute;sta es la parte al inverso...  Configuramos un flujo
desde el enrutador 208.2.2.2 hasta el 208.1.1.1

<blockquote><tt>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.2.2.2 255.255.255.255 208.1.1.1 255.255.255.255</b>
</tt></blockquote>

<p>
Despu&eacute;s configuramos un flujo desde la red 192.168.99.0/24 (que
est&aacute; detr&aacute;s de 208.1.1.1) hasta 208.1.2.0/24

<blockquote><tt>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.2.0 255.255.255.0 192.168.99.0 255.255.255.0</b>
</tt></blockquote>

<p>
Despu&eacute;s configuramos un flujo desde la red 192.168.99.0/24 (que
est&aacute; detr&aacute;s de 208.1.1.1) hasta 208.1.5.0/24

<blockquote><tt>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.5.0 255.255.255.0 192.168.99.0 255.255.255.0</b>
</tt></blockquote>

<p>
Despu&eacute;s configuramos un flujo desde 192.169.99.0/24 (que
est&aacute; detr&aacute;s de 208.1.1.1) hasta el enrutador 208.2.2.2

<blockquote><tt>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.2.2.2 255.255.255.255 192.168.99.0 255.255.255.0</b>
</tt></blockquote>

<p>
Ya casi hemos terminado...  Quedan dos flujos para obtener 208.1.2.0/24
y 208.1.5.0/24 desde el enrutador 208.2.2.2 hasta el enrutador 208.1.1.1

<blockquote><tt>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.2.0 255.255.255.0 208.2.2.2 255.255.255.255 -ingress</b>
<br>
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.5.0 255.255.255.0 208.2.2.2 255.255.255.255 -ingress</b>
</tt></blockquote>

<p>
Si hemos usado ipsecadm, y queremos librarnos de cualquier trabajo que
hayamos hecho y empezar desde cero, haremos lo siguiente:

<blockquote><tt>
# <b>ipsecadm flush</b>
</tt></blockquote>

<p>
Esto limpiar&aacute; toda la informaci&oacute;n de IPsec (SPIs, flujos,
entradas de enrutamiento) del sistema.


<p>
<a name="isakmpd"></a>
<h2>13.7 - &iquest;C&oacute;mo configuro isakmpd?</h2>

<p>
Si se est&aacute; pensando en &laquo;redes privadas virtuales&raquo;
(VPN) u otras aplicaciones tradicionales de IPsec, probablemente se va a
usar ISAKMP.  Algunas implementaciones comerciales de IPsec no proveen
ning&uacute;n tipo de sistema de claves manual, y en su lugar requieren
que se use alg&uacute;n tipo de ISAKMP.

<p>
<h3>13.7.1 - &iquest;Qu&eacute; es isakmpd?</h3>

ISAKMP, tambi&eacute;n conocido como &laquo;Intercambio de Claves por
Internet&raquo; (IKE, <i>Internet Key Exchange</i>) es el mecanismo de
intercambio para la VPN.  ISAKMP aborda los problemas de seguridad
usando los m&eacute;todos mencionados en los RFC 2407, 2408 y 2409.
ISAKMP gestiona el intercambio de claves criptogr&aacute;ficas que
ISAKMP es el Protocolo de Asociaci&oacute;n de Seguridad y de
Gesti&oacute;n de Claves de Internet (<i>Internet Security Association
and Key Management Protocol</i>).  Tambi&eacute;n se conoce como IKE, o
Intercambio de Claves por Internet (<i>Internet Key Exchange</i>).  Es
el mecanismo est&aacute;ndar en IPsec para el intercambio de claves.
Se encarga de los problemas de seguridad mencionados en
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2407.html">
RFC 2407</a>,
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2408.html">
RFC 2408,</a> y
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2409.html">
RFC 2409</a>.  ISAKMP gestiona el intercambio de claves
criptogr&aacute;ficas que de otra forma tendr&iacute; que gestionar el
usuario con
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&amp;sektion=8">ipsecadm(8)</a>.
Para ello hace uso de un proceso en dos fases con el fin de establecer
par&aacute;metros de IPsec entre dos nodos de IPsec.

<p>
<b>Fase 1</b> - Los dos extremos de las conexiones ISAKMP establecen un
canal seguro, autenticado, sobre el cual se comunican entre dos
d&aelig;mons.  Esto establece una Asociaci&oacute;n de Seguridad (SA)
entre ambos anfitriones.  Los m&eacute;todos usados para establecer este
canal son el <b>Main Mode</b> (modo principal) y el <b>Agressive
Mode</b> (modo agresivo).  El Modo Principal env&iacute;a la variada
informaci&oacute;n sobre autenticaci&oacute;n en una cierta secuencia,
al tiempo que provee protecci&oacute;n para la identidad.  El Modo
Agresivo no provee esta protecci&oacute;n a la identidad porque toda la
informaci&oacute;n sobre la autenticaci&oacute;n se env&iacute;a al
mismo tiempo.  El modo agresivo s&oacute;lo se deber&iacute;a usar en
casos en los que preocupe el ancho de banda de la red, ya que puede
exponer informaci&oacute;n sobre la identidad a alguien que estuviera a
la escucha.

<p>
<b>Fase 2</b> - Las Asociaciones de Seguridad se negocian en nombre de
IPsec.  La fase 2 establece t&uacute;neles o Asociaciones de Seguridad
(SA) t&eacute;rminos entre anfitriones IPsec.  El <b>Quick Mode</b>
(modo r&aacute;pido) se usa en la fase 2 porque no es necesario repetir
una autenticaci&oacute;n total;  la fase 1 ya ha establecido las SA.

<p>
Resumiendo, la fase 1 se usa para obtener un canal seguro en el que
llevar a cabo las configuraciones (m&aacute;s r&aacute;pidas) de la fase
2.  Puede haber m&uacute;ltiples configuraciones de la fase 2 en el
mismo canal que la fase 1.  La fase 2 se usa para configurar los
t&uacute;neles.  En la fase 1, sus nodos de IPsec establecen una
conexi&oacute;n en la que intercambian autenticaci&oacute;n (bien sea un
certificado X.509 &oacute; un secreto precompartido).  Esto permite que
cada extremo se asegure de que el otro extremo sea autenticado.  La fase
2 es un intercambio de claves que determinan c&oacute;mo se cifran los
datos entre los dos.

<p>
<h3>13.7.2 - &iquest;C&oacute;mo empiezo con isakmpd?</h3>

<p>
OpenBSD incluye los binarios necesarios para ISAKMP y para la pila de
IPsec por definici&oacute;n.  Se pueden encontrar unos ficheros de
configuraci&oacute;n de ejemplo en <tt>/usr/share/ipsec/isakmpd</tt>.
Para este ejemplo hay que copiar <i>policy</i> a
<tt>/etc/isakmpd/isakmpd.policy</tt>, y <i>VPN-east.conf</i> a
<tt>/etc/isakmpd/isakmpd.conf</tt>.  Intentaremos mostrar c&oacute;mo
configurar una VPN (t&uacute;nel).  Si se quiere usar isakmpd entre
anfitriones &uacute;nicos, hay otros ficheros de configuraci&oacute;n en
el directorio <i>samples</i>.  Las p&aacute;ginas de manual contienen
informaci&oacute;n detallada.  No hay que olvidar la lectura de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&amp;sektion=5">isakmpd.conf(5)</a> e
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&amp;sektion=5">isakmpd.policy(5)</a>.

<p>
El primer paso es activar ESP.  En el <a href="#ManKey">principio de la
secci&oacute;n 13.6</a> se explica c&oacute;mo hacerlo, tanto en tiempo
de arranque como con el sistema funcionando.  Despu&eacute;s hay que
editar <tt>/etc/isakmpd/isakmpd.policy</tt>.
Aunque ambos protocolos, ESP y AH, se encuentran activados por
definici&oacute;n en el n&uacute;cleo, hay que verificar que
est&eacute;n disponibles los protocolos que se vayan a necesitar por el
procedimiento que se detalla en la secci&oacute;n sobre
<a href="#ManKey">Claves Manuales</a>.  A continuaci&oacute;n hay que
modificar el fichero <tt>/etc/isakmpd/isakmpd.policy</tt>.  Este fichero
indica a ISAKMP qui&eacute;n puede acceder a IPsec.  En este ejemplo, el
fichero <i>policy</i> indica que cualquiera que env&iacute;e datos
usando ESP, y que se haya autenticado con la contrase&ntilde;a
<i>mekmitasdigoat</i> (o cualquier otra contrase&ntilde;a que
determinemos), puede comunicarse con isakmpd.  Se puede modificar este
fichero para indicar a ISAKMP que s&oacute;lo se desea permitir datos
firmados con ciertos certificados digitales o usando una cierta
transformaci&oacute;n de cifrado.  Tambi&eacute;n se puede permitir el
acceso a IPsec a cualquiera.  Esto s&oacute;lo es recomendable para
pruebas.  Para ello hay que editar el fichero <i>policy</i> para que
contenga s&oacute;lo las siguientes l&iacute;neas:

<blockquote><pre>
KeyNote-Version: 2
Authorizer: &quot;POLICY&quot;
</pre></blockquote>

<p>
El mismo fichero <i>policy</i> contiene dos l&iacute;neas que empiezan
con el car&aacute;cter $.  Esas l&iacute;neas se deben eliminar antes de
usarlo, son s&oacute;lo para cvs.

<p>
Un fichero <i>policy</i> m&aacute;s &uacute;til para este ejemplo
ser&iacute;a:

<blockquote><pre>
KeyNote-Version: 2
Comment: This policy accepts ESP SAs from a remote that uses the right password
Authorizer: &quot;POLICY&quot;
Licensees: &quot;passphrase:mekmitasdigoat&quot;
Conditions: app_domain ==&quot;IPsec policy&quot; &amp;&amp;
            esp_present ==&quot;yes&quot; -&gt; &quot;true&quot;; 
</pre></blockquote>

<p>
Implementando esto se obtendr&aacute; solamente una VPN (t&uacute;nel)
b&aacute;sica que use ESP.  En el anfitri&oacute;n A editaremos
<tt>/etc/isakmpd/isakmpd.conf</tt>.  La direcci&oacute;n IP de muestra
249.2.2.2, debe ser reemplazada con la direcci&oacute;n IP externa del
anfitri&oacute;n A.

<blockquote><pre>
[General] 
Retransmits=		5
Exchange-max-time=	120
Listen-on=		249.2.2.2
</pre></blockquote>

<p>
Haremos algo parecido con isakmpd.conf en el anfitri&oacute;n B.
249.3.3.3 representa la direcci&oacute;n IP externa para el
anfitri&oacute;n B.

<blockquote><pre>
[General]
Retransmits=		5
Exchange-max-time=	120
Listen-on=		249.3.3.3
</pre></blockquote>

<p>
Aqu&iacute; es donde se pueden configurar las variables que
afectar&aacute;n al comportamiento principal de isakmpd.  El uso de los
predefinidos aqu&iacute; es correcto.  El valor <b>Listen-on</b>=
especifica el IP en el que isakmpd debe estar a la escucha.  S&oacute;lo
es necesario el IP de Internet de nuestra pasarela.  Si tenemos
interfaces m&uacute;ltiples externas en nuestra pasarela,
podr&iacute;amos especificar una lista de las interfaces en las que
queremos que est&eacute; a la escucha, introduci&eacute;ndolas,
separadas por comas, en una lista.

<p>
A continuaci&oacute;n, en el anfitri&oacute;n A, editaremos isakmpd.conf
otra vez:

<blockquote><pre>
[Phase 1]
249.3.3.3=		HostB
</pre></blockquote>

<p>
Y en el anfitri&oacute;n B:

<blockquote><pre>
[Phase 1]
249.2.2.2=		HostA
</pre></blockquote>

<p>
Esta secci&oacute;n describe qu&eacute; direcciones IP se deben aceptar
para negociar la conexi&oacute;n de la fase 1.  Su valor se&ntilde;ala a
la secci&oacute;n de m&aacute;s abajo (recu&eacute;rdese que la fase 1
s&oacute;lo autentica la conexi&oacute;n remota para asegurar que sean
quienes afirman ser).  Podemos dar una lista de m&uacute;ltiples
direcciones con l&iacute;neas adicionales en el formato IP_Address=<i>
&lt;PEER-NAME&gt;.</i>.

<p>
A continuaci&oacute;n, en el anfitri&oacute;n A:

<blockquote><pre>
[Phase 2]
Connections=		HostA-HostB
</pre></blockquote>

<p>
Y en el anfitri&oacute;n B:

<blockquote><pre>
[Phase 2]
Connections=		HostB-HostA
</pre></blockquote>

<p>
Esto describe la fase 2 de la conexi&oacute;n.  &Eacute;sta es la fase
que determina qu&eacute; protocolos usar&aacute;n las dos partes para
comunicarse.

<p>
El indicador <b>Connections</b>= se refiere a la secci&oacute;n de
m&aacute;s abajo.  Inicia los requisitos o los m&eacute;todos aceptados
para activar la fase 2.  Tambi&eacute;n le indica a ISAKMPD qu&eacute;
conexiones debe iniciar una vez haya comenzado.  Podemos tener secciones
m&uacute;ltiples, como se ilustra abajo, si vamos a conectar con
m&uacute;ltiples anfitriones.

<p>
Si no tenemos la direcci&oacute;n IP del anfitri&oacute;n remoto,
podemos especificar un <b>Default</b>= que se&ntilde;ale a una
secci&oacute;n que describa una entrada gen&eacute;rica que
servir&aacute; de referencia para cualquier IP entrante que no
est&eacute; en la lista del indicador <b>Connections</b>=.

<p>
En el anfitri&oacute;n A:

<blockquote><pre>
[HostB]
Phase=			1
Transport=		udp
Local-address=		249.2.2.2
Address=		249.3.3.3
Configuration=		Default-main-mode
Authentication=		mekmitasdigoat
#Flags=
</pre></blockquote>

<p>
En el anfitri&oacute;n B:

<blockquote><pre>
[HostA]
Phase=			1
Transport=		udp
Local-address=		249.3.3.3
Address=		249.2.2.2
Configuration=		Default-main-mode
Authentication=		mekmitasdigoat
#Flags=
</pre></blockquote>

<p>
&Eacute;stas representan las secciones a las que se refiere en la
secci&oacute;n anterior sobre la fase 1.  Cada una de ellas describe los
requisitos que debe cumplir la pasarela del extremo que intenta
conectar, para proceder a la fase 2.  Aqu&iacute; hay muchas otras
opciones, pero las que se mencionan son los requisitos m&iacute;nimos.
<!-- Buscar una traducción para `peer' y revisar arriba y abajo -->

<ul>
<li><b>Fase=1</b> se requiere porque el c&oacute;digo ISAKMPD usa los
mismos procedimientos para procesar Fase 1 y Fase 2.  Debe ser <b>1</b>
o no funcionar&aacute; nada.

<li><b>Transport=</b> ofrece diferentes posiblidades para diferentes
anfitriones que vayan a conectar.  Se sugiere que aqu&iacute; se use
UDP, as&iacute; que lo dejaremos en este punto.  Algunos anfitriones que
vayan a conectar pueden estar detr&aacute;s de un cortafuegos que no
permita pasar tr&aacute;fico UDP.  Esto debe ser determinado antes de
activarlo.

<li><b>Local-address</b> es la direcci&oacute;n de destino a la que
se&ntilde;alan los paquetes entrantes.  En algunos casos, puede estar
escuchando conexiones para Fase 1 en distintas interfaces.  En esta
muestra, s&oacute;lo hay una interfaz escuchando, por tanto &eacute;ste
es el IP de la interfaz de escucha en este extremo de la
conexi&oacute;n.

<li><b>Address=</b> es la direcci&oacute;n que se&ntilde;ala al origen
IP de los paquetes entrantes.  Generalmente esto se&ntilde;ala a la
pasarela del extremo conectado.  Esto necesita ser explicado en
m&aacute;s detalle, porque la direcci&oacute;n IP de origen del otro
extremo puede ser desconocida.

<li><b>Configuration=</b> se&ntilde;ala a la secci&oacute;n de abajo.
Puede especificar m&uacute;ltiples secciones como &eacute;sta.
Aqu&iacute; usamos la secci&oacute;n predefinida, especificada en el
fichero de muestra.

<li><b>Authentication=</b> es el secreto precompartido que va a usar
este extremo de la conexi&oacute;n en particular.  Es, m&aacute;s o
menos, una contrase&ntilde;a que usa cada extremo de la conexi&oacute;n.
Esta contrase&ntilde;a se pasa al fichero <i>policy</i> para verificar
si tiene permiso para usar IPsec con este anfitri&oacute;n.  Si
cambiamos esta contrase&ntilde;a, tambi&eacute;n debemos cambiarla en el
fichero <i>policy</i>, porque el fichero de muestra contiene una
contrase&ntilde;a.  Si se ha decidido utilizar un fichero <i>policy</i>
m&iacute;nimo, entonces se puede especificar lo que se quiera
aqu&iacute;.

<li><b>Flags=</b> no se usa en la actualidad.  Los RFC dejan lugar para
que se especifiquen opciones adicionales para la fase 1.
<p>
Hay otros indicadores que permiten configurar otras opciones.
V&eacute;nse las descripciones en la p&aacute;gina del manual de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&amp;sektion=5">isakmpd.conf(5)</a>.
</ul>

<p>
En el anfitri&oacute;n A:

<blockquote><pre>
[HostA-HostB]
Phase=			2
ISAKMP-peer=		HostB
Configuration=		Default-quick-mode
Local-ID=		Net-A
Remote-ID=		Net-B
</pre></blockquote>

<p>
En el anfitri&oacute;n B:

<blockquote><pre>
[HostB-HostA]
Phase=			2
ISAKMP-peer=		HostA
Configuration=		Default-quick-mode
Local-ID=		Net-B
Remote-ID=		Net-A
</pre></blockquote>

<p>
&Eacute;stas representan las secciones a las que se refiere en la
secci&oacute;n anterior sobre la fase 2.  Son las configuraciones
individuales que ISAKMPD debe usar para hablar entre las dos pasarelas
de la conexi&oacute;n.

<ul>
<li><b>Phase=2</b> es necesaria porque el c&oacute;digo de ISAKMPD usa
las mismas funciones para autenticar las Fase 1 y la Fase 2.  Se
requiere para que funcione la VPN.

<li><b>ISAKMPD-Peer=</b> es el nombre de la secci&oacute;n del
anfitri&oacute;n.  Esto significa que estamos hablando con ese extremo
de la conexi&oacute;n en particular para establecer una conexi&oacute;n
de Fase 2.  Se provee para que pueda tener secciones m&uacute;ltiples
que describan conexiones isakmp.

<li><b>Configuration=</b> se refiere a la secci&oacute;n que describe
las normativas que este anfitri&oacute;n y el extremo de la
conexi&oacute;n en concreto deben cumplir.

<li><b>Local-ID=</b> se refiere a una secci&oacute;n IPsec-ID que
describe su Red Privada a la pasarela del otro extremo de la
conexi&oacute;n.  &Eacute;sta es la porci&oacute;n que se pasa para que
la otra pasarela pueda configurar la tabla de enrutamiento concreta, que
transferir&aacute; datos a trav&eacute;s de la VPN a nuestra red.

<li><b>Remote-ID=</b> hace referencia a una secci&oacute;n IPsec-ID que
describe lo que se supone que la Red Privada remota es para nuestro
anfitri&oacute;n.  Esta porci&oacute;n debe ser interpretada para la
correcta configuraci&oacute;n de las tablas de enrutamiento que
transferir&aacute;n datos desde nuestra Red Privada, a trav&eacute;s de
la VPN, hacia la Red Privada remota.
<p>
Hay otro indicador que tiene soporte aqu&iacute; llamado <b>Flags=</b>.
Si se necesita usar este indicador, l&eacute;se antes la p&aacute;gina
del manual de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&amp;sektion=5">isakmpd.conf(5)</a>.
</ul>

<p>
&Eacute;sta es la secci&oacute;n de IPsec-ID.  Estas entradas deben
existir en los ficheros isakmpd.conf del anfitri&oacute;n A y del
anfitri&oacute;n B.  Este ejemplo configurar&aacute;
192.168.1.0/255.255.255.0 para el anfitri&oacute;n A (que se
conect&oacute; arriba a Net-A) y 192.168.20.0/255.255.255.0 para el
anfitri&oacute;n B (arriba Net-B).

<blockquote><pre>
[Net-A]
ID-type=		IPV4_ADDR_SUBNET
Network=		192.168.1.0
Netmask=		255.255.255.0

[Net-B]
ID-type=		IPV4_ADDR_SUBNET
Network=		192.168.20.0
Netmask=		255.255.255.0
</pre></blockquote>

<p>
Estas dos secciones est&aacute;n en el fichero de
<b>configuraci&oacute;n</b> de cada anfitri&oacute;n.  Son las secciones
a las que se hace referencia en los identificadores <b>Local-ID</b> y
<b>Remote-ID</b>.  Describen las rutas que se deben configurar para
permitir el paso del tr&aacute;fico desde una red privada hasta otra.
<b>ID-type</b>= puede ser <b>IPV4_ADDR_SUBNET</b> o <b>IPV4_ADDR</b>
(RFC2708 menciona m&aacute;s valores posibles.  En la actualidad
s&oacute;lo hay soporte en la implementaci&oacute;n de OpenBSD para
IPv4.  El soporte para IPv6 puede estar en OpenBSD-current).
 
<p>
Ahora, en ambos anfitriones, el fichero de muestra deber&iacute;a ser:

<blockquote><pre>
[Default-main-mode]
DOI=			IPSEC
EXCHANGE_TYPE=		ID_PROT
Transforms=		3DES-SHA
</pre></blockquote>

<p>
Esta secci&oacute;n describe los requisitos para los m&eacute;todos de
cifrado de las conexiones de la fase 1.  El nombre refleja el valor de
la variable <i>Configuration=</i>.  Como se puede ver aqu&iacute;,
estamos indicando nuestro Dominio de Inter&eacute;s, que es IPsec.  La
variable <b>EXCHANGE_TYPE</b> est&aacute; configurada con el valor
<b>ID_PROT</b> para la fase 1, que identifica los protocolos que
cubrir&aacute; esta autenticaci&oacute;n.  <b>Transforms=</b> es la
transformaci&oacute;n criptogr&aacute;fica requerida (o asignada) para
este intercambio.  En este caso se&ntilde;ala a la secci&oacute;n de
abajo en el fichero de configuraci&oacute;n, que indica que estamos
recibiendo un paquete cifrado con 3DES y una suma de comprobaci&oacute;n
verificable con SHA.  Hay muchas transformaciones criptogr&aacute;ficas
definidas en el fichero de muestra <b>VPN-east.conf</b>.  &Eacute;stas
se proveen porque 3DES y SHA no siempre tienen soporte en las diferentes
plataformas.  Para OpenBSD no hay raz&oacute;n para cambiar esta
configuraci&oacute;n b&aacute;sica.  Si deseamos crear copias de esta
secci&oacute;n y cambiar la variable <b>Transforms</b>=, poemos hacerlo.
El &uacute;nico requisito es que cambiemos la variable
<b>Configuration</b>=.

<blockquote><pre>
[Default-quick-mode]
DOI=			IPSEC
EXCHANGE_TYPE=		QUICK_MODE
Suites=			QM-ESP-3DES-SHA-PFS-SUITE,QM-ESP-DES-MD5-PFS-SUITE
</pre></blockquote>

<p>
En esta secci&oacute;n se han descrito los requisitos para el cifrado de
los datos que se env&iacute;an a trav&eacute;s de la VPN, y la
referencia a ella est&aacute; arriba en <i>Configuration</i>.
N&oacute;tese que la diferencia entre esta secci&oacute;n y su
equivalente en la fase 1 anterior es que <b>EXCHANGE_TYPE</b> es
<b>QUICK_MODE</b>.  <b>Suites=</b> se&ntilde;ala a una secci&oacute;n
Suite de IPsec que describe los distintos esquemas de cifrado
disponibles entre los dos anfitriones.  Se podr&iacute;a decir mucho
m&aacute;s sobre ISAKMP e IPsec, pero usando las descripciones
b&aacute;sicas que hemos mencionado se deber&iacute;a poder crear una
VPN simple pero s&oacute;lida, que cuidara de s&iacute; misma.  Esto es
el <i>m&iacute;nimo indispensable</i> de <b>isakmpd.conf</b> para ambos
anfitriones.
 
<p>
<h3>13.7.3 - Iniciar isakmpd</h3>

<p>
Podemos usar

<blockquote><tt>
# <b>isakmpd -d -DA=90</b>
</tt></blockquote>

<p>
la primera vez que decidamos invocar este d&aelig;mon.  El d&aelig;mon
no funcionar&aacute; en modo d&aelig;mon, sino como un proceso regular
(en primer plano).  Grabar&aacute; todo en nuestro terminal.  Para parar
isakmpd y limpiar las rutas hay que matar el proceso isakmpd en cada
modo, y ejecutar <b>ipsecadm flush</b>.


<p>
<a name="x509"></a>
<h2>13.8 - &iquest;C&oacute;mo uso isakmpd con certificados X.509?</h2>

<p>
Configurar isakmpd para el uso de certificados en lugar de claves
precompartidas no es mucho m&aacute;s dif&iacute;cil en una gran red con
muchas conexiones entrantes no fiables de lo que ser&iacute;a en una
peque&ntilde;a red.  En realidad podemos simplificar la
configuraci&oacute;n y, m&aacute;s importante, hace que la
gesti&oacute;n de claves sea m&aacute;s flexible.


<p>
<h2>Generaci&oacute;n de cerfificados</h2>

<p>
Hay una buena descripci&oacute;n sobre c&oacute;mo generar claves y
certificados en el fichero
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/README.PKI?rev=1.7">README.PKI</a>
del directorio de fuentes de isakmpd.  Debemos disponer de una clave CA,
el correspondiente certificado CA X.509, una clave privada para cada
m&aacute;quina en la red que use isakmpd, y un certificado X.509 para
cada una de esas claves.

<p>
Para que puedan ser utilizados por isakmpd, los certificados X.509 deben
tener una extensi&oacute;n Subject Alternative Name (subjectAltName)
a&ntilde;adida.  Esta extensi&oacute;n describe la identidad del
poseedor del certificado, y se puede a&ntilde;adir usando
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=certpatch&amp;sektion=8">certpatch(8)</a>,
o un fichero de configuraci&oacute;n de openssl personalizado como
<tt>/etc/ssl/x509v3.cnf</tt>. En los ejemplo que hay en
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/README.PKI?rev=1.7">README.PKI</a>
se describe este proceso usando direcciones IP como identificadores
subjectAltName.

<p>
Aunque el mecanismo predeterminado para las extensiones subjectAltName
sean las direcciones IP, certpatch tambi&eacute;n admite el uso de
&laquo;Nombres de Dominio Totalmente Cualificados&raquo; (FQDN, <i>Fully
Qualified Domain Name</i>) o UFQDN (FQDN de Usuario).  Estos
&uacute;ltimos pueden ser &uacute;tiles para los usuarios de
port&aacute;tiles.  Un ejemplo de FQDN podr&iacute;a ser
<tt>www.openbsd.org</tt>.  Un ejemplo de UFQDN podr&iacute;a ser una
direcci&oacute;n de correo electr&oacute;nico como
<tt>Jorgen.Granstam@@abc.se</tt>.  N&oacute;tese que, a diferencia de los
identificadores basados en IP, isakmpd no verifica los datos que se
presentan en las identificaciones basadas en FQDN o UFQDN, y los
identificadores se tratan como simples cadenas.

<p>
En los siguientes ejemplos se usar&aacute;n FQDNs como subjectAltNames.

<p>
Para introducir un subjectAltName FQDN en un certificado,
har&iacute;amos algo como esto:

<blockquote><tt>
$ <b>/usr/sbin/certpatch -t fqdn -i home.mysite.se -k ca.key originalcert.crt nuevocert.crt</b>
</tt></blockquote>

<p>
Aqu&iacute;, ca.key es la clave privada de la &laquo;Autoridad de
Certificaci&oacute;n&raquo; (CA), por lo tanto esto s&oacute;lo lo puede
hacer quien tenga acceso a la clave privada del CA.  home.mysite.se es
el FQDN que se introduce en el certificado.  Los nombres de los ficheros
originalcert.crt y nuevocert.crt podr&iacute;an tener el mismo nombre,
en cuyo caso el fichero original ser&iacute;a anulado por el certificado
modificado nuevo.

<p>
Estas claves y certificados se deben copiar a sus directorios
correspondientes.  La ubicaci&oacute;n predeterminada para las claves y
cerficados es como sigue:

<p>
<table>
<tr><td><tt>/etc/isakmpd/ca</tt></td>
<td>certificados de clave p&uacute;blica (en formato PEM) de Autoridades
Certificadoras (CA) de confianza</td></tr>
<tr><td><tt>/etc/isakmpd/certs</tt></td>
<td>certificados (con extensiones subjectAltName) de claves
p&uacute;blicas (en formato PEM) de confianza</td></tr>
<tr><td><tt>/etc/isakmpd/private</tt></td>
<td>claves privadas;  &eacute;stas deben tener sus correspondientes
claves p&uacute;blicas en el directorio <tt>cert</tt> que se ha indicado
anteriormente</td></tr>
</table>

<p>
Estas ubicaciones se pueden anular mediante valores en la secci&oacute;n
[X509-certificates] de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&amp;sektion=5">isakmpd.conf(5)</a>.

<p>
N&oacute;tese que si se va a confiar en la infraestructura de CA, la
clave privada de CA (<tt>/etc/isakmpd/ca/ca.key</tt>) se deber&iacute;a
guardar en un sitio seguro, deber&iacute;a ser de un tama&ntilde;o en
bits apropiado (o sea, 2048 bits), y deber&iacute;a cifrarse con una
contrase&ntilde;a fuerte.


<p>
<h2>Configuraci&oacute;n de isakmpd</h2>
  
<p>
Ahora veamos el fichero de configuraci&oacute;n
<tt>/etc/isakmpd/isakmpd.conf</tt>.  Esta configuraci&oacute;n se
tom&oacute; originalmente del fichero de ejemplo en
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&amp;sektion=5">isakmpd.conf(5)</a>,
pero se ha modificado mucho.  Tambi&eacute;n usaremos un fichero mucho
m&aacute;s corto que el fichero del ejemplo de la p&aacute;gina del
manual, para que sea m&aacute;s f&aacute;cil de entender.
Adem&aacute;s, he a&ntilde;adido algunos comentarios (algunos
comentarios los he dejado como estaban en isakmpd.conf(5)), y he
cambiado algunos nombres.  Ninguno de los nombres de dominio aqu&iacute;
usados existen (que yo sepa).

<p>
En realidad, puesto que todo el que lea esto ya tendr&aacute; una
configuraci&oacute;n que funcione del caso de claves precompartidas (ver
la secci&oacute;n anterior), no habr&aacute; muchas sorpresas en este
fichero.  No lo explicar&eacute; en detalle;  en la p&aacute;gina del
manual de isakmpd.conf(5) est&aacute;n las descripciones de las partes
que no comente.

<p>
Asumamos que nuestra configuraci&oacute;n es parecida a &eacute;sta:

<center>
<pre>
one.mysite.se                                        one.worksite.se
 192.168.1.2--+    10.0.0.1====/======10.0.0.2     +--192.168.2.2 
              |  gw.mysite.se       gw.worksite.se |
              +--192.168.1.1         192.168.2.1---+
two.mysite.se |                                    | two.worksite.se
 192.168.1.3--+                                    +--192.168.2.3
</pre>
</center>

<p>
O sea, dos redes que deben conectarse usando un t&uacute;nel IPsec sobre
una red de otro modo insegura.  Ignoraremos el hecho de que aqu&iacute;
se est&eacute;n usando direcciones IP reservadas para Internets privadas
(RFC1918), debo usar algo.  No explicar&eacute; c&oacute;mo usar isakmpd
en combinaci&oacute;n con NAT ni nada parecido (ya que no lo he
probado).

<p>
Ahora, veamos el fichero de configuraci&oacute;n.  &Eacute;ste es el
fichero para la pasarela de seguridad gw.mysite.se:

<blockquote><pre>
# *****************************************************************
# ************* Fichero isakmpd.conf de gw.mysite.se **************
# *****************************************************************

# Una configuraci&oacute;n de muestra para el d&aelig;mon isakmpd de
# ISAKMP/Oakley (conocido como IKE)
[General]
Policy-File=            /etc/isakmpd/isakmpd.policy
Retransmits=            5
Exchange-max-time=      120
Listen-on=              10.0.0.1


# Aqu&iacute;, el nombre work-gw se usa s&oacute;lo como un nombre de
# secci&oacute;n y una etiqueta para usarlo en este fichero de
# configuraci&oacute;n, y no tiene porqu&eacute; ser el nombre real del
# anfitri&oacute;n ni el nombre de dominio del extremo de la
# conexi&oacute;n (pero podr&iacute;a serlo).  Fase 1, como ya
# sabr&aacute;, es la negociaci&oacute;n de una asociaci&oacute;n de
# seguridad ISAKMP (SA).  Deber&iacute;a haber un IP y un nombre por
# cada extremo con el que queramos comunicarnos.
[Phase 1]
10.0.0.2=               work-gw


# Fase 2 es la negociaci&oacute;n de SAs de IPsec.  Como en fase 1,
# aqu&iacute; el nombre es un nombre de secci&oacute;n que se
# usar&aacute; m&aacute;s tarde.  Puede ser una lista de nombres de
# secci&oacute;n separados por comas.  De este modo, si el
# tr&aacute;fico desde muchas redes (o anfitriones individuales)
# tuviera que ser reenviado a trav&eacute;s de este t&uacute;nel, la
# mayor&iacute;a de nombres de secci&oacute;n ser&iacute;an
# a&ntilde;adidos (y las correspondientes secciones nuevas m&aacute;s
# abajo).
[Phase 2]
Connections=            work-gw-my-gw


# Los siguientes par&aacute;metros son para negociaciones de SA de
# ISAKMP.  El nombre de secci&oacute;n es el anterior de la fase 1.  La
# etiqueta m&aacute;s interesante es la de ID.  La etiqueta ID
# est&aacute; configurada con el nombre de la secci&oacute;n, en donde
# se puede encontrar la informaci&oacute;n de la identidad sobre este
# anfitri&oacute;n, que se presentar&aacute; a los extremos que
# conecten.  Si la etiqueta ID no se encontrara disponible, isakmpd
# asumir&aacute; que se debe identificar a s&iacute; mismo usando la
# direcci&oacute;n IP.  N&oacute;tese que ya no hay ninguna etiqueta de
# autenticaci&oacute;n en esta configuraci&oacute;n.  Los datos de
# autenticaci&oacute;n se usan s&oacute;lo en el caso de claves
# precompartidas.
[work-gw]
Phase=                  1
Transport=              udp
Local-address=          10.0.0.1                # Local address
Address=                10.0.0.2                # Peer address
ID=                     my-ID
Configuration=          Default-main-mode


# &Eacute;stos son los datos de identidad.  ID-type tambi&eacute;n
# puede ser IPV4_ADDR (por definici&oacute;n), IPV4_ADDR_SUBNET o
# UFQDN.  La etiqueta Name se usa paraa FQDN y UFQDN;  para IPV4_ADDR
# se usar&iacute;a una etiqueta Address.  Para IPV4_ADDR_SUBNET se
# usar&iacute;a una etiqueta Network y Netmask.
[my-ID]
ID-type=                FQDN
Name=                   gw.mysite.se


# &Eacute;sta es la secci&oacute;n para la conexi&oacute;n IPsec.  El
# nombre de la secci&oacute;n viene de la lista en la secci&oacute;n
# anterior de fase 2.  ISAKMP-peer es, por supuesto, la etiqueta de
# nuestro extremo de conexi&oacute;n en la secci&oacute;n fase 1
# anterior.  Las etiquetas Local-ID y Remote-ID deben ser los nombres
# de las secciones que describen qu&eacute; paquetes se deben reenviar
# por el t&uacute;nel IPsec hacia la red remota.
[work-gw-my-gw]
Phase=                  2
ISAKMP-peer=            work-gw
Configuration=          Default-quick-mode
Local-ID=               Net-west
Remote-ID=              Net-east

# Cualquier paquete cuyo origen sea una m&aacute;quina en la red
# aqu&iacute; descrita...
[Net-west]
ID-type=                IPV4_ADDR_SUBNET
Network=                192.168.1.0
Netmask=                255.255.255.0

# ... y cuyo destino coincida con la red descrita aqu&iacute;,
# ser&aacute; cifrado y reenviado por el t&uacute;nel IPsec al sistema
# remoto.
[Net-east]
ID-type=                IPV4_ADDR_SUBNET
Network=                192.168.2.0
Netmask=                255.255.255.0

# Descripciones del modo principal


# Aqu&iacute; est&aacute;n los datos para el modo principal.  Usar
# aqu&iacute; DES no es una buena idea, ya que DES ya no est&aacute;
# considerado como un algoritmo de cifrado seguro.  3DES est&aacute;
# considerado como mucho m&aacute;s seguro debido a que tiene
# suficientes bits en la clave como para ser seguro.  Transforms es una
# lista de etiquetas que describen las transformaciones
# criptogr&aacute;ficas del modo principal.  En este ejemplo
# s&oacute;lo tenemos una.
[Default-main-mode]
DOI=                    IPSEC
EXCHANGE_TYPE=          ID_PROT
Transforms=             3DES-MD5


# Certificados almacenados en formato PEM.  Esta parte es importante
# cuando se usen certificados.  Los certificados CA deben estar en
# CA-directory (pero no la clave privada CA).  Cert-directory debe
# tener, al menos, el certificado para el anfitri&oacute;n local, pero
# tambi&eacute;n est&aacute;n permitidos otros certificados.  La clave
# privada debe ser la clave privada del anfitri&oacute;n local.
[X509-certificates]
CA-directory=           /etc/isakmpd/ca/
Cert-directory=         /etc/isakmpd/certs/
Private-key=            /etc/isakmpd/private/local.key

# Transformaciones criptogr&aacute;ficas del modo principal
####################################################

# Aqu&iacute; va nuestra transformaci&oacute;n del modo principal;  lo
# m&aacute;s importante aqu&iacute; es usar RSA_SIG como m&eacute;todo
# de autenticaci&oacute;n cuando se usen certificados.  Por el momento,
# es el &uacute;nico m&eacute;todo que tiene soporte cuando se usan
# certificados.  Las entidades comerciales en los EE.UU. tendr&aacute;n
# que esperar hasta septiembre de 2.000 para usarlo, debido a la
# patente de RSA.  Por suerte, yo no vivo en los EE.UU.  Tambi&eacute;n
# es importante la etiqueta GROUP_DESCRIPTION.  Debe coincidir con la
# etiqueta GROUP_DESCRIPTION en las transformaciones
# criptogr&aacute;ficas del modo r&aacute;pido descritas m&aacute;s
# adelante.  Aqu&iacute; la etiqueta Life se podr&iacute;a modificar.
# LIFE_60_SECS podr&iacute;a ser m&aacute;s corta de lo necesario para
# el uso normal.

[3DES-MD5]
ENCRYPTION_ALGORITHM=   3DES_CBC
HASH_ALGORITHM=         MD5
AUTHENTICATION_METHOD=  RSA_SIG
GROUP_DESCRIPTION=      MODP_1024
Life=                   LIFE_60_SECS,LIFE_1000_KB

# Descripci&oacute;n del modo r&aacute;pido
#############################

[Default-quick-mode]
DOI=                    IPSEC
EXCHANGE_TYPE=          QUICK_MODE
Suites=                 QM-ESP-3DES-MD5-PFS-SUITE

# Grupos de protecci&oacute;n del modo r&aacute;pido
######################################
# 3DES

[QM-ESP-3DES-MD5-PFS-SUITE]
Protocols=              QM-ESP-3DES-MD5-PFS

# 3DES

[QM-ESP-3DES-MD5-PFS]
PROTOCOL_ID=            IPSEC_ESP
Transforms=             QM-ESP-3DES-MD5-PFS-XF

# Transformaciones criptogr&aacute;ficas del modo r&aacute;pido

# No lo olvide.  GROUP_DESCRIPTION debe coincidir con GROUP_DESCRIPTION
# en el modo principal anterior.  Para reenviar paquetes entre dos
# redes (o desde un anfitri&oacute;n a una red) usamos el modo TUNNEL.
# Entre dos anfitriones tambi&eacute;n podemos usar el modo TRANSPORT.
[QM-ESP-3DES-MD5-PFS-XF]
TRANSFORM_ID=           3DES
ENCAPSULATION_MODE=     TUNNEL
AUTHENTICATION_ALGORITHM=       HMAC_MD5
GROUP_DESCRIPTION=      MODP_1024
Life=                   LIFE_60_SECS


# Como ya sabemos por la p&aacute;gina de manual de isakmpd.config,
# aqu&iacute; LIFE_DURATION es un valor de oferta (60), un valor
# m&iacute;nimo aceptable, y un valor m&aacute;ximo aceptable.  El
# ejemplo de isakmpd.conf tiene configurado esto a 600,450/720.  Este
# valor puede ser mejor para un uso normal.
[LIFE_60_SECS]
LIFE_TYPE=              SECONDS
LIFE_DURATION=          60,45:72

[LIFE_1000_KB]
LIFE_TYPE=              KILOBYTES
LIFE_DURATION=          1000,768:1536

# *****************************************************************
# ********* Fin del fichero isakmpd.conf de gw.mysite.se **********
# *****************************************************************
</pre></blockquote>

<p>
Hasta aqu&iacute; la configuraci&oacute;n para el sistema local.  El
sistema remoto se configura exactamente del mismo modo, s&oacute;lo que
al rev&eacute;s.  Por lo tanto, la primera parte del fichero
isakmpd.conf es diferente.  Echemos un vistazo a esa primera parte del
fichero isakmpd.conf para la pasarela de seguridad de gw.worksite.se:

<blockquote><pre>
# *****************************************************************
# ************* Fichero isakmpd.conf de gw.worksite.se ************
# *****************************************************************

[General]
Policy-File=            /etc/isakmpd/isakmpd.policy
Retransmits=            5
Exchange-max-time=      120
Listen-on=              10.0.0.2

[Phase 1]
10.0.0.1=               my-gw

[Phase 2]
Connections=            work-gw-my-gw

[my-gw]
Phase=                  1
Transport=              udp
Local-address=          10.0.0.2                # Local address
Address=                10.0.0.1                # Peer address
ID=                     work-ID
Configuration=          Default-main-mode

[work-ID]
ID-type=                FQDN
Name=                   gw.worksite.se

[work-gw-my-gw]
Phase=                  2
ISAKMP-peer=            my-gw
Configuration=          Default-quick-mode
Local-ID=               Net-east
Remote-ID=              Net-west

# *****************************************************************
# ************************ ... continuar&aacute; *************************
# *****************************************************************
</pre></blockquote>

<p>
No ha sido tan dif&iacute;cil, tal vez algo aburrido de leer.  La
siguiente parte es algo m&aacute;s interesante.


<p>
<h2>El fichero policy</h2>

<p>
El fichero <i>policy</i> puede ser algo confuso para alguien que no lo
haya usado con anterioridad, especialmente si las cosas no funcionan
como se espera.  La p&aacute;gina del manual de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&amp;sektion=5">isakmpd.policy(5)</a>
no est&aacute; tan mal.  Tal vez sea poco clara en algunas partes, pero
en general es buena.

<p>
El fichero <i>policy</i> m&aacute;s simple ser&iacute;a uno que
contuviera una &uacute;nica l&iacute;nea:

<blockquote><pre>
authorizer: &quot;POLICY&quot;
</pre></blockquote>

<p>
B&aacute;sicamente, esto significa que no hay limitaciones en
<i>policy</i> sobre qui&eacute;n puede conectar.  Por lo tanto, no es
una configuraci&oacute;n muy segura.  La etiqueta authorizer es para
indicar qui&eacute;n tiene la autorizaci&oacute;n para decidir la
pol&iacute;tica a seguir.  El autorizador especial &quot;POLICY&quot;
tiene la autoridad total sobre <i>policy</i>.  Cualquier otro authorizer
debe primero ser autorizado por &quot;POLICY&quot; para poder tener
cualquier autoridad.

<p>
Tambi&eacute;n puede haber un grupo de condiciones sobre qu&eacute;
est&aacute; autorizado.  El siguiente <i>policy</i> vendr&iacute;a a
decir que s&oacute;lo alguien que use el protocolo ESP con algo de
cifrado real, estar&iacute;a autorizado (bueno, alguien que usara DES
tambi&eacute;n estar&iacute;a autorizado aqu&iacute;, aunque DES casi
est&aacute; considerado como muy inseguro, se deja como ejercicio para
el lector el cambiar este fichero <i>policy</i> para no permitir tampoco
DES).  N&oacute;tese que cualquiera que cifre con ESP todav&iacute;a
estar&iacute;a autorizado.

<blockquote><pre>
authorizer: &quot;POLICY&quot;
conditions: app_domain ==&quot;IPsec policy&quot; &amp;&amp;
            esp_present ==&quot;yes&quot; &amp;&amp;
            esp_enc_alg !=&quot;null&quot; -&gt; &quot;true&quot;;
</pre></blockquote>

<p>
Tambi&eacute;n se puede &laquo;sublicenciar&raquo; la autoridad a
alguien m&aacute;s (podr&iacute;a ser una o m&aacute;s entidades).  El
caso simple ser&iacute;a el caso de la clave precompartida.  En ese
caso, cualquiera que sepa que la contrase&ntilde;a precompartida,
estar&aacute; autorizado.  Por lo tanto:

<blockquote><pre>
authorizer: &quot;POLICY&quot;
licensees:  &quot;contrase&ntilde;a:algo muy secreto&quot;
conditions: app_domain ==&quot;IPsec policy&quot; &amp;&amp;
            esp_present ==&quot;yes&quot; &amp;&amp;
            esp_enc_alg !=&quot;null&quot; -&gt; &quot;true&quot;;
</pre></blockquote>

<p>
Esto autorizar&iacute;a a cualquiera que supiera esta contrase&ntilde;a
para conectar y cumplir con las condiciones (pero hay que recordar que
la contrase&ntilde;a tambi&eacute;n se debe activar en la etiqueta
Authentication de isakmpd.conf).

<p>
Hasta ahora, nada complicado.  Ahora viene la parte interesante.
Primero, puede haber muchos con licencias, aunque deben estar todos
autorizados por &quot;POLICY&quot;.  Adem&aacute;s, aqu&eacute;llos que
dispongan de licencias y est&eacute;n autorizados, pueden
&laquo;sublicenciar&raquo; a otros.  Un licenciado puede ser simplemente
una cadena si est&aacute; m&aacute;s descrito en el fichero
<i>policy</i>:

<blockquote><pre>
authorizer: &quot;POLICY&quot;
licensees:  &quot;subpolicyAH&quot; ||  &quot;subpolicyESP&quot;
conditions: app_domain ==&quot;IPsec policy&quot; -&gt; &quot;true&quot;;

authorizer: &quot;subpolicyESP&quot; 
licensees:  &quot;contrase&ntilde;a:algo muy secreto&quot;
conditions: esp_present ==&quot;yes&quot; -&gt; &quot;true&quot;;

authorizer: &quot;subpolicyAH&quot; 
licensees:  &quot;contrase&ntilde;a:algo muy secreto&quot;
conditions: ah_present ==&quot;yes&quot; -&gt; &quot;true&quot;;
</pre></blockquote>

<p>
Y ahora, a por lo que todos estaban esperando.  <i>policy</i>
tambi&eacute;n se puede sublicenciar o delegar a una clave.  En este
caso suele ser un certificado X.509.  El uso m&aacute;s simple de
certificados ser&iacute;a usarlos como las contrase&ntilde;as.
Simplemente introducimos certificados de usuarios individuales en el
fichero <i>policy</i>:

<blockquote><pre>
keynote-version: 2
comment: This is an example of a policy delegating to a key.
authorizer: &quot;POLICY&quot;
licensees: &quot;x509-base64:\
        MIIBsTCCARoCAQAwDQYJKoZIhvcNAQEEBQAwITELMAkGA1UEBhMCc2UxEjAQBgNV\
        BAMTCUlLRUxBQiBDQTAeFw0wMDAxMjgxNzQyMTZaFw0wMTAxMjcxNzQyMTZaMCEx\
        CzA           Esto es un certificado de usuario             AQEB\
        BQA                                                         IUuz\
        eOW8P5UGJUH2JVkiA2CTDryFf0CHYwd2P003dtVYw5RvET7XLMpRZiCcWtBdxneW\
        ct+016zUBP/cQMMl+KownxAUq9ezA8GvTyUWC97SOMOgoVj/QR3FHmEjpUi3AgMB\
        AAEwDQYJKoZIhvcNAQEEBQADgYEALGShaAxHvGncev0iFnKrJI4x5T4vlaMP1ad+\
        iWLV5q9H3wickVGN0NPerq0YLwx/VA9WaecYN8V+ALtNKYPuDiT11zwvE8GQeaai\
        NuzgmQ9hh3GifEgN9VEiC3j4kTytonKr0Q+vTLM7xYzheOxvrtUErRwZ9Xs1KzHe\
        yiXHSU8=&quot;
conditions: app_domain ==&quot;IPsec policy&quot; &amp;&amp;
            esp_present ==&quot;yes&quot; &amp;&amp;
            esp_enc_alg !=&quot;null&quot; -&gt; &quot;true&quot;;
</pre></blockquote>

<p>
Esto, obviamente, es una idea est&uacute;pida si hay muchos usuarios.
Los certificados que isakmpd lee de los directorios CA- y Certificate, y
los certificados recibidos desde el otro extremo de la conexi&oacute;n
se convierten en pseudocredenciales.  Estos certificados convertidos en
pseudocredenciales ser&iacute;an algo as&iacute;:

<blockquote><pre>

authorizer: &quot;x509-base64:\
        MIIBsTCCARoCAQAwDQYJKoZIhvcNAQEEBQAwITELMAkGA1UEBhMCc2UxEjAQBgI2\
	CzA    Esto es la clave/certificado p&uacute;blico del firmante    AQEB\
        BQA      del certificado de usuario (El certificado CA)     IUuz\
        eOW8P5UGJUH2JVkiA2CTDryFf0CHYwd2P003dtVYw5RvET7XLMpRZiCcWtBdxneW\
        ct+016zUBP/cQMMl+KownxAUq9ezA8GvTyUWC97SOMOgoVj/QR3FHmEjpUi3AgMB\
        AAEwDQYJKoZIhvcNAQEEBQADgYEALGShaAxHvGncev0iFnKrJI4x5T4vlaMP1ad+\
        iWLV5q9H3wickVGN0NPerq0YLwx/VA9WaecYN8V+ALtNKYPuDiT11zwvE8GQeaai\
        NuzgmQ9hh3GifEgN9VEiC3j4kTytonKr0Q+vTLM7xYzheOxvrtUErRwZ9Xs1KzHe\
        yiXHSU8=&quot;
licensees:  &quot;x509-base64:\
        MIIBsTCCARoCAQAwDQYJKoZIhvcNAQEEBQAwITELMAkGA1UEBhMCc2UxEjAQBgNV\
        BAMTCUlLRUxBQiBDQTAeFw0wMDAxMjgxNzQyMTZaFw0wMTAxMjcxNzQyMTZaMCEx\
        CzA              Esto es la clave del asunto del            AQEB\
        BQA                        certificado                      IUuz\
        eOW8P5UGJUH2JVkiA2CTDryFf0CHYwd2P003dtVYw5RvET7XLMpRZiCcWtBdxneW\
        ct+016zUBP/cQMMl+KownxAUq9ezA8GvTyUWC97SOMOgoVj/QR3FHmEjpUi3AgMB\
        AAEwDQYJKoZIhvcNAQEEBQADgYEALGShaAxHvGncev0iFnKrJI4x5T4vlaMP1ad+\
        iWLV5q9H3wickVGN0NPerq0YLwx/VA9WaecYN8V+ALtNKYPuDiT11zwvE8GQeaai\
        NuzgmQ9hh3GifEgN9VEiC3j4kTytonKr0Q+vTLM7xYzheOxvrtUErRwZ9Xs1KzHe\
        yiXHSU8=&quot;
conditions: app_domain ==&quot;IPsec policy&quot; -&gt; &quot;true&quot;;
</pre></blockquote>

<p>
N&oacute;tese que &eacute;stos no est&aacute;n autorizados por
&quot;POLICY&quot; y por lo tanto no tendr&aacute;n ning&uacute;n efecto
sin que est&eacute;n de alguna manera autorizados.  Adem&aacute;s, esto
muestra lo que le ocurre internamente a los certificados.  La credencial
anterior no se ve en el fichero <i>policy</i>.  Sin embargo, se puede
dar una sublicencia a tales credenciales.  Recu&eacute;rdese el tema
sobre sublicencias.  Es posible dar licencias a todos los certificados
que est&eacute;n firmados por una cierta CA, poniendo el certificado de
la CA como un licenciado de &quot;POLICY&quot;:

<blockquote><pre>
keynote-version: 2
comment: This is an example of a policy delegating to a key.
authorizer: &quot;POLICY&quot;
licensees: &quot;x509-base64:\
        MIIBsTCCARoCAQAwDQYJKoZIhvcNAQEEBQAwITELMAkGA1UEBhMCc2UxEjAQBgNV\
        BAMTCUlLRUxBQiBDQTAeFw0wMDAxMjgxNzQyMTZaFw0wMTAxMjcxNzQyMTZaMCEx\
        CzA                 Esto es un certificado CA               AQEB\
        BQA                                                         IUuz\
        eOW8P5UGJUH2JVkiA2CTDryFf0CHYwd2P003dtVYw5RvET7XLMpRZiCcWtBdxneW\
        ct+016zUBP/cQMMl+KownxAUq9ezA8GvTyUWC97SOMOgoVj/QR3FHmEjpUi3AgMB\
        AAEwDQYJKoZIhvcNAQEEBQADgYEALGShaAxHvGncev0iFnKrJI4x5T4vlaMP1ad+\
        iWLV5q9H3wickVGN0NPerq0YLwx/VA9WaecYN8V+ALtNKYPuDiT11zwvE8GQeaai\
        NuzgmQ9hh3GifEgN9VEiC3j4kTytonKr0Q+vTLM7xYzheOxvrtUErRwZ9Xs1KzHe\
        yiXHSU8=&quot;
conditions: app_domain ==&quot;IPsec policy&quot; &amp;&amp;
            esp_present ==&quot;yes&quot; &amp;&amp;
            esp_enc_alg !=&quot;null&quot; -&gt; &quot;true&quot;;
</pre></blockquote>

<p>
El fichero <i>policy</i> que hemos visto es un simple ejemplo de fichero
<i>policy</i> que delega en una CA.  Cualquier usuario que tenga un
certificado firmado por la CA de este certificado, y que adem&aacute;s
cumpla las otras condiciones configuradas en <i>policy</i> y en el
fichero de configuraci&oacute;n, estar&aacute; autorizado.


<p>
<h2>Casi seguro... &iexcl;no es seguro!</h2>

<p>
Desafortunadamente, esto no es suficiente para estar realmente seguro.
Hay formas para atacar una pasarela de seguridad configurada de esta
forma.  Si alguien no quiere leer los detalles, puede pasar a la
secci&oacute;n siguiente ahora.  Para el resto, intentaremos entender
porqu&eacute; esto no es seguro.  No es dif&iacute;cil.

<p>
Consideremos a qu&eacute; informaci&oacute;n tiene acceso en este
momento uno de los isakmpd.  Del fichero de configuraci&oacute;n,
isakmpd sabemos cu&aacute;l es el IP-address desde el que se
conectar&aacute;n (en la secci&oacute;n Fase 1).  De la
informaci&oacute;n que obtiene durante la negociaci&oacute;n de la fase
1, sabe el ID con el que el extremo que se conecta presenta a s&iacute;
mismo y el certificado que obtiene desde ese extremo de la
conexi&oacute;n prueba que que ese ID le pertenece.

<p>
Si la informaci&oacute;n del ID era el IP (si no ponemos una
secci&oacute;n ID en fase 1, &eacute;sta es la
situaci&oacute;n por definici&oacute;n), todo va bien.  La CA
habr&aacute; vinculado el IP al certificado, y el IP en la
configuraci&oacute;n ser&aacute; toda la informaci&oacute;n que
necesitemos.  Un impostor podr&iacute;a usar el mismo IP de otra
m&aacute;quina en algunos casos (por ejemplo, si ambas m&aacute;quinas
estuvieran en la misma red local y la m&aacute;quina que tuviera este IP
estuviera fuera de servicio por cualquier motivo).  Sin embargo, el
impostor no podr&iacute;a tener un certificado y la correspondiente
clave privada que probara que este IP pertenece al impostor.

<p>
Si esto ocurriera alguna vez, el impostor habr&iacute;a conseguido robar
la clave privada del aut&eacute;ntico propietario del IP, o el impostor
habr&iacute;a conseguido enga&ntilde;ar la CA para que le diera un
certificado que contuviera informaci&oacute;n falsa.  En el primer caso
significar&iacute;a que la clave privada no se habr&iacute;a protegido
lo suficientemente bien, y en el segundo la CA habr&iacute;a fallado al
comprobar la identidad del impostor como debiera (o la
informaci&oacute;n del ID del certificado) o la clave privada de la CA
no habr&iacute;a estado bien protegida.  Como todo esto son
prerrequisitos para que la seguridad funcione, ninguna de estas
situaciones deber&iacute;a suceder nunca.

<p>
En nuestro ejemplo la situaci&oacute;n es diferente.  Aqu&iacute;
tenemos un FQDN en el certificado en lugar de una direcci&oacute;n IP.
Como todav&iacute;a tenemos una direcci&oacute;n IP en la secci&oacute;n
de fase 1, tenemos por tanto un posible problema de seguridad.  Lo que
ocurrir&iacute;a durante la negociaci&oacute;n de fase 1 de ISAKMP
ser&iacute;a que podr&iacute;amos comprobar que el extremo de la
conexi&oacute;n se hubiera llevado a cabo desde el IP supuesto (pero
como hemos explicado anteriormente, en algunos casos se podr&iacute;a
falsificar).  Podr&iacute;amos comprobar que ese ID que presenta nuestro
extremo de la conexi&oacute;n realmente pertenece a &eacute;ste.  Pero
lo que no podr&iacute;amos comprobar ahora ser&iacute;a si ese ID es
realmente el ID que suponemos, porque isakmpd nunca ha sabido qu&eacute;
ID deber&iacute;a ser.

<p>
Alguien podr&iacute;a decir que el sistema de DNS ata el IP al FQDN para
el anfitri&oacute;n.  Es cierto, sin embargo el sistema de DNS actual no
es seguro y se le puede, bajo ciertas circunstancias, enga&ntilde;ar
para que entregue informaci&oacute;n falsa (o podr&iacute;a ser
v&iacute;ctima de una ataque de &laquo;denegaci&oacute;n de
servicio&raquo; (DoS, &quot;Denial of Service&quot;) por parte de un
atacante, y la m&aacute;quina del atacante podr&iacute;a falsificar la
respuesta del servidor de DNS).  DNS seguro aparecer&aacute; en el
futuro, pero todav&iacute;a no est&aacute; aqu&iacute; (o por lo menos
la mayor&iacute;a de servidores de DNS todav&iacute;a no son seguros);
por lo tanto, hoy en d&iacute;a, el uso de DNS para comprobar si el FQDN
en el certificado corresponde al IP supuesto, no es una garant&iacute;a.
De hecho, isakmpd no lo comprueba con DNS.  Aun cuando DNS fuera seguro,
la comprobaci&oacute;n no servir&iacute;a en el caso de usar un UFQDN.

<p>
As&iacute; pues, en caso de tener un FQDN como ID, ser&iacute;a posible
que un atacante obtuviese su propia clave privada y que &eacute;sta
estuviera firmada por la misma CA que usamos nosotros (pero con el FQDN
del atacante).  Y podr&iacute;a lanzar un ataque DoS sobre nuestra
conexi&oacute;n para hacerla caer (de hecho, existen unos agujeros en el
mismo protocolo ISAKMP, que probablemente se podr&iacute;n usar para
lanzar un ataque DoS remoto contra la conexi&oacute;n y hacerla caer,
aunque no s&eacute; qu&eacute; sensibles a estos ataques ser&iacute;a
isakmpd).  Entonces, el atacante podr&iacute;a configurar su propia
m&aacute;quina del mismo modo que la de nuestra conexi&oacute;n,
conectarla a la red de nuestra conexi&oacute;n, e intentar conectarse
mediante su ID, clave privada y certificado propios.

<p>
Nuestro isakmpd no habr&iacute;a sido informado sobre qu&eacute; ID por
nuestra conexi&oacute;n (debido a que el atacante est&aacute;
configurado de forma id&eacute;ntica a nuestra conexi&oacute;n, aparte
del certificado, ID y clave privada).  Nuestro isakmpd podr&iacute;a
comprobar que el certificado estuviera firmado por la misma CA (pero la
mayor&iacute;a de CAs firman muchos certificados, y un certificado no es
tan dif&iacute;cil de conseguir), y que el ID presentado fuera el mismo
que el ID en el certificado.  Sin embargo, con la configuraci&oacute;n
presentada hasta ahora, no comprobar&iacute;a que este ID fuera el
supuesto.  Por lo tanto, el atacante tendr&iacute;a permiso para
conectar.

<p>
<h3>Prevenir el ataque</h3>

<p>
Ahora la cuesti&oacute;n es, &iquest;c&oacute;mo podemos informar a
isakmpd sobre qu&eacute; ID debe esperar?  Por suerte esto es
f&aacute;cil, y est&aacute; documentado en la p&aacute;gina del manual
de <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&amp;sektion=5">isakmpd.policy(5)</a>.
Debemos hacer la comprobaci&oacute;n en <i>policy</i>, como sigue:

<blockquote><pre>
keynote-version: 2
comment: This is an example of a policy delegating to a key.
authorizer: &quot;POLICY&quot;
licensees: &quot;x509-base64:\
        MIIBsTCCARoCAQAwDQYJKoZIhvcNAQEEBQAwITELMAkGA1UEBhMCc2UxEjAQBgNV\
        BAMTCUlLRUxBQiBDQTAeFw0wMDAxMjgxNzQyMTZaFw0wMTAxMjcxNzQyMTZaMCEx\
        CzA                Esto es un certificado CA                AQEB\
        BQA                                                         IUuz\
        eOW8P5UGJUH2JVkiA2CTDryFf0CHYwd2P003dtVYw5RvET7XLMpRZiCcWtBdxneW\
        ct+016zUBP/cQMMl+KownxAUq9ezA8GvTyUWC97SOMOgoVj/QR3FHmEjpUi3AgMB\
        AAEwDQYJKoZIhvcNAQEEBQADgYEALGShaAxHvGncev0iFnKrJI4x5T4vlaMP1ad+\
        iWLV5q9H3wickVGN0NPerq0YLwx/VA9WaecYN8V+ALtNKYPuDiT11zwvE8GQeaai\
        NuzgmQ9hh3GifEgN9VEiC3j4kTytonKr0Q+vTLM7xYzheOxvrtUErRwZ9Xs1KzHe\
        yiXHSU8=&quot;
conditions: app_domain ==&quot;IPsec policy&quot; &amp;&amp;
            esp_present ==&quot;yes&quot; &amp;&amp;
            esp_enc_alg !=&quot;null&quot; &amp;&amp;
            remote_id ==&quot;gw.worksite.se&quot; -&gt; &quot;true&quot;;
</pre></blockquote>

<p>
Ahora s&oacute;lo gw.worksite.se podr&iacute;a obtener una
conexi&oacute;n IPsec.  Se pueden a&ntilde;adir m&aacute;s permisos para
otros IDs, a&ntilde;adiendo m&aacute;s comprobaciones remote_id
alternativas, o sea, teniendo condiciones en el fichero <i>policy</i>
como &eacute;sta:

<blockquote><pre>
conditions: app_domain ==&quot;IPsec policy&quot; &amp;&amp;
            esp_present ==&quot;yes&quot; &amp;&amp;
            esp_enc_alg !=&quot;null&quot; &amp;&amp;
            (remote_id ==&quot;gw.worksite.se&quot;  ||
               remote_id ==&quot;gw.whatsite.se&quot;) -&gt; &quot;true&quot;;
</pre></blockquote>

<p>
Con esta <i>policy</i> podr&iacute;an conectar tanto gw.worksite.se,
como gw.somesite.se, como gw.whatsite.se.

<p>
Algunos afirman que es desafortunado que tengan que haber certificados
enteros introducidos en <i>policy</i>.  Reformatear los certificados en
el formato de <i>policy</i> requiere algo de esfuerzo, y hace que
<i>policy</i> sea poco legible.  Si alguien substituyera por error, un
certificado de usuario con el correspondiente certificado de CA en
alguna parte de un fichero <i>policy</i> complejo, podr&iacute;a
provocar que usuarios no autorizados obtuvieran permiso para conectar en
algunos casos y, a&uacute;n peor, no ser&iacute;a f&aacute;cilmente
detectable leyendo el fichero <i>policy</i> (porque los certificados
X.509 no est&aacute;n en un formato humano legible).

<p>
Para aquellos a quienes les gusta estar al borde del precipicio, existe
una soluci&oacute;n a este problema.  Ahora se puede usar el certificado
&laquo;Nombre Distinguido&raquo; (DN, &quot;Distinguished Name&quot;) en
lugar de un certificado en <i>policy</i> (por supuesto que el
correspondiente certificado debe estar disponible desde los directorios
cert o ca del disco, de modo que isakmpd lo pueda encontrar).  Con este
formato, el fichero <i>policy</i> anterior acabar&iacute;a siendo algo
as&iacute;:

<blockquote><pre>  
keynote-version: 2
comment: This is an example of a policy delegating to a key.
authorizer: &quot;POLICY&quot;
licensees: &quot;DN:/C=se/CN=IKELAB CA&quot;
conditions: app_domain ==&quot;IPsec policy&quot; &amp;&amp;
            esp_present ==&quot;yes&quot; &amp;&amp;
            esp_enc_alg !=&quot;null&quot; &amp;&amp;
            (remote_id ==&quot;gw.worksite.se&quot;  ||
             remote_id ==&quot;gw.somesite.se&quot;  ||
             remote_id ==&quot;gw.whatsite.se&quot;) -&gt; &quot;true&quot;;
</pre></blockquote>

<p>
Mucho m&aacute;s legible, &iquest;o no?  La informaci&oacute;n sobre lo
que es el exacto DN para un certificado se puede encontrar mirando al
certificado, usando la utilidad openssl:

<blockquote><tt>
$ <b>openssl x509 -text &lt; ca.crt</b>
</tt></blockquote>

<p>
Se pueden hacer configuraciones de <i>policy</i> m&aacute;s complicadas
pero esto es suficiente para empezar, y todav&iacute;a hay otro ejemplo
en la siguiente secci&oacute;n.

<p>
Esto deber&iacute;a proveer de la informaci&oacute;n necesaria sobre el
certificado en ca.crt.  Esto ser&aacute; bueno siempre que tengamos un
fichero <i>policy</i> peque&ntilde;o o, por lo menos, uno razonable.
Sin embargo, todav&iacute;a no es suficiente si tenemos un sitio enorme
con muchos usuarios que deban tener permiso de conexi&oacute;n.


<p>
<h2>Configuraciones de multiusuario y/o autorizaci&oacute;n
centralizada</h2>

<p>
Veamos ahora algunas caracter&iacute;sticas interesantes de isakmpd.
Hasta ahora hemos asumido que el supuesto extremo remoto de la
conexi&oacute;n era conocido y ten&iacute;a una direcci&oacute;n IP
est&aacute;tica.  Esto no siempre es as&iacute;.  Muchas personas usan
IPs asignados de forma din&aacute;mica, o usan muchas m&aacute;quinas
diferentes.  En otros casos, como en el caso de los servidores,
podr&iacute;amos no estar seguros de qui&eacute;n quiere conectar.

<p>
Por lo tanto, una funcionalidad interesante de isakmpd es que puede usar
en la secci&oacute;n de fase 1 una etiqueta predefinida en lugar de un
IP, permitiendo de este modo negociaciones isakmpd desde cualquier IP.
Esto se har&iacute;a del siguiente modo:

<blockquote><pre>
[phase 1]
Default=        work-gw
</pre></blockquote>

<p>
Primero, hay que decir que esta configuraci&oacute;n podr&iacute;a no
ser segura frente a ataques de DoS.  Como se ha dicho anteriormente,
existen algunos agujeros en los protocolos ISAKMP/IKE.  De todos modos,
el uso de una secci&oacute;n de fase 1 predefinida tambi&eacute;n nos
permite usar un tipo de &laquo;certificados de
autorizaci&oacute;n&raquo;.

<p>
Imaginemos que tuvi&eacute;ramos muchos usuarios autorizados, pero que
no acept&aacute;ramos a cualquier usuario, como podr&iacute;a ocurrir en
una compa&ntilde;&iacute;a.  Nos gustar&iacute;a que los empleados
tuvieran permiso para conectar, pero nadie m&aacute;s.  Ahora imaginemos
que la compa&ntilde;&iacute;a tuviera miles de empleados, y que
quisi&eacute;ramos que todos ellos pudieran conectar desde cualquier
m&aacute;quina (no s&oacute;lo desde dentro de la red de la
compa&ntilde;&iacute;a), pero que no todos tuvieran permiso para hacer
cualquier cosa.  Se podr&iacute;a escribir un fichero <i>policy</i> como
&eacute;ste:

<blockquote><pre>
keynote-version: 2
authorizer: &quot;POLICY&quot;
licensees: &quot;telnet@@work&quot; || &quot;telnet@@lab&quot; || &quot;pop3@@work&quot; 
conditions: app_domain ==&quot;IPsec policy&quot; &amp;&amp;
            esp_present ==&quot;yes&quot; &amp;&amp;
            esp_enc_alg !=&quot;null&quot; &amp;&amp;
            remote_id_type ==&quot;UFQDN&quot; &amp;&amp;
            (remote_id ==&quot;telnet@@worksite.se&quot;  ||
             remote_id ==&quot;pop3@@worksite.se&quot;  ||
             remote_id ==&quot;telnet@@lab.worksite.se&quot;) -&gt; &quot;true&quot;;

authorizer: &quot;telnet@@work&quot;
licensees: &quot;DN:/C=se/CN=IKELAB CA&quot;
conditions: remote_id ==&quot;telnet@@worksite.se&quot; &amp;&amp;
            local_filter_type ==&quot;IPv4 address&quot; &amp;&amp;
            local_filter_port ==&quot;23&quot; &amp;&amp;
            local_filter ==&quot;192.168.002.003&quot;

authorizer: &quot;telnet@@lab&quot;
licensees: &quot;DN:/C=se/CN=IKELAB CA&quot;
conditions: remote_id ==&quot;telnet@@lab.worksite.se&quot; &amp;&amp;
            local_filter_type ==&quot;IPv4 address&quot; &amp;&amp;
            local_filter_port ==&quot;23&quot; &amp;&amp;
            local_filter ==&quot;192.168.002.002&quot; -&gt; &quot;true&quot;;

authorizer: &quot;pop3@@work&quot;
licensees: &quot;DN:/C=se/CN=IKELAB CA&quot;
conditions: local_filter_type ==&quot;IPv4 address&quot; &amp;&amp;
            local_filter_port ==&quot;110&quot; &amp;&amp;
            local_filter ==&quot;192.168.002.003&quot; &amp;&amp;
            remote_id ==&quot;telnet@@worksite.se&quot; -&gt; &quot;true&quot;;
</pre></blockquote>

<p> 
Puede que esto no sea exactamente como deber&iacute;a ser.  Por lo que
s&eacute;, no est&aacute; comprobado (de hecho, estas condiciones de
filtros podr&iacute;an no funcionar como espero).  Adem&aacute;s, un
fichero <i>policy</i> como &eacute;ste (cualquiera con un IP del extremo
de la conexi&oacute;n predefinido) requerir&iacute;a reescribir partes
del fichero isakmpd.conf tambi&eacute;n.  Esto conllevar&iacute;a
algunas implicaciones en la seguridad.  Para este tipo de conexiones en
las que cualquiera debe tener permiso para conectar, es probablemente
deseable grabar el DN de cualquiera que conecte.  Que yo sepa, isakmpd
todav&iacute;a no tiene soporte para esto.  Adem&aacute;s,
tambi&eacute;n podr&iacute;a tener otras implicaciones en la seguridad.
De cualquier modo la idea b&aacute;sica est&aacute; clara.

<p> 
Por si acaso alguien no ha visto las interesantes posibilidades que esto
tiene: Si todas la m&aacute;quinas que usan ISAMKP/IKE de este modo
tuvieran un grupo de condiciones est&aacute;ndar para todos los
servicios que los usuarios quisieran usar de forma remota, la CA
podr&iacute;a autorizar a los usuarios poniendo las extensiones
subjectAltName correctas en sus certificados.  Adem&aacute;s, la fecha
de caducidad para estos certificados se podr&iacute;a configurar para
que caducara a menudo, aunque los usuarios podr&iacute;an obtener nuevos
certificados cuando sus certificados actuales estuvieran a punto de
caducar.  Si los usuarios hicieran un mal uso de sus autorizaciones,
bastar&iacute;a con no volver a emitir los certificados para que no
pudieran acceder despu&eacute;s de la fecha de caducidad.  No
ser&iacute;a necesario cambiar los ficheros <i>policy</i> en todas las
m&aacute;quinas simplemente porque un empleado, por ejemplo, dejara el
trabajo.  El mismo esquema podr&iacute;a funcionar para
prop&oacute;sitos distintos a ISAKMP/IPsec (¡incluida la
autorizaci&oacute;n para sistemas fuera de la conexi&oacute;n!), aunque
eso requerir&iacute;a un software especial.  En cualquier caso,
cualquier organizaci&oacute;n que hiciera esto es probable que
tambi&eacute;n quisiera ser su propia CA.

<p>
Las configuraciones de multiusuarios (usuarios m&oacute;viles) como
&eacute;sta, tambi&eacute;n son posibles con claves precompartidas, pero
entonces se requiere que se use el modo AGGRESSIVE en lugar del modo
ID_PROT, ya que en este caso necesitaremos poder escoger la frase de la
contrase&ntilde;a correcta basada en el ID, debido a que en este caso no
lo podemos saber por el ID (en modo AGGRESSIVE el ID se env&iacute;a
durante un estado m&aacute;s temprano de la negociaci&oacute;n, pero se
env&iacute;a descifrado, por lo tanto el modo AGGRESSIVE es m&aacute;s
r&aacute;pido porque necesita menos intercambios de mensajes, pero
tambi&eacute;n es un poco menos seguro debido a que el ID se
env&iacute;a en claro).


<p>
<a name="IKEcl"></a>
<h2>13.9 - &iquest;Qu&eacute; clientes IKE son compatibles con
isakmpd?</h2>

<p>
<code>isakmpd</code> es el d&aelig;mon de la gesti&oacute;n de claves de
ISAKMP/Oakley que viene con OpenBSD.  Sospechamos que interacciona, por
lo menos en parte, con la mayor&iacute;a de implementaciones ISAKMP,
pero s&oacute;lo los siguientes han sido comprobados.  N&oacute;tese que
algunos software isakmp que puede encontrar est&aacute;n basados en el
d&aelig;mon iskamp de OpenBSD.

<p>
Los siguientes clientes para MS-Windows son compatibles seg&uacute;n los
informes recibidos:

<ul>
<!--  <li><a href="http://www.timestep.com/">TimeStep</a> PERMIT/Client -->
<li><a href="http://www.ashleylaurent.com/">Ashley Laurent</a> VPN
software
<li><a href="http://www.pgp.com/">PGP VPN</a> software
<li><a href="http://www.ssh.com/">SSH Sentinel</a> IPsec client
<li><a href="http://www.cisco.com/">Cisco</a> IRE client
<li><a href="http://www.microsoft.com">Microsoft</a> Windows 2000 y XP
</ul>

<p>
Las siguientes pasarelas/enrutadores son compatibles seg&uacute;n los
informes recibidos:

<ul>
<li><a href="http://www.cisco.com/">Cisco</a> IOS
<li><a href="http://www.cisco.com/">Cisco</a> PIX
<li><a href="http://www.intel.com/">Intel</a> LanRover
<!-- <li><a href="http://www.timestep.com/">TimeStep</a> PERMIT/Gate -->
<li><a href="http://www.cendio.com/">Cendio</a> Fuego
<li><a href="http://www.kame.net/">KAME</a> para FreeBSD
<li><a href="http://www.xs4all.nl/~freeswan/">FreeS/WAN</a> para Linux
<li><a href="http://www.symantec.com/">Symantec</a> Raptor
<li><a href="http://www.ericsson.com/">Ericsson</a> eBox
<li><a href="http://www.f-secure.com/">F-Secure</a> VPN+
<li><a href="http://www.teamware.com/">Teamware</a> TWISS
<li><a href="http://www.3com.com/">3com</a> Pathbuilder
<li><a href="http://www.nortelnetworks.com/">Nortel</a> Contivity
<li><a href="http://www.checkpoint.com/">CheckPoint</a> FW-1
<li><a href="http://www.watchguard.com/">Watchguard</a> Firebox III
<li><a href="http://www.lucent.com/">Lucent</a> Access Point
</ul>


<p>
<a name="Trouble"></a>
<h2>13.10 - Resoluci&oacute;n de problemas de IPsec/VPN</h2>

<p>
Para resolver problemas, la primera herramienta que se debe usar es
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8">tcpdump(8)</a>.
Usaremos <code>tcpdump</code> para buscar varias cosas.

<p>
Si estamos usando tcpdump en OpenBSD, disponemos de una versi&oacute;n
mejorada de tcpdump que puede mostrarnos algo de informaci&oacute;n
sobre paquetes ESP y AH.  Si estamos usando tcpdump desde OpenBSD 2.5 o
desde otro sistema operativo, es posible que tengamos una versi&oacute;n
anticuada que s&oacute;lo nos muestre el n&uacute;mero del protocolo
para AH o ESP (el protocolo IP de ESP es 50, y el de AH es 51).

<ul>
<li>Con tcpdump podemos mirar si el tr&aacute;fico est&aacute; usando
AH/ESP o texto en claro.  Si nuestro tr&aacute;fico es en texto en
claro, entonces nuestro flujos est&aacute;n configurados de modo
incorrecto, o nuestro isakmp no est&aacute; negociando como debiera.  En
tal caso usaremos
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8">ping(8)</a>
para generar tr&aacute;fico simple.
<p>
Por ejemplo, yo tengo dos m&aacute;quinas anfitrionas, 208.1.1.1 y
208.2.2.2.  Ingreso en 208.2.2.2 y hago lo siguiente:
<pre>
# <b>ping -c 3 208.1.1.1</b>
PING esp.mil (208.1.1.1): 56 data bytes
64 bytes from 208.1.1.1: icmp_seq=0 ttl=255 time=190.155 ms
64 bytes from 208.1.1.1: icmp_seq=1 ttl=255 time=201.040 ms
64 bytes from 208.1.1.1: icmp_seq=2 ttl=255 time=165.481 ms
--- esp.mil ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 165.481/185.558/201.040 ms
</pre>
<p>
Y en otra sesi&oacute;n puedo ver mis &quot;pings&quot; encapsulados:
<pre>
# <b>tcpdump -ni fxp7 host 208.1.1.1</b>
tcpdump: listening on fxp7
14:12:19.630274 esp 208.2.2.2 &gt; 208.1.1.1 spi 0x00001000 seq 4535 len 116
14:12:19.813519 esp 208.1.1.1 &gt; 208.2.2.2 spi 0x00001001 seq 49313 len 116
14:12:20.630277 esp 208.2.2.2 &gt; 208.1.1.1 spi 0x00001000 seq 4536 len 116
14:12:20.832458 esp 208.1.1.1 &gt; 208.2.2.2 spi 0x00001001 seq 49314 len 116
14:12:21.630273 esp 208.2.2.2 &gt; 208.1.1.1 spi 0x00001000 seq 4537 len 116
<b>^C</b>
1831 packets received by filter
0 packets dropped by kernel
</pre>

<p>
<li>ISAKMP va por el puerto UDP 500.  Si este puerto est&aacute;
bloqueado por un cortafuegos o filtro de paquetes, entonces debemos
cambiarlo.

<blockquote><pre>
# Passing in ISAKMP traffic from the security gateways
pass in on ne0 proto udp from gatewB/32 port = 500 to gatewA/32 port = 500
pass out on ne0 proto udp from gatewA/32 port = 500 to gatewB/32 port = 500

# Passing in encrypted traffic from security gateways
pass in proto esp from gatewB/32 to gatewA/32
pass out proto esp from gatewA/32 to gatewB/32
</pre></blockquote>

<p>
<li>Para activar todo el depurado de utilidad en isakmpd, lo iniciamos
como

<blockquote><tt>
# <b>/sbin/isakmpd -d -DA=90</b>
</tt></blockquote>

<p>
o (para saltar la informaci&oacute;n m&aacute;s detallada de depurado
del temporizador)

<blockquote><tt>
# <b>/sbin/isakmpd -d -DA=90 -D1=70</b>
</tt></blockquote>

<p>
<li>Debemos permitir el paso a nuestra net A con cortafuegos del
tr&aacute;fico que ha sido procesado por IPsec.

<blockquote><pre>
# Passing in traffic from the designated subnets.
pass in on enc0 from netB/netBmask to netA/netAmask
</pre></blockquote>

<p>
<li>Con tcpdump en OpenBSD podemos descodificar la mayor parte del texto
en claro de las sesiones IKE.  tcpdump tambi&eacute;n nos
mostrar&aacute; los datos de cargo de AH.

<p>
<li>Montaremos un sistema de archivo /kern (si no usamos uno por
definici&oacute;n)

<blockquote><tt>
# <b>mkdir /kern; mount -t kernfs /kern /kern</b>
</tt></blockquote>

<p>
En /kern hay una tabla de SA/SPIs actuales, incluidos los que tienen
flujos (SAs salientes) y los que no (SAs entrantes).  Tambi&eacute;n hay
contadores de tr&aacute;fico que podemos usar para ver qu&eacute;
tr&aacute;fico pasa y hacia d&oacute;de se dirige.

<p>
<li>Finalmente, podemos usar
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=netstat&amp;sektion=1">netstat(1)</a>
para ver nuestras SAs.

<blockquote><pre>
$ <b>netstat -rn -f encap</b>
Routing tables

Encap:
Source             Port  Destination        Port  Proto SA(Address/SPI/Proto) 
0.0.0.0/32         0     192.168.99/24      0     0     208.1.1.1/00001000/50
0.0.0.0/32         0     208.1.1.1/32       0     0     208.1.1.1/00001000/50
208.1.2.0/24       0     192.168.99/24      0     0     208.1.1.1/00001000/50
208.1.2.0/24       0     208.1.1.1/32       0     0     208.1.1.1/00001000/50
208.1.5.0/24       0     192.168.99/24      0     0     208.1.1.1/00001000/50
208.1.5.0/24       0     208.1.1.1/32       0     0     208.1.1.1/00001000/50
208.2.2.2/32       0     192.168.99/24      0     0     208.1.1.1/00001000/50
208.2.2.2/32       0     208.1.1.1/32       0     0     208.1.1.1/00001000/50
</pre></blockquote>

<p>
<li>Si todo lo dem&aacute;s fallara, recompilaremos el n&uacute;cleo del
sistema con <code>option ENCDEBUG</code>.  A continuaci&oacute;n
configuraremos <i>net.inet.ip.encdebug</i> con el valor 1 en sysctl.
Buscaremos avisos o errores en nuestro dmesg, e informaremos sobre ellos
a los desarrolladores de OpenBSD, usando
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendbug&amp;sektion=1">sendbug(1)</a>.
De forma alternativa, si no se est&aacute; seguro de que que el problema
sea un error, se puede enviar un mensaje a una de las 
<a href="../../es/mail.html">listas de correo</a>.
</ul>


<p>
<a name="SeeAlso"></a>
<h2>13.11 - Documentaci&oacute;n relacionada</h2>

<p>
IPsec est&aacute; parcialmente documentado en la p&aacute;gina del
manual de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&amp;sektion=8">vpn(8)</a>.
Hay varios modelos de configuraci&oacute;n en el directorio
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/">/usr/share/ipsec/</a> 
que pueden ser de ayuda.  Las p&aacute;ginas del manual de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=enc&amp;sektion=4">enc(4)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&amp;sektion=4">ipsec(4)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&amp;sektion=8">ipsecadm(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&amp;sektion=8">isakmpd(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&amp;sektion=5">isakmpd.conf(5)</a> y
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&amp;sektion=5">isakmpd.policy(5)</a>
tienen informaci&oacute;n m&aacute;s detallada y pueden ayudarnos con la
configuraci&oacute;n y operaci&oacute;n de IPsec.

<p>
Otros enlaces:

<ul>
<li><a href="http://www.ietf.org/html.charters/ipsec-charter.html">Grupo
de Trabajo de IPsec del IETF</a>
<li><a href="http://isakmp-test.ssh.fi/">Nodo de Verificaci&oacute;n de
Interoperabilidad de SSH IPsec</a>
<li><a href="http://ipsec-wit.antd.nist.gov/">Verificador de
Interoperabilidad de NIST IPsec basado en web</a>
<li><a href="http://www.r4k.net/ipsec/">Porte de IPsec de OpenBSD para
FreeBSD</a>
<li><a href="http://www.xs4all.nl/~freeswan/">FreeS/WAN - IPsec para
Linux</a>
<li><a href="http://www.pintday.org/hack/docs/vpn-24-minifaq.shtml">
Mini-FAQ de Configuraci&oacute;n de una VPN con OpenBSD 2.4</a>
</ul>

<p> 
<a name="rfc">
Y en los RFC:
</a>

<ul>
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1320.html">RFC
1320</a> - The MD4 Message-Digest Algorithm
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1321.html">RFC
1321</a> - The MD5 Message-Digest Algorithm
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1828.html">RFC
1828</a> - IP Authentication using Keyed MD5
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1829.html">RFC
1829</a> - The ESP DES-CBC Transform
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2040.html">RFC
2040</a> - The RC5, RC5-CBC, RC5-CBC-Pad, and RC5-CTS Algorithms
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2085.html">RFC
2085</a> - HMAC-MD5 IP Authentication with Replay Prevention
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2104.html">RFC
2104</a> - HMAC: Keyed-Hashing for Message Authentication
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2144.html">RFC
2144</a> - The CAST-128 Encryption Algorithm 
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2202.html">RFC
2202</a> - Test Cases for HMAC-MD5 and HMAC-SHA-1 
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2207.html">RFC
2207</a> - RSVP Extensions for IPsec Data Flows
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2268.html">RFC
2268</a> - A Description of the RC2 Encryption Algorithm 
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2367.html">RFC
2367</a> - PF_KEY Key Management API, Version 2
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2401.html">RFC
2401</a> - Security Architecture for the Internet Protocol
(<b>IPsec</b>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2402.html">RFC
2402</a> - IP Authentication Header (<b>AH</b>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2403.html">RFC
2403</a> - The Use of HMAC-MD5-96 within ESP and AH
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2404.html">RFC
2404</a> - The Use of HMAC-SHA-1-96 within ESP and AH
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2405.html">RFC
2405</a> - The ESP DES-CBC Cipher Algorithm With Explicit IV
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">RFC
2406</a> - IP Encapsulating Security Payload (<b>ESP</b>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2407.html">RFC
2407</a> - The Internet IP Security Domain of Interpretation for ISAKMP
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2408.html">RFC
2408</a> - Internet Security Association and Key Management Protocol
(<b>ISAKMP</b>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2409.html">RFC
2409</a> - The Internet Key Exchange (<b>IKE</b>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2410.html">RFC
2410</a> - The NULL Encryption Algorithm and Its Use With IPsec (ha
ha...)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2411.html">RFC
2411</a> - IP Security Document Roadmap
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2412.html">RFC
2412</a> - The OAKLEY Key Determination Protocol
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2451.html">RFC
2451</a> - The ESP CBC-Mode Cipher Algorithms
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2631.html">RFC
2631</a> - Diffie-Hellman Key Agreement Method
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2709.html">RFC
2709</a> - Security Model with Tunnel-mode IPsec for NAT Domains
</ul>
d44 2
a45 2
Originally [OpenBSD: faq13.html,v 1.78 2003/06/28 23:01:32 jolan Exp ]<br>
$Translation: faq13.html,v 1.41 2003/06/29 08:48:44 horacio Exp $<br>
@


1.38
log
@sync with steelix translation CVS
@
text
@d220 3
a222 3
La <strong>Cabecera de Autenticaci&oacute;n</strong> (AH) viene de la
cabecera b&aacute;sica IP y contiene res&uacute;menes
criptogr&aacute;ficos (<i>hash</i>) de los datos e informaci&oacute;n de
d232 6
a237 6
La cabecera de la <strong>Carga &Uacute;til de Seguridad
Encapsulada</strong> (<i>Encapsulated Security Payload</i>, ESP) permite
reescribir la carga &uacute;til de forma cifrada.  La cabecera ESP no
considera los campos de la cabecera IP que van delante, y por lo tanto
no garantiza nada excepto la carga &uacute;til del paquete.  Los
distintos tipos de ESP aplicables deben ser conformes con el
d250 17
a266 17
<li>El modo <strong>transporte</strong> es el que usa un
anfitri&oacute;n que genera los paquetes.  En modo transporte, las
cabeceras de seguridad se a&ntilde;aden antes que las cabeceras de la
capa de transporte (v.g., TCP, UDP), antes de que la cabecera IP sea
a&ntilde;adida al paquete.  En otras palabras, un AH a&ntilde;adido al
paquete cubrir&aacute; el resumen criptogr&aacute;fico de la cabecera
TCP y algunos campos de la cabecera IP de extremo a extremo, y una
cabecera ESP cubrir&aacute; el cifrado de la cabecera TCP y los datos,
pero no la cabecera IP de extremo a extremo.

<li>El modo <strong>T&uacute;nel</strong> se usa cuando la cabecera IP
de extremo a extremo ya ha sido adjuntada al paquete, y uno de los
extremos de la conexi&oacute;n segura es solamente una pasarela.  En
este modo, las cabeceras AH y ESP se usan para cubrir todo el paquete,
incluida la cabecera de extremo a extremo, y se a&ntilde;ade una nueva
cabecera IP al paquete que cubre s&oacute;lo el salto al otro extremo de
la conexi&oacute;n segura (aunque eso puedan ser varios saltos de
d272 4
a275 4
&laquo;Asociaciones de Seguridad&raquo; (<strong>SA</strong>s).  Cada SA
viene definida por un &uacute;nico flujo unidireccional de datos, y por
regla general (ignorando multicast) desde un &uacute;nico punto hasta
otro, cubriendo el tr&aacute;fico que se distingue por alg&uacute;n
d615 5
a619 5
Aqu&iacute; se crear&aacute;n <strong>dos</strong> flujos, uno
ser&aacute; la direcci&oacute;n de origen local, que cubrir&aacute;
todos los paquetes que originen del anfitri&oacute;n local hacia el
destino, y el otro ser&aacute; el flujo de vuelta desde el destino hasta
el anfitri&oacute;n local.
d655 2
a656 3
hay que especificar <strong>con exactitud</strong> lo que se desea
hacer.  No lo adivinar&aacute; por nosotros.  V&eacute;anse los
siguientes ejemplos:
d949 7
a955 7
predefinidos aqu&iacute; es correcto.  El valor
<strong>Listen-on</strong>= especifica el IP en el que isakmpd debe
estar a la escucha.  S&oacute;lo es necesario el IP de Internet de
nuestra pasarela.  Si tenemos interfaces m&uacute;ltiples externas en
nuestra pasarela, podr&iacute;amos especificar una lista de las
interfaces en las que queremos que est&eacute; a la escucha,
introduci&eacute;ndolas, separadas por comas, en una lista.
d1005 6
a1010 6
El indicador <strong>Connections</strong>= se refiere a la
secci&oacute;n de m&aacute;s abajo.  Inicia los requisitos o los
m&eacute;todos aceptados para activar la fase 2.  Tambi&eacute;n le
indica a ISAKMPD qu&eacute; conexiones debe iniciar una vez haya
comenzado.  Podemos tener secciones m&uacute;ltiples, como se ilustra
abajo, si vamos a conectar con m&uacute;ltiples anfitriones.
d1014 1
a1014 1
podemos especificar un <strong>Default</strong>= que se&ntilde;ale a una
d1017 1
a1017 1
est&eacute; en la lista del indicador <strong>Connections</strong>=.
d1190 8
a1197 9
<strong>configuraci&oacute;n</strong> de cada anfitri&oacute;n.  Son las
secciones a las que se hace referencia en los identificadores
<strong>Local-ID</strong> y <strong>Remote-ID</strong>.  Describen las
rutas que se deben configurar para permitir el paso del tr&aacute;fico
desde una red privada hasta otra.  <strong>ID-type</strong>= puede ser
<strong>IPV4_ADDR_SUBNET</strong> o <strong>IPV4_ADDR</strong> (RFC2708
menciona m&aacute;s valores posibles.  En la actualidad s&oacute;lo hay
soporte en la implementaci&oacute;n de OpenBSD para IPv4.  El soporte
para IPv6 puede estar en OpenBSD-current).
d1214 10
a1223 11
variable <strong>EXCHANGE_TYPE</strong> est&aacute; configurada con el
valor <strong>ID_PROT</strong> para la fase 1, que identifica los
protocolos que cubrir&aacute; esta autenticaci&oacute;n.
<strong>Transforms=</strong> es la transformaci&oacute;n
criptogr&aacute;fica requerida (o asignada) para este intercambio.  En
este caso se&ntilde;ala a la secci&oacute;n de abajo en el fichero de
configuraci&oacute;n, que indica que estamos recibiendo un paquete
cifrado con 3DES y una suma de comprobaci&oacute;n verificable con SHA.
Hay muchas transformaciones criptogr&aacute;ficas definidas en el
fichero de muestra <strong>VPN-east.conf</strong>.  &Eacute;stas se
proveen porque 3DES y SHA no siempre tienen soporte en las diferentes
d1226 3
a1228 3
secci&oacute;n y cambiar la variable <strong>Transforms</strong>=,
poemos hacerlo.  El &uacute;nico requisito es que cambiemos la variable
<strong>Configuration</strong>=.
d1242 9
a1250 9
equivalente en la fase 1 anterior es que <strong>EXCHANGE_TYPE</strong>
es <strong>QUICK_MODE</strong>.  <strong>Suites=</strong> se&ntilde;ala
a una secci&oacute;n Suite de IPsec que describe los distintos esquemas
de cifrado disponibles entre los dos anfitriones.  Se podr&iacute;a
decir mucho m&aacute;s sobre ISAKMP e IPsec, pero usando las
descripciones b&aacute;sicas que hemos mencionado se deber&iacute;a
poder crear una VPN simple pero s&oacute;lida, que cuidara de s&iacute;
misma.  Esto es el <i>m&iacute;nimo indispensable</i> de
<strong>isakmpd.conf</strong> para ambos anfitriones.
d1267 1
a1267 1
modo, y ejecutar <strong>ipsecadm flush</strong>.
d2232 1
a2232 1
<li><a href="http://www.ssh.com/">SSH Sentinel</a> IPSec client
d2521 2
a2522 2
Originally [OpenBSD: faq13.html,v 1.77 2003/06/22 18:54:12 david Exp ]<br>
$Translation: faq13.html,v 1.40 2003/06/22 21:28:32 horacio Exp $<br>
@


1.37
log
@sync with steelix translation CVS
@
text
@d1 1
a1 1
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
d694 1
a694 1
</blockquote></tt>
d2524 2
a2525 2
Originally [OpenBSD: faq13.html,v 1.76 2003/06/15 01:56:38 nick Exp ]<br>
$Translation: faq13.html,v 1.39 2003/06/15 10:54:51 horacio Exp $<br>
@


1.36
log
@
sync with steelix translation CVS
@
text
@d2231 7
a2237 8
<!--    <li><a href="http://www.timestep.com/">TimeStep</a> PERMIT/Client -->
   <li><a href="http://www.ashleylaurent.com/">Ashley Laurent</a> VPN
   software
   <li><a href="http://www.pgp.com/">PGP VPN</a> software
   <li><a href="http://www.radguard.com/">Radguard</a> cIPro client
   <li><a href="http://www.cisco.com/">Cisco</a> IRE client
   <li><a href="http://www.microsoft.com">Microsoft</a> Windows 2000 y
   XP
d2524 2
a2525 2
Originally [OpenBSD: faq13.html,v 1.75 2003/05/02 15:41:59 nick Exp ]<br>
$Translation: faq13.html,v 1.38 2003/05/03 08:54:54 horacio Exp $<br>
@


1.35
log
@
sync with steelix translation CVS
@
text
@d2232 1
a2232 1
   <li><a href="http://www.vpcom.com/">Ashley Laurent</a> VPCom VPN
d2525 2
a2526 2
Originally [OpenBSD: faq13.html,v 1.74 2003/04/03 15:12:53 nick Exp ]<br>
$Translation: faq13.html,v 1.37 2003/04/06 22:13:41 horacio Exp $<br>
@


1.34
log
@
sync with steelix translation CVS
@
text
@d2142 1
a2142 1
licensees: &quot;DN:\C=se\CN=IKELAB CA&quot;
d2149 1
a2149 1
licensees: &quot;DN:\C=se\CN=IKELAB CA&quot;
d2156 1
a2156 1
licensees: &quot;DN:\C=se\CN=IKELAB CA&quot;
d2525 2
a2526 2
Originally [OpenBSD: faq13.html,v 1.73 2003/03/29 20:22:58 nick Exp ]<br>
$Translation: faq13.html,v 1.36 2003/04/01 08:30:18 horacio Exp $<br>
@


1.33
log
@
sync with steelix translation CVS
@
text
@d2054 1
a2054 1
licensees: &quot;DN:\C=se\CN=IKELAB CA&quot;
d2525 2
a2526 2
Originally [OpenBSD: faq13.html,v 1.72 2003/03/22 22:02:20 nick Exp ]<br>
$Translation: faq13.html,v 1.35 2003/03/23 18:53:04 horacio Exp $<br>
@


1.32
log
@
sync with steelix translation CVS
@
text
@d2525 2
a2526 2
Originally [OpenBSD: faq13.html,v 1.71 2003/03/18 03:41:04 nick Exp ]<br>
$Translation: faq13.html,v 1.34 2003/03/18 12:33:28 horacio Exp $<br>
@


1.31
log
@
sync with steelix translation CVS
@
text
@d19 6
a25 1
<p>
d2515 1
a2515 1
<a href="index.html">[Volver al &iacute;ndice principal]</a>
d2525 2
a2526 2
Originally [OpenBSD: faq13.html,v 1.70 2003/02/28 00:34:28 nick Exp ]<br>
$Translation: faq13.html,v 1.33 2003/03/01 11:24:49 horacio Exp $<br>
@


1.30
log
@
sync with steelix translation CVS
@
text
@d2520 2
a2521 2
Originally [OpenBSD: faq13.html,v 1.69 2003/02/25 04:00:10 david Exp ]<br>
$Translation: faq13.html,v 1.32 2003/02/25 12:22:31 horacio Exp $<br>
@


1.29
log
@
sync with steelix translation CVS
@
text
@d4 1
a4 1
<title>13.0 - Uso de IPsec</title>
d21 1
a21 1
<h1><font color="#e00000">13.0 - Uso de IPsec (Protocolo de Seguridad
d65 1
a65 1
<h1>13.1 - &iquest;Qu&eacute; es IPsec?</h1>
d177 2
a178 2
<h1>13.3 - &iquest;Cu&aacute;les son los protocolos que conforman
IPsec?</h1>
d212 1
a212 1
<h1>13.4 - Sobre el formato &quot;wire&quot;</h1>
d369 1
a369 1
<h1>13.5 - Configuraci&oacute;n de IPsec</h1>
d474 2
a475 2
<h1>13.6 - &iquest;C&oacute;mo configuro IPsec con el sistema de
&laquo;claves manuales&raquo;?</h1>
d507 1
a507 2
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&sektion=8">
sysctl(8)</a>.
d783 1
a783 1
<h1>13.7 - &iquest;C&oacute;mo configuro isakmpd?</h1>
d800 14
a813 1
normalmente tendr&iacute;amos que gestionar nosotros con
d830 3
a832 1
casos en los que preocupe el ancho de banda de la red.
d857 2
a858 2
OpenBSD incluye los binarios para ISAKMP y para la pila de IPsec por
definici&oacute;n.  Se pueden encontrar unos ficheros de
d1262 4
a1265 4
no funcionar&aacute; en modo d&aelig;mon, sino como un proceso regular.
Grabar&aacute; todo en nuestro terminal.  Para parar isakmpd y limpiar
las rutas hay que matar el proceso isakmpd en cada modo, y ejecutar
<strong>ipsecadm flush</strong>.
d1270 1
a1270 1
<h1>13.8 - &iquest;C&oacute;mo uso isakmpd con certificados X.509?</h1>
d1277 2
a1278 2
configuraci&oacute;n y, m&aacute;s importante, la gesti&oacute;n de
claves.
d1294 27
a1320 22
Los certificados X.509 necesitan tener una extensi&oacute;n de
&laquo;Asunto Nombre Alternativo&raquo; (SubjectAltName), que describa
al poseedor del certificado.  La configuraci&oacute;n de una
extensi&oacute;n SubjectAltName usando certpatch para un certificado
tambi&eacute;n se describe en README.PKI para el caso de
configuraci&oacute;n de una direcci&oacute;n IP como la extensi&oacute;n
SubjectAltName.  Aqu&iacute;, el uso de una direcci&oacute;n IP
tambi&eacute;n es el comportamiento por definici&oacute;n de isakmpd.

<p>
Certpatch tambi&eacute;n tiene soporte para el uso de &laquo;Nombres de
Dominio Totalmente Cualificados&raquo; (FQDN, &quot;Fully Qualified
Domain Name&quot;) o UFQDN (FQDN de Usuario).  Un ejemplo de un FQDN
ser&iacute;a <tt>www.openbsd.org</tt>, y un ejemplo de un UFQDN
ser&iacute;a una direcci&oacute;n de correo electr&oacute;nico, como por
ejemplo <tt>Jorgen.Granstam@@abc.se</tt>.

<p>
En este documento se usar&eacute; FQDNs como SubjectAltNames.  El uso de
direcciones IP deber&iacute;a ser algo m&aacute;s f&aacute;cil, ya que
es el comportamiento por definici&oacute;n de isakmpd pero no es muy
diferente, como veremos m&aacute;s adelante.
d1323 1
a1323 1
Para introducir un SubjectAltName FQDN en un certificado,
d1340 29
a1368 4
Pondremos las claves y certificados en los directorios tal y como se
describe al final de README.PKI.  Si se van a usar las claves de una
forma seria, la clave CA (ca.key) se debe guardar en alg&uacute;n sitio
seguro.
d1429 1
a1429 1
Policy-File=            /etc/isakmpd/policy
d1638 1
a1638 1
Policy-File=            /etc/isakmpd/policy
d2178 1
a2178 1
SubjectAltName correctas en sus certificados.  Adem&aacute;s, la fecha
d2210 2
a2211 2
<h1>13.9 - &iquest;Qu&eacute; clientes IKE son compatibles con
isakmpd?</h1>
d2262 1
a2262 1
<h1>13.10 - Resoluci&oacute;n de problemas de IPsec/VPN</h1>
d2408 1
a2408 1
<h1>13.11 - Documentaci&oacute;n relacionada</h1>
d2511 2
a2512 2
<a href="faq12.html">[Secci&oacute;n 12.0 - Para usuarios avanzados]</a>
<a href="faq14.html">[Secci&oacute;n 14.0 - Uso de discos en OpenBSD]</a>
d2520 2
a2521 2
Originally [OpenBSD: faq13.html,v 1.63 2003/01/12 22:48:23 kjell Exp ]<br>
$Translation: faq13.html,v 1.29 2003/01/20 21:36:25 horacio Exp $<br>
@


1.28
log
@
sync with steelix translation CVS
@
text
@d106 1
a106 1
este enrutador controla y cifra el tr&aacute;fico para una <em>Red</em>
d112 1
a112 1
(VPN, <em>Virtual Private Networks</em>).  Sin embargo, su utilidad va
d114 3
a116 4
&laquo;intercambio de claves de Internet&raquo; (IKE, <em>Internet Key
Exchange</em>), cada m&aacute;quina en Internet podr&iacute;a
comunicarse con otra y usar cifrado y autenticaci&oacute;n de alto
grado.
d137 4
a140 3
de comprender para todos excepto para el receptor, que nadie pueda leer
las contrase&ntilde;as contrase&ntilde;as cuando se ingresa en una
m&aacute;quina remota a trav&eacute;s de Internet.
d161 11
a171 15
Necesitamos modos para asegurarnos de que una transacci&oacute;n
s&oacute;lo se puede llevar a cabo una vez, a menos que autoricemos que
la repitan.  Nadie deber&iacute;a poder grabar una transacci&oacute;n, y
luego replicarla al pie de la letra con el prop&oacute;sito de hacer que
parezca como si se hubieran recibido m&uacute;ltiples transacciones del
remitente original.  Imagine que el atacante deba conocer cu&aacute;l es
el motivo del tr&aacute;fico por medios distintos al de poder
descifrarlo, y que el tr&aacute;fico causara sucesos favorables para
&eacute;l, como depositar dinero en su cuenta.  Tendr&iacute;amos que
asegurarnos de que no pudiera replicar ese tr&aacute;fico m&aacute;s
tarde.  <em>AVISO: tal y como lo especifica la normativa, la
protecci&oacute;n a la r&eacute;plica no se llevar&aacute; a cabo cuando
se use el sistema de claves manuales de IPsec (v.g., cuando se
est&eacute; usando 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&amp;sektion=8">ipsecadm(8)</a>)</em>.
d184 1
a184 1
Autenticaci&oacute;n&raquo; (AH, <em>Authentication Header</em>) y
d186 1
a186 1
<em>Encapsulated Security Payload</em>).
d190 5
a194 3
r&eacute;plica (pero no confidencialidad).  Su principal diferencia con
ESP es que AH tambi&eacute;n asegura partes de la cabecera IP del
paquete (como las direcciones de origen o destino).
d205 3
d217 2
a218 2
criptogr&aacute;ficos (<em>hash</em>) de los datos e informaci&oacute;n
de identificaci&oacute;n.  Los res&uacute;menes criptogr&aacute;ficos
d228 4
a231 4
Encapsulada</strong> (<em>Encapsulated Security Payload</em>, ESP)
permite reescribir la carga &uacute;til de forma cifrada.  La cabecera
ESP no considera los campos de la cabecera IP que van delante, y por lo
tanto no garantiza nada excepto la carga &uacute;til del paquete.  Los
d381 4
a384 4
Seguridad&raquo; (SAD, <em>Security Association Database</em>, llamado
TDB o tabla TDB en el c&oacute;digo fuente de IPsec de OpenBSD), y el
otro es la &laquo;Base de Datos de Pol&iacute;tica de la
Seguridad&raquo; (SPD, <em>Security Policy Database</em>).
d486 3
a488 6
Para empezar hay que activar las opciones IP AH e IP ESP en el
n&uacute;cleo del sistema de OpenBSD (si s&oacute;lo se est&aacute;
usando ESP, como con el gui&oacute;n de ejecuci&oacute;n rc.vpn,
entonces <em>no es necesario activar AH</em>;  de hecho, puede haber
problemas relacionados con la seguridad activando AH si no est&aacute;
siendo usado).
d490 5
d496 2
a497 1
Hay un sysctl para activar estos protocolos:
d500 2
a501 4
# <b>sysctl -w net.inet.esp.enable=1</b><br>
net.inet.esp.enable: 0 -&gt; 1<br>
# <b>sysctl -w net.inet.ah.enable=1</b><br>
net.inet.ah.enable: 0 -&gt; 1
d505 20
a524 5
Se puede editar <em>/etc/sysctl.conf</em> para activarlos durante el
arranque.  Para ello hay que borrar la marca de comentario # que se
precede a la l&iacute;nea net.inet.esp.enable y/o net.inet.ah.enable
(dependiendo de cu&aacute;l se va a usar) y asegurarse de que
est&aacute;n configuradas con el valor 1.
d527 2
a528 2
Tambi&eacute;n ser&aacute; necesario generar las claves manuales.  Como
la seguridad del VPN se basa en que estas claves no se puedan
d533 1
a533 1
Por ejemplo, para producir 160 bits de aleatoriedad:
d536 1
a536 1
# <b>dd if=/dev/urandom bs=1024 count=1 | sha1</b>
d564 1
a564 1
<em>En estos ejemplos s&oacute;lo se usa ESP para cifrar su
d569 1
a569 1
entorno de t&uacute;neles.</em>
d797 1
a797 1
Internet&raquo; (IKE, <em>Internet Key Exchange</em>) es el mecanismo de
d843 6
a848 13
OpenBSD viene con los binarios para ISAKMP y para todo IPsec por
definici&oacute;n, pero no con los ficheros de muestra.  Para obtenerlos
hay que bajarse /usr/src/sbin/isakmpd/samples/VPN-east.conf y
/usr/src/sbin/isakmpd/samples/policy del &aacute;rbol de fuentes.  Se
puede usar el CD si se tiene,
<a href="http://www.openbsd.org/cgi-bin/cvsweb/">cvsweb</a>, o el
<a href="../../es/anoncvs.html">cliente de CVS en la l&iacute;nea de
&oacute;rdenes</a> (Cvsweb tiene
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/samples/VPN-east.conf">VPN-east.conf</a> y
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/samples/policy">policy</a> 
disponibles).  Para este ejemplo, copiaremos <em>policy</em> a
<em>/etc/isakmpd/isakmpd.policy</em>, y <em>VPN-east.conf</em> a
<em>/etc/isakmpd/isakmpd.conf</em>.  Intentaremos mostrar c&oacute;mo
d851 1
a851 1
el directorio <em>samples</em>.  Las p&aacute;ginas de manual contienen
d860 11
a870 5
editar <em>/etc/isakmpd/isakmpd.policy</em>.  Este fichero indica a
ISAKMP qui&eacute;n puede acceder a IPsec.  En este ejemplo, el fichero
<em>policy</em> indica que cualquiera que env&iacute;e datos usando ESP,
y que se haya autenticado con la contrase&ntilde;a
<kbd>mekmitasdigoat</kbd> (o cualquier otra contrase&ntilde;a que
d876 1
a876 1
pruebas.  Para ello hay que editar el fichero <em>policy</em> para que
d885 1
a885 1
El mismo fichero <em>policy</em> contiene dos l&iacute;neas que empiezan
d890 1
a890 1
Un fichero <em>policy</em> m&aacute;s &uacute;til para este ejemplo
d905 2
a906 2
/etc/isakmpd/isakmpd.conf.  La direcci&oacute;n IP de muestra 249.2.2.2,
debe ser reemplazada con la direcci&oacute;n IP externa del
d962 2
a963 2
direcciones con l&iacute;neas adicionales en el formato IP_Address=<em>
&lt;PEER-NAME&gt;.</em>.
d1070 1
a1070 1
Esta contrase&ntilde;a se pasa al fichero <em>policy</em> para verificar
d1073 4
a1076 4
fichero <em>policy</em>, porque el fichero de muestra contiene una
contrase&ntilde;a.  Si se ha decidido utilizar un fichero
<em>policy</em> m&iacute;nimo, entonces se puede especificar lo que se
quiera aqu&iacute;.
d1195 1
a1195 1
la variable <em>Configuration=</em>.  Como se puede ver aqu&iacute;,
d1224 1
a1224 1
referencia a ella est&aacute; arriba en <em>Configuration</em>.
d1233 1
a1233 1
misma.  Esto es el <em>m&iacute;nimo indispensable</em> de
d1243 1
a1243 1
# <b>isakmpd -d -DA=99</b>
d1332 1
a1332 1
<em>/etc/isakmpd/isakmpd.conf</em>.  Esta configuraci&oacute;n se
d1638 1
a1638 1
El fichero <em>policy</em> puede ser algo confuso para alguien que no lo
d1646 1
a1646 1
El fichero <em>policy</em> m&aacute;s simple ser&iacute;a uno que
d1655 1
a1655 1
<em>policy</em> sobre qui&eacute;n puede conectar.  Por lo tanto, no es
d1659 3
a1661 3
tiene la autoridad total sobre <em>policy</em>.  Cualquier otro
authorizer debe primero ser autorizado por &quot;POLICY&quot; para poder
tener cualquier autoridad.
d1665 1
a1665 1
est&aacute; autorizado.  El siguiente <em>policy</em> vendr&iacute;a a
d1670 3
a1672 3
el lector el cambiar este fichero <em>policy</em> para no permitir
tampoco DES).  N&oacute;tese que cualquiera que cifre con ESP
todav&iacute;a estar&iacute;a autorizado.
d1709 1
a1709 1
<em>policy</em>:
d1726 1
a1726 1
Y ahora, a por lo que todos estaban esperando.  <em>policy</em>
d1731 1
a1731 1
fichero <em>policy</em>:
d1791 1
a1791 1
anterior no se ve en el fichero <em>policy</em>.  Sin embargo, se puede
d1818 5
a1822 6
El fichero <em>policy</em> que hemos visto es un simple ejemplo de
fichero <em>policy</em> que delega en una CA.  Cualquier usuario que
tenga un certificado firmado por la CA de este certificado, y que
adem&aacute;s cumpla las otras condiciones configuradas en
<em>policy</em> y en el fichero de configuraci&oacute;n, estar&aacute;
autorizado.
d1937 1
a1937 1
Debemos hacer la comprobaci&oacute;n en <em>policy</em>, como sigue:
d1964 1
a1964 1
alternativas, o sea, teniendo condiciones en el fichero <em>policy</em>
d1976 1
a1976 1
Con esta <em>policy</em> podr&iacute;an conectar tanto gw.worksite.se,
d1981 3
a1983 3
enteros introducidos en <em>policy</em>.  Reformatear los certificados
en el formato de <em>policy</em> requiere algo de esfuerzo, y hace que
<em>policy</em> sea poco legible.  Si alguien substituyera por error, un
d1985 1
a1985 1
alguna parte de un fichero <em>policy</em> complejo, podr&iacute;a
d1988 1
a1988 1
detectable leyendo el fichero <em>policy</em> (porque los certificados
d1995 1
a1995 1
lugar de un certificado en <em>policy</em> (por supuesto que el
d1998 1
a1998 1
formato, el fichero <em>policy</em> anterior acabar&iacute;a siendo algo
d2024 3
a2026 3
Se pueden hacer configuraciones de <em>policy</em> m&aacute;s
complicadas pero esto es suficiente para empezar, y todav&iacute;a hay
otro ejemplo en la siguiente secci&oacute;n.
d2031 1
a2031 1
fichero <em>policy</em> peque&ntilde;o o, por lo menos, uno razonable.
d2077 2
a2078 2
cualquier cosa.  Se podr&iacute;a escribir un fichero <em>policy</em>
como &eacute;ste:
d2118 3
a2120 3
fichero <em>policy</em> como &eacute;ste (cualquiera con un IP del
extremo de la conexi&oacute;n predefinido) requerir&iacute;a reescribir
partes del fichero isakmpd.conf tambi&eacute;n.  Esto conllevar&iacute;a
d2141 1
a2141 1
ser&iacute;a necesario cambiar los ficheros <em>policy</em> en todas las
d2285 2
a2286 1
<li>Para activar todo el depurado en isakmpd, lo iniciamos como
d2289 1
a2289 1
# <b>/sbin/isakmpd -d -DA=99</b>
d2297 1
a2297 1
# <b>/sbin/isakmpd -d -DA=99 -D1=70</b>
d2352 1
a2352 1
configuraremos <em>net.inet.ip.encdebug</em> con el valor 1 en sysctl.
d2476 2
a2477 2
Originally [OpenBSD: faq13.html,v 1.62 2003/01/01 13:01:59 nick Exp ]<br>
$Translation: faq13.html,v 1.28 2003/01/06 18:33:12 horacio Exp $<br>
@


1.27
log
@
sync
@
text
@d12 1
a12 1
<meta name="copyright"     content="Este documento es copyright 2000-2002 de OpenBSD">
d2460 2
a2461 2
Originally [OpenBSD: faq13.html,v 1.61 2002/11/26 01:02:04 nick Exp ]<br>
$Translation: faq13.html,v 1.27 2002/11/26 21:41:54 horacio Exp $<br>
@


1.26
log
@
sync with badlands translation CVS
@
text
@d1 1
d17 1
d26 2
a27 1
<h3>Tabla de contenidos</h3>
d50 4
a53 3
<ul>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&sektion=4&format=html">ipsec(4)</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&sektion=8&format=html">vpn(8)</a>
d58 1
a58 1
</font>
d61 1
d98 3
a100 3
   <li>Anfitri&oacute;n-a-Anfitri&oacute;n
   <li>Anfitri&oacute;n-a-Red
   <li>Red-a-Red
d103 1
d119 1
d175 2
a176 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&apropos=0&sektion=8&format=html">ipsecadm(8)</a>)</em>.
d207 1
d244 18
a261 18
   <li>El modo <strong>transporte</strong> es el que usa un
   anfitri&oacute;n que genera los paquetes.  En modo transporte, las
   cabeceras de seguridad se a&ntilde;aden antes que las cabeceras de la
   capa de transporte (v.g., TCP, UDP), antes de que la cabecera IP sea
   a&ntilde;adida al paquete.  En otras palabras, un AH a&ntilde;adido
   al paquete cubrir&aacute; el resumen criptogr&aacute;fico de la
   cabecera TCP y algunos campos de la cabecera IP de extremo a extremo,
   y una cabecera ESP cubrir&aacute; el cifrado de la cabecera TCP y los
   datos, pero no la cabecera IP de extremo a extremo.

   <li>El modo <strong>T&uacute;nel</strong> se usa cuando la cabecera
   IP de extremo a extremo ya ha sido adjuntada al paquete, y uno de los
   extremos de la conexi&oacute;n segura es solamente una pasarela.  En
   este modo, las cabeceras AH y ESP se usan para cubrir todo el
   paquete, incluida la cabecera de extremo a extremo, y se a&ntilde;ade
   una nueva cabecera IP al paquete que cubre s&oacute;lo el salto al
   otro extremo de la conexi&oacute;n segura (aunque eso puedan ser
   varios saltos de distancia).
d279 5
a283 6
   <li>&laquo;Direcci&oacute;n IP de destino&raquo; (&quot;destination
   IP address&quot;)
   <li>&laquo;&Iacute;ndice del Par&aacute;metro de Seguridad&raquo;
   (SPI, &quot;Security Parameter Index&quot;)
   <li>&laquo;Protocolo de seguridad&raquo; (&quot;security
   protocol&quot;)
d301 2
a302 2
<td><strong>IPhdr</strong></td>
<td><strong>AH</strong></td>
d315 2
a316 2
<td><strong>IPhdr</strong></td>
<td><strong>AH</strong></td>
d330 5
a334 5
<td><strong>IPhdr</strong></td>
<td><strong>AH</strong></td>
<td><strong>ESP</strong></td>
<td><em>TCPhdr</em></td>
<td><em>datos</em></td>
d345 6
a350 6
<td><strong>IPhdr</strong></td>
<td><strong>AH</strong></td>
<td><strong>ESP</strong></td>
<td><em>IPhdr2</em></td>
<td><em>TCPhdr</em></td>
<td><em>datos</em></td>
d364 1
d423 11
a433 11
   <li>Direcci&oacute;n IP de destino
   <li>Protocolo IPsec (AH o ESP)
   <li>SPI (cookie)
   <li>Contador de secuencias
   <li>Indicador de secuencia O/F
   <li>Ventana de informaci&oacute;n anti-r&eacute;plica
   <li>Tipo de AH e informaci&oacute;n
   <li>Tipo de ESP e informaci&oacute;n
   <li>Informaci&oacute;n sobre el tiempo de vida
   <li>Indicadores de modos t&uacute;nel/transporte
   <li>Informaci&oacute;n sobre el camino MTU
d440 2
a441 2
   <li>Puntero a SAs activas
   <li>Campos de selector
d458 1
a458 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&apropos=0&sektion=8&format=html">ipsecadm(8)</a>,
d467 2
a468 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&sektion=8">isakmpd(8)</a>.
d495 2
a496 3
<ul>
<tt>
# <strong>sysctl -w net.inet.esp.enable=1</strong><br>
d498 1
a498 1
# <strong>sysctl -w net.inet.ah.enable=1</strong><br>
d500 1
a500 2
</tt>
</ul>
d502 1
d515 1
a515 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=random&sektion=4&format=html">random(4)</a>.
d518 3
a520 5
<ul>
<tt>
# <strong>dd if=/dev/urandom bs=1024 count=1 | sha1</strong>
</tt>
</ul>
d522 1
d554 3
a556 6
<p>
<ul>
<tt>
# <strong>ipsecadm new esp -spi SPI_OUT -src MY_EXTERNAL_IP -dst PEER_EXTERNAL_IP -forcetunnel -enc blf -auth sha1 -key ENC_KEY -authkey AUTH_KEY</strong>
</tt>
</ul>
d565 2
a566 3
<ul>
<tt>
# <strong>ipsecadm new esp -spi 1000 -src 192.168.5.1 -dst 192.168.25.9 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</strong>
d568 2
a569 3
# <strong>ipsecadm new esp -spi 1001 -dst 192.168.5.1 -src 192.168.25.9 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</strong>
</tt>
</ul>
d574 2
a575 3
<ul>
<tt>
# <strong>ipsecadm new esp -spi 1001 -src 192.168.25.9 -dst 192.168.5.1 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</strong>
d577 2
a578 3
# <strong>ipsecadm new esp -spi 1000 -dst 192.168.25.9 -src 192.168.5.1 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</strong>
</tt>
</ul>
d600 3
a602 5
<ul>
<tt>
# <strong>ipsecadm flow -proto esp -dst 192.168.25.9 -spi 1000 -addr 192.168.5.1 255.255.255.255 192.168.25.9 255.255.255.255</strong>
</tt>
</ul>
d606 3
a608 5
<ul>
<tt>
# <strong>ipsecadm flow -proto esp -dst 192.168.5.1 -spi 1001 -addr 192.168.25.9 255.255.255.255 192.168.5.1 255.255.255.255</strong>
</tt>
</ul>
d638 2
d643 1
a643 2
Primero configuramos las asociaciones de seguridad (SA):
<br>
d646 2
a647 5
<ul>
<tt>
# <strong>ipsecadm new esp -src 208.1.1.1 -dst 208.2.2.2 -forcetunnel -spi 1001 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</strong>
<br>
# <strong>ipsecadm new esp -src 208.2.2.2 -dst 208.1.1.1 -forcetunnel -spi 1000 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</strong>
d649 2
a650 2
</tt>
</ul>
d652 1
d656 3
a658 6
<ul>
<tt>
# <strong>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 208.1.1.1 255.255.255.255 208.2.2.2 255.255.255.255</strong>
<br>
</tt>
</ul>
d663 3
a665 6
<ul>
<tt>
# <strong>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 192.168.99.0 255.255.255.0 208.1.2.0 255.255.255.0</strong>
<br>
</tt>
</ul>
d667 1
d671 3
a673 6
<ul>
<tt>
# <strong>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 192.168.99.0 255.255.255.0 208.1.5.0 255.255.255.0</strong>
<br>
</ul>
</tt>
d678 3
a680 6
<ul>
<tt>
# <strong>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 208.1.1.1 255.255.255.255 208.1.2.0 255.255.255.0</strong>
<br>
</tt>
</ul>
d682 1
d686 3
a688 6
<ul>
<tt>
# <strong>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 208.1.1.1 255.255.255.255 208.1.5.0 255.255.255.0</strong>
<br>
</tt>
</ul>
d690 1
d694 4
a697 6
<ul>
<tt>
# <strong>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 192.168.99.0 255.255.255.0 208.2.2.2 255.255.255.255</strong>
<br>
</tt>
</ul>
d705 2
a706 5
<ul>
<tt>
# <strong>ipsecadm new esp -src 208.2.2.2 -dst 208.1.1.1 -forcetunnel -spi 1000 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</strong>
<br>
# <strong>ipsecadm new esp -src 208.1.1.1 -dst 208.2.2.2 -forcetunnel -spi 1001 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</strong>
d708 2
a709 2
</tt>
</ul>
d714 3
a716 6
<ul>
<tt>
# <strong>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.2.2.2 255.255.255.255 208.1.1.1 255.255.255.255</strong>
<br>
</tt>
</ul>
d718 1
d722 3
a724 6
<ul>
<tt>
# <strong>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.2.0 255.255.255.0 192.168.99.0 255.255.255.0</strong>
<br>
</tt>
</ul>
d726 1
d730 3
a732 6
<ul>
<tt>
# <strong>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.5.0 255.255.255.0 192.168.99.0 255.255.255.0</strong>
<br>
</tt>
</ul>
d734 1
d738 3
a740 6
<ul>
<tt>
# <strong>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.2.2.2 255.255.255.255 192.168.99.0 255.255.255.0</strong>
<br>
</tt>
</ul>
d742 1
d746 2
a747 5
<ul>
<tt>
# <strong>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.2.0 255.255.255.0 208.2.2.2 255.255.255.255 -ingress</strong>
<br>
# <strong>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.5.0 255.255.255.0 208.2.2.2 255.255.255.255 -ingress</strong>
d749 2
a750 2
</tt>
</ul>
d756 3
a758 5
<ul>
<tt>
# <strong>ipsecadm flush</strong>
</tt>
</ul>
d760 1
d764 1
d785 1
a785 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&apropos=0&sektion=8">ipsecadm(8)</a>.
d790 19
a808 21
<strong>Fase 1</strong> - Los dos extremos de las conexiones ISAKMP
establecen un canal seguro, autenticado, sobre el cual se comunican
entre dos d&aelig;mons.  Esto establece una Asociaci&oacute;n de
Seguridad (SA) entre ambos anfitriones.  Los m&eacute;todos usados para
establecer este canal son el <strong>Main Mode</strong> (modo principal)
y el <strong>Agressive Mode</strong> (modo agresivo).  El Modo Principal
env&iacute;a la variada informaci&oacute;n sobre autenticaci&oacute;n en
una cierta secuencia, al tiempo que provee protecci&oacute;n para la
identidad.  El Modo Agresivo no provee esta protecci&oacute;n a la
identidad porque toda la informaci&oacute;n sobre la
autenticaci&oacute;n se env&iacute;a al mismo tiempo.  El modo agresivo
s&oacute;lo se deber&iacute;a usar en casos en los que preocupe el ancho
de banda de la red.

<p>
<strong>Fase 2</strong> - Las Asociaciones de Seguridad se negocian en
nombre de IPsec.  La fase 2 establece t&uacute;neles o Asociaciones de
Seguridad (SA) t&eacute;rminos entre anfitriones IPsec.  El
<strong>Quick Mode</strong> (modo r&aacute;pido) se usa en la fase 2
porque no es necesario repetir una autenticaci&oacute;n total;  la fase
1 ya ha establecido las SA.
d843 2
a844 2
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&sektion=5">isakmpd.conf(5)</a> e
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&sektion=5">isakmpd.policy(5)</a>.
d863 1
a863 3
<br>
<ul>
<pre>
d866 1
a866 2
</pre>
</ul>
d877 1
a877 2
<ul>
<pre>
d884 1
a884 2
</pre>
</ul>
d886 1
d893 1
a893 2
<ul>
<pre>
d898 1
a898 2
</pre>
</ul>
d900 1
d905 1
a905 2
<ul>
<pre>
d910 1
a910 2
</pre>
</ul>
d927 1
a927 2
<ul>
<pre>
d930 1
a930 2
</pre>
</ul>
d932 1
d935 1
a935 2
<ul>
<pre>
d938 1
a938 2
</pre>
</ul>
d952 1
a952 2
<ul>
<pre>
d955 1
a955 2
</pre>
</ul>
d957 1
d960 1
a960 2
<ul>
<pre>
d963 1
a963 2
</pre>
</ul>
d988 1
a988 2
<ul>
<pre>
d997 1
a997 2
</pre>
</ul>
d999 1
d1002 1
a1002 2
<ul>
<pre>
d1011 1
a1011 2
</pre>
</ul>
d1013 1
d1020 1
d1022 16
a1037 16
<li><strong>Fase=1</strong> se requiere porque el c&oacute;digo ISAKMPD
usa los mismos procedimientos para procesar Fase 1 y Fase 2.  Debe ser
<strong>1</strong> o no funcionar&aacute; nada.

<li><strong>Transport=</strong> ofrece diferentes posiblidades para
diferentes anfitriones que vayan a conectar.  Se sugiere que aqu&iacute;
se use UDP, as&iacute; que lo dejaremos en este punto.  Algunos
anfitriones que vayan a conectar pueden estar detr&aacute;s de un
cortafuegos que no permita pasar tr&aacute;fico UDP.  Esto debe ser
determinado antes de activarlo.

<li><strong>Local-address</strong> es la direcci&oacute;n de destino a
la que se&ntilde;alan los paquetes entrantes.  En algunos casos, puede
estar escuchando conexiones para Fase 1 en distintas interfaces.  En
esta muestra, s&oacute;lo hay una interfaz escuchando, por tanto
&eacute;ste es el IP de la interfaz de escucha en este extremo de la
d1040 3
a1042 3
<li><strong>Address=</strong> es la direcci&oacute;n que se&ntilde;ala
al origen IP de los paquetes entrantes.  Generalmente esto se&ntilde;ala
a la pasarela del extremo conectado.  Esto necesita ser explicado en
d1046 15
a1060 18
<li><strong>Configuration=</strong> se&ntilde;ala a la
secci&oacute;n de abajo.  Puede especificar m&uacute;ltiples secciones
como &eacute;sta.  Aqu&iacute; usamos la secci&oacute;n predefinida,
especificada en el fichero de muestra.

<li><strong>Authentication=</strong> es el secreto precompartido que va
a usar este extremo de la conexi&oacute;n en particular.  Es, m&aacute;s
o menos, una contrase&ntilde;a que usa cada extremo de la
conexi&oacute;n.  Esta contrase&ntilde;a se pasa al fichero
<em>policy</em> para verificar si tiene permiso para usar IPsec con este
anfitri&oacute;n.  Si cambiamos esta contrase&ntilde;a, tambi&eacute;n
debemos cambiarla en el fichero <em>policy</em>, porque el fichero de
muestra contiene una contrase&ntilde;a.  Si se ha decidido utilizar un
fichero <em>policy</em> m&iacute;nimo, entonces se puede especificar lo
que se quiera aqu&iacute;.

<li><strong>Flags=</strong> no se usa en la actualidad.  Los RFC dejan
lugar para que se especifiquen opciones adicionales para la fase 1.
d1062 2
d1067 1
a1067 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&apropos=0&sektion=5&format=html">isakmpd.conf(5)</a>.
d1072 2
a1073 2
<ul>
<pre>
d1080 1
a1080 2
</pre>
</ul>
d1082 1
d1084 2
a1085 2
<ul>
<pre>
d1092 1
a1092 2
</pre>
</ul>
d1101 3
a1103 3
<li><strong>Phase=2</strong> es necesaria porque el c&oacute;digo de
ISAKMPD usa las mismas funciones para autenticar las Fase 1 y la Fase 2.
Se requiere para que funcione la VPN.
d1105 1
a1105 1
<li><strong>ISAKMPD-Peer=</strong> es el nombre de la secci&oacute;n del
d1111 2
a1112 2
<li><strong>Configuration=</strong> se refiere a la secci&oacute;n que
describe las normativas que este anfitri&oacute;n y el extremo de la
d1115 2
a1116 2
<li><strong>Local-ID=</strong> se refiere a una secci&oacute;n IPsec-ID
que describe su Red Privada a la pasarela del otro extremo de la
d1121 4
a1124 4
<li><strong>Remote-ID=</strong> hace referencia a una secci&oacute;n
IPsec-ID que describe lo que se supone que la Red Privada remota es para
nuestro anfitri&oacute;n.  Esta porci&oacute;n debe ser interpretada
para la correcta configuraci&oacute;n de las tablas de enrutamiento que
a1126 1

d1128 4
a1131 4
Hay otro indicador que tiene soporte aqu&iacute; llamado
<strong>Flags=</strong>.  Si se necesita usar este indicador,
l&eacute;se antes la p&aacute;gina del manual de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&apropos=0&sektion=5&format=html">isakmpd.conf(5)</a>.
d1142 1
a1142 2
<ul>
<pre>
d1152 1
a1152 2
</pre>
</ul>
d1169 1
a1169 2
<ul>
<pre>
d1174 1
a1174 2
</pre>
</ul>
d1198 1
a1198 2
<ul>
<pre>
d1203 1
a1203 2
</pre>
</ul>
d1220 1
d1226 3
a1228 3
<ul>
<tt># <strong>isakmpd -d -DA=99</strong></tt>
</ul>
d1237 1
d1250 1
d1291 3
a1293 6
<p>
<ul>
<tt>
$ <strong>/usr/sbin/certpatch -t fqdn -i home.mysite.se -k ca.key originalcert.crt nuevocert.crt</strong>
</tt>
</ul>
d1310 1
d1318 1
a1318 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&sektion=5">isakmpd.conf(5)</a>,
a1337 1
<p>
d1361 1
a1361 2
<ul>
<pre>
d1563 1
a1563 2
</pre>
</ul>
d1572 1
a1572 3
<p>
<ul>
<pre>
d1611 1
a1611 2
</pre>
</ul>
d1617 1
d1625 1
a1625 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&sektion=5">isakmpd.policy(5)</a>
d1633 1
a1633 3
<p>
<ul>
<pre>
d1635 1
a1635 2
</pre>
</ul>
d1658 1
a1658 3
<p>
<ul>
<pre>
d1663 1
a1663 2
</pre>
</ul>
d1672 1
a1672 3
<p>
<ul>
<pre>
d1678 1
a1678 2
</pre>
</ul>
d1695 1
a1695 3
<p>
<ul>
<pre>
d1707 1
a1707 2
</pre>
</ul>
d1717 1
a1717 3
<p>
<ul>
<pre>
d1735 1
a1735 2
</pre>
</ul>
d1744 1
a1744 3
<p>
<ul>
<pre>
d1768 1
a1768 2
</pre>
</ul>
d1781 1
a1781 3
<p>
<ul>
<pre>
d1799 1
a1799 2
</pre>
</ul>
d1809 1
a1810 1

d1921 1
a1921 1
de <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&sektion=5">isakmpd.policy(5)</a>.
d1924 1
a1924 3
<p>
<ul>
<pre>
d1943 1
a1943 2
</pre>
</ul>
d1952 1
a1952 3
<p>
<ul>
<pre>
d1958 1
a1958 2
</pre>
</ul>
d1986 1
a1986 3
<p>
<ul>
<pre>  
d1997 1
a1997 2
</pre>
</ul>
d2004 3
a2006 6
<p>
<ul>
<tt>
$ <strong>openssl x509 -text &lt; ca.crt</strong>
</tt>
</ul>
d2020 1
d2040 1
a2040 3
<p>
<ul>
<pre>
d2043 1
a2043 2
</pre>
</ul>
d2065 1
a2065 3
<p>
<ul>
<pre>
d2097 1
a2097 2
</pre> 
</ul>
d2148 1
d2200 1
d2207 1
a2207 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&apropos=0&sektion=8&format=html">tcpdump(8)</a>.
a2217 1
<p>
d2224 1
a2224 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&apropos=0&sektion=8&format=html">ping(8)</a>
a2225 1

a2226 1
<ul>
a2228 1

d2230 1
a2230 1
# <strong>ping -c 3 208.1.1.1</strong>
a2238 1

a2240 1

d2242 1
a2242 1
# <strong>tcpdump -ni fxp7 host 208.1.1.1</strong>
d2249 1
a2249 1
<strong>^C</strong>
a2252 1
</ul>
d2259 1
a2259 2
<ul>
<pre>
d2267 1
a2267 2
</pre>
</ul>
d2272 3
a2274 6
<p>
<ul>
<tt>
# <strong>/sbin/isakmpd -d -DA=99</strong>
</tt>
</ul>
d2280 3
a2282 6
<p>
<ul>
<tt>
# <strong>/sbin/isakmpd -d -DA=99 -D1=70</strong>
</tt>
</ul>
d2288 1
a2288 2
<ul>
<pre>
d2291 1
a2291 2
</pre>
</ul>
d2302 3
a2304 6
<p>
<ul>
<tt>
# <strong>mkdir /kern; mount -t kernfs /kern /kern</strong>
</tt>
</ul>
d2314 1
a2314 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=netstat&apropos=0&sektion=1&format=html">netstat(1)</a>
d2317 2
a2318 3
<ul>
<pre>
$ <strong>netstat -rn -f encap</strong>
d2331 1
a2331 2
</pre>
</ul>
d2339 1
a2339 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendbug&apropos=0&sektion=1&format=html">sendbug(1)</a>.
d2345 1
d2353 1
a2353 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&apropos=0&sektion=0&format=html">vpn(8)</a>.
d2357 6
a2362 6
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=enc&sektion=4">enc(4)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&sektion=4">ipsec(4)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&sektion=8">ipsecadm(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&sektion=8">isakmpd(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&sektion=5">isakmpd.conf(5)</a> y
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&sektion=5">isakmpd.policy(5)</a>
d2370 12
a2381 6
   <li><a href="http://www.ietf.org/html.charters/ipsec-charter.html">Grupo de Trabajo de IPsec del IETF</a>
   <li><a href="http://isakmp-test.ssh.fi/">Nodo de Verificaci&oacute;n de Interoperabilidad de SSH IPsec</a>
   <li><a href="http://ipsec-wit.antd.nist.gov/">Verificador de Interoperabilidad de NIST IPsec basado en web</a>
   <li><a href="http://www.r4k.net/ipsec/">Porte de IPsec de OpenBSD para FreeBSD</a>
   <li><a href="http://www.xs4all.nl/~freeswan/">FreeS/WAN - IPsec para Linux</a>
   <li><a href="http://www.pintday.org/hack/docs/vpn-24-minifaq.shtml">Mini-FAQ de Configuraci&oacute;n de una VPN con OpenBSD 2.4</a>
d2386 2
a2387 1
Y en los RFC:</a>
d2390 57
a2446 27
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1320.html">RFC 1320</a> - The MD4 Message-Digest Algorithm
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1321.html">RFC 1321</a> - The MD5 Message-Digest Algorithm
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1828.html">RFC 1828</a> - IP Authentication using Keyed MD5
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc1829.html">RFC 1829</a> - The ESP DES-CBC Transform
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2040.html">RFC 2040</a> - The RC5, RC5-CBC, RC5-CBC-Pad, and RC5-CTS Algorithms
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2085.html">RFC 2085</a> - HMAC-MD5 IP Authentication with Replay Prevention
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2104.html">RFC 2104</a> - HMAC: Keyed-Hashing for Message Authentication
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2144.html">RFC 2144</a> - The CAST-128 Encryption Algorithm 
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2202.html">RFC 2202</a> - Test Cases for HMAC-MD5 and HMAC-SHA-1 
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2207.html">RFC 2207</a> - RSVP Extensions for IPsec Data Flows
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2268.html">RFC 2268</a> - A Description of the RC2 Encryption Algorithm 
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2367.html">RFC 2367</a> - PF_KEY Key Management API, Version 2
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2401.html">RFC 2401</a> - Security Architecture for the Internet Protocol (<strong>IPsec</strong>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2402.html">RFC 2402</a> - IP Authentication Header (<strong>AH</strong>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2403.html">RFC 2403</a> - The Use of HMAC-MD5-96 within ESP and AH
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2404.html">RFC 2404</a> - The Use of HMAC-SHA-1-96 within ESP and AH
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2405.html">RFC 2405</a> - The ESP DES-CBC Cipher Algorithm With Explicit IV
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">RFC 2406</a> - IP Encapsulating Security Payload (<strong>ESP</strong>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2407.html">RFC 2407</a> - The Internet IP Security Domain of Interpretation for ISAKMP
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2408.html">RFC 2408</a> - Internet Security Association and Key Management Protocol (<strong>ISAKMP</strong>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2409.html">RFC 2409</a> - The Internet Key Exchange (<strong>IKE</strong>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2410.html">RFC 2410</a> - The NULL Encryption Algorithm and Its Use With IPsec (ha ha...)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2411.html">RFC 2411</a> - IP Security Document Roadmap
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2412.html">RFC 2412</a> - The OAKLEY Key Determination Protocol
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2451.html">RFC 2451</a> - The ESP CBC-Mode Cipher Algorithms
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2631.html">RFC 2631</a> - Diffie-Hellman Key Agreement Method
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2709.html">RFC 2709</a> - Security Model with Tunnel-mode IPsec for NAT Domains
d2460 2
a2461 2
Originally [OpenBSD: faq13.html,v 1.60 2002/11/03 00:21:54 mcbride Exp ]<br>
$Translation: faq13.html,v 1.26 2002/11/06 22:21:47 horacio Exp $<br>
@


1.25
log
@
sync with badlands translation CVS
@
text
@d2280 16
a2295 16
   <li><a href="http://www.cisco.com/">Cisco</a> IOS
   <li><a href="http://www.cisco.com/">Cisco</a> PIX
   <li><a href="http://www.intel.com/">Intel</a> LanRover
<!--    <li><a href="http://www.timestep.com/">TimeStep</a> PERMIT/Gate -->
   <li><a href="http://www.cendio.com/">Cendio</a> Fuego
   <li><a href="http://www.kame.net/">KAME</a> para FreeBSD
   <li><a href="http://www.xs4all.nl/~freeswan/">FreeS/WAN</a> para
   Linux
   <li><a href="http://www.symantec.com/">Symantec</a> Raptor
   <li><a href="http://www.ericsson.com/">Ericsson</a> eBox
   <li><a href="http://www.f-secure.com/">F-Secure</a> VPN+
   <li><a href="http://www.teamware.com/">Teamware</a> TWISS
   <li><a href="http://www.3com.com/">3com</a> Pathbuilder
   <li><a href="http://www.nortelnetworks.com/">Nortel</a> Contivity
   <li><a href="http://www.checkpoint.com/">CheckPoint</a> FW-1
   <li><a href="http://www.watchguard.com/">Watchguard</a> Firebox III
d2541 2
a2542 2
Originally [OpenBSD: faq13.html,v 1.59 2002/09/26 18:20:28 nick Exp ]<br>
$Translation: faq13.html,v 1.25 2002/09/29 10:05:09 horacio Exp $<br>
@


1.24
log
@
sync with badlands translation CVS
@
text
@d5 1
d15 1
d19 2
a20 2
<h1><font color="#e00000">13.0 - Uso de IPsec (Protocolo de
Seguridad IP)</font></h1>
d27 5
a31 6
<li><a href="#Why">13.2 - Muy bien pero, &iquest;para
qu&eacute; querr&iacute;a usar IPsec?</a>
<li><a href="#Protocols">13.3 - &iquest;Cu&aacute;les son los
protocolos detr&aacute;s de IPsec?</a>
<li><a href="#Wire">13.4 - Sobre el formato
&quot;wire&quot;</a>
d33 3
a35 4
<li><a href="#ManKey">13.6 - &iquest;C&oacute;mo configuro
IPsec con el sistema de &laquo;claves manuales&raquo;?</a>
<li><a href="#isakmpd">13.7 - &iquest;C&oacute;mo configuro
isakmpd?</a>
d38 5
a42 6
<li><a href="#IKEcl">13.9 - &iquest;Qu&eacute; clientes IKE
son compatibles con isakmpd?</a>
<li><a href="#Trouble">13.10 - Resoluci&oacute;n de problemas
de IPsec/VPN</a>
<li><a href="#SeeAlso">13.11 - Documentaci&oacute;n
relacionada</a>
d50 3
a52 3
<li><a href="http://www.freebsd.org/~julian/IPSEC_4_Dummies.html">IPsec for Dummies</a> por Julian Elischer
<li><a href="http://www.secureops.com/vpn/vpn.html">ISAKMP Howto</a> por Patrick Ethier
<li><a href="http://hem.passagen.se/hojg/isakmpd/">X.509v3 certificates with isakmpd</a> por J&ouml;rgen Granstam
a60 1
</p>
d63 8
a70 9
IPsec es un grupo de extensiones de la familia del protocolo
IP.  IPsec provee servicios criptogr&aacute;ficos de
seguridad.  Estos servicios permiten la autenticaci&oacute;n,
integridad, control de acceso, y confidencialidad.  IPsec
provee servicios similares a SSL, pero a nivel de redes, de un
modo que es completamente transparente para sus aplicaciones y
mucho m&aacute;s robusto.  Es transparente porque sus
aplicaciones no necesitan tener ning&uacute;n conocimiento de
IPsec para poder usarlo.  Puede usar
d72 4
a75 4
sobre IPsec.  Puede crear t&uacute;neles cifrados (VPN), o
simple cifrado entre computadoras (ordenadores).  Debido a que
dispone de tantas opciones, IPsec es m&aacute;s bien complejo
(&iexcl;mucho m&aacute;s que SSL!).
d78 2
a79 2
Antes de empezar a usar IPsec, le recomendamos encarecidamente
que mire la &laquo;lectura recomendada&raquo; de la 
d81 2
a82 2
frecuentes.  En particular, si todav&iacute;a no lo entiende,
el documento 
d85 2
a86 1
<a href="http://www.3com.com/other/pdfs/infra/corpinfo/en_US/501302.pdf">este enlace</a>).
d89 2
a90 2
De un modo l&oacute;gico, IPsec funciona en cualquiera de
estos tres modos:
d98 4
a101 4
En cualquier escenario en el que haya una red, el concepto de
enrutador est&aacute; impl&iacute;cito, como en
Anfitri&oacute;n-a-Enrutador (y este enrutador controla y
cifra el tr&aacute;fico para una <em>Red</em> particular).
d104 8
a111 8
Como puede ver, IPsec se puede usar como t&uacute;nel de
tr&aacute;fico para conexiones de &laquo;redes privadas
virtuales&raquo; (VPN, <em>Virtual Private Networks</em>).
Sin embargo, su utilidad va m&aacute;s all&aacute; de las VPN.
Con un registro central de &laquo;intercambio de claves de
internet&raquo; (IKE, <em>Internet Key Exchange</em>), cada
m&aacute;quina en internet podr&iacute;a comunicarse con otra
y usar cifrado y autenticaci&oacute;n de alto grado.
d116 2
a117 3
<h1>13.2 - Muy bien pero, &iquest;para qu&eacute;
querr&iacute;a usar IPsec?</h1>
</p>
d120 6
a125 7
El protocolo de internet, IP, tambi&eacute;n conocido como
IPv4, no provee por s&iacute; mismo de ninguna
protecci&oacute;n a sus transferencias de datos.  Ni siquiera
puede garantizar que el remitente sea quien dice ser.  IPsec
intenta remediarlo.  Estos servicios vienen tratados como dos
servicios distintos, pero IPsec ofrece soporte para ambos de
un modo uniforme.
d130 4
a133 5
Aseg&uacute;rese de que sea dif&iacute;cil para todos
comprender qu&eacute; datos se han comunicado, excepto para el
receptor.  No querr&aacute; que nadie vea sus
contrase&ntilde;as cuando ingrese en una m&aacute;quina remota
a trav&eacute;s de Internet.
d138 5
a142 5
Garantice que los datos no puedan ser cambiados en el camino.
Si se encuentra en una l&iacute;nea que lleve datos sobre
facturaci&oacute;n, querr&aacute; estar seguro de que las
cantidades y cifras de contabilidad son las correctas, y que
no han podido ser alteradas durante el tr&aacute;nsito.
d147 3
a149 3
Firme sus datos de modo que otros puedan verificar que es
realmente Vd.  quien los envi&oacute;.  Es agradable saber que
los documentos no son falsos.
d154 6
a159 7
Necesitamos modos para asegurarnos de que una
transacci&oacute;n s&oacute;lo se puede llevar a cabo una vez,
a menos que autoricemos que la repitan.  Nadie deber&iacute;a
poder grabar una transacci&oacute;n, y luego replicarla al pie
de la letra, con el prop&oacute;sito que pareciera como si se
hubieran recibido m&uacute;ltiples transacciones del remitente
original.  Imagine que el atacante deba conocer cu&aacute;l es
d161 7
a167 8
descifrarlo, y que el tr&aacute;fico causara sucesos
favorables para &eacute;l, como depositar dinero en su cuenta.
Tendr&iacute;amos que asegurarnos que no pudiera replicar ese
tr&aacute;fico m&aacute;s tarde.
<em>AVISO: tal y como lo especifica la normativa, la
protecci&oacute;n a la r&eacute;plica no se llevar&aacute; a
cabo cuando se use el sistema de claves manuales de IPsec
(v.g., cuando se est&eacute; usando 
d173 2
a174 3
<h1>13.3 - &iquest;Cu&aacute;les son los protocolos
detr&aacute;s de IPsec?</h1>
</p>
d178 20
a197 23
protecci&oacute;n a la r&eacute;plica a trav&eacute;s de dos
nuevos protocolos.  Estos protocolos se llaman &laquo;Cabecera
de Autenticaci&oacute;n&raquo; (AH, &quot;Authentication
Header&quot;) y &laquo;Cargo de Seguridad Encapsulado&raquo;
(ESP, &quot;Encapsulated Security Payload&quot;).

<p>
AH provee auntenticaci&oacute;n, integridad, y
protecci&oacute;n a la r&eacute;plica (pero no
confidencialidad).  Su principal diferencia con ESP es que AH
tambi&eacute;n asegura partes de la cabecera IP del paquete
(como las direcciones de origen o destino).

<p>
ESP puede proveer autenticaci&oacute;n, integridad,
protecci&oacute;n a la r&eacute;plica, y confidencialidad de
los datos (asegura todo lo que sigue a la cabecera en el
paquete).  La protecci&oacute;n a la r&eacute;plica requiere
autenticaci&oacute;n e integridad (&eacute;stas dos van
siempre juntas).  La confidencialidad (cifrado) se puede usar
con o sin autenticaci&oacute;n y/o integridad.  Del mismo
modo, puede usar la autenticaci&oacute;n y/o la integridad con
o sin la confidencialidad.
a202 1
</p>
d205 10
a214 10
La <strong>Cabecera de Autenticaci&oacute;n</strong> (AH)
viene de la cabecera b&aacute;sica IP y contiene
res&uacute;menes criptogr&aacute;ficos (&quot;hash&quot;) de
los datos e informaci&oacute;n de identificaci&oacute;n.  Los
res&uacute;menes criptogr&aacute;ficos tambi&eacute;n pueden
cubrir las partes invariables de la misma cabecera de IP.  Hay
varios RFC diferentes que ofrecen una elecci&oacute;n de
algoritmos para AH, sin embargo todos deben seguir las
l&iacute;neas especificadas en el
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2402.html">RFC2402</a>.
d218 8
a225 8
Encapsulada</strong> (<em>Encapsulated Security Payload</em>,
ESP) permite reescribir el cargo en modo cifrado.  La cabecera
ESP no considera los campos de la cabecera IP que van delante,
y por lo tanto no garantiza nada excepto el cargo.  Los
distintos tipos de ESP aplicables deben seguir conformar con
el <a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">RFC2406</a>.
Una cabecera ESP tambi&eacute;n puede proveer
autenticaci&oacute;n para el cargo (pero no la cabecera
d229 4
a232 4
Una divisi&oacute;n ortogonal (en su mayor parte) de
funcionalidad de IPsec, se aplica dependiendo de si el extremo
que est&aacute; llevando a cabo la encapsulaci&oacute;n IPsec
es la fuente original de los datos o una pasarela:
d236 17
a252 20
   anfitri&oacute;n que genera los paquetes.  En modo
   transporte, las cabeceras de seguridad se a&ntilde;aden
   antes que las cabeceras de la capa de transporte (v.g.,
   TCP, UDP), antes de que la cabecera IP sea a&ntilde;adida
   al paquete.  En otras palabras, un AH a&ntilde;adido al
   paquete cubrir&aacute; el resumen criptogr&aacute;fico de
   la cabecera TCP y algunos campos de la cabecera IP
   extremo-a-extremo, y una cabecera ESP cubrir&aacute; el
   cifrado de la cabecera TCP y los datos, pero no la cabecera
   IP extremo-a-extremo.</li>

   <li>El modo <strong>T&uacute;nel</strong> se usa cuando la
   cabecera IP extremo-a-extremo ya ha sido adjuntada al
   paquete, y uno de los extremos de la conexi&oacute;n segura
   es solamente una pasarela.  En este modo, las cabeceras AH
   y ESP se usan para cubrir todo el paquete, incluida la
   cabecera extremo-a-extremo, y se a&ntilde;ade una nueva
   cabecera IP al paquete que cubre s&oacute;lo el salto al
   otro extremo de la conexi&oacute;n segura (aunque eso
   puedan ser varios saltos de distancia).</li>
d257 17
a273 20
&laquo;Asociaciones de Seguridad&raquo;
(<strong>SA</strong>s).  Cada SA viene definida por un
&uacute;nico flujo unidireccional de datos, y por regla
general (ignorando multicast) desde un &uacute;nico punto
hasta otro, cubriendo el tr&aacute;fico que se distingue por
alg&uacute;n &laquo;selector &uacute;nico&raquo;.  Todo el
flujo de tr&aacute;fico sobre un &uacute;nico SA se trata del
mismo modo.  Algo del tr&aacute;fico puede estar sujeto a
varios SAs, cada uno de los cuales aplica alg&uacute;n tipo de
transformaci&oacute;n criptogr&aacute;fica.  Un grupo de SAs
se conoce como un &laquo;Haz&raquo; (&quot;SA Bundle&quot;).
Los paquetes entrantes se pueden asignar a un SA particular
por medio de los tres campos de definici&oacute;n:

<ul>
   <li>&laquo;Direcci&oacute;n IP de destino&raquo;
   (&quot;destination IP address&quot;)
   <li>&laquo;&Iacute;ndice del Par&aacute;metro de
   Seguridad&raquo; (SPI, &quot;Security Parameter
   Index&quot;)
d278 7
a284 7
SPI se puede considerar como un &quot;cookie&quot; manejado
por el receptor del SA, cuando se negocian los
par&aacute;metros de la conexi&oacute;n.  El protocolo de
seguridad debe ser AH o ESP.  Debido a que la direcci&oacute;n
IP del receptor es parte del tr&iacute;o, &eacute;sta es un
valor &uacute;nico garantizado.  Se pueden encontrar desde la
cabecera IP exterior y la primera cabecera de seguridad (que
d315 3
a317 3
Debido a que una cabecera ESP no puede autenticar la cabecera
IP exterior, es &uacute;til combinar una cabecera AH y una ESP
para obtener lo siguiente:
d331 1
a331 1
A esto se le llama &laquo;Adyacencia de Transporte&raquo;.  La
d347 8
a354 9
Sin embargo, no se menciona en el RFC.  Como ocurre con la
adyacencia de Transporte, esto autenticar&iacute;a todo el
paquete excepto unas cuantas cabeceras de la cabecera IP, y
tambi&eacute;n cifrar&iacute;a la carga (en el ejemplo, en
bastardilla).  Cuando una cabecera AH y una ESP se aplican
juntas directamente como en este caso, el orden de las
cabeceras deber&iacute;a ser como el que se ha mostrado.  En
modo t&uacute;nel es posible hacer encapsulaci&oacute;n
recursiva arbitraria para que no se especifique el orden.
a359 1
</p>
d362 25
a386 27
La forma en la que se configuran los sistemas IPsec y las
pasarelas es, hasta un cierto punto, trabajo del diseñador;
sin embargo, el RFC contiene algunas recomendaciones
importantes sobre c&oacute;mo se deber&iacute;a implementar
para evitar al m&aacute;ximo la confusi&oacute;n.

<p>
Existen dos entidades administrativas que controlan lo que le
ocurre a un paquete.  Una es la &laquo;Base de Datos de
Asociaci&oacute;n de la Seguridad&raquo; (SAD, &quot;Security
Association Database&quot;, llamado TDB o tabla TDB en el
c&oacute;digo fuente de IPsec de OpenBSD), y el otro es la
&laquo;Base de Datos de Pol&iacute;tica de la Seguridad&raquo;
(SPD, &quot;Security Policy Database&quot;).

<p>
Las dos se parecen en que, dado un n&uacute;mero de selectores
que describan algo de tr&aacute;fico, entregar&aacute;n una
entrada que describa el proceso necesario.  Sin embargo, SPD
se elimina a dos pasos del proceso:  SPD se usa para paquetes
salientes, para decidir qu&eacute; entradas SAD se deben usar,
y qu&eacute; entradas SAD describen el proceso y sus
par&aacute;metros.  Las entradas SPD especifican las entradas
SAD existentes a usar (si es un &laquo;haz&raquo; puede haber
m&aacute;s de una), pero si no hay una que se pueda usar,
entonces se usa para crear otras nuevas.  Los campos de SA que
se crean se pueden tomar de la entrada SPD o del paquete que
d390 3
a392 4
Los paquetes salientes van desde la entrada SPD a la
especificada de SA, para obtener par&aacute;metros de
codificaci&oacute;n.  Los paquetes entrantes obtienen la SA
correcta directamente, usando el tr&iacute;o
d397 5
a401 6
deber&iacute;a circunvalar IPsec, y cu&aacute;l se
deber&iacute;a dejar caer, as&iacute; que tambi&eacute;n debe
ser consultado para tr&aacute;fico no IPsec entrante.  Las
entradas SPD se deben ordenar de forma expl&iacute;cita, ya
que varias podr&iacute;an coincidir con un paquete particular,
y el proceso debe ser reproducible.
d404 5
a408 6
Se puede pensar en SPD como algo parecido a un filtro de
paquetes, en el que las acciones que se deciden son la
activaci&oacute;n de procesos SA.  Los selectores pueden
incluir direcciones de origen y destino, n&uacute;meros de
puertos si fueran relevantes, nombres de anfitriones, niveles
de sensibilidad de seguridad, protocolos, etc...
d437 6
a442 7
sesi&oacute;n de IPsec debe tener una de las dos o ambas, pero
no se puede definir sin ninguna de las dos (en caso contrario
no habr&iacute;a cabeceras para especificar el SPI que deba
buscar la SA).  El RFC no dice qu&eacute; suceder&iacute;a si
las cabeceras AH y ESP estuvieran en desacuerdo sobre el valor
de SPI.  Se puede pensar que esto implicar&iacute;a
m&uacute;ltiples SAs en un haz.
d445 4
a448 4
En OpenBSD, SPD se gestiona a trav&eacute;s de la orden
<tt>ipsecadm flow</tt> (s&oacute;lo se cambiar&iacute;a si
estuviera usando el sistema de claves manual).  Las entradas
de SAD se pueden configurar manualmente con
d451 3
a453 6
autom&aacute;ticos para la iniciaci&oacute;n de sesiones y
otras cosas como el intercambio de claves.  OpenBSD implementa
Photuris 
(<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2522.html">RFC2522</a> y
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2523.html">RFC2523</a>) e
intercambio autom&aacute;tico de claves ISAKMP
d457 2
a458 3
en los d&aelig;mons
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=photurisd&apropos=0&sektion=8&format=html">photurisd(8)</a> e
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&apropos=0&sektion=8&format=html">isakmpd(8)</a>.
d463 2
a464 3
<h1>13.6 - &iquest;C&oacute;mo configuro IPsec con el sistema
de &laquo;claves manuales&raquo;?</h1>
</p>
d467 5
a471 6
El sistema de claves manuales es el m&aacute;s sencillo para
empezar con IPsec.  Con este m&eacute;todo puede activar los
sistemas criptogr&aacute;ficos de cifrado entre redes y crear
VPN.  Despu&eacute;s de que haya leido esta secci&oacute;n,
puede investigar c&oacute;mo configurarlo de forma
autom&aacute;tica mediante el uso de
d475 6
a480 6
Para empezar debe activar las opciones IP AH e IP ESP en el
n&uacute;cleo del sistema de OpenBSD (si s&oacute;lo
est&aacute; usando ESP, como con el gui&oacute;n rc.vpn,
entonce <em>no necesita activar AH</em>;  de hecho, puede
haber problemas relacionados con la seguridad activando AH si
no lo est&aacute; usando).
d494 5
a498 6
Puede editar <em>/etc/sysctl.conf</em> para activarlos durante
el arranque.  Para ello borre la marca de comentario # que
ver&aacute; delante de la l&iacute;nea net.inet.esp.enable y/o
net.inet.ah.enable (dependiendo de cu&aacute;l vaya a usar) y
aseg&uacute;rese de que est&eacute;n configuradas con el valor
1.
d501 5
a505 5
Tambi&eacute;n tendr&aacute; que generar sus claves manuales.
Como la seguridad del VPN se basa en que estas claves no se
puedan &laquo;adivinar&raquo;, es muy importante escoger las
claves usando una fuente aleatoria fuerte.  Un m&eacute;todo
pr&aacute;ctico de generarlas es usar el dispositivo
d507 1
a507 1
Por ejemplo, para producir 160 bits de aleatoriedad, ponga:
d515 3
a517 3
El n&uacute;mero de bits producidos es importante.  Tipos de
cifrado diferentes pueden requerir claves de tama&ntilde;os
tambi&eacute;n diferentes.
d531 6
a536 7
Ahora tiene que configurar las SAs (&laquo;Asociaciones de
Seguridad&raquo;).  Una SA es una combinaci&oacute;n de sus
direcciones IP, un SPI, y su protocolo de seguridad (AH y/o
ESP).  Las direcciones IP son la suya y la de su destino.  El
SPI (&laquo;&Iacute;ndice del Par&aacute;metro de
Seguridad&raquo;) es un n&uacute;mero que OpenBSD usa para
clasificar distintas SAs.
d540 5
a544 6
tr&aacute;fico.  ESP incluye la autenticaci&oacute;n de los
datos cifrados contenidos, pero no autentica la cabecera IP a
su alrededor.  Esta &laquo;autenticaci&oacute;n
limitada&raquo; es, sin embargo, suficiente para la
mayor&iacute;a de casos, especialmente para ESP en un entorno
de t&uacute;neles.</em>
d554 2
a555 2
Llev&eacute;moslo a la pr&aacute;ctica con dos enrutadores,
192.168.5.1 y 192.168.25.9.
d580 4
a583 5
N&oacute;tese que los SPI son distintos.  V&eacute;se la
secci&oacute;n sobre el <a href="#Wire">formato
&quot;wire&quot;</a> para una descripci&oacute;n completa
sobre qu&eacute; es el SPI y sobre d&oacute;nde se est&aacute;
usando.
d586 2
a587 2
Ahora que ya tiene sus Asociaciones de Seguridad en su sitio,
configure sus flujos.
d594 4
a597 5
ser&aacute; la direcci&oacute;n de origen local, que
cubrir&aacute; todos los paquetes que originen del
anfitri&oacute;n local hacia el destino, y el otro ser&aacute;
el flujo de vuelta desde el destino hasta el anfitri&oacute;n
local.
d614 19
a632 23
Si no necesita tanta carga en sus VPN
Hu&eacute;sped-a-Hu&eacute;sped puede crear el SPI sin
<tt>-forcetunnel</tt>, lo que le permitir&aacute; usar el modo
de transporte (mientras que <tt>-forcetunnel</tt> asegura que
todo en el paquete IP, incluida la cabecera IP, sea
encapsulado por SPI).  Si el origen o el destino es una red,
tendr&aacute; que usar el modo de t&uacute;nel.  Crear una SA
hacia o desde una red le asegurar&aacute;
autom&aacute;ticamente que se est&eacute;n creando los SPI en
modo t&uacute;nel.

<p>
&Eacute;ste es un m&eacute;todo simple para empezar a usar
IPsec.

<p>
Puede usar IPsec para pasar los espacios de direcciones IP
privados por t&uacute;neles en Internet.  He aqu&iacute; un
buen ejemplo:  Queremos pasar 192.168.99.0/24 (que se
encuentra detr&aacute;s de 208.1.1.1) por t&uacute;neles a
208.1.2.0/24 y 208.1.5.0/24 (que est&aacute;n detr&aacute;s de
208.2.2.2).  Estos ejemplos se han generado usando el
gui&oacute;n
d636 4
a639 4
Como puede ver, cuando est&aacute; usando el sistema de claves
manuales con IPsec tiene que especificar <strong>con
exactitud</strong> lo que quiere hacer.  No lo
adivinar&aacute; por usted.  Mire estos ejemplos:
d644 1
a644 1
Primero configure las asociaciones de seguridad (SA):
d646 1
a646 1
(esto configura los SPI, m&eacute;todos de cifrado, y claves)
d657 1
a657 1
A continuaci&oacute;n configure un flujo desde 208.1.1.1 hasta
d667 1
a667 1
Configure un flujo desde 208.1.2.0/24 (que est&aacute;
d677 1
a677 1
Configure un flujo desde 208.1.5.0/24 (que est&aacute;
d687 1
a687 1
Configure un flujo desde 208.1.2.0/24 (que est&aacute;
d697 1
a697 1
Configure un flujo desde 208.1.5.0/24 (que est&aacute;
d707 2
a708 2
Finalmente, configure un flujo desde el enrutador 208.2.2.2
hasta el 192.168.99.0/24
d732 2
a733 2
Ahora, &eacute;sta es la parte al inverso...  Configure un
flujo desde el enrutador 208.2.2.2 hasta el 208.1.1.1
d742 1
a742 1
Configure un flujo desde la red 192.168.99.0/24 (que
d752 1
a752 1
Configure un flujo desde la red 192.168.99.0/24 (que
d762 2
a763 2
Configure un flujo desde 192.169.99.0/24 (que est&aacute;
detr&aacute;s de 208.1.1.1) hasta el enrutador 208.2.2.2
d772 2
a773 3
Ya casi hemos terminado...  Quedan dos flujos para obtener
208.1.2.0/24 y 208.1.5.0/24 desde el enrutador 208.2.2.2 hasta
el enrutador 208.1.1.1
d785 2
a786 2
Si ha usado ipsecadm, y quiere librarse de cualquier trabajo
que haya hecho y empezar desde cero, haga
d794 2
a795 2
Esto limpiar&aacute; toda la informaci&oacute;n de IPsec
(SPIs, flujos, entradas de enrutamiento) de su sistema.
a799 1
</p>
d802 5
a806 6
Si est&aacute; pensando en &laquo;redes privadas
virtuales&raquo; (VPN) u otras aplicaciones tradicionales de
IPsec, probablemente vaya a usar ISAKMP.  Algunas
implementaciones comerciales de IPsec no proveen ning&uacute;n
tipo de sistema de claves manual, y en su lugar requieren que
use alg&uacute;n tipo de ISAKMP.
d811 6
a816 7
ISAKMP, tambi&eacute;n conocido como &laquo;Intercambio de
Claves por Internet&raquo; (IKE, &quot;Internet Key
Exchange&quot;) es el mecanismo de intercambio para la VPN.
ISAKMP aborda los problemas de seguridad usando los
m&eacute;todos mencionados en los RFC 2407, 2408 y 2409.
ISAKMP gestiona el intercambio de claves criptogr&aacute;ficas
que normalmente tendr&iacute;a que gestionar usted con
d818 1
a818 1
Para ello hace uso de un proceso en dos fases para establecer
d822 33
a854 37
<strong>Fase 1</strong> - Los dos extremos de conexiones
ISAKMP establecen un canal seguro, autenticado, sobre el cual
se comunican entre dos d&aelig;mons.  &Eacute;sto establece
una Asociaci&oacute;n de Seguridad (SA) entre ambos
anfitriones.  Los m&eacute;todos usados para establecer este
canal son el <strong>Main Mode</strong> (modo principal) y el
<strong>Agressive Mode</strong> (modo agresivo).  El Modo
Principal env&iacute;a la variada informaci&oacute;n sobre
autenticaci&oacute;n en una cierta secuencia, al tiempo que
provee protecci&oacute;n para la identidad.  El Modo Agresivo
no provee esta protecci&oacute;n a la identidad porque toda la
informaci&oacute;n sobre la autenticaci&oacute;n se
env&iacute;a al mismo tiempo.  El modo agresivo s&oacute;lo se
deber&iacute;a usar en casos en los que preocupe el ancho de
banda de la red.

<p>
<strong>Fase 2</strong> - Las Asociaciones de Seguridad se
negocian en nombre de IPsec.  La fase 2 establece
t&uacute;neles o Asociaciones de Seguridad (SA)
t&eacute;rminos entre anfitriones IPsec.  El <strong>Quick
Mode</strong> (modo r&aacute;pido) se usa en la fase 2 porque
no es necesario repetir una autenticaci&oacute;n total;  la
fase 1 ya ha establecido las SA.

<p>
Resumiendo, la fase 1 se usa para obtener un canal seguro en
el que llevar a cabo las configuraciones (m&aacute;s
r&aacute;pidas) de la fase 2.  Puede haber m&uacute;ltiples
configuraciones de la fase 2 en el mismo canal que la fase 1.
La fase 2 se usa para configurar los t&uacute;neles.  En la
fase 1, sus nodos de IPsec establecen una conexi&oacute;n en
la que intercambian autenticaci&oacute;n (bien sea un
certificado X.509 &oacute; un secreto precompartido).  Esto
permite que cada extremo se asegure de que el otro extremo sea
autenticado.  La fase 2 es un intercambio de claves que
determinan c&oacute;mo se cifran los datos entre los dos.
d860 5
a864 6
OpenBSD viene con los binarios para ISAKMP y para todo IPsec
por definici&oacute;n, pero no con los ficheros de muestra.
Para obtenerlos necesita bajarse
/usr/src/sbin/isakmpd/samples/VPN-east.conf y
/usr/src/sbin/isakmpd/samples/policy del &aacute;rbol de
fuentes.  Puede usar su CD (si tiene uno),
d866 2
a867 2
<a href="../../es/anoncvs.html">cliente de CVS en la
l&iacute;nea de &oacute;rdenes</a> (Cvsweb tiene
d870 7
a876 8
disponibles).  Para este ejemplo, copie <em>policy</em> a
<em>/etc/isakmpd/isakmpd.policy</em>, y <em>VPN-east.conf</em>
a <em>/etc/isakmpd/isakmpd.conf</em>.  Intentaremos mostrarle
c&oacute;mo configurar una VPN (t&uacute;nel).  Si desea usar
isakmpd entre anfitriones &uacute;nicos, hay otros ficheros de
configuraci&oacute;n en el directorio <em>samples</em>.  Las
p&aacute;ginas de manual contienen informaci&oacute;n
detallada.  No se olvide de
d881 15
a895 18
Su primer paso es activar ESP.  En el
<a href="#ManKey">principio de la secci&oacute;n 13.6</a>
se explica c&oacute;mo hacerlo, tanto en tiempo de arranque
como con el sistema funcionando.  Despu&eacute;s debe editar
<em>/etc/isakmpd.policy</em>.  Este fichero indica a ISAKMP
qui&eacute;n puede acceder a IPsec.  En este ejemplo, el
fichero <em>policy</em> indica que cualquiera que env&iacute;e
datos usando ESP, y que se haya autenticado con la
contrase&ntilde;a <kbd>mekmitasdigoat</kbd> (o cualquier otra
contrase&ntilde;a que Vd. determine), puede comunicarse con
isakmpd.  Puede modificar este fichero para indicar a ISAKMP
que s&oacute;lo quiere permitir datos firmados con ciertos
certificados digitales o usando una cierta
transformaci&oacute;n de cifrado.  Tambi&eacute;n puede
permitir el acceso a IPsec a cualquiera.  Esto s&oacute;lo es
recomendable para pruebas.  Para ello, edite su fichero
<em>policy</em> para que contenga s&oacute;lo las siguientes
l&iacute;neas:
d906 3
a908 3
El mismo fichero <em>policy</em> contiene dos l&iacute;neas
que empiezan con el car&aacute;cter $.  Debe eliminar esas
l&iacute;neas antes de usarlo, son s&oacute;lo para cvs.
d911 2
a912 2
Un fichero <em>policy</em> m&aacute;s &uacute;til para este
ejemplo ser&iacute;a:
d925 5
a929 5
Implementando esto obtendr&aacute; solamente una VPN
(t&uacute;nel) b&aacute;sica que use ESP.  En el
anfitri&oacute;n A, edite /etc/isakmpd/isakmpd.conf.  La
direcci&oacute;n IP de muestra 249.2.2.2, debe ser reemplazada
con la direcci&oacute;n IP externa del anfitri&oacute;n A.
d940 1
a940 1
Haga algo parecido con isakmpd.conf en el anfitri&oacute;n B.
d954 9
a962 10
Aqu&iacute; es donde puede configurar las variables que
afectar&aacute;n al comportamiento principal de isakmpd.  El
uso de los predefinidos aqu&iacute; es correcto.  El valor
<strong>Listen-on</strong>= especifica el IP en el que isakmpd
debe estar a la escucha.  S&oacute;lo es necesario el IP de
Internet de su pasarela.  Si tiene interfaces m&uacute;ltiples
externas en su pasarela, podr&iacute;a especificar una lista
de las interfaces en las que quiere que est&eacute; a la
escucha, introduci&eacute;ndolas, separadas por comas, en una
lista.
d965 2
a966 2
A continuaci&oacute;n, en el anfitri&oacute;n A, edite
isakmpd.conf otra vez:
d985 6
a990 7
Esta secci&oacute;n describe qu&eacute; direcciones IP se
deben aceptar para negociar la conexi&oacute;n de la fase 1.
Su valor se&ntilde;ala a la secci&oacute;n de m&aacute;s abajo
(recuerde que la fase 1 s&oacute;lo autentica la
conexi&oacute;n remota para asegurar que sean quienes afirman
ser).  Puede dar una lista de m&uacute;ltiples direcciones con
l&iacute;neas adicionales en el formato IP_Address=<em>
d1013 3
a1015 3
Esto describe la fase 2 de la conexi&oacute;n.  &Eacute;sta es
la fase que determina qu&eacute; protocolos usar&aacute;n las
dos partes para comunicarse.
d1019 5
a1023 6
secci&oacute;n de m&aacute;s abajo.  Inicia los requisitos o
los m&eacute;todos aceptados para activar la fase 2.
Tambi&eacute;n le indica a ISAKMPD qu&eacute; conexiones debe
iniciar una vez haya comenzado.  Puede tener secciones
m&uacute;ltiples, como se ilustra abajo, si va a conectar con
m&uacute;ltiples anfitriones.
d1026 5
a1030 6
Si no tiene la direcci&oacute;n IP del anfitri&oacute;n
remoto, puede especificar un <strong>Default</strong>= que
se&ntilde;ale a una secci&oacute;n que describa una entrada
gen&eacute;rica que servir&aacute; de referencia para
cualquier IP entrante que no est&eacute; en la lista del
indicador <strong>Connections</strong>=.
d1063 5
a1067 6
&Eacute;stas representan las secciones a las que se refiere en
la secci&oacute;n anterior sobre la fase 1.  Cada una de ellas
describe los requisitos que debe cumplir la pasarela del
extremo que intenta conectar, para proceder a la fase 2.
Aqu&iacute; hay muchas otras opciones, pero las que se
mencionan son los requisitos m&iacute;nimos.
d1070 23
a1092 26
<li><strong>Fase=1</strong> se requiere porque el
c&oacute;digo ISAKMPD usa los mismos procedimientos para
procesar Fase 1 y Fase 2.  Debe ser <strong>1</strong> o no
funcionar&aacute; nada.

<li><strong>Transport=</strong> le ofrece diferentes
posiblidades para diferentes anfitriones que vayan a conectar.
Se sugiere que aqu&iacute; se use UDP, as&iacute; que lo
dejaremos en este punto.  Algunos anfitriones que vayan a
conectar pueden estar detr&aacute;s de un cortafuegos que no
permita pasar tr&aacute;fico UDP.  Esto debe ser determinado
antes de activarlo.

<li><strong>Local-address</strong> es la direcci&oacute;n de
destino a la que se&ntilde;alan los paquetes entrantes.  En
algunos casos, puede estar escuchando conexiones para Fase 1
en distintas interfaces.  En esta muestra, s&oacute;lo hay una
interfaz escuchando, por tanto &eacute;ste es el IP de la
interfaz de escucha en este extremo de la conexi&oacute;n.

<li><strong>Address=</strong> es la direcci&oacute;n que
se&ntilde;ala al origen IP de los paquetes entrantes.
Generalmente esto se&ntilde;ala a la pasarela del extremo
conectado.  Esto necesita ser explicado en m&aacute;s detalle,
porque la direcci&oacute;n IP de origen del otro extremo puede
ser desconocida.
d1095 17
a1111 21
secci&oacute;n de abajo.  Puede especificar m&uacute;ltiples
secciones como &eacute;sta.  Aqu&iacute; usamos la
secci&oacute;n predefinida, especificada en el fichero de
muestra.

<li><strong>Authentication=</strong> es el secreto
precompartido que va a usar este extremo de la conexi&oacute;n
en particular.  Es, m&aacute;s o menos, una contrase&ntilde;a
que usa cada extremo de la conexi&oacute;n.  Esta
contrase&ntilde;a se pasa al fichero <em>policy</em> para
verificar si tiene permiso para usar IPsec con este
anfitri&oacute;n.  Si cambia esta contrase&ntilde;a,
tambi&eacute;n debe cambiarla en el fichero <em>policy</em>,
porque el fichero de muestra contiene una contrase&ntilde;a.
Si ha decidido que va a utilizar un fichero <em>policy</em>
m&iacute;nimo, entonces puede especificar lo que quiera
aqu&iacute;.

<li><strong>Flags=</strong> no se usa en la actualidad.  Los
RFC dejan lugar para que se especifiquen opciones adicionales
para la fase 1.
d1115 2
a1116 3
Lea la p&aacute;gina del manual de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.conf&apropos=0&sektion=5&format=html">isakmpd.conf(5)</a>
para ver las descripciones.
d1145 32
a1176 38
&Eacute;stas representan las secciones a las que se refiere en
la secci&oacute;n anterior sobre la fase 2.  Son las
configuraciones individuales que ISAKMPD debe usar para hablar
entre las dos pasarelas de la conexi&oacute;n.

<ul>
<li><strong>Phase=2</strong> es necesaria porque el
c&oacute;digo de ISAKMPD usa las mismas funciones para
autenticar las Fase 1 y la Fase 2.  Se requiere para que
funcione la VPN.

<li><strong>ISAKMPD-Peer=</strong> es el nombre de la
secci&oacute;n del anfitri&oacute;n.  Esto significa que
estamos hablando con ese extremo de la conexi&oacute;n en
particular para establecer una conexi&oacute;n de Fase 2.  Se
provee para que pueda tener secciones m&uacute;ltiples que
describan conexiones isakmp.

<li><strong>Configuration=</strong> se refiere a la
secci&oacute;n que describe las normativas que este
anfitri&oacute;n y el extremo de la conexi&oacute;n en
concreto deben cumplir.

<li><strong>Local-ID=</strong> se refiere a una secci&oacute;n
IPsec-ID que describe su Red Privada a la pasarela del otro
extremo de la conexi&oacute;n.  &Eacute;sta es la
porci&oacute;n que se pasa para que la otra pasarela pueda
configurar la tabla de enrutamiento concreta, que
transferir&aacute; datos a trav&eacute;s de la VPN a nuestra
red.

<li><strong>Remote-ID=</strong> hace referencia a una
secci&oacute;n IPsec-ID que describe lo que se supone que la
Red Privada remota es para nuestro anfitri&oacute;n.  Esta
porci&oacute;n debe ser interpretada para la correcta
configuraci&oacute;n de las tablas de enrutamiento que
transferir&aacute;n datos desde nuestra Red Privada, a
trav&eacute;s de la VPN, hacia la Red Privada remota.
d1180 2
a1181 2
<strong>Flags=</strong>.  Si necesita este indicador, lea la
p&aacute;gina del manual de
d1186 6
a1191 7
&Eacute;sta es la secci&oacute;n de IPsec-ID.  Estas entradas
deben existir en los ficheros isakmpd.conf del
anfitri&oacute;n A y del anfitri&oacute;n B.  Este ejemplo
configurar&aacute; 192.168.1.0/255.255.255.0 para el
anfitri&oacute;n A (que se conect&oacute; arriba a Net-A) y
192.168.20.0/255.255.255.0 para el anfitri&oacute;n B (arriba
Net-B).
d1209 9
a1217 11
<strong>configuraci&oacute;n</strong> de cada
anfitri&oacute;n.  Son las secciones a las que se hace
referencia en los identificadores <strong>Local-ID</strong> y
<strong>Remote-ID</strong>.  Describen las rutas que se deben
configurar para permitir el paso del tr&aacute;fico desde una
red privada hasta otra.  <strong>ID-type</strong>= puede ser
<strong>IPV4_ADDR_SUBNET</strong> o <strong>IPV4_ADDR</strong>
(RFC2708 menciona m&aacute;s valores posibles.  En la
actualidad s&oacute;lo hay soporte en la implementaci&oacute;n
de OpenBSD para IPv4.  El soporte para IPv6 puede estar en
OpenBSD-current).
d1220 1
a1220 2
Ahora, en ambos anfitriones, el fichero de muestra
deber&iacute;a ser:
d1232 19
a1250 23
Esta secci&oacute;n describe los requisitos para los
m&eacute;todos de cifrado de las conexiones de la fase 1.  El
nombre refleja el valor de la variable
<em>Configuration=</em>.  Como se puede ver aqu&iacute;,
estamos indicando nuestro Dominio de Inter&eacute;s, que es
IPsec.  La variable <strong>EXCHANGE_TYPE</strong> est&aacute;
configurada con el valor <strong>ID_PROT</strong> para la fase
1, que identifica los protocolos que cubrir&aacute; esta
autenticaci&oacute;n.  <strong>Transforms=</strong> es la
transformaci&oacute;n criptogr&aacute;fica requerida (o
asignada) para este intercambio.  En este caso se&ntilde;ala a
la secci&oacute;n de abajo en el fichero de
configuraci&oacute;n, que indica que estamos recibiendo un
paquete cifrado con 3DES y una suma de comprobaci&oacute;n
verificable con SHA.  Hay muchas transformaciones
criptogr&aacute;ficas definidas en el fichero de muestra
<strong>VPN-east.conf</strong>.  &Eacute;stas se proveen
porque 3DES y SHA no siempre tienen soporte en las diferentes
plataformas.  Para OpenBSD no hay raz&oacute;n para cambiar
esta configuraci&oacute;n b&aacute;sica.  Si desea crear
copias de esta secci&oacute;n y cambiar la variable
<strong>Transforms</strong>=, puede hacerlo.  El &uacute;nico
requisito es que cambie la variable
d1263 1
a1263 1
Esta secci&oacute;n describe los requisitos para el cifrado de
d1265 10
a1274 12
referencia a ella est&aacute; arriba en
<em>Configuration</em>.  N&oacute;tese que la diferencia entre
esta secci&oacute;n y su equivalente en la fase 1 anterior es
que <strong>EXCHANGE_TYPE</strong> es
<strong>QUICK_MODE</strong>.  <strong>Suites=</strong>
se&ntilde;ala a una secci&oacute;n Suite de IPsec que describe
los distintos esquemas de cifrado disponibles entre los dos
anfitriones.  Se podr&iacute;a decir mucho m&aacute;s sobre
ISAKMP e IPsec, pero usando las descripciones b&aacute;sicas
que hemos mencionado deber&iacute;a ser capaz de crear una VPN
simple pero s&oacute;lida, que se cuidara de s&iacute; misma.
Esto es el <em>m&iacute;nimo indispensable</em> de
d1280 1
a1280 1
Puede usar
d1287 5
a1291 6
la primera vez que decida invocar este d&aelig;mon.  El
d&aelig;mon no funcionar&aacute; en modo d&aelig;mon, sino
como un proceso regular.  Grabar&aacute; todo en su terminal.
Para parar isakmpd y limpiar las rutas, tiene que matar el
proceso isakmpd en cada modo, y ejecutar <strong>ipsecadm
flush</strong>.
d1295 1
a1295 3
<h1>13.8 - &iquest;C&oacute;mo uso isakmpd con certificados
X.509?</h1>
</p>
d1298 6
a1303 6
Configurar isakmpd para el uso de certificados en lugar de
claves precompartidas no es mucho m&aacute;s dif&iacute;cil en
una gran red con muchas conexiones entrantes no fiables de lo
que ser&iacute;a en una peque&ntilde;a red.  En realidad puede
simplificar la configuraci&oacute;n, y m&aacute;s importante,
la gesti&oacute;n de claves.
d1309 2
a1310 2
Hay una buena descripci&oacute;n sobre c&oacute;mo generar
claves y certificados en el fichero
d1312 4
a1315 4
del directorio de fuentes de isakmpd.  Debe tener una clave
CA, el correspondiente certificado CA X.509, una clave privada
para cada m&aacute;quina en la red que use isakmpd, y un
certificado X.509 para cada una de esas claves.
d1319 21
a1339 25
&laquo;Asunto Nombre Alternativo&raquo; (SubjectAltName), que
describa al poseedor del certificado.  C&oacute;mo configurar
una extensi&oacute;n SubjectAltName usando certpatch para un
certificado, tambi&eacute;n se describe en README.PKI para el
caso de configuraci&oacute;n de una direcci&oacute;n IP como
la extensi&oacute;n SubjectAltName.  Aqu&iacute;, el uso de
una direcci&oacute;n IP tambi&eacute;n es el comportamiento
por definici&oacute;n de isakmpd.

<p>
Certpatch tambi&eacute;n tiene soporte para el uso de
&laquo;Nombres de Dominio Totalmente Cualificados&raquo;
(FQDN, &quot;Fully Qualified Domain Name&quot;) o UFQDN (FQDN
de Usuario).  Un ejemplo de un FQDN ser&iacute;a
<tt>www.openbsd.org</tt>, y un ejemplo de un UFQDN
ser&iacute;a una direcci&oacute;n de correo
electr&oacute;nico, como por ejemplo
<tt>Jorgen.Granstam@@abc.se</tt>.

<p>
En este documento usar&eacute; FQDNs como SubjectAltNames.  El
uso de direcciones IP deber&iacute;a ser algo m&aacute;s
f&aacute;cil, ya que es el comportamiento por
definici&oacute;n de isakmpd pero no es muy diferente, como
veremos m&aacute;s adelante.
d1353 7
a1359 8
Aqu&iacute;, ca.key es la clave privada de la &laquo;Autoridad
de Certificaci&oacute;n&raquo; (CA), por lo tanto esto
s&oacute;lo lo puede hacer quien tenga acceso a la clave
privada del CA.  home.mysite.se es el FQDN que se introduce en
el certificado.  Los nombres de los ficheros originalcert.crt
y nuevocert.crt podr&iacute;an tener el mismo nombre, en cuyo
caso el fichero original ser&iacute;a anulado por el
certificado modificado nuevo.
d1362 4
a1365 4
Ponga las claves y certificados en los directorios tal y como
se describe al final de README.PKI.  Si se van a usar las
clave de una forma seria, la clave CA (ca.key) se debe guardar
en alg&uacute;n sitio seguro.
d1372 2
a1373 2
<em>/etc/isakmpd/isakmpd.conf</em>.  Esta configuraci&oacute;n
se tom&oacute; originalmente del fichero de ejemplo en
d1375 15
a1389 16
pero se ha modificado mucho.  Tambi&eacute;n usar&eacute; un
fichero mucho m&aacute;s corto que el fichero del ejemplo de
la p&aacute;gina del manual, para que sea m&aacute;s
f&aacute;cil de entender.  Tambi&eacute;n he a&ntilde;adido
algunos comentarios (algunos comentarios los he dejado como
estaban en isakmpd.conf(5)), y he cambiado algunos nombres.
Ninguno de los nombres de dominio aqu&iacute; usados existen
(que yo sepa).

<p>
En realidad, puesto que todo el que lea esto ya tendr&aacute;
una configuraci&oacute;n que funcione del caso de claves
precompartidas (ver la secci&oacute;n anterior), no
habr&aacute; muchas sorpresas en este fichero.  No lo
explicar&eacute; en detalle, mire isakmpd.conf(5) para
descripciones de las partes que no comente.
d1392 1
a1392 2
Asumamos que nuestra configuraci&oacute;n es parecida a
&eacute;sta:
d1407 5
a1411 6
O sea, dos redes que deben conectarse usando un t&uacute;nel
IPsec sobre una red de otro modo insegura.  Ignore el hecho de
que aqu&iacute; se est&eacute;n usando direcciones IP
reservadas para Internets privadas (RFC1918), debo usar algo.
No explicar&eacute; c&oacute;mo usar isakmpd en
combinaci&oacute;n con NAT ni nada parecido (ya que no lo he
d1415 2
a1416 2
Ahora, veamos el fichero de configuraci&oacute;n.  &Eacute;ste
es el fichero para la pasarela de seguridad gw.mysite.se:
d1625 5
a1629 6
Hasta aqu&iacute; la configuraci&oacute;n para el sistema
local.  El sistema remoto se configura exactamente del mismo
modo, s&oacute;lo que al rev&eacute;s.  Por lo tanto, la
primera parte del fichero isakmpd.conf es diferente.  Echemos
un vistazo a esa primera parte del fichero isakmpd.conf para
la pasarela de seguridad de gw.worksite.se:
d1676 2
a1677 2
No ha sido tan dif&iacute;cil, tal vez algo aburrido de leer.
La siguiente parte es algo m&aacute;s interesante.
d1683 6
a1688 6
El fichero <em>policy</em> puede ser algo confuso para alguien
que no lo haya usado con anterioridad, especialmente si las
cosas no funcionan como se espera.  La p&aacute;gina de manual
de <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&sektion=5">isakmpd.policy(5)</a>
no est&aacute; tan mal.  Tal vez sea poco clara en algunas
partes, pero en general es buena.
d1691 2
a1692 2
El fichero <em>policy</em> m&aacute;s simple que es posible
ser&iacute;a uno que contuviera una &uacute;nica l&iacute;nea:
d1703 18
a1720 21
<em>policy</em> sobre qui&eacute;n puede conectar.  Por lo
tanto, no es una configuraci&oacute;n muy segura.  La etiqueta
authorizer es para indicar qui&eacute;n tiene la
autorizaci&oacute;n para decidir la pol&iacute;tica a seguir.
El autorizador especial &quot;POLICY&quot; tiene la autoridad
total sobre <em>policy</em>.  Cualquier otro authorizer debe
primero ser autorizado por &quot;POLICY&quot; para poder tener
cualquier autoridad.

<p>
Tambi&eacute;n puede haber un grupo de condiciones sobre
qu&eacute; est&aacute; autorizado.  El siguiente
<em>policy</em> vendr&iacute;a a decir que s&oacute;lo alguien
que use el protocolo ESP con algo de cifrado real,
estar&iacute;a autorizado (bueno, alguien que usara DES
tambi&eacute;n estar&iacute;a autorizado aqu&iacute;, aunque
DES casi est&aacute; considerado como muy inseguro, se deja
como ejercicio para el lector el cambiar este fichero
<em>policy</em> para no permitir tampoco DES).  N&oacute;tese
que cualquiera que cifre con ESP todav&iacute;a estar&iacute;a
autorizado.
d1733 5
a1737 6
Tambi&eacute;n se puede &laquo;sublicenciar&raquo; la
autoridad a alguien m&aacute;s (podr&iacute;a ser una o
m&aacute;s entidades).  El caso simple ser&iacute;a el caso de
la clave precompartida.  En ese caso, cualquiera que sepa que
la contrase&ntilde;a precompartida, estar&aacute; autorizado.
Por lo tanto:
d1751 4
a1754 4
Esto autorizar&iacute;a a cualquiera que supiera esta
contrase&ntilde;a para conectar y cumplir con las condiciones
(pero recuerde que la contrase&ntilde;a tambi&eacute;n se debe
activar en la etiqueta Authentication de isakmpd.conf).
d1757 7
a1763 7
Hasta ahora, nada complicado.  Ahora viene la parte
interesante.  Primero, puede haber muchos con licencias,
aunque deben estar todos autorizados por &quot;POLICY&quot;.
Adem&aacute;s, aqu&eacute;llos que dispongan de licencias y
est&eacute;n autorizados, pueden &laquo;sublicenciar&raquo; a
otros.  Un licenciado puede ser simplemente una cadena si
est&aacute; m&aacute;s descrito en el fichero <em>policy</em>:
d1783 6
a1788 7
Y ahora, a por lo que todos estaban esperando.
<em>policy</em> tambi&eacute;n se puede sublicenciar o delegar
a una clave.  En este caso suele ser un certificado X.509.  El
uso m&aacute;s simple de certificados ser&iacute;a usarlos
como las contrase&ntilde;as.  Simplemente introduzca
certificados de usuarios individuales en el fichero
<em>policy</em>:
d1814 4
a1817 5
Esto, obviamente, es una idea est&uacute;pida si hay muchos
usuarios.  Los certificados que isakmpd lee de los directorios
CA- y Certificate, y los certificados recibidos desde el otro
extremo de la conexi&oacute;n se convierten en
pseudocredenciales.  Estos certificados convertidos en
d1851 8
a1858 10
&quot;POLICY&quot; y por lo tanto no tendr&aacute;n
ning&uacute;n efecto sin que est&eacute;n de alguna manera
autorizados.  Adem&aacute;s, esto muestra lo que le ocurre
internamente a los certificados.  La credencial anterior no se
ve en el fichero <em>policy</em>.  Sin embargo, se puede dar
una sublicencia a tales credenciales.  Recuerde el tema sobre
sublicencias.  Es posible dar licencias a todos los
certificados que est&eacute;n firmados por una cierta CA,
poniendo el certificado de la CA como un licenciado de
&quot;POLICY&quot;:
d1884 6
a1889 6
El fichero <em>policy</em> que hemos visto es un simple
ejemplo de fichero <em>policy</em> que delega en una CA.
Cualquier usuario que tenga un certificado firmado por la CA
de este certificado, y que adem&aacute;s cumpla las otras
condiciones configuradas en <em>policy</em> y en el fichero de
configuraci&oacute;n, estar&aacute; autorizado.
d1896 14
a1909 16
Desafortunadamente, esto no es suficiente para estar realmente
seguro.  Hay formas para atacar una pasarela de seguridad
configurada de esta forma.  Si no quiere leer los detalles,
pase a la secci&oacute;n siguiente ahora.  Para el resto,
intentaremos entender porqu&eacute; esto no es seguro.  No es
dif&iacute;cil.

<p>
Considere a qu&eacute; informaci&oacute;n tiene acceso en este
momento uno de los isakmpd.  Del fichero de
configuraci&oacute;n, isakmpd sabe cu&aacute;l es el
IP-address desde el que se conectar&aacute;n (en la
secci&oacute;n Fase 1).  De la informaci&oacute;n que obtiene
durante la negociaci&oacute;n de la fase 1, sabe el ID con el
que el extremo que se conecta presenta a s&iacute; mismo y el
certificado que obtiene desde ese extremo de la
d1916 79
a1994 90
habr&aacute; ligado el IP al certificado, y el IP en la
configuraci&oacute;n ser&aacute; toda la informaci&oacute;n
que necesitemos.  Un impostor podr&iacute;a usar el mismo IP
de otra m&aacute;quina en algunos casos (por ejemplo, si ambas
m&aacute;quinas estuvieran en la misma red local y la
m&aacute;quina que tuviera este IP estuviera fuera de servicio
por cualquier motivo).  Sin embargo, el impostor no
podr&iacute;a tener un certificado y la correspondiente clave
privada que probara que este IP pertenece al impostor.

<p>
Si esto ocurriera alguna vez, el impostor habr&iacute;a
conseguido robar la clave privada del aut&eacute;ntico
propietario del IP, o el impostor habr&iacute;a conseguido
enga&ntilde;ar la CA para que le diera un certificado que
contuviera informaci&oacute;n falsa.  En el primer caso
significar&iacute;a que la clave privada no se habr&iacute;a
protegido lo suficientemente bien, y en el segundo la CA
habr&iacute;a fallado al comprobar la identidad del impostor
como debiera (o la informaci&oacute;n del ID del certificado)
o la clave privada de la CA no habr&iacute;a estado bien
protegida.  Como todo esto son prerrequisitos para que la
seguridad funcione, ninguna de estas situaciones
deber&iacute;a suceder nunca.

<p>
En nuestro ejemplo la situaci&oacute;n es diferente.
Aqu&iacute; tenemos un FQDN en el certificado en lugar de una
direcci&oacute;n IP.  Como todav&iacute;a tenemos una
direcci&oacute;n IP en la secci&oacute;n de fase 1, tenemos
por tanto un posible problema de seguridad.  Lo que
ocurrir&iacute;a durante la negociaci&oacute;n de fase 1 de
ISAKMP ser&iacute;a que podr&iacute;amos comprobar que el
extremo de la conexi&oacute;n se hubiera llevado a cabo desde
el IP supuesto (pero como hemos explicado anteriormente, en
algunos casos se podr&iacute;a falsificar).  Podr&iacute;amos
comprobar que ese ID que presenta nuestro extremo de la
conexi&oacute;n realmente pertenece a &eacute;ste.  Pero lo
que no podr&iacute;amos comprobar ahora ser&iacute;a si ese ID
es realmente el ID que suponemos, porque isakmpd nunca ha
sabido qu&eacute; ID deber&iacute;a ser.

<p>
Alguien podr&iacute;a decir que el sistema de DNS ata el IP al
FQDN para el anfitri&oacute;n.  Es cierto, sin embargo el
sistema de DNS actual no es seguro y se le puede, bajo ciertas
circunstancias, enga&ntilde;ar para que entregue
informaci&oacute;n falsa (o podr&iacute;a ser v&iacute;ctima
de una ataque de &laquo;denegaci&oacute;n de servicio&raquo;
(DoS, &quot;Denial of Service&quot;) por parte de un atacante,
y la m&aacute;quina del atacante podr&iacute;a falsificar la
respuesta del servidor de DNS).  DNS seguro aparecer&aacute;
en el futuro, pero todav&iacute;a no est&aacute; aqu&iacute;
(o por lo menos la mayor&iacute;a de servidores de DNS
todav&iacute;a no son seguros);  por lo tanto, hoy en
d&iacute;a, el uso de DNS para comprobar si el FQDN en el
certificado corresponde al IP supuesto, no es una
garant&iacute;a.  De hecho, isakmpd no lo comprueba con DNS.
Aun cuando DNS fuera seguro, la comprobaci&oacute;n no
servir&iacute;a en el caso de usar un UFQDN.

<p>
As&iacute; pues, en caso de tener un FQDN como ID,
ser&iacute;a posible que un atacante obtuviese su propia clave
privada y que &eacute;sta estuviera firmada por la misma CA
que usamos nosotros (pero con el FQDN del atacante).  Y
podr&iacute;a lanzar un ataque DoS sobre nuestra
conexi&oacute;n para hacerla caer (de hecho, existen unos
agujeros en el mismo protocolo ISAKMP, que probablemente se
podr&iacute;n usar para lanzar un ataque DoS remoto contra la
conexi&oacute;n y hacerla caer, aunque no s&eacute; qu&eacute;
sensibles a estos ataques ser&iacute;a isakmpd).  Entonces, el
atacante podr&iacute;a configurar su propia m&aacute;quina del
mismo modo que la de nuestra conexi&oacute;n, conectarla a la
red de nuestra conexi&oacute;n, e intentar conectarse mediante
su ID, clave privada y certificado propios.

<p>
Nuestro isakmpd no habr&iacute;a sido informado sobre
qu&eacute; ID por nuestra conexi&oacute;n (debido a que el
atacante est&aacute; configurado de forma id&eacute;ntica a
nuestra conexi&oacute;n, aparte del certificado, ID y clave
privada).  Nuestro isakmpd podr&iacute;a comprobar que el
certificado estuviera firmado por la misma CA (pero la
mayor&iacute;a de CAs firman muchos certificados, y un
certificado no es tan dif&iacute;cil de conseguir), y que el
ID presentado fuera el mismo que el ID en el certificado.  Sin
embargo, con la configuraci&oacute;n presentada hasta ahora,
no comprobar&iacute;a que este ID fuera el supuesto.  Por lo
tanto, el atacante tendr&iacute;a permiso para conectar.
d2000 5
a2004 7
Ahora la cuesti&oacute;n es, &iquest;c&oacute;mo podemos
informar a isakmpd sobre qu&eacute; ID debe esperar?  Por
suerte esto es f&aacute;cil, y est&aacute; documentado en la
p&aacute;gina de manual de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&sektion=5">isakmpd.policy(5)</a>.
Debemos hacer la comprobaci&oacute;n en <em>policy</em>, como
esto:
d2032 4
a2035 4
conexi&oacute;n IPsec.  Se pueden a&ntilde;adir m&aacute;s
permisos para otros IDs, a&ntilde;adiendo m&aacute;s
comprobaciones remote_id alternativas, o sea, teniendo
condiciones en el fichero <em>policy</em> como &eacute;sta:
d2049 2
a2050 2
Con esta <em>policy</em> podr&iacute;an conectar tanto
gw.worksite.se, como gw.somesite.se, como gw.whatsite.se.
d2053 20
a2072 23
Algunos afirman que es desafortunado que tengan que haber
certificados enteros introducidos en <em>policy</em>.
Reformatear los certificados en el formato de <em>policy</em>
requiere algo de esfuerzo, y hace que <em>policy</em> sea poco
legible.  Si alguien substituyera por error, un certificado de
usuario con el correspondiente certificado de CA en alguna
parte de un fichero <em>policy</em> complejo, podr&iacute;a
provocar que usuarios no autorizados obtuvieran permiso para
conectar en algunos casos y, a&uacute;n peor, no ser&iacute;a
f&aacute;cilmente detectable leyendo el fichero
<em>policy</em> (porque los certificados X.509 no est&aacute;n
en un formato humano legible).

<p>
Ahora, para aquellos a quienes les gusta estar al borde del
precipicio, existe una soluci&oacute;n a este problema.  Ahora
se puede usar el certificado &laquo;Nombre Distinguido&raquo;
(DN, &quot;Distinguished Name&quot;) en lugar de un
certificado en <em>policy</em> (por supuesto que el
correspondiente certificado debe estar disponible desde los
directorios cert o ca del disco, de modo que isakmpd lo pueda
encontrar).  Con este formato, el fichero <em>policy</em>
anterior acabar&iacute;a siendo algo as&iacute;:
d2091 3
a2093 3
Mucho m&aacute;s legible, &iquest;o no?  La informaci&oacute;n
sobre lo que es el exacto DN para un certificado se puede
encontrar mirando al certificado, usando la utilidad openssl:
d2104 2
a2105 3
complicadas pero esto es suficiente para empezar, y
todav&iacute;a hay otro ejemplo en la siguiente
secci&oacute;n.
d2108 5
a2112 6
Esto deber&iacute;a proveerle con la informaci&oacute;n
necesaria sobre el certificado en ca.crt.  Esto ser&aacute;
bueno siempre que tengamos un fichero <em>policy</em>
peque&ntilde;o o, por lo menos, uno razonable.  Sin embargo,
todav&iacute;a no es suficiente si tenemos un sitio enorme con
muchos usuarios que deban tener permiso de conexi&oacute;n.
d2119 7
a2125 9
Veamos ahora algunas caracter&iacute;sticas interesantes de
isakmpd.  Hasta ahora hemos asumido que el supuesto extremo
remoto de la conexi&oacute;n era conocido y ten&iacute;a una
direcci&oacute;n IP est&aacute;tica.  Esto no siempre es
as&iacute;.  Muchas personas usan IPs asignados de forma
din&aacute;mica, o usan muchas m&aacute;quinas diferentes.  En
otros casos, como en el caso de los servidores,
podr&iacute;amos no estar seguros de qui&eacute;n quiere
conectar.
d2128 4
a2131 5
Por lo tanto, una funcionalidad interesante de isakmpd es que
puede usar en la secci&oacute;n de fase 1 una etiqueta
predefinida en lugar de un IP, permitiendo de este modo
negociaciones isakmpd desde cualquier IP.  Esto se
har&iacute;a del siguiente modo:
d2142 4
a2145 5
Primero, hay que decir que esta configuraci&oacute;n
podr&iacute;a no ser segura frente a ataques de DoS.  Como se
ha dicho anteriormente, existen algunos agujeros en los
protocolos ISAKMP/IKE.  De todos modos, el uso de una
secci&oacute;n de fase 1 predefinida tambi&eacute;n nos
d2150 10
a2159 11
Imagine que tuvi&eacute;ramos muchos usuarios autorizados,
pero que no acept&aacute;ramos a cualquier usuario, como
podr&iacute;a ocurrir en una compa&ntilde;&iacute;a.  Nos
gustar&iacute;a que los empleados tuvieran permiso para
conectar, pero nadie m&aacute;s.  Ahora imagine que la
compa&ntilde;&iacute;a tuviera miles de empleados, y que
quisi&eacute;ramos que todos ellos pudieran conectar desde
cualquier m&aacute;quina (no s&oacute;lo desde dentro de la
red de la compa&ntilde;&iacute;a), pero que no todos tuvieran
permiso para hacer cualquier cosa.  Se podr&iacute;a escribir
un fichero <em>policy</em> como &eacute;ste:
d2199 9
a2207 11
Puede que esto no sea exactamente como deber&iacute;a ser.
Por lo que s&eacute;, no est&aacute; comprobado (de hecho,
estas condiciones de filtros podr&iacute;an no funcionar como
espero).  Adem&aacute;s, un fichero <em>policy</em> como
&eacute;ste (cualquiera con un IP del extremo de la
conexi&oacute;n predefinido) requerir&iacute;a reescribir
partes del fichero isakmpd.conf tambi&eacute;n.  Esto
conllevar&iacute;a algunas implicaciones en la seguridad.
Para este tipo de conexiones en las que cualquiera debe tener
permiso para conectar, es probablemente deseable grabar el DN
de cualquiera que conecte.  Que yo sepa, isakmpd
d2209 2
a2210 3
tambi&eacute;n podr&iacute;a tener otras implicaciones en la
seguridad.  De cualquier modo la idea b&aacute;sica
est&aacute; clara.
d2213 33
a2245 38
Por si acaso alguien no ha visto las interesantes
posibilidades que esto tiene: Si todas la m&aacute;quinas que
usan ISAMKP/IKE de este modo, tuvieran un grupo de condiciones
est&aacute;ndar para todos los servicios que los usuarios
quisieran usar de forma remota, la CA podr&iacute;a autorizar
a los usuarios poniendo las extensiones SubjectAltName
correctas en sus certificados.  Adem&aacute;s, la fecha de
caducidad para estos certificados se podr&iacute;a configurar
para que caducara a menudo, aunque los usuarios podr&iacute;an
obtener nuevos certificados cuando sus certificados actuales
estuvieran a punto de caducar.  Si los usuarios hicieran un
mal uso de sus autorizaciones, bastar&iacute;a con no volver a
emitir los certificados para que no pudieran acceder
despu&eacute;s de la fecha de caducidad.  No ser&iacute;a
necesario cambiar los ficheros <em>policy</em> en todas las
m&aacute;quinas simplemente porque un empleado, por ejemplo,
dejara el trabajo.  El mismo esquema podr&iacute;a funcionar
para prop&oacute;sitos distintos a ISAKMP/IPsec (¡incluida la
autorizaci&oacute;n para sistemas fuera de la
conexi&oacute;n!), aunque eso requerir&iacute;a un software
especial.  En cualquier caso, cualquier organizaci&oacute;n
que hiciera esto es probable que tambi&eacute;n quisiera ser
su propia CA.

<p>
Las configuraciones de multiusuarios (usuarios m&oacute;viles)
como &eacute;sta, tambi&eacute;n son posibles con claves
precompartidas, pero entonces se requiere que se use el modo
AGGRESSIVE en lugar del modo ID_PROT, ya que en este caso
necesitaremos poder escoger la frase de la contrase&ntilde;a
correcta basada en el ID, debido a que en este caso no lo
podemos saber por el ID (en modo AGGRESSIVE el ID se
env&iacute;a durante un estado m&aacute;s temprano de la
negociaci&oacute;n, pero se env&iacute;a descifrado, por lo
tanto el modo AGGRESSIVE es m&aacute;s r&aacute;pido porque
necesita menos intercambios de mensajes, pero tambi&eacute;n
es un poco menos seguro debido a que el ID se env&iacute;a en
claro).
d2249 2
a2250 3
<h1>13.9 - &iquest;Qu&eacute; clientes IKE son compatibles
con isakmpd?</h1>
</p>
d2253 5
a2257 6
<code>isakmpd</code> es el d&aelig;mon de la gesti&oacute;n de
claves de ISAKMP/Oakley que viene con OpenBSD.  Sospechamos
que interacciona, por lo menos en parte, con la mayor&iacute;a
de implementaciones ISAKMP, pero s&oacute;lo los siguientes
han sido comprobados.  N&oacute;tese que algunos software
isakmp que puede encontrar est&aacute;n basados en el
d2261 2
a2262 2
Los siguientes clientes para MS-Windows son compatibles
seg&uacute;n los informes recibidos:
d2266 2
a2267 2
   <li><a href="http://www.vpcom.com/">Ashley Laurent</a>
   VPCom VPN software
d2269 1
a2269 2
   <li><a href="http://www.radguard.com/">Radguard</a> cIPro
   client
d2271 2
a2272 2
   <li><a href="http://www.microsoft.com">Microsoft</a>
   Windows 2000 y XP
d2276 2
a2277 2
Las siguientes pasarelas/enrutadores son compatibles
seg&uacute;n los informes recibidos:
d2286 2
a2287 2
   <li><a href="http://www.xs4all.nl/~freeswan/">FreeS/WAN</a>
   para Linux
d2293 3
a2295 6
   <li><a href="http://www.nortelnetworks.com/">Nortel</a>
   Contivity
   <li><a href="http://www.checkpoint.com/">CheckPoint</a>
   FW-1
   <li><a href="http://www.watchguard.com/">Watchguard</a>
   Firebox III
a2300 1
</p>
d2303 3
a2305 3
Para resolver problemas, la primera herramienta que debe usar
es <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&apropos=0&sektion=8&format=html">tcpdump(8)</a>.
Use <code>tcpdump</code> para buscar varias cosas.
d2308 6
a2313 7
Si est&aacute; usando tcpdump en OpenBSD, dispone de una
versi&oacute;n mejorada de tcpdump que puede mostrarle algo de
informaci&oacute;n sobre paquetes ESP y AH.  Si est&aacute;
usando tcpdump desde OpenBSD 2.5 o desde otro sistema
operativo, es posible que tenga una versi&oacute;n anticuada
que s&oacute;lo le muestre el n&uacute;mero del protocolo para
AH o ESP (el protocolo IP de ESP es 50, y el de AH es 51).
d2317 5
a2321 5
<li>Con tcpdump, mire si el tr&aacute;fico est&aacute; usando
AH/ESP o texto en claro.  Si su tr&aacute;fico es en texto en
claro, entonces sus flujos est&aacute;n configurados de modo
incorrecto, o su isakmp no est&aacute; negociando como
debiera.  Use 
d2327 2
a2328 3
Por ejemplo, yo tengo dos m&aacute;quinas anfitrionas,
208.1.1.1 y 208.2.2.2.  Ingreso en 208.2.2.2 y hago lo
siguiente:
d2341 2
a2342 2
Y en otra sesi&oacute;n puedo ver mis &quot;pings&quot;
encapsulados:
d2359 3
a2361 3
<li>ISAKMP va por el puerto UDP 500.  Si este puerto
est&aacute; bloqueado por un cortafuegos o filtro de paquetes,
entonces debe cambiarlo.
d2376 1
a2376 19
<li>Photuris va por el puerto UDP 468.  Se aplican las mismas
consideraciones que anteriormente, pero el protocolo
aqu&iacute; es AH.

<ul>
<pre>
# Passing in Photuris traffic from the security gateways
pass in on ne0 proto udp from gatewB/32 port = 468 to gatewA/32 port = 468
pass out on ne0 proto udp from gatewA/32 port = 468 to gatewB/32 port = 468

# Passing in encrypted traffic from security gateways
pass in proto ah from gatewB/32 to gatewA/32
pass out proto ah from gatewA/32 to gatewB/32
</pre>
</ul>

<p>
<li>Para activar todo el depurado en isakmpd, in&iacute;cielo
como
d2386 2
a2387 2
o (para saltar la informaci&oacute;n m&aacute;s detallada de
depurado del temporizador
d2397 1
a2397 1
<li>Debe permitir el paso a su net A con cortafuegos del
d2408 3
a2410 3
<li>Con tcpdump en OpenBSD puede descodificar la mayor parte
del texto en claro de las sesiones IKE.  tcpdump
tambi&eacute;n le mostrar&aacute; los datos de cargo de AH.
d2413 1
a2413 1
<li>Monte un sistema de archivo /kern (si no usa uno por
d2424 4
a2427 4
En /kern hay una tabla de SA/SPIs actuales, incluidos los que
tienen flujos (SAs salientes) y los que no (SAs entrantes).
Tambi&eacute;n hay contadores de tr&aacute;fico que puede usar
para ver qu&eacute; tr&aacute;fico pasa y a d&oacute;nde va.
d2430 1
a2430 1
<li>Finalmente, puede usar
d2432 1
a2432 1
para ver sus SAs
d2453 8
a2460 8
<li>Si todo lo dem&aacute;s fallara, recompile el
n&uacute;cleo del sistema con <code>option ENCDEBUG</code>.  A
continuaci&oacute;n configure <em>net.inet.ip.encdebug</em>
con el valor 1 en sysctl.  Busque avisos o errores en su
dmesg, e informe sobre ellos a los desarrolladores de OpenBSD,
usando <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendbug&apropos=0&sektion=1&format=html">sendbug(1)</a>.
De forma alternativa, si no est&aacute; seguro de que su
problema sea un error, puede enviar un mensaje a una de las 
a2466 1
</p>
d2469 2
a2470 2
IPsec est&aacute; parcialmente documentado en la p&aacute;gina
de manual de
d2474 1
a2474 1
que le pueden ser de ayuda.  Las p&aacute;ginas de manual de
a2477 2
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=photurisd&sektion=8">photurisd(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=startkey&sektion=1">startkey(1)</a>,
d2481 2
a2482 3
tienen informaci&oacute;n m&aacute;s detallada y pueden
ayudarle con la configuraci&oacute;n y operaci&oacute;n de
IPsec.
a2525 2
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2522.html">RFC 2522</a> - Photuris: Session-Key Management Protocol
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2523.html">RFC 2523</a> - Photuris: Extended Schemes and Attributes
d2541 2
a2542 2
Originally [OpenBSD: faq13.html,v 1.58 2002/07/12 02:51:35 nick Exp ]<br>
$Translation: faq13.html,v 1.24 2002/07/14 07:03:30 horacio Exp $<br>
a2544 1
</p>
@


1.23
log
@
sync with badlands translation CVS
@
text
@d2710 2
a2711 2
Originally [OpenBSD: faq13.html,v 1.57 2002/07/07 21:58:21 nick Exp ]<br>
$Translation: faq13.html,v 1.23 2002/07/09 10:18:46 horacio Exp $<br>
@


1.22
log
@
sync with badlands translation CVS
@
text
@d34 1
a34 3
<li><a href="#Photuris">13.7 - &iquest;C&oacute;mo configuro
photurisd?</a>
<li><a href="#isakmpd">13.8 - &iquest;C&oacute;mo configuro
d36 1
a36 1
<li><a href="#x509">13.9 - &iquest;C&oacute;mo uso isakmpd con
d38 1
a38 1
<li><a href="#IKEcl">13.10 - &iquest;Qu&eacute; clientes IKE
d40 1
a40 1
<li><a href="#Trouble">13.11 - Resoluci&oacute;n de problemas
d42 1
a42 1
<li><a href="#SeeAlso">13.12 - Documentaci&oacute;n
d178 1
a178 1
<a name= "Protocols"></a>
d211 1
a211 1
<a name= "Wire"></a>
d376 1
a376 1
<a name= "Config"></a>
d491 1
a491 1
<a name= "ManKey"></a>
d840 2
a841 86
<a name= "Photuris"></a>
<a name="13.7"></a>
<h1>13.7 - ¿C&oacute;mo configuro photurisd?</h1>
</p>

<p>
El uso de photuris no est&aacute; tan extendido y por lo que
concierne al estado del RFC, se considera experimental.  Sin
embargo, muchas personas lo han usado con OpenBSD.

<p>
Para configurar photurisd, primero edite
/etc/photuris/secrets.conf en cada anfitri&oacute;n con
photurisd.

<ul>
<pre>
# <strong>cat /etc/photuris/secrets.conf</strong>
# Palabras clave aceptadas:
# identity local &quot;id&quot; &quot;secret&quot;
# identity pair local &quot;receivedid&quot; &quot;myid&quot; &quot;secret&quot;
# identity remote &quot;id&quot; &quot;secret&quot;
# identity lookup "&quot;ag&quot; &quot;username&quot;
# Simple 
identity local &quot;Default&quot; &quot;This should be changed.&quot;
identity remote &quot;Default&quot; &quot;This should be changed.&quot;
</pre>
</ul>

Cambie &quot;This should be changed.&quot; por una clave de su
elecci&oacute;n en el fichero de configuraci&oacute;n local, y
otra clave de su elecci&oacute;n en el fichero de
configuraci&oacute;n remota (use la misma configuraci&oacute;n
en su m&aacute;quina remota pero cambie el lugar de
&quot;local&quot; por el de &quot;remote&quot;, y viceversa,
para que se vea a s&iacute; misma como la clave local).
N&oacute;tese que estas claves ser&aacute;n substituidas en
una versi&oacute;n futura de photurisd que llevar&aacute; a
cabo su intercambio inicial de claves con claves
p&uacute;blicas.

<p>
Aseg&uacute;rese de que <em>net.inet.ah.enable</em>
est&aacute; configurado al valor 1.

<ul>
<pre>
# <strong>sysctl -w net.inet.ah.enable=1</strong>
net.inet.ah.enable: 0 -&gt; 1
</pre>
</ul>

Y ejecute startkey.

<ul>
<pre>
# <strong>startkey dst=remote.host</strong>
</pre>
</ul>

Ahora ejecute tcpdump para verificar que sus paquetes
est&eacute;n siendo cifrados con AH (ejecute ping en otra
ventana o sesi&oacute;n para generar tr&aacute;fico).

<pre>
<ul>
# <strong>tcpdump proto ah</strong>
</ul>
</pre>

Tambi&eacute;n puede intentar usar tcpdump por la
direcci&oacute;n del anfitri&oacute;n si no obtiene nada.

<pre>
<ul>
# <strong>tcpdump host remote.host</strong>
</ul>
</pre>

Puede hacer que photurisd configure el origen y el destino del
anfitri&oacute;n o redes en /etc/photuris/photuris.startup

<p>
<a name= "isakmpd"></a>
<a name="13.8"></a>
<h1>13.8 - &iquest;C&oacute;mo configuro isakmpd?</h1>
d853 1
a853 1
<h3>13.8.1 - &iquest;Qu&eacute; es isakmpd?</h3>
d906 1
a906 1
<h3>13.8.2 - &iquest;C&oacute;mo empiezo con isakmpd?</h3>
d1360 1
a1360 1
<h3>13.8.3 - Iniciar isakmpd</h3>
d1378 2
a1379 3
<a name= "x509"></a>
<a name="13.9"></a>
<h1>13.9 - &iquest;C&oacute;mo uso isakmpd con certificados
d2384 2
a2385 3
<a name= "IKEcl"></a>
<a name="13.10"></a>
<h1>13.10 - &iquest;Qu&eacute; clientes IKE son compatibles
d2441 2
a2442 3
<a name= "Trouble"></a>
<a name="13.11"></a>
<h1>13.11 - Resoluci&oacute;n de problemas de IPsec/VPN</h1>
d2628 2
a2629 3
<a name= "SeeAlso"></a>
<a name="13.12"></a>
<h1>13.12 - Documentaci&oacute;n relacionada</h1>
d2710 2
a2711 2
Originally [OpenBSD: faq13.html,v 1.56 2002/07/02 01:17:58 nick Exp ]<br>
$Translation: faq13.html,v 1.22 2002/07/05 02:08:28 horacio Exp $<br>
@


1.21
log
@
sync with badslands translation CVS
@
text
@d859 1
a859 1
bsd# <strong>cat /etc/photuris/secrets.conf</strong>
d889 1
a889 1
bsd# <strong>sysctl -w net.inet.ah.enable=1</strong>
d898 1
a898 1
bsd# <strong>startkey dst=remote.host</strong>
d908 1
a908 1
bsd# <strong>tcpdump proto ah</strong>
d917 1
a917 1
bsd# <strong>tcpdump host remote.host</strong>
d2524 2
d2565 1
a2565 1
vpn# <strong>ping -c 3 208.1.1.1</strong>
d2579 1
a2579 1
vpn# <strong>tcpdump -ni fxp7 host 208.1.1.1</strong>
d2688 1
a2688 1
vpn% <strong>netstat -rn -f encap</strong>
d2800 2
a2801 2
Originally [OpenBSD: faq13.html,v 1.54 2002/06/20 06:17:32 chris Exp ]<br>
$Translation: faq13.html,v 1.21 2002/06/29 15:17:01 horacio Exp $<br>
@


1.20
log
@
sync with badlands CVS
@
text
@d560 2
a561 2
BLF	        Variable (40-160, 160 bits recommended)
CAST    	Variable (40-128, 128 bits recommended)
d2499 1
a2499 1
   Windows 2000 (s&oacute;lo en modo de transporte)
d2798 2
a2799 2
Originally [OpenBSD: faq13.html,v 1.53 2002/05/29 19:24:44 nick Exp ]<br>
$Translation: faq13.html,v 1.20 2002/06/04 17:59:07 horacio Exp $<br>
@


1.19
log
@
sync with badlands translation CVS
@
text
@d1267 1
a1267 1
Lea la p&aacute;gina de manual de
d1340 1
a1340 1
p&aacute;gina de manual de
d1554 7
a1560 9
fichero mucho m&aacute;s corto que en el fichero de ejemplo en
la p&aacute;gina de manual.  He eliminado de ese fichero la
mayor&iacute;a de las partes no necesarias para esta
configuraci&oacute;n para hacerla m&aacute;s f&aacute;cil de
entender.  Tambi&eacute;n he a&ntilde;adido algunos
comentarios (algunos comentarios los he dejado como estaban en
isakmpd.conf(5)), y he cambiado algunos nombres.  Ninguno de
los nombres de dominio aqu&iacute; usados existen (que yo
sepa).
d2798 2
a2799 2
Originally [OpenBSD: faq13.html,v 1.52 2002/05/03 13:24:33 jsyn Exp ]<br>
$Translation: faq13.html,v 1.19 2002/05/14 13:48:23 horacio Exp $<br>
@


1.18
log
@
sync with badlands translation CVS
@
text
@d15 1
d104 2
a105 2
Anfitri&oacute;n-a-Enrutador (y este enrutador controla y cifra
el tr&aacute;fico para una <i>Red</i> particular).
d125 7
a131 6
El protocolo de internet, IP, tambi&eacute;n conocido como IPv4, no
provee por s&iacute; mismo de ninguna protecci&oacute;n a sus
transferencias de datos.  Ni siquiera puede garantizar que el remitente
sea quien dice ser.  IPsec intenta remediarlo.  Estos servicios vienen
tratados como dos servicios distintos, pero IPsec ofrece soporte para
ambos de un modo uniforme.
d154 3
a156 3
Firme sus datos de modo que otros puedan verificar que es realmente Vd.
quien los envi&oacute;.  Es agradable saber que los documentos no son
falsos.
d160 17
a176 14
Necesitamos modos para asegurarnos de que una transacci&oacute;n
s&oacute;lo se puede llevar a cabo una vez, a menos que autoricemos que
la repitan.  Nadie deber&iacute;a poder grabar una transacci&oacute;n,
y luego replicarla al pie de la letra, con el prop&oacute;sito que
pareciera como si se hubieran recibido m&uacute;ltiples transacciones
del remitente original.  Imagine que el atacante deba conocer
cu&aacute;l es el motivo del tr&aacute;fico por medios distintos al de
poder descifrarlo, y que el tr&aacute;fico causara sucesos favorables
para &eacute;l, como depositar dinero en su cuenta.  Tendr&iacute;amos
que asegurarnos que no pudiera replicar ese tr&aacute;fico m&aacute;s
tarde.
<em>AVISO: tal y como lo especifica la normativa, la protecci&oacute;n
a la r&eacute;plica no se llevar&aacute; a cabo cuando se use el
sistema de claves manuales de IPsec (v.g., cuando se est&eacute; usando 
d231 7
a237 7
La cabecera del <strong>Cargo de Seguridad
Encapsulado</strong> (ESP) permite reescribir el cargo en modo
cifrado.  La cabecera ESP no considera los campos de la
cabecera IP que van delante, y por lo tanto no garantiza nada
excepto el cargo.  Los distintos tipos de ESP aplicables deben
seguir conformar con el
<a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">RFC2406</a>.
d250 20
a269 18
       anfitri&oacute;n que genera los paquetes.  En modo transporte,
       las cabeceras de seguridad se a&ntilde;aden antes que las
       cabeceras de la capa de transporte (v.g., TCP, UDP), antes de
       que la cabecera IP sea a&ntilde;adida al paquete.  En otras
       palabras, un AH a&ntilde;adido al paquete cubrir&aacute; el
       resumen criptogr&aacute;fico de la cabecera TCP y algunos campos
       de la cabecera IP extremo-a-extremo, y una cabecera ESP
       cubrir&aacute; el cifrado de la cabecera TCP y los datos, pero
       no la cabecera IP extremo-a-extremo.</li>

   <li>El modo <strong>T&uacute;nel</strong> se usa cuando la cabecera
       IP extremo-a-extremo ya ha sido adjuntada al paquete, y uno de
       los extremos de la conexi&oacute;n segura es solamente una
       pasarela.  En este modo, las cabeceras AH y ESP se usan para
       cubrir todo el paquete, incluida la cabecera extremo-a-extremo,
       y se a&ntilde;ade una nueva cabecera IP al paquete que cubre
       s&oacute;lo el salto al otro extremo de la conexi&oacute;n
       segura (aunque eso puedan ser varios saltos de distancia).</li>
d274 4
a277 3
&laquo;Asociaciones de Seguridad&raquo; (<strong>SA</strong>s).  Cada
SA viene definida por un &uacute;nico flujo unidireccional de datos, y
por regla general (ignorando multicast) desde un &uacute;nico punto
d279 8
a286 8
alg&uacute;n &laquo;selector &uacute;nico&raquo;.  Todo el flujo de
tr&aacute;fico sobre un &uacute;nico SA se trata del mismo modo.  Algo
del tr&aacute;fico puede estar sujeto a varios SAs, cada uno de los
cuales aplica alg&uacute;n tipo de transformaci&oacute;n
criptogr&aacute;fica.  Un grupo de SAs se conoce como un
&laquo;Haz&raquo; (&quot;SA Bundle&quot;).  Los paquetes entrantes se
pueden asignar a un SA particular por medio de los tres campos de
definici&oacute;n:
d290 6
a295 5
       (&quot;destination IP address&quot;)
   <li>&laquo;&Iacute;ndice del Par&aacute;metro de Seguridad&raquo;
       (SPI, &quot;Security Parameter Index&quot;)
   <li>&laquo;Protocolo de seguridad&raquo;
       (&quot;security protocol&quot;)
d298 7
a304 6
SPI se puede considerar como un &quot;cookie&quot; manejado por el
receptor del SA, cuando se negocian los par&aacute;metros de la
conexi&oacute;n.  El protocolo de seguridad debe ser AH o ESP.  Debido
a que la direcci&oacute;n IP del receptor es parte del tr&iacute;o,
&eacute;sta es un valor &uacute;nico garantizado.  Se pueden encontrar
desde la cabecera IP exterior y la primera cabecera de seguridad (que
d335 3
a337 3
Debido a que una cabecera ESP no puede autenticar la cabecera IP
exterior, es &uacute;til combinar una cabecera AH y una ESP para
obtener lo siguiente:
d351 2
a352 2
A esto se le llama &laquo;Adyacencia de Transporte&raquo;.
La versi&oacute;n del t&uacute;nel ser&iacute;a algo as&iacute;:
d367 9
a375 8
Sin embargo, no se menciona en el RFC.  Como ocurre con la adyacencia
de Transporte, esto autenticar&iacute;a todo el paquete excepto unas
cuantas cabeceras de la cabecera IP, y tambi&eacute;n cifrar&iacute;a
la carga (en el ejemplo, en bastardilla).  Cuando una cabecera AH y una
ESP se aplican juntas directamente como en este caso, el orden de las
cabeceras deber&iacute;a ser como el que se ha mostrado.  En modo
t&uacute;nel es posible hacer encapsulaci&oacute;n recursiva arbitraria
para que no se especifique el orden.
d384 27
a410 25
La forma en la que se configuran los sistemas IPsec y las pasarelas es,
hasta un cierto punto, trabajo del diseñador;  sin embargo, el RFC
contiene algunas recomendaciones importantes sobre c&oacute;mo se
deber&iacute;a implementar para evitar al m&aacute;ximo la
confusi&oacute;n.

<p>
Existen dos entidades administrativas que controlan lo que le ocurre a
un paquete.  Una es la &laquo;Base de Datos de Asociaci&oacute;n de la
Seguridad&raquo; (SAD, &quot;Security Association Database&quot;,
llamado TDB o tabla TDB en el c&oacute;digo fuente de IPsec de
OpenBSD), y el otro es la &laquo;Base de Datos de Pol&iacute;tica de la
Seguridad&raquo; (SPD, &quot;Security Policy Database&quot;).

<p>
Las dos se parecen en que, dado un n&uacute;mero de selectores que
describan algo de tr&aacute;fico, entregar&aacute;n una entrada que
describa el proceso necesario.  Sin embargo, SPD se elimina a dos pasos
del proceso:  SPD se usa para paquetes salientes, para decidir
qu&eacute; entradas SAD se deben usar, y qu&eacute; entradas SAD
describen el proceso y sus par&aacute;metros.  Las entradas SPD
especifican las entradas SAD existentes a usar (si es un
&laquo;haz&raquo; puede haber m&aacute;s de una), pero si no hay una
que se pueda usar, entonces se usa para crear otras nuevas.  Los campos
de SA que se crean se pueden tomar de la entrada SPD o del paquete que
d414 5
a418 4
Los paquetes salientes van desde la entrada SPD a la especificada de
SA, para obtener par&aacute;metros de codificaci&oacute;n.  Los
paquetes entrantes obtienen la SA correcta directamente, usando el
tr&iacute;o SPI/DestIP/Protocolo, y de ah&iacute; van a la entrada SPD.
d422 6
a427 5
deber&iacute;a circunvalar IPsec, y cu&aacute;l se deber&iacute;a dejar
caer, as&iacute; que tambi&eacute;n debe ser consultado para
tr&aacute;fico no IPsec entrante.  Las entradas SPD se deben ordenar de
forma expl&iacute;cita, ya que varias podr&iacute;an coincidir con un
paquete particular, y el proceso debe ser reproducible.
d430 6
a435 5
Se puede pensar en SPD como algo parecido a un filtro de paquetes, en
el que las acciones que se deciden son la activaci&oacute;n de procesos
SA.  Los selectores pueden incluir direcciones de origen y destino,
n&uacute;meros de puertos si fueran relevantes, nombres de anfitriones,
niveles de sensibilidad de seguridad, protocolos, etc...
d464 7
a470 6
sesi&oacute;n de IPsec debe tener una de las dos o ambas, pero no se
puede definir sin ninguna de las dos (en caso contrario no
habr&iacute;a cabeceras para especificar el SPI que deba buscar la SA).
El RFC no dice qu&eacute; suceder&iacute;a si las cabeceras AH y ESP
estuvieran en desacuerdo sobre el valor de SPI.  Se puede pensar que
esto implicar&iacute;a m&uacute;ltiples SAs en un haz.
d473 4
a476 4
En OpenBSD, SPD se gestiona a trav&eacute;s de la orden <tt>ipsecadm
flow</tt> (s&oacute;lo se cambiar&iacute;a si estuviera usando el
sistema de claves manual).  Las entradas de SAD se pueden configurar
manualmente con
d479 3
a481 2
autom&aacute;ticos para la iniciaci&oacute;n de sesiones y otras cosas
como el intercambio de claves.  OpenBSD implementa Photuris 
d500 6
a505 5
El sistema de claves manuales es el m&aacute;s sencillo para empezar
con IPsec.  Con este m&eacute;todo puede activar los sistemas
criptogr&aacute;ficos de cifrado entre redes y crear VPN.
Despu&eacute;s de que haya leido esta secci&oacute;n, puede investigar
c&oacute;mo configurarlo de forma autom&aacute;tica mediante el uso de
d510 5
a514 4
n&uacute;cleo del sistema de OpenBSD (si s&oacute;lo est&aacute; usando
ESP, como con el gui&oacute;n rc.vpn, entonce <em>no necesita activar
AH</em>;  de hecho, puede haber problemas relacionados con la seguridad
activando AH si no lo est&aacute; usando).
d528 6
a533 5
Puede editar <em>/etc/sysctl.conf</em> para activarlos durante el
arranque.  Para ello borre la marca de comentario # que ver&aacute;
delante de la l&iacute;nea net.inet.esp.enable y/o net.inet.ah.enable
(dependiendo de cu&aacute;l vaya a usar) y aseg&uacute;rese de que
est&eacute;n configuradas con el valor 1.
d536 5
a540 5
Tambi&eacute;n tendr&aacute; que generar sus claves manuales.  Como la
seguridad del VPN se basa en que estas claves no se puedan
&laquo;adivinar&raquo;, es muy importante escoger las claves usando una
fuente aleatoria fuerte.  Un m&eacute;todo pr&aacute;ctico de
generarlas es usar el dispositivo
d550 3
a552 3
El n&uacute;mero de bits producidos es importante.  Tipos de cifrado
diferentes pueden requerir claves de tama&ntilde;os tambi&eacute;n
diferentes.
d567 6
a572 5
Seguridad&raquo;).  Una SA es una combinaci&oacute;n de sus direcciones
IP, un SPI, y su protocolo de seguridad (AH y/o ESP).  Las direcciones
IP son la suya y la de su destino.  El SPI (&laquo;&Iacute;ndice del
Par&aacute;metro de Seguridad&raquo;) es un n&uacute;mero que OpenBSD
usa para clasificar distintas SAs.
d576 6
a581 5
tr&aacute;fico.  ESP incluye la autenticaci&oacute;n de los datos
cifrados contenidos, pero no autentica la cabecera IP a su alrededor.
Esta &laquo;autenticaci&oacute;n limitada&raquo; es, sin embargo,
suficiente para la mayor&iacute;a de casos, especialmente para ESP en
un entorno de t&uacute;neles.</em>
d591 2
a592 2
Llev&eacute;moslo a la pr&aacute;ctica con dos enrutadores, 192.168.5.1
y 192.168.25.9.
d617 5
a621 4
N&oacute;tese que los SPI son distintos.  Vea la secci&oacute;n 
<a href="#Wire">Sobre el formato &quot;wire&quot;</a> para una
descripci&oacute;n completa sobre qu&eacute; es el SPI y sobre
d&oacute;nde se est&aacute; usando.
d624 2
a625 2
Ahora que ya tiene sus Asociaciones de Seguridad en su sitio, configure
sus flujos.
d632 5
a636 4
ser&aacute; la direcci&oacute;n de origen local, que cubrir&aacute;
todos los paquetes que originen del anfitri&oacute;n local hacia el
destino, y el otro ser&aacute; el flujo de vuelta desde el destino
hasta el anfitri&oacute;n local.
d653 22
a674 18
Si no necesita tanta carga en sus VPN Hu&eacute;sped-a-Hu&eacute;sped
puede crear el SPI sin <tt>-forcetunnel</tt>, lo que le
permitir&aacute; usar el modo de transporte (mientras que
<tt>-forcetunnel</tt> asegura que todo en el paquete IP, incluida la
cabecera IP, sea encapsulado por SPI).  Si el origen o el destino es
una red, tendr&aacute; que usar el modo de t&uacute;nel.  Crear una SA
hacia o desde una red le asegurar&aacute; autom&aacute;ticamente que se
est&eacute;n creando los SPI en modo t&uacute;nel.

<p>
&Eacute;ste es un m&eacute;todo simple para empezar a usar IPsec.

<p>
Puede usar IPsec para pasar los espacios de direcciones IP privados por
t&uacute;neles en Internet.  He aqu&iacute; un buen ejemplo:  Queremos
pasar 192.168.99.0/24 (que se encuentra detr&aacute;s de 208.1.1.1) por
t&uacute;neles a 208.1.2.0/24 y 208.1.5.0/24 (que est&aacute;n
detr&aacute;s de 208.2.2.2).  Estos ejemplos se han generado usando el
d679 4
a682 3
Como puede ver, cuando est&aacute; usando el sistema de claves manuales
con IPsec tiene que especificar <strong>con exactitud</strong> lo que
quiere hacer.  No lo adivinar&aacute; por usted.  Mire estos ejemplos:
d710 2
a711 2
Configure un flujo desde 208.1.2.0/24 (que est&aacute; detr&aacute;s de
208.2.2.2) hasta 192.168.99.0/24
d720 2
a721 2
Configure un flujo desde 208.1.5.0/24 (que est&aacute; detr&aacute;s de
208.2.2.2) hasta 192.168.99.0/24
d730 2
a731 2
Configure un flujo desde 208.1.2.0/24 (que est&aacute; detr&aacute;s de
208.2.2.2) hasta el enrutador 208.1.1.1
d740 2
a741 2
Configure un flujo desde 208.1.5.0/24 (que est&aacute; detr&aacute;s de
208.2.2.2) hasta el enrutador 208.1.1.1
d750 2
a751 2
Finalmente, configure un flujo desde el enrutador 208.2.2.2 hasta el
192.168.99.0/24
d775 2
a776 2
Ahora, &eacute;sta es la parte al inverso...  Configure un flujo desde
el enrutador 208.2.2.2 hasta el 208.1.1.1
d785 2
a786 2
Configure un flujo desde la red 192.168.99.0/24 (que est&aacute;
detr&aacute;s de 208.1.1.1) hasta 208.1.2.0/24
d795 2
a796 2
Configure un flujo desde la red 192.168.99.0/24 (que est&aacute;
detr&aacute;s de 208.1.1.1) hasta 208.1.5.0/24
d805 2
a806 2
Configure un flujo desde 192.169.99.0/24 (que est&aacute; detr&aacute;s
de 208.1.1.1) hasta el enrutador 208.2.2.2
d815 3
a817 3
Ya casi hemos terminado...  Quedan dos flujos para obtener 208.1.2.0/24
y 208.1.5.0/24 desde el enrutador 208.2.2.2 hasta el enrutador
208.1.1.1
d829 2
a830 2
Si ha usado ipsecadm, y quiere librarse de cualquier trabajo que haya
hecho y empezar desde cero, haga
d838 2
a839 2
Esto limpiar&aacute; toda la informaci&oacute;n de IPsec (SPIs, flujos,
entradas de enrutamiento) de su sistema.
d848 3
a850 3
El uso de photuris no est&aacute; tan extendido y por lo que concierne
al estado del RFC, se considera experimental.  Sin embargo, muchas
personas lo han usado con OpenBSD.
d853 3
a855 2
Para configurar photurisd, primero edite /etc/photuris/secrets.conf en
cada anfitri&oacute;n con photurisd.
d872 10
a881 8
elecci&oacute;n en el fichero de configuraci&oacute;n local, y otra
clave de su elecci&oacute;n en el fichero de configuraci&oacute;n
remota (use la misma configuraci&oacute;n en su m&aacute;quina remota
pero cambie el lugar de &quot;local&quot; por el de &quot;remote&quot;,
y viceversa, para que se vea a s&iacute; misma como la clave local).
Note que estas claves ser&aacute;n substituidas en una versi&oacute;n
futura de photurisd que llevar&aacute; a cabo su intercambio inicial de
claves con claves p&uacute;blicas.
d884 2
a885 2
Aseg&uacute;rese de que <em>net.inet.ah.enable</em> est&aacute;
configurado al valor 1.
d902 3
a904 3
Ahora ejecute tcpdump para verificar que sus paquetes est&eacute;n
siendo cifrados con AH (ejecute ping en otra ventana o sesi&oacute;n
para generar tr&aacute;fico).
d912 2
a913 2
Tambi&eacute;n puede intentar usar tcpdump por la direcci&oacute;n del
anfitri&oacute;n si no obtiene nada.
d941 6
a946 5
ISAKMP, tambi&eacute;n conocido como &laquo;Intercambio de Claves por
Internet&raquo; (IKE, &quot;Internet Key Exchange&quot;) es el
mecanismo de intercambio para la VPN.  ISAKMP aborda los problemas de
seguridad usando los m&eacute;todos mencionados en los RFC 2407, 2408 y
2409.  ISAKMP gestiona el intercambio de claves criptogr&aacute;ficas
d953 12
a964 10
<strong>Fase 1</strong> - Los dos extremos de conexiones ISAKMP
establecen un canal seguro, autenticado, sobre el cual se comunican
entre dos d&aelig;mos.  &Eacute;sto establece una Asociaci&oacute;n de
Seguridad (SA) entre ambos anfitriones.  Los m&eacute;todos usados para
establecer este canal son el <strong>Modo Principal</strong> y el
<strong>Modo Agresivo</strong>.  El Modo Principal env&iacute;a la
variada informaci&oacute;n sobre autenticaci&oacute;n en una cierta
secuencia, al tiempo que provee protecci&oacute;n para la identidad.
El Modo Agresivo no provee esta protecci&oacute;n a la identidad porque
toda la informaci&oacute;n sobre la autenticaci&oacute;n se
d966 2
a967 2
deber&iacute;a usar en casos en los que preocupe el ancho de banda de
la red.
d970 20
a989 18
<strong>Fase 2</strong> - Las Asociaciones de Seguridad se negocian en
nombre de IPsec.  La fase 2 establece t&uacute;neles o SAs
t&eacute;rminos entre anfitriones IPsec.  El <strong>Modo
R&aacute;pido</strong> se usa en la fase 2 porque no es necesario
repetir una autenticaci&oacute;n total debido a que la fase 1 ya ha
establecido las SA.

<p>
Resumiendo, la fase 1 se usa para obtener un canal seguro en el que
llevar a cabo las configuraciones (m&aacute;s r&aacute;pidas) de la
fase 2.  Puede haber m&uacute;ltiples configuraciones de la fase 2 en
el mismo canal que la fase 1.  La fase 2 se usa para configurar los
t&uacute;neles.  En la fase 1, sus nodos de IPsec establecen una
conexi&oacute;n en la que intercambian autenticaci&oacute;n (bien sea
un certificado X509 &oacute; un secreto precompartido).  Esto permite
que cada extremo se asegure de que el otro extremo sea autenticado.  La
fase 2 es un intercambio de claves que determinan c&oacute;mo se cifran
los datos entre los dos.
d995 6
a1000 5
OpenBSD viene con los binarios para ISAKMP y para todo IPsec por
definici&oacute;n, pero no con los ficheros de muestra.  Para
obtenerlos necesita bajarse /usr/src/sbin/isakmpd/samples/VPN-east.conf
y /usr/src/sbin/isakmpd/samples/policy del &aacute;rbol de fuentes.
Puede usar su CD (si tiene uno),
d1007 7
a1013 6
<em>/etc/isakmpd/isakmpd.policy</em>, y <em>VPN-east.conf</em> a
<em>/etc/isakmpd/isakmpd.conf</em>.  Intentaremos mostrarle c&oacute;mo
configurar una VPN (t&uacute;nel).  Si desea usar isakmpd entre
anfitriones &uacute;nicos, hay otros ficheros de configuraci&oacute;n
en el directorio <em>samples</em>.  Las p&aacute;ginas de manual
contienen informaci&oacute;n detallada.  No se olvide de
d1022 4
a1025 4
<em>/etc/isakmpd.policy</em>.
Este fichero indica a ISAKMP qui&eacute;n puede acceder a IPsec.  En
este ejemplo, el fichero <em>policy</em> indica que cualquiera que
env&iacute;e datos usando ESP, y que se haya autenticado con la
d1027 9
a1035 7
contrase&ntilde;a que Vd. determine), puede comunicarse con isakmpd.
Puede modificar este fichero para indicar a ISAKMP que s&oacute;lo
quiere permitir datos firmados con ciertos certificados digitales o
usando una cierta transformaci&oacute;n de cifrado.  Tambi&eacute;n
puede permitir el acceso a IPsec a cualquiera.  Esto s&oacute;lo es
recomendable para pruebas.  Para ello, edite su fichero <em>policy</em>
para que contenga s&oacute;lo las siguientes l&iacute;neas:
d1046 3
a1048 3
El mismo fichero <em>policy</em> contiene dos l&iacute;neas que
empiezan con el car&aacute;cter $.  Debe eliminar esas l&iacute;neas
antes de usarlo, son s&oacute;lo para cvs.
d1051 2
a1052 2
Un fichero <em>policy</em> m&aacute;s &uacute;til para este ejemplo
ser&iacute;a:
d1065 5
a1069 5
Implementando esto obtendr&aacute; solamente una VPN (t&uacute;nel)
b&aacute;sica que use ESP.  En el anfitri&oacute;n A, edite
/etc/isakmpd/isakmpd.conf.  La direcci&oacute;n IP de muestra
249.2.2.2, debe ser reemplazada con la direcci&oacute;n IP externa del
anfitri&oacute;n A.
d1095 9
a1103 8
afectar&aacute;n al comportamiento principal de isakmpd.  El uso de los
predefinidos aqu&iacute; es correcto.  El valor
<strong>Listen-on</strong>= especifica el IP en el que isakmpd debe
estar a la escucha.  S&oacute;lo es necesario el IP de Internet de su
pasarela.  Si tiene interfaces m&uacute;ltiples externas en su
pasarela, podr&iacute;a especificar una lista de las interfaces en las
que quiere que est&eacute; a la escucha, introduci&eacute;ndolas,
separadas por comas, en una lista.
d1106 2
a1107 2
A continuaci&oacute;n, en el anfitri&oacute;n A, edite isakmpd.conf
otra vez:
d1126 7
a1132 6
Esta secci&oacute;n describe qu&eacute; direcciones IP se deben aceptar
para negociar la conexi&oacute;n de la fase 1.  Su valor se&ntilde;ala
a la secci&oacute;n de m&aacute;s abajo (recuerde que la fase 1
s&oacute;lo autentica la conexi&oacute;n remota para asegurar que sean
quienes afirman ser).  Puede dar una lista de m&uacute;ltiples
direcciones con l&iacute;neas adicionales en el formato IP_Address=<em>
d1155 3
a1157 3
Esto describe la fase 2 de la conexi&oacute;n.  &Eacute;sta es la fase
que determina qu&eacute; protocolos usar&aacute;n las dos partes para
comunicarse.
d1161 6
a1166 5
secci&oacute;n de m&aacute;s abajo.  Inicia los requisitos o los
m&eacute;todos aceptados para activar la fase 2.  Tambi&eacute;n le
indica a ISAKMPD qu&eacute; conexiones debe iniciar una vez haya
comenzado.  Puede tener secciones m&uacute;ltiples, como se ilustra
abajo, si va a conectar con m&uacute;ltiples anfitriones.
d1169 6
a1174 5
Si no tiene la direcci&oacute;n IP del anfitri&oacute;n remoto, puede
especificar un <strong>Default</strong>= que se&ntilde;ale a una
secci&oacute;n que describa una entrada gen&eacute;rica que
servir&aacute; de referencia para cualquier IP entrante que no
est&eacute; en la lista del indicador <strong>Connections</strong>=.
d1207 6
a1212 5
&Eacute;stas representan las secciones a las que se refiere en la
secci&oacute;n anterior sobre la fase 1.  Cada una de ellas describe
los requisitos que debe cumplir la pasarela del extremo que intenta
conectar, para proceder a la fase 2.  Aqu&iacute; hay muchas otras
opciones, pero las que se mencionan son los requisitos m&iacute;nimos.
d1215 49
a1263 43
<li><strong>Fase=1</strong> se requiere porque el c&oacute;digo ISAKMPD
    usa los mismos procedimientos para procesar Fase 1 y Fase 2.  Debe
    ser <strong>1</strong> o no funcionar&aacute; nada.

<li><strong>Transport=</strong> le ofrece diferentes posiblidades para
    diferentes anfitriones que vayan a conectar.  Se sugiere que
    aqu&iacute; se use UDP, as&iacute; que lo dejaremos en este punto.
    Algunos anfitriones que vayan a conectar pueden estar detr&aacute;s
    de un cortafuegos que no permita pasar tr&aacute;fico UDP.  Esto
    debe ser determinado antes de activarlo.

<li><strong>Local-address</strong> es la direcci&oacute;n de destino a
    la que se&ntilde;alan los paquetes entrantes.  En algunos casos,
    puede estar escuchando conexiones para Fase 1 en distintas
    interfaces.  En esta muestra, s&oacute;lo hay una interfaz
    escuchando, por tanto &eacute;ste es el IP de la interfaz de
    escucha en este extremo de la conexi&oacute;n.

<li><strong>Address=</strong> es la direcci&oacute;n que se&ntilde;ala
    al origen IP de los paquetes entrantes.  Generalmente esto
    se&ntilde;ala a la pasarela del extremo conectado.  Esto necesita
    ser explicado en m&aacute;s detalle, porque la direcci&oacute;n IP
    de origen del otro extremo puede ser desconocida.

<li><strong>Configuration=</strong> se&ntilde;ala a la secci&oacute;n
    de abajo.  Puede especificar m&uacute;ltiples secciones como
    &eacute;sta.  Aqu&iacute; usamos la secci&oacute;n predefinida,
    especificada en el fichero de muestra.

<li><strong>Authentication=</strong> es el secreto precompartido que va
    a usar este extremo de la conexi&oacute;n en particular.  Es,
    m&aacute;s o menos, una contrase&ntilde;a que usa cada extremo de
    la conexi&oacute;n.  Esta contrase&ntilde;a se pasa al fichero
    <em>policy</em> para verificar si tiene permiso para usar IPsec con
    este anfitri&oacute;n.  Si cambia esta contrase&ntilde;a,
    tambi&eacute;n debe cambiarla en el fichero <em>policy</em>, porque
    el fichero de muestra contiene una contrase&ntilde;a.  Si ha
    decidido que va a utilizar un fichero <em>policy</em>
    m&iacute;nimo, entonces puede especificar lo que quiera
    aqu&iacute;.

<li><strong>Flags=</strong> no se usa en la actualidad.  Los RFC dejan
    lugar para que se especifiquen opciones adicionales para la fase 1.
d1266 2
a1267 2
Hay otros indicadores que permiten configurar otras opciones.  Lea la
p&aacute;gina de manual de
d1298 38
a1335 33
&Eacute;stas representan las secciones a las que se refiere en la
secci&oacute;n anterior sobre la fase 2.  Son las configuraciones
individuales que ISAKMPD debe usar para hablar entre las dos pasarelas
de la conexi&oacute;n.

<ul>
<li><strong>Phase=2</strong> es necesaria porque el c&oacute;digo de
    ISAKMPD usa las mismas funciones para autenticar las Fase 1 y la
    Fase 2.  Se requiere para que funcione la VPN.

<li><strong>ISAKMPD-Peer=</strong> es el nombre de la secci&oacute;n
    del anfitri&oacute;n.  Esto significa que estamos hablando con ese
    extremo de la conexi&oacute;n en particular para establecer una
    conexi&oacute;n de Fase 2.  Se provee para que pueda tener
    secciones m&uacute;ltiples que describan conexiones isakmp.

<li><strong>Configuration=</strong> se refiere a la secci&oacute;n que
    describe las normativas que este anfitri&oacute;n y el extremo de
    la conexi&oacute;n en concreto deben cumplir.

<li><strong>Local-ID=</strong> se refiere a una secci&oacute;n IPsec-ID
    que describe su Red Privada a la pasarela del otro extremo de la
    conexi&oacute;n.  &Eacute;sta es la porci&oacute;n que se pasa para
    que la otra pasarela pueda configurar la tabla de enrutamiento
    concreta, que transferir&aacute; datos a trav&eacute;s de la VPN a
    nuestra red.

<li><strong>Remote-ID=</strong> hace referencia a una secci&oacute;n
    IPsec-ID que describe lo que se supone que la Red Privada remota es
    para nuestro anfitri&oacute;n.  Esta porci&oacute;n debe ser
    interpretada para la correcta configuraci&oacute;n de las tablas de
    enrutamiento que transferir&aacute;n datos desde nuestra Red
    Privada, a trav&eacute;s de la VPN, hacia la Red Privada remota.
d1345 7
a1351 6
&Eacute;sta es la secci&oacute;n de IPsec-ID.  Estas entradas deben
existir en los ficheros isakmpd.conf del anfitri&oacute;n A y del
anfitri&oacute;n B.  Este ejemplo configurar&aacute;
192.168.1.0/255.255.255.0 para el anfitri&oacute;n A (que se
conect&oacute; arriba a Net-A) y 192.168.20.0/255.255.255.0 para el
anfitri&oacute;n B (arriba Net-B).
d1369 11
a1379 9
<strong>configuraci&oacute;n</strong> de cada anfitri&oacute;n.  Son
las secciones a las que se hace referencia en los identificadores
<strong>Local-ID</strong> y <strong>Remote-ID</strong>.  Describen las
rutas que se deben configurar para permitir el paso del tr&aacute;fico
desde una red privada hasta otra.  <strong>ID-type</strong>= puede ser
<strong>IPV4_ADDR_SUBNET</strong> o <strong>IPV4_ADDR</strong> (RFC2708
menciona m&aacute;s valores posibles.  En la actualidad s&oacute;lo hay
soporte en la implementaci&oacute;n de OpenBSD para IPv4.  El soporte
para IPv6 puede estar en OpenBSD-current).
d1382 2
a1383 1
Ahora, en ambos anfitriones, el fichero de muestra deber&iacute;a ser:
d1395 23
a1417 19
Esta secci&oacute;n describe los requisitos para los m&eacute;todos de
cifrado de las conexiones de la fase 1.  El nombre refleja el valor de
la variable <em>Configuration=</em>.  Como se puede ver aqu&iacute;,
estamos indicando nuestro Dominio de Inter&eacute;s, que es IPsec.  La
variable <strong>EXCHANGE_TYPE</strong> est&aacute; configurada con el
valor <strong>ID_PROT</strong> para la fase 1, que identifica los
protocolos que cubrir&aacute; esta autenticaci&oacute;n.
<strong>Transforms=</strong> es la transformaci&oacute;n
criptogr&aacute;fica requerida (o asignada) para este intercambio.  En
este caso se&ntilde;ala a la secci&oacute;n de abajo en el fichero de
configuraci&oacute;n, que indica que estamos recibiendo un paquete
cifrado con 3DES y una suma de comprobaci&oacute;n verificable con SHA.
Hay muchas transformaciones criptogr&aacute;ficas definidas en el
fichero de muestra <strong>VPN-east.conf</strong>.  &Eacute;stas se
proveen porque 3DES y SHA no siempre tienen soporte en las diferentes
plataformas.  Para OpenBSD no hay raz&oacute;n para cambiar esta
configuraci&oacute;n b&aacute;sica.  Si desea crear copias de esta
secci&oacute;n y cambiar la variable <strong>Transforms</strong>=,
puede hacerlo.  El &uacute;nico requisito es que cambie la variable
d1430 14
a1443 12
Esta secci&oacute;n describe los requisitos para el cifrado de los
datos que se env&iacute;an a trav&eacute;s de la VPN, y la referencia a
ella est&aacute; arriba en <em>Configuration</em>.  Note que la
diferencia entre esta secci&oacute;n y su equivalente en la fase 1
anterior es que <strong>EXCHANGE_TYPE</strong> es
<strong>QUICK_MODE</strong>.  <strong>Suites=</strong> se&ntilde;ala a
una secci&oacute;n Suite de IPsec que describe los distintos esquemas
de cifrado disponibles entre los dos anfitriones.  Se podr&iacute;a
decir mucho m&aacute;s sobre ISAKMP e IPsec, pero usando las
descripciones b&aacute;sicas que hemos mencionado deber&iacute;a ser
capaz de crear una VPN simple pero s&oacute;lida, que se cuidara de
s&iacute; misma.  Esto es el <em>m&iacute;nimo indispensable</em> de
d1452 1
a1452 1
<tt># <b>isakmpd -d -DA=99</b></tt>
d1456 6
a1461 5
la primera vez que decida invocar este d&aelig;mon.  El d&aelig;mon no
funcionar&aacute; en modo d&aelig;mon, sino como un proceso regular.
Grabar&aacute; todo en su terminal.  Para parar isakmpd y limpiar las
rutas, tiene que matar el proceso isakmpd en cada modo, y ejecutar
<strong>ipsecadm flush</strong>.
d1471 6
a1476 6
Configurar isakmpd para el uso de certificados en lugar de claves
precompartidas no es mucho m&aacute;s dif&iacute;cil en una gran red
con muchas conexiones entrantes no fiables de lo que ser&iacute;a en
una peque&ntilde;a red.  En realidad puede simplificar la
configuraci&oacute;n, y m&aacute;s importante, la gesti&oacute;n de
claves.
d1482 2
a1483 2
Hay una buena descripci&oacute;n sobre c&oacute;mo generar claves y
certificados en el fichero
d1485 4
a1488 4
del directorio de fuentes de isakmpd.  Debe tener una clave CA, el
correspondiente certificado CA X.509, una clave privada para cada
m&aacute;quina en la red que use isakmpd, y un certificado X.509 para
cada una de esas claves.
d1492 25
a1516 22
&laquo;Asunto Nombre Alternativo&raquo; (SubjectAltName), que describa
al poseedor del certificado.  C&oacute;mo configurar una
extensi&oacute;n SubjectAltName usando certpatch para un certificado,
tambi&eacute;n se describe en README.PKI para el caso de
configuraci&oacute;n de una direcci&oacute;n IP como la
extensi&oacute;n SubjectAltName.  Aqu&iacute;, el uso de una
direcci&oacute;n IP tambi&eacute;n es el comportamiento por
definici&oacute;n de isakmpd.

<p>
Certpatch tambi&eacute;n tiene soporte para el uso de &laquo;Nombres de
Dominio Totalmente Cualificados&raquo; (FQDN, &quot;Fully Qualified
Domain Name&quot;) o UFQDN (FQDN de Usuario).  Un ejemplo de un FQDN
ser&iacute;a <tt>www.openbsd.org</tt>, y un ejemplo de un UFQDN
ser&iacute;a una direcci&oacute;n de correo electr&oacute;nico, como
por ejemplo <tt>Jorgen.Granstam@@abc.se</tt>.

<p>
En este documento usar&eacute; FQDNs como SubjectAltNames.  El uso de
direcciones IP deber&iacute;a ser algo m&aacute;s f&aacute;cil, ya que
es el comportamiento por definici&oacute;n de isakmpd pero no es muy
diferente, como veremos m&aacute;s adelante.
d1530 8
a1537 7
Aqu&iacute;, ca.key es la clave privada de la &laquo;Autoridad de
Certificaci&oacute;n&raquo; (CA), por lo tanto esto s&oacute;lo lo
puede hacer quien tenga acceso a la clave privada del CA.
home.mysite.se es el FQDN que se introduce en el certificado.  Los
nombres de los ficheros originalcert.crt y nuevocert.crt podr&iacute;an
tener el mismo nombre, en cuyo caso el fichero original ser&iacute;a
anulado por el certificado modificado nuevo.
d1540 4
a1543 4
Ponga las claves y certificados en los directorios tal y como se
describe al final de README.PKI.  Si se van a usar las clave de una
forma seria, la clave CA (ca.key) se debe guardar en alg&uacute;n sitio
seguro.
d1565 6
a1570 5
En realidad, puesto que todo el que lea esto ya tendr&aacute; una
configuraci&oacute;n que funcione del caso de claves precompartidas
(ver la secci&oacute;n anterior), no habr&aacute; muchas sorpresas en
este fichero.  No lo explicar&eacute; en detalle, mire isakmpd.conf(5)
para descripciones de las partes que no comente.
d1573 2
a1574 1
Asumamos que nuestra configuraci&oacute;n es parecida a &eacute;sta:
d1649 1
a1649 1
# direcci&oacute;n IP.  Note que ya no hay ninguna etiqueta de
d1808 6
a1813 5
Hasta aqu&iacute; la configuraci&oacute;n para el sistema local.  El
sistema remoto se configura exactamente del mismo modo, s&oacute;lo que
al rev&eacute;s.  Por lo tanto, la primera parte del fichero
isakmpd.conf es diferente.  Echemos un vistazo a esa primera parte del
fichero isakmpd.conf para la pasarela de seguridad de gw.worksite.se:
d1860 2
a1861 2
No ha sido tan dif&iacute;cil, tal vez algo aburrido de leer.  La
siguiente parte es algo m&aacute;s interesante.
d1867 6
a1872 6
El fichero <em>policy</em> puede ser algo confuso para alguien que no
lo haya usado con anterioridad, especialmente si las cosas no funcionan
como se espera.  La p&aacute;gina de manual de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&sektion=5">isakmpd.policy(5)</a>
no est&aacute; tan mal.  Tal vez sea poco clara en algunas partes, pero
en general es buena.
d1887 21
a1907 18
<em>policy</em> sobre qui&eacute;n puede conectar.  Por lo tanto, no es
una configuraci&oacute;n muy segura.  La etiqueta authorizer es para
indicar qui&eacute;n tiene la autorizaci&oacute;n para decidir la
pol&iacute;tica a seguir.  El autorizador especial &quot;POLICY&quot;
tiene la autoridad total sobre <em>policy</em>.  Cualquier otro
authorizer debe primero ser autorizado por &quot;POLICY&quot; para
poder tener cualquier autoridad.

<p>
Tambi&eacute;n puede haber un grupo de condiciones sobre qu&eacute;
est&aacute; autorizado.  El siguiente <em>policy</em> vendr&iacute;a a
decir que s&oacute;lo alguien que use el protocolo ESP con algo de
cifrado real, estar&iacute;a autorizado (bueno, alguien que usara DES
tambi&eacute;n estar&iacute;a autorizado aqu&iacute;, aunque DES casi
est&aacute; considerado como muy inseguro, se deja como ejercicio para
el lector el cambiar este fichero <em>policy</em> para no permitir
tampoco DES).  Note que cualquiera que cifre con ESP todav&iacute;a
estar&iacute;a autorizado.
d1920 6
a1925 5
Tambi&eacute;n se puede &laquo;sublicenciar&raquo; la autoridad a
alguien m&aacute;s (podr&iacute;a ser una o m&aacute;s entidades).  El
caso simple ser&iacute;a el caso de la clave precompartida.  En ese
caso, cualquiera que sepa que la contrase&ntilde;a precompartida,
estar&aacute; autorizado.  Por lo tanto:
d1939 4
a1942 4
Esto autorizar&iacute;a a cualquiera que supiera esta contrase&ntilde;a
para conectar y cumplir con las condiciones (pero recuerde que la
contrase&ntilde;a tambi&eacute;n se debe activar en la etiqueta
Authentication de isakmpd.conf).
d1945 7
a1951 7
Hasta ahora, nada complicado.  Ahora viene la parte interesante.
Primero, puede haber muchos con licencias, aunque deben estar todos
autorizados por &quot;POLICY&quot;.  Adem&aacute;s, aqu&eacute;llos que
dispongan de licencias y est&eacute;n autorizados, pueden
&laquo;sublicenciar&raquo; a otros.  Un licenciado puede ser
simplemente una cadena si est&aacute; m&aacute;s descrito en el fichero
<i>policy</i>:
d1971 7
a1977 6
Y ahora, a por lo que todos estaban esperando.  <em>policy</em>
tambi&eacute;n se puede sublicenciar o delegar a una clave.  En este
caso suele ser un certificado X.509.  El uso m&aacute;s simple de
certificados ser&iacute;a usarlos como las contrase&ntilde;as.
Simplemente introduzca certificados de usuarios individuales en el
fichero <em>policy</em>:
d2003 6
a2008 6
Esto, obviamente, es una idea est&uacute;pida si hay muchos usuarios.
Los certificados que isakmpd lee de los directorios CA- y Certificate,
y los certificados recibidos desde el otro extremo de la
conexi&oacute;n se convierten en pseudocredenciales.  Estos
certificados convertidos en pseudocredenciales ser&iacute;an algo
as&iacute;:
d2040 10
a2049 9
Note que &eacute;stos no est&aacute;n autorizados por
&quot;POLICY&quot; y por lo tanto no tendr&aacute;n ning&uacute;n
efecto sin que est&eacute;n de alguna manera autorizados.
Adem&aacute;s, esto muestra lo que le ocurre internamente a los
certificados.  La credencial anterior no se ve en el fichero
<em>policy</em>.  Sin embargo, se puede dar una sublicencia a tales
credenciales.  Recuerde el tema sobre sublicencias.  Es posible dar
licencias a todos los certificados que est&eacute;n firmados por una
cierta CA, poniendo el certificado de la CA como un licenciado de
d2076 6
a2081 6
El fichero <em>policy</em> que hemos visto es un simple ejemplo de
fichero <em>policy</em> que delega en una CA.  Cualquier usuario que
tenga un certificado firmado por la CA de este certificado, y que
adem&aacute;s cumpla las otras condiciones configuradas en
<em>policy</em> y en el fichero de configuraci&oacute;n, estar&aacute;
autorizado.
d2088 17
a2104 15
Desafortunadamente, esto no es suficiente para estar realmente seguro.
Hay formas para atacar una pasarela de seguridad configurada de esta
forma.  Si no quiere leer los detalles, pase a la secci&oacute;n
siguiente ahora.  Para el resto, intentaremos entender porqu&eacute;
esto no es seguro.  No es dif&iacute;cil.

<p>
Considere a qu&eacute; informaci&oacute;n tiene acceso en este momento
uno de los isakmpd.  Del fichero de configuraci&oacute;n, isakmpd sabe
cu&aacute;l es el IP-address desde el que se conectar&aacute;n (en la
secci&oacute;n Fase 1).  De la informaci&oacute;n que obtiene durante
la negociaci&oacute;n de la fase 1, sabe el ID con el que el extremo
que se conecta presenta a s&iacute; mismo y el certificado que obtiene
desde ese extremo de la conexi&oacute;n prueba que que ese ID le
pertenece.
d2108 92
a2199 82
secci&oacute;n ID en fase 1, &eacute;sta es la situaci&oacute;n por
definici&oacute;n), todo va bien.  La CA habr&aacute; ligado el IP al
certificado, y el IP en la configuraci&oacute;n ser&aacute; toda la
informaci&oacute;n que necesitemos.  Un impostor podr&iacute;a usar el
mismo IP de otra m&aacute;quina en algunos casos (por ejemplo, si ambas
m&aacute;quinas estuvieran en la misma red local y la m&aacute;quina
que tuviera este IP estuviera fuera de servicio por cualquier motivo).
Sin embargo, el impostor no podr&iacute;a tener un certificado y la
correspondiente clave privada que probara que este IP pertenece al
impostor.

<p>
Si esto ocurriera alguna vez, el impostor habr&iacute;a conseguido
robar la clave privada del aut&eacute;ntico propietario del IP, o el
impostor habr&iacute;a conseguido enga&ntilde;ar la CA para que le
diera un certificado que contuviera informaci&oacute;n falsa.  En el
primer caso significar&iacute;a que la clave privada no se
habr&iacute;a protegido lo suficientemente bien, y en el segundo la CA
habr&iacute;a fallado al comprobar la identidad del impostor como
debiera (o la informaci&oacute;n del ID del certificado) o la clave
privada de la CA no habr&iacute;a estado bien protegida.  Como todo
esto son prerrequisitos para que la seguridad funcione, ninguna de
estas situaciones deber&iacute;a suceder nunca.

<p>
En nuestro ejemplo la situaci&oacute;n es diferente.  Aqu&iacute;
tenemos un FQDN en el certificado en lugar de una direcci&oacute;n IP.
Como todav&iacute;a tenemos una direcci&oacute;n IP en la
secci&oacute;n de fase 1, tenemos por tanto un posible problema de
seguridad.  Lo que ocurrir&iacute;a durante la negociaci&oacute;n de
fase 1 de ISAKMP ser&iacute;a que podr&iacute;amos comprobar que el
extremo de la conexi&oacute;n se hubiera llevado a cabo desde el IP
supuesto (pero como hemos explicado anteriormente, en algunos casos se
podr&iacute;a falsificar).  Podr&iacute;amos comprobar que ese ID que
presenta nuestro extremo de la conexi&oacute;n realmente pertenece a
&eacute;ste.  Pero lo que no podr&iacute;amos comprobar ahora
ser&iacute;a si ese ID es realmente el ID que suponemos, porque isakmpd
nunca ha sabido qu&eacute; ID deber&iacute;a ser.

<p>
Alguien podr&iacute;a decir que el sistema de DNS ata el IP al FQDN
para el anfitri&oacute;n.  Es cierto, sin embargo el sistema de DNS
actual no es seguro y se le puede, bajo ciertas circunstancias,
enga&ntilde;ar para que entregue informaci&oacute;n falsa (o
podr&iacute;a ser v&iacute;ctima de una ataque de
&laquo;denegaci&oacute;n de servicio&raquo; (DoS, &quot;Denial of
Service&quot;) por parte de un atacante, y la m&aacute;quina del
atacante podr&iacute;a falsificar la respuesta del servidor de DNS).
DNS seguro aparecer&aacute; en el futuro, pero todav&iacute;a no
est&aacute; aqu&iacute; (o por lo menos la mayor&iacute;a de servidores
de DNS todav&iacute;a no son seguros);  por lo tanto, hoy en
d&iacute;a, el uso de DNS para comprobar si el FQDN en el certificado
corresponde al IP supuesto, no es una garant&iacute;a.  De hecho,
isakmpd no lo comprueba con DNS.  Aun cuando DNS fuera seguro, la
comprobaci&oacute;n no servir&iacute;a en el caso de usar un UFQDN.

<p>
As&iacute; pues, en caso de tener un FQDN como ID, ser&iacute;a posible
que un atacante obtuviese su propia clave privada y que &eacute;sta
estuviera firmada por la misma CA que usamos nosotros (pero con el FQDN
del atacante).  Y podr&iacute;a lanzar un ataque DoS sobre nuestra
conexi&oacute;n para hacerla caer (de hecho, existen unos agujeros en
el mismo protocolo ISAKMP, que probablemente se podr&iacute;n usar para
lanzar un ataque DoS remoto contra la conexi&oacute;n y hacerla caer,
aunque no s&eacute; qu&eacute; sensibles a estos ataques ser&iacute;a
isakmpd).  Entonces, el atacante podr&iacute;a configurar su propia
m&aacute;quina del mismo modo que la de nuestra conexi&oacute;n,
conectarla a la red de nuestra conexi&oacute;n, e intentar conectarse
mediante su ID, clave privada y certificado propios.

<p>
Nuestro isakmpd no habr&iacute;a sido informado sobre qu&eacute; ID por
nuestra conexi&oacute;n (debido a que el atacante est&aacute;
configurado de forma id&eacute;ntica a nuestra conexi&oacute;n, aparte
del certificado, ID y clave privada).  Nuestro isakmpd podr&iacute;a
comprobar que el certificado estuviera firmado por la misma CA (pero la
mayor&iacute;a de CAs firman muchos certificados, y un certificado no
es tan dif&iacute;cil de conseguir), y que el ID presentado fuera el
mismo que el ID en el certificado.  Sin embargo, con la
configuraci&oacute;n presentada hasta ahora, no comprobar&iacute;a que
este ID fuera el supuesto.  Por lo tanto, el atacante tendr&iacute;a
permiso para conectar.
d2205 4
a2208 4
Ahora la cuesti&oacute;n es, &iquest;c&oacute;mo podemos informar a
isakmpd sobre qu&eacute; ID debe esperar?  Por suerte esto es
f&aacute;cil, y est&aacute; documentado en la p&aacute;gina de manual
de
d2210 2
a2211 1
Debemos hacer la comprobaci&oacute;n en <em>policy</em>, como esto:
d2256 2
a2257 2
Con esta <em>policy</em> podr&iacute;an conectar tanto gw.worksite.se,
como gw.somesite.se, como gw.whatsite.se.
d2260 20
a2279 17
Algunos afirman que es desafortunado que tengan que haber certificados
enteros introducidos en <em>policy</em>.  Reformatear los certificados
en el formato de <em>policy</em> requiere algo de esfuerzo, y hace que
<em>policy</em> sea poco legible.  Si alguien substituyera por error,
un certificado de usuario con el correspondiente certificado de CA en
alguna parte de un fichero <em>policy</em> complejo, podr&iacute;a
provocar que usuarios no autorizados obtuvieran permiso para conectar
en algunos casos y, a&uacute;n peor, no ser&iacute;a f&aacute;cilmente
detectable leyendo el fichero <em>policy</em> (porque los certificados
X.509 no est&aacute;n en un formato humano legible).

<p>
Ahora, para aquellos a quienes les gusta estar al borde del precipicio,
existe una soluci&oacute;n a este problema.  Ahora se puede usar el
certificado &laquo;Nombre Distinguido&raquo; (DN, &quot;Distinguished
Name&quot;) en lugar de un certificado en <em>policy</em> (por supuesto
que el correspondiente certificado debe estar disponible desde los
d2281 2
a2282 2
encontrar).  Con este formato, el fichero <em>policy</em> anterior
acabar&iacute;a siendo algo as&iacute;:
d2301 3
a2303 3
Mucho m&aacute;s legible, &iquest;o no?  La informaci&oacute;n sobre lo
que es el exacto DN para un certificado se puede encontrar mirando al
certificado, usando la utilidad openssl:
d2314 3
a2316 2
complicadas pero esto es suficiente para empezar, y todav&iacute;a hay
otro ejemplo en la siguiente secci&oacute;n.
d2319 6
a2324 6
Esto deber&iacute;a proveerle con la informaci&oacute;n necesaria sobre
el certificado en ca.crt.  Esto ser&aacute; bueno siempre que tengamos
un fichero <em>policy</em> peque&ntilde;o o, por lo menos, uno
razonable.  Sin embargo, todav&iacute;a no es suficiente si tenemos un
sitio enorme con muchos usuarios que deban tener permiso de
conexi&oacute;n.
d2331 16
a2346 13
Veamos ahora algunas caracter&iacute;sticas interesantes de isakmpd.
Hasta ahora hemos asumido que el supuesto extremo remoto de la
conexi&oacute;n era conocido y ten&iacute;a una direcci&oacute;n IP
est&aacute;tica.  Esto no siempre es as&iacute;.  Muchas personas usan
IPs asignados de forma din&aacute;mica, o usan muchas m&aacute;quinas
diferentes.  En otros casos, como en el caso de los servidores,
podr&iacute;amos no estar seguros de qui&eacute;n quiere conectar.

<p>
Por lo tanto, una funcionalidad interesante de isakmpd es que puede
usar en la secci&oacute;n de fase 1 una etiqueta predefinida en lugar
de un IP, permitiendo de este modo negociaciones isakmpd desde
cualquier IP.  Esto se har&iacute;a del siguiente modo:
d2357 5
a2361 4
Primero, hay que decir que esta configuraci&oacute;n podr&iacute;a no
ser segura frente a ataques de DoS.  Como se ha dicho anteriormente,
existen algunos agujeros en los protocolos ISAKMP/IKE.  De todos modos,
el uso de una secci&oacute;n de fase 1 predefinida tambi&eacute;n nos
d2366 11
a2376 10
Imagine que tuvi&eacute;ramos muchos usuarios autorizados, pero que no
acept&aacute;ramos a cualquier usuario, como podr&iacute;a ocurrir en
una compa&ntilde;&iacute;a.  Nos gustar&iacute;a que los empleados
tuvieran permiso para conectar, pero nadie m&aacute;s.  Ahora imagine
que la compa&ntilde;&iacute;a tuviera miles de empleados, y que
quisi&eacute;ramos que todos ellos pudieran conectar desde cualquier
m&aacute;quina (no s&oacute;lo desde dentro de la red de la
compa&ntilde;&iacute;a), pero que no todos tuvieran permiso para hacer
cualquier cosa.  Se podr&iacute;a escribir un fichero <em>policy</em>
como &eacute;ste:
d2416 6
a2421 5
Puede que esto no sea exactamente como deber&iacute;a ser.  Por lo que
s&eacute;, no est&aacute; comprobado (de hecho, estas condiciones de
filtros podr&iacute;an no funcionar como espero).  Adem&aacute;s, un
fichero <em>policy</em> como &eacute;ste (cualquiera con un IP del
extremo de la conexi&oacute;n predefinido) requerir&iacute;a reescribir
d2423 7
a2429 6
conllevar&iacute;a algunas implicaciones en la seguridad.  Para este
tipo de conexiones en las que cualquiera debe tener permiso para
conectar, es probablemente deseable grabar el DN de cualquiera que
conecte.  Que yo sepa, isakmpd todav&iacute;a no tiene soporte para
esto.  Adem&aacute;s, tambi&eacute;n podr&iacute;a tener otras
implicaciones en la seguridad.  De cualquier modo la idea b&aacute;sica
d2433 32
a2464 28
Por si acaso alguien no ha visto las interesantes posibilidades que
esto tiene: Si todas la m&aacute;quinas que usan ISAMKP/IKE de este
modo, tuvieran un grupo de condiciones est&aacute;ndar para todos los
servicios que los usuarios quisieran usar de forma remota, la CA
podr&iacute;a autorizar a los usuarios poniendo las extensiones
SubjectAltName correctas en sus certificados.  Adem&aacute;s, la fecha
de caducidad para estos certificados se podr&iacute;a configurar para
que caducara a menudo, aunque los usuarios podr&iacute;an obtener
nuevos certificados cuando sus certificados actuales estuvieran a punto
de caducar.  Si los usuarios hicieran un mal uso de sus autorizaciones,
bastar&iacute;a con no volver a emitir los certificados para que no
pudieran acceder despu&eacute;s de la fecha de caducidad.  No
ser&iacute;a necesario cambiar los ficheros <em>policy</em> en todas
las m&aacute;quinas simplemente porque un empleado, por ejemplo, dejara
el trabajo.  El mismo esquema podr&iacute;a funcionar para
prop&oacute;sitos distintos a ISAKMP/IPsec (¡incluida la
autorizaci&oacute;n para sistemas fuera de la conexi&oacute;n!), aunque
eso requerir&iacute;a un software especial.  En cualquier caso,
cualquier organizaci&oacute;n que hiciera esto es probable que
tambi&eacute;n quisiera ser su propia CA.

<p>
Las configuraciones de multiusuarios (usuarios m&oacute;viles) como
&eacute;sta, tambi&eacute;n son posibles con claves precompartidas,
pero entonces se requiere que se use el modo AGGRESSIVE en lugar del
modo ID_PROT, ya que en este caso necesitaremos poder escoger la frase
de la contrase&ntilde;a correcta basada en el ID, debido a que en este
caso no lo podemos saber por el ID (en modo AGGRESSIVE el ID se
d2466 5
a2470 4
negociaci&oacute;n, pero se env&iacute;a descifrado, por lo tanto el
modo AGGRESSIVE es m&aacute;s r&aacute;pido porque necesita menos
intercambios de mensajes, pero tambi&eacute;n es un poco menos seguro
debido a que el ID se env&iacute;a en claro).
d2480 6
a2485 5
<code>isakmpd</code> es el d&aelig;mon de la gesti&oacute;n de claves de
ISAKMP/Oakley que viene con OpenBSD.  Sospechamos que interacciona, por
lo menos en parte, con la mayor&iacute;a de implementaciones ISAKMP,
pero s&oacute;lo los siguientes han sido comprobados.  Note que algunos
software isakmp que puede encontrar est&aacute;n basados en el
d2489 2
a2490 2
Los siguientes clientes para MS-Windows son compatibles seg&uacute;n
los informes recibidos:
d2505 2
a2506 2
Las siguientes pasarelas/enrutadores son compatibles seg&uacute;n los
informes recibidos:
d2535 2
a2536 2
Para resolver problemas, la primera herramienta que debe usar es
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&apropos=0&sektion=8&format=html">tcpdump(8)</a>.
d2540 7
a2546 7
Si est&aacute; usando tcpdump en OpenBSD, dispone de una versi&oacute;n
mejorada de tcpdump que puede mostrarle algo de informaci&oacute;n
sobre paquetes ESP y AH.  Si est&aacute; usando tcpdump desde OpenBSD
2.5 o desde otro sistema operativo, es posible que tenga una
versi&oacute;n anticuada que s&oacute;lo le muestre el n&uacute;mero
del protocolo para AH o ESP (el protocolo IP de ESP es 50, y el de AH
es 51).
d2550 7
a2556 6
<li>Con tcpdump, mire si el tr&aacute;fico est&aacute; usando AH/ESP o
    texto en claro.  Si su tr&aacute;fico es en texto en claro,
    entonces sus flujos est&aacute;n configurados de modo incorrecto, o
    su isakmp no est&aacute; negociando como debiera.  Use 
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&apropos=0&sektion=8&format=html">ping(8)</a>
    para generar tr&aacute;fico simple.
d2560 3
a2562 2
Por ejemplo, yo tengo dos m&aacute;quinas anfitrionas, 208.1.1.1 y
208.2.2.2.  Ingreso en 208.2.2.2 y hago lo siguiente:
d2575 2
a2576 1
Y en otra sesi&oacute;n puedo ver mis &quot;pings&quot; encapsulados:
d2593 3
a2595 3
<li>ISAKMP va por el puerto UDP 500.
    Si este puerto est&aacute; bloqueado por un cortafuegos o filtro de
    paquetes, entonces debe cambiarlo.
d2610 3
a2612 3
<li>Photuris va por el puerto UDP 468.
    Se aplican las mismas consideraciones que anteriormente, pero el
    protocolo aqu&iacute; es AH.
d2627 2
a2628 1
<li>Para activar todo el depurado en isakmpd, in&iacute;cielo como
d2638 2
a2639 2
o (para saltar la informaci&oacute;n m&aacute;s detallada de depurado
del temporizador
d2649 2
a2650 2
<li>Debe permitir el paso a su net A con cortafuegos del tr&aacute;fico
    que ha sido procesado por IPsec.
d2660 3
a2662 3
<li>Con tcpdump en OpenBSD puede descodificar la mayor parte del texto
    en claro de las sesiones IKE.  tcpdump tambi&eacute;n le
    mostrar&aacute; los datos de cargo de AH.
d2666 1
a2666 1
    definici&oacute;n)
d2676 4
a2679 4
En /kern hay una tabla de SA/SPIs actuales, incluidos los que tienen
flujos (SAs salientes) y los que no (SAs entrantes).  Tambi&eacute;n
hay contadores de tr&aacute;fico que puede usar para ver qu&eacute;
tr&aacute;fico pasa y a d&oacute;nde va.
d2683 2
a2684 2
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=netstat&apropos=0&sektion=1&format=html">netstat(1)</a>
    para ver sus SAs
d2705 9
a2713 9
<li>Si todo lo dem&aacute;s fallara, recompile el n&uacute;cleo del
    sistema con <code>option ENCDEBUG</code>.  A continuaci&oacute;n
    configure <em>net.inet.ip.encdebug</em> con el valor 1 en sysctl.
    Busque avisos o errores en su dmesg, e informe sobre ellos a los
    desarrolladores de OpenBSD, usando
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendbug&apropos=0&sektion=1&format=html">sendbug(1)</a>.
    De forma alternativa, si no est&aacute; seguro de que su problema
    sea un error, puede enviar un mensaje a una de las 
    <a href="../../es/mail.html">listas de correo</a>.
d2723 2
a2724 2
IPsec est&aacute; parcialmente documentado en la p&aacute;gina de
manual de
d2737 3
a2739 2
tienen informaci&oacute;n m&aacute;s detallada y pueden ayudarle con la
configuraci&oacute;n y operaci&oacute;n de IPsec.
d2800 2
a2801 2
Originally [OpenBSD: faq13.html,v 1.51 2002/02/20 03:13:15 nick Exp ]<br>
$Translation: faq13.html,v 1.18 2002/03/29 10:02:49 horacio Exp $<br>
@


1.17
log
@
broken links
@
text
@d5 1
d2684 1
a2684 1
$Translation: faq13.html,v 1.17 2002/03/23 09:49:47 jufi Exp $<br>
@


1.16
log
@
sync with badlands translation CVS.
@
text
@d978 1
a978 1
<a href="ManKey">principio de la secci&oacute;n 13.6</a>
d2683 1
a2683 1
$Translation: faq13.html,v 1.16 2002/02/23 02:49:56 horacio Exp $<br>
@


1.15
log
@
sync with badlands translation CVS
@
text
@d1479 10
a1488 9
pero se ha modificado mucho.  Tambi&eacute;n usar&eacute; un fichero
mucho m&aacute;s corto que en el fichero de ejemplo en la p&aacute;gina
de manual.  He eliminado de ese fichero la mayor&iacute;a de las partes
no necesarias para esta configuraci&oacute;n.  En parte para
simplificar la comprensi&oacute;n de esta configuraci&oacute;n.
Tambi&eacute;n he a&ntilde;adido algunos comentarios (algunos
comentarios los he dejado como estaban en isakmpd.conf(5)), y he
cambiado algunos nombres.  Ninguno de los nombres de dominio
aqu&iacute; usados existen (que yo sepa).
d2682 2
a2683 2
Originally [OpenBSD: faq13.html,v 1.50 2002/01/27 22:44:34 nick Exp ]<br>
$Translation: faq13.html,v 1.15 2002/01/28 14:51:09 horacio Exp $<br>
@


1.14
log
@
sync with badlands translation CVS
@
text
@d74 1
a74 1
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/protocols?rev=1.8">cualquier protocolo IP</a>
d86 3
a88 2
<a href="http://www.3com.com/nsc/501302s.html">Understanding IP
Addressing</a> es muy recomendable.
d486 1
a486 1
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/rc.vpn?rev=1.3">/usr/share/ipsec/rc.vpn</a>.
d594 1
a594 1
<a href="#13.4">Sobre el formato &quot;wire&quot;</a> para una
d962 1
a962 1
<a href="http://www.openbsd.org/es/anoncvs.html">cliente de CVS en la
d977 5
a981 4
Su primer paso es activar ESP.  Al 
<a href="#13.6" target="_blank">principio de la secci&oacute;n 13.6</a>
se explica c&oacute;mo hacerlo, tanto durante el arranque como con el
sistema funcionando.  Despu&eacute;s debe editar /etc/isakmpd.policy.
d1476 2
a1477 2
/etc/isakmpd/isakmpd.conf.  Originalmente se tom&oacute; del fichero de
ejemplo en
d2379 6
a2384 6
   <li><a href="http://www.timestep.com/">TimeStep</a> PERMIT/Client
   <li><a href="http://www.vpcom.com/">Ashley Laurent</a> VPCom VPN 
       software
   <li><a href="http://www.nai.com/asp_set/products/tns/pgp_vpn.asp">PGP 
       VPN</a> software
   <li><a href="http://www.radguard.com/">Radguard</a> cIPro client
d2386 2
a2387 2
   <li><a href="http://www.microsoft.com">Microsoft</a> Windows 2000 
       (S&oacute;lo en modo de transporte)
d2398 1
a2398 1
   <li><a href="http://www.timestep.com/">TimeStep</a> PERMIT/Gate
d2401 3
a2403 3
   <li><a href="http://www.xs4all.nl/~freeswan/">FreeS/WAN</a> para
       Linux
   <li><a href="http://www.axent.com/">Axent</a> Raptor
a2404 1
   <li><a href="http://www.radguard.com/">Radguard</a> cIPro-VPN
d2408 4
a2411 2
   <li><a href="http://www.nortelnetworks.com/">Nortel</a> Contivity
   <li><a href="http://www.checkpoint.com/">CheckPoint</a> FW-1
d2631 1
a2631 1
   <li><a href="http://www.codetalker.com/greenbox/docs/vpn-24-minifaq.html">Mini-FAQ de Configuraci&oacute;n de una VPN con OpenBSD 2.4</a>
d2681 2
a2682 2
Originally [OpenBSD: faq13.html,v 1.49 2002/01/21 20:28:25 nick Exp ]<br>
$Translation: faq13.html,v 1.14 2002/01/22 21:24:07 horacio Exp $<br>
@


1.13
log
@
sync with badlands translation CVS.
new tags.
@
text
@d9 1
a9 1
<meta name="copyright"     content="Este documento es copyright 2000-2001 de OpenBSD">
d2678 2
a2679 2
Originally [OpenBSD: faq13.html,v 1.48 2002/01/13 00:00:32 ericj Exp ]<br>
$Translation: faq13.html,v 1.13 2002/01/16 20:14:55 horacio Exp $<br>
@


1.12
log
@
sync with badlands translation CVS.
@
text
@d12 1
a12 1
<body bgcolor="#ffffff" text="#000000" link="#23238e">
d22 2
a23 2
<li><a href="#13.1">13.1 - &iquest;Qu&eacute; es IPsec?</a>
<li><a href="#13.2">13.2 - Est&aacute; bien pero, &iquest;para
d25 1
a25 1
<li><a href="#13.3">13.3 - &iquest;Cu&aacute;les son los
d27 6
a32 5
<li><a href="#13.4">13.4 - Sobre el formato &quot;wire&quot;</a>
<li><a href="#13.5">13.5 - Configuraci&oacute;n de IPsec</a>
<li><a href="#13.6">13.6 - &iquest;C&oacute;mo configuro IPsec
con el sistema de &laquo;claves manuales&raquo;?</a>
<li><a href="#13.7">13.7 - &iquest;C&oacute;mo configuro
d34 1
a34 1
<li><a href="#13.8">13.8 - &iquest;C&oacute;mo configuro
d36 1
a36 1
<li><a href="#13.9">13.9 - &iquest;C&oacute;mo uso isakmpd con
d38 1
a38 1
<li><a href="#13.10">13.10 - &iquest;Qu&eacute; clientes IKE
d40 3
a42 3
<li><a href="#13.11">13.11 - Soluci&oacute;n de problemas de
IPsec/VPN</a>
<li><a href="#13.12">13.12 - Documentaci&oacute;n
d47 1
a47 1
Partes de este contenido han sido sacadas de:
d59 1
d62 1
d94 2
a95 2
   <li>Hu&eacute;sped-a-Hu&eacute;sped
   <li>Hu&eacute;sped-a-Red
d101 1
a101 1
Hu&eacute;sped-a-Enrutador (y este enrutador controla y cifra
d106 2
a107 2
tr&aacute;fico para conexiones de &laquo;Redes Privadas
Virtuales&raquo; (VPN, &quot;Virtual Private Networks&quot;).
d109 2
a110 2
Con un registro central de &laquo;Intercambio de Claves de
Internet&raquo; (IKE, &quot;Internet Key Exchange&quot;), cada
d112 1
a112 1
y usar cifrado y autenticaci&oacute;n fuerte.
d115 1
d117 1
a117 1
<h1>13.2 - Est&aacute; bien pero, &iquest;para qu&eacute;
d119 1
d132 5
a136 4
Aseg&uacute;rese de que sea dif&iacute;cil para todos comprender
qu&eacute; datos se han comunicado, excepto para el receptor.  No
querr&aacute; que nadie vea sus contrase&ntilde;as cuando ingrese en
una m&aacute;quina remota a trav&eacute;s de Internet.
d141 5
a145 5
Garantice que los datos no puedan ser cambiados en el camino.  Si se
encuentra en una l&iacute;nea que lleve datos sobre facturaci&oacute;n,
seguro que querr&aacute; estar seguro de que las cantidades y cifras de
contabilidad son las correctas, y que no han podido ser alteradas
durante el tr&aacute;nsito.
d173 1
d177 1
d206 1
d209 1
d364 2
d368 1
d472 2
a473 1

d475 3
a477 2
<h1>13.6 - &iquest;C&oacute;mo configuro IPsec con el sistema de
&laquo;claves manuales&raquo;?</h1>
d810 1
d813 1
d890 1
d893 1
d896 6
a901 4
Si est&aacute; pensando en VPNs u otras aplicaciones tradicionales de
IPsec, probablemente vaya a usar ISAKMP.  Algunas implementaciones
comerciales de IPsec no proveen ning&uacute;n tipo de sistema de claves
manual, y en su lugar requieren que use alg&uacute;n tipo de ISAKMP.
d1392 1
d1394 3
a1396 1
<h1>13.9 - &iquest;C&oacute;mo uso isakmpd con certificados X.509?</h1>
d2358 1
d2360 3
a2362 2
<h1>13.10 - &iquest;Qu&eacute; clientes IKE son compatibles con
isakmpd?</h1>
d2412 1
d2414 2
a2415 1
<h1>13.11 - Soluci&oacute;n de problemas de IPsec/VPN</h1>
d2418 1
a2418 1
Para solventar problemas, la primera herramienta que debe usar es
d2596 1
d2599 1
d2678 2
a2679 2
Originally [OpenBSD: faq13.html,v 1.46 2001/12/23 03:09:52 miod Exp ]<br>
$Translation: faq13.html,v 1.12 2001/12/30 03:07:46 horacio Exp $<br>
@


1.11
log
@sync with badlands translation CVS, work by Horacio
@
text
@d3 1
a3 1
<title>13.0 - Uso de IPSec</title>
d15 1
a15 1
<h1><font color="#e00000">13.0 - Uso de IPSec (Protocolo de
d17 1
a19 2

<h1>13.0 - Uso de IPSec (Protocolo de Seguridad de IP)</h1>
d22 1
a22 1
<li><a href="#13.1">13.1 - &iquest;Qu&eacute; es IPSec?</a>
d24 3
a26 3
    qu&eacute; querr&iacute;a usar IPSec?</a>
<li><a href="#13.3">13.3 - &iquest;Cu&aacute;les son los protocolos
    detr&aacute;s de IPSec?</a>
d28 7
a34 5
<li><a href="#13.5">13.5 - Configuraci&oacute;n de IPSec</a>
<li><a href="#13.6">13.6 - &iquest;C&oacute;mo configuro IPSec con el
    sistema de &laquo;claves manuales&raquo;?</a>
<li><a href="#13.7">13.7 - &iquest;C&oacute;mo configuro photurisd?</a>
<li><a href="#13.8">13.8 - &iquest;C&oacute;mo configuro isakmpd?</a>
d36 3
a38 3
    certificados X.509?</a>
<li><a href="#13.10">13.10 - &iquest;Qu&eacute; clientes IKE son
    compatibles con isakmpd?</a>
d40 3
a42 2
    IPSec/VPN</a>
<li><a href="#13.12">13.12 - Documentaci&oacute;n relacionada</a>
d50 1
a50 1
<li><a href="http://www.freebsd.org/~julian/IPSEC_4_Dummies.html">IPSec for Dummies</a> por Julian Elischer
d59 1
a59 1
<h1>13.1 - &iquest;Qu&eacute; es IPSec?</h1>
d62 9
a70 8
IPSec es un grupo de extensiones de la familia del protocolo IP.  IPSec
provee servicios criptogr&aacute;ficos de seguridad.  Estos servicios
permiten la autenticaci&oacute;n, integridad, control de acceso, y
confidencialidad.  IPSec provee servicios similares a SSL, pero a nivel
de redes, de un modo que es completamente transparente para sus
aplicaciones y mucho m&aacute;s robusto.  Es transparente porque sus
aplicaciones no necesitan tener ning&uacute;n conocimiento de IPSec
para poder usarlo.  Puede usar
d72 4
a75 4
sobre IPSec.  Puede crear t&uacute;neles cifrados (VPNs), o simple
cifrado entre computadoras (ordenadores).  Debido a que dispone de
tantas opciones, IPSec es m&aacute;s bien complejo (&iexcl;mucho
m&aacute;s que SSL!).
d78 5
a82 4
Antes de empezar a usar IPSec, le recomendamos encarecidamente que mire
la &laquo;lectura recomendada&raquo; de la 
<a href="faq6.html">secci&oacute;n 6</a> de las preguntas frecuentes.
En particular, si todav&iacute;a no lo entiende, el documento 
d87 2
a88 2
De un modo l&oacute;gico, IPSec funciona en cualquiera de estos tres
modos:
d96 4
a99 4
En cualquier escenario en el que haya una red, el concepto de enrutador
est&aacute; impl&iacute;cito, como en Hu&eacute;sped-a-Enrutador (y
este enrutador controla y cifra el tr&aacute;fico para una <i>Red</i>
particular).
d102 8
a109 7
Como puede ver, IPSec se puede usar como t&uacute;nel de tr&aacute;fico
para conexiones de &laquo;Redes Privadas Virtuales&raquo; (VPN,
&quot;Virtual Private Networks&quot;).  Sin embargo, su utilidad va
m&aacute;s all&aacute; de las VPNs.  Con un registro central de
&laquo;Intercambio de Claves de Internet&raquo; (IKE, &quot;Internet
Key Exchange&quot;), cada m&aacute;quina en internet podr&iacute;a
comunicarse con otra y usar cifrado y autenticaci&oacute;n fuerte.
d114 1
a114 1
querr&iacute;a usar IPSec?</h1>
d120 2
a121 2
sea quien dice ser.  IPSec intenta remediarlo.  Estos servicios vienen
tratados como dos servicios distintos, pero IPSec ofrece soporte para
d163 1
a163 1
sistema de claves manuales de IPSec (v.g., cuando se est&eacute; usando 
d168 2
a169 2
<h1>13.3 - &iquest;Cu&aacute;les son los protocolos detr&aacute;s de
IPSec?</h1>
d172 24
a195 22
IPSec provee confidencialidad, integridad, autenticidad, y
protecci&oacute;n a la r&eacute;plica a trav&eacute;s de dos nuevos
protocolos.  Estos protocolos se llaman &laquo;Cabecera de
Autenticaci&oacute;n&raquo; (AH, &quot;Authentication Header&quot;) y
&laquo;Cargo de Seguridad Encapsulado&raquo; (ESP, &quot;Encapsulated
Security Payload&quot;).

<p>
AH provee auntenticaci&oacute;n, integridad, y protecci&oacute;n a la
r&eacute;plica (pero no confidencialidad).  Su principal diferencia con
ESP es que AH tambi&eacute;n asegura partes de la cabecera IP del
paquete (como las direcciones de origen o destino).

<p>
ESP puede proveer autenticaci&oacute;n, integridad, protecci&oacute;n a
la r&eacute;plica, y confidencialidad de los datos (asegura todo lo que
sigue a la cabecera en el paquete).  La protecci&oacute;n a la
r&eacute;plica requiere autenticaci&oacute;n e integridad (&eacute;stas
dos van siempre juntas).  La confidencialidad (cifrado) se puede usar
con o sin autenticaci&oacute;n y/o integridad.  Del mismo modo, puede
usar la autenticaci&oacute;n y/o la integridad con o sin la
confidencialidad.
d202 9
a210 8
La <strong>Cabecera de Autenticaci&oacute;n</strong> (AH) viene de la
cabecera b&aacute;sica IP y contiene res&uacute;menes
criptogr&aacute;ficos (&quot;hash&quot;) de los datos e
informaci&oacute;n de identificaci&oacute;n.  Los res&uacute;menes
criptogr&aacute;ficos tambi&eacute;n pueden cubrir las partes
invariables de la misma cabecera de IP.  Hay varios RFCs diferentes que
ofrecen una elecci&oacute;n de algoritmos para AH, sin embargo todos
deben seguir las l&iacute;neas especificadas en el
d214 6
a219 5
La cabecera del <strong>Cargo de Seguridad Encapsulado</strong> (ESP)
permite reescribir el cargo en modo cifrado.  La cabecera ESP no
considera los campos de la cabecera IP que van delante, y por lo tanto
no garantiza nada excepto el cargo.  Los distintos tipos de ESP
aplicables deben seguir conformar con el
d221 3
a223 2
Una cabecera ESP tambi&eacute;n puede proveer autenticaci&oacute;n para
el cargo (pero no la cabecera exterior).
d226 4
a229 4
Una divisi&oacute;n ortogonal (en su mayor parte) de funcionalidad de
IPSec, se aplica dependiendo de si el extremo que est&aacute; llevando
a cabo la encapsulaci&oacute;n IPSec es la fuente original de los datos
o una pasarela:
d254 1
a254 1
Los enlaces seguros de IPSec se definen en t&eacute;rminos de
d355 1
a355 1
<h1>13.5 - Configuraci&oacute;n de IPSec</h1>
d358 1
a358 1
La forma en la que se configuran los sistemas IPSec y las pasarelas es,
d368 1
a368 1
llamado TDB o tabla TDB en el c&oacute;digo fuente de IPSec de
d393 1
a393 1
deber&iacute;a circunvalar IPSec, y cu&aacute;l se deber&iacute;a dejar
d395 1
a395 1
tr&aacute;fico no IPSec entrante.  Las entradas SPD se deben ordenar de
d411 1
a411 1
   <li>Protocolo IPSec (AH o ESP)
d433 1
a433 1
sesi&oacute;n de IPSec debe tener una de las dos o ambas, pero no se
d461 1
a461 1
<h1>13.6 - &iquest;C&oacute;mo configuro IPSec con el sistema de
d466 2
a467 2
con IPSec.  Con este m&eacute;todo puede activar los sistemas
criptogr&aacute;ficos de cifrado entre redes y crear VPNs.
d621 1
a621 1
&Eacute;ste es un m&eacute;todo simple para empezar a usar IPSec.
d624 1
a624 1
Puede usar IPSec para pasar los espacios de direcciones IP privados por
d634 1
a634 1
con IPSec tiene que especificar <strong>con exactitud</strong> lo que
d791 1
a791 1
Esto limpiar&aacute; toda la informaci&oacute;n de IPSec (SPIs, flujos,
d878 2
a879 2
IPSec, probablemente vaya a usar ISAKMP.  Algunas implementaciones
comerciales de IPSec no proveen ning&uacute;n tipo de sistema de claves
d893 1
a893 1
par&aacute;metros de IPSec entre dos nodos de IPSec.
d912 2
a913 2
nombre de IPSec.  La fase 2 establece t&uacute;neles o SAs
t&eacute;rminos entre anfitriones IPSec.  El <strong>Modo
d923 1
a923 1
t&uacute;neles.  En la fase 1, sus nodos de IPSec establecen una
d934 1
a934 1
OpenBSD viene con los binarios para ISAKMP y para todo IPSec por
d959 1
a959 1
Este fichero indica a ISAKMP qui&eacute;n puede acceder a IPSec.  En
d967 1
a967 1
puede permitir el acceso a IPSec a cualquiera.  Esto s&oacute;lo es
d994 1
a994 1
Conditions: app_domain ==&quot;IPSec policy&quot; &amp;&amp;
d1177 1
a1177 1
    <em>policy</em> para verificar si tiene permiso para usar IPSec con
d1241 1
a1241 1
<li><strong>Local-ID=</strong> se refiere a una secci&oacute;n IPSec-ID
d1249 1
a1249 1
    IPSec-ID que describe lo que se supone que la Red Privada remota es
d1263 1
a1263 1
&Eacute;sta es la secci&oacute;n de IPSec-ID.  Estas entradas deben
d1312 1
a1312 1
estamos indicando nuestro Dominio de Inter&eacute;s, que es IPSec.  La
d1346 1
a1346 1
una secci&oacute;n Suite de IPSec que describe los distintos esquemas
d1348 1
a1348 1
decir mucho m&aacute;s sobre ISAKMP e IPSec, pero usando las
d1486 7
a1492 6
O sea, dos redes que deben conectarse usando un t&uacute;nel IPSec
sobre una red de otro modo insegura.  Ignore el hecho de que
aqu&iacute; est&eacute; usando direcciones IP reservadas para Internets
privadas (RFC1918), debo usar algo.  No explicar&eacute; c&oacute;mo
usar isakmpd en combinaci&oacute;n con NAT ni nada parecido (ya que no
lo he probado).
d1495 2
a1496 2
Ahora, veamos el fichero de configuraci&oacute;n.  &Eacute;ste es el
fichero para la pasarela de seguridad gw.mysite.se:
d1525 1
a1525 1
# Fase 2 es la negociaci&oacute;n de SAs de IPSec.  Como en fase 1,
d1569 1
a1569 1
# &Eacute;sta es la secci&oacute;n para la conexi&oacute;n IPSec.  El
d1575 1
a1575 1
# por el t&uacute;nel IPSec hacia la red remota.
d1591 1
a1591 1
# ser&aacute; cifrado y reenviado por el t&uacute;nel IPSec al sistema
d2116 4
a2119 4
conexi&oacute;n IPSec.  Se pueden a&ntilde;adir m&aacute;s permisos
para otros IDs, a&ntilde;adiendo m&aacute;s comprobaciones remote_id
alternativas, o sea, teniendo condiciones en <em>policy</em> como
&eacute;sta:
d2314 1
a2314 1
prop&oacute;sitos distintos a ISAKMP/IPSec (¡incluida la
d2387 1
a2387 1
<h1>13.11 - Soluci&oacute;n de problemas de IPSec/VPN</h1>
d2501 1
a2501 1
    que ha sido procesado por IPSec.
d2572 1
a2572 1
IPSec est&aacute; parcialmente documentado en la p&aacute;gina de
d2587 1
a2587 1
configuraci&oacute;n y operaci&oacute;n de IPSec.
d2593 5
a2597 5
   <li><a href="http://www.ietf.org/html.charters/ipsec-charter.html">Grupo de Trabajo de IPSec del IETF</a>
   <li><a href="http://isakmp-test.ssh.fi/">Nodo de Verificaci&oacute;n de Interoperabilidad de SSH IPSec</a>
   <li><a href="http://ipsec-wit.antd.nist.gov/">Verificador de Interoperabilidad de NIST IPSec basado en web</a>
   <li><a href="http://www.r4k.net/ipsec/">Porte de IPSec de OpenBSD para FreeBSD</a>
   <li><a href="http://www.xs4all.nl/~freeswan/">FreeS/WAN - IPSec para Linux</a>
d2615 1
a2615 1
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2207.html">RFC 2207</a> - RSVP Extensions for IPSec Data Flows
d2618 1
a2618 1
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2401.html">RFC 2401</a> - Security Architecture for the Internet Protocol (<strong>IPSec</strong>)
d2648 2
a2649 2
Originally [OpenBSD: faq13.html,v 1.45 2001/10/04 09:59:02 wilfried Exp ]<br>
$Translation: faq13.html,v 1.11 2001/10/19 14:08:15 horacio Exp $<br>
@


1.10
log
@
sync with badlands translation CVS.
@
text
@d1989 1
a1989 1
mismo IP de otra m&aacute;quina en algunos casos (si ambas
d2637 2
a2638 2
Originally [OpenBSD: faq13.html,v 1.44 2001/09/10 19:26:32 jufi Exp ]<br>
$Translation: faq13.html,v 1.10 2001/09/20 02:09:35 horacio Exp $<br>
@


1.9
log
@
Sync with translation CVS, work by Horacio
@
text
@d9 1
a9 1
<meta name="copyright"     content="Este documento es copyright (C) 2000 de OpenBSD">
d15 3
a17 20

<p>
<font color="#0000e0">
<a href="index.html">[Volver al &iacute;ndice principal]</a>
<a href="faq12.html">[Secci&oacute;n 12.0 - Para usuarios avanzados]</a>
<a href="faq14.html">[Secci&oacute;n 14.0 - Uso de discos en OpenBSD]</a>
</font>
</p>

<p>
<font size="-1">
Partes de este documento proceden de:
<ul>
   <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&sektion=4&format=html">ipsec(4)</a>
   <li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&sektion=8&format=html">vpn(8)</a>
   <li><a href="http://www.freebsd.org/~julian/IPSEC_4_Dummies.html">IPSec for Dummies</a> por Julian Elischer
   <li><a href="http://www.secureops.com/vpn/vpn.html">ISAKMP Howto</a> por Patrick Ethier
   <li><a href="http://hem.passagen.se/hojg/isakmpd/">X.509v3 certificates with isakmpd</a> por J&ouml;rgen Granstam
</ul>
</font>
d21 1
d42 12
a2586 1
   <li><a href="http://www.cs.umass.edu/~lmccarth/ipsec.html">Muchos enlaces relacionados con IPSec</a>
d2637 2
a2638 2
Originally [OpenBSD: faq13.html,v 1.40 2001/03/26 17:14:09 todd Exp ]<br>
$Translation: faq13.html,v 1.9 2001/04/06 16:41:15 horacio Exp $<br>
@


1.8
log
@
another sync. Work by horacio.
@
text
@d5 3
a7 3
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq">
d9 1
a9 1
<meta name="copyright"     content="This document copyright (C) 2000 OpenBSD">
d2642 2
a2643 2
Originally [OpenBSD: faq13.html,v 1.39 2001/02/25 07:15:09 ericj Exp ]<br>
$Translation: faq13.html,v 1.8 2001/02/26 00:05:34 horacio Exp $<br>
@


1.7
log
@
Sync with translation CVS. Work by Horacio
@
text
@d405 1
a405 1
   <li>Protocolo IPSec (SA o ESP)
d2642 2
a2643 2
Originally [OpenBSD: faq13.html,v 1.38 2001/01/27 22:19:47 ericj Exp ]<br>
$Translation: faq13.html,v 1.7 2001/02/24 22:41:06 horacio Exp $<br>
@


1.6
log
@
Sync with Badlands Translation CVS. Work by Horacio
@
text
@d36 1
a36 1
<p>
d160 4
a163 4
<i>AVISO: tal y como lo especifica la normativa, la protecci&oacute;n a
la r&eacute;plica no se llevar&aacute; a cabo cuando se use el sistema
de claves manuales de IPSec (v.g., cuando se est&eacute; usando 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&apropos=0&sektion=8&format=html">ipsecadm(8)</a>)</i>.
d199 8
a206 8
La <b>Cabecera de Autenticaci&oacute;n</b> (AH) viene de la cabecera
b&aacute;sica IP y contiene res&uacute;menes criptogr&aacute;ficos
(&quot;hash&quot;) de los datos e informaci&oacute;n de
identificaci&oacute;n.  Los res&uacute;menes criptogr&aacute;ficos
tambi&eacute;n pueden cubrir las partes invariables de la misma
cabecera de IP.  Hay varios RFCs diferentes que ofrecen una
elecci&oacute;n de algoritmos para AH, sin embargo todos deben seguir
las l&iacute;neas especificadas en el
d210 5
a214 5
La cabecera del <b>Cargo de Seguridad Encapsulado</b> (ESP) permite
reescribir el cargo en modo cifrado.  La cabecera ESP no considera los
campos de la cabecera IP que van delante, y por lo tanto no garantiza
nada excepto el cargo.  Los distintos tipos de ESP aplicables deben
seguir conformar con el
d226 17
a242 17
   <li>El modo <b>transporte</b> es el que usa un anfitri&oacute;n que
       genera los paquetes.  En modo transporte, las cabeceras de
       seguridad se a&ntilde;aden antes que las cabeceras de la capa de
       transporte (v.g., TCP, UDP), antes de que la cabecera IP sea
       a&ntilde;adida al paquete.  En otras palabras, un AH
       a&ntilde;adido al paquete cubrir&aacute; el resumen
       criptogr&aacute;fico de la cabecera TCP y algunos campos de la
       cabecera IP extremo-a-extremo, y una cabecera ESP cubrir&aacute;
       el cifrado de la cabecera TCP y los datos, pero no la cabecera
       IP extremo-a-extremo.</li>

   <li>El modo <b>T&uacute;nel</B> se usa cuando la cabecera IP
       extremo-a-extremo ya ha sido adjuntada al paquete, y uno de los
       extremos de la conexi&oacute;n segura es solamente una pasarela.
       En este modo, las cabeceras AH y ESP se usan para cubrir todo el
       paquete, incluida la cabecera extremo-a-extremo, y se
       a&ntilde;ade una nueva cabecera IP al paquete que cubre
d249 12
a260 11
&laquo;Asociaciones de Seguridad&raquo; (<b>SA</b>s).  Cada SA viene
definida por un &uacute;nico flujo unidireccional de datos, y por regla
general (ignorando multicast) desde un &uacute;nico punto hasta otro,
cubriendo el tr&aacute;fico que se distingue por alg&uacute;n
&laquo;selector &uacute;nico&raquo;.  Todo el flujo de tr&aacute;fico
sobre un &uacute;nico SA se trata del mismo modo.  Algo del
tr&aacute;fico puede estar sujeto a varios SAs, cada uno de los cuales
aplica alg&uacute;n tipo de transformaci&oacute;n criptogr&aacute;fica.
Un grupo de SAs se conoce como un &laquo;Haz&raquo; (&quot;SA
Bundle&quot;).  Los paquetes entrantes se pueden asignar a un SA
particular por medio de los tres campos de definici&oacute;n:
d285 2
a286 2
<td><b>IPhdr</B></td>
<td><b>AH</B></td>
d299 2
a300 2
<td><b>IPhdr</B></td>
<td><b>AH</B></td>
d314 5
a318 5
<td><b>IPhdr</B></td>
<td><b>AH</B></td>
<td><b>ESP</B></td>
<td><I>TCPhdr</I></td>
<td><I>datos</I></td>
d329 6
a334 6
<td><b>IPhdr</B></td>
<td><b>AH</B></td>
<td><b>ESP</B></td>
<td><I>IPhdr2</I></td>
<td><I>TCPhdr</I></td>
<td><I>datos</I></td>
d469 2
a470 2
ESP, como con el gui&oacute;n rc.vpn, entonce <i>no necesita activar
AH</i>;  de hecho, puede haber problemas relacionados con la seguridad
d478 1
a478 1
# <b>sysctl -w net.inet.esp.enable=1</b><br>
d480 1
a480 1
# <b>sysctl -w net.inet.ah.enable=1</b><br>
d485 1
a485 1
Puede editar <tt>/etc/sysctl.conf</tt> para activarlos durante el
d502 1
a502 1
# <b>dd if=/dev/urandom bs=1024 count=1 | sha1</b>
d530 1
a530 1
<i>En estos ejemplos s&oacute;lo se usa ESP para cifrar su
d535 1
a535 1
un entorno de t&uacute;neles.</i>
d540 1
a540 1
# <b>ipsecadm new esp -spi SPI_OUT -src MY_EXTERNAL_IP -dst PEER_EXTERNAL_IP -forcetunnel -enc blf -auth sha1 -key ENC_KEY -authkey AUTH_KEY</b>
d550 1
d553 1
a553 1
# <b>ipsecadm new esp -spi 1000 -src 192.168.5.1 -dst 192.168.25.9 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b>
d555 1
a555 1
# <b>ipsecadm new esp -spi 1001 -dst 192.168.5.1 -src 192.168.25.9 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b>
d561 1
d564 1
a564 1
# <b>ipsecadm new esp -spi 1001 -src 192.168.25.9 -dst 192.168.5.1 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b>
d566 1
a566 1
# <b>ipsecadm new esp -spi 1000 -dst 192.168.25.9 -src 192.168.5.1 -forcetunnel -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 6a20367e21c66e5a40739db293cf2ef2a4e6659f</b>
d584 5
a588 5
Aqu&iacute; se crear&aacute;n <b>dos</b> flujos, uno ser&aacute; la
direcci&oacute;n de origen local, que cubrir&aacute; todos los paquetes
que originen del anfitri&oacute;n local hacia el destino, y el otro
ser&aacute; el flujo de vuelta desde el destino hasta el
anfitri&oacute;n local.
d592 1
a592 2
# <b>ipsecadm flow -proto esp -dst 192.168.25.9 -spi 1000
-addr 192.168.5.1 255.255.255.255 192.168.25.9 255.255.255.255</b>
d600 1
a600 2
# <b>ipsecadm flow -proto esp -dst 192.168.5.1 -spi 1001
-addr 192.168.25.9 255.255.255.255 192.168.5.1 255.255.255.255</b>
d628 2
a629 2
con IPSec tiene que especificar <b>con exactitud</b> lo que quiere
hacer.  No lo adivinar&aacute; por usted.  Mire estos ejemplos:
d640 1
a640 1
# <b>ipsecadm new esp -src 208.1.1.1 -dst 208.2.2.2 -forcetunnel -spi 1001 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b>
d642 1
a642 1
# <b>ipsecadm new esp -src 208.2.2.2 -dst 208.1.1.1 -forcetunnel -spi 1000 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b>
d652 1
a652 1
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 208.1.1.1 255.255.255.255 208.2.2.2 255.255.255.255</b>
d662 1
a662 1
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 192.168.99.0 255.255.255.0 208.1.2.0 255.255.255.0</b>
d672 1
a672 1
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 192.168.99.0 255.255.255.0 208.1.5.0 255.255.255.0</b>
d682 1
a682 1
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 208.1.1.1 255.255.255.255 208.1.2.0 255.255.255.0</b>
d692 1
a692 1
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 208.1.1.1 255.255.255.255 208.1.5.0 255.255.255.0</b>
d702 1
a702 1
# <b>ipsecadm flow -proto esp -dst 208.2.2.2 -spi 1001 -addr 192.168.99.0 255.255.255.0 208.2.2.2 255.255.255.255</b>
d715 1
a715 1
# <b>ipsecadm new esp -src 208.2.2.2 -dst 208.1.1.1 -forcetunnel -spi 1000 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b>
d717 1
a717 1
# <b>ipsecadm new esp -src 208.1.1.1 -dst 208.2.2.2 -forcetunnel -spi 1001 -enc blf -auth sha1 -key 7762d8707255d974168cbb1d274f8bed4cbd3364 -authkey 67e21c66e5a40739db293cf2ef2a4e6659f</b>
d727 1
a727 1
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.2.2.2 255.255.255.255 208.1.1.1 255.255.255.255</b>
d737 1
a737 1
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.2.0 255.255.255.0 192.168.99.0 255.255.255.0</b>
d747 1
a747 1
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.5.0 255.255.255.0 192.168.99.0 255.255.255.0</b>
d757 1
a757 1
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.2.2.2 255.255.255.255 192.168.99.0 255.255.255.0</b>
d768 1
a768 1
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.2.0 255.255.255.0 208.2.2.2 255.255.255.255 -ingress</b>
d770 1
a770 1
# <b>ipsecadm flow -proto esp -dst 208.1.1.1 -spi 1000 -addr 208.1.5.0 255.255.255.0 208.2.2.2 255.255.255.255 -ingress</b>
d781 1
a781 1
# <b>ipsecadm flush</b>
d803 2
a804 2
bsd# <b>cat /etc/photuris/secrets.conf</b>
# Palabras claves aceptadas:
d826 1
a826 1
Aseg&uacute;rese de que <tt>net.inet.ah.enable</tt> est&aacute;
d831 1
a831 1
bsd# <b>sysctl -w net.inet.ah.enable=1</b>
d840 1
a840 1
bsd# <b>startkey dst=remote.host</B>
d850 2
a851 1
bsd# <b>tcpdump proto ah</b>
a852 1
</ul>
d859 2
a860 1
bsd# <b>tcpdump host remote.host</b>
a861 1
</ul>
d890 21
a910 19
<b>Fase 1</b> - Los dos extremos de conexiones ISAKMP establecen un
canal seguro, autenticado, sobre el cual se comunican entre dos
d&aelig;mos.  &Eacute;sto establece una Asociaci&oacute;n de Seguridad
(SA) entre ambos anfitriones.  Los m&eacute;todos usados para
establecer este canal son el <b>Modo Principal</b> y el <b>Modo
Agresivo</b>.  El Modo Principal env&iacute;a la variada
informaci&oacute;n sobre autenticaci&oacute;n en una cierta secuencia,
al tiempo que provee protecci&oacute;n para la identidad.  El Modo
Agresivo no provee esta protecci&oacute;n a la identidad porque toda la
informaci&oacute;n sobre la autenticaci&oacute;n se env&iacute;a al
mismo tiempo.  El modo agresivo s&oacute;lo se deber&iacute;a usar en
casos en los que preocupe el ancho de banda de la red.

<p>
<b>Fase 2</b> - Las Asociaciones de Seguridad se negocian en nombre de
IPSec.  La fase 2 establece t&uacute;neles o SAs t&eacute;rminos entre
anfitriones IPSec.  El <b>Modo R&aacute;pido</b> se usa en la fase 2
porque no es necesario repetir una autenticaci&oacute;n total debido a
que la fase 1 ya ha establecido las SA.
d938 3
a940 3
disponibles).  Para este ejemplo, copie <i>policy</i> a
/etc/isakmpd/isakmpd.policy, y <i>VPN-east.conf</i> a
/etc/isakmpd/isakmpd.conf.  Intentaremos mostrarle c&oacute;mo
d943 1
a943 1
en el directorio <i>samples</i>.  Las p&aacute;ginas de manual
d954 1
a954 1
este ejemplo, el fichero <i>policy</i> indica que cualquiera que
d962 1
a962 1
recomendable para pruebas.  Para ello, edite su fichero <i>policy</i>
d974 3
a976 3
El mismo fichero <i>policy</i> contiene dos l&iacute;neas que empiezan
con el car&aacute;cter $.  Debe eliminar esas l&iacute;neas antes de
usarlo, son s&oacute;lo para cvs.
d979 1
a979 1
Un fichero <i>policy</i> m&aacute;s &uacute;til para este ejemplo
a980 1
<br>
d1024 7
a1030 7
predefinidos aqu&iacute; es correcto.  El valor <b>Listen-on</b>=
especifica el IP en el que isakmpd debe estar a la escucha.
S&oacute;lo es necesario el IP de Internet de su pasarela.  Si tiene
interfaces m&uacute;ltiples externas en su pasarela, podr&iacute;a
especificar una lista de las interfaces en las que quiere que
est&eacute; a la escucha, introduci&eacute;ndolas, separadas por comas,
en una lista.
d1058 2
a1059 2
direcciones con l&iacute;neas adicionales en el formato IP_Address=<i>
&lt;PEER-NAME&gt;.</i>.
d1086 6
a1091 6
El indicador <b>Connections</b>= se refiere a la secci&oacute;n de
m&aacute;s abajo.  Inicia los requisitos o los m&eacute;todos aceptados
para activar la fase 2.  Tambi&eacute;n le indica a ISAKMPD qu&eacute;
conexiones debe iniciar una vez haya comenzado.  Puede tener secciones
m&uacute;ltiples, como se ilustra abajo, si va a conectar con
m&uacute;ltiples anfitriones.
d1095 4
a1098 4
especificar un <b>Default</b>= que se&ntilde;ale a una secci&oacute;n
que describa una entrada gen&eacute;rica que servir&aacute; de
referencia para cualquier IP entrante que no est&eacute; en la lista
del indicador <b>Connections</b>=.
d1138 34
a1171 34
<li><b>Fase=1</b> se requiere porque el c&oacute;digo ISAKMPD usa los
    mismos procedimientos para procesar Fase 1 y Fase 2.  Debe ser
    <b>1</b> o no funcionar&aacute; nada.

<li><b>Transport=</b> le ofrece diferentes posiblidades para diferentes
    anfitriones que vayan a conectar.  Se sugiere que aqu&iacute; se
    use UDP, as&iacute; que lo dejaremos en este punto.  Algunos
    anfitriones que vayan a conectar pueden estar detr&aacute;s de un
    cortafuegos que no permita pasar tr&aacute;fico UDP.  Esto debe ser
    determinado antes de activarlo.

<li><b>Local-address</b> es la direcci&oacute;n de destino a la que
    se&ntilde;alan los paquetes entrantes.  En algunos casos, puede
    estar escuchando conexiones para Fase 1 en distintas interfaces.
    En esta muestra, s&oacute;lo hay una interfaz escuchando, por tanto
    &eacute;ste es el IP de la interfaz de escucha en este extremo de
    la conexi&oacute;n.

<li><b>Address=</b> es la direcci&oacute;n que se&ntilde;ala al origen
    IP de los paquetes entrantes.  Generalmente esto se&ntilde;ala a la
    pasarela del extremo conectado.  Esto necesita ser explicado en
    m&aacute;s detalle, porque la direcci&oacute;n IP de origen del
    otro extremo puede ser desconocida.

<li><b>Configuration=</b> se&ntilde;ala a la secci&oacute;n de abajo.
    Puede especificar m&uacute;ltiples secciones como &eacute;sta.
    Aqu&iacute; usamos la secci&oacute;n predefinida, especificada en
    el fichero de muestra.

<li><b>Authentication=</b> es el secreto precompartido que va a usar
    este extremo de la conexi&oacute;n en particular.  Es, m&aacute;s o
    menos, una contrase&ntilde;a que usa cada extremo de la
    conexi&oacute;n.  Esta contrase&ntilde;a se pasa al fichero
    <i>policy</i> para verificar si tiene permiso para usar IPSec con
d1173 1
a1173 1
    tambi&eacute;n debe cambiarla en el fichero <i>policy</i>, porque
d1175 3
a1177 2
    decidido que va a utilizar un fichero <i>policy</i> m&iacute;nimo,
    entonces puede especificar lo que quiera aqu&iacute;.
d1179 2
a1180 2
<li><b>Flags=</b> no se usa en la actualidad.  Los RFC dejan lugar para
    que se especifiquen opciones adicionales para la fase 1.
d1182 3
a1184 2
<p>Hay otros indicadores que permiten configurar otras opciones.  Lea
la p&aacute;gina de manual de
d1221 3
a1223 3
<li><b>Phase=2</b> es necesaria porque el c&oacute;digo de ISAKMPD usa
    las mismas funciones para autenticar las Fase 1 y la Fase 2.  Se
    requiere para que funcione la VPN.
d1225 2
a1226 2
<li><b>ISAKMPD-Peer=</b> es el nombre de la secci&oacute;n del
    anfitri&oacute;n.  Esto significa que estamos hablando con ese
d1231 3
a1233 3
<li><b>Configuration=</b> se refiere a la secci&oacute;n que describe
    las normativas que este anfitri&oacute;n y el extremo de la
    conexi&oacute;n en concreto deben cumplir.
d1235 2
a1236 2
<li><b>Local-ID=</b> se refiere a una secci&oacute;n IPSec-ID que
    describe su Red Privada a la pasarela del otro extremo de la
d1242 6
a1247 6
<li><b>Remote-ID=</b> hace referencia a una secci&oacute;n IPSec-ID que
    describe lo que se supone que la Red Privada remota es para nuestro
    anfitri&oacute;n.  Esta porci&oacute;n debe ser interpretada para
    la correcta configuraci&oacute;n de las tablas de enrutamiento que
    transferir&aacute;n datos desde nuestra Red Privada, a
    trav&eacute;s de la VPN, hacia la Red Privada remota.
d1249 4
a1252 3
<p>Hay otro indicador que tiene soporte aqu&iacute; llamado
<b>Flags=</b>.  Si necesita este indicador, lea la p&aacute;gina de
manual de
d1280 9
a1288 9
<b>configuraci&oacute;n</b> de cada anfitri&oacute;n.  Son las
secciones a las que se hace referencia en los identificadores
<b>Local-ID</b> y <b>Remote-ID</b>.  Describen las rutas que se deben
configurar para permitir el paso del tr&aacute;fico desde una red
privada hasta otra.  <b>ID-type</b>= puede ser <b>IPV4_ADDR_SUBNET</b>
o <b>IPV4_ADDR</b> (RFC2708 menciona m&aacute;s valores posibles.  En
la actualidad s&oacute;lo hay soporte en la implementaci&oacute;n de
OpenBSD para IPv4.  El soporte para IPv6 puede estar en
OpenBSD-current).
d1305 1
a1305 1
la variable <i>Configuration=</i>.  Como se puede ver aqu&iacute;,
d1307 16
a1322 15
variable <b>EXCHANGE_TYPE</b> est&aacute; configurada con el valor
<b>ID_PROT</b> para la fase 1, que identifica los protocolos que
cubrir&aacute; esta autenticaci&oacute;n.  <b>Transforms=</b> es la
transformaci&oacute;n criptogr&aacute;fica requerida (o asignada) para
este intercambio.  En este caso se&ntilde;ala a la secci&oacute;n de
abajo en el fichero de configuraci&oacute;n, que indica que estamos
recibiendo un paquete cifrado con 3DES y una suma de
comprobaci&oacute;n verificable con SHA.  Hay muchas transformaciones
criptogr&aacute;ficas definidas en el fichero de muestra
<b>VPN-east.conf</b>.  &Eacute;stas se proveen porque 3DES y SHA no
siempre tienen soporte en las diferentes plataformas.  Para OpenBSD no
hay raz&oacute;n para cambiar esta configuraci&oacute;n b&aacute;sica.
Si desea crear copias de esta secci&oacute;n y cambiar la variable
<b>Transforms</b>=, puede hacerlo.  El &uacute;nico requisito es que
cambie la variable <b>Configuration</b>=.
d1336 1
a1336 1
ella est&aacute; arriba en <i>Configuration</i>.  Note que la
d1338 9
a1346 9
anterior es que <b>EXCHANGE_TYPE</b> es <b>QUICK_MODE</b>.
<b>Suites=</b> se&ntilde;ala a una secci&oacute;n Suite de IPSec que
describe los distintos esquemas de cifrado disponibles entre los dos
anfitriones.  Se podr&iacute;a decir mucho m&aacute;s sobre ISAKMP e
IPSec, pero usando las descripciones b&aacute;sicas que hemos
mencionado deber&iacute;a ser capaz de crear una VPN simple pero
s&oacute;lida, que se cuidara de s&iacute; misma.  Esto es el
<i>m&iacute;nimo indispensable</i> de <b>isakmpd.conf</b> para ambos
anfitriones.
d1362 1
a1362 1
<b>ipsecadm flush</b>.
d1420 1
a1420 1
$ <b>/usr/sbin/certpatch -t fqdn -i home.mysite.se -k ca.key originalcert.crt nuevocert.crt</b>
d1756 2
a1757 2
El fichero <i>policy</i> puede ser algo confuso para alguien que no lo
haya usado con anterioridad, especialmente si las cosas no funcionan
d1764 2
a1765 2
El fichero <i>policy</i> m&aacute;s simple que es posible ser&iacute;a
uno que contuviera una &uacute;nica l&iacute;nea:
d1776 1
a1776 1
<i>policy</i> sobre qui&eacute;n puede conectar.  Por lo tanto, no es
d1780 1
a1780 1
tiene la autoridad total sobre <i>policy</i>.  Cualquier otro
d1786 1
a1786 1
est&aacute; autorizado.  El siguiente <i>policy</i> vendr&iacute;a a
d1791 1
a1791 1
el lector el cambiar este fichero <i>policy</i> para no permitir
d1856 1
a1856 1
Y ahora, a por lo que todos estaban esperando.  <i>policy</i>
d1861 1
a1861 1
fichero <i>policy</i>:
d1929 1
a1929 1
<i>policy</i>.  Sin embargo, se puede dar una sublicencia a tales
d1959 2
a1960 2
El fichero <i>policy</i> que hemos visto es un simple ejemplo de
fichero <i>policy</i> que delega en una CA.  Cualquier usuario que
d1963 1
a1963 1
<i>policy</i> y en el fichero de configuraci&oacute;n, estar&aacute;
d2081 1
a2081 1
Debemos hacer la comprobaci&oacute;n en <i>policy</i>, como esto:
d2111 2
a2112 1
alternativas, o sea, teniendo condiciones en <i>policy</i> como esta:
d2126 1
a2126 1
Con esta <i>policy</i> podr&iacute;an conectar tanto gw.worksite.se,
d2131 5
a2135 5
enteros introducidos en <i>policy</i>.  Reformatear los certificados en
el formato de <i>policy</i> requiere algo de esfuerzo, y hace que
<i>policy</i> sea poco legible.  Si alguien substituyera por error, un
certificado de usuario con el correspondiente certificado de CA en
alguna parte de un fichero <i>policy</i> complejo, podr&iacute;a
d2138 1
a2138 1
detectable leyendo el fichero <i>policy</i> (porque los certificados
d2145 1
a2145 1
Name&quot;) en lugar de un certificado en <i>policy</i> (por supuesto
d2148 1
a2148 1
encontrar).  Con este formato, el fichero <i>policy</i> anterior
d2175 1
a2175 1
$ <b>openssl x509 -text &lt; ca.crt</b>
d2180 3
a2182 3
Se pueden hacer configuraciones de <i>policy</i> m&aacute;s complicadas
pero esto es suficiente para empezar, y todav&iacute;a hay otro ejemplo
en la siguiente secci&oacute;n.
d2187 4
a2190 3
un fichero <i>policy</i> peque&ntilde;o o, por lo menos, uno razonable.
Sin embargo, todav&iacute;a no es suficiente si tenemos un sitio enorme
con muchos usuarios que deban tener permiso de conexi&oacute;n.
d2236 1
a2236 1
cualquier cosa.  Se podr&iacute;a escribir un fichero <i>policy</i>
d2280 1
a2280 1
fichero <i>policy</i> como &eacute;ste (cualquiera con un IP del
d2304 3
a2306 3
ser&iacute;a necesario cambiar los ficheros <i>policy</i> en todas las
m&aacute;quinas simplemente porque un empleado, por ejemplo, dejara el
trabajo.  El mismo esquema podr&iacute;a funcionar para
d2332 1
a2332 1
<tt>isakmpd</tt> es el d&aelig;mon de la gesti&oacute;n de claves de
d2385 1
a2385 1
Use <tt>tcpdump</tt> para buscar varias cosas.
d2411 1
a2411 1
vpn# <b>ping -c 3 208.1.1.1</b>
d2424 1
a2424 1
vpn# <b>tcpdump -ni fxp7 host 208.1.1.1</b>
d2431 1
a2431 1
<b>^C</b>
d2477 1
a2477 1
# <b>/sbin/isakmpd -d -DA=99</b>
d2488 1
a2488 1
# <b>/sbin/isakmpd -d -DA=99 -D1=70</b>
d2515 1
a2515 1
# <b>mkdir /kern; mount -t kernfs /kern /kern</b>
d2532 1
a2532 1
vpn% <b>netstat -rn -f encap</b>
d2550 2
a2551 2
    sistema con <tt>option ENCDEBUG</tt>.  A continuaci&oacute;n
    configure el sysctl <tt>net.inet.ip.encdebug</tt> con el valor 1.
d2597 1
a2597 1
Y en los RFC:
d2612 2
a2613 2
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2401.html">RFC 2401</a> - Security Architecture for the Internet Protocol (<b>IPSec</b>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2402.html">RFC 2402</a> - IP Authentication Header (<b>AH</b>)
d2617 1
a2617 1
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2406.html">RFC 2406</a> - IP Encapsulating Security Payload (<b>ESP</b>)
d2619 2
a2620 2
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2408.html">RFC 2408</a> - Internet Security Association and Key Management Protocol (<b>ISAKMP</b>)
<li><a href="http://www.cis.ohio-state.edu/htbin/rfc/rfc2409.html">RFC 2409</a> - The Internet Key Exchange (<b>IKE</b>)
d2642 2
a2643 2
Originally [OpenBSD: faq13.html,v 1.37 2000/12/26 16:17:40 ericj Exp ]<br>
$Translation: faq13.html,v 1.6 2000/12/26 21:12:09 horacio Exp $<br>
@


1.5
log
@
And another one.
@
text
@d936 1
a936 1
/etc/isakmpd.policy, y <i>VPN-east.conf</i> a
d2634 2
a2635 2
Originally [OpenBSD: faq13.html,v 1.36 2000/10/11 18:04:04 mickey Exp ]<br>
$Translation: faq13.html,v 1.5 2000/10/23 21:38:34 horacio Exp $<br>
@


1.4
log
@
Sync with Badlands Translation CVS. Work by es Horacio
@
text
@d31 1
a31 1
   <li><a href="http://www.secureops.com/resources/vpn/">ISAKMP Howto</a> por Patrick Ethier
d2634 2
a2635 2
Originally [OpenBSD: faq13.html,v 1.35 2000/07/25 00:07:53 chris Exp ]<br>
$Translation: faq13.html,v 1.4 2000/09/26 14:43:36 horacio Exp $<br>
@


1.3
log
@
Sync with Badlands Translation CVS. Work by Horacio.
@
text
@d18 3
a20 3
<a href="index.html">[Volver al &Iacute;ndice Principal]</a>
<a href="faq12.html">[Secci&oacute;n 12.0 - Para Usuarios Avanzados]</a>
<a href="faq14.html">[Secci&oacute;n 14.0 - Uso de Discos en OpenBSD]</a>
d515 2
a516 2
BLF       	Variable (160 bits recomendados)
CAST      	Variable (160 bits recommendados)
d2624 3
a2626 3
<a href="index.html">[Volver al &Iacute;ndice Principal]</a>
<a href="faq12.html">[Secci&oacute;n 12.0 - Para Usuarios Avanzados]</a>
<a href="faq14.html">[Secci&oacute;n 14.0 - Uso de Discos en OpenBSD]</a>
d2634 2
a2635 2
Originally [OpenBSD: faq13.html,v 1.34 2000/05/26 07:10:32 chris Exp ]<br>
$Translation: faq13.html,v 1.3 2000/06/01 20:22:10 horacio Exp $<br>
@


1.2
log
@Sync with Badlands Translation CVS. Work by Horacio.
@
text
@d18 1
a18 1
<a href="index.html">[Volver al Índice Principal]</a>
d39 4
a42 4
<li><a href="#13.1">13.1 - ¿Qu&eacute; es IPSec?</a>
<li><a href="#13.2">13.2 - Est&aacute; bien pero, ¿para qu&eacute;
    querr&iacute;a usar IPSec?</a>
<li><a href="#13.3">13.3 - ¿Cu&aacute;les son los protocolos
d46 10
a55 9
<li><a href="#13.6">13.6 - ¿C&oacute;mo configuro IPSec con el sistema
    de &laquo;claves manuales&raquo;?</a>
<li><a href="#13.7">13.7 - ¿C&oacute;mo configuro photurisd?</a>
<li><a href="#13.8">13.8 - ¿C&oacute;mo configuro isakmpd?</a>
<li><a href="#13.9">13.9 - ¿C&oacute;mo uso isakmpd con certificados 
    X.509?</a>
<li><a href="#13.10">13.10 - ¿Qu&eacute; clientes IKE son compatibles
    con isakmpd?</a>
<li><a href="#13.11">13.11 - Soluci&oacute;n de problemas de IPSec/VPN</a>
d61 1
a61 1
<h1>13.1 - ¿Qu&eacute; es IPSec?</h1>
d64 8
a71 10
IPSec es un grupo de extensiones de la familia del protocolo IP.
IPSec provee servicios criptogr&aacute;ficos de seguridad.
Estos servicios permiten la autenticaci&oacute;n, integridad, control de
acceso, y confidencialidad.
IPSec provee servicios similares a SSL, pero a nivel de redes, de un modo que
es completamente transparente para sus aplicaciones y mucho m&aacute;s
robusto.
Es transparente porque sus aplicaciones no necesitan tener ning&uacute;n
conocimiento de IPSec para poder usarlo.
Puede usar
d73 4
a76 5
sobre IPSec.
Puede crear t&uacute;neles cifrados (VPNs), o simple cifrado entre
computadoras (ordenadores).
Debido a que dispone de tantas opciones, IPSec es m&aacute;s bien complejo
(¡mucho m&aacute;s que SSL!).
d79 4
a82 4
Antes de empezar a usar IPSec, le recomendamos encarecidamente que mire la
&laquo;lectura recomendada&raquo; de la <a href="faq6.html">secci&oacute;n
6</a> de las preguntas frecuentes.
En particular, si todav&iacute;a no lo entiende, el documento
d87 2
a88 1
De un modo l&oacute;gico, IPSec funciona en cualquiera de estos tres modos:
d97 3
a99 2
est&aacute; impl&iacute;cito, como en Hu&eacute;sped-a-Enrutador (y este
enrutador controla y cifra el tr&aacute;fico para una <i>Red</i> particular).
d102 7
a108 8
Como puede ver, IPSec se puede usar como t&uacute;nel de tr&aacute;fico para
conexiones de &laquo;Redes Privadas Virtuales&raquo; (VPN, &quot;Virtual
Private Networks&quot;).
Sin embargo, su utilidad va m&aacute;s all&aacute; de las VPNs.
Con un registro central de &laquo;Intercambio de Claves de Internet&raquo;
(IKE, &quot;Internet Key Exchange&quot;), cada m&aacute;quina en internet
podr&iacute;a comunicarse con otra y usar cifrado y autenticaci&oacute;n
fuerte.
d112 1
a112 1
<h1>13.2 - Est&aacute; bien pero, ¿para qu&eacute;
d116 6
a121 7
El protocolo de internet, IP, tambi&eacute;n conocido como IPv4, no provee
por s&iacute; mismo de ninguna protecci&oacute;n a sus transferencias de
datos.
Ni siquiera puede garantizar que el remitente sea quien dice ser.
IPSec intenta remediarlo.
Estos servicios vienen tratados como dos servicios distintos, pero IPSec 
ofrece soporte para ambos de un modo uniforme.
d126 4
a129 4
Aseg&uacute;rese de que sea dif&iacute;cil para todos comprender qu&eacute; 
datos se han comunicado, excepto para el receptor.
No querr&aacute; que nadie vea sus contrase&ntilde;as cuando ingrese en una
m&aacute;quina remota a trav&eacute;s de Internet.
d134 5
a138 5
Garantice que los datos no puedan ser cambiados en el camino.
Si se encuentra en una l&iacute;nea que lleve datos sobre facturaci&oacute;n,
seguro que querr&aacute; estar seguro de que las cantidades y cifras de 
contabilidad son las correctas, y que no han podido ser alteradas durante el 
tr&aacute;nsito.
d143 3
a145 3
Firme sus datos de modo que otros puedan verificar que es realmente Vd. quien 
los envi&oacute;.
Es agradable saber que los documentos no son falsos.
d149 14
a162 14
Necesitamos modos para asegurarnos de que una transacci&oacute;n s&oacute;lo 
se puede llevar a cabo una vez, a menos que autoricemos que la repitan.
Nadie deber&iacute;a poder grabar una transacci&oacute;n, y luego replicarla
al pie de la letra, con el prop&oacute;sito que pareciera como si se
hubieran recibido m&uacute;ltiples transacciones del remitente original.
Imagine que el atacante deba conocer cu&aacute;l es el motivo del
tr&aacute;fico por medios distintos al de poder descifrarlo, y que el
tr&aacute;fico causara sucesos favorables para &eacute;l, como depositar
dinero en su cuenta.
Tendr&iacute;amos que asegurarnos que no pudiera replicar ese
tr&aacute;fico m&aacute;s tarde.
<i>AVISO: tal y como lo especifica la normativa, la protecci&oacute;n a la
r&eacute;plica no se llevar&aacute; a cabo cuando se use el sistema de claves
manuales de IPSec (v.g., cuando se est&eacute; usando
d167 2
a168 1
<h1>13.3 - ¿Cu&aacute;les son los protocolos detr&aacute;s de IPSec?</h1>
d171 6
a176 5
IPSec provee confidencialidad, integridad, autenticidad, y protecci&oacute;n
a la r&eacute;plica a trav&eacute;s de dos nuevos protocolos.
Estos protocolos se llaman &laquo;Cabecera de Autenticaci&oacute;n&raquo;
(AH, &quot;Authentication Header&quot;) y &laquo;Cargo de Seguridad
Encapsulado&raquo; (ESP, &quot;Encapsulated Security Payload&quot;).
d180 3
a182 3
r&eacute;plica (pero no confidencialidad).
Su principal diferencia con ESP es que AH tambi&eacute;n asegura partes de la
cabecera IP del paquete (como las direcciones de origen o destino).
d185 8
a192 9
ESP puede proveer autenticaci&oacute;n, integridad, protecci&oacute;n a la
r&eacute;plica, y confidencialidad de los datos (asegura todo lo que sigue a
la cabecera en el paquete).
La protecci&oacute;n a la r&eacute;plica requiere autenticaci&oacute;n e
integridad (&eacute;stas dos van siempre juntas).
La confidencialidad (cifrado) se puede usar con o sin autenticaci&oacute;n
y/o integridad.
Del mismo modo, puede usar la autenticaci&oacute;n y/o la integridad con o
sin la confidencialidad.
d202 5
a206 5
identificaci&oacute;n.
Los res&uacute;menes criptogr&aacute;ficos tambi&eacute;n pueden cubrir las
partes invariables de la misma cabecera de IP.
Hay varios RFCs diferentes que ofrecen una elecci&oacute;n de algoritmos para
AH, sin embargo todos deben seguir las l&iacute;neas especificadas en el
d211 4
a214 4
reescribir el cargo en modo cifrado.
La cabecera ESP no considera los campos de la cabecera IP que van delante, y
por lo tanto no garantiza nada excepto el cargo.
Los distintos tipos de ESP aplicables deben seguir conformar con el
d216 2
a217 2
Una cabecera ESP tambi&eacute;n puede proveer autenticaci&oacute;n para el
cargo (pero no la cabecera exterior).
d220 16
a235 15
Una divisi&oacute;n ortogonal (en su mayor parte) de funcionalidad de IPSec,
se aplica dependiendo de si el extremo que est&aacute; llevando a cabo la
encapsulaci&oacute;n IPSec es la fuente original de los datos o una pasarela:

<ul>
   <li>El modo <b>transporte</b> es el que usa un anfitri&oacute;n que genera
       los paquetes.
       En modo transporte, las cabeceras de seguridad se a&ntilde;aden antes
       que las cabeceras de la capa de transporte (v.g., TCP, UDP), antes de
       que la cabecera IP sea a&ntilde;adida al paquete.
       En otras palabras, un AH a&ntilde;adido al paquete cubrir&aacute; el
       resumen criptogr&aacute;fico de la cabecera TCP y algunos campos de la
       cabecera IP extremo-a-extremo, y una cabecera ESP cubrir&aacute; el
       cifrado de la cabecera TCP y los datos, pero no la cabecera IP
       extremo-a-extremo.</li>
d241 4
a244 4
       paquete, incluida la cabecera extremo-a-extremo, y se a&ntilde;ade una
       nueva cabecera IP al paquete que cubre s&oacute;lo el salto al otro
       extremo de la conexi&oacute;n segura (aunque eso puedan ser varios
       saltos de distancia).</li>
d248 12
a259 14
Los enlaces seguros de IPSec se definen en t&eacute;rminos de 
&laquo;Asociaciones de Seguridad&raquo; (<b>SA</b>s).
Cada SA viene definida por un &uacute;nico flujo unidireccional de datos, y
por regla general (ignorando multicast) desde un &uacute;nico punto hasta
otro, cubriendo el tr&aacute;fico que se distingue por alg&uacute;n
&laquo;selector &uacute;nico&raquo;.
Todo el flujo de tr&aacute;fico sobre un &uacute;nico SA se trata del mismo
modo.
Algo del tr&aacute;fico puede estar sujeto a varios SAs, cada uno de los
cuales aplica alg&uacute;n tipo de transformaci&oacute;n
criptogr&aacute;fica.
Un grupo de SAs se conoce como un &laquo;Haz&raquo; (&quot;SA Bundle&quot;).
Los paquetes entrantes se pueden asignar a un SA particular por medio de los
tres campos de definici&oacute;n:
d270 7
a276 7
SPI se puede considerar como un &quot;cookie&quot; manejado por el receptor
del SA, cuando se negocian los par&aacute;metros de la conexi&oacute;n.
El protocolo de seguridad debe ser AH o ESP.
Debido a que la direcci&oacute;n IP del receptor es parte del tr&iacute;o,
&eacute;sta es un valor &uacute;nico garantizado.
Se pueden encontrar desde la cabecera IP exterior y la primera cabecera de
seguridad (que contiene el SPI y el protocolo de seguridad).
d306 3
a308 2
Debido a que una cabecera ESP no puede autenticar la cabecera IP exterior, es
&uacute;til combinar una cabecera AH y una ESP para obtener lo siguiente:
d338 8
a345 9
Sin embargo, no se menciona en el RFC.
Como ocurre con la adyacencia de Transporte, esto autenticar&iacute;a todo el
paquete excepto unas cuantas cabeceras de la cabecera IP, y tambi&eacute;n
cifrar&iacute;a la carga (en el ejemplo, en bastardilla).
Cuando una cabecera AH y una ESP se aplican juntas directamente como en este
caso, el orden de las cabeceras deber&iacute;a ser como el que se ha
mostrado.
En modo t&uacute;nel es posible hacer encapsulaci&oacute;n recursiva
arbitraria para que no se especifique el orden.
d351 31
a381 31
La forma en la que se configuran los sistemas IPSec y las pasarelas es, hasta
un cierto punto, trabajo del diseñador;  sin embargo, el RFC contiene algunas
recomendaciones importantes sobre c&oacute;mo se deber&iacute;a implementar
para evitar al m&aacute;ximo la confusi&oacute;n.

<p>
Existen dos entidades administrativas que controlan lo que le ocurre a un
paquete.
Una es la &laquo;Base de Datos de Asociaci&oacute;n de la Seguridad&raquo;
(SAD, &quot;Security Association Database&quot;, llamado TDB o tabla TDB en
el c&oacute;digo fuente de IPSec de OpenBSD), y el otro es la &laquo;Base de
Datos de Pol&iacute;tica de la Seguridad&raquo; (SPD, &quot;Security Policy
Database&quot;).

<p>
Las dos se parecen en que, dado un n&uacute;mero de selectores que describan
algo de tr&aacute;fico, entregar&aacute;n una entrada que describa el proceso
necesario.
Sin embargo, SPD se elimina a dos pasos del proceso:  SPD se usa para
paquetes salientes, para decidir qu&eacute; entradas SAD se deben usar, y
qu&eacute; entradas SAD describen el proceso y sus par&aacute;metros.
Las entradas SPD especifican las entradas SAD existentes a usar (si es un
&laquo;haz&raquo; puede haber m&aacute;s de una), pero si no hay una que se
pueda usar, entonces se usa para crear otras nuevas.
Los campos de SA que se crean se pueden tomar de la entrada SPD o del paquete
que inici&oacute; la creaci&oacute;n.

<p>
Los paquetes salientes van desde la entrada SPD a la especificada de SA, para
obtener par&aacute;metros de codificaci&oacute;n.
Los paquetes entrantes obtienen la SA correcta directamente, usando el
d385 6
a390 6
SPD tambi&eacute;n puede especificar qu&eacute; tr&aacute;fico deber&iacute;a
circunvalar IPSec, y cu&aacute;l se deber&iacute;a dejar caer, as&iacute; que
tambi&eacute;n debe ser consultado para tr&aacute;fico no IPSec entrante.
Las entradas SPD se deben ordenar de forma expl&iacute;cita, ya que varias
podr&iacute;an coincidir con un paquete particular, y el proceso debe ser
reproducible.
d393 5
a397 5
Se puede pensar en SPD como algo parecido a un filtro de paquetes, en el que
las acciones que se deciden son la activaci&oacute;n de procesos SA.
Los selectores pueden incluir direcciones de origen y destino, n&uacute;meros 
de puertos si fueran relevantes, nombres de anfitriones, niveles de
sensibilidad de seguridad, protocolos, etc...
d425 7
a431 8

Cada SA puede definir una cabecera ESP y una cabecera AH.
Una sesi&oacute;n de IPSec debe tener una de las dos o ambas, pero no se puede
definir sin ninguna de las dos (en caso contrario no habr&iacute;a cabeceras
para especificar el SPI que deba buscar la SA).
El RFC no dice qu&eacute; suceder&iacute;a si las cabeceras AH y ESP 
estuvieran en desacuerdo sobre el valor de SPI.
Se puede pensar que esto implicar&iacute;a m&uacute;ltiples SAs en un haz.
d435 3
a437 3
flow</tt> (s&oacute;lo se cambiar&iacute;a si estuviera usando el sistema de
claves manual).
Las entradas de SAD se pueden configurar manualmente con
d439 3
a441 4
sin embargo el IETF tambi&eacute;n ha definido mecanismos autom&aacute;ticos
para la iniciaci&oacute;n de sesiones y otras cosas como el intercambio de
claves.
OpenBSD implementa Photuris 
d454 1
a454 1
<h1>13.6 - ¿C&oacute;mo configuro IPSec con el sistema de 
d458 3
a460 4
El sistema de claves manuales es el m&aacute;s sencillo para empezar con
IPSec.
Con este m&eacute;todo puede activar los sistemas criptogr&aacute;ficos de 
cifrado entre redes y crear VPNs.
d466 5
a470 5
Para empezar debe activar las opciones IP AH e IP ESP en el n&uacute;cleo del
sistema de OpenBSD (si s&oacute;lo est&aacute; usando ESP, como con el
gui&oacute;n rc.vpn, entonce <i>no necesita activar AH</i>;  de hecho, puede
haber problemas relacionados con la seguridad activando AH si no lo
est&aacute; usando).
d484 5
a488 5
Puede editar <tt>/etc/sysctl.conf</tt> para activarlos durante el arranque.
Para ello borre la marca de comentario # que ver&aacute; delante de la
l&iacute;nea net.inet.esp.enable y/o net.inet.ah.enable (dependiendo de
cu&aacute;l vaya a usar) y aseg&uacute;rese de que est&eacute;n configuradas
con el valor 1.
d491 2
a492 2
Tambi&eacute;n tendr&aacute; que generar sus claves manuales.
Como la seguridad del VPN se basa en que estas claves no se puedan
d494 2
a495 2
fuente aleatoria fuerte.
Un m&eacute;todo pr&aacute;ctico de generarlas es usar el dispositivo
d505 3
a507 3
El n&uacute;mero de bits producidos es importante.
Tipos de cifrado diferentes pueden requerir claves de tama&ntilde;os 
tambi&eacute;n diferentes.
d521 6
a526 6
Ahora tiene que configurar las SAs (&laquo;Asociaciones de Seguridad&raquo;).
Una SA es una combinaci&oacute;n de sus direcciones IP, un SPI, y su
protocolo de seguridad (AH y/o ESP).
Las direcciones IP son la suya y la de su destino.
El SPI (&laquo;&Iacute;ndice del Par&aacute;metro de Seguridad&raquo;) es un
n&uacute;mero que OpenBSD usa para clasificar distintas SAs.
d529 6
a534 6
<i>En estos ejemplos s&oacute;lo se usa ESP para cifrar su tr&aacute;fico.
ESP incluye la autenticaci&oacute;n de los datos cifrados contenidos, pero no
autentica la cabecera IP a su alrededor.
Esta &laquo;autenticaci&oacute;n limitada&raquo; es, sin embargo, suficiente
para la mayor&iacute;a de casos, especialmente para ESP en un entorno de
t&uacute;neles.</i>
d544 2
a545 2
Llev&eacute;moslo a la pr&aacute;ctica con dos enrutadores, 192.168.5.1 y
192.168.25.9.
d568 3
a570 3
N&oacute;tese que los SPI son distintos.
Vea la secci&oacute;n <a href="#13.4">Sobre el formato &quot;wire&quot;</a>
para una descripci&oacute;n completa sobre qu&eacute; es el SPI y sobre
d574 2
a575 2
Ahora que ya tiene sus Asociaciones de Seguridad en su sitio, configure sus
flujos.
d582 4
a585 3
direcci&oacute;n de origen local, que cubrir&aacute; todos los paquetes que
originen del anfitri&oacute;n local hacia el destino, y el otro ser&aacute; 
el flujo de vuelta desde el destino hasta el anfitri&oacute;n local.
d604 8
a611 8
Si no necesita tanta carga en sus VPN Hu&eacute;sped-a-Hu&eacute;sped puede
crear el SPI sin <tt>-forcetunnel</tt>, lo que le permitir&aacute; usar el
modo de transporte (mientras que <tt>-forcetunnel</tt> asegura que todo en el
paquete IP, incluida la cabecera IP, sea encapsulado por SPI).
Si el origen o el destino es una red, tendr&aacute; que usar el modo de
t&uacute;nel.
Crear una SA hacia o desde una red le asegurar&aacute; autom&aacute;ticamente
que se est&eacute;n creando los SPI en modo t&uacute;nel.
d617 6
a622 6
Puede usar IPSec para pasar los espacios de direcciones IP privados por 
t&uacute;neles en Internet.
He aqu&iacute; un buen ejemplo:  Queremos pasar 192.168.99.0/24 (que se
encuentra detr&aacute;s de 208.1.1.1) por t&uacute;neles a 208.1.2.0/24 y
208.1.5.0/24 (que est&aacute;n detr&aacute;s de 208.2.2.2).
Estos ejemplos se han generado usando el gui&oacute;n
d626 3
a628 4
Como puede ver, cuando est&aacute; usando el sistema de claves manuales con
IPSec tiene que especificar <b>con exactitud</b> lo que quiere hacer.
No lo adivinar&aacute; por usted.
Mire estos ejemplos:
d646 2
a647 1
A continuaci&oacute;n configure un flujo desde 208.1.1.1 hasta 208.2.2.2
d721 2
a722 2
Ahora, &eacute;sta es la parte al inverso...
Configure un flujo desde el enrutador 208.2.2.2 hasta el 208.1.1.1
d751 2
a752 2
Configure un flujo desde 192.169.99.0/24 (que est&aacute; detr&aacute;s de
208.1.1.1) hasta el enrutador 208.2.2.2
d761 3
a763 3
Ya casi hemos terminado...
Quedan dos flujos para obtener 208.1.2.0/24 y 208.1.5.0/24 desde el enrutador
208.2.2.2 hasta el enrutador 208.1.1.1
d775 2
a776 2
Si ha usado ipsecadm, y quiere librarse de cualquier trabajo que haya hecho y
empezar desde cero, haga
d784 2
a785 2
Esto limpiará toda la informaci&oacute;n de IPSec (SPIs, flujos, entradas de
enrutamiento) de su sistema.
d792 3
a794 3
El uso de photuris no est&aacute; tan extendido y por lo que concierne al
estado del RFC, se considera experimental.
Sin embargo, muchas personas lo han usado con OpenBSD.
d797 2
a798 2
Para configurar photurisd, primero edite /etc/photuris/secrets.conf en cada
anfitri&oacute;n con photurisd.
d815 8
a822 9
elecci&oacute;n en el fichero de configuraci&oacute;n local, y otra clave de
su elecci&oacute;n en el fichero de configuraci&oacute;n remota (use la misma
configuraci&oacute;n en su m&aacute;quina remota pero cambie el lugar de
&quot;local&quot; por el de &quot;remote&quot;, y viceversa, para que se vea 
a s&iacute; misma como
la clave local).
Note que estas claves ser&aacute;n substituidas en una versi&oacute;n futura
de photurisd que llevar&aacute; a cabo su intercambio inicial de claves con
claves p&uacute;blicas.
d825 2
a826 2
Aseg&uacute;rese de que <tt>net.inet.ah.enable</tt> est&aacute; configurado
al valor 1.
d843 3
a845 3
Ahora ejecute tcpdump para verificar que sus paquetes est&eacute;n siendo
cifrados con AH (ejecute ping en otra ventana o sesi&oacute;n para generar
tr&aacute;fico).
d867 1
a867 1
<h1>13.8 - ¿C&oacute;mo configuro isakmpd?</h1>
d870 4
a873 5
Si est&aacute; pensando en VPNs u otras aplicaciones tradicionales de IPSec,
probablemente vaya a usar ISAKMP.
Algunas implementaciones comerciales de IPSec no proveen ning&uacute;n tipo
de sistema de claves manual, y en su lugar requieren que use alg&uacute;n
tipo de ISAKMP.
d876 1
a876 1
<h3>13.8.1 - ¿Qu&eacute; es isakmpd?</h3>
d879 5
a883 6
Internet&raquo; (IKE, &quot;Internet Key Exchange&quot;) es el mecanismo de
intercambio para la VPN.
ISAKMP aborda los problemas de seguridad usando los m&eacute;todos
mencionados en los RFC 2407, 2408 y 2409.
ISAKMP gestiona el intercambio de claves criptogr&aacute;ficas que
normalmente tendr&iacute;a que gestionar usted con
d889 30
a918 35
<b>Fase 1</b> - Los dos extremos de conexiones ISAKMP establecen un canal
seguro, autenticado, sobre el cual se comunican entre dos d&aelig;mos.
&Eacute;sto establece una Asociaci&oacute;n de Seguridad (SA) entre ambos
anfitriones.
Los m&eacute;todos usados para establecer este canal son el <b>Modo
Principal</b> y el <b>Modo Agresivo</b>.
El Modo Principal env&iacute;a la variada informaci&oacute;n sobre
autenticaci&oacute;n en una cierta secuencia, al tiempo que provee
protecci&oacute;n para la identidad.
El Modo Agresivo no provee esta protecci&oacute;n a la identidad porque toda
la informaci&oacute;n sobre la autenticaci&oacute;n se env&iacute;a al mismo
tiempo.
El modo agresivo s&oacute;lo se deber&iacute;a usar en casos en los que
preocupe el ancho de banda de la red.

<p>
<b>Fase 2</b> - Las Asociaciones de Seguridad se negocian en nombre de IPSec.
La fase 2 establece t&uacute;neles o SAs t&eacute;rminos entre
anfitriones IPSec.
El <b>Modo R&aacute;pido</b> se usa en la fase 2 porque no es necesario
repetir una autenticaci&oacute;n total debido a que la fase 1 ya ha
establecido las SA.

<p>
Resumiendo, la fase 1 se usa para obtener un canal seguro en el que llevar a
cabo las configuraciones (m&aacute;s r&aacute;pidas) de la fase 2.
Puede haber m&uacute;ltiples configuraciones de la fase 2 en el mismo canal
que la fase 1.
La fase 2 se usa para configurar los t&uacute;neles.
En la fase 1, sus nodos de IPSec establecen una conexi&oacute;n en la que
intercambian autenticaci&oacute;n (bien sea un certificado X509 &oacute; un
secreto precompartido).
Esto permite que cada extremo se asegure de que el otro extremo sea
autenticado.
La fase 2 es un intercambio de claves que determinan c&oacute;mo se cifran
d922 1
a922 1
<h3>13.8.2 - ¿C&oacute;mo empiezo con isakmpd?</h3>
d926 2
a927 2
definici&oacute;n, pero no con los ficheros de muestra.
Para obtenerlos necesita bajarse /usr/src/sbin/isakmpd/samples/VPN-east.conf
d934 8
a941 8
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/sbin/isakmpd/samples/policy">policy</a> disponibles).
Para este ejemplo, copie <i>policy</i> a /etc/isakmpd.policy, y
<i>VPN-east.conf</i> a /etc/isakmpd/isakmpd.conf.
Intentaremos mostrarle c&oacute;mo configurar una VPN (t&uacute;nel).
Si desea usar isakmpd entre anfitriones &uacute;nicos, hay otros
ficheros de configuraci&oacute;n en el directorio <i>samples</i>.
Las p&aacute;ginas de manual contienen informaci&oacute;n detallada.
No se olvide de
d946 6
a951 7
Su primer paso es activar ESP.
Al <a href="#13.6" target="_blank">principio de la secci&oacute;n 13.6</a> se
explica c&oacute;mo hacerlo, tanto durante el arranque como con el sistema
funcionando.
Despu&eacute;s debe editar /etc/isakmpd.policy.
Este fichero indica a ISAKMP qui&eacute;n puede acceder a IPSec.
En este ejemplo, el fichero <i>policy</i> indica que cualquiera que
d955 6
a960 7
Puede modificar este fichero para indicar a ISAKMP que s&oacute;lo quiere
permitir datos firmados con ciertos certificados digitales o usando una
cierta transformaci&oacute;n de cifrado.
Tambi&eacute;n puede permitir el acceso a IPSec a cualquiera.
Esto s&oacute;lo es recomendable para pruebas.
Para ello, edite su fichero <i>policy</i> para que contenga s&oacute;lo las
siguientes l&iacute;neas:
d971 3
a973 3
El mismo fichero <i>policy</i> contiene dos l&iacute;neas que empiezan con el
car&aacute;cter $.
Debe eliminar esas l&iacute;neas antes de usarlo, son s&oacute;lo para cvs.
d992 4
a995 4
b&aacute;sica que use ESP.
En el anfitri&oacute;n A, edite /etc/isakmpd/isakmpd.conf.
La direcci&oacute;n IP de muestra 249.2.2.2, debe ser reemplazada con la
direcci&oacute;n IP externa del anfitri&oacute;n A.
d1007 1
a1007 1
249.3.3.3 representa la direcci&oacute;n IP externa para el 
d1020 9
a1028 9
Aqu&iacute; es donde puede configurar las variables que afectar&aacute;n al
comportamiento principal de isakmpd.
El uso de los predefinidos aqu&iacute; es correcto.
El valor <b>Listen-on</b>= especifica el IP en el que isakmpd debe estar a la
escucha.
S&oacute;lo es necesario el IP de Internet de su pasarela.
Si tiene interfaces m&uacute;ltiples externas en su pasarela, podr&iacute;a
especificar una lista de las interfaces en las que quiere que est&eacute; a 
la escucha, introduci&eacute;ndolas, separadas por comas, en una lista.
d1031 2
a1032 1
A continuaci&oacute;n, en el anfitri&oacute;n A, edite isakmpd.conf otra vez:
d1051 7
a1057 7
Esta secci&oacute;n describe qu&eacute; direcciones IP se deben aceptar para
negociar la conexi&oacute;n de la fase 1.
Su valor se&ntilde;ala a la secci&oacute;n de m&aacute;s abajo (recuerde que
la fase 1 s&oacute;lo autentica la conexi&oacute;n remota para asegurar que
sean quienes afirman ser).
Puede dar una lista de m&uacute;ltiples direcciones con l&iacute;neas
adicionales en el formato IP_Address=<i> &lt;PEER-NAME&gt;.</i>.
d1079 3
a1081 3
Esto describe la fase 2 de la conexi&oacute;n.
&Eacute;sta es la fase que determina qu&eacute; protocolos usar&aacute;n las
dos partes para comunicarse.
d1084 6
a1089 7
El indicador <b>Connections</b>= se refiere a la secci&oacute;n de m&aacute;s
abajo.
Inicia los requisitos o los m&eacute;todos aceptados para activar la fase 2.
Tambi&eacute;n le indica a ISAKMPD qu&eacute; conexiones debe iniciar una vez
haya comenzado.
Puede tener secciones m&uacute;ltiples, como se ilustra abajo, si va a
conectar con m&uacute;ltiples anfitriones.
d1093 4
a1096 4
especificar un <b>Default</b>= que se&ntilde;ale a una secci&oacute;n que
describa una entrada gen&eacute;rica que servir&aacute; de referencia para
cualquier IP entrante que no est&eacute; en la lista del indicador
<b>Connections</b>=.
d1130 4
a1133 5
secci&oacute;n anterior sobre la fase 1.
Cada una de ellas describe los requisitos que debe cumplir la pasarela del
extremo que intenta conectar, para proceder a la fase 2.
Aqu&iacute; hay muchas otras opciones, pero las que se mencionan son los
requisitos m&iacute;nimos.
d1136 3
a1138 3
<li><b>Fase=1</b> se requiere porque el c&oacute;digo ISAKMPD usa los mismos
    procedimientos para procesar Fase 1 y Fase 2.
    Debe ser <b>1</b> o no funcionar&aacute; nada.
d1141 5
a1145 6
    anfitriones que vayan a conectar.
    Se sugiere que aqu&iacute; se use UDP, as&iacute; que lo dejaremos en
    este punto.
    Algunos anfitriones que vayan a conectar pueden estar detr&aacute;s
    de un cortafuegos que no permita pasar tr&aacute;fico UDP.
    Esto debe ser determinado antes de activarlo.
d1148 2
a1149 3
    se&ntilde;alan los paquetes entrantes.
    En algunos casos, puede estar escuchando conexiones para Fase 1 en
    distintas interfaces.
d1151 2
a1152 2
    &eacute;ste es el IP de la interfaz de escucha en este extremo de la
    conexi&oacute;n.
d1154 5
a1158 5
<li><b>Address=</b> es la direcci&oacute;n que se&ntilde;ala al origen IP de
    los paquetes entrantes.
    Generalmente esto se&ntilde;ala a la pasarela del extremo conectado.
    Esto necesita ser explicado en m&aacute;s detalle, porque la
    direcci&oacute;n IP de origen del otro extremo puede ser desconocida.
d1162 2
a1163 2
    Aqu&iacute; usamos la secci&oacute;n predefinida, especificada en el
    fichero de muestra.
d1165 9
a1173 10
<li><b>Authentication=</b> es el secreto precompartido que va a usar este 
    extremo de la conexi&oacute;n en particular.
    Es, m&aacute;s o menos, una contrase&ntilde;a que usa cada extremo de la
    conexi&oacute;n.
    Esta contrase&ntilde;a se pasa al fichero <i>policy</i> para verificar si
    tiene permiso para usar IPSec con este anfitri&oacute;n.
    Si cambia esta contrase&ntilde;a, tambi&eacute;n debe cambiarla en el
    fichero <i>policy</i>, porque el fichero de muestra contiene una
    contrase&ntilde;a.
    Si ha decidido que va a utilizar un fichero <i>policy</i> m&iacute;nimo,
d1176 2
a1177 3
<li><b>Flags=</b> no se usa en la actualidad.
    Los RFC dejan lugar para que se especifiquen opciones adicionales para la
    fase 1.
d1179 2
a1180 2
<p>Hay otros indicadores que permiten configurar otras opciones.
Lea la p&aacute;gina de manual de
d1212 25
a1236 25
secci&oacute;n anterior sobre la fase 2.
Son las configuraciones individuales que ISAKMPD debe usar para hablar entre
las dos pasarelas de la conexi&oacute;n.

<ul>
<li><b>Phase=2</b> es necesaria porque el c&oacute;digo de ISAKMPD usa las
    mismas funciones para autenticar las Fase 1 y la Fase 2.
    Se requiere para que funcione la VPN.

<li><b>ISAKMPD-Peer=</b> es el nombre de la secci&oacute;n del 
    anfitri&oacute;n.
    Esto significa que estamos hablando con ese extremo de la conexi&oacute;n
    en particular para establecer una conexi&oacute;n de Fase 2.
    Se provee para que pueda tener secciones m&uacute;ltiples que describan
    conexiones isakmp.

<li><b>Configuration=</b> se refiere a la secci&oacute;n que describe las
    normativas que este anfitri&oacute;n y el extremo de la conexi&oacute;n 
    en concreto deben cumplir.

<li><b>Local-ID=</b> se refiere a una secci&oacute;n IPSec-ID que describe su
    Red Privada a la pasarela del otro extremo de la conexi&oacute;n.
    &Eacute;sta es la porci&oacute;n que se pasa para que la otra pasarela
    pueda configurar la tabla de enrutamiento concreta, que
    transferir&aacute; datos a trav&eacute;s de la VPN a nuestra red.
d1238 1
a1238 1
<li><b>Remote-ID=</b> hace referencia a una secci&oacute;n IPSec-ID que 
d1240 8
a1247 8
    anfitri&oacute;n.
    Esta porci&oacute;n debe ser interpretada para la correcta
    configuraci&oacute;n de las tablas de enrutamiento que
    transferir&aacute;n datos desde nuestra Red Privada, a trav&eacute;s de
    la VPN, hacia la Red Privada remota.

<p>Hay otro indicador que tiene soporte aqu&iacute; llamado <b>Flags=</b>.
Si necesita este indicador, lea la p&aacute;gina de manual de
d1252 6
a1257 6
&Eacute;sta es la secci&oacute;n de IPSec-ID.
Estas entradas deben existir en los ficheros isakmpd.conf del
anfitri&oacute;n A y del anfitri&oacute;n B.
Este ejemplo configurar&aacute; 192.168.1.0/255.255.255.0 para el
anfitri&oacute;n A (que se conect&oacute; arriba a Net-A) y
192.168.20.0/255.255.255.0 para el anfitri&oacute;n B (arriba Net-B).
d1274 10
a1283 10
Estas dos secciones est&aacute;n en el fichero de <b>configuraci&oacute;n</b>
de cada anfitri&oacute;n.
Son las secciones a las que se hace referencia en los identificadores
<b>Local-ID</b> y <b>Remote-ID</b>.
Describen las rutas que se deben configurar para permitir el paso del
tr&aacute;fico desde una red privada hasta otra.
<b>ID-type</b>= puede ser <b>IPV4_ADDR_SUBNET</b> o <b>IPV4_ADDR</b> (RFC2708
menciona m&aacute;s valores posibles.  En la actualidad s&oacute;lo hay
soporte en la implementaci&oacute;n de OpenBSD para IPv4.  El soporte para
IPv6 puede estar en OpenBSD-current).
d1299 4
a1302 5
cifrado de las conexiones de la fase 1.
El nombre refleja el valor de la variable <i>Configuration=</i>.
Como se puede ver aqu&iacute;, estamos indicando nuestro Dominio de
Inter&eacute;s, que es IPSec.
La variable <b>EXCHANGE_TYPE</b> est&aacute; configurada con el valor
d1304 10
a1313 12
cubrir&aacute; esta autenticaci&oacute;n.
<b>Transforms=</b> es la transformaci&oacute;n criptogr&aacute;fica requerida 
(o asignada) para este intercambio.
En este caso se&ntilde;ala a la secci&oacute;n de abajo en el fichero de
configuraci&oacute;n, que indica que estamos recibiendo un paquete cifrado
con 3DES y una suma de comprobaci&oacute;n verificable con SHA.
Hay muchas transformaciones criptogr&aacute;ficas definidas en el fichero de 
muestra <b>VPN-east.conf</b>.
&Eacute;stas se proveen porque 3DES y SHA no siempre tienen soporte en las
diferentes plataformas.
Para OpenBSD no hay raz&oacute;n para cambiar esta configuraci&oacute;n
b&aacute;sica.
d1315 2
a1316 2
<b>Transforms</b>=, puede hacerlo.
El &uacute;nico requisito es que cambie la variable <b>Configuration</b>=.
d1328 4
a1331 4
Esta secci&oacute;n describe los requisitos para el cifrado de los datos que
se env&iacute;an a trav&eacute;s de la VPN, y la referencia a ella est&aacute;
arriba en <i>Configuration</i>.
Note que la diferencia entre esta secci&oacute;n y su equivalente en la fase 1
d1333 8
a1340 7
<b>Suites=</b> se&ntilde;ala a una secci&oacute;n Suite de IPSec que describe
los distintos esquemas de cifrado disponibles entre los dos anfitriones.
Se podr&iacute;a decir mucho m&aacute;s sobre ISAKMP e IPSec, pero usando las
descripciones b&aacute;sicas que hemos mencionado deber&iacute;a ser capaz de
crear una VPN simple pero s&oacute;lida, que se cuidara de s&iacute; misma.
Esto es el <i>m&iacute;nimo indispensable</i> de <b>isakmpd.conf</b> para
ambos anfitriones.
d1352 5
a1356 6
la primera vez que decida invocar este d&aelig;mon.
El d&aelig;mon no funcionar&aacute; en modo d&aelig;mon, sino como un proceso
regular.
Grabar&aacute; todo en su terminal.
Para parar isakmpd y limpiar las rutas, tiene que matar el proceso isakmpd en
cada modo, y ejecutar <b>ipsecadm flush</b>.
d1360 1
a1360 1
<h1>13.9 - ¿C&oacute;mo uso isakmpd con certificados X.509?</h1>
d1364 5
a1368 5
precompartidas no es mucho m&aacute;s dif&iacute;cil en una gran red con
muchas conexiones entrantes no fiables de lo que ser&iacute;a en una
peque&ntilde;a red.
En realidad puede simplificar la configuraci&oacute;n, y m&aacute;s
importante, la gesti&oacute;n de claves.
d1377 4
a1380 4
del directorio de fuentes de isakmpd.
Debe tener una clave CA, el correspondiente certificado CA X.509, una clave
privada para cada m&aacute;quina en la red que use isakmpd, y un certificado
X.509 para cada una de esas claves.
d1383 9
a1391 9
Los certificados X.509 necesitan tener una extensi&oacute;n de &laquo;Asunto 
Nombre Alternativo&raquo; (SubjectAltName), que describa al poseedor del
certificado.
C&oacute;mo configurar una extensi&oacute;n SubjectAltName usando certpatch
para un certificado, tambi&eacute;n se describe en README.PKI para el caso de
configuraci&oacute;n de una direcci&oacute;n IP como la extensi&oacute;n
SubjectAltName.
Aqu&iacute;, el uso de una direcci&oacute;n IP tambi&eacute;n es el
comportamiento por definici&oacute;n de isakmpd.
d1395 4
a1398 4
Dominio Totalmente Cualificados&raquo; (FQDN, &quot;Fully Qualified Domain
Name&quot;) o UFQDN (FQDN de Usuario).
Un ejemplo de un FQDN ser&iacute;a <tt>www.openbsd.org</tt>, y un ejemplo de
un UFQDN ser&iacute;a una direcci&oacute;n de correo electr&oacute;nico, como
d1402 3
a1404 3
En este documento usar&eacute; FQDNs como SubjectAltNames.
El uso de direcciones IP deber&iacute;a ser algo m&aacute;s f&aacute;cil, ya
que es el comportamiento por definici&oacute;n de isakmpd pero no es muy
d1408 2
a1409 2
Para introducir un SubjectAltName FQDN en un certificado, har&iacute;amos
algo como esto:
d1420 6
a1425 6
Certificaci&oacute;n&raquo; (CA), por lo tanto esto s&oacute;lo
lo puede hacer quien tenga acceso a la clave privada del CA.
home.mysite.se es el FQDN que se introduce en el certificado.
Los nombres de los ficheros originalcert.crt y nuevocert.crt podr&iacute;an
tener el mismo nombre, en cuyo caso el fichero original ser&iacute;a anulado
por el certificado modificado nuevo.
d1428 4
a1431 4
Ponga las claves y certificados en los directorios tal y como se describe al
final de README.PKI.
Si se van a usar las clave de una forma seria, la clave CA (ca.key) se debe 
guardar en alg&uacute;n sitio seguro.
d1437 3
a1439 2
Ahora veamos el fichero de configuraci&oacute;n /etc/isakmpd/isakmpd.conf.
Originalmente se tom&oacute; del fichero de ejemplo en
d1441 9
a1449 9
pero se ha modificado mucho.
Tambi&eacute;n usar&eacute; un fichero mucho m&aacute;s corto que en el
fichero de ejemplo en la p&aacute;gina de manual.
He eliminado de ese fichero la mayor&iacute;a de las partes no necesarias 
para esta configuraci&oacute;n.
En parte para simplificar la comprensi&oacute;n de esta configuraci&oacute;n.
Tambi&eacute;n he a&ntilde;adido algunos comentarios (algunos comentarios los
he dejado como estaban en isakmpd.conf(5)), y he cambiado algunos nombres.
Ninguno de los nombres de dominio aqu&iacute; usados existen (que yo sepa).
d1453 4
a1456 4
configuraci&oacute;n que funcione del caso de claves precompartidas (ver la
secci&oacute;n anterior), no habr&aacute; muchas sorpresas en este fichero.
No lo explicar&eacute; en detalle, mire isakmpd.conf(5) para descripciones de
las partes que no comente.
d1474 6
a1479 6
O sea, dos redes que deben conectarse usando un t&uacute;nel IPSec sobre una
red de otro modo insegura.
Ignore el hecho de que aqu&iacute; est&eacute; usando direcciones IP 
reservadas para Internets privadas (RFC1918), debo usar algo.
No explicar&eacute; c&oacute;mo usar isakmpd en combinaci&oacute;n con NAT ni
nada parecido (ya que no lo he probado).
d1482 2
a1483 2
Ahora, veamos el fichero de configuraci&oacute;n.
&Eacute;ste es el fichero para la pasarela de seguridad gw.mysite.se:
d1503 5
a1507 5
# anfitri&oacute;n ni el nombre de dominio del extremo de la conexi&oacute;n
# (pero podr&iacute;a serlo).  Fase 1, como ya sabr&aacute;, es la
# negociaci&oacute;n de una asociaci&oacute;n de seguridad ISAKMP (SA).
# Deber&iacute;a haber un IP y un nombre por cada extremo con el que queramos
# comunicarnos.
d1513 8
a1520 7
# aqu&iacute; el nombre es un nombre de secci&oacute;n que se usar&aacute;
# m&aacute;s tarde.  Puede ser una lista de nombres de secci&oacute;n
# separados por comas.  De este modo, si el tr&aacute;fico desde muchas redes
# (o anfitriones individuales) tuviera que ser reenviado a trav&eacute;s
# de este t&uacute;nel, la mayor&iacute;a de nombres de secci&oacute;n
# ser&iacute;an a&ntilde;adidos (y las correspondientes secciones nuevas
# m&aacute;s abajo).
d1525 11
a1535 10
# Los siguientes par&aacute;metros son para negociaciones de SA de ISAKMP.
# El nombre de secci&oacute;n es el anterior de la fase 1.  La etiqueta
# m&aacute;s interesante es la de ID.  La etiqueta ID est&aacute; configurada
# con el nombre de la secci&oacute;n, en donde se puede encontrar la
# informaci&oacute;n de la identidad sobre este anfitri&oacute;n, que se
# presentar&aacute; a los extremos que conecten.  Si la etiqueta ID no se
# encontrara disponible, isakmpd asumir&aacute; que se debe identificar a
# s&iacute; mismo usando la direcci&oacute;n IP.  Note que ya no hay ninguna
# etiqueta de autenticaci&oacute;n en esta configuraci&oacute;n.  Los datos
# de autenticaci&oacute;n se usan s&oacute;lo en el caso de claves
d1546 5
a1550 5
# &Eacute;stos son los datos de identidad.  ID-type tambi&eacute;n puede ser
# IPV4_ADDR (por definici&oacute;n), IPV4_ADDR_SUBNET o UFQDN.  La etiqueta
# Name se usa paraa FQDN y UFQDN;  para IPV4_ADDR se usar&iacute;a una
# etiqueta Address.  Para IPV4_ADDR_SUBNET se usar&iacute;a una etiqueta
# Network y Netmask.
d1556 7
a1562 7
# &Eacute;sta es la secci&oacute;n para la conexi&oacute;n IPSec.  El nombre
# de la secci&oacute;n viene de la lista en la secci&oacute;n anterior de
# fase 2.  ISAKMP-peer es, por supuesto, la etiqueta de nuestro extremo de
# conexi&oacute;n en la secci&oacute;n fase 1 anterior.  Las etiquetas
# Local-ID y Remote-ID deben ser los nombres de las secciones que describen
# qu&eacute; paquetes se deben reenviar por el t&uacute;nel IPSec hacia la
# red remota.
d1577 3
a1579 2
# ... y cuyo destino coincida con la red descrita aqu&iacute;, ser&aacute;
# cifrado y reenviado por el t&uacute;nel IPSec al sistema remoto.
d1591 5
a1595 4
# considerado como mucho m&aacute;s seguro debido a que tiene suficientes
# bits en la clave como para ser seguro.  Transforms es una lista de
# etiquetas que describen las transformaciones criptogr&aacute;ficas del modo
# principal.  En este ejemplo s&oacute;lo tenemos una.
d1602 4
a1605 4
# Certificados almacenados en formato PEM.
# Esta parte es importante cuando se usen certificados.  Los certificados CA
# deben estar en CA-directory (pero no la clave privada CA).  Cert-directory
# debe tener, al menos, el certificado para el anfitri&oacute;n local, pero
d1617 12
a1628 11
# m&aacute;s importante aqu&iacute; es usar RSA_SIG como m&eacute;todo de
# autenticaci&oacute;n cuando se usen certificados.  Por el momento, es el
# &uacute;nico m&eacute;todo que tiene soporte cuando se usan certificados.
# Las entidades comerciales en los EE.UU. tendr&aacute;n que esperar hasta
# septiembre de 2.000 para usarlo, debido a la patente de RSA.  Por suerte,
# yo no vivo en los EE.UU.  Tambi&eacute;n es importante la etiqueta
# GROUP_DESCRIPTION.  Debe coincidir con la etiqueta GROUP_DESCRIPTION en las
# transformaciones criptogr&aacute;ficas del modo r&aacute;pido descritas
# m&aacute;s adelante.  Aqu&iacute; la etiqueta Life se podr&iacute;a
# modificar.  LIFE_60_SECS podr&iacute;a ser m&aacute;s corta de lo necesario
# para el uso normal.
d1660 4
a1663 4
# No lo olvide.  GROUP_DESCRIPTION debe coincidir con GROUP_DESCRIPTION en el
# modo principal anterior.  Para reenviar paquetes entre dos redes (o desde
# un anfitri&oacute;n a una red) usamos el modo TUNNEL.  Entre dos
# anfitriones tambi&eacute;n podemos usar el modo TRANSPORT.
d1674 3
a1676 3
# m&iacute;nimo aceptable, y un valor m&aacute;ximo aceptable.  El ejemplo de
# isakmpd.conf tiene configurado esto a 600,450/720.  Este valor puede ser
# mejor para un uso normal.
d1692 5
a1696 5
Hasta aqu&iacute; la configuraci&oacute;n para el sistema local.  El sistema
remoto se configura exactamente del mismo modo, s&oacute;lo que al
rev&eacute;s.  Por lo tanto, la primera parte del fichero isakmpd.conf es
diferente.  Echemos un vistazo a esa primera parte del fichero isakmpd.conf
para la pasarela de seguridad de gw.worksite.se:
d1743 2
a1744 2
No ha sido tan dif&iacute;cil, tal vez algo aburrido de leer.
La siguiente parte es algo m&aacute;s interesante.
d1750 3
a1752 4
El fichero <i>policy</i> puede ser algo confuso para alguien que no lo haya
usado con anterioridad, especialmente si las cosas no funcionan como se
espera.
La p&aacute;gina de manual de
d1754 2
a1755 2
no est&aacute; tan mal.
Tal vez sea poco clara en algunas partes, pero en general es buena.
d1758 2
a1759 2
El fichero <i>policy</i> m&aacute;s simple que es posible ser&iacute;a uno
que contuviera una &uacute;nica l&iacute;nea:
d1769 8
a1776 9
B&aacute;sicamente, esto significa que no hay limitaciones en <i>policy</i>
sobre qui&eacute;n puede conectar.
Por lo tanto, no es una configuraci&oacute;n muy segura.
La etiqueta authorizer es para indicar qui&eacute;n tiene la 
autorizaci&oacute;n para decidir la pol&iacute;tica a seguir.
El autorizador especial &quot;POLICY&quot; tiene la autoridad total sobre 
<i>policy</i>.
Cualquier otro authorizer debe primero ser autorizado por &quot;POLICY&quot; 
para poder tener cualquier autoridad.
d1780 8
a1787 9
est&aacute; autorizado.
El siguiente <i>policy</i> vendr&iacute;a a decir que s&oacute;lo alguien que
use el protocolo ESP con algo de cifrado real, estar&iacute;a autorizado
(bueno, alguien que usara DES tambi&eacute;n estar&iacute;a autorizado
aqu&iacute;, aunque DES casi est&aacute; considerado como muy inseguro, se
deja como ejercicio para el lector el cambiar este fichero <i>policy</i> para
no permitir tampoco DES).
Note que cualquiera que cifre con ESP todav&iacute;a estar&iacute;a
autorizado.
d1800 5
a1804 6
Tambi&eacute;n se puede &laquo;sublicenciar&raquo; la autoridad a alguien
m&aacute;s (podr&iacute;a ser una o m&aacute;s entidades).
El caso simple ser&iacute;a el caso de la clave precompartida.
En ese caso, cualquiera que sepa que la contrase&ntilde;a precompartida,
estar&aacute; autorizado.
Por lo tanto:
d1818 2
a1819 2
Esto autorizar&iacute;a a cualquiera que supiera esta contrase&ntilde;a para
conectar y cumplir con las condiciones (pero recuerde que la
d1824 1
a1824 2
Hasta ahora, nada complicado.
Ahora viene la parte interesante.
d1826 5
a1830 5
autorizados por &quot;POLICY&quot;.
Adem&aacute;s, aqu&eacute;llos que dispongan de licencias y est&eacute;n
autorizados, pueden &laquo;sublicenciar&raquo; a otros.
Un licenciado puede ser simplemente una cadena si est&aacute; m&aacute;s
descrito en el fichero <i>policy</i>:
d1850 6
a1855 7
Y ahora, a por lo que todos estaban esperando.
<i>policy</i> tambi&eacute;n se puede sublicenciar o delegar a una clave.
En este caso suele ser un certificado X.509.
El uso m&aacute;s simple de certificados ser&iacute;a usarlos como las
contrase&ntilde;as.
Simplemente introduzca certificados de usuarios individuales en el fichero
<i>policy</i>:
d1882 4
a1885 4
Los certificados que isakmpd lee de los directorios CA- y Certificate, y los
certificados recibidos desde el otro extremo de la conexi&oacute;n se
convierten en pseudocredenciales.
Estos certificados convertidos en pseudocredenciales ser&iacute;an algo
d1918 9
a1926 9
Note que &eacute;stos no est&aacute;n autorizados por &quot;POLICY&quot; y
por lo tanto no tendr&aacute;n ning&uacute;n efecto sin que est&eacute;n de
alguna manera autorizados.
Adem&aacute;s, esto muestra lo que le ocurre internamente a los certificados.
La credencial anterior no se ve en el fichero <i>policy</i>.
Sin embargo, se puede dar una sublicencia a tales credenciales.
Recuerde el tema sobre sublicencias.
Es posible dar licencias a todos los certificados que est&eacute;n firmados
por una cierta CA, poniendo el certificado de la CA como un licenciado de
d1953 4
a1956 4
El fichero <i>policy</i> que hemos visto es un simple ejemplo de fichero
<i>policy</i> que delega en una CA.
Cualquier usuario que tenga un certificado firmado por la CA de este
certificado, y que adem&aacute;s cumpla las otras condiciones configuradas en
d1962 1
a1962 1
<h2>Casi seguro... ¡no es seguro!</h2>
d1966 24
a1989 25
Hay formas para atacar una pasarela de seguridad configurada de esta forma.
Si no quiere leer los detalles, pase a la secci&oacute;n siguiente ahora.
Para el resto, intentaremos entender porqu&eacute; esto no es seguro.
No es dif&iacute;cil.

<p>
Considere a qu&eacute; informaci&oacute;n tiene acceso en este momento uno de
los isakmpd.
Del fichero de configuraci&oacute;n, isakmpd sabe cu&aacute;l es el 
IP-address desde el que se conectar&aacute;n (en la secci&oacute;n Fase 1).
De la informaci&oacute;n que obtiene durante la negociaci&oacute;n de la fase
1, sabe el ID con el que el extremo que se conecta presenta a s&iacute; mismo
y el certificado que obtiene desde ese extremo de la conexi&oacute;n prueba
que que ese ID le pertenece.

<p>
Si la informaci&oacute;n del ID era el IP (si no ponemos una secci&oacute;n 
ID en fase 1, &eacute;sta es la situaci&oacute;n por definici&oacute;n), 
todo va bien.
La CA habr&aacute; ligado el IP al certificado, y el IP en la
configuraci&oacute;n ser&aacute; toda la informaci&oacute;n que necesitemos.
Un impostor podr&iacute;a usar el mismo IP de otra m&aacute;quina en algunos
casos (si ambas m&aacute;quinas estuvieran en la misma red local y la
m&aacute;quina que tuviera este IP estuviera fuera de servicio por cualquier
motivo).
d1991 2
a1992 1
correspondiente clave privada que probara que este IP pertenece al impostor.
d1995 5
a1999 5
Si esto ocurriera alguna vez, el impostor habr&iacute;a conseguido robar la 
clave privada del aut&eacute;ntico propietario del IP, o el impostor 
habr&iacute;a conseguido enga&ntilde;ar la CA para que le diera un
certificado que contuviera informaci&oacute;n falsa.
En el primer caso significar&iacute;a que la clave privada no se
d2001 4
a2004 4
habr&iacute;a fallado al comprobar la identidad del impostor como debiera (o
la informaci&oacute;n del ID del certificado) o la clave privada de la CA no
habr&iacute;a estado bien protegida.
Como todo esto son prerrequisitos para que la seguridad funcione, ninguna de
d2008 20
a2027 21
En nuestro ejemplo la situaci&oacute;n es diferente.
Aqu&iacute; tenemos un FQDN en el certificado en lugar de una
direcci&oacute;n IP.
Como todav&iacute;a tenemos una direcci&oacute;n IP en la secci&oacute;n de
fase 1, tenemos por tanto un posible problema de seguridad.
Lo que ocurrir&iacute;a durante la negociaci&oacute;n de fase 1 de ISAKMP
ser&iacute;a que podr&iacute;amos comprobar que el extremo de la
conexi&oacute;n se hubiera llevado a cabo desde el IP supuesto (pero como 
hemos explicado anteriormente, en algunos casos se podr&iacute;a falsificar).
Podr&iacute;amos comprobar que ese ID que presenta nuestro extremo de la
conexi&oacute;n realmente pertenece a &eacute;ste.
Pero lo que no podr&iacute;amos comprobar ahora ser&iacute;a si ese ID es 
realmente el ID que suponemos, porque isakmpd nunca ha sabido qu&eacute; ID 
deber&iacute;a ser.

<p>
Alguien podr&iacute;a decir que el sistema de DNS ata el IP al FQDN para el
anfitri&oacute;n.
Es cierto, sin embargo el sistema de DNS actual no es seguro y se le puede,
bajo ciertas circunstancias, enga&ntilde;ar para que entregue
informaci&oacute;n falsa (o podr&iacute;a ser v&iacute;ctima de una ataque de
d2029 23
a2051 24
Service&quot;) por parte de un atacante, y la m&aacute;quina del atacante
podr&iacute;a falsificar la respuesta del servidor de DNS).
DNS seguro aparecer&aacute; en el futuro, pero todav&iacute;a no est&aacute;
aqu&iacute; (o por lo menos la mayor&iacute;a de servidores de DNS
todav&iacute;a no son seguros);  por lo tanto, hoy en d&iacute;a, el uso de
DNS para comprobar si el FQDN en el certificado corresponde al IP supuesto,
no es una garant&iacute;a.
De hecho, isakmpd no lo comprueba con DNS.
Aun cuando DNS fuera seguro, la comprobaci&oacute;n no servir&iacute;a en el
caso de usar un UFQDN.

<p>
As&iacute; pues, en caso de tener un FQDN como ID, ser&iacute;a posible que
un atacante obtuviese su propia clave privada y que &eacute;sta estuviera
firmada por la misma CA que usamos nosotros (pero con el FQDN del atacante).
Y podr&iacute;a lanzar un ataque DoS sobre nuestra conexi&oacute;n para
hacerla caer (de hecho, existen unos agujeros en el mismo protocolo ISAKMP,
que probablemente se podr&iacute;n usar para lanzar un ataque DoS remoto
contra la conexi&oacute;n y hacerla caer, aunque no s&eacute; qu&eacute;
sensibles a estos ataques ser&iacute;a isakmpd).
Entonces, el atacante podr&iacute;a configurar su propia m&aacute;quina del
mismo modo que la de nuestra conexi&oacute;n, conectarla a la red de nuestra
conexi&oacute;n, e intentar conectarse mediante su ID, clave privada y 
certificado propios.
d2055 10
a2064 10
nuestra conexi&oacute;n (debido a que el atacante est&aacute; configurado de
forma id&eacute;ntica a nuestra conexi&oacute;n, aparte del certificado, ID
y clave privada).
Nuestro isakmpd podr&iacute;a comprobar que el certificado estuviera firmado
por la misma CA (pero la mayor&iacute;a de CAs firman muchos certificados, y
un certificado no es tan dif&iacute;cil de conseguir), y que el ID presentado
fuera el mismo que el ID en el certificado.
Sin embargo, con la configuraci&oacute;n presentada hasta ahora, no
comprobar&iacute;a que este ID fuera el supuesto.
Por lo tanto, el atacante tendr&iacute;a permiso para conectar.
d2070 4
a2073 4
Ahora la cuesti&oacute;n es, ¿c&oacute;mo podemos informar a isakmpd sobre
qu&eacute; ID debe esperar?
Por suerte esto es f&aacute;cil, y est&aacute; documentado en la p&aacute;gina
de manual de
d2102 4
a2105 5
Ahora s&oacute;lo gw.worksite.se podr&iacute;a obtener una conexi&oacute;n
IPSec.
Se pueden a&ntilde;adir m&aacute;s permisos para otros IDs, a&ntilde;adiendo 
m&aacute;s comprobaciones remote_id alternativas, o sea, teniendo condiciones 
en <i>policy</i> como esta:
d2119 2
a2120 2
Con esta <i>policy</i> podr&iacute;an conectar tanto gw.worksite.se, como
gw.somesite.se, como gw.whatsite.se.
d2124 19
a2142 19
enteros introducidos en <i>policy</i>.
Reformatear los certificados en el formato de <i>policy</i> requiere algo de
esfuerzo, y hace que <i>policy</i> sea poco legible.
Si alguien substituyera por error, un certificado de usuario con el
correspondiente certificado de CA en alguna parte de un fichero <i>policy</i>
complejo, podr&iacute;a provocar que usuarios no autorizados obtuvieran
permiso para conectar en algunos casos y, a&uacute;n peor, no ser&iacute;a
f&aacute;cilmente detectable leyendo el fichero <i>policy</i> (porque los
certificados X.509 no est&aacute;n en un formato humano legible).

<p>
Ahora, para aquellos a quienes les gusta estar al borde del precipicio, existe 
una soluci&oacute;n a este problema.
Ahora se puede usar el certificado &laquo;Nombre Distinguido&raquo; (DN,
&quot;Distinguished Name&quot;) en lugar de un certificado en <i>policy</i>
(por supuesto que el correspondiente certificado debe estar disponible desde
los directorios cert o ca del disco, de modo que isakmpd lo pueda encontrar).
Con este formato, el fichero <i>policy</i> anterior acabar&iacute;a siendo
algo as&iacute;:
d2161 3
a2163 3
Mucho m&aacute;s legible, ¿o no?
La informaci&oacute;n sobre lo que es el exacto DN para un certificado se
puede encontrar mirando al certificado, usando la utilidad openssl:
d2173 3
a2175 3
Se pueden hacer configuraciones de <i>policy</i> m&aacute;s complicadas pero
esto es suficiente para empezar, y todav&iacute;a hay otro ejemplo en la
siguiente secci&oacute;n.
d2178 5
a2182 6
Esto deber&iacute;a proveerle con la informaci&oacute;n necesaria sobre el
certificado en ca.crt.
Esto ser&aacute; bueno siempre que tengamos un fichero <i>policy</i>
peque&ntilde;o o, por lo menos, uno razonable.
Sin embargo, todav&iacute;a no es suficiente si tenemos un sitio enorme con
muchos usuarios que deban tener permiso de conexi&oacute;n.
d2185 2
a2186 1
<h2>Configuraciones de multiusuario y/o autorizaci&oacute;n centralizada</h2>
d2190 1
a2190 1
Hasta ahora hemos asumido que el supuesto extremo remoto de la 
d2192 4
a2195 6
est&aacute;tica.
Esto no siempre es as&iacute;.
Muchas personas usan IPs asignados de forma din&aacute;mica, o usan muchas
m&aacute;quinas diferentes.
En otros casos, como en el caso de los servidores, podr&iacute;amos no estar
seguros de qui&eacute;n quiere conectar.
d2198 4
a2201 4
Por lo tanto, una funcionalidad interesante de isakmpd es que puede usar en
la secci&oacute;n de fase 1 una etiqueta predefinida en lugar de un IP,
permitiendo de este modo negociaciones isakmpd desde cualquier IP.
Esto se har&iacute;a del siguiente modo:
d2212 5
a2216 6
Primero, hay que decir que esta configuraci&oacute;n podr&iacute;a no ser
segura frente a ataques de DoS.
Como se ha dicho anteriormente, existen algunos agujeros en los protocolos
ISAKMP/IKE.
De todos modos, el uso de una secci&oacute;n de fase 1 predefinida
tambi&eacute;n nos permite usar un tipo de &laquo;certificados de
d2221 4
a2224 5
acept&aacute;ramos a cualquier usuario, como podr&iacute;a ocurrir en una
compa&ntilde;&iacute;a.
Nos gustar&iacute;a que los empleados tuvieran permiso para conectar, pero
nadie m&aacute;s.
Ahora imagine que la compa&ntilde;&iacute;a tuviera miles de empleados, y que
d2228 2
a2229 2
cualquier cosa.
Se podr&iacute;a escribir un fichero <i>policy</i> como &eacute;ste:
d2269 13
a2281 13
Puede que esto no sea exactamente como deber&iacute;a ser.
Por lo que s&eacute;, no est&aacute; comprobado (de hecho, estas condiciones
de filtros podr&iacute;an no funcionar como espero).
Adem&aacute;s, un fichero <i>policy</i> como &eacute;ste (cualquiera con un
IP del extremo de la conexi&oacute;n predefinido) requerir&iacute;a
reescribir partes del fichero isakmpd.conf tambi&eacute;n.
Esto conllevar&iacute;a algunas implicaciones en la seguridad.
Para este tipo de conexiones en las que cualquiera debe tener permiso para
conectar, es probablemente deseable grabar el DN de cualquiera que conecte.
Que yo sepa, isakmpd todav&iacute;a no tiene soporte para esto.
Adem&aacute;s, tambi&eacute;n podr&iacute;a tener otras implicaciones en la
seguridad.
De cualquier modo la idea b&aacute;sica est&aacute; clara.
d2284 13
a2296 15
Por si acaso alguien no ha visto las interesantes posibilidades que esto
tiene:
Si todas la m&aacute;quinas que usan ISAMKP/IKE de este modo, tuvieran un
grupo de condiciones est&aacute;ndar para todos los servicios que los
usuarios quisieran usar de forma remota, la CA podr&iacute;a autorizar a los
usuarios poniendo las extensiones SubjectAltName correctas en sus
certificados.
Adem&aacute;s, la fecha de caducidad para estos certificados se podr&iacute;a
configurar para que caducara a menudo, aunque los usuarios podr&iacute;an
obtener nuevos certificados cuando sus certificados actuales estuvieran a
punto de caducar.
Si los usuarios hicieran un mal uso de sus autorizaciones, bastar&iacute;a
con no volver a emitir los certificados para que no pudieran acceder
despu&eacute;s de la fecha de caducidad.
No ser&iacute;a necesario cambiar los ficheros <i>policy</i> en todas las
d2298 6
a2303 6
trabajo.
El mismo esquema podr&iacute;a funcionar para prop&oacute;sitos distintos a
ISAKMP/IPSec (¡incluida la autorizaci&oacute;n para sistemas fuera de la
conexi&oacute;n!), aunque eso requerir&iacute;a un software especial.
En cualquier caso, cualquier organizaci&oacute;n que hiciera esto es probable
que tambi&eacute;n quisiera ser su propia CA.
d2307 10
a2316 9
&eacute;sta, tambi&eacute;n son posibles con claves precompartidas, pero
entonces se requiere que se use el modo AGGRESSIVE en lugar del modo ID_PROT,
ya que en este caso necesitaremos poder escoger la frase de la
contrase&ntilde;a correcta basada en el ID, debido a que en este caso no lo
podemos saber por el ID (en modo AGGRESSIVE el ID se env&iacute;a durante un
estado m&aacute;s temprano de la negociaci&oacute;n, pero se env&iacute;a
descifrado, por lo tanto el modo AGGRESSIVE es m&aacute;s r&aacute;pido
porque necesita menos intercambios de mensajes, pero tambi&eacute;n es un
poco menos seguro debido a que el ID se env&iacute;a en claro).
d2320 2
a2321 1
<h1>13.10 - ¿Qu&eacute; clientes IKE son compatibles con isakmpd?</h1>
d2325 5
a2329 6
ISAKMP/Oakley que viene con OpenBSD.
Sospechamos que interacciona, por lo menos en parte, con la mayor&iacute;a de
implementaciones ISAKMP, pero s&oacute;lo los siguientes han sido
comprobados.
Note que algunos software isakmp que puede encontrar est&aacute;n basados en
el d&aelig;mon iskamp de OpenBSD.
d2332 2
a2333 2
Los siguientes clientes para MS-Windows son compatibles seg&uacute;n los
informes recibidos:
d2337 4
a2340 2
   <li><a href="http://www.vpcom.com/">Ashley Laurent</a> VPCom VPN software
   <li><a href="http://www.nai.com/asp_set/products/tns/pgp_vpn.asp">PGP VPN</a> software
d2343 2
d2357 3
a2359 2
   <li><a href="http://www.kame.net/">KAME</a> for FreeBSD
   <li><a href="http://www.xs4all.nl/~freeswan/">FreeS/WAN</a> for Linux
d2381 6
a2386 6
mejorada de tcpdump que puede mostrarle algo de informaci&oacute;n sobre
paquetes ESP y AH.
Si est&aacute; usando tcpdump desde OpenBSD 2.5 o desde otro sistema
operativo, es posible que tenga una versi&oacute;n anticuada que s&oacute;lo
le muestre el n&uacute;mero del protocolo para AH o ESP (el protocolo IP de
ESP es 50, y el de AH es 51).
d2390 5
a2394 6
<li>Con tcpdump, mire si el tr&aacute;fico est&aacute; usando AH/ESP o texto
    en claro.
    Si su tr&aacute;fico es en texto en claro, entonces sus flujos
    est&aacute;n configurados de modo incorrecto, o su isakmp no est&aacute;
    negociando como debiera.
    Use <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&apropos=0&sektion=8&format=html">ping(8)</a>
d2399 2
a2400 2
Por ejemplo, yo tengo dos m&aacute;quinas anfitrionas, 208.1.1.1 y 208.2.2.2.
Ingreso en 208.2.2.2 y hago lo siguiente:
d2474 2
a2475 2
o (para saltar la informaci&oacute;n m&aacute;s detallada de depurado del 
temporizador
d2485 2
a2486 2
<li>Debe permitir el paso a su net A con cortafuegos del tr&aacute;fico que ha 
sido procesado por IPSec.
d2496 3
a2498 3
<li>Con tcpdump en OpenBSD puede descodificar la mayor parte del texto en
    claro de las sesiones IKE.
    tcpdump tambi&eacute;n le mostrar&aacute; los datos de cargo de AH.
d2501 2
a2502 1
<li>Monte un sistema de archivo /kern (si no usa uno por definici&oacute;n)
d2512 4
a2515 4
En /kern hay una tabla de SA/SPIs actuales, incluidos los que tienen flujos
(SAs salientes) y los que no (SAs entrantes).
Tambi&eacute;n hay contadores de tr&aacute;fico que puede usar para ver
qu&eacute; tr&aacute;fico pasa y a d&oacute;nde va.
d2541 3
a2543 4
<li>Si todo lo dem&aacute;s fallara, recompile el n&uacute;cleo del sistema
    con <tt>option ENCDEBUG</tt>.
    A continuaci&oacute;n configure el sysctl <tt>net.inet.ip.encdebug</tt>
    con el valor 1.
d2547 2
a2548 2
    De forma alternativa, si no est&aacute; seguro de que su problema sea un
    error, puede enviar un mensaje a una de las 
d2557 2
a2558 1
IPSec est&aacute; parcialmente documentado en la p&aacute;gina de manual de
d2561 2
a2562 2
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/share/ipsec/">/usr/share/ipsec/</a> que le pueden ser de ayuda.
Las p&aacute;ginas de manual de
d2588 1
d2592 5
d2599 2
d2602 2
d2619 1
d2624 1
a2624 1
<a href="index.html">[Volver al Índice Principal]</a>
d2634 2
a2635 2
Originally [OpenBSD: faq13.html,v 1.32 2000/04/26 22:37:08 chris Exp ]<br>
$Translation: faq13.html,v 1.2 2000/04/29 17:58:05 horacio Exp $<br>
@


1.1
log
@Sync with Badlands translation CVS. Work by Horacio
@
text
@d20 1
a20 1
<a href="../faq14.html">[Secci&oacute;n 14.0 - Uso de Discos en OpenBSD]</a>
d2640 1
a2640 1
<a href="../faq14.html">[Secci&oacute;n 14.0 - Uso de Discos en OpenBSD]</a>
d2644 1
a2644 1
<a href="index.html"><img height="24" width="24" src="../../images/back.gif" border="0" alt="[back]"></a>
d2648 2
a2649 2
Originally [OpenBSD: faq13.html,v 1.31 2000/04/23 22:17:36 chris Exp ]<br>
$Translation: faq13.html,v 1.1 2000/04/26 15:13:44 horacio Exp $<br>
@

