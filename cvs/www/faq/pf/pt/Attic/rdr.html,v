head	1.15;
access;
symbols;
locks; strict;
comment	@# @;


1.15
date	2014.04.01.17.14.11;	author nick;	state dead;
branches;
next	1.14;

1.14
date	2012.02.27.07.12.56;	author ajacoutot;	state Exp;
branches;
next	1.13;

1.13
date	2012.01.03.08.19.10;	author ajacoutot;	state Exp;
branches;
next	1.12;

1.12
date	2009.10.19.09.39.59;	author ajacoutot;	state Exp;
branches;
next	1.11;

1.11
date	2009.10.17.15.58.26;	author ajacoutot;	state Exp;
branches;
next	1.10;

1.10
date	2009.06.29.17.19.48;	author ajacoutot;	state Exp;
branches;
next	1.9;

1.9
date	2009.05.16.08.59.12;	author ajacoutot;	state Exp;
branches;
next	1.8;

1.8
date	2009.03.16.20.24.23;	author tobias;	state Exp;
branches;
next	1.7;

1.7
date	2007.12.01.10.39.11;	author tobias;	state Exp;
branches;
next	1.6;

1.6
date	2006.11.22.15.14.07;	author saad;	state Exp;
branches;
next	1.5;

1.5
date	2006.05.29.11.06.11;	author jufi;	state Exp;
branches;
next	1.4;

1.4
date	2005.11.18.20.48.47;	author jufi;	state Exp;
branches;
next	1.3;

1.3
date	2005.07.03.07.28.34;	author saad;	state Exp;
branches;
next	1.2;

1.2
date	2005.05.30.13.52.07;	author saad;	state Exp;
branches;
next	1.1;

1.1
date	2005.01.06.20.03.30;	author jufi;	state Exp;
branches;
next	;


desc
@@


1.15
log
@
Abandon translations, per deraadt@@ and ajacoutot@@.
@
text
@<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Redirecionamento de Tráfego ("Port Forwarding")</title>
<link rev="made" href="mailto:www@@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, Nick Holland <nick@@openbsd.org>
Copyright (c) 2003-2005, Joel Knight <enabled@@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="nat.html">Anterior: Tradução do Endereço de Rede (NAT)</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="shortcuts.html">Próximo: Atalhos na Criação de
Conjuntos de Regras</a>]

<h1><font color="#e00000">PF: Redirecionamento ("Port Forwarding")</font></h1>

<hr>

<h3>Conteúdo</h3>
<ul>
<li><a href="#intro">Introdução</a>
<li><a href="#filter">Redirecionamento e Filtragem de Pacotes</a>
<li><a href="#security">Implicações de Segurança</a>
<li><a href="#reflect">Redirecionamento e Reflexão</a>
	<ul>
	<li><a href="#splitdns">DNS "Split-Horizon"</a>
	<li><a href="#sepnet">Mover o Servidor Para uma Rede Local
            Separada</a>
	<li><a href="#tcpproxy">Proxy TCP</a>
	<li><a href="#rdrnat">Combinação de RDR-TO e NAT-TO</a>
	</ul>
</ul>

<hr>

<a name="intro"></a>
<a name="filter"></a>
<h2>Introdução</h2>
Quando você utiliza NAT no seu escritório, você tem a Internet
inteira disponível para todas as suas máquinas.
Mas e se você tiver uma máquina atrás do gateway NAT que precisa ser
acessada de fora? É aqui que entra em cena o redirecionamento.
Redirecionamento permite enviar tráfego para uma máquina atrás do
gateway NAT.

<p>
Vejamos um exemplo:
<blockquote>
<tt>
pass in on tl0 proto tcp from any to any port 80 rdr-to 192.168.1.20
</tt>
</blockquote>

<p>
Essa linha redireciona o tráfego TCP na porta 80 (servidor Web) para uma
máquina na rede com o endereço 192.168.1.20. Portanto, mesmo que
192.168.1.20 esteja atrás do gateway dentro da rede, ela se torna
acessível ao mundo externo.

<p>
A parte <tt>from any to any</tt> da linha <tt>rdr</tt> acima pode ser
muito útil. Se você souber quais endereços ou sub-redes devem ter acesso
ao servidor na porta 80, pode restringi-los assim:
<blockquote>
<tt>
pass in on tl0 proto tcp from 27.146.49.0/24 to any port 80 \<br>
&nbsp;&nbsp;&nbsp;rdr-to 192.168.1.20
</tt>
</blockquote>

<p>
Isso redireciona somente a sub-rede especificada. Perceba que isso
implica que você pode redirecionar diferentes máquinas para máquinas
diferentes atrás do gateway. Isso pode ser muito útil. Por exemplo,
você pode fazer com que usuários em lugares remotos acessem seus
próprios computadores desktop usando a mesma porta e o mesmo endereço IP
no gateway desde que você saiba de que endereço IP eles se conectarão:
<blockquote>
<tt>
pass in on tl0 proto tcp from 27.146.49.14 to any port 80 \<br>
&nbsp;&nbsp;&nbsp;rdr-to 192.168.1.20<br>
pass in on tl0 proto tcp from 16.114.4.89 to any port 80 \<br>
&nbsp;&nbsp;&nbsp;rdr-to 192.168.1.22<br>
pass in on tl0 proto tcp from 24.2.74.178 to any port 80 \<br>
&nbsp;&nbsp;&nbsp;rdr-to 192.168.1.23
</tt>
</blockquote>

<p>
Uma faixa de portas também pode ser redirecionada dentro da mesma regra:
<blockquote>
<tt>
pass in on tl0 proto tcp from any to any port 5000:5500 \<br>
&nbsp;&nbsp;&nbsp;rdr-to 192.168.1.20<br>
pass in on tl0 proto tcp from any to any port 5000:5500 \<br>
&nbsp;&nbsp;&nbsp;rdr-to 192.168.1.20 port 6000<br>
pass in on tl0 proto tcp from any to any port 5000:5500 \<br>
&nbsp;&nbsp;&nbsp;rdr-to 192.168.1.20 port 7000:*<br>
</tt>
</blockquote>

<p>
Esses exemplos mostram portas entre 5000 a 5500 (faixa inclusiva)
sendo redirecionadas para 192.168.1.20.
Na primeira regra, a porta 5000 é redirecionada para 5000, 5001 para
5001, etc.
Na segunda regra, toda a faixa de portas é redirecionada para a porta
6000.
E, na última regra, a porta 5000 é redirecionada para 7000, 5001 para
7001, etc.

<a name="security"></a>
<h2>Implicações de Segurança</h2>
Redirecionamento possui implicações de segurança. Fazer um furo no
firewall para permitir tráfego para a rede interna protegida cria um
risco de comprometimento da máquina interna. Caso o tráfego seja
transmitido para um servidor Web interno, por exemplo, e uma
vulnerabilidade seja descoberta no daemon do servidor ou em um
script CGI executado no servidor Web, a máquina pode ser comprometida
por um intruso na Internet. De lá, o intruso tem uma porta aberta para
a rede interna, em uma máquina que tem permissão de passar pelo
firewall.

<p>
Esses riscos podem ser minimizados mantendo-se os sistemas acessados
externamente confinados numa rede separada. Essa rede é geralmente
chamada de Zona Desmilitarizada (DMZ - "Demilitarized Zone") ou
Rede de Serviços Privada (PSN - "Private Service Network").
Dessa forma, caso o servidor Web seja comprometido, os efeitos podem ser
limitados à rede DMZ/PSN pela filtragem cuidadosa do tráfego que terá
permissão de entrar e sair da rede DMZ/PSN.

<a name="reflect"></a>
<h2>Redirecionamento e Reflexão</h2>
Geralmente regras de redirecionamento são usadas para transferir
pedidos de conexão da Internet para um servidor local com endereço IP
privado na rede interna, ou LAN, como:
<blockquote>
<tt>
server = 192.168.1.40<br>
<br>
pass in on $ext_if proto tcp from any to $ext_if port 80 \<br>
&nbsp;&nbsp;&nbsp;rdr-to $server port 80
</tt>
</blockquote>

<p>
Mas quando a regra de redirecionamento é testada por um cliente na LAN,
ela não funciona. O motivo é que as regras de redirecionamento se
aplicam apenas a pacotes que passam pela interface especificada (no
exemplo, a interface externa <tt>$ext_if</tt>).
Conectar-se ao endereço externo do firewall a partir de uma máquina na
LAN, contudo, não significa que os pacotes passarão por sua interface
externa. A pilha TCP/IP no firewall compara o endereço de destino do
pacote chegando com seus próprios endereços e apelidos e detecta
conexões para ela mesma tão logo que tenham passado pela interface
interna.
Esses pacotes não passam fisicamente pela interface externa, e a pilha
TCP/IP não simula essa passagem de forma alguma. Portanto, o PF nunca
vê esses pacotes na interface externa, e a regra de redirecionamento,
especificando a interface externa, não se aplica.

<p>
Adicionar uma segunda regra de redirecionamento para a interface interna
também não produz o efeito desejado. Quando um cliente local conecta-se
ao endereço externo do firewall, o pacote inicial do handshake TCP
atinge o firewall pela interface interna. A regra de redirecionamento
é aplicada e o endereço de destino é substituído pelo do servidor
interno. O pacote é transferido de volta pela interface interna e chega
ao servidor interno. Mas o endereço de origem no pacote não foi
traduzido, e ainda contém o endereço do cliente local, portanto o
servidor envia suas respostas diretamente ao cliente. O firewall nunca
vê as respostas, ficando sem chance de reverter a tradução
apropriadamente. O cliente então recebe respostas de um endereço
IP de onde ele nunca esperava, e por isso descarta os pacotes. O
handshake TCP falha e nenhuma conexão pode ser estabelecida.

<p>
Mas ainda assim, geralmente é necessário que os clientes na LAN se
conectem ao servidor interno da mesma forma que os clientes externos,
e que o façam de maneira transparente. Existem várias soluções
para esse problema:

<a name="splitdns"></a>
<h3>DNS "Split-Horizon"</h3>

<p>
É possível configurar servidores DNS para responder às pesquisas de
clientes locais de maneira diferente das pesquisas externas, de forma
que clientes locais receberão o endereço interno do servidor durante
a resolução de nomes. Eles, portanto, se conectam diretamente
ao servidor local, e o firewall não tem envolvimento. Isso reduz o
tráfego local, já que os pacotes não precisam passar pelo firewall.

<a name="sepnet"></a>
<h3>Mover o Servidor Para uma Rede Local Separada</h3>

<p>
Acrescentar mais uma interface de rede ao firewall e mover
o servidor local da rede cliente para uma rede dedicada (DMZ) permite
o redirecionamento de conexões dos clientes locais da mesma maneira
que o redirecionamento de conexões externas. O uso de redes separadas
traz diversas vantagens, incluindo melhora na segurança devido ao
isolamento do servidor das máquinas locais restantes. Caso o servidor
(que em nosso caso é acessível pela Internet) seja comprometido, ele não
terá acesso direto às máquinas locais porque todas as conexões devem
agora passar pelo firewall.

<a name="tcpproxy"></a>
<h3>Proxy TCP</h3>

<p>
Um proxy TCP genérico pode ser configurado no firewall, escutando na
porta a ser redirecionada ou recebendo conexões redirecionadas na
interface interna para a porta onde ele esteja escutando. Quando um
cliente local se conecta ao firewall, o proxy aceita a conexão,
estabelece uma segunda conexão com o servidor interno e transfere
dados entre as duas conexões.

<p>
Proxies simples podem ser criados usando-se
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;sektion=8"
>inetd(8)</a> e
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=nc&amp;sektion=1"
>nc(1)</a>. A entrada no <tt>/etc/inetd.conf</tt> a seguir cria um
soquete que escuta no endereço de loopback (127.0.0.1) na porta 5000.
As conexões são encaminhadas ao servidor 192.168.1.10 na porta 80.
O redirecionamento é feito pelo usuário "proxy".
<blockquote>
<tt>
127.0.0.1:5000 stream tcp nowait proxy /usr/bin/nc nc -w \<br>
&nbsp;&nbsp;&nbsp;20 192.168.1.10 80
</tt>
</blockquote>

<p>
A regra de redirecionamento a seguir transfere conexões na porta 80,
na interface interna, para o proxy:
<blockquote>
<tt>
pass in on $int_if proto tcp from $int_net to $ext_if port 80 \<br>
&nbsp;&nbsp;&nbsp;rdr-to 127.0.0.1 port 5000
</tt>
</blockquote>

Proxies de alto desempenho, também podem ser criados com <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=relayd&amp;sektion=8">relayd(8)</a>.

<a name="rdrnat"></a>
<h3>Combinação de RDR-TO e NAT-TO</h3>

<p>
Com uma regra NAT adicional na interface interna, a tradução de
endereço que estava faltando no cenário acima pode ser remediada.
<blockquote>
<tt>
pass in on $int_if proto tcp from $int_net to $ext_if port 80 \<br>
&nbsp;&nbsp;&nbsp;rdr-to $server<br>
pass out on $int_if proto tcp to $server port 80 \<br>
&nbsp;&nbsp;&nbsp;received-on $int_if nat-to $int_if
</tt>
</blockquote>

<p>
Isso faz com que o pacote inicial do cliente seja traduzido novamente
quando retornar através da interface interna, substituindo o endereço
de origem do cliente pelo endereço interno do firewall. O servidor
interno responde para o firewall, que pode então reverter ambas
as regras de tradução NAT e RDR ao transferir o pacote para o cliente.
Essa construção é um tanto complexa, pois cria dois estados separados
para cada conexão refletida. Deve-se tomar muito cuidado para evitar
que a regra NAT atinja outro tráfego; por exemplo, conexões originadas
de máquinas externas (através de outros redirecionamentos) ou do próprio
firewall. Perceba que a regra <tt>rdr-to</tt> acima faz com que a pilha
TCP/IP receba pacotes na interface interna com um endereço de destino
dentro da rede interna.

<p>
[<a href="nat.html">Anterior: Tradução do Endereço de Rede (NAT)</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="shortcuts.html">Próximo: Atalhos na Criação de
Conjuntos de Regras</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[voltar]"></a>
<a href="mailto:www@@openbsd.org">www@@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: rdr.html,v 1.31 ]<br>
$Translation: rdr.html,v 1.14 2012/02/27 02:29:42 renato Exp $<br>
-->
$OpenBSD: rdr.html,v 1.14 2012/02/27 07:12:56 ajacoutot Exp $
</small>

</body>
</html>
@


1.14
log
@Sync with Steelix CVS
@
text
@d322 1
a322 1
$OpenBSD$
@


1.13
log
@Sync with Steelix CVS
@
text
@d319 2
a320 2
Originally [OpenBSD: rdr.html,v 1.29 ]<br>
$Translation: rdr.html,v 1.13 2012/01/02 16:38:56 renato Exp $<br>
@


1.12
log
@Sync with Steelix CVS
@
text
@d59 1
a59 1
	<li><a href="#rdrnat">Combinação de RDR e NAT</a>
d66 1
d79 1
a79 1
rdr on tl0 proto tcp from any to any port 80 -&gt; 192.168.1.20
d95 2
a96 2
rdr on tl0 proto tcp from 27.146.49.0/24 to any port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.20
d109 6
a114 6
rdr on tl0 proto tcp from 27.146.49.14 to any port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.20<br>
rdr on tl0 proto tcp from 16.114.4.89 to any port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.22<br>
rdr on tl0 proto tcp from 24.2.74.178 to any port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.23
d122 6
a127 6
rdr on tl0 proto tcp from any to any port 5000:5500 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.20<br>
rdr on tl0 proto tcp from any to any port 5000:5500 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.20 port 6000<br>
rdr on tl0 proto tcp from any to any port 5000:5500 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.20 port 7000:*<br>
a140 67
<a name="filter"></a>
<h2>Redirecionamento e Filtragem de Pacotes</h2>
<font color="#ff0000">NOTA:</font> Pacotes traduzidos ainda devem passar
pelo sistema de filtragem e serão bloqueados ou permitidos com base
nas regras de filtragem que foram definidas.

<p>
A <i>única</i> exceção à regra é quando a palavra-chave <tt>pass</tt>
é usada na regra <tt>rdr</tt>. Nesse caso, os pacotes redirecionados
passam direto pelo sistema de filtragem: as regras de filtragem não
são avaliadas para esses pacotes.
Esse é um atalho para evitar a adição de regras de filtragem
<tt>pass</tt> para cada regra de redirecionamento.
Pense nisso como uma regra <tt>rdr</tt> normal (sem a palavra-chave
<tt>pass</tt>) associada a uma regra de filtragem <tt>pass</tt> com a
palavra-chave <tt>keep state</tt>.
Contudo, caso queira habilitar opções de filtragem mais específicas,
como <tt>synproxy</tt>, <tt>modulate state</tt>, etc., você ainda
precisa usar regras <tt>pass</tt> dedicadas, já que essas opções
não se encaixam em regras de redirecionamento.

<p>
Também fique ciente de que a tradução ocorre <i>antes</i> da
filtragem; o sistema de filtragem vê os pacotes <i>traduzidos</i>
como eles ficam após terem seus endereços IP e/ou portas alterados
para corresponder ao endereço/à porta de redirecionamento
especificado(a) na regra <tt>rdr</tt>.
Considere o cenário:

<ul>
<li>192.0.2.1 - máquina na Internet
<li>24.65.1.13 - endereço externo do roteador OpenBSD
<li>192.168.1.5 - endereço IP interno do servidor Web
</ul>

<p>
Regra de redirecionamento:
<blockquote>
<tt>
rdr on tl0 proto tcp from 192.0.2.1 to 24.65.1.13 port 80 \<br>
&nbsp;&nbsp;&nbsp;-&gt; 192.168.1.5 port 8000
</tt>
</blockquote>

<p>
Pacote antes da regra <tt>rdr</tt> ser processada:
<ul>
<li>Endereço de origem: 192.0.2.1
<li>Porta de origem: 4028 (escolhida aleatoriamente pelo sistema
    operacional)
<li>Endereço de destino: 24.65.1.13
<li>Porta de destino: 80
</ul>

<p>
Pacote após a regra <tt>rdr</tt> ter sido processada:
<ul>
<li>Endereço de origem: 192.0.2.1
<li>Porta de origem: 4028
<li>Endereço de destino: 192.168.1.5
<li>Porta de destino: 8000
</ul>

<p>
O sistema de filtragem vê o pacote IP como ele se encontra após ter
sido feita a tradução.

d171 2
a172 2
rdr on $ext_if proto tcp from any to $ext_if port 80 -&gt; $server \<br>
&nbsp;&nbsp;&nbsp;port 80
d270 2
a271 2
rdr on $int_if proto tcp from $int_net to $ext_if port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;127.0.0.1 port 5000
d275 2
d278 1
a278 1
<h3>Combinação de RDR e NAT</h3>
d285 4
a288 6
rdr on $int_if proto tcp from $int_net to $ext_if port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;$server
<br>
no nat on $int_if proto tcp from $int_if to $int_net<br>
nat on $int_if proto tcp from $int_net to $server port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;$int_if
d302 1
a302 1
firewall. Perceba que a regra <tt>rdr</tt> acima faz com que a pilha
a306 4
De preferência, deve-se utilizar uma das soluções apresentadas
anteriormente.

<p>
d319 2
a320 2
Originally [OpenBSD: rdr.html,v 1.28 ]<br>
$Translation: rdr.html,v 1.12 2009/10/18 16:52:52 alan Exp $<br>
@


1.11
log
@Sync with Steelix CVS
@
text
@d222 2
a223 2
chamada de Zona Desmilitarizada (DMZ, "Demilitarized Zone") ou
Rede de Serviços Privada (PSN, "Private Service Network").
d390 1
a390 1
$Translation: rdr.html,v 1.11 2009/10/13 19:12:28 alan Exp $<br>
@


1.10
log
@Sync with Steelix CVS
@
text
@d39 1
a39 1
[<a href="nat.html">Anterior: Tradução do Endereço de Rede ("NAT")</a>]
d41 2
a42 1
[<a href="shortcuts.html">Próximo: Atalhos na Criação de Regras</a>]
d55 2
a56 2
	<li><a href="#splitdns">Split-Horizon DNS</a>
	<li><a href="#sepnet">Movendo o Servidor Para uma Rede Local
d58 1
a58 1
	<li><a href="#tcpproxy">TCP Proxying</a>
d70 1
a70 1
acessada de fora?  É aqui que entra o redirecionamento.
d83 2
a84 2
Essa linha redireciona o tráfego TCP na porta 80 (servidor web) para uma
máquina na rede com endereço 192.168.1.20. Portanto, mesmo que
d90 2
a91 2
muito útil. Se você souber quais endereços ou subredes devem ter acesso
ao servidor na porta 80, pode restringí-los assim:
d100 3
a102 3
Isso irá redirecionar somente a subrede especificada. Perceba que isso
implica que você pode redirecionar diferentes hosts para máquinas
diferentes atrás do gateway. O que pode ser muito útil. Por exemplo,
d104 2
a105 2
próprios computadores desktop usando a mesma porta e endereço IP no
gateway desde que você saiba de que endereço IP eles se conectarão.
d131 1
a131 1
Esses exemplos mostram portas entre 5000 a 5500 (faixa inclusiva),
d137 1
a137 1
E na última regra, a porta 5000 é redirecionada para 7000, 5001 para
d143 2
a144 2
pelo sistema de filtragem e serão bloqueados ou permitidos, com base
nas regras de filtragem definidas.
d149 4
a152 4
passarão direto pelo sistema de filtragem: as regras de filtragem não
serão avaliadas para esses pacotes.
É um atalho para evitar a adição de regras de filtragem <tt>pass</tt>
para cada regra de redirecionamento.
d158 1
a158 1
precisará usar regras <tt>pass</tt> dedicadas, já que essas opções
d162 2
a163 2
Também fique ciente de que, como a tradução ocorre <i>antes</i> da
filtragem, o sistema de filtragem verá os pacotes <i>traduzidos</i>
d165 2
a166 2
para combinar com o redirecionamento de endereço/porta especificado
na regra <tt>rdr</tt>.
d170 1
a170 1
<li>192.0.2.1 - host na Internet
d172 1
a172 1
<li>192.168.1.5 - endereço IP interno do servidor WEB
d176 1
a176 1
Regra de Redirecionamento:
d210 8
a217 7
firewall para permitir tráfego para a rede interna protegida, cria um
risco de comprometimento da máquina. Caso o tráfego seja transmitido
para um servidor web interno, por exemplo, e uma vulnerabilidade seja
descoberta no daemon do servidor ou num script CGI rodando no servidor
web, a máquina pode ser comprometida por um intruso na Internet.
De lá, o intruso tem uma porta aberta para a rede interna, numa máquina
que tem permissão de passar pelo firewall.
d222 3
a224 3
chamada de Zona Desmilitarizada (DMZ) ou Rede de Serviços Privada
("Private Service Network", PSN).
Dessa forma, caso o servidor web seja comprometido, os efeitos podem ser
d226 1
a226 1
permissão de entrar e sair da DMZ/PSN.
d230 1
a230 1
Geralmente, regras de redirecionamento são usadas para transferir
d232 1
a232 1
privado na rede interna, ou LAN como:
d245 12
a256 11
aplicam apenas à pacotes que passam pela interface especificada (no
exemplo, a interface <tt>$ext_if</tt>).
Conectar-se ao endereço externo do firewall de um host na LAN, contudo,
não significa que os pacotes passarão por sua interface externa. A pilha
TCP/IP no firewall compara o endereço de destino do pacote chegando com
seus próprios endereços e aliases e detecta conexões para ela mesma
tão logo tenham passado pela interface interna. Esses pacotes não passam
fisicamente pela interface externa, e a pilha TCP/IP não simula essa
passagem de forma alguma. Portanto, o PF nunca verá esses pacotes na
interface externa, e a regra de redirecionamento, especificando a
interface externa, não se aplicará.
d260 1
a260 1
também não produz o efeito desejado. Quando um cliente local se conecta
d266 1
a266 1
alterado, contendo ainda o endereço local do cliente, portanto o
d271 1
a271 1
handshake TCP falha e a conexão não pode ser estabelecida.
d280 1
a280 1
<h3>Split-Horizon DNS</h3>
d283 1
a283 1
É possível configurar servidores DNS para responder à pesquisas de
d286 1
a286 1
a resolução de nomes. Eles irão, portanto, se conectar diretamente
d288 1
a288 1
tráfego local, já que os pacotes não precisarão passar pelo firewall.
d291 1
a291 1
<h3>Movendo o Servidor Para uma Rede Local Separada</h3>
d294 1
a294 1
Acrescentando mais uma interface de rede ao firewall e movendo
d296 1
a296 1
o redirecionamento de conexões de clientes locais da mesma maneira
d299 3
a301 3
isolamento do servidor e dos clientes locais. Caso o servidor (que
em nosso caso é acessível pela Internet) seja comprometido, ele não
terá acesso direto aos hosts locais, porque todas as conexões devem
d309 2
a310 2
porta para ser transferida ou recebendo conexões redirecionadas na
interface interna para a porta onde ele esteja ouvindo. Quando um
d320 2
a321 2
>nc(1)</a>. A entrada <tt>/etc/inetd.conf</tt> a seguir cria um socket
escutando no endereço de loopback (127.0.0.1) na porta 5000.
d332 2
a333 2
A regra de redirecionamento a seguir transfere conexões na porta 80
na interface interna para o proxy
d359 1
a359 1
Isso fará com que o pacote inicial do cliente seja traduzido novamente
d362 1
a362 1
interno irá responder para o firewall, que pode então reverter ambas
d367 3
a369 3
de hosts externos (através de outros redirecionamentos) ou o próprio
firewall. Perceba que a regra <tt>rdr</tt> acima fará com que a pilha
TCP/IP receba pacotes na interface interna com endereço de destino
d377 1
a377 1
[<a href="nat.html">Anterior: Tradução do Endereço de Rede ("NAT")</a>]
d379 2
a380 1
[<a href="shortcuts.html">Próximo: Atalhos na Criação de Regras</a>]
d390 1
a390 1
$Translation: rdr.html,v 1.10 2009/06/22 13:19:16 alan Exp $<br>
@


1.9
log
@Sync with Steelix CVS
@
text
@d318 1
a318 1
escutando no endere&ccedil;o de loopback (127.0.0.1) na porta 5000.
d320 1
d323 1
a323 1
127.0.0.1:5000 stream tcp nowait nobody /usr/bin/nc nc -w \<br>
d385 2
a386 2
Originally [OpenBSD: rdr.html,v 1.27 ]<br>
$Translation: rdr.html,v 1.9 2009/05/10 17:44:16 alan Exp $<br>
@


1.8
log
@Sync with Steelix CVS
@
text
@d130 1
a130 1
Esses exemplos mostram portas entre 5000 a 5500 inclusive,
d385 1
a385 1
$Translation: rdr.html,v 1.8 2009/03/11 00:52:57 dsantos Exp $<br>
@


1.7
log
@Sync with Steelix CVS
@
text
@d4 1
a4 1
<title>PF: Redirecionamento de Tr&aacute;fego (Port Forwarding)</title>
d8 3
a10 3
<meta name="description" content="the OpenBSD FAQ page">
<meta name="keywords" content="openbsd,faq,pf">
<meta name="distribution" content="global">
d39 3
a41 3
[<a href="nat.html">Anterior: Tradu&ccedil;&atilde;o do Endere&ccedil;o de Rede (NAT)</a>]
[<a href="index.html">Conte&uacute;do</a>]
[<a href="shortcuts.html">Pr&oacute;ximo: Atalhos na Cria&ccedil;&atilde;o de Regras</a>]
d43 1
a43 1
<h1><font color="#e00000">PF: Redirecionamento (Port Forwarding)</font></h1>
d47 1
a47 1
<h3>Conte&uacute;do</h3>
d49 1
a49 1
<li><a href="#intro">Introdu&ccedil;&atilde;o</a>
d51 2
a52 2
<li><a href="#security">Implica&ccedil;&otilde;es de Seguran&ccedil;a</a>
<li><a href="#reflect">Redirecionamento e Reflex&atilde;o</a>
d55 2
a56 1
	<li><a href="#sepnet">Movendo o Servidor Para uma Rede Local Separada</a>
d58 1
a58 1
	<li><a href="#rdrnat">Combina&ccedil;&atilde;o de RDR e NAT</a>
d65 7
a71 7
<h2>Introdu&ccedil;&atilde;o</h2>
Quando voc&ecirc; utiliza NAT no seu escrit&oacute;rio, voc&ecirc; tem a Internet
inteira dispon&iacute;vel para todas as suas m&aacute;quinas.
Mas e se voc&ecirc; tiver uma m&aacute;quina atr&aacute;s do gateway 
NAT que precisa ser acessada de fora?  &Eacute; aqui que entra o redirecionamento.
Redirecionamento permite enviar tr&aacute;fego para uma m&aacute;quina atr&aacute;s do gateway
NAT.
d82 4
a85 3
Esta linha redireciona o tr&aacute;fego TCP na porta 80 (servidor web) para uma 
m&aacute;quina na rede com endere&ccedil;o 192.168.1.20.  Portanto, mesmo que 192.168.1.20
esteja atr&aacute;s do gateway dentro da rede, ela se torna acess&iacute;vel ao mundo externo.
d89 2
a90 2
muito bem utilizada. Se voc&ecirc; souber quais endere&ccedil;os ou subredes devem ter acesso
ao servidor na porta 80, pode restringi-los assim:
d99 6
a104 7
Isto ir&aacute; redirecionar somente a subrede especificada.  Perceba que isso 
implica que voc&ecirc; pode redirecionar diferentes hosts para m&aacute;quinas 
diferentes atr&aacute;s do gateway. O que pode ser muito &uacute;til. Por exemplo, 
voc&ecirc; pode fazer com que usu&aacute;rios em lugares remotos acessem seus 
pr&oacute;prios computadores desktop usando a mesma porta e endere&ccedil;o IP no gateway 
desde que voc&ecirc; saiba de que endere&ccedil;o IP eles se conectar&atilde;o.

d117 1
a117 2
Uma faixa de portas tamb&eacute;m pode ser redirecionada dentro
da mesma regra:
d130 8
a137 5
Estes exemplos mostram portas 5000 a 5500 inclusive, sendo redirecionadas
para 192.168.1.20.
Na regra #1, a porta 5000 &eacute; redirecionada para 5000, 5001 para 5001, etc.
Na regra #2, toda a faixa de portas &eacute; redirecionada para a porta 6000.
E na regra #3, a porta 5000 &eacute; redirecionada para 7000, 5001 para 7001, etc.
d141 2
a142 2
<font color="#ff0000">NOTA:</font> Pacotes traduzidos ainda devem passar 
pelo sistema de filtragem e ser&atilde;o bloqueados ou permitidos, com base 
d146 21
a166 19
A <i>&uacute;nica</i> exce&ccedil;&atilde;o a regra &eacute; quando a palavra-chave <tt>pass</tt> 
&eacute; usada na regra <tt>rdr</tt>. Neste caso, os pacotes redirecionados 
passar&atilde;o direto pelo sistema de filtragem: as regras de filtragem n&atilde;o 
ser&atilde;o avalidas para estes pacotes.
&Eacute; um atalho para evitar a adi&ccedil;&atilde;o de regras de filtragem <tt>pass</tt> para
cada regra de redirecionamento.
Pense nisso como uma regra <tt>rdr</tt> normal (sem a palavra-chave <tt>pass</tt>)
associada a uma regra de filtragem <tt>pass</tt> com a palavra-chave <tt>keep state</tt>.
Contudo, caso queira habilitar op&ccedil;&otilde;es de filtragem mais espec&iacute;ficas, como
<tt>synproxy</tt>, <tt>modulate state</tt>, etc, voc&ecirc; ainda precisar&aacute; usar 
regras <tt>pass</tt> dedicadas, j&aacute; que estas op&ccedil;&otilde;es n&atilde;o se encaixam 
em regras de redirecionamento.

<p>
Tamb&eacute;m fique ciente de que, como a tradu&ccedil;&atilde;o ocorre <i>antes</i> da filtragem,
o sistema de filtragem ver&aacute; os pacotes <i>traduzidos</i> como eles ficam 
ap&oacute;s a altera&ccedil;&atilde;o de seu endere&ccedil;o IP e/ou porta de destino terem sido 
alterados pela regra <tt>rdr</tt>.
Considere o cen&aacute;rio:
d170 2
a171 2
<li>24.65.1.13 - endere&ccedil;o externo do roteador OpenBSD
<li>192.168.1.5 - endere&ccedil;o IP interno do servidor WEB
d186 4
a189 3
<li>Endere&ccedil;o de origem: 192.0.2.1
<li>Porta de origem: 4028 (escolhida aleat&oacute;riamente pelo sistema operacional)
<li>Endere&ccedil;o de destino: 24.65.1.13
d194 1
a194 1
Pacote ap&oacute;s a regra <tt>rdr</tt> ter sido processada:
d196 1
a196 1
<li>Endere&ccedil;o de origem: 192.0.2.1
d198 1
a198 1
<li>Endere&ccedil;o de destino: 192.168.1.5
d203 2
a204 2
O sistema de filtragem v&ecirc; o pacote IP como ele se encontra ap&oacute;s ter 
sido feita a tradu&ccedil;&atilde;o.
d207 9
a215 9
<h2>Implica&ccedil;&otilde;es de Seguran&ccedil;a</h2>
Redirecionamento possui implica&ccedil;&otilde;es de seguran&ccedil;a. Fazer um furo no firewall
para permitir tr&aacute;fego para a rede interna protegida, cria um risco de
comprometimento da m&aacute;quina. Caso o tr&aacute;fego seja transmitido para um 
servidor web interno por exemplo, e uma vulnerabilidade seja descoberta 
no servidor ou num script CGI rodando no servidor web, a m&aacute;quina 
pode ser comprometida por um intruso na Internet. De l&aacute;, o intruso tem 
uma porta aberta para a rede interna, numa m&aacute;quina que tem permiss&atilde;o 
de passar pelo firewall.
d218 4
a221 3
Estes riscos podem ser minimizados mantendo-se os sistemas acessados 
externamente confinados numa rede separada. Essa rede &eacute; geralmente 
chamada de Zona Desmilitarizada (DMZ) ou Rede de Servi&ccedil;os Privada (PSN). 
d223 2
a224 2
limitados &agrave; rede DMZ/PSN pela filtragem cuidadosa do tr&aacute;fego que 
ter&aacute; permiss&atilde;o de entrar e sair da DMZ/PSN.
d227 4
a230 4
<h2>Redirecionamento e Reflex&atilde;o</h2>
Geralmente, regras de redirecionamento s&atilde;o usadas para transferir pedidos 
de conex&atilde;o da Internet para um servidor local com endere&ccedil;o IP privado na 
rede interna, ou LAN como:
d241 34
a274 34
Mas quando a regra de redirecionamento &eacute; testada por um cliente na LAN, 
ela n&atilde;o funciona. O motivo &eacute; que as regras de redirecionamento se aplicam 
apenas a pacotes que passam pela interface especificada (no exemplo a
interface <tt>$ext_if</tt>).
Conectar-se ao endere&ccedil;o externo do firewall de um host na LAN, contudo, 
n&atilde;o significa que os pacotes passar&atilde;o por sua interface externa. A pilha 
TCP/IP no firewall compara o endere&ccedil;o de destino do pacote chegando com 
seus pr&oacute;prios endere&ccedil;os e aliases e detecta conex&otilde;es para ela mesma
t&atilde;o logo tenham passado pela interface interna. Estes pacotes n&atilde;o passam
fisicamente pela interface externa, e a pilha TCP/IP n&atilde;o simula essa 
passagem de forma alguma. Portanto, o PF nunca ver&aacute; estes pacotes na 
interface externa, e a regra de redirecionamento, especificando a 
interface externa, n&atilde;o se aplicar&aacute;.

<p>
Adicionar uma segunda regra de redirecionamento para a interface interna 
tamb&eacute;m n&atilde;o produz o efeito desejado. Quando um cliente local se conecta 
ao endere&ccedil;o externo do firewall, o pacote inicial do handshake TCP 
atinge o firewall pela interface interna. A regra de redirecionamento 
&eacute; aplicada e o endere&ccedil;o de destino &eacute; substitu&iacute;do pelo do 
servidor interno. O pacote &eacute; transferido de volta pela interface interna e chega ao servidor 
interno. Mas o endere&ccedil;o de origem no pacote n&atilde;o foi alterado, contendo ainda
o endere&ccedil;o local do cliente, portanto o servidor envia suas respostas
diretamente ao cliente. O firewall nunca v&ecirc; as respostas, ficando sem
chance de reverter a tradu&ccedil;&atilde;o apropriadamente. O cliente ent&atilde;o recebe 
respostas de um endere&ccedil;o IP de onde ele nunca esperava, e por isso
descarta os pacotes. O handshake TCP falha e a conex&atilde;o n&atilde;o pode ser
estabelecida.

<p>
Mas ainda assim, geralmente &eacute; necess&aacute;rio que os clientes na LAN se 
conectem ao servidor interno da mesma forma que os 
clientes externos, e que o fa&ccedil;am de maneira transparente.
Existem v&aacute;rias solu&ccedil;&otilde;es para este problema:
d280 6
a285 6
&Eacute; poss&iacute;vel configurar servidores DNS para responder a pesquisas 
de clientes locais de maneira diferente das pesquisas externas, de forma 
que clientes locais receber&atilde;o o endere&ccedil;o interno do servidor durante 
a resolu&ccedil;&atilde;o de nomes. Eles ir&atilde;o, portanto, se conectar diretamente 
ao servidor local, e o firewall n&atilde;o tem envolvimento. Isso reduz o tr&aacute;fego 
local, j&aacute; que os pacotes n&atilde;o precisar&atilde;o passar pelo firewall.
d291 9
a299 9
Acrescenteando mais uma interface de rede ao firewall e movendo 
o servidor local da rede cliente para uma rede dedicada (DMZ) permite 
o redirecionamento de conex&otilde;es de clientes locais da mesma maneira 
que o redirecionamento de conex&otilde;es externas. O uso de redes separadas 
tr&aacute;z diversas vantagens, incluindo melhora na seguran&ccedil;a devido ao 
isolamento do servidor e dos clientes locais. Caso o servidor (que 
em nosso caso &eacute; acess&iacute;vel pela Internet) seja comprometido, ele n&atilde;o 
ter&aacute; acesso direto aos hosts locais, porque todas as conex&otilde;es 
devem agora passar pelo firewall.
d305 6
a310 5
Um proxy TCP gen&eacute;rico pode ser configurado no firewall, escutando na 
porta para ser transferido ou recebendo conex&otilde;es redirecionadas na interface interna 
para a porta onde ele esteja ouvindo. Quando um cliente local se conecta 
ao firewall, o proxy aceita a conex&atilde;o, estabelece uma segunda conex&atilde;o com 
o servidor interno e transfere dados entre as duas conex&otilde;es.
d314 1
a314 2
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;sektion=8"
d316 1
a316 2
<a
href="http://www.openbsd.org/cgi-bin/man.cgi?query=nc&amp;sektion=1"
d319 1
a319 1
As conex&otilde;es s&atilde;o encaminhadas ao servidor 192.168.1.10 na porta 80.
d328 1
a328 1
A regra de redirecionamento a seguir transfere conex&otilde;es na porta 80 
d338 1
a338 1
<h3>Combina&ccedil;&atilde;o de RDR e NAT</h3>
d341 2
a342 2
Com uma regra NAT adicional na interface interna, a tradu&ccedil;&atilde;o de 
endere&ccedil;o que estava faltando no cen&aacute;rio acima pode ser remediada.
d355 21
a375 19
Isso far&aacute; com que o pacote inicial do cliente seja traduzido novamente
quando retornar atrav&eacute;s da interface interna, substituindo o endere&ccedil;o de 
origem do cliente pelo endere&ccedil;o interno do firewall. O servidor interno 
ir&aacute; responder para o firewall, que pode ent&atilde;o reverter ambas as regras de
tradu&ccedil;&atilde;o NAT e RDR ao transferir o pacote para o cliente. Esta 
constru&ccedil;&atilde;o &eacute; um tanto complexa, pois cria dois estados separados para 
cada conex&atilde;o refletida. Deve-se tomar muito cuidado para evitar que a regra NAT 
atinja outro tr&aacute;fego, por exemplo conex&otilde;es originadas de hosts externos 
(atrav&eacute;s de outros redirecionamentos) ou o pr&oacute;prio firewall. Perceba que 
a regra <tt>rdr</tt> acima far&aacute; com que a pilha TCP/IP receba pacotes 
na interface interna com endere&ccedil;o de destino dentro da rede interna.

<p>
De prefer&ecirc;ncia, deve-se utilizar uma das solu&ccedil;&otilde;es apresentadas anteriormente. 

<p>
[<a href="nat.html">Anterior: Tradu&ccedil;&atilde;o do Endere&ccedil;o de Rede (NAT)</a>]
[<a href="index.html">Conte&uacute;do</a>]
[<a href="shortcuts.html">Pr&oacute;ximo: Atalhos na Cria&ccedil;&atilde;o de Regras</a>]
d385 1
a385 1
$Translation: rdr.html,v 1.7 2007/11/24 18:12:31 dsantos Exp $<br>
d387 1
a387 1
$OpenBSD$ 
@


1.6
log
@sync with Steelix CVS
@
text
@d206 1
a206 1
no daemon do servidor ou num script CGI rodando no servidor web, a m&aacute;quina 
d307 1
a307 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;sektion=8&amp;manpath=OpenBSD+4.0"
d310 1
a310 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=nc&amp;sektion=1&amp;manpath=OpenBSD+4.0"
d376 2
a377 2
Originally [OpenBSD: rdr.html,v 1.26 ]<br>
$Translation: rdr.html,v 1.6 2006/11/21 01:54:24 dsantos Exp $<br>
@


1.5
log
@sync with steelix translation CVS
@
text
@d307 1
a307 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;sektion=8&amp;manpath=OpenBSD+3.9"
d310 1
a310 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=nc&amp;sektion=1&amp;manpath=OpenBSD+3.9"
d376 2
a377 2
Originally [OpenBSD: rdr.html,v 1.25 ]<br>
$Translation: rdr.html,v 1.5 2006/05/28 17:23:03 dsantos Exp $<br>
@


1.4
log
@sync with steelix translation CVS
@
text
@d307 1
a307 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;sektion=8&amp;manpath=OpenBSD+3.8"
d310 1
a310 1
href="http://www.openbsd.org/cgi-bin/man.cgi?query=nc&amp;sektion=1&amp;manpath=OpenBSD+3.8"
d376 2
a377 2
Originally [OpenBSD: rdr.html,v 1.24 ]<br>
$Translation: rdr.html,v 1.4 2005/11/15 14:36:42 dsantos Exp $<br>
@


1.3
log
@sync with Steelix CVS
@
text
@d306 2
a307 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;sektion=8&amp;manpath=OpenBSD+3.7"
d309 2
a310 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=nc&amp;sektion=1&amp;manpath=OpenBSD+3.7"
d375 4
a378 2
Originally [OpenBSD: rdr.html,v 1.23 ]<br>
$Translation: rdr.html,v 1.3 2005/06/30 20:56:33 dsantos Exp $<br>
@


1.2
log
@sync with Steelix CVS
@
text
@d15 1
a15 1
Copyright (c) 2003, 2004, Joel Knight <enabled@@myrealbox.com>
d115 21
d373 2
a374 2
Originally [OpenBSD: rdr.html,v 1.22 ]<br>
$Translation: rdr.html,v 1.2 2005/05/27 15:11:33 dsantos Exp $<br>
@


1.1
log
@sync with steelix translation CVS
@
text
@d285 1
a285 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;sektion=8&amp;manpath=OpenBSD+3.6"
d287 1
a287 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=nc&amp;sektion=1&amp;manpath=OpenBSD+3.6"
d352 2
a353 2
Originally [OpenBSD: rdr.html,v 1.21 ]<br>                                                      
$Translation: rdr.html,v 1.1 2005/01/04 17:09:07 dsantos Exp $<br>                 
@

