head	1.11;
access;
symbols;
locks; strict;
comment	@# @;


1.11
date	2014.04.01.17.14.10;	author nick;	state dead;
branches;
next	1.10;

1.10
date	2011.02.20.10.08.24;	author ajacoutot;	state Exp;
branches;
next	1.9;

1.9
date	2011.02.17.23.28.45;	author ajacoutot;	state Exp;
branches;
next	1.8;

1.8
date	2004.08.31.16.10.23;	author saad;	state Exp;
branches;
next	1.7;

1.7
date	2004.01.04.22.29.12;	author horacio;	state Exp;
branches;
next	1.6;

1.6
date	2003.12.03.21.40.56;	author horacio;	state Exp;
branches;
next	1.5;

1.5
date	2003.11.17.19.44.24;	author horacio;	state Exp;
branches;
next	1.4;

1.4
date	2003.09.27.14.55.54;	author horacio;	state Exp;
branches;
next	1.3;

1.3
date	2003.09.20.07.00.26;	author horacio;	state Exp;
branches;
next	1.2;

1.2
date	2003.07.13.13.11.41;	author jufi;	state Exp;
branches;
next	1.1;

1.1
date	2003.07.04.22.43.46;	author jufi;	state Exp;
branches;
next	;


desc
@@


1.11
log
@
Abandon translations, per deraadt@@ and ajacoutot@@.
@
text
@<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Ejemplo: Cortafuegos para red doméstica u oficina</title>
<link rev="made" href="mailto:www@@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../es/index.html">
<img alt="[OpenBSD]" height="30" width="141" src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="carp.html">Anterior: Redundancia de cortafuegos con CARP y pfsync</a>]
[<a href="index.html">Contenido</a>]


<p>
<h1><font color="#e00000">PF: Ejemplo: Cortafuegos para una red doméstica 
o una oficina</font></h1>
<hr>

<h3>Índice de contenidos</h3>
<ul>
<li><a href="#scenario">El escenario</a>
	<ul>
	<li><a href="#network">La red</a>
	<li><a href="#objective">El objetivo</a>
	<li><a href="#prep">Preparación</a>
	</ul>
<li><a href="#ruleset">El grupo de reglas</a>
	<ul>
	<li><a href="#macros">Macros</a>
	<li><a href="#options">Opciones</a>
	<li><a href="#rules">Reglas de cortafuegos</a>
	</ul>
<li><a href="#allrules">El grupo de reglas completo</a>
</ul>

<hr>

<a name="scenario"></a>
<h2>El escenario</h2>
<p>
En este ejemplo, PF funciona en una máquina OpenBSD que actúa como
cortafuegos y pasarela de NAT para una pequeña red en casa o en
la oficina.  El objetivo final es el de dar acceso a Internet desde
la red, permitir un acceso limitado a la máquina cortafuegos
desde Internet y exponer un servidor web interno a Internet.  
En este documento se repasa un grupo de reglas completo
con este fin.

<a name="network"></a>
<h3>La red</h3>
<p>
La configuración de la red es como sigue:

<pre>
    
  [ COMP1 ]    [ COMP3 ]
      |            |                               
   ---+------+-----+------- xl0 [ OpenBSD ] fxp0 -------- ( Internet )
             |
         [ COMP2 ]

</pre>

<p>
En la red interna hay varios ordenadores;  el diagrama muestra
sólo tres, aunque el número real es irrelevante.  
Estos ordenadores son estaciones de trabajo normales que se
usan para navegar por la web, correo electrónico, charlas
en línea (<i>chats</i>), etc., excepto COMP3 que además corre un pequeño
servidor web.
La red interna usa el bloque de red 192.168.0.0 / 255.255.255.0.

<p>
El cortafuegos OpenBSD es un Celeron 300 con dos tarjetas de red: una 3Com
3c905B (<tt>xl0</tt>) y una Intel EtherExpress Pro/100 (<tt>fxp0</tt>).  
El cortafuegos tiene una conexión de cable a
Internet y está usando NAT para compartir esta conexión
con la red interna.  La dirección IP en la interfaz externa la
asigna de forma dinámica el proveedor de Internet (ISP).

<a name="objective"></a>
<h3>El objetivo</h3>
Los objetivos son:
<ul>
<li>Dar acceso a Internet sin restricciones a cada uno de los
ordenadores internos.
<li>Usar un grupo de reglas de filtrado con &laquo;denegación
predeterminada&raquo;.
<li>Permitir el paso del siguiente tráfico entrante al
cortafuegos desde Internet:
	<ul>
	<li>SSH (TCP puerto 22): se usará para el mantenimiento
	remoto de la máquina cortafuegos.
	<li>Auth/Ident (TCP puerto 113): usado por algunos servicios como
	SMTP e IRC.
	<li>ICMP Echo Requests: el tipo de paquete ICMP usado por
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8"
>ping(8)</a>.
	</ul>
<li>Redireccionar intentos de conexión al puerto TCP 80 (accesos a un servidor
	web) a la máquina COMP3.
Permitir también el tráfico por el puerto TCP 80 destinado a COMP3 a través
	del cortafuegos.
<li>Registrar estadísticas de filtrado en la interfaz externa.
<li>Contestar, de modo predeterminado, con un TCP RST o <i>ICMP
Unreachable</i> a los paquetes bloqueados.
<li>Conseguir un grupo de reglas tan simple y fácil de mantener
como sea posible.
</ul>

<a name="prep"></a>
<h3>Preparación</h3>
<p>
En este documento se asume que se ha configurado correctamente el
anfitrión con OpenBSD para que funcione como un enrutador,
incluida la verificación de la configuración de redes IP,
la conexión a Internet y haber configurado las variables 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=3"
>sysctl(3)</a> <tt>net.inet.ip.forwarding</tt> 
y/o <tt>net.inet6.ip6.forwarding</tt> con el valor "<tt>1</tt>".

<a name="ruleset"></a>
<h2>El grupo de reglas</h2>
<p>
A continuación construiremos un grupo de reglas que
lograrán los objetivos anteriores.

<a name="macros"></a>
<h3>Macros</h3>
<p>
Las siguientes macros se han definido para facilitar el mantenimiento y
la lectura del grupo de reglas:
<blockquote><pre>
int_if="xl0"

tcp_services="{ 22, 113 }"
icmp_types="echoreq"

comp3="192.168.0.3"
</pre></blockquote>

<p>
La primera línea define la interfaz de red interna en la que
tendrá lugar el filtrado.
Al definirlas aquí, si tenemos que mover este sistema a otra
máquina con diferente hardware, podemos cambiar solo estas dos
líneas, y el resto de reglas seguirán siendo válidas.
(Para este ejemplo, la interfaz externa será manejada usando 
la interfaz de grupo <tt>egress</tt>.
Esto es automáticamente configurado en cualquier interfaz que 
contenga una ruta por defecto, en este caso fxp0).
La segunda y tercera líneas son una lista de los números de 
puertos TCP de los servicios que se abrirán a Internet 
(SSH e ident/auth) y de los tipos de paquetes ICMP a los se 
que les permitirá llegar a la máquina cortafuegos. 
Finalmente, la última línea define la dirección IP de COMP3.

<p>
<b>Nota</b>: Si la conexión de Internet requiere
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=4"
>PPPoE</a>, entonces el filtrado y el NAT tendrían que realizarse 
en la interfaz <tt>pppoe0</tt>y <i>no</i> en <tt>fxp0</tt>.

<a name="options"></a>
<h3>Opciones</h3>
<p>
Con las siguientes dos opciones se configura la respuesta predeterminada
para las reglas de filtrado <tt>block</tt>, y se activa el registro de
estadísticas para la interfaz externa:
<blockquote><pre>
set block-policy return
set loginterface fxp0
</pre></blockquote>

<p>
Todo sistema Unix tiene una interfaz de retrobucle (<i>loopback</i>). Se trata de
una interfaz virtual de red que usan las aplicaciones para comunicarse
entre sí mismas dentro del sistema.  En OpenBSD, la
interfaz de <i>loopback</i> es
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4"
>lo(4)</a>. Se considera una buena práctica desactivar todo filtrado
en las interfaces <i>loopback</i>.
Por medio de <a href="options.html#skip">set skip</a> lograremos esto:
<blockquote><pre>
set skip on lo
</pre></blockquote>
<!-- XXX this should be interface groups, but PF (at least up to
 4.8) just does a substring match on the interface name -->
Tenga en cuenta que nos estamos saltando el filtrado para todos los 
interfaces <tt>lo</tt>. De esta manera, si más tarde debemos añadir 
interfaces <i>loopback</i> suplementarios, no tendríamos que preocuparnos 
por la modificación de esta parte de nuestro actual fichero de reglas.

<a name="rules"></a>
<h3>Reglas del cortafuegos</h3>

Comenzaremos con las reglas para soportar el uso de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.8"
>ftp-proxy(8)</a>, 
de modo que los clientes FTP en la red local puede conectarse 
a servidores FTP en Internet. Esto funciona mediante 
la inserción dinámica de las reglas cuando se realiza una conexión 
ftp. Se hace por medio de un <a href="anchors.html">anclaje</a>:
<blockquote><pre>
anchor "ftp-proxy/*"
</pre></blockquote>

<p>
Ahora añadiremos la regla que permita la redirección 
de las conexiones FTP para que puedan ser vistas por 
ftp-proxy(8):
<blockquote><pre>
pass in quick on $int_if inet proto tcp to any port ftp \
    rdr-to 127.0.0.1 port 8021
</pre></blockquote>

<p>
Esta regla interceptará las conexiones FTP en el puerto 21 
y las redirigirá a una instancia ftp-proxy(8) que se ejecuta 
en el puerto 8021 y, a través del uso de la palabra clave 
<tt>quick</tt>, los paquetes válidos no serán 
verificados por el resto del conjunto de reglas. 
Si los usuarios se conectan regularmente a los servidores FTP 
en otros puertos, entonces se debe utilizar una lista para 
especificar el puerto de destino, por ejemplo: 
<tt>to any port { 21, 2121 }</tt>.

<p>
Hay que subrayar que tanto el <a href="anchors.html">anclaje</a> como la regla
de redirección 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.8"
>ftp-proxy(8)</a> necesitan ser situados antes de cualquier 
regla <tt>match</tt> para el NAT o el ftp-proxy(8) no funcionará
como se espera.

<p>
Ahora vamos a ver las reglas <tt>match</tt>. 
Por sí misma, una regla <tt>match</tt> no determina 
si a un paquete se le permite o no pasar. En cambio, 
se almacenarán los parámetros de los paquetes que coincidan 
con esta regla y se utilizarán en cualquier regla
<tt>pass</tt> que luego valide estos paquetes.

<p>
Esto es potente: parámetros tales como <a href="nat.html">NAT</a>
o <a href="queueing.html">formación de colas</a> (<i>queueing</i>) 
pueden aplicarse a ciertas clases de paquetes y los permisos de acceso 
definirse después por separado.

<p>
Para disponer de NAT en toda la red interna se utiliza la siguiente regla
<tt>match</tt>:
<blockquote><pre>
match out on egress inet from !(egress:network) to any nat-to (egress:0)
</pre></blockquote>

<p>
En este caso, el "<tt>!(egress:network)</tt>" podría ser fácilmente 
reemplazado por un "<tt>$int_if:network</tt>", pero si usted ha agregado 
múltiples interfaces internas, habría que añadir reglas NAT adicionales, 
mientras que con esta estructura NAT será manejado en todas las interfaces 
protegidas.

<p>
Dado que la dirección IP de la interfaz externa se asigna dinámicamente,
los paréntesis se colocan en torno a la interfaz de traducción para que PF
sea avisado cuando la dirección cambia.
El sufijo :0 se utiliza para que si la interfaz externa tiene múltiples
direcciones, sólo la primera dirección se utilice para la traducción.

<p>
Para acabar, se especifica la familia de protocolos <tt>inet</tt> (IPv4)
Esto suprime la traducción de todos los paquetes <tt>inet6</tt> (IPv6)
que puedan ser recibidos. 

<p>
Ahora las reglas para controlar los permisos de acceso.
Se empieza con una denegación de forma predeterminada:
<blockquote><pre>
block in log
</pre></blockquote>

<p>
En este punto todo el tráfico que intenta entrar en la interfaz será
bloqueado, incluso el que proviene de la red interna. 
Estos paquetes también son logueados.
Las reglas siguientes abrirán el cortafuegos de acuerdo con los objetivos
descritos anteriormente, y abrirán también todos los interfaces virtuales
necesarios.

<p>
Tenga en cuenta que pf puede bloquear el tráfico entrante o saliente 
de un interfaz.
Puede simplificar su vida si usted elige filtrar el tráfico en una
dirección, en lugar de tratar de bloquear entrada y salida.
En nuestro caso, optaremos por filtrar únicamente el tráfico de entrada, 
pero una vez permitida la entrada en una interfaz, no vamos a 
tratar de obstruir la salida, por lo que haremos lo siguiente:

<blockquote><pre>
pass out quick
</pre></blockquote>

Utilizando <tt>quick</tt> puede evitarse que los paquetes salientes sean
verificados contra las reglas siguientes, mejorando así el rendimiento.

<p>
Es útil usar también la <a href="filter.html#antispoof">protección contra 
la falsificación de direcciones</a> (<i>antispoofing</i>):
<blockquote><pre>
antispoof quick for { lo $int_if }
</pre></blockquote>

<p>
Ahora abrimos los puertos usados por los servicios de red
que estarán disponibles desde Internet.
Primero, el tráfico que se destina al cortafuegos mismo: 

<blockquote><pre>
pass in on egress inet proto tcp from any to (egress) \
    port $tcp_services
</pre></blockquote>

<p>
Especificar los puertos de red en la macro 
<tt>$tcp_services</tt> simplifica la apertura 
de servicios adicionales a Internet, simplemente mediante
la edición de la macro y la recarga del conjunto de reglas. 
Los servicios UDP también pueden abrirse mediante la creación de 
una macro <tt>$udp_services</tt> y la adición de una regla de filtrado,
similar a la indicada anteriormente, que especifique <tt>proto udp</tt>.

<p>
La siguiente regla captura cualquier intento de conexión desde Internet 
por medio del puerto TCP 80 del cortafuegos.
Los intentos legítimos para acceder a este puerto procederán de usuarios 
que tratan de acceder al servidor web de la red.
Estos intentos de conexión deben ser redirigidos a COMP3:

<blockquote><pre>
pass in on egress inet proto tcp to (egress) port 80 \
    rdr-to $comp3 synproxy state
</pre></blockquote>

<p>
Para incrementar un poco la seguridad, usaremos el 
<a href="filter.html#synproxy">proxy de paquetes TCP SYN</a> 
con el fin de proteger el servidor web.

<p>
Debe permitirse el tráfico ICMP:
<blockquote><pre>
pass in inet proto icmp all icmp-type $icmp_types
</pre></blockquote>

<p>
Similar a la macro <tt>$tcp_services</tt>, la macro <tt>$icmp_types</tt> 
puede fácilmente ser modificada para alterar los tipos de paquetes ICMP
que serán autorizados a alcanzar el cortafuegos. Téngase en cuenta que esta
regla se aplica a todas las interfaces de red.

<p>
Ahora el tráfico de la red interna debe ser permitido. 
Asumimos que los usuarios de la red interna
saben lo que hacen y no causarán problemas. Esto no es
 necesariamente una asunción válida para muchos
entornos; para muchos otros contextos pueden ser más apropiado  
un conjunto de reglas más restrictivo.
<blockquote><pre>
pass in on $int_if
</pre></blockquote>

<p>
Se permite que el tráfico TCP, UDP y ICMP salga del cortafuegos
hacia Internet gracias a la regla precedente "<tt>pass out</tt>".  
La información sobre el estado se guarda para
que los paquetes de vuelta pasen a través del cortafuegos.

<a name="allrules"></a>
<h2>El grupo de reglas completo</h2>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# macros

int_if="xl0"

tcp_services="{ 22, 113 }"
icmp_types="echoreq"

comp3="192.168.0.3"

# opciones

set block-policy return
set loginterface fxp0
set skip on lo

# reglas proxy FTP

anchor "ftp-proxy/*"

pass in quick on $int_if inet proto tcp to any port ftp \
    rdr-to 127.0.0.1 port 8021

# reglas match

match out on egress inet from !(egress) to any nat-to (egress:0)

# reglas de filtrado

block in log
pass out quick

antispoof quick for { lo $int_if }

pass in on egress inet proto tcp from any to (egress) \
    port $tcp_services

pass in on egress inet proto tcp to (egress) port 80 \
    rdr-to $comp3 synproxy state

pass in inet proto icmp all icmp-type $icmp_types

pass in on $int_if
</pre>
</td></tr>
</table>

<p>
[<a href="carp.html">Anterior: Redundancia de cortafuegos con CARP y pfsync</a>]
[<a href="index.html">Contenido</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24"
src="../../../images/back.gif" border="0" alt="[back]"></a>
<a href="mailto:www@@openbsd.org">www@@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: example1.html,v 1.45 ]<br>
$Translation: example1.html,v 1.12 2011/02/18 11:31:01 mvidal Exp $<br>
-->
$OpenBSD: example1.html,v 1.10 2011/02/20 10:08:24 ajacoutot Exp $
</small>

</body>
</html> 
@


1.10
log
@Sync with Steelix CVS
@
text
@d473 1
a473 1
$OpenBSD$
@


1.9
log
@Sync with Steelix CVS
@
text
@d43 2
a44 2
<h1><font color="#e00000">PF: Ejemplo: Cortafuegos para red doméstica 
u oficina</font></h1>
d471 1
a471 1
$Translation: example1.html,v 1.11 2011/02/16 14:46:56 mvidal Exp $<br>
@


1.8
log
@sync with Steelix CVS
@
text
@d4 1
a4 1
<title>PF: Ejemplo #1: Cortafuegos para Red en Casa u Oficina</title>
d7 3
a9 4
<meta http-equiv="Content-Language" content="es">
<meta name="resource-type" content="documento">
<meta name="description"   content="Preguntas Frecuentes de PF">
<meta name="keywords"      content="openbsd,preguntas frecuentes,faq,pf">
a10 1
<meta name="copyright"     content="Este documento es copyright 2003-2004 de OpenBSD.">
d13 17
d31 2
d34 3
a36 1
<img alt="[OpenBSD]" height="30" width="141" src="../../../images/smalltitle.gif">
d38 1
a38 2
[<a href="authpf.html">Anterior: Authpf: <i>Shell</i> de Usuario para la
Autenticaci&oacute;n de Pasarelas</a>]
d41 1
d43 2
a44 2
<h1><font color="#e00000">PF: Ejemplo: Cortafuegos para Red en Casa u
Oficina</font></h1>
d47 1
a47 1
<h3>&Iacute;ndice de Contenidos</h3>
d49 1
a49 1
<li><a href="#scenario">El Escenario</a>
d51 3
a53 3
	<li><a href="#network">La Red</a>
	<li><a href="#objective">El Objetivo</a>
	<li><a href="#prep">Preparaci&oacute;n</a>
d55 1
a55 1
<li><a href="#ruleset">El Grupo de Reglas</a>
d59 1
a59 4
	<li><a href="#scrub">Normalizaci&oacute;n</a>
	<li><a href="#nat">Traducci&oacute;n de Direcciones de Red</a>
	<li><a href="#rdr">Redireccionamiento</a>
	<li><a href="#filter">Reglas de Filtrado</a>
d61 1
a61 1
<li><a href="#allrules">El Grupo de Reglas Completo</a>
d67 1
a67 1
<h2>El Escenario</h2>
d69 6
a74 5
En este ejemplo, PF es parte de un sistema OpenBSD que act&uacute;a como
cortafuegos y pasarela de NAT para una peque&ntilde;a red en casa o en
la oficina.  El objetivo final es el de dar acceso hacia Internet desde
la red, y permitir un acceso limitado a la m&aacute;quina cortafuegos
desde Internet.  En este documento se repasa un grupo de reglas completo
d78 1
a78 1
<h3>La Red</h3>
d80 1
a80 1
La configuraci&oacute;n de la red es como sigue:
d85 2
a86 2
      |            |                               ADSL
   ---+------+-----+------- fxp0 [ OpenBSD ] ep0 -------- ( Internet )
d94 4
a97 4
s&oacute;lo tres (COMP1, ... COMP3), aunque el n&uacute;mero real no es
relevante.  Estos ordenadores son estaciones de trabajo normales que se
usan para navegar por la <i>web</i>, correo electr&oacute;nico, charlas
interactivas (<i>chats</i>), etc., excepto COMP3 que además corre un pequeño
d102 6
a107 6
El enrutador con OpenBSD es un Pentium 100 con dos tarjetas de red:  una
3com 3c509B (<tt>ep0</tt>) y una Intel EtherExpress Pro/100
(<tt>fxp0</tt>).  El enrutador tiene una conexi&oacute;n de ADSL a
Internet, y est&aacute; usando NAT para compartir esta conexi&oacute;n
con la red interna.  La direcci&oacute;n IP en la interfaz externa la
asigna de forma din&aacute;mica el Proveedor de Internet.
d110 1
a110 2
<h3>El Objetivo</h3>
<p>
d113 1
a113 1
<li>Dar un acceso a Internet sin restricciones a cada uno de los
d115 1
a115 1
<li>Usar un grupo de reglas de filtrado con &laquo;denegaci&oacute;n
d117 1
a117 1
<li>Permitir el paso del siguiente tr&aacute;fico entrante al
d120 2
a121 2
	<li>SSH (TCP puerto 22): se usar&aacute; para el mantenimiento
	remoto de la m&aacute;quina cortafuegos.
d123 1
a123 1
	SMTP y IRC.
d125 2
a126 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8&amp;manpath=OpenBSD+3.5">ping(8)</a>.
d129 5
a133 5
	web) a la computadora COMP3.
<li>Permitir también el tráfico por el puerto TCP 80 destinado a COMP3 a través
	del firewall
<li>Registrar estad&iacute;sticas de filtrado en la interfaz externa.
<li>Contestar, de modo predeterminado, con un <i>TCP RST</i> o <i>ICMP
d135 1
a135 1
<li>Conseguir un grupo de reglas tan simple y f&aacute;cil de mantener
d140 1
a140 1
<h3>Preparaci&oacute;n</h3>
d143 6
a148 4
anfitri&oacute;n con OpenBSD para que funcione como un enrutador,
incluida la verificaci&oacute;n de la configuraci&oacute;n de redes IP,
la conexi&oacute;n a Internet, y haber configurado
<tt>net.inet.ip.forwarding</tt> con el valor &quot;<tt>1</tt>&quot;.
d151 1
a151 1
<h2>El Grupo de Reglas</h2>
d153 2
a154 2
A continuaci&oacute;n construiremos un grupo de reglas que
conseguir&aacute; los objetivos anteriores.
d161 8
a168 14
<blockquote>
<tt>
int_if = &quot;fxp0&quot;<br>
ext_if = &quot;ep0&quot;<br>
<br>
tcp_services = &quot;{ 22, 113 }&quot;<br>
icmp_types = &quot;echoreq&quot;<br>
<br>
priv_nets = &quot;{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }&quot;
<br>
<br>
comp3 = "192.168.0.3"
</tt>
</blockquote>
d171 13
a183 8
Las primeras dos l&iacute;neas definen las interfaces de red en las que
tendr&aacute; lugar el filtrado.  La tercera y cuarta l&iacute;neas son
una lista de los n&uacute;meros de puertos TCP de los servicios que se
abrir&aacute;n a Internet (SSH y ident/auth) y de los tipos de paquetes
ICMP a los se que les permitir&aacute; llegar a la m&aacute;quina
cortafuegos.  La quinta l&iacute;nea define la direcci&oacute;n
de <i>loopback</i> y los bloques de direcciones
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>.
d187 4
a190 4
<b>Nota</b>: Si la conexi&oacute;n de Internet ADSL requiere
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=8&amp;manpath=OpenBSD+3.5">PPPoE</a>,
entonces el filtrado y NAT tendr&aacute;n que realizarse en la interfaz
<tt>tun0</tt>, y <i>no</i> en la <tt>ep0</tt>.
d197 5
a201 87
estad&iacute;sticas para la interfaz externa:
<blockquote>
<tt>
set block-policy return<br>
set loginterface $ext_if
</tt>
</blockquote>

<a name="scrub"></a>
<h3>Normalizaci&oacute;n (<i>scrub</i>)</h3>
<p>
No hay motivo para no usar la normalizaci&oacute;n recomendada en todo
el tr&aacute;fico entrante, as&iacute; que aqu&iacute; va una simple
l&iacute;nea:
<blockquote>
<tt>
scrub in all
</tt>
</blockquote>

<a name="nat"></a>
<h3>Traducci&oacute;n de Direcciones de Red (<i>NAT</i>)</h3>
<p>
Para llevar a cabo el servicio de NAT en toda la red interna, se usa la
siguiente regla de <tt>nat</tt>:
<blockquote>
<tt>
nat on $ext_if from $int_if:network to any -&gt; ($ext_if)
</tt>
</blockquote>

<p>
Como la direcci&oacute;n IP en la interfaz interna se asigna de forma
din&aacute;mica, se usan par&eacute;ntesis alrededor de la interfaz de
traducci&oacute;n para que PF sepa cu&aacute;ndo cambia la
direcci&oacute;n.

<a name="rdr"></a>
<h3>Redireccionamiento</h3>
<p>
La primera regla de redireccionamiento se necesita para
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+3.5">ftp-proxy(8)</a>,
de modo que los clientes de FTP en la red local puedan conectarse a
servidores de FTP en Internet.
<blockquote>
<tt>
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 port 8021
</tt>
</blockquote>

<p>
N&oacute;tese que esta regla s&oacute;lo servir&aacute; para conexiones
de FTP al puerto 21.  Si los usuarios se conectan a servidores de FTP
por otros puertos, entonces se debe usar una lista que especifique el
puerto de destino;  por ejemplo:
<tt>from any to any port { 21, 2121 }</tt>.

<p>
la segunda recla de redireccionamiento atrapa cualquier intento de conexión
desde Internet hacia el puerto TCP 80 en el corta fuegos.
Intentos legítimos de acceso a este puerto serán realizados por usuarios que
intentan acceder al servidor web de la red.
Estos intentos de conexión necesitan ser redirigidos a COMP3:

<blockquote>
<tt>
rdr on $ext_if proto tcp from any to any port 80 -&gt; $comp3
</tt>
</blockquote>

<a name="filter"></a>
<h3>Reglas de Filtrado</h3>
<p>
Ahora vienen las reglas de filtrado.  Empezaremos con la
denegaci&oacute;n predeterminada:
<blockquote>
<tt>
block all<br>
</tt>
</blockquote>

<p>
En este punto nada pasar&aacute; por el cortafuegos, ni siquiera desde
la red interna.  Las siguientes reglas ir&aacute;n abriendo el
cortafuegos paso a paso para que se puedan alcanzar los objetivos que se
han propuesto, y adem&aacute;s abrir&aacute;n cualquier interfaz virtual
que sea necesaria.
d204 1
a204 1
Todo sistema Unix tiene una interfaz de <i>loopback</i>.  &Eacute;sta es
d206 1
a206 2
entre s&iacute; mismas dentro del sistema.  Todo el tr&aacute;fico
deber&iacute;a pasar por la interfaz de <i>loopback</i>.  En OpenBSD, la
d208 198
a405 149
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4&amp;manpath=OpenBSD+3.5">lo(4)</a>.
<blockquote>
<tt>
pass quick on lo0 all
</tt>
</blockquote>

<p>
A continuaci&oacute;n se bloquear&aacute;n las direcciones
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a> para
evitar que entren a, o salgan desde, la interfaz externa.  Estas
direcciones nunca deben aparecer en p&uacute;blico en Internet,
y filtr&aacute;ndolas nos aseguraremos de que el enrutador no
&laquo;muestra&raquo; estas direcciones fuera de la red interna, y
tambi&eacute;n bloquearemos cualquier paquete entrante que tenga como
direcci&oacute;n de origen una de esas redes.
<blockquote>
<tt>
block drop in &nbsp;quick on $ext_if from $priv_nets to any<br>
block drop out quick on $ext_if from any to $priv_nets
</tt>
</blockquote>

<p>
N&oacute;tese que se usa <tt>block drop</tt> para indicar a PF que no
responda con un paquete TCP RST o ICMP Unreachable.  Como las
direcciones RFC 1918 no existen en Internet, cualquier paquete que se
env&iacute;e a esas direcciones nunca llegar&aacute;.  La opci&oacute;n
<tt>quick</tt> se usa para indicar a PF que no eval&uacute;e el resto de
las reglas de filtrado si concuerda alguna de las reglas anteriores;
los paquetes hacia o desde las redes <tt>$priv_nets</tt> se
bloquear&aacute;n inmediatamente.

<p>
Ahora abriremos los puertos usados por aquellos servicios de red que
estar&aacute;n disponibles por Internet:
<blockquote>
<tt>
pass in on $ext_if inet proto tcp from any to ($ext_if) \<br>
&nbsp;&nbsp;&nbsp;port $tcp_services flags S/SA keep state
</tt>
</blockquote>

<p>
Especificar los puertos de red en la macro <tt>$tcp_services</tt> hace
que sea m&aacute;s simple abrir servicios adicionales a Internet,
simplemente editando la macro y recargando el grupo de reglas.  Los
servicios de UDP tambi&eacute;n se pueden abrir mediante la
creaci&oacute;n de una macro <tt>$udp_services</tt> y a&ntilde;adiendo
una regla de filtrado parecida a la anterior que especifique <tt>proto
udp</tt>.

<p>
Además de tener una regla <tt>rdr</tt> que redirija el tráfico del
servidor web a COMP3, también DEBEMOS dejar pasar este tráfico a través
del corta fuegos:
<blockquote>
<tt>
pass in on $ext_if proto tcp from any to $comp3 port 80 \<br>
&nbsp;&nbsp;&nbsp;&nbsp;flags S/SA synproxy state
</tt>
</blockquote>

<p>
Como una medida de seguridad adicional, usaremos
<a href="filter.html#synproxy">TCP SYN Proxy</a> para proteger aún más el
servidor web.

<p>

Ahora debemos dejar pasar el tr&aacute;fico ICMP:
<blockquote>
<tt>
pass in inet proto icmp all icmp-type $icmp_types keep state
</tt>
</blockquote>

<p>
De forma parecida a la macro <tt>$tcp_services</tt>, la macro
<tt>$icmp_types</tt> se puede editar f&aacute;cilmente para cambiar los
tipos de paquetes ICMP a los que se permitir&aacute; alcanzar el
cortafuegos.  N&oacute;tese que esta regla es aplicable a todas la
interfaces de red.

<p>
Ahora debemos permitir el paso del tr&aacute;fico hacia y desde la red
interna.  Asumiremos que los usuarios en la red interna saben lo que
est&aacute;n haciendo y que no van a causar problemas.  Esto no es algo
que deba ser asumido necesariamente, y en algunos entornos ser&iacute;a
apropiado usar un grupo de reglas mucho m&aacute;s restrictivo.
<blockquote>
<tt>
pass in on $int_if from $int_if:network to any keep state
</tt>
</blockquote>

<p>
La regla anterior permitir&aacute; que cualquier m&aacute;quina interna
pueda enviar paquetes a trav&eacute;s del cortafuegos;  sin embargo,
<i>no</i> permitir&aacute; que el cortafuegos inicie una conexi&oacute;n
con una m&aacute;quina interna.  &iquest;Es esto una buena idea?
Depende de algunos detalles de la configuraci&oacute;n de la red.  Si el
cortafuegos tambi&eacute;n es un servidor de DHCP, puede que sea
necesario enviar se&ntilde;ales de <i>ping</i> a alguna direcci&oacute;n
para verificar su disponibilidad antes de darle una asignaci&oacute;n.
Permitir que el cortafuegos se conecte a la red interna tambi&eacute;n
permite que alguien que se haya conectado mediante ssh al cortafuegos
desde Internet pueda entonces acceder a la m&aacute;quinas de la red.
Hay que tener en cuenta que <i>no</i> permitir que el cortafuegos se
comunique directamente con la red no representa un gran beneficio de
seguridad;  si alguien logra acceder al cortafuegos en primera
instancia, es probable que pueda alterar las reglas de filtrado.
A&ntilde;adiendo la siguiente regla, el cortafuegos podr&aacute; iniciar
conexiones con la red interna:
<blockquote>
<tt>
pass out on $int_if from any to $int_if:network keep state
</tt>
</blockquote>

<p>
N&oacute;tese que si ambas l&iacute;neas est&aacute;n en uso, no se
necesita la opci&oacute;n <tt>keep state</tt>;  todos los paquetes
podr&aacute;n pasar a trav&eacute;s de la interfaz interna porque hay
una regla para permitir el paso de paquetes en ambas direcciones.  Sin
embargo, si la l&iacute;nea <tt>pass out</tt> <i>no</i> va incluida, la
l&iacute;nea <tt>pass in</tt> <i>debe</i> incluir <tt>keep state</tt>.
El mantenimiento de estado tambi&eacute;n ofrece alg&uacute;n beneficio
en el rendimiento:  Las tablas de estado se comprueban antes de evaluar
las reglas, y si se encuentra un estado que concuerda, se permite pasar
al paquete a trav&eacute;s del cortafuegos sin que pase a trav&eacute;s
de la evaluaci&oacute;n del grupo de reglas.  Esto puede ofrecer un
beneficio en el rendimiento de un cortafuegos con mucha carga, aunque no
es probable que un sistema tan simple como el de este ejemplo genere la
carga suficiente como para que esto sea importante.

<p>
Finalmente, dejaremos salir el tr&aacute;fico en la interfaz externa:
<blockquote>
<tt>
pass out on $ext_if proto tcp all modulate state flags S/SA<br>
pass out on $ext_if proto { udp, icmp } all keep state
</tt>
</blockquote>

<p>
Se permite que el tr&aacute;fico TCP, UDP, y ICMP salga del cortafuegos
hacia Internet.  La informaci&oacute;n sobre el estado se guarda para
que los paquetes de vuelta pasen a trav&eacute;s del cortafuegos.
d408 2
a409 2
<h2>El Grupo de Reglas Completo</h2>
<table border="0" width="650">
a412 2
int_if = "fxp0"
ext_if = "ep0"
d414 4
a417 2
tcp_services = "{ 22, 113 }"
icmp_types = "echoreq"
d419 1
a419 3
priv_nets = "{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }"
	  
comp3 = "192.168.0.3"
d422 1
d424 6
a429 1
set loginterface $ext_if
d431 2
a432 2
# normalizaci&oacute;n
scrub in all
d434 3
a436 5
# nat/rdr
nat on $ext_if from $int_if:network to any -&gt; ($ext_if)
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 \
   port 8021
rdr on $ext_if proto tcp from any to any port 80 -&gt; $comp3
a438 3
block all

pass quick on lo0 all
d440 2
a441 2
block drop in  quick on $ext_if from $priv_nets to any
block drop out quick on $ext_if from any to $priv_nets
d443 1
a443 2
pass in on $ext_if inet proto tcp from any to ($ext_if) \
   port $tcp_services flags S/SA keep state
d445 2
a446 2
pass in on $ext_if proto tcp from any to $comp3 port 80 \
   flags S/SA synproxy state
d448 2
a449 1
pass in inet proto icmp all icmp-type $icmp_types keep state
d451 1
a451 2
pass in  on $int_if from $int_if:network to any keep state
pass out on $int_if from any to $int_if:network keep state
d453 1
a453 2
pass out on $ext_if proto tcp all modulate state flags S/SA
pass out on $ext_if proto { udp, icmp } all keep state
d459 1
a459 2
[<a href="authpf.html">Anterior: Authpf: <i>Shell</i> de Usuario para la
Autenticaci&oacute;n de Pasarelas</a>]
d464 2
a465 1
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[&Iacute;ndice]"></a> 
d469 5
a473 3
Originally [OpenBSD: example1.html,v 1.15 ]<br>
$OpenBSD$<br>
$Translation: example1.html,v 1.10 2004/08/30 17:38:14 santana Exp $
d475 1
@


1.7
log
@Sync with Steelix CVS
@
text
@d24 1
a24 1
<h1><font color="#e00000">PF: Ejemplo #1: Cortafuegos para Red en Casa u
d80 3
a82 2
interactivas (<i>chats</i>), etc.  La red interna usa el bloque de red
192.168.0.0 / 255.255.255.0.
d109 1
a109 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8&amp;manpath=OpenBSD+3.4">ping(8)</a>.
d111 4
d151 3
d163 1
a163 1
cortafuegos.  La &uacute;ltima l&iacute;nea define la direcci&oacute;n
d166 1
d170 1
a170 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=8&amp;manpath=OpenBSD+3.4">PPPoE</a>,
d219 2
a220 2
El &uacute;nico redireccionamiento que se necesita es para
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+3.4">ftp-proxy(8)</a>,
d236 13
d273 1
a273 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4&amp;manpath=OpenBSD+3.4">lo(4)</a>.
d326 17
d437 2
d450 1
d463 3
d488 1
a488 1
Originally [OpenBSD: example1.html,v 1.12 ]<br>
d490 1
a490 1
$Translation: example1.html,v 1.9 2004/01/04 21:32:07 horacio Exp $
@


1.6
log
@Sync with Steelix CVS
@
text
@d12 1
a12 1
<meta name="copyright"     content="Este documento es copyright 2003 de OpenBSD.">
d443 1
a443 1
Originally [OpenBSD: example1.html,v 1.11 ]<br>
d445 1
a445 1
$Translation: example1.html,v 1.8 2003/12/01 22:53:16 horacio Exp $
@


1.5
log
@Sync with Steelix CVS
@
text
@d85 5
a89 5
3com 3c509B (ep0) y una Intel EtherExpress Pro/100 (fxp0).  El enrutador
tiene una conexi&oacute;n de ADSL a Internet, y est&aacute; usando NAT
para compartir esta conexi&oacute;n con la red interna.  La
direcci&oacute;n IP en la interfaz externa la asigna de forma
din&aacute;mica el Proveedor de Internet.
d443 1
a443 1
Originally [OpenBSD: example1.html,v 1.10 ]<br>
d445 1
a445 1
$Translation: example1.html,v 1.7 2003/11/17 19:22:08 horacio Exp $
@


1.4
log
@sync with steelix cvs
@
text
@d108 1
a108 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8&amp;manpath=OpenBSD+3.3">ping(8)</a>.
d161 1
a161 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=8&amp;manpath=OpenBSD+3.3">PPPoE</a>,
d211 1
a211 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+3.3">ftp-proxy(8)</a>,
d251 1
a251 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4&amp;manpath=OpenBSD+3.3">lo(4)</a>.
d443 1
a443 1
Originally [OpenBSD: example1.html,v 1.9 ]<br>
d445 1
a445 1
$Translation: example1.html,v 1.6 2003/09/27 13:46:08 horacio Exp $
@


1.3
log
@sync with steelix cvs
@
text
@d443 1
a443 1
Originally [OpenBSD: example1.html,v 1.8 2003/09/16 01:23:49 nick Exp ]<br>
d445 1
a445 1
$Translation: example1.html,v 1.5 2003/09/19 22:10:58 horacio Exp $
@


1.2
log
@sync with steelix translation CVS
@
text
@d97 1
a97 1
ordenadores internos
d99 1
a99 1
predeterminada&raquo;
d104 1
a104 1
	remoto de la m&aacute;quina cortafuegos
d106 1
a106 1
	SMTP y IRC
d108 1
a108 1
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8&amp;manpath=OpenBSD+3.3">ping(8)</a>
d110 1
a110 1
<li>Registrar estad&iacute;sticas de filtrado en la interfaz externa
d112 1
a112 1
Unreachable</i> a los paquetes bloqueados
d114 1
a114 1
como sea posible
d261 3
a263 3
evitar que entren a, o salgan desde, la interfaz externa;  estas
direcciones nunca deben aparecer en p&uacute;blico en Internet.
Filtr&aacute;ndolas nos aseguraremos de que el enrutador no
d265 1
a265 1
tambi&eacute;n evitaremos cualquier paquete entrante que tenga como
d443 1
a443 1
Originally [OpenBSD: example1.html,v 1.7 2003/06/29 20:28:24 nick Exp ]<br>
d445 1
a445 1
$Translation: example1.html,v 1.4 2003/07/13 12:22:53 horacio Exp $
@


1.1
log
@sync with steelix translation CVS
@
text
@d55 2
a56 2
la oficina.  El objetivo que se persigue es el de dar acceso a Internet
a la red y permitir un acceso limitado a la m&aacute;quina cortafuegos
d111 2
a112 2
<li>Contestar, de modo predeterminado, con un TCP RST o ICMP Unreachable
a los paquetes bloqueados
d124 1
a124 1
<tt>net.inet.ip.forwarding</tt> con &quot;<tt>1</tt>&quot;.
d168 2
a169 2
Las siguientes dos opciones configuran la respuesta predeterminada para
las reglas de filtrado <tt>block</tt>, y activa el registro de
d221 1
a221 1
N&oacute;tese que esta reglas s&oacute;lo servir&aacute; para conexiones
d223 2
a224 2
por otros puertos, entonces se deber&iacute;a usar una lista que
especificara el puerto de destino;  por ejemplo:
d246 1
a246 1
Cada sistema Unix tiene una interfaz de <i>loopback</i>.  &Eacute;sta es
d248 3
a250 3
entre ellas dentro del sistema.  Todo el tr&aacute;fico deber&iacute;a
pasar por la interfaz de <i>loopback</i>.  En OpenBSD, la interfaz de
<i>loopback</i> es
d261 6
a266 6
evitar que entren o salgan de la interfaz externa;  estas direcciones
nunca deben aparecer en p&uacute;blico en Internet.  Filtr&aacute;ndolas
nos aseguraremos de que el enrutador no &laquo;muestra&raquo; estas
direcciones fuera de la red interna, y tambi&eacute;n y tambi&eacute;n
evitaremos cualquier paquete entrante con una direcci&oacute;n de origen
de una de esas redes.
d299 1
a299 1
creaci&oacute;n de una macro <tt>$udp_services</tt> y a&ntilde;diendo
d336 3
a338 3
cortafuegos tambi&eacute;n es un servidor de DHCP puede que necesite
enviar se&ntilde;ales de <i>ping</i> a alguna direcci&oacute;n para
verificar su disponibilidad antes de darle una asignaci&oacute;n.
d346 1
a346 1
A&ntilde;adiendo la siguiente regla el cortafuegos podr&aacute; iniciar
d366 2
a367 2
beneficio en el rendimiento en un cortafuegos con mucha carga, aunque un
sistema tan simple como el de este ejemplo no es probable que genere la
d382 1
a382 1
que los paquetes de vuelta pasen a trav&eacue;s del cortafuegos.
d402 1
a402 1
# scrub
d445 1
a445 1
$Translation: example1.html,v 1.3 2003/07/01 14:55:02 horacio Exp $
@

