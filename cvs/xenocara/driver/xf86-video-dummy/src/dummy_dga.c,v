head	1.3;
access;
symbols
	OPENBSD_6_1:1.3.0.18
	OPENBSD_6_1_BASE:1.3
	OPENBSD_6_0:1.3.0.16
	OPENBSD_6_0_BASE:1.3
	OPENBSD_5_9:1.3.0.14
	OPENBSD_5_9_BASE:1.3
	OPENBSD_5_8:1.3.0.12
	OPENBSD_5_8_BASE:1.3
	OPENBSD_5_7:1.3.0.10
	OPENBSD_5_7_BASE:1.3
	OPENBSD_5_6:1.3.0.8
	OPENBSD_5_6_BASE:1.3
	OPENBSD_5_5:1.3.0.6
	OPENBSD_5_5_BASE:1.3
	OPENBSD_5_4:1.3.0.4
	OPENBSD_5_4_BASE:1.3
	OPENBSD_5_3:1.3.0.2
	OPENBSD_5_3_BASE:1.3
	OPENBSD_5_2:1.2.0.2
	OPENBSD_5_2_BASE:1.2
	OPENBSD_5_1_BASE:1.1.1.1
	OPENBSD_5_1:1.1.1.1.0.20
	OPENBSD_5_0:1.1.1.1.0.18
	OPENBSD_5_0_BASE:1.1.1.1
	OPENBSD_4_9:1.1.1.1.0.14
	OPENBSD_4_9_BASE:1.1.1.1
	OPENBSD_4_8:1.1.1.1.0.16
	OPENBSD_4_8_BASE:1.1.1.1
	OPENBSD_4_7:1.1.1.1.0.12
	OPENBSD_4_7_BASE:1.1.1.1
	OPENBSD_4_6:1.1.1.1.0.10
	OPENBSD_4_6_BASE:1.1.1.1
	OPENBSD_4_5:1.1.1.1.0.8
	OPENBSD_4_5_BASE:1.1.1.1
	OPENBSD_4_4:1.1.1.1.0.6
	OPENBSD_4_4_BASE:1.1.1.1
	OPENBSD_4_3_BASE:1.1.1.1
	OPENBSD_4_3:1.1.1.1.0.4
	OPENBSD_4_2:1.1.1.1.0.2
	OPENBSD_4_2_BASE:1.1.1.1
	v0_2_0:1.1.1.1
	xorg:1.1.1;
locks; strict;
comment	@ * @;


1.3
date	2012.09.09.21.31.46;	author matthieu;	state Exp;
branches;
next	1.2;

1.2
date	2012.02.20.21.48.45;	author matthieu;	state Exp;
branches;
next	1.1;

1.1
date	2006.11.26.20.03.11;	author matthieu;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2006.11.26.20.03.11;	author matthieu;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Upate to xf86-video-dummy 0.3.6
@
text
@#ifdef HAVE_CONFIG_H
#include "config.h"
#endif

#include "xf86.h"
#include "xf86_OSproc.h"
#include "dgaproc.h"
#include "dummy.h"

static Bool DUMMY_OpenFramebuffer(ScrnInfoPtr, char **, unsigned char **, 
					int *, int *, int *);
static Bool DUMMY_SetMode(ScrnInfoPtr, DGAModePtr);
static int  DUMMY_GetViewport(ScrnInfoPtr);
static void DUMMY_SetViewport(ScrnInfoPtr, int, int, int);

static
DGAFunctionRec DUMMYDGAFuncs = {
   DUMMY_OpenFramebuffer,
   NULL,
   DUMMY_SetMode,
   DUMMY_SetViewport,
   DUMMY_GetViewport,
   NULL,
   NULL,
   NULL,
#if 0
   DUMMY_BlitTransRect
#else
   NULL
#endif
};

Bool
DUMMYDGAInit(ScreenPtr pScreen)
{   
   ScrnInfoPtr pScrn = xf86ScreenToScrn(pScreen);
   DUMMYPtr pDUMMY = DUMMYPTR(pScrn);
   DGAModePtr modes = NULL, newmodes = NULL, currentMode;
   DisplayModePtr pMode, firstMode;
   int Bpp = pScrn->bitsPerPixel >> 3;
   int num = 0, imlines, pixlines;

   imlines =  (pScrn->videoRam * 1024) /
      (pScrn->displayWidth * (pScrn->bitsPerPixel >> 3));

   pixlines =   imlines;

   pMode = firstMode = pScrn->modes;

   while(pMode) {

	newmodes = realloc(modes, (num + 1) * sizeof(DGAModeRec));

	if(!newmodes) {
	   free(modes);
	   return FALSE;
	}
	modes = newmodes;

	currentMode = modes + num;
	num++;

	currentMode->mode = pMode;
	currentMode->flags = DGA_CONCURRENT_ACCESS | DGA_PIXMAP_AVAILABLE;
	if(pMode->Flags & V_DBLSCAN)
	   currentMode->flags |= DGA_DOUBLESCAN;
	if(pMode->Flags & V_INTERLACE)
	   currentMode->flags |= DGA_INTERLACED;
	currentMode->byteOrder = pScrn->imageByteOrder;
	currentMode->depth = pScrn->depth;
	currentMode->bitsPerPixel = pScrn->bitsPerPixel;
	currentMode->red_mask = pScrn->mask.red;
	currentMode->green_mask = pScrn->mask.green;
	currentMode->blue_mask = pScrn->mask.blue;
	currentMode->visualClass = (Bpp == 1) ? PseudoColor : TrueColor;
	currentMode->viewportWidth = pMode->HDisplay;
	currentMode->viewportHeight = pMode->VDisplay;
	currentMode->xViewportStep = 1;
	currentMode->yViewportStep = 1;
	currentMode->viewportFlags = DGA_FLIP_RETRACE;
	currentMode->offset = 0;
	currentMode->address = (unsigned char *)pDUMMY->FBBase;

	currentMode->bytesPerScanline = 
			((pScrn->displayWidth * Bpp) + 3) & ~3L;
	currentMode->imageWidth = pScrn->displayWidth;
	currentMode->imageHeight =  imlines;
	currentMode->pixmapWidth = currentMode->imageWidth;
	currentMode->pixmapHeight = pixlines;
	currentMode->maxViewportX = currentMode->imageWidth - 
					currentMode->viewportWidth;
	currentMode->maxViewportY = currentMode->imageHeight -
					currentMode->viewportHeight;

	pMode = pMode->next;
	if(pMode == firstMode)
	   break;
   }

   pDUMMY->numDGAModes = num;
   pDUMMY->DGAModes = modes;

   return DGAInit(pScreen, &DUMMYDGAFuncs, modes, num);  
}

static DisplayModePtr DUMMYSavedDGAModes[MAXSCREENS];

static Bool
DUMMY_SetMode(
   ScrnInfoPtr pScrn,
   DGAModePtr pMode
){
   int index = pScrn->pScreen->myNum;
   DUMMYPtr pDUMMY = DUMMYPTR(pScrn);

   if(!pMode) { /* restore the original mode */
 	if(pDUMMY->DGAactive) {	
	    pScrn->currentMode = DUMMYSavedDGAModes[index];
            DUMMYSwitchMode(SWITCH_MODE_ARGS(pScrn, pScrn->currentMode));
	    DUMMYAdjustFrame(ADJUST_FRAME_ARGS(pScrn, 0, 0));
 	    pDUMMY->DGAactive = FALSE;
	}
   } else {
	if(!pDUMMY->DGAactive) {  /* save the old parameters */
	    DUMMYSavedDGAModes[index] = pScrn->currentMode;
	    pDUMMY->DGAactive = TRUE;
	}

        DUMMYSwitchMode(SWITCH_MODE_ARGS(pScrn, pMode->mode));
   }
   
   return TRUE;
}

static int  
DUMMY_GetViewport(
  ScrnInfoPtr pScrn
){
    DUMMYPtr pDUMMY = DUMMYPTR(pScrn);

    return pDUMMY->DGAViewportStatus;
}

static void 
DUMMY_SetViewport(
   ScrnInfoPtr pScrn, 
   int x, int y, 
   int flags
){
   DUMMYPtr pDUMMY = DUMMYPTR(pScrn);

   DUMMYAdjustFrame(ADJUST_FRAME_ARGS(pScrn, x, y));
   pDUMMY->DGAViewportStatus = 0;  
}


static Bool 
DUMMY_OpenFramebuffer(
   ScrnInfoPtr pScrn, 
   char **name,
   unsigned char **mem,
   int *size,
   int *offset,
   int *flags
){
    DUMMYPtr pDUMMY = DUMMYPTR(pScrn);

    *name = NULL; 		/* no special device */
    *mem = (unsigned char*)pDUMMY->FBBase;
    *size = pScrn->videoRam * 1024;
    *offset = 0;
    *flags = DGA_NEED_ROOT;

    return TRUE;
}
@


1.2
log
@Update to xf86-video-dummy 0.3.5
@
text
@d36 1
a36 1
   ScrnInfoPtr pScrn = xf86Screens[pScreen->myNum];
d119 2
a120 2
            DUMMYSwitchMode(index, pScrn->currentMode, 0);
	    DUMMYAdjustFrame(index, 0, 0, 0);
d129 1
a129 1
        DUMMYSwitchMode(index, pMode->mode, 0);
d152 1
a152 1
   DUMMYAdjustFrame(pScrn->pScreen->myNum, x, y, flags);
@


1.1
log
@Initial revision
@
text
@a6 2
#include "xf86Pci.h"
#include "xf86PciInfo.h"
d52 1
a52 1
	newmodes = xrealloc(modes, (num + 1) * sizeof(DGAModeRec));
d55 1
a55 1
	   xfree(modes);
@


1.1.1.1
log
@Importing xf86-video-dummy 0.2.0
@
text
@@
