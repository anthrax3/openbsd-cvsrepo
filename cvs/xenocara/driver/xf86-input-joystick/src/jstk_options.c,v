head	1.6;
access;
symbols
	OPENBSD_6_0:1.6.0.20
	OPENBSD_6_0_BASE:1.6
	OPENBSD_5_9:1.6.0.18
	OPENBSD_5_9_BASE:1.6
	OPENBSD_5_8:1.6.0.16
	OPENBSD_5_8_BASE:1.6
	OPENBSD_5_7:1.6.0.14
	OPENBSD_5_7_BASE:1.6
	OPENBSD_5_6:1.6.0.12
	OPENBSD_5_6_BASE:1.6
	OPENBSD_5_5:1.6.0.10
	OPENBSD_5_5_BASE:1.6
	OPENBSD_5_4:1.6.0.8
	OPENBSD_5_4_BASE:1.6
	OPENBSD_5_3:1.6.0.6
	OPENBSD_5_3_BASE:1.6
	OPENBSD_5_2:1.6.0.4
	OPENBSD_5_2_BASE:1.6
	OPENBSD_5_1_BASE:1.6
	OPENBSD_5_1:1.6.0.2
	OPENBSD_5_0:1.5.0.2
	OPENBSD_5_0_BASE:1.5
	OPENBSD_4_9:1.3.0.4
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.3.0.6
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.3.0.2
	OPENBSD_4_7_BASE:1.3
	OPENBSD_4_6:1.2.0.2
	OPENBSD_4_6_BASE:1.2
	OPENBSD_4_5:1.1.0.2
	OPENBSD_4_5_BASE:1.1;
locks; strict;
comment	@ * @;


1.6
date	2011.11.05.14.01.51;	author matthieu;	state Exp;
branches;
next	1.5;

1.5
date	2011.07.02.21.59.45;	author matthieu;	state Exp;
branches;
next	1.4;

1.4
date	2011.07.02.21.03.43;	author matthieu;	state Exp;
branches;
next	1.3;

1.3
date	2009.11.22.14.38.31;	author matthieu;	state Exp;
branches;
next	1.2;

1.2
date	2009.05.03.13.54.12;	author matthieu;	state Exp;
branches;
next	1.1;

1.1
date	2008.08.23.14.16.59;	author matthieu;	state Exp;
branches;
next	;


desc
@@


1.6
log
@Update to xf86-input-joystick 1.6.0 for good now.
@
text
@/*
 * Copyright 2007 - 2008    by Sascha Hlusiak. <saschahlusiak@@freedesktop.org>
 *                                                                            
 * Permission to use, copy, modify, distribute, and sell this software and its
 * documentation for any purpose is  hereby granted without fee, provided that
 * the  above copyright   notice appear  in   all  copies and  that both  that
 * copyright  notice   and   this  permission   notice  appear  in  supporting
 * documentation, and that   the  name of  Sascha   Hlusiak  not  be  used  in
 * advertising or publicity pertaining to distribution of the software without
 * specific,  written      prior  permission.     Sascha   Hlusiak   makes  no
 * representations about the suitability of this software for any purpose.  It
 * is provided "as is" without express or implied warranty.                   
 *                                                                            
 * SASCHA  HLUSIAK  DISCLAIMS ALL   WARRANTIES WITH REGARD  TO  THIS SOFTWARE,
 * INCLUDING ALL IMPLIED   WARRANTIES OF MERCHANTABILITY  AND   FITNESS, IN NO
 * EVENT  SHALL SASCHA  HLUSIAK  BE   LIABLE   FOR ANY  SPECIAL, INDIRECT   OR
 * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE,
 * DATA  OR PROFITS, WHETHER  IN  AN ACTION OF  CONTRACT,  NEGLIGENCE OR OTHER
 * TORTIOUS  ACTION, ARISING    OUT OF OR   IN  CONNECTION  WITH THE USE    OR
 * PERFORMANCE OF THIS SOFTWARE.
 *
 */


#ifdef HAVE_CONFIG_H
#include "config.h"
#endif

#include <xorg-server.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include <xf86.h>
#include <X11/keysym.h>
#include <X11/XF86keysym.h>
#include "jstk.h"
#include "jstk_options.h"




/***********************************************************************
 *
 * jstkGetAxisMapping --
 *
 * Parses strings like:
 * x, +y, -zx, 3x, 3.5zy, -8x 
 * And returns the mapping and stores the optional factor
 * In the float referenced by 'value'
 *
 ***********************************************************************
 */

static JSTK_MAPPING
jstkGetAxisMapping(float *value, const char* param, const char* name) 
{
    if (sscanf(param, "%f", value)==0) {
        if (param[0] == '-')
            *value *= -1.0;
    }
    if (strstr(param, "key") != NULL)
        return JSTK_MAPPING_KEY;
    else if (strstr(param, "zx") != NULL)
        return JSTK_MAPPING_ZX;
    else if (strstr(param, "zy") != NULL)
        return JSTK_MAPPING_ZY;
    else if (strstr(param, "x") != NULL)
        return JSTK_MAPPING_X;
    else if (strstr(param, "y") != NULL)
        return JSTK_MAPPING_Y;

    return JSTK_MAPPING_NONE;
}


/***********************************************************************
 *
 * jstkParseButtonOption --
 *
 * Interpretes one ButtonMappingX option, given in 'org'
 * stores the result in *button
 * name is the name of the InputDevice
 *
 ***********************************************************************
 */

void
jstkParseButtonOption(const char* org,
                      JoystickDevPtr priv,
                      int number,
                      const char* name)
{
    char *param;
    int value;
    float fvalue;
    char p[64];
    BUTTON* button;

    button = &priv->button[number];

    param = xstrdup(org);
/*    for (tmp = param; *tmp; tmp++) *tmp = tolower(*tmp); */

    if (strcmp(param, "none") == 0) {
        button->mapping = JSTK_MAPPING_NONE;
    } else if (sscanf(param, "button=%d", &value) == 1) {
        if (value<0 || value >BUTTONMAP_SIZE) {
            xf86Msg(X_WARNING, "%s: button number out of range (0..%d): %d.\n", 
                    name, BUTTONMAP_SIZE,  value);
        } else {
            button->mapping      = JSTK_MAPPING_BUTTON;
            button->buttonnumber = value;
        }
    } else if (sscanf(param, "axis=%15s", p) == 1) {
        p[15]='\0';
        fvalue = 1.0f;
        button->mapping = jstkGetAxisMapping(&fvalue, p, name);
        button->amplify = fvalue;
        button->currentspeed = 1.0f;
        if (button->mapping == JSTK_MAPPING_NONE)
            xf86Msg(X_WARNING, "%s: error parsing axis: %s.\n", 
                    name, p);
    } else if (sscanf(param, "amplify=%f", &fvalue) == 1) {
        button->mapping = JSTK_MAPPING_SPEED_MULTIPLY;
        button->amplify = fvalue;
    } else if (sscanf(param, "key=%30s", p) == 1) {
        char *current, *next;
        p[30]='\0';
        current = p;
        button->mapping = JSTK_MAPPING_KEY;

        for (value = 0; value < MAXKEYSPERBUTTON; value++) if (current != NULL) {
            unsigned int key;
            next = strchr(current, ',');
            if (!next) next = strchr(current, '+');
            if (next) *(next++) = '\0';
            key = strtol(current, NULL, 0);
            DBG(3, ErrorF("Parsed %s to %d\n", current, key));
            if (key == 0)
                xf86Msg(X_WARNING, "%s: error parsing key value: %s.\n", 
                        name, current);
            else {
                button->keys[value] = key;
            }
            current = next;
        } else button->keys[value] = 0;
    } else if (strcmp(param, "disable-all") == 0) {
        button->mapping = JSTK_MAPPING_DISABLE;
    } else if (strcmp(param, "disable-mouse") == 0) {
        button->mapping = JSTK_MAPPING_DISABLE_MOUSE;
    } else if (strcmp(param, "disable-keys") == 0) {
        button->mapping = JSTK_MAPPING_DISABLE_KEYS;
    } else {
        xf86Msg(X_WARNING, "%s: error parsing button parameter.\n", 
                name);
    }
    free(param);
}


/***********************************************************************
 *
 * jstkParseAxisOption --
 *
 * Interpretes one AxisMappingX option, given in 'org'
 * stores the result in *axis
 * name is the name of the InputDevice
 *
 ***********************************************************************
 */

void
jstkParseAxisOption(const char* org, 
                    JoystickDevPtr priv,
                    AXIS *axis,
                    const char *name)
{
    char *param;
    char *tmp;
    int value;
    float fvalue;
    char p[64];
    param = xstrdup(org);
/*    for (tmp     for (tmp = param; *tmp; tmp++) *tmp = tolower(*tmp);
= param; *tmp; tmp++) *tmp = tolower(*tmp); */

    if ((tmp=strstr(param, "mode=")) != NULL) {
        if (sscanf(tmp, "mode=%15s", p) == 1) {
            p[15] = '\0';
            if (strcmp(p, "relative") == 0) {
                axis->type = JSTK_TYPE_BYVALUE;
            } else if (strcmp(p, "accelerated") == 0) {
                axis->type = JSTK_TYPE_ACCELERATED;
                axis->currentspeed = 1.0f;
            } else if (strcmp(p, "absolute") == 0) {
                axis->type = JSTK_TYPE_ABSOLUTE;
            } else if (strcmp(p, "none") == 0) {
                axis->type = JSTK_TYPE_NONE;
            } else {
                axis->type = JSTK_TYPE_NONE;
                xf86Msg(X_WARNING, "%s: \"%s\": error parsing mode.\n", 
                        name, param);
            }
        } else xf86Msg(X_WARNING, "%s: \"%s\": error parsing mode.\n", 
                       name, param);
    }

    if ((tmp = strstr(param, "axis=")) != NULL) {
        if (sscanf(tmp, "axis=%15s", p) == 1) {
            p[15] = '\0';
            fvalue = 1.0f;
            axis->mapping = jstkGetAxisMapping(&fvalue, p, name);
            if ((axis->type == JSTK_TYPE_ABSOLUTE) &&
                ((fvalue <= 1.1)&&(fvalue >= -1.1))) {
                if (axis->mapping == JSTK_MAPPING_X)
                    fvalue *= (int)screenInfo.screens[0]->width;
                if (axis->mapping == JSTK_MAPPING_Y)
                    fvalue *= (int)screenInfo.screens[0]->height;
            }
            axis->amplify = fvalue;
            if (axis->mapping == JSTK_MAPPING_NONE)
                xf86Msg(X_WARNING, "%s: error parsing axis: %s.\n",
                        name, p);
        }else xf86Msg(X_WARNING, "%s: error parsing axis.\n",
                      name);
    }

    if ((tmp = strstr(param, "valuator")) != NULL ) {
        axis->valuator = 0; /* Will be renumbered appropriately on DEVICE_INIT */
    }

    if ((tmp = strstr(param, "keylow=")) != NULL) {
        if (sscanf(tmp, "keylow=%30s", p) == 1) {
            char *current, *next;
            unsigned int key;
            p[30]='\0';
            current = p;
            axis->mapping = JSTK_MAPPING_KEY;
            for (value = 0; value < MAXKEYSPERBUTTON; value++) 
                if (current != NULL) {
                    next = strchr(current, ',');
		    if (!next) next = strchr(current, '+');
                    if (next) *(next++) = '\0';

                    key = strtol(current, NULL, 0);
                    DBG(3, ErrorF("Parsed %s to %d\n", current, key));
                    if (key == 0)
                        xf86Msg(X_WARNING, "%s: error parsing keylow value: %s.\n", 
                                name, current);
                    else {
                        axis->keys_low[value] = key;
                    }
                    current = next;
                } else axis->keys_low[value] = 0;
        }
    }

    if ((tmp = strstr(param, "keyhigh=")) != NULL) {
        if (sscanf(tmp, "keyhigh=%30s", p) == 1) {
            char *current, *next;
            unsigned int key;
            p[30]='\0';
            current = p;
            axis->mapping = JSTK_MAPPING_KEY;
            for (value = 0; value < MAXKEYSPERBUTTON; value++) 
                if (current != NULL) {
                    next = strchr(current, ',');
                    if (!next) next = strchr(current, '+');
                    if (next) *(next++) = '\0';
                    key = strtol(current, NULL, 0);
                    key = strtol(current, NULL, 0);
                    DBG(3, ErrorF("Parsed %s to %d\n", current, key));
                    if (key == 0)
                        xf86Msg(X_WARNING, "%s: error parsing keyhigh value: %s.\n", 
                                name, current);
                    else {
                        axis->keys_high[value] = key;
                    }
                    current = next;
                } else axis->keys_high[value] = 0;
        }
    }

    if ((tmp = strstr(param, "deadzone=")) != NULL ) {
        if (sscanf(tmp, "deadzone=%d", &value) == 1) {
            value = (value < 0) ? (-value) : (value);
            if (value > 30000)
                xf86Msg(X_WARNING, 
                        "%s: deadzone of %d seems unreasonable. Ignored.\n", 
                        name, value);
            else axis->deadzone = value;
        }else xf86Msg(X_WARNING, "%s: error parsing deadzone.\n", 
                      name);
    }
    free(param);
}
@


1.5
log
@Revert update to xf86-input-joystick 1.6.0.
This driver depends on xserver 1.10.
@
text
@d29 1
d158 1
a158 1
    xfree(param);
d296 1
a296 1
    xfree(param);
@


1.4
log
@Update to xf86-input-joystick 1.6.0
@
text
@a28 1
#include <xorg-server.h>
d157 1
a157 1
    free(param);
d295 1
a295 1
    free(param);
@


1.3
log
@Update to xf86-input-joystick 1.5.0
@
text
@d29 1
d158 1
a158 1
    xfree(param);
d296 1
a296 1
    xfree(param);
@


1.2
log
@update to xf86-input-joystick 1.4.1
@
text
@a37 1
#include "StrKeysym.h"
a41 25

/***********************************************************************
 *
 * jstkGetKeyNumberInMap --
 *
 * Adds a KeySym to the keymap and returns the index
 *
 ***********************************************************************
 */

static int
jstkGetKeyNumberInMap(JoystickDevPtr priv,
                      KeySym keysym)
{
    int j;
    for (j=0; j<priv->keymap.size; j++)
        if (priv->keymap.map[j] == keysym)
            break;
    if (j >= sizeof(priv->keymap.map)/sizeof(priv->keymap.map[0])) return 0;
    priv->keymap.map[j] = keysym;
    if (j + 1 > priv->keymap.size) priv->keymap.size = j + 1;
    return j;
}


d133 1
a133 1
            unsigned key;
d135 1
a135 1
	    if (!next) next = strchr(current, '+');
d137 1
a137 5
#ifdef _STRKEYSYM_H_INCLUDED_
            key = XStringToKeysym(current);
            if (key == NoSymbol)
#endif
                key = strtol(current, NULL, 0);
d143 1
a143 1
                button->keys[value] = jstkGetKeyNumberInMap(priv, key);
d245 1
a245 5
#ifdef _STRKEYSYM_H_INCLUDED_
                    key = XStringToKeysym(current);
                    if (key == NoSymbol)
#endif
                        key = strtol(current, NULL, 0);
d251 1
a251 1
                        axis->keys_low[value] = jstkGetKeyNumberInMap(priv, key);
d268 1
a268 1
		    if (!next) next = strchr(current, '+');
d271 1
a271 5
#ifdef _STRKEYSYM_H_INCLUDED_
                    key = XStringToKeysym(current);
                    if (key == NoSymbol)
#endif
                        key = strtol(current, NULL, 0);
d277 1
a277 1
                        axis->keys_high[value] = jstkGetKeyNumberInMap(priv, key);
@


1.1
log
@xf86-input joystick 1.3.2
@
text
@a45 25
 * jstkGetButtonNumberInMap --
 *
 * Adds a button number to the button map and returns the index
 *
 ***********************************************************************
 */

int
jstkGetButtonNumberInMap(JoystickDevPtr priv,
                         int buttonnumber)
{
    int j;
    for (j=1; j<=priv->buttonmap.size; j++)
        if (priv->buttonmap.map[j] == buttonnumber)
            break;
    if (j > MAXBUTTONS+1) return 0;
    priv->buttonmap.map[j] = buttonnumber;
    if (j > priv->buttonmap.size) priv->buttonmap.size = j;
    return j;
}



/***********************************************************************
 *
d53 1
a53 1
int
d80 1
a80 1
static JOYSTICKMAPPING
d88 1
a88 1
        return MAPPING_KEY;
d90 1
a90 1
        return MAPPING_ZX;
d92 1
a92 1
        return MAPPING_ZY;
d94 1
a94 1
        return MAPPING_X;
d96 1
a96 1
        return MAPPING_Y;
d98 1
a98 1
    return MAPPING_NONE;
d131 1
a131 1
        button->mapping = MAPPING_NONE;
d133 7
a139 2
        button->mapping      = MAPPING_BUTTON;
        button->buttonnumber = jstkGetButtonNumberInMap(priv, value);
d146 1
a146 1
        if (button->mapping == MAPPING_NONE)
d150 1
a150 1
        button->mapping = MAPPING_SPEED_MULTIPLY;
d156 1
a156 1
        button->mapping = MAPPING_KEY;
d178 1
a178 1
        button->mapping = MAPPING_DISABLE;
d180 1
a180 1
        button->mapping = MAPPING_DISABLE_MOUSE;
d182 1
a182 1
        button->mapping = MAPPING_DISABLE_KEYS;
d221 1
a221 1
                axis->type = TYPE_BYVALUE;
d223 1
a223 1
                axis->type = TYPE_ACCELERATED;
d226 1
a226 1
                axis->type = TYPE_ABSOLUTE;
d228 1
a228 1
                axis->type = TYPE_NONE;
d230 1
a230 1
                axis->type = TYPE_NONE;
d243 1
a243 1
            if ((axis->type == TYPE_ABSOLUTE) &&
d245 1
a245 1
                if (axis->mapping == MAPPING_X)
d247 1
a247 1
                if (axis->mapping == MAPPING_Y)
d251 1
a251 1
            if (axis->mapping == MAPPING_NONE)
d258 4
d268 1
a268 1
            axis->mapping = MAPPING_KEY;
d298 1
a298 1
            axis->mapping = MAPPING_KEY;
@

