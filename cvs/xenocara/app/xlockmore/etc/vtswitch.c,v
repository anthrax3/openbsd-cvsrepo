head	1.1;
branch	1.1.1;
access;
symbols
	OPENBSD_6_2:1.1.1.1.0.42
	OPENBSD_6_2_BASE:1.1.1.1
	OPENBSD_6_1:1.1.1.1.0.40
	OPENBSD_6_1_BASE:1.1.1.1
	OPENBSD_6_0:1.1.1.1.0.38
	OPENBSD_6_0_BASE:1.1.1.1
	OPENBSD_5_9:1.1.1.1.0.36
	OPENBSD_5_9_BASE:1.1.1.1
	OPENBSD_5_8:1.1.1.1.0.34
	OPENBSD_5_8_BASE:1.1.1.1
	OPENBSD_5_7:1.1.1.1.0.32
	OPENBSD_5_7_BASE:1.1.1.1
	OPENBSD_5_6:1.1.1.1.0.30
	OPENBSD_5_6_BASE:1.1.1.1
	OPENBSD_5_5:1.1.1.1.0.28
	OPENBSD_5_5_BASE:1.1.1.1
	OPENBSD_5_4:1.1.1.1.0.26
	OPENBSD_5_4_BASE:1.1.1.1
	OPENBSD_5_3:1.1.1.1.0.24
	OPENBSD_5_3_BASE:1.1.1.1
	OPENBSD_5_2:1.1.1.1.0.22
	OPENBSD_5_2_BASE:1.1.1.1
	OPENBSD_5_1_BASE:1.1.1.1
	OPENBSD_5_1:1.1.1.1.0.20
	OPENBSD_5_0:1.1.1.1.0.18
	OPENBSD_5_0_BASE:1.1.1.1
	OPENBSD_4_9:1.1.1.1.0.14
	OPENBSD_4_9_BASE:1.1.1.1
	OPENBSD_4_8:1.1.1.1.0.16
	OPENBSD_4_8_BASE:1.1.1.1
	OPENBSD_4_7:1.1.1.1.0.12
	OPENBSD_4_7_BASE:1.1.1.1
	OPENBSD_4_6:1.1.1.1.0.10
	OPENBSD_4_6_BASE:1.1.1.1
	OPENBSD_4_5:1.1.1.1.0.8
	OPENBSD_4_5_BASE:1.1.1.1
	OPENBSD_4_4:1.1.1.1.0.6
	OPENBSD_4_4_BASE:1.1.1.1
	OPENBSD_4_3_BASE:1.1.1.1
	OPENBSD_4_3:1.1.1.1.0.4
	OPENBSD_4_2:1.1.1.1.0.2
	OPENBSD_4_2_BASE:1.1.1.1
	v5_22:1.1.1.1
	xlockmore:1.1.1;
locks; strict;
comment	@ * @;


1.1
date	2006.11.26.11.08.08;	author matthieu;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2006.11.26.11.08.08;	author matthieu;	state Exp;
branches;
next	;


desc
@@



1.1
log
@Initial revision
@
text
@/* Copyright (c) R. Cohen-Scali, 1998. */

/*
 * Permission to use, copy, modify, and distribute this software and its
 * documentation for any purpose and without fee is hereby granted,
 * provided that the above copyright notice appear in all copies and that
 * both that copyright notice and this permission notice appear in
 * supporting documentation.
 *
 * This file is provided AS IS with no warranties of any kind.  The author
 * shall have no liability with respect to the infringement of copyrights,
 * trade secrets or any patents by this file or any part thereof.  In no
 * event will the author be liable for any lost revenue or profits or
 * other special, indirect and consequential damages.
 *
 * <remi.cohenscali@@pobox.com>
 */


#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <linux/vt.h>

#define CONSOLE "/dev/console"

static char *progname = NULL;
static char errmsg[1024];

static void usage( int verb )
{
    fprintf( stderr, "%s: usage: %s [-h] <on/off>\n", progname, progname );
    if ( verb )
    {
        fprintf( stderr, "    Allows to enable/disable to VT switching ability\n" );
        fprintf( stderr, "      -- %s on -- enable VT switching\n", progname );
        fprintf( stderr, "      -- %s off -- disable VT switching\n", progname );
        fprintf( stderr, "    Option -h display this message\n" );
    }
    fprintf( stderr, "\n", progname, progname );
}

main( int argc, char **argv )
{
    char *cmd = argv[1];
    int allow = 0, consfd = -1;
    uid_t uid = -1;
    struct stat consstat;

    /* Program name */
    progname =( progname = strrchr( argv[0], '/' ) ) ? progname +1 : argv[0];

    /* Check args */
    if ( argc != 2 && argc != 3 )
    {
        usage( 0 );
        exit( 1 );
    }

    /* Process -h */
    if ( !strcmp( cmd, "-h" ) || !strcmp( cmd, "--help" ) )
    {
        usage( 1 );
        cmd = argv[2];
        if ( argc == 2 ) exit( 0 );
    }

    /* Process on/off (case insensitive) */
    if ( strcasecmp( cmd, "on" ) && strcasecmp( cmd, "off" ) )
    {
        usage( 0 );
        exit( 1 );
    }
    allow = !strcasecmp( cmd, "on" );

    /* Check user is allowed to do it */
    uid = getuid();
    if ( stat( CONSOLE, &consstat ) == -1 )
    {
        sprintf( errmsg, "%s: Cannot stat " CONSOLE, progname );
        perror( errmsg );
        exit( 1 );
    }
    if ( uid != consstat.st_uid )
    {
        fprintf(stderr,
                "%s: Sorry, you are not allowed to %slock"
                " VT switching: Operation not permitted\n",
                progname,
                allow ? "un" : "" );
        exit( 1 );
    }
    seteuid( 0 );

    /* Open console */
    if ( ( consfd = open( CONSOLE, O_RDWR ) ) == -1 )
    {
        sprintf( errmsg, "%s: Cannot open " CONSOLE, progname );
        perror( errmsg );
        seteuid( uid );
        exit( 1 );
    }

    /* Do it */
    if ( ioctl( consfd, allow?VT_UNLOCKSWITCH:VT_LOCKSWITCH ) == -1 )
    {
        sprintf( errmsg, "%s: Cannot %slock VT switching for " CONSOLE, progname, allow ? "un" : "" );
        perror( errmsg );
        seteuid( uid );
        exit( 1 );
    }

    /* Terminate */
    close( consfd );
    fprintf( stdout, "VT switching %s\n", allow ? "enabled" : "disabled" );
    seteuid( uid );
    exit( 0 );
}
@


1.1.1.1
log
@Importing xlockmore 5.22
@
text
@@
