head	1.1;
branch	1.1.1;
access;
symbols
	mesa-17_1_6:1.1.1.1
	OPENBSD_6_1:1.1.1.1.0.2
	OPENBSD_6_1_BASE:1.1.1.1
	mesa-13_0_6:1.1.1.1
	mesa-13_0_5:1.1.1.1
	mesa-13_0_3:1.1.1.1
	mesa-13_0_2:1.1.1.1
	OPENBSD_6_0:1.1.1.1.0.4
	OPENBSD_6_0_BASE:1.1.1.1
	mesa-11_2_2:1.1.1.1
	mesa:1.1.1;
locks; strict;
comment	@// @;
expand	@o@;


1.1
date	2016.05.29.10.16.42;	author jsg;	state Exp;
branches
	1.1.1.1;
next	;
commitid	OwGfrJACrYJkCVJ4;

1.1.1.1
date	2016.05.29.10.16.42;	author jsg;	state Exp;
branches;
next	;
commitid	OwGfrJACrYJkCVJ4;


desc
@@


1.1
log
@Initial revision
@
text
@/*
 * Copyright Â© 2014 Intel Corporation
 *
 * Permission is hereby granted, free of charge, to any person obtaining a
 * copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice (including the next
 * paragraph) shall be included in all copies or substantial portions of the
 * Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.
 */

#include "ir.h"
#include "ir_visitor.h"
#include "ir_optimization.h"

/**
 * Pre-linking, optimize unused built-in variables
 *
 * Uniforms, constants, system values, inputs (vertex shader only), and
 * outputs (fragment shader only) that are not used can be removed.
 */
void
optimize_dead_builtin_variables(exec_list *instructions,
                                enum ir_variable_mode other)
{
   foreach_in_list_safe(ir_variable, var, instructions) {
      if (var->ir_type != ir_type_variable || var->data.used)
         continue;

      if (var->data.mode != ir_var_uniform
          && var->data.mode != ir_var_auto
          && var->data.mode != ir_var_system_value
          && var->data.mode != other)
         continue;

      /* So that linker rules can later be enforced, we cannot elimate
       * variables that were redeclared in the shader code.
       */
      if ((var->data.mode == other || var->data.mode == ir_var_system_value)
          && var->data.how_declared != ir_var_declared_implicitly)
         continue;

      if (!is_gl_identifier(var->name))
         continue;

      /* gl_ModelViewProjectionMatrix and gl_Vertex are special because they
       * are used by ftransform.  No other built-in variable is used by a
       * built-in function.  The forward declarations of these variables in
       * the built-in function shader does not have the "state slot"
       * information, so removing these variables from the user shader will
       * cause problems later.
       *
       * For compute shaders, gl_GlobalInvocationID has some dependencies, so
       * we avoid removing these dependencies.
       *
       * We also avoid removing gl_GlobalInvocationID at this stage because it
       * might be used by a linked shader. In this case it still needs to be
       * initialized by the main function.
       *
       *    gl_GlobalInvocationID =
       *       gl_WorkGroupID * gl_WorkGroupSize + gl_LocalInvocationID
       *
       * Similarly, we initialize gl_LocalInvocationIndex in the main function:
       *
       *    gl_LocalInvocationIndex =
       *       gl_LocalInvocationID.z * gl_WorkGroupSize.x * gl_WorkGroupSize.y +
       *       gl_LocalInvocationID.y * gl_WorkGroupSize.x +
       *       gl_LocalInvocationID.x;
       *
       * Matrix uniforms with "Transpose" are not eliminated because there's
       * an optimization pass that can turn references to the regular matrix
       * into references to the transpose matrix.  Eliminating the transpose
       * matrix would cause that pass to generate references to undeclareds
       * variables (thank you, ir_validate).
       *
       * It doesn't seem worth the effort to track when the transpose could be
       * eliminated (i.e., when the non-transpose was eliminated).
       */
      if (strcmp(var->name, "gl_ModelViewProjectionMatrix") == 0
          || strcmp(var->name, "gl_Vertex") == 0
          || strcmp(var->name, "gl_WorkGroupID") == 0
          || strcmp(var->name, "gl_WorkGroupSize") == 0
          || strcmp(var->name, "gl_LocalInvocationID") == 0
          || strcmp(var->name, "gl_GlobalInvocationID") == 0
          || strcmp(var->name, "gl_LocalInvocationIndex") == 0
          || strstr(var->name, "Transpose") != NULL)
         continue;

      var->remove();
   }
}
@


1.1.1.1
log
@Import Mesa 11.2.2
@
text
@@
