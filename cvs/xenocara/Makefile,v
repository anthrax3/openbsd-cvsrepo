head	1.77;
access;
symbols
	OPENBSD_6_2:1.77.0.4
	OPENBSD_6_2_BASE:1.77
	OPENBSD_6_1:1.77.0.2
	OPENBSD_6_1_BASE:1.77
	OPENBSD_6_0:1.70.0.2
	OPENBSD_6_0_BASE:1.70
	OPENBSD_5_9:1.68.0.2
	OPENBSD_5_9_BASE:1.68
	OPENBSD_5_8:1.66.0.2
	OPENBSD_5_8_BASE:1.66
	OPENBSD_5_7:1.63.0.2
	OPENBSD_5_7_BASE:1.63
	OPENBSD_5_6:1.60.0.2
	OPENBSD_5_6_BASE:1.60
	OPENBSD_5_5:1.55.0.2
	OPENBSD_5_5_BASE:1.55
	OPENBSD_5_4:1.51.0.4
	OPENBSD_5_4_BASE:1.51
	OPENBSD_5_3:1.51.0.2
	OPENBSD_5_3_BASE:1.51
	OPENBSD_5_2:1.46.0.2
	OPENBSD_5_2_BASE:1.46
	OPENBSD_5_1_BASE:1.44
	OPENBSD_5_1:1.44.0.2
	OPENBSD_5_0:1.41.0.2
	OPENBSD_5_0_BASE:1.41
	OPENBSD_4_9:1.40.0.2
	OPENBSD_4_9_BASE:1.40
	OPENBSD_4_8:1.37.0.2
	OPENBSD_4_8_BASE:1.37
	OPENBSD_4_7:1.35.0.2
	OPENBSD_4_7_BASE:1.35
	OPENBSD_4_6:1.29.0.2
	OPENBSD_4_6_BASE:1.29
	OPENBSD_4_5:1.28.0.2
	OPENBSD_4_5_BASE:1.28
	OPENBSD_4_4:1.26.0.2
	OPENBSD_4_4_BASE:1.26
	OPENBSD_4_3_BASE:1.25
	OPENBSD_4_3:1.25.0.2
	OPENBSD_4_2:1.21.0.2
	OPENBSD_4_2_BASE:1.21;
locks; strict;
comment	@# @;


1.77
date	2016.11.19.14.22.05;	author tb;	state Exp;
branches;
next	1.76;
commitid	0ACu8WF2n8D09TYK;

1.76
date	2016.11.19.08.56.27;	author tb;	state Exp;
branches;
next	1.75;
commitid	4lz11LcZNbZnWJqH;

1.75
date	2016.10.14.10.14.00;	author natano;	state Exp;
branches;
next	1.74;
commitid	vTNBawggvF7KQxhd;

1.74
date	2016.10.10.13.34.43;	author matthieu;	state Exp;
branches;
next	1.73;
commitid	EkQV3yf9tZSpUgE4;

1.73
date	2016.10.02.09.25.23;	author tb;	state Exp;
branches;
next	1.72;
commitid	aD5AZFAkYMjMgTWx;

1.72
date	2016.09.03.13.57.18;	author matthieu;	state Exp;
branches;
next	1.71;
commitid	j4eADgGSKUvvxUKQ;

1.71
date	2016.07.30.12.18.35;	author matthieu;	state Exp;
branches;
next	1.70;
commitid	UJ4wwOuSgp5NvvWe;

1.70
date	2016.04.01.03.15.15;	author jsg;	state Exp;
branches;
next	1.69;
commitid	q3HsDrq7nfLMWLnS;

1.69
date	2016.03.11.13.09.42;	author okan;	state Exp;
branches;
next	1.68;
commitid	rypizj9eWLMTQq0Q;

1.68
date	2015.08.24.10.41.21;	author ajacoutot;	state Exp;
branches;
next	1.67;
commitid	ha9Dm2qAnqcras0k;

1.67
date	2015.08.23.18.50.33;	author deraadt;	state Exp;
branches;
next	1.66;
commitid	M75jgBWDt70Gzonj;

1.66
date	2015.07.19.10.44.05;	author matthieu;	state Exp;
branches;
next	1.65;
commitid	U9rXt2Xt9xAw3KEO;

1.65
date	2015.07.01.20.10.39;	author deraadt;	state Exp;
branches;
next	1.64;
commitid	I1G0WpDtOdMSWtaK;

1.64
date	2015.06.18.11.46.16;	author deraadt;	state Exp;
branches;
next	1.63;
commitid	yKxg3ZjkPYfIJdDU;

1.63
date	2014.11.27.11.37.45;	author ajacoutot;	state Exp;
branches;
next	1.62;
commitid	w4hF9Bmm5Ku5O6Hh;

1.62
date	2014.09.28.20.48.59;	author rpe;	state Exp;
branches;
next	1.61;
commitid	MyybmUvZ0Mnpwrul;

1.61
date	2014.08.28.17.08.33;	author matthieu;	state Exp;
branches;
next	1.60;
commitid	V1mFhx4vmKpsouti;

1.60
date	2014.07.16.21.38.36;	author ajacoutot;	state Exp;
branches;
next	1.59;
commitid	ULg0KkpSth0KTJBc;

1.59
date	2014.07.11.13.45.54;	author matthieu;	state Exp;
branches;
next	1.58;
commitid	k6IRhvCya0qwf4TO;

1.58
date	2014.07.10.07.13.13;	author espie;	state Exp;
branches;
next	1.57;
commitid	ruHFrC60cyflIHAt;

1.57
date	2014.04.18.10.02.45;	author schwarze;	state Exp;
branches;
next	1.56;

1.56
date	2014.03.24.20.41.19;	author sthen;	state Exp;
branches;
next	1.55;

1.55
date	2014.01.10.00.17.54;	author todd;	state Exp;
branches;
next	1.54;

1.54
date	2013.10.25.18.12.59;	author miod;	state Exp;
branches;
next	1.53;

1.53
date	2013.09.09.19.17.09;	author espie;	state Exp;
branches;
next	1.52;

1.52
date	2013.08.22.18.48.45;	author miod;	state Exp;
branches;
next	1.51;

1.51
date	2013.02.21.17.45.32;	author todd;	state Exp;
branches;
next	1.50;

1.50
date	2012.12.01.21.10.42;	author miod;	state Exp;
branches;
next	1.49;

1.49
date	2012.10.29.21.19.16;	author matthieu;	state Exp;
branches;
next	1.48;

1.48
date	2012.10.17.08.48.43;	author espie;	state Exp;
branches;
next	1.47;

1.47
date	2012.08.18.10.38.39;	author espie;	state Exp;
branches;
next	1.46;

1.46
date	2012.04.01.23.00.24;	author matthieu;	state Exp;
branches;
next	1.45;

1.45
date	2012.04.01.09.24.04;	author matthieu;	state Exp;
branches;
next	1.44;

1.44
date	2012.02.07.19.54.55;	author matthieu;	state Exp;
branches;
next	1.43;

1.43
date	2012.01.16.08.42.38;	author schwarze;	state Exp;
branches;
next	1.42;

1.42
date	2012.01.06.23.40.08;	author schwarze;	state Exp;
branches;
next	1.41;

1.41
date	2011.03.07.22.17.31;	author matthieu;	state Exp;
branches;
next	1.40;

1.40
date	2011.02.22.00.24.35;	author espie;	state Exp;
branches;
next	1.39;

1.39
date	2010.09.04.10.41.57;	author matthieu;	state Exp;
branches;
next	1.38;

1.38
date	2010.08.25.17.42.18;	author todd;	state Exp;
branches;
next	1.37;

1.37
date	2010.08.10.20.55.50;	author todd;	state Exp;
branches
	1.37.2.1;
next	1.36;

1.36
date	2010.05.11.18.51.21;	author espie;	state Exp;
branches;
next	1.35;

1.35
date	2010.01.31.14.28.45;	author matthieu;	state Exp;
branches;
next	1.34;

1.34
date	2010.01.10.13.36.10;	author ajacoutot;	state Exp;
branches;
next	1.33;

1.33
date	2009.12.01.21.36.52;	author matthieu;	state Exp;
branches;
next	1.32;

1.32
date	2009.11.26.22.53.50;	author matthieu;	state Exp;
branches;
next	1.31;

1.31
date	2009.10.01.19.48.31;	author matthieu;	state Exp;
branches;
next	1.30;

1.30
date	2009.09.10.19.28.23;	author matthieu;	state Exp;
branches;
next	1.29;

1.29
date	2009.05.20.18.26.32;	author miod;	state Exp;
branches;
next	1.28;

1.28
date	2009.02.02.20.57.55;	author matthieu;	state Exp;
branches;
next	1.27;

1.27
date	2008.10.05.08.06.06;	author matthieu;	state Exp;
branches;
next	1.26;

1.26
date	2008.06.12.21.58.28;	author matthieu;	state Exp;
branches;
next	1.25;

1.25
date	2008.01.31.22.34.40;	author matthieu;	state Exp;
branches;
next	1.24;

1.24
date	2008.01.05.20.22.38;	author espie;	state Exp;
branches;
next	1.23;

1.23
date	2007.12.20.06.52.03;	author matthieu;	state Exp;
branches;
next	1.22;

1.22
date	2007.10.27.20.01.23;	author matthieu;	state Exp;
branches;
next	1.21;

1.21
date	2007.06.11.15.27.51;	author todd;	state Exp;
branches;
next	1.20;

1.20
date	2007.03.31.20.25.53;	author matthieu;	state Exp;
branches;
next	1.19;

1.19
date	2007.03.28.19.41.15;	author matthieu;	state Exp;
branches;
next	1.18;

1.18
date	2007.03.28.00.22.03;	author todd;	state Exp;
branches;
next	1.17;

1.17
date	2007.03.26.19.58.54;	author matthieu;	state Exp;
branches;
next	1.16;

1.16
date	2007.03.16.23.54.43;	author todd;	state Exp;
branches;
next	1.15;

1.15
date	2007.03.16.21.04.42;	author todd;	state Exp;
branches;
next	1.14;

1.14
date	2006.12.31.13.55.44;	author matthieu;	state Exp;
branches;
next	1.13;

1.13
date	2006.12.31.10.52.07;	author matthieu;	state Exp;
branches;
next	1.12;

1.12
date	2006.12.31.10.40.23;	author matthieu;	state Exp;
branches;
next	1.11;

1.11
date	2006.12.23.13.08.07;	author matthieu;	state Exp;
branches;
next	1.10;

1.10
date	2006.12.17.22.47.35;	author matthieu;	state Exp;
branches;
next	1.9;

1.9
date	2006.12.17.20.41.36;	author matthieu;	state Exp;
branches;
next	1.8;

1.8
date	2006.12.17.20.15.39;	author matthieu;	state Exp;
branches;
next	1.7;

1.7
date	2006.11.30.23.22.15;	author matthieu;	state Exp;
branches;
next	1.6;

1.6
date	2006.11.30.17.12.58;	author matthieu;	state Exp;
branches;
next	1.5;

1.5
date	2006.11.30.14.07.20;	author todd;	state Exp;
branches;
next	1.4;

1.4
date	2006.11.29.22.45.03;	author matthieu;	state Exp;
branches;
next	1.3;

1.3
date	2006.11.29.21.52.18;	author matthieu;	state Exp;
branches;
next	1.2;

1.2
date	2006.11.29.17.42.27;	author matthieu;	state Exp;
branches;
next	1.1;

1.1
date	2006.11.26.14.00.56;	author matthieu;	state Exp;
branches;
next	;

1.37.2.1
date	2010.11.19.01.22.27;	author william;	state Exp;
branches;
next	;


desc
@@


1.77
log
@Enable builds with a dedicated user for xenocara as well.

"push forward" deraadt; no objections matthieu; testing, input & ok rpe
@
text
@# $OpenBSD: Makefile,v 1.76 2016/11/19 08:56:27 tb Exp $
.include <bsd.own.mk>
.include <bsd.xconf.mk>

LOCALAPPD=/usr/local/lib/X11/app-defaults
LOCALAPPX=/usr/local/lib/X11
REALAPPD=/etc/X11/app-defaults
RM?=rm

XSERVER= xserver

SUBDIR= proto font/util data/bitmaps lib app data \
	${XSERVER} driver util doc
.ifndef NOFONTS
SUBDIR+= font
.endif
SUBDIR+= distrib/notes

NOOBJ=

.if defined(DESTDIR)
build:
	@@echo "Cannot run ${MAKE} build with DESTDIR set"
	@@exit 2
.else
build:
	umask ${WOBJUMASK}; exec ${MAKE} do-build

do-build: 
	@@if [[ `id -u` -ne 0 ]]; then \
		echo $@@ must be called by root >&2; \
		false; \
	fi
	exec ${MAKE} bootstrap-root
	cd util/macros && \
	    exec su ${BUILDUSER} -c 'exec ${MAKE} -f Makefile.bsd-wrapper'
	exec ${MAKE} beforebuild
	exec ${MAKE} realbuild
	exec ${MAKE} afterbuild
.endif

realbuild: _SUBDIRUSE
	# that's all folks

bootstrap:
	@@if [[ `id -u` -ne 0 ]]; then \
		echo $@@ must be called by root >&2; \
		false; \
	fi
	exec ${MAKE} bootstrap-root

bootstrap-root:
	exec ${MAKE} distrib-dirs
	exec ${MAKE} install-mk

beforeinstall beforebuild:
	cd util/macros && exec ${MAKE} -f Makefile.bsd-wrapper install

afterinstall afterbuild:
	exec ${MAKE} fix-appd
	/usr/sbin/makewhatis -Qv ${DESTDIR}/usr/X11R6/man
	chown root:wheel ${DESTDIR}/usr/X11R6/man/mandoc.db
	chmod 644 ${DESTDIR}/usr/X11R6/man/mandoc.db
	touch ${DESTDIR}/var/sysmerge/xetcsum
	cd ${DESTDIR}/ && \
		sort ${.CURDIR}/distrib/sets/lists/xetc/{mi,md.${MACHINE}} | \
		xargs sha256 -h ${DESTDIR}/var/sysmerge/xetcsum || true
	chown root:wheel ${DESTDIR}/var/sysmerge/xetcsum
	chmod 644 ${DESTDIR}/var/sysmerge/xetcsum
	cd distrib/sets && exec ${MAKE}

install-mk:
	cd share/mk && exec ${MAKE} X11BASE=${X11BASE} install

fix-appd:
	# Make sure /usr/local/lib/X11/app-defaults is a link
	if [ ! -L $(DESTDIR)${LOCALAPPD} ]; then \
	    if [ -d $(DESTDIR)${LOCALAPPD} ]; then \
		mv $(DESTDIR)${LOCALAPPD}/* $(DESTDIR)${REALAPPD} || true; \
		rmdir $(DESTDIR)${LOCALAPPD}; \
	    fi; \
	    mkdir -p ${DESTDIR}${LOCALAPPX}; \
	    ln -s ${REALAPPD} ${DESTDIR}${LOCALAPPD}; \
	    chown -h root:wheel ${DESTDIR}${LOCALAPPD}; \
	fi

font-cache:
	cd font/alias && exec ${MAKE} -f Makefile.bsd-wrapper afterinstall

.if ! ( defined(DESTDIR) && defined(RELEASEDIR) )
release:
	@@echo You must set DESTDIR and RELEASEDIR for a release.; exit 255
.else
release: sha

sha: release-clean release-install dist hash

hash: dist
	-cd ${RELEASEDIR}; \
		cksum -a sha256 x*tgz > SHA256

.ORDER: release-clean release-install dist hash
.endif

release-clean:
	${RM} -rf ${DESTDIR}/usr/X11R6/* ${DESTDIR}/usr/X11R6/.[a-zA-Z0-9]*
	${RM} -rf ${DESTDIR}/var/cache/*
	${RM} -rf ${DESTDIR}/etc/X11/*
	${RM} -rf ${DESTDIR}/etc/fonts/*
	@@if [ -d ${DESTDIR}/usr/X11R6 ] && [ "`cd ${DESTDIR}/usr/X11R6;ls`" ]; then \
		echo "Files found in ${DESTDIR}/usr/X11R6:"; \
		(cd ${DESTDIR}/usr/X11R6;/bin/pwd;ls -a); \
		echo "Cleanup before proceeding."; \
		exit 255; \
	fi

release-install:
	@@exec ${MAKE} bootstrap-root
	@@exec ${MAKE} install

dist-rel:
	${MAKE} RELEASEDIR=`pwd`/rel DESTDIR=`pwd`/dest dist 2>&1 | tee distlog

dist:
	cd distrib/sets && \
		env MACHINE=${MACHINE} ksh ./maketars ${OSrev} ${OSREV}

checkdist:
	@@cd distrib/sets && \
		{ env MACHINE=${MACHINE} ksh ./checkflist ${OSREV} || true ; }

distrib-dirs:
.if defined(DESTDIR) && ${DESTDIR} != ""
	# running mtree under ${DESTDIR}
	mtree -qdef /etc/mtree/BSD.x11.dist -p ${DESTDIR} -U
.else
	# running mtree
	mtree -qdef /etc/mtree/BSD.x11.dist -p / -U
.endif


.PHONY: all build beforeinstall install afterinstall release clean cleandir \
	dist distrib-dirs fix-appd beforebuild bootstrap afterbuild realbuild \
	install-mk bootstrap-root

.include <bsd.subdir.mk>
.include <bsd.xorg.mk>
@


1.76
log
@Set permissions of mandoc.db and xetcsum explicitly, so they don't
depend on the umask.

push forward deraadt; no objections matthieu
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.75 2016/10/14 10:14:00 natano Exp $
d26 4
a29 1
build: 
@


1.75
log
@Port the de-escalation mechanism we have in src to xenocara's make
bootstrap/obj/build. This is now possible due to a normal build not
writing to the source tree anymore.

ok deraadt
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.74 2016/10/10 13:34:43 matthieu Exp $
d60 1
d66 1
@


1.74
log
@Remove the global 'make includes' step from 'make build'.
This is no longer needed and gets in the way of tightening
permission used during build. ok and suggestions natano@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.73 2016/10/02 09:25:23 tb Exp $
d27 8
a34 3
	exec ${SUDO} ${MAKE} bootstrap-root
	cd util/macros && exec ${MAKE} -f Makefile.bsd-wrapper
	exec ${SUDO} ${MAKE} beforebuild
d36 1
a36 1
	exec ${SUDO} ${MAKE} afterbuild
d43 5
a47 1
	exec ${SUDO} ${MAKE} bootstrap-root
@


1.73
log
@Set owner and group of the mandoc.db, the xetcsum file for sysmerge
and of the app-defaults symlink.  Needed for noperm release.

ok matthieu
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.72 2016/09/03 13:57:18 matthieu Exp $
a45 1
	exec ${MAKE} includes
@


1.72
log
@Remove zaurus support
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.71 2016/07/30 12:18:35 matthieu Exp $
d51 1
d56 1
d71 1
@


1.71
log
@Merge the build of Xephyr in the main xserver build.

Recent X server doesn't require to build the DIX with different
options for xfree86 and kdrive.

Tested for beeing a no-op on m88k by Kenji Aoyama. Thanks
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.70 2016/04/01 03:15:15 jsg Exp $
a7 1
XCONFIG=${XSRCDIR}/etc/X11.${MACHINE}/xorg.conf
a102 8
.if ${MACHINE} == zaurus
	@@if [ -f $(DESTDIR)/etc/X11/xorg.conf ]; then \
	 echo "Not overwriting existing" $(DESTDIR)/etc/X11/xorg.conf; \
	else set -x; \
	 ${INSTALL} ${INSTALL_COPY} -o root -g wheel -m 644 \
		${XCONFIG} ${DESTDIR}/etc/X11 ; \
	fi
.endif
@


1.70
log
@remove XENOCARA_BUILD_PIXMAN all platforms now build pixman
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.69 2016/03/11 13:09:42 okan Exp $
a11 6

.if defined(XENOCARA_BUILD_GL)
.if ${XENOCARA_BUILD_GL:L} == "yes"
XSERVER+= kdrive
.endif
.endif
@


1.69
log
@Remove support vax and XENOCARA_HAVE_SHARED_LIBS scaffolding.

ok matthieu@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.68 2015/08/24 10:41:21 ajacoutot Exp $
d13 2
a14 3
.if defined(XENOCARA_BUILD_PIXMAN)
.if ${XENOCARA_BUILD_PIXMAN:L} == "yes" && \
    ${XENOCARA_BUILD_GL:L} == "yes"
@


1.68
log
@/usr/share/sysmerge -> /var/sysmerge

requested by several
discussed with deraadt@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.67 2015/08/23 18:50:33 deraadt Exp $
a10 1
.if ${MACHINE_ARCH} != "vax"
a11 1
.endif
d15 1
a15 2
    ${XENOCARA_BUILD_GL:L} == "yes" && \
    ${XENOCARA_HAVE_SHARED_LIBS:L} == "yes"
@


1.67
log
@do checkflist like base -- meaning, don't do it automatically.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.66 2015/07/19 10:44:05 matthieu Exp $
d62 1
a62 1
	touch ${DESTDIR}/usr/share/sysmerge/xetcsum
d65 1
a65 1
		xargs sha256 -h ${DESTDIR}/usr/share/sysmerge/xetcsum || true
@


1.66
log
@Complain if 'make build' is run with DESTDIR set.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.65 2015/07/01 20:10:39 deraadt Exp $
d129 1
a129 2
		env MACHINE=${MACHINE} ksh ./maketars ${OSrev} ${OSREV} && \
		{ env MACHINE=${MACHINE} ksh ./checkflist ${OSREV} || true ; }
@


1.65
log
@silence checkflist command, like base
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.64 2015/06/18 11:46:16 deraadt Exp $
d32 5
d43 1
@


1.64
log
@better sets checking target
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.63 2014/11/27 11:37:45 ajacoutot Exp $
d127 1
a127 1
	cd distrib/sets && \
@


1.63
log
@Create xetcsum at build time like we do in src. This prevents ending up
with an empty file...

issue reported by sthen@@
ok rpe@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.62 2014/09/28 20:48:59 rpe Exp $
d126 3
@


1.62
log
@Create xetc.tgz without intermediate file.

OK matthieu@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.61 2014/08/28 17:08:33 matthieu Exp $
d56 4
a115 1
	touch ${DESTDIR}/usr/share/sysmerge/xetcsum
a116 3
	cd ${DESTDIR} && \
		sort ${.CURDIR}/distrib/sets/lists/xetc/{mi,md.${MACHINE}} | \
		xargs sha256 -h ${DESTDIR}/usr/share/sysmerge/xetcsum || true
@


1.61
log
@Move xetc set to xbase like etc in base. ok and a tweak by ajacoutot@@

There are still some issues, they will be fixed in tree.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.60 2014/07/16 21:38:36 ajacoutot Exp $
a113 2
	XETCLIST=`mktemp /tmp/_xetcsum.XXXXXXXXXX` || exit 1; \
	sort distrib/sets/lists/xetc/{mi,md.${MACHINE}} > $${XETCLIST}; \
d115 2
a116 2
		xargs sha256 -h ${DESTDIR}/usr/share/sysmerge/xetcsum < $${XETCLIST} || true; \
	rm -f $${XETCLIST}
@


1.60
log
@Unbreak release after recent sysmerge sum file changes.

quikly discussed with deraadt@@ todd@@ matthieu@@
other fallout can be worked in tree
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.59 2014/07/11 13:45:54 matthieu Exp $
a103 1
	@@exec ${MAKE} install
d113 1
@


1.59
log
@remove extra ${SUDO} in release-install target.
This target can only be run as root already.
ok espie@@ todd@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.58 2014/07/10 07:13:13 espie Exp $
d113 3
a115 3
	touch ${DESTDIR}/var/db/sysmerge/xetcsum
	TMPSUM=`mktemp /tmp/_xetcsum.XXXXXXXXXX` || exit 1; \
	sort distrib/sets/lists/xetc/{mi,md.${MACHINE}} > $${TMPSUM}; \
d117 2
a118 2
		xargs cksum < $${TMPSUM} > ${DESTDIR}/var/db/sysmerge/xetcsum; \
	rm -f $${TMPSUM}
@


1.58
log
@locate db in X, named xorg.db to please matthieu
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.57 2014/04/18 10:02:45 schwarze Exp $
d103 1
a103 1
	@@exec ${SUDO} ${MAKE} bootstrap-root
@


1.57
log
@Reduce the build time for the makewhatis(8) step by roughly a factor of 3.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.56 2014/03/24 20:41:19 sthen Exp $
d56 1
@


1.56
log
@sum -> cksum
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.55 2014/01/10 00:17:54 todd Exp $
d55 1
a55 1
	/usr/libexec/makewhatis -v ${DESTDIR}/usr/X11R6/man
@


1.55
log
@add sha: target like src/etc/Makefile .. prodded by deraadt@@
I also added a hash: target so I can re-roll tarballs w/out re-populating destdir/
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.54 2013/10/25 18:12:59 miod Exp $
d84 1
a84 1
		sum -a sha256 x*tgz > SHA256
@


1.54
log
@Do not attempt to build kdrive if we did not build Mesa, for its configure
script looks for libGL.

ok matthieu@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.53 2013/09/09 19:17:09 espie Exp $
d78 9
a86 2
release: release-clean release-install dist
.ORDER: release-clean release-install dist
@


1.53
log
@move the DESTDIR/RELEASEDIR check to the main target
okay matthieu@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.52 2013/08/22 18:48:45 miod Exp $
d17 1
@


1.52
log
@Remove COMPILER_VERSION tests used to special-case gcc 2, since it is no
longer used.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.51 2013/02/21 17:45:32 todd Exp $
d73 4
d79 1
a81 3
.if ! ( defined(DESTDIR) && defined(RELEASEDIR) )
	@@echo You must set DESTDIR and RELEASEDIR for a release.; exit 255
.endif
@


1.51
log
@after a compiler update, landisk can now handle pixman and thus xserver again
prodded by brad@@, ok matthieu@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.50 2012/12/01 21:10:42 miod Exp $
d16 1
a16 1
.if ${COMPILER_VERSION:L:Mgcc[34]*} && ${XENOCARA_BUILD_PIXMAN:L} == "yes" && \
@


1.50
log
@Do not build kdrive on static arches, for libGL doesn't get build on them.
ok matthieu@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.49 2012/10/29 21:19:16 matthieu Exp $
d11 1
a11 1
.if ${MACHINE_ARCH} != "sh" && ${MACHINE_ARCH} != "vax"
@


1.49
log
@Unlink share/pciids from the build. The generated file is not
used by xserver anymore.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.48 2012/10/17 08:48:43 espie Exp $
d16 2
a17 1
.if ${COMPILER_VERSION:L:Mgcc[34]*} && ${XENOCARA_BUILD_PIXMAN:L} == "yes"
@


1.48
log
@if the directory is empty, the mv will fail.
But we don't really care, because the real test for success is the rmdir.
okay matthieu@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.47 2012/08/18 10:38:39 espie Exp $
a25 1
SUBDIR+= share/pciids
@


1.47
log
@let build and release proceed through the exact same steps, avoiding
nasty surprises...

REQUIRES current /usr/share/mk (cd /usr/src/share/mk && make install)

okay matthieu@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.46 2012/04/01 23:00:24 matthieu Exp $
d63 1
a63 1
		mv $(DESTDIR)${LOCALAPPD}/* $(DESTDIR)${REALAPPD}; \
@


1.46
log
@Fix previous for bootstrap.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.45 2012/04/01 09:24:04 matthieu Exp $
d31 9
a39 1
build: beforebuild _SUBDIRUSE
d42 12
a53 18
	${SUDO} ${MAKE} distrib-dirs
	cd ${.CURDIR}/share/mk \
		&& exec ${SUDO} ${MAKE} X11BASE=${X11BASE} install

beforebuild: bootstrap
	cd ${.CURDIR}/util/macros \
		&& ${MAKE} -f Makefile.bsd-wrapper \
		&& exec ${SUDO} ${MAKE} -f Makefile.bsd-wrapper install
	exec ${SUDO} ${MAKE} includes

beforeinstall:
	${MAKE} distrib-dirs
	${MAKE} includes

afterinstall:
	${MAKE} install-mk
	${MAKE} fix-appd
	${MAKE} font-cache
a55 2
realinstall: _SUBDIRUSE

d57 1
a57 12
.if defined(DESTDIR) && (${DESTDIR} != "" || ${DESTDIR} != "/")
	cd ${.CURDIR}/share/mk \
		&& ${MAKE} X11BASE=${X11BASE} install
.endif

font-cache:
	@@echo "running fc-cache"
	if test -z "$(DESTDIR)"; then \
		fc-cache -s -v ;\
	else\
		fc-cache -c ${DESTDIR} -s -v ;\
	fi
d70 5
a74 2
release: release-clean distrib-dirs release-install dist
.ORDER: release-clean distrib-dirs release-install dist
d92 2
a93 1
	@@${MAKE} install
d115 1
a115 1
		(env MACHINE=${MACHINE} ksh ./checkflist ${OSREV} || true)
d120 1
d123 1
d129 2
a130 1
	dist distrib-dirs fix-appd
@


1.45
log
@Don't build kdrive if pixman isn't built.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.44 2012/02/07 19:54:55 matthieu Exp $
d15 1
d18 1
@


1.44
log
@Don't install xorg.conf on machines with no X server.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.43 2012/01/16 08:42:38 schwarze Exp $
d3 1
d15 1
a15 1
.if ${COMPILER_VERSION:L:Mgcc[34]*}
@


1.43
log
@Backout activation of the new apropos(1)/whatis(1)/makewhatis(8).
In its current state, it causes too much slowdown, in particular
during system builds, and there are other regressions.
That cannot be fixed quickly while it's enabled.

Problems pointed out by espie@@, backout requested by deraadt@@,
diff "looks good" to espie@@.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.42 2012/01/06 23:40:08 schwarze Exp $
d45 1
a45 1
afterinstall: 
d98 1
a98 2
.if ${MACHINE} == alpha || ${MACHINE} == hp300 || \
    ${MACHINE} == mac68k || ${MACHINE} == zaurus
@


1.42
log
@Let makewhatis(8) build the whatis.db quietly.
ok todd@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.41 2011/03/07 22:17:31 matthieu Exp $
d49 1
a49 1
	/usr/libexec/makewhatis ${DESTDIR}/usr/X11R6/man
@


1.41
log
@Descend into data/ not data/xkbdata explicitely here.
Change suggested by shadchin@@, needed for upcoming patches.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.40 2011/02/22 00:24:35 espie Exp $
d49 1
a49 1
	/usr/libexec/makewhatis -v ${DESTDIR}/usr/X11R6/man
@


1.40
log
@run makewhatis -v
(needs -current !)
okay miod@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.39 2010/09/04 10:41:57 matthieu Exp $
d18 1
a18 1
SUBDIR= proto font/util data/bitmaps lib app data/xkbdata \
@


1.39
log
@Remove macppc default xorg.conf. Discussed with ajacoutot@@, drahn@@ oga@@
and todd@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.38 2010/08/25 17:42:18 todd Exp $
d49 1
a49 1
	/usr/libexec/makewhatis ${DESTDIR}/usr/X11R6/man
@


1.38
log
@make 'make release' work on vax
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.37 2010/08/10 20:55:50 todd Exp $
d99 1
a99 2
    ${MACHINE} == mac68k || ${MACHINE} == macppc || \
    ${MACHINE} == zaurus
@


1.37
log
@permit sgi/loongson to make a release with no xorg.conf,
broken since xorg.conf was removed for these archs
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.36 2010/05/11 18:51:21 espie Exp $
d100 1
a100 1
    ${MACHINE} == vax || ${MACHINE} == zaurus
@


1.37.2.1
log
@MFC:

- - -
revision 1.38
date: 2010/08/25 17:42:18;  author: todd;  state: Exp;  lines: +2 -2
make 'make release' work on vax
- - -

requested by todd
"commit" matthieu
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.37 2010/08/10 20:55:50 todd Exp $
d100 1
a100 1
    ${MACHINE} == zaurus
@


1.36
log
@allow gcc4 switch, okay matthieu@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.35 2010/01/31 14:28:45 matthieu Exp $
d98 2
a99 2
.if ${MACHINE} == alpha || ${MACHINE} == hp300 || ${MACHINE} == loongson || \
    ${MACHINE} == mac68k || ${MACHINE} == macppc || ${MACHINE} == sgi || \
@


1.35
log
@xorg.conf for loongson.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.34 2010/01/10 13:36:10 ajacoutot Exp $
d14 1
a14 1
.if ${USE_GCC3:L} == "yes"
@


1.34
log
@Create and distribute the initial sysmerge sum file just like we do for
base on new installations.

"reads alright" oga@@, ok matthieu@@ todd@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.33 2009/12/01 21:36:52 matthieu Exp $
d98 2
a99 2
.if ${MACHINE} == alpha || ${MACHINE} == hp300 || ${MACHINE} == mac68k || \
    ${MACHINE} == macppc || ${MACHINE} == sgi || \
@


1.33
log
@Move back build of xtsscale with other apps. It doesn't require
an installed header anymore.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.32 2009/11/26 22:53:50 matthieu Exp $
d108 6
@


1.32
log
@Move app/xtsscale build after drivers, since it requires a
header installed by driver/xf86-input-ws.
Problem noticed by jdixon@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.31 2009/10/01 19:48:31 matthieu Exp $
d19 1
a19 1
	${XSERVER} driver app/xtsscale util doc
@


1.31
log
@Use the installed /etc/mtree/BSD.x11.dist file now that it's up-to-date.
Further mtree updates will go to /usr/src/etc/mtree/BSD.x11.dist directly.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.30 2009/09/10 19:28:23 matthieu Exp $
d18 2
a19 1
SUBDIR= proto data/bitmaps lib app data/xkbdata ${XSERVER} driver util doc
@


1.30
log
@Completely disable xserver on vax, it generates a gcc segmentation
violation in xkb/xkbEvents.c. ok todd@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.29 2009/05/20 18:26:32 miod Exp $
d119 1
a119 1
	mtree -qdef ${.CURDIR}/etc/mtree/BSD.x11.dist -p ${DESTDIR} -U
d121 1
a121 1
	mtree -qdef ${.CURDIR}/etc/mtree/BSD.x11.dist -p / -U
@


1.29
log
@Sync with sparc wsmouse changes.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.28 2009/02/02 20:57:55 matthieu Exp $
d10 1
a10 1
.if ${MACHINE_ARCH} != "sh"
@


1.28
log
@Enable build of kdrive/Xephyr on gcc3 arches. ok todd@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.27 2008/10/05 08:06:06 matthieu Exp $
d98 1
a98 1
    ${MACHINE} == macppc || ${MACHINE} == sparc || ${MACHINE} == sgi || \
@


1.27
log
@provide a pciutils style pci.ids file for libpciaccess.
ok todd@@ deraadt@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.26 2008/06/12 21:58:28 matthieu Exp $
d12 4
@


1.26
log
@Actually install xorg.conf for sgi when building a release, so that
it ends up in the xetc set...
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.25 2008/01/31 22:34:40 matthieu Exp $
d18 1
@


1.25
log
@Merge the two xenocara mtree specs into a unique one, rooted at /
ok todd@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.24 2008/01/05 20:22:38 espie Exp $
d93 2
a94 2
    ${MACHINE} == macppc || ${MACHINE} == sparc || ${MACHINE} == vax || \
    ${MACHINE} == zaurus
@


1.24
log
@fix release for make -j
okay matthieu@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.23 2007/12/20 06:52:03 matthieu Exp $
d113 6
a118 10
	if [ ! -d ${DESTDIR}${X11BASE}/. ]; then \
		${INSTALL} -d -o root -g wheel -m 755 ${DESTDIR}${X11BASE}/; \
	fi
	mtree -qdef ${.CURDIR}/etc/mtree/BSD.x11.dist \
		-p ${DESTDIR}${X11BASE}/ -U
	if [ ! -d ${DESTDIR}${X11ETC}/. ]; then \
		${INSTALL} -d -o root -g wheel -m 755 ${DESTDIR}${X11ETC}/; \
	fi
	mtree -qdef ${.CURDIR}/etc/mtree/BSD.etc-x11.dist \
		-p ${DESTDIR}${X11ETC}/ -U
@


1.23
log
@Don't try to build xserver on landisk. it now depends on lib/pixman
which doesn't build because of gcc problems.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.22 2007/10/27 20:01:23 matthieu Exp $
d73 1
@


1.22
log
@Rebuild the fontcache at the end of make install.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.21 2007/06/11 15:27:51 todd Exp $
d10 5
a14 1
SUBDIR= proto data/bitmaps lib app data/xkbdata xserver driver util doc
@


1.21
log
@no need to recurse into distrib/notes twice
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.20 2007/03/31 20:25:53 matthieu Exp $
d38 1
d48 8
@


1.20
log
@XENOCARA_TOP -> XSRCDIR and now defaults to /usr/src/xenocara
XENOCARA_OBJDIR -> XOBJDIR  and now defaults to /usr/xobj
suggested by espie@@ ok krw@@ mbalmer@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.19 2007/03/28 19:41:15 matthieu Exp $
a37 1
	cd distrib/notes; ${MAKE} install
@


1.19
log
@use exec for recursive make invocations.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.18 2007/03/28 00:22:03 todd Exp $
d7 1
a7 1
XCONFIG=${XENOCARA_TOP}/etc/X11.${MACHINE}/xorg.conf
@


1.18
log
@make obj in distrib/notes/ to avoid writing to the src tree, and
make it a regular SUBDIR
ok matthieu@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.17 2007/03/26 19:58:54 matthieu Exp $
d23 1
a23 1
		&& ${SUDO} ${MAKE} X11BASE=${X11BASE} install
d28 2
a29 2
		&& ${SUDO} ${MAKE} -f Makefile.bsd-wrapper install
	${SUDO} ${MAKE} includes
@


1.17
log
@set XCONFIG for release-install
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.16 2007/03/16 23:54:43 todd Exp $
d14 1
@


1.16
log
@add `dist' to .PHONY
pointed out by Ingo Schwarze, schwarze at usta dot de, Thanks!
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.15 2007/03/16 21:04:42 todd Exp $
d7 1
@


1.15
log
@borrow a line from XF4/Makefile that defines RM and
permits 'make release' to have a chance
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.14 2006/12/31 13:55:44 matthieu Exp $
d110 1
a110 1
	distrib-dirs fix-appd
@


1.14
log
@More fixes:
- install bsd.xorg.mk in DESTDIR in postinstall
- don't use dependencies in postinstall
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.13 2006/12/31 10:52:07 matthieu Exp $
d7 1
@


1.13
log
@set X11BASE explicitely when installing bsd.xorg.mk, because
the Makefile there doesn't see /usr/share/mk/bsd.xorg.mk.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.12 2006/12/31 10:40:23 matthieu Exp $
a11 3
.ifmake(install)
SUBDIR+= share/mk
.endif
d32 3
a34 1
afterinstall: fix-appd
d39 6
@


1.12
log
@Remove redundant X11BASE setting.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.11 2006/12/23 13:08:07 matthieu Exp $
d23 1
a23 1
		&& ${SUDO} ${MAKE} install
@


1.11
log
@- Bring in the /usr/local/lib/X11/app-default handling from XF4 Makefile
- Repair subdir recursion. noticed by Frederick C. Druseikis.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.10 2006/12/17 22:47:35 matthieu Exp $
a2 2

X11BASE?=	/usr/X11R6
@


1.10
log
@fix make obj after recent changes
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.9 2006/12/17 20:41:36 matthieu Exp $
d6 4
d37 1
a37 1
afterinstall:
d43 10
a52 1
obj: _SUBDIRUSE
d106 1
a106 1
	distrib-dirs
d108 1
@


1.9
log
@make the install target more similar to what is done in the base system.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.8 2006/12/17 20:15:39 matthieu Exp $
d14 1
a14 1
NOOBJS=
d38 2
@


1.8
log
@remove update target
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.7 2006/11/30 23:22:15 matthieu Exp $
d33 2
a34 1
afterinstall: install-distrib
d37 1
a37 2
install-distrib:
	cd distrib/notes; ${MAKE} install
a55 1

d90 2
a91 1
.PHONY: all build beforeinstall install afterinstall release clean cleandir
a92 1
.include <bsd.subdir.mk>
@


1.7
log
@Fix the install target: one typo and one thinko, probably caused by
committing while tired.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.6 2006/11/30 17:12:58 matthieu Exp $
a89 2

update: _SUBDIRUSE
@


1.6
log
@revert
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.4 2006/11/29 22:45:03 matthieu Exp $
d33 1
a33 1
install: instal-distrib
@


1.5
log
@give a chance of building by referencing the right mtree file
@
text
@d88 1
a88 1
	mtree -qdef ${.CURDIR}/etc/mtree/BSD.x11-etc.dist \
@


1.4
log
@doc needs to be build after util.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.3 2006/11/29 21:52:18 matthieu Exp $
d88 1
a88 1
	mtree -qdef ${.CURDIR}/etc/mtree/BSD.etc-x11.dist \
@


1.3
log
@(untested) release bits)
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.2 2006/11/29 17:42:27 matthieu Exp $
d6 1
a6 1
SUBDIR= proto data/bitmaps lib app data/xkbdata xserver driver doc util
@


1.2
log
@Hook docs to the build
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.1 2006/11/26 14:00:56 matthieu Exp $
d33 45
a77 1
release:
@


1.1
log
@Top level makefile for xenocara.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.9 2006/04/17 13:18:17 matthieu Exp $
d6 1
a6 1
SUBDIR= proto data/bitmaps lib app data/xkbdata xserver driver util
d41 5
@

