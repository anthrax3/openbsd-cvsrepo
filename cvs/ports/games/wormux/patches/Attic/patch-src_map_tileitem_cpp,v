head	1.4;
access;
symbols
	OPENBSD_4_4:1.3.0.2
	OPENBSD_4_4_BASE:1.3
	OPENBSD_4_3:1.1.1.1.0.4
	OPENBSD_4_3_BASE:1.1.1.1
	OPENBSD_4_2:1.1.1.1.0.2
	OPENBSD_4_2_BASE:1.1.1.1
	msf_20070523:1.1.1.1
	msf:1.1.1;
locks; strict;
comment	@# @;


1.4
date	2008.10.01.11.24.08;	author landry;	state dead;
branches;
next	1.3;

1.3
date	2008.06.08.16.10.40;	author landry;	state Exp;
branches;
next	1.2;

1.2
date	2008.05.28.18.44.32;	author landry;	state Exp;
branches;
next	1.1;

1.1
date	2007.05.22.18.31.33;	author msf;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2007.05.22.18.31.33;	author msf;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Update to wormux 0.8.1.
All previous patches integrated upstream, and newer patches already
commited in svn too. see http://gna.org/bugs/?11751, 11754 and 12340.
@
text
@$OpenBSD: patch-src_map_tileitem_cpp,v 1.3 2008/06/08 16:10:40 landry Exp $
--- src/map/tileitem.cpp.orig	Thu May 15 16:47:34 2008
+++ src/map/tileitem.cpp	Sat Jun  7 13:58:38 2008
@@@@ -27,6 +27,7 @@@@
 #include "include/app.h"
 #include "map/camera.h"
 #include "tool/error.h"
+#include "tool/math_tools.h"
 #include "tool/point.h"
 //#include "tool/stats.h"
 #ifdef DBG_TILE
@@@@ -132,44 +133,36 @@@@ void TileItem_AlphaSoftware::Dig(const Point2i &center
   const uint line_size = m_surface.GetPitch();
   const uint bpp       = m_surface.GetBytesPerPixel();
 
-  int y = (center.y - (int)radius - (int)EXPLOSION_BORDER_SIZE >= 0) ? (center.y - (int)radius - EXPLOSION_BORDER_SIZE) : 0;
+  int y = center.y - (int)(radius+EXPLOSION_BORDER_SIZE);
+  if (y < 0) y = 0;
   buf += y * line_size;
 
   //Empties each line of the tile horizontaly that are in the circle
-  while ( (uint) y <= center.y + radius + EXPLOSION_BORDER_SIZE&& y < CELL_SIZE.y )
+  for (; (uint)y <= center.y + radius + EXPLOSION_BORDER_SIZE && y < CELL_SIZE.y;
+       buf += line_size, y++)
   {
     //Abscisse distance from the center of the circle to the circle
     int dac = center.y - y;
 
-    //Angle on the circle
-    float angle = asin( (float)dac / (float)radius);
+    //Darken the border of the removed ground
+    int blength = lround(sqrt((radius+EXPLOSION_BORDER_SIZE)*(radius+EXPLOSION_BORDER_SIZE) - dac*dac));
 
+    //Nothing to empty, just darken
+    if ((uint)abs(dac) > radius) {
+	Darken(center.x-blength, center.x+blength, buf, bpp);
+	continue;
+    }
+
     //Zone of the line which needs to be emptied
-    int start_x, end_x, lenght;
-    lenght = (int) ((float) radius * cos (angle));
-    lenght = lenght > 0 ? lenght : - lenght;
-    start_x = center.x - lenght;
-    lenght *= 2;
-    end_x = start_x + lenght;
-    Empty(start_x, end_x, buf, bpp);
+    int length = lround(sqrt(radius*radius - dac*dac));
 
-    //Darken the border of the removed ground
     // Left half of the circle
-    int bstart_x, bend_x, blenght;
-    angle = asin( (float)dac / (float)(radius + EXPLOSION_BORDER_SIZE));
-    blenght = (int) ((float) (radius + EXPLOSION_BORDER_SIZE) * cos (angle));
-    blenght = blenght > 0 ? blenght : - blenght;
-    bstart_x = center.x - blenght;
-    bend_x = bstart_x + (blenght - lenght/2);
-    Darken(bstart_x, bend_x, buf, bpp);
+    Darken(center.x-blength, center.x-length, buf, bpp);
 
-    // Right half of the circle
-    bstart_x = center.x + lenght/2 + 1;
-    bend_x = bstart_x + (blenght - lenght/2);
-    Darken(bstart_x, bend_x, buf, bpp);
+    // Rigth half of the circle
+    Darken(center.x+length, center.x+blength, buf, bpp);
 
-    buf += line_size;
-    y++;
+    Empty(center.x-length, center.x+length, buf, bpp);
   }
 }
 
@


1.3
log
@Update a cherry-picked patch from ustream svn to finally fix nicely
https://gna.org/bugs/?11751

ok ajacoutot@@
@
text
@d1 1
a1 1
$OpenBSD: patch-src_map_tileitem_cpp,v 1.2 2008/05/28 18:44:32 landry Exp $
@


1.2
log
@Update to wormux 0.8, this release adds network play feature.

Rework the way we deal with #define NAN, discussed with upstream.
patch-src_tool_math_tools_h and patch-src_network_network_cpp are already
integrated upstream, and a bug has been reported to integrate
patch-src_map_tileitem_cpp.

ok ajacoutot@@
@
text
@d1 24
a24 5
$OpenBSD: patch-src_map_tileitem_cpp,v 1.1.1.1 2007/05/22 18:31:33 msf Exp $
--- src/map/tileitem.cpp.orig	Fri May 16 00:47:34 2008
+++ src/map/tileitem.cpp	Wed May 21 14:36:51 2008
@@@@ -139,15 +139,14 @@@@ void TileItem_AlphaSoftware::Dig(const Point2i &center
   while ( (uint) y <= center.y + radius + EXPLOSION_BORDER_SIZE&& y < CELL_SIZE.y )
d27 1
a27 2
-    int dac = center.y - y;
+    int dac = y - center.y;
d29 1
a29 1
     //Angle on the circle
d31 2
a32 1
+    float angle = asin( (float)dac / (float)(radius + EXPLOSION_BORDER_SIZE));
d34 6
d41 2
a42 2
     int start_x, end_x, lenght;
     lenght = (int) ((float) radius * cos (angle));
d44 11
a54 7
     start_x = center.x - lenght;
     lenght *= 2;
     end_x = start_x + lenght;
@@@@ -158,7 +157,6 @@@@ void TileItem_AlphaSoftware::Dig(const Point2i &center
     int bstart_x, bend_x, blenght;
     angle = asin( (float)dac / (float)(radius + EXPLOSION_BORDER_SIZE));
     blenght = (int) ((float) (radius + EXPLOSION_BORDER_SIZE) * cos (angle));
d56 18
a73 3
     bstart_x = center.x - blenght;
     bend_x = bstart_x + (blenght - lenght/2);
     Darken(bstart_x, bend_x, buf, bpp);
@


1.1
log
@Initial revision
@
text
@d1 4
a4 4
$OpenBSD$
--- src/map/tileitem.cpp.orig	Sun Jan 28 15:03:48 2007
+++ src/map/tileitem.cpp	Sun May 20 17:29:28 2007
@@@@ -125,15 +125,14 @@@@ void TileItem_AlphaSoftware::Dig(const Point2i &center
d22 1
a22 1
@@@@ -144,7 +143,6 @@@@ void TileItem_AlphaSoftware::Dig(const Point2i &center
@


1.1.1.1
log
@initial import of wormux 0.7.9

Have the mascots of your favorite free software battle in the Wormux
arena. Using dynamite, grenades, baseball bat and others bazookas,...
exterminate your opponent in a 2D toon style scenery and a funny
environment.

ok jasper@@
@
text
@@
