head	1.4;
access;
symbols
	deanna_20080117:1.1.1.1 deanna:1.1.1;
locks; strict;
comment	@# @;


1.4
date	2017.04.22.19.49.18;	author espie;	state Exp;
branches;
next	1.3;
commitid	Q8sdUrlidIAMs9MD;

1.3
date	2017.04.20.15.52.29;	author espie;	state Exp;
branches;
next	1.2;
commitid	bZR21d9nt8deHgED;

1.2
date	2008.01.27.16.34.32;	author deanna;	state dead;
branches;
next	1.1;

1.1
date	2008.01.18.03.36.32;	author deanna;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2008.01.18.03.36.32;	author deanna;	state Exp;
branches;
next	;


desc
@@


1.4
log
@silence a lot more warnings by adding prototypes, not yet finished
@
text
@$OpenBSD: patch-src_sim_w_x_c,v 1.3 2017/04/20 15:52:29 espie Exp $
--- src/sim/w_x.c.orig	Mon Feb  4 03:52:26 2008
+++ src/sim/w_x.c	Sat Apr 22 18:28:38 2017
@@@@ -90,6 +90,8 @@@@ unsigned char ColorIntensities[] = {
 	/* COLOR_DARKGRAY */		63,
 	/* COLOR_BLACK */		0,
 };
+void DoPanTo(struct SimView *view, int x, int y);
+void DoResizeView(SimView *view, int w, int h);
 
 
 ViewToTileCoords(SimView *view, int x, int y, int *outx, int *outy)
@@@@ -148,6 +150,7 @@@@ ViewToPixelCoords(SimView *view, int x, int y, int *ou
 }
 
 
+void
 UpdateFlush()
 {
   struct XDisplay *xd;
@@@@ -216,6 +219,7 @@@@ printf("GOT X ERROR code %d request code %d %d\n",
 }
 
 
+void
 DoStopMicropolis()
 {
   (void)XSetErrorHandler(CatchXError);
@@@@ -244,6 +248,7 @@@@ DoStopMicropolis()
 }
 
 
+void
 DoTimeoutListen()
 {
   while (Tk_DoOneEvent(TK_DONT_WAIT)) ;
@@@@ -723,6 +728,7 @@@@ AllocPixels(int len, unsigned char pixel)
 }
 
 
+void
 DoResizeView(SimView *view, int w, int h)
 {
   int resize = 0;
@@@@ -1254,6 +1260,7 @@@@ DoPanBy(struct SimView *view, int dx, int dy)
 }
 
 
+void
 DoPanTo(struct SimView *view, int x, int y)
 {
   if (view->class != Editor_Class) {
@


1.3
log
@declare a shitload of functions void to appease clang who definitely
does not like void returns in non void functions.
@
text
@d1 3
a3 3
$OpenBSD$
--- src/sim/w_x.c.orig	Thu Apr 20 17:37:51 2017
+++ src/sim/w_x.c	Thu Apr 20 17:39:11 2017
d21 17
a37 1
@@@@ -723,6 +726,7 @@@@ AllocPixels(int len, unsigned char pixel)
d45 1
a45 1
@@@@ -1254,6 +1258,7 @@@@ DoPanBy(struct SimView *view, int dx, int dy)
@


1.2
log
@- Build from a recent snapshot of the repository at git.zerfleddert.de
  instead of the tarball from laptop.org.  Lets us get rid of many
  patches.

- Enable shared memory (run without -w) since kurt@@'s patch has fixed
  it.

This gives us many bugfixes and goodies such as a fix for the numlock
freeze bug and re-enabling the air crash disaster.  Full changelog at

http://git.zerfleddert.de/cgi-bin/gitweb.cgi/micropolis
@
text
@d1 34
a34 53
$OpenBSD: patch-src_sim_w_x_c,v 1.1 2008/01/18 03:36:32 deanna Exp $
--- src/sim/w_x.c.orig	Fri Nov 30 21:49:55 2007
+++ src/sim/w_x.c	Tue Jan 15 20:28:31 2008
@@@@ -327,28 +327,43 @@@@ FindXDisplay(Tk_Window tkwin)
 	      color->pixel; \
 	    break; \
 	  case 15: \
+	    if (xd->visual->red_mask == 0x7c00) { \
 	    xd->pixels[i] = \
 	      (((color->red >> (8 + 3)) & 0x1f) << (5 + 5)) | \
 	      (((color->green >> (8 + 2)) & 0x1f) << (5)) | \
 	      (((color->blue >> (8 + 3)) & 0x1f) << (0)); \
+	    } else { \
+	      (((color->blue >> (8 + 3)) & 0x1f) << (5 + 5)) | \
+	      (((color->green >> (8 + 2)) & 0x1f) << (5)) | \
+	      (((color->red >> (8 + 3)) & 0x1f) << (0)); \
+	    } \
 	    break; \
 	  case 16: \
+	    if (xd->visual->red_mask == 0xf800) { \
 	    xd->pixels[i] = \
 	      (((color->red >> (8 + 3)) & 0x1f) << (6 + 5)) | \
 	      (((color->green >> (8 + 2)) & 0x3f) << (5)) | \
 	      (((color->blue >> (8 + 3)) & 0x1f) << (0)); \
+	    } else { \
+	    xd->pixels[i] = \
+	      (((color->blue >> (8 + 3)) & 0x1f) << (6 + 5)) | \
+	      (((color->green >> (8 + 2)) & 0x3f) << (5)) | \
+	      (((color->red >> (8 + 3)) & 0x1f) << (0)); \
+	    } \
 	    break; \
 	  case 24: \
+	  case 32: \
+	    if (xd->visual->red_mask == 0xff0000) { \
 	    xd->pixels[i] = \
 	      ((color->red & 0xff) << 16) | \
 	      ((color->green & 0xff) << 8) | \
 	      ((color->blue & 0xff) << 0); \
-	    break; \
-	  case 32: \
+	    } else { \
 	    xd->pixels[i] = \
-	      ((color->red & 0xff) << 16) | \
+	      ((color->blue & 0xff) << 16) | \
 	      ((color->green & 0xff) << 8) | \
-	      ((color->blue & 0xff) << 0); \
+	      ((color->red & 0xff) << 0); \
+	    } \
 	    break; \
 	  } \
 	} \
@@@@ -488,6 +503,7 @@@@ SimView *
 InitNewView(SimView *view, char *title, int class, int w, int h)
d36 1
a36 34
   int type, i;
+  int test = 1;
   int d = 8;
   unsigned long valuemask = 0;
   char *t;
@@@@ -582,6 +598,10 @@@@ InitNewView(SimView *view, char *title, int class, int
     view->type = X_Mem_View;
   }
 
+  view->x->needs_swap = !(*(unsigned char*) (&test));
+  view->x->x_big_endian = (ImageByteOrder(view->x->dpy) == MSBFirst);
+
+
   GetPixmaps(view->x);
   view->pixels = view->x->pixels;
 
@@@@ -1138,7 +1158,7 @@@@ DoResizeView(SimView *view, int w, int h)
 	  view->pixel_bytes = 2;
 	  view->depth = 15;
 	  bitmap_pad = 16;
-	  bitmap_depth = 16;
+	  bitmap_depth = 15;
 	  view->line_bytes8 =
 	    ((view->m_width * view->pixel_bytes) + 3) & (~3);
 	  break;
@@@@ -1156,7 +1176,7 @@@@ DoResizeView(SimView *view, int w, int h)
 	  view->pixel_bytes = 4;
 	  //view->pixel_bytes = 3;
 	  view->depth = 24;
-	  bitmap_depth = 32;
+	  bitmap_depth = 24;
 	  bitmap_pad = 32;
 	  view->line_bytes8 =
 	    ((view->m_width * 4) + 3) & (~3);
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
$OpenBSD$
@


1.1.1.1
log
@Import micropolis

Micropolis, Unix Version, (A.K.A. "S*mC*ty"). This game was released
for the Unix platform in or about 1990 and has been modified for
inclusion in the One Laptop Per Child program. Copyright (C) 1989 -
2007 Electronic Arts Inc.

This port is based on patches written by Michael Gernoth, located at
http://git.zerfleddert.de/cgi-bin/gitweb.cgi/micropolis

Help from kurt@@ and ian@@, tested by lots of people, thanks!

ok ian@@, espie@@

@
text
@@
