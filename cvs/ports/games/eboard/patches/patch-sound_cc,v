head	1.7;
access;
symbols
	OPENBSD_6_0:1.7.0.28
	OPENBSD_6_0_BASE:1.7
	OPENBSD_5_9:1.7.0.24
	OPENBSD_5_9_BASE:1.7
	OPENBSD_5_8:1.7.0.26
	OPENBSD_5_8_BASE:1.7
	OPENBSD_5_7:1.7.0.22
	OPENBSD_5_7_BASE:1.7
	OPENBSD_5_6:1.7.0.20
	OPENBSD_5_6_BASE:1.7
	OPENBSD_5_5:1.7.0.18
	OPENBSD_5_5_BASE:1.7
	OPENBSD_5_4:1.7.0.16
	OPENBSD_5_4_BASE:1.7
	OPENBSD_5_3:1.7.0.14
	OPENBSD_5_3_BASE:1.7
	OPENBSD_5_2:1.7.0.12
	OPENBSD_5_2_BASE:1.7
	OPENBSD_5_1_BASE:1.7
	OPENBSD_5_1:1.7.0.10
	OPENBSD_5_0:1.7.0.8
	OPENBSD_5_0_BASE:1.7
	OPENBSD_4_9:1.7.0.6
	OPENBSD_4_9_BASE:1.7
	OPENBSD_4_8:1.7.0.4
	OPENBSD_4_8_BASE:1.7
	OPENBSD_4_7:1.7.0.2
	OPENBSD_4_7_BASE:1.7
	OPENBSD_4_6:1.6.0.8
	OPENBSD_4_6_BASE:1.6
	OPENBSD_4_5:1.6.0.6
	OPENBSD_4_5_BASE:1.6
	OPENBSD_4_4:1.6.0.4
	OPENBSD_4_4_BASE:1.6
	OPENBSD_4_3:1.6.0.2
	OPENBSD_4_3_BASE:1.6
	OPENBSD_4_2:1.5.0.20
	OPENBSD_4_2_BASE:1.5
	OPENBSD_4_1:1.5.0.18
	OPENBSD_4_1_BASE:1.5
	OPENBSD_4_0:1.5.0.16
	OPENBSD_4_0_BASE:1.5
	OPENBSD_3_9:1.5.0.14
	OPENBSD_3_9_BASE:1.5
	OPENBSD_3_8:1.5.0.12
	OPENBSD_3_8_BASE:1.5
	OPENBSD_3_7:1.5.0.10
	OPENBSD_3_7_BASE:1.5
	OPENBSD_3_6:1.5.0.8
	OPENBSD_3_6_BASE:1.5
	OPENBSD_3_5:1.5.0.6
	OPENBSD_3_5_BASE:1.5
	OPENBSD_3_4:1.5.0.4
	OPENBSD_3_4_BASE:1.5
	OPENBSD_3_3:1.5.0.2
	OPENBSD_3_3_BASE:1.5
	OPENBSD_3_2:1.4.0.2
	OPENBSD_3_2_BASE:1.4;
locks; strict;
comment	@# @;


1.7
date	2010.01.07.09.49.21;	author jakemsr;	state Exp;
branches;
next	1.6;

1.6
date	2007.12.03.18.54.58;	author fgsch;	state Exp;
branches;
next	1.5;

1.5
date	2003.01.26.19.26.25;	author fgsch;	state Exp;
branches;
next	1.4;

1.4
date	2002.07.17.10.27.06;	author fgsch;	state Exp;
branches;
next	1.3;

1.3
date	2002.06.07.18.38.45;	author fgsch;	state Exp;
branches;
next	1.2;

1.2
date	2002.05.02.09.38.10;	author fgsch;	state Exp;
branches;
next	1.1;

1.1
date	2002.05.02.07.46.24;	author fgsch;	state Exp;
branches;
next	;


desc
@@


1.7
log
@use sndio for audio
ok ratchov@@
@
text
@$OpenBSD: patch-sound_cc,v 1.6 2007/12/03 18:54:58 fgsch Exp $
--- sound.cc.orig	Wed May 23 11:57:45 2007
+++ sound.cc	Sat Dec 26 04:11:49 2009
@@@@ -46,14 +46,25 @@@@
 #include "eboard.h"
 
 #define SOME_DRIVER 1
+#define SOUND_DEV "/dev/dsp"
 
 #ifdef HAVE_SYS_SOUNDCARD_H
 
 #define OSS_DRIVER 1
 #include <sys/soundcard.h>
 
+#elif defined HAVE_SNDIO_H
+
+#define SNDIO_DRIVER 1
+#include <sndio.h>
+#undef SOUND_DEV
+#define SOUND_DEV "default"
+
 #elif defined HAVE_SYS_AUDIOIO_H
 
+#undef SOUND_DEV
+#define SOUND_DEV "/dev/audio"
+
 #define OPENBSD_DRIVER 1
 #include <sys/audioio.h>
 
@@@@ -74,7 +85,7 @@@@ SoundEvent::SoundEvent() {
   Pitch=800;
   Duration=250;
   Count=1;
-  strcpy(Device,"/dev/dsp");
+  strcpy(Device,SOUND_DEV);
   ExtraData[0]=0;
   enabled = true;
 }
@@@@ -157,7 +168,7 @@@@ ostream & operator<<(ostream &s,  SoundEvent e) {
     s << e.Device << ',' << e.Count << ',' << (e.enabled?1:0);
     break;
   case EXT_WAVE:
-    if (e.Device[0] == 0) strcpy(e.Device,"/dev/dsp");
+    if (e.Device[0] == 0) strcpy(e.Device,SOUND_DEV);
     s << "1," << e.Device << ',' << e.ExtraData;
     s << ',' << (e.enabled?1:0);
     break;
@@@@ -200,8 +211,12 @@@@ void SoundEvent::play() {
 
     switch(type) {
     case EXT_WAVE:
+#ifdef SNDIO_DRIVER
+      execlp("aucat","aucat","-i",ExtraData,(char *)NULL);
+#else
       execlp("play","play","-d",Device,ExtraData,0);
       execlp("sox",ExtraData,"-t","ossdsp",Device,0);
+#endif
       break;
     case EXT_PROGRAM:
       execlp("/bin/sh","/bin/sh","-c",ExtraData,0);
@@@@ -231,6 +246,11 @@@@ void SoundEvent::sine_beep(char *device,int pitch,int 
   int channels=1;
 #endif
 
+#ifdef SNDIO_DRIVER
+  struct sio_hdl *hdl;
+  struct sio_par par;
+#endif
+
 #ifdef OPENBSD_DRIVER
   audio_info_t ai;
 #endif // OPENBSD
@@@@ -257,9 +277,15 @@@@ void SoundEvent::sine_beep(char *device,int pitch,int 
   for(i=1;i<Count;i++)
     memcpy(wave+i*(bl+interval),wave,bl);
 
+#ifdef SNDIO_DRIVER
+  hdl=sio_open(NULL,SIO_PLAY,0);
+  if (hdl==NULL)
+#else
   fd=open(device,O_WRONLY);
   if (fd<0)
+#endif
     goto leave2;
+
 #endif // SOME
 
 #ifdef OSS_DRIVER
@@@@ -273,6 +299,20 @@@@ void SoundEvent::sine_beep(char *device,int pitch,int 
     goto leave1;
 #endif // OSS
 
+#ifdef SNDIO_DRIVER
+  sio_initpar(&par);
+  par.bits=8;
+  par.sig=0;
+  par.pchan=1;
+  par.rate=rate;
+  if (!sio_setpar(hdl, &par) || !sio_getpar(hdl, &par))
+    goto leave1;
+  if (par.bits != 8 || par.sig != 0 || par.pchan != 1 || par.rate != rate)
+    goto leave1;
+  if (!sio_start(hdl))
+    goto leave1;
+#endif
+
 #ifdef OPENBSD_DRIVER
   AUDIO_INITINFO(&ai);
   ai.mode             = AUMODE_PLAY;
@@@@ -285,8 +325,13 @@@@ void SoundEvent::sine_beep(char *device,int pitch,int 
 #endif // OPENBSD
 
 #ifdef SOME_DRIVER
-  for(i=0;i<ts;)
+  for(i=0;i<ts;) {
+#ifdef SNDIO_DRIVER
+    i+=sio_write(hdl,&wave[i],ts-i);
+#else
     i+=::write(fd,&wave[i],ts-i);
+#endif
+  }
 #endif // SOME
 
 #ifdef OSS_DRIVER
@@@@ -299,7 +344,11 @@@@ void SoundEvent::sine_beep(char *device,int pitch,int 
 
 #ifdef SOME_DRIVER
  leave1:
+#ifdef SNDIO_DRIVER
+  sio_close(hdl);
+#else
   close(fd);
+#endif // SNDIO
  leave2:
   free(wave);
 #endif // SOME
@


1.6
log
@update to eboard 1.0.4 and remove myself as maintainer.
@
text
@d1 4
a4 4
$OpenBSD$
--- sound.cc.orig	Wed May 23 19:57:45 2007
+++ sound.cc	Mon Dec  3 11:58:00 2007
@@@@ -46,6 +46,7 @@@@
d12 2
a13 1
@@@@ -54,6 +55,9 @@@@
d15 7
d30 1
a30 1
@@@@ -74,7 +78,7 @@@@ SoundEvent::SoundEvent() {
d39 1
a39 1
@@@@ -157,7 +161,7 @@@@ ostream & operator<<(ostream &s,  SoundEvent e) {
d48 89
@


1.5
log
@eboard 0.7.1pl1 update.
from naddy@@:
- DESTDIR support in po.
- fix gettext detection.
@
text
@d1 22
a22 4
$OpenBSD: patch-sound_cc,v 1.4 2002/07/17 10:27:06 fgsch Exp $
--- sound.cc.orig	Sun Jan 19 16:24:03 2003
+++ sound.cc	Sat Jan 25 02:51:15 2003
@@@@ -76,7 +76,7 @@@@ SoundEvent::SoundEvent() {
d27 1
a27 1
+  strcpy(Device,"/dev/audio");
d31 9
@


1.4
log
@- update to eboard 0.6.2.
- pass CFLAGS.
- remove deprecated NEED_VERSION.
@
text
@d1 4
a4 4
$OpenBSD: patch-sound_cc,v 1.3 2002/06/07 18:38:45 fgsch Exp $
--- sound.cc.orig	Mon Jun 17 00:24:31 2002
+++ sound.cc	Tue Jul 16 19:35:58 2002
@@@@ -74,7 +74,7 @@@@ SoundEvent::SoundEvent() {
d11 1
a12 1
 
@


1.3
log
@update to eboard 0.5.2.
remove sound diffs that are now in the distro.
@
text
@d1 4
a4 4
$OpenBSD: patch-sound_cc,v 1.2 2002/05/02 09:38:10 fgsch Exp $
--- sound.cc.orig	Fri Jun  7 03:24:53 2002
+++ sound.cc	Fri Jun  7 03:25:34 2002
@@@@ -65,7 +65,7 @@@@ SoundEvent::SoundEvent() {
@


1.2
log
@set default audio device to /dev/audio.
@
text
@d1 4
a4 13
$OpenBSD: patch-sound_cc,v 1.1 2002/05/02 07:46:24 fgsch Exp $
--- sound.cc.orig	Tue Apr 23 22:16:33 2002
+++ sound.cc	Thu May  2 05:33:34 2002
@@@@ -45,6 +45,8 @@@@
 
 #ifdef HAVE_SYS_SOUNDCARD_H
 #include <sys/soundcard.h>
+#elif defined HAVE_SYS_AUDIOIO_H
+#include <sys/audioio.h>
 #endif
 
 SoundEvent::SoundEvent() {
@@@@ -52,7 +54,7 @@@@ SoundEvent::SoundEvent() {
a12 59
@@@@ -219,6 +221,58 @@@@ void SoundEvent::sine_beep(char *device,
     i+=::write(fd,&wave[i],ts-i);
 
   ioctl(fd,SNDCTL_DSP_POST,0);
+
+ leave1:
+  close(fd);
+ leave2:
+  free(wave);
+#elif defined HAVE_SYS_AUDIOIO_H
+  audio_info_t ai;
+  int rate=11025;         // Hz
+  int interval;
+
+  unsigned char *wave;
+  int bl,fd,i,ts;
+  double r,s;
+
+  interval=120*rate/1000; // 120 msec
+
+  wave=(unsigned char *)malloc(ts = (Count*(bl=(rate*duration)/1000) + (Count-1)*interval) );
+
+  if (!wave)
+    /*	return;	*/
+  memset(wave,127,ts);
+
+  for(i=0;i<bl;i++) {
+    r=(double)pitch;
+    r/=(double)rate;
+    r*=(double)i;
+    s=(double)i;
+    s/=(double)bl;
+    s=0.30+sin(M_PI*s)*0.70;
+    wave[i]=(unsigned char)(128.0+127.0*s*sin(M_PI*2.0*r));
+  }
+
+  for(i=1;i<Count;i++)
+    memcpy(wave+i*(bl+interval),wave,bl);
+
+  fd=open(device,O_WRONLY);
+  if (fd<0)
+    goto leave2;
+
+  AUDIO_INITINFO(&ai);
+  ai.mode = AUMODE_PLAY;
+  ai.play.sample_rate = rate;
+  ai.play.channels = 1;
+  ai.play.encoding = AUDIO_ENCODING_ULINEAR;
+  
+  if (ioctl(fd,AUDIO_SETINFO,&ai)==-1)
+    goto leave1;
+
+  for(i=0;i<ts;)
+    i+=::write(fd,&wave[i],ts-i);
+
+  ioctl(fd,AUDIO_DRAIN,0);
 
  leave1:
   close(fd);
@


1.1
log
@sound support; diffs sent to eboard for inclusion.
@
text
@d1 3
a3 3
$OpenBSD$
--- sound.cc.orig	Wed May  1 21:56:47 2002
+++ sound.cc	Wed May  1 22:05:06 2002
d13 9
@

