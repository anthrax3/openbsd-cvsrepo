head	1.4;
access;
symbols
	OPENBSD_6_0:1.4.0.28
	OPENBSD_6_0_BASE:1.4
	OPENBSD_5_9:1.4.0.24
	OPENBSD_5_9_BASE:1.4
	OPENBSD_5_8:1.4.0.26
	OPENBSD_5_8_BASE:1.4
	OPENBSD_5_7:1.4.0.22
	OPENBSD_5_7_BASE:1.4
	OPENBSD_5_6:1.4.0.20
	OPENBSD_5_6_BASE:1.4
	OPENBSD_5_5:1.4.0.18
	OPENBSD_5_5_BASE:1.4
	OPENBSD_5_4:1.4.0.16
	OPENBSD_5_4_BASE:1.4
	OPENBSD_5_3:1.4.0.14
	OPENBSD_5_3_BASE:1.4
	OPENBSD_5_2:1.4.0.12
	OPENBSD_5_2_BASE:1.4
	OPENBSD_5_1_BASE:1.4
	OPENBSD_5_1:1.4.0.10
	OPENBSD_5_0:1.4.0.8
	OPENBSD_5_0_BASE:1.4
	OPENBSD_4_9:1.4.0.6
	OPENBSD_4_9_BASE:1.4
	OPENBSD_4_8:1.4.0.4
	OPENBSD_4_8_BASE:1.4
	OPENBSD_4_7:1.4.0.2
	OPENBSD_4_7_BASE:1.4
	OPENBSD_4_6:1.3.0.32
	OPENBSD_4_6_BASE:1.3
	OPENBSD_4_5:1.3.0.30
	OPENBSD_4_5_BASE:1.3
	OPENBSD_4_4:1.3.0.28
	OPENBSD_4_4_BASE:1.3
	OPENBSD_4_3:1.3.0.26
	OPENBSD_4_3_BASE:1.3
	OPENBSD_4_2:1.3.0.24
	OPENBSD_4_2_BASE:1.3
	OPENBSD_4_1:1.3.0.22
	OPENBSD_4_1_BASE:1.3
	OPENBSD_4_0:1.3.0.20
	OPENBSD_4_0_BASE:1.3
	OPENBSD_3_9:1.3.0.18
	OPENBSD_3_9_BASE:1.3
	OPENBSD_3_8:1.3.0.16
	OPENBSD_3_8_BASE:1.3
	OPENBSD_3_7:1.3.0.14
	OPENBSD_3_7_BASE:1.3
	OPENBSD_3_6:1.3.0.12
	OPENBSD_3_6_BASE:1.3
	OPENBSD_3_5:1.3.0.10
	OPENBSD_3_5_BASE:1.3
	OPENBSD_3_4:1.3.0.8
	OPENBSD_3_4_BASE:1.3
	OPENBSD_3_3:1.3.0.6
	OPENBSD_3_3_BASE:1.3
	OPENBSD_3_2:1.3.0.4
	OPENBSD_3_2_BASE:1.3
	OPENBSD_3_1:1.3.0.2
	OPENBSD_3_1_BASE:1.3
	OPENBSD_3_0:1.1.1.1.0.2
	OPENBSD_3_0_BASE:1.1.1.1
	OPENBSD_2_9_TRACKING_SWITCH:1.1.1.1
	joshua:1.1.1.1
	xscavenger:1.1.1;
locks; strict;
comment	@# @;


1.4
date	2010.01.03.21.51.29;	author jakemsr;	state Exp;
branches;
next	1.3;

1.3
date	2002.03.21.02.18.21;	author jcs;	state Exp;
branches;
next	1.2;

1.2
date	2002.02.25.13.05.40;	author naddy;	state Exp;
branches;
next	1.1;

1.1
date	2001.07.16.13.03.57;	author espie;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2001.07.16.13.03.57;	author espie;	state Exp;
branches;
next	;


desc
@@


1.4
log
@- use sndio instead of ossaudio
- license marker
- @@bin marker
ok landry@@, ratchov@@
@
text
@$OpenBSD: patch-src-sound_c,v 1.3 2002/03/21 02:18:21 jcs Exp $
--- src/sound.c.orig	Sun Dec  1 22:03:54 2002
+++ src/sound.c	Sun Jan  3 01:53:43 2010
@@@@ -4,8 +4,7 @@@@
 #include <stdlib.h>
 #include <unistd.h>
 #include <fcntl.h>
-#include <sys/ioctl.h>
-#include <linux/soundcard.h>
+#include <sndio.h>
 #include <sys/time.h>
 #include <signal.h>
 #include <string.h>
@@@@ -14,8 +13,6 @@@@
 #include "scav.h"
 #include "sound.h"
 
-#define SOUNDDEV "/dev/dsp"
-
 char dirlist[512];
 
 #define NUMSOUNDS	(sizeof(soundnames)/sizeof(char*))
@@@@ -42,7 +39,8 @@@@ sample samples[NUMSOUNDS];
 
 int soundworking=0;
 int fragment;
-int dsp;
+struct sio_hdl *hdl;
+struct sio_par par;
 int soundwrite,soundread;
 int *soundbuffer;
 int soundbufferlen;
@@@@ -52,7 +50,6 @@@@ int soundbufferlen;
 void soundinit(void)
 {
 int fd[2];
-char devname[256];
 int value;
 
 	sprintf(dirlist,"%s/%s,%s",localname,localdirname,libname);
@@@@ -67,17 +64,29 @@@@ int value;
 	}
 	close(soundwrite);
 	memset(samples,0,sizeof(samples));
-	strcpy(devname,SOUNDDEV);
-	dsp=open(devname,O_WRONLY);
-	if(dsp<0) goto failed;
-	fragment=0x20009;
-	ioctl(dsp,SNDCTL_DSP_SETFRAGMENT,&fragment);
-	value=10000;
-	ioctl(dsp,SNDCTL_DSP_SPEED,&value);
-	value=0;
-	ioctl(dsp,SNDCTL_DSP_STEREO,&value);
-	ioctl(dsp,SNDCTL_DSP_GETBLKSIZE,&fragment);
-	if(!fragment) {close(dsp);goto failed;}
+	hdl=sio_open(NULL,SIO_PLAY,0);
+	if(hdl==NULL) goto failed;
+	sio_initpar(&par);
+	par.bits=8;
+	par.sig=0;
+	par.rate=10000;
+        par.pchan=1;
+	par.le=SIO_LE_NATIVE;
+	par.appbufsz=par.rate/20;
+	if(!sio_setpar(hdl,&par) || !sio_getpar(hdl,&par)) {
+	  sio_close(hdl);
+	  goto failed;
+	}
+	if(par.bits!=8 || par.sig!=0 || par.rate!=10000 || par.pchan!=1) {
+	  sio_close(hdl);
+	  goto failed;
+	}
+	if(!sio_start(hdl)) {
+	  sio_close(hdl);
+	  goto failed;
+	}
+	fragment=par.round*par.bps*par.pchan;
+	if(!fragment) {sio_close(hdl);goto failed;}
 	soundbufferlen=fragment*sizeof(int);
 	soundbuffer=malloc(soundbufferlen);
 	if(!soundbuffer) goto failed;
@@@@ -207,13 +216,13 @@@@ int which;
 		ip=soundbuffer;
 		p=(char *) soundbuffer;
 		while(j--) *p++ = clip[4096+*ip++];
-		write(dsp,(char *)soundbuffer,fragment);
+		sio_write(hdl,(char *)soundbuffer,fragment);
 	}
 }
 
 void playsound(int n)
 {
-char c;
+signed char c;
 	c=n;
 	write(soundwrite,&c,1);
 }
@


1.3
log
@Update to xscavenger-1.4.3
@
text
@d1 5
a5 4
$OpenBSD$
--- src/sound.c.orig	Wed Mar 20 20:06:22 2002
+++ src/sound.c	Wed Mar 20 20:07:17 2002
@@@@ -5,7 +5,7 @@@@
d8 1
a8 1
 #include <sys/ioctl.h>
d10 1
a10 1
+#include <soundcard.h>
d14 1
a14 1
@@@@ -14,7 +14,7 @@@@
d19 5
a23 1
+#define SOUNDDEV "/dev/audio"
d25 14
a38 1
 char dirlist[512];
d40 50
a89 1
@@@@ -207,7 +207,7 @@@@
@


1.2
log
@character signedness fixes; ok jcs@@
@
text
@d2 2
a3 2
--- src/sound.c.orig	Thu Jan  6 07:23:56 2000
+++ src/sound.c	Mon Feb 25 02:03:05 2002
d22 1
a22 14
@@@@ -126,9 +126,10 @@@@ doall()
 {
 unsigned char clip[8192];
 int i,j;
-char commands[64],commandlen,com;
-char *p;
+signed char commands[64];
+signed char *p;
 int *ip;
+int com, commandlen;
 int playing[MIXMAX],position[MIXMAX];
 int which;
 
@@@@ -207,7 +208,7 @@@@ int which;
@


1.1
log
@Initial revision
@
text
@d1 3
a3 2
--- src/sound.c.orig	Thu Jan  6 00:23:56 2000
+++ src/sound.c	Sun Jul 15 12:52:17 2001
d22 22
@


1.1.1.1
log
@lode-runner clone.
@
text
@@
