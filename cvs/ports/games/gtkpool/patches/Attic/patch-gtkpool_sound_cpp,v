head	1.6;
access;
symbols
	OPENBSD_4_7:1.5.0.2
	OPENBSD_4_7_BASE:1.5
	OPENBSD_4_6:1.4.0.8
	OPENBSD_4_6_BASE:1.4
	OPENBSD_4_5:1.4.0.6
	OPENBSD_4_5_BASE:1.4
	OPENBSD_4_4:1.4.0.4
	OPENBSD_4_4_BASE:1.4
	OPENBSD_4_3:1.4.0.2
	OPENBSD_4_3_BASE:1.4
	OPENBSD_4_2:1.3.0.20
	OPENBSD_4_2_BASE:1.3
	OPENBSD_4_1:1.3.0.18
	OPENBSD_4_1_BASE:1.3
	OPENBSD_4_0:1.3.0.16
	OPENBSD_4_0_BASE:1.3
	OPENBSD_3_9:1.3.0.14
	OPENBSD_3_9_BASE:1.3
	OPENBSD_3_8:1.3.0.12
	OPENBSD_3_8_BASE:1.3
	OPENBSD_3_7:1.3.0.10
	OPENBSD_3_7_BASE:1.3
	OPENBSD_3_6:1.3.0.8
	OPENBSD_3_6_BASE:1.3
	OPENBSD_3_5:1.3.0.6
	OPENBSD_3_5_BASE:1.3
	OPENBSD_3_4:1.3.0.4
	OPENBSD_3_4_BASE:1.3
	OPENBSD_3_3:1.3.0.2
	OPENBSD_3_3_BASE:1.3
	OPENBSD_3_2:1.2.0.2
	OPENBSD_3_2_BASE:1.2
	OPENBSD_3_1:1.1.0.2
	OPENBSD_3_1_BASE:1.1;
locks; strict;
comment	@# @;


1.6
date	2010.03.24.22.36.40;	author jasper;	state dead;
branches;
next	1.5;

1.5
date	2010.01.03.08.58.07;	author jakemsr;	state Exp;
branches;
next	1.4;

1.4
date	2007.10.29.06.47.20;	author jakemsr;	state Exp;
branches;
next	1.3;

1.3
date	2002.10.25.11.59.06;	author naddy;	state Exp;
branches;
next	1.2;

1.2
date	2002.09.28.21.01.17;	author naddy;	state Exp;
branches;
next	1.1;

1.1
date	2002.02.19.06.28.31;	author pvalchev;	state Exp;
branches;
next	;


desc
@@


1.6
log
@- remove gtkpool, it's lost the toolkit game..

ok pval@@ (MAINTAINER)
@
text
@$OpenBSD: patch-gtkpool_sound_cpp,v 1.5 2010/01/03 08:58:07 jakemsr Exp $
--- gtkpool/sound.cpp.orig	Sun Jul 28 14:57:41 2002
+++ gtkpool/sound.cpp	Sat Jan  2 23:14:43 2010
@@@@ -16,17 +16,12 @@@@
  ***************************************************************************/
 
 #include <gtk/gtk.h>
-#include <sys/types.h>
-#include <sys/stat.h>
 #include <fcntl.h>
 #include <unistd.h>
-#include <sys/soundcard.h>
-#include <sys/ioctl.h>
-#include <stdio.h>
-#include <errno.h>
+#include <sndio.h>
 #include "sound.h"
 
-SoundError::SoundError(char *desc, int c, int r = 0, int g = 0){
+SoundError::SoundError(char *desc, int c, int r, int g){
 	description = strdup(desc);
 	code = c;
 	requested = r;
@@@@ -36,7 +31,7 @@@@ SoundError::~SoundError(){
 	free(description);
 }
 
-int audio_fd;
+struct sio_hdl *hdl;
 bool sound_enabled;
 
 	// must add error checking!
@@@@ -49,25 +44,22 @@@@ bool sound_enabled;
 
 void play_sound(char *sound, int count)
 {
-	//int fragment = 0x20008;
 	if(!sound_enabled)
 	{
 		g_message("Sound not available.");
 		return;
 	}
-	if(audio_fd < 0)
+	if(hdl == NULL)
 	{
 		g_message("Sound device not open.");
 		return;
 	}
 	
-	if(write(audio_fd, sound, count) < 0)
+	if(sio_write(hdl, sound, count) == 0)
 	{
 		g_message("Write to sound device failed.");
 		return;
 	}
-	
-	ioctl(audio_fd, SNDCTL_DSP_POST, 0);
 }
 
 int load_sound(char *file, char *buffer, int *count)
@@@@ -78,37 +70,53 @@@@ int load_sound(char *file, char *buffer, int *count)
 	return *count;
 }
 
-void open_sound_device(char *name)
+void open_sound_device()
 {
-	if ((audio_fd = open("/dev/dsp", O_WRONLY, 0)) == -1) {
+	if ((hdl = sio_open(NULL, SIO_PLAY, 0)) == NULL) {
 		g_message("Could Not open Audio Device");
 	}
 }
 
 void close_sound_device()
 {
-	 close (audio_fd);
+	if (hdl != NULL)
+		sio_close(hdl);
+	hdl = NULL;
 }
 
 void configure_sound_device()
 {
-	int fragment = 0x00020008;
-	int format = AFMT_U8;
-	int channels = 2;
-	int speed = 44100;
-	
-	if (ioctl(audio_fd, SNDCTL_DSP_SETFMT, &format) == -1) {
-		perror("SNDCTL_DSP_SETFMT");
+	struct sio_par par;
+
+	sound_enabled = false;
+
+	sio_initpar(&par);
+	par.bits = 8;
+	par.sig = 0;
+	par.pchan = 2;
+	par.rate = 44100;
+
+	/* OSS is using this, which is 2 buffers of 256 bytes each */
+	/* int fragment = 0x00020008; */
+	/* par.round = 256 / SIO_BPS(par.bits) / par.pchan; */
+	/* par.appbufsz = par.round * 2; */
+	par.appbufsz = par.rate / 20;	/* 50 ms */
+
+	if (!sio_setpar(hdl, &par) || !sio_getpar(hdl, &par)) {
+		g_message("setting or getting audio params failed");
+		return;
 	}
-	if (ioctl(audio_fd, SNDCTL_DSP_CHANNELS, &channels) == -1) {
-		perror("SNDCTL_DSP_CHANNELS");
+
+	if (par.bits != 8 || par.sig != 0 || par.pchan != 2 ||
+	    par.rate != 44100) {
+		g_message("could not set audio params as desired");
+		return;
 	}
-	if (ioctl(audio_fd, SNDCTL_DSP_SPEED, &speed) == -1) {
-		perror("SNDCTL_DSP_SPEED");
+
+	if (!sio_start(hdl)) {
+		g_message("could not start audio");
+		return;
 	}
-	if( ioctl(audio_fd, SNDCTL_DSP_SETFRAGMENT, &fragment) == -1 ) {
-		perror("SNDCTL_DSP_SETFRAGMENT");
-	}
-	
+
 	sound_enabled = true;
 }
@


1.5
log
@- use sndio instead of ossaudio
- regen patches
- @@bin marker
@
text
@d1 1
a1 1
$OpenBSD: patch-gtkpool_sound_cpp,v 1.4 2007/10/29 06:47:20 jakemsr Exp $
@


1.4
log
@- include soundcard.h _after_ sys/ioctl.h
- use /dev/audio instead of /dev/dsp

ok pvalchev@@ (MAINAINER)
@
text
@d1 1
a1 1
$OpenBSD: patch-gtkpool_sound_cpp,v 1.3 2002/10/25 11:59:06 naddy Exp $
d3 7
a9 3
+++ gtkpool/sound.cpp	Sun Oct 28 19:09:11 2007
@@@@ -20,13 +20,17 @@@@
 #include <sys/stat.h>
d13 4
a16 8
 #include <sys/ioctl.h>
+#ifdef __OpenBSD__
+#include <soundcard.h>
+#else
+#include <sys/soundcard.h>
+#endif
 #include <stdio.h>
 #include <errno.h>
d24 35
a58 1
@@@@ -80,7 +84,7 @@@@ int load_sound(char *file, char *buffer, int *count)
d60 7
a66 1
 void open_sound_device(char *name)
d69 1
a69 1
+	if ((audio_fd = open("/dev/audio", O_WRONLY, 0)) == -1) {
d72 60
@


1.3
log
@update to 0.5.0 and fix C++ for gcc3; ok pvalchev@@
@
text
@d1 4
a4 4
$OpenBSD: patch-gtkpool_sound_cpp,v 1.2 2002/09/28 21:01:17 naddy Exp $
--- gtkpool/sound.cpp.orig	Sun Jul 28 23:57:41 2002
+++ gtkpool/sound.cpp	Thu Oct 24 12:08:17 2002
@@@@ -20,13 +20,19 @@@@
d8 2
a11 2
+#include <sys/audioio.h>
+#include <string.h>
d13 1
a13 1
 #include <sys/soundcard.h>
a14 1
 #include <sys/ioctl.h>
d24 9
@


1.2
log
@some C++ fixes for compiling with gcc3
@
text
@d1 4
a4 4
$OpenBSD: patch-gtkpool_sound_cpp,v 1.1 2002/02/19 06:28:31 pvalchev Exp $
--- gtkpool/sound.cpp.orig	Mon Jan 14 10:23:39 2002
+++ gtkpool/sound.cpp	Sat Sep 28 22:54:25 2002
@@@@ -20,12 +20,18 @@@@
d16 1
@


1.1
log
@Update to gtkpool-0.4.1
@
text
@d1 4
a4 4
$OpenBSD$
--- gtkpool/sound.cpp.orig	Mon Jan 14 02:23:39 2002
+++ gtkpool/sound.cpp	Mon Feb 18 23:07:08 2002
@@@@ -20,7 +20,13 @@@@
d18 6
@

