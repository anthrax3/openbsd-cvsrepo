head	1.4;
access;
symbols
	OPENBSD_4_9:1.3.0.6
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.3.0.4
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.3.0.2
	OPENBSD_4_7_BASE:1.3
	OPENBSD_4_6:1.2.0.24
	OPENBSD_4_6_BASE:1.2
	OPENBSD_4_5:1.2.0.22
	OPENBSD_4_5_BASE:1.2
	OPENBSD_4_4:1.2.0.20
	OPENBSD_4_4_BASE:1.2
	OPENBSD_4_3:1.2.0.18
	OPENBSD_4_3_BASE:1.2
	OPENBSD_4_2:1.2.0.16
	OPENBSD_4_2_BASE:1.2
	OPENBSD_4_1:1.2.0.14
	OPENBSD_4_1_BASE:1.2
	OPENBSD_4_0:1.2.0.12
	OPENBSD_4_0_BASE:1.2
	OPENBSD_3_9:1.2.0.10
	OPENBSD_3_9_BASE:1.2
	OPENBSD_3_8:1.2.0.8
	OPENBSD_3_8_BASE:1.2
	OPENBSD_3_7:1.2.0.6
	OPENBSD_3_7_BASE:1.2
	OPENBSD_3_6:1.2.0.4
	OPENBSD_3_6_BASE:1.2
	OPENBSD_3_5:1.2.0.2
	OPENBSD_3_5_BASE:1.2
	OPENBSD_3_4:1.1.0.16
	OPENBSD_3_4_BASE:1.1
	OPENBSD_3_3:1.1.0.14
	OPENBSD_3_3_BASE:1.1
	OPENBSD_3_2:1.1.0.12
	OPENBSD_3_2_BASE:1.1
	OPENBSD_3_1:1.1.0.10
	OPENBSD_3_1_BASE:1.1
	OPENBSD_3_0:1.1.0.8
	OPENBSD_3_0_BASE:1.1
	OPENBSD_2_9_TRACKING_SWITCH:1.1
	OPENBSD_2_9:1.1.0.6
	OPENBSD_2_9_BASE:1.1
	OPENBSD_2_8:1.1.0.4
	OPENBSD_2_8_BASE:1.1
	OPENBSD_2_7:1.1.0.2
	OPENBSD_2_7_BASE:1.1;
locks; strict;
comment	@ * @;


1.4
date	2011.07.08.11.42.09;	author jasper;	state dead;
branches;
next	1.3;

1.3
date	2010.01.04.11.21.21;	author sthen;	state Exp;
branches;
next	1.2;

1.2
date	2004.03.05.22.56.42;	author naddy;	state Exp;
branches;
next	1.1;

1.1
date	2000.03.24.23.45.11;	author turan;	state Exp;
branches;
next	;


desc
@@


1.4
log
@- fix patch names, no binary change
- regen a patch while here
@
text
@$OpenBSD: patch-audio-LINUXaudio.c,v 1.3 2010/01/04 11:21:21 sthen Exp $
--- audio/LINUXaudio.c.orig	Thu Nov 21 17:28:33 1996
+++ audio/LINUXaudio.c	Sun Jan  3 02:36:53 2010
@@@@ -52,11 +52,13 @@@@
  *  Include file dependencies:
  */
 
+#include <fcntl.h>
 #include <unistd.h>
 #include <stdio.h>
-#include <fcntl.h>
-#include <linux/soundcard.h>
+#include <sndio.h>
 
+#include "include/ulaw.h"
+
 #include "include/error.h"
 #include "include/audio.h"
 
@@@@ -77,10 +79,11 @@@@ static int snd_pipes[2];
  *  Internal variable declarations:
  */
 
-static char				*Audio_dev = "/dev/audio";
-static int 				Audio_fd;
+static struct sio_hdl			*hdl;
+
 /* size should depend on sample_rate */
 static unsigned char   	buf[BUFFER_SIZE];       
+static short	  		linBuf[BUFFER_SIZE];
 static char 			errorString[255];
 
 #if NeedFunctionPrototypes
@@@@ -90,7 +93,9 @@@@ int SetUpAudioSystem(display)
 	Display *display;
 #endif
 {
-	int err, cnt;
+	struct sio_par par;
+	int i,err, cnt;
+	uint32_t pos = 0;
       
 
 	if (child_pid == 0)
@@@@ -124,17 +129,30 @@@@ int SetUpAudioSystem(display)
 
                   if (!strcmp(string, "EXIT"))
 	             {
-                     /* Make sure that the audio device is flushed and reset */
- 	             ioctl(Audio_fd, SNDCTL_DSP_RESET, 0);
-
 		     exit(0); 
 	             }	
 
 	          /* Try to open the audio device */
- 	          if (!(Audio_fd = open(Audio_dev, O_WRONLY)))
+ 	          if (!(hdl = sio_open(NULL, SIO_PLAY, 0)))
   	          {	
+fprintf(stderr, "sio_open failed\n");
 		         continue;
   	          }
+		  sio_initpar(&par);
+		  par.bits = 16;
+		  par.sig = 1;
+		  par.rate = 8000;
+		  par.le = SIO_LE_NATIVE;
+		  if (!sio_setpar(hdl, &par) || !sio_getpar(hdl, &par)) {
+			sprintf(errorString, "Unable to configure sndio device.");
+                        WarningMessage(errorString);
+			continue;
+		  }
+		  if (!sio_start(hdl)) {
+			sprintf(errorString, "Unable to start sndio device.");
+                        WarningMessage(errorString);
+			continue;
+                  }
 	
 		/* Must be a sound file name */
  		if (str != NULL)
@@@@ -151,13 +169,28 @@@@ int SetUpAudioSystem(display)
 
                 }
 
+		/* skip the header, if present */
+		if (read(ifd, (char *)buf, 4) == 4) {
+			if (!strncmp(buf, ".snd", 4)) {
+				if (read(ifd, &pos, sizeof(pos)) == sizeof(pos)) {
+					pos = ntohl(pos);
+				}
+			}
+		}
+		lseek(ifd, (off_t)pos, SEEK_SET);
+
                 /* At this point, we're all ready to copy the data. */
-                while ((cnt = read(ifd, (char *) buf, BUFFER_SIZE)) >= 0) 
+                while ((cnt = read(ifd, (char *) buf, BUFFER_SIZE)) > 0) 
                 {
+			/* Now do the ulaw stuff to the raw data */
+			for(i = 0; i < cnt; i++) 
+			{
+		    	linBuf[i] = UlToLin(buf[i]);
+			}
                         /* If input EOF, write an eof marker */
-                        err = write(Audio_fd, (char *)buf, cnt);
+                        err = sio_write(hdl, (char *)linBuf, cnt * 2);
 
-                        if (err != cnt) 
+                        if (err != cnt * 2) 
                         {
                                 sprintf(errorString, "Problem while writing to sound device");
                                 WarningMessage(errorString);
@@@@ -176,15 +209,9 @@@@ int SetUpAudioSystem(display)
                 }
         
 
- 		/* Flush any audio activity */
- 		if (ioctl(Audio_fd, SNDCTL_DSP_SYNC, 0) < 0)
-  		     {
-  			     sprintf(errorString, "Unable to flush audio device.");
-  			     WarningMessage(errorString);
-  		     }
                 /* Close the sound file */
                 (void) close(ifd);
-		(void) close(Audio_fd);
+		sio_close(hdl);
              } while (True);
           }
        
@


1.3
log
@- convert to use sndio, from jakemsr@@

- use default colour maps by default, allowing this to work with
24-bit displays. use -no-usedefcmap to revert to previous behaviour.
@
text
@d1 1
a1 1
$OpenBSD: patch-audio-LINUXaudio.c,v 1.2 2004/03/05 22:56:42 naddy Exp $
@


1.2
log
@regen patches
@
text
@d1 8
a8 4
$OpenBSD$
--- audio/LINUXaudio.c.orig	1996-11-22 02:28:33.000000000 +0100
+++ audio/LINUXaudio.c	2004-03-05 23:30:39.000000000 +0100
@@@@ -55,7 +55,8 @@@@
d11 1
a11 1
 #include <fcntl.h>
d13 1
a13 2
+#include <sys/ioctl.h>
+#include <soundcard.h>
d15 2
d19 110
@


1.1
log
@Fix broken port:
- force install in local instead of X11R6
- rename patches to something more useable.
@
text
@d1 13
a13 20
*** audio/LINUXaudio.c.orig	Thu Nov 20 03:04:17 1997
--- audio/LINUXaudio.c	Thu Nov 20 03:04:31 1997
***************
*** 55,61 ****
  #include <unistd.h>
  #include <stdio.h>
  #include <fcntl.h>
! #include <linux/soundcard.h>
  
  #include "include/error.h"
  #include "include/audio.h"
--- 55,61 ----
  #include <unistd.h>
  #include <stdio.h>
  #include <fcntl.h>
+ #include <sys/ioctl.h>
! #include <soundcard.h>
  
  #include "include/error.h"
  #include "include/audio.h"
@

