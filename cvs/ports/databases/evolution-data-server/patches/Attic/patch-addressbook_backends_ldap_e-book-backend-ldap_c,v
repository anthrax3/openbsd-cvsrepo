head	1.23;
access;
symbols
	OPENBSD_5_4:1.15.0.2
	OPENBSD_5_4_BASE:1.15
	OPENBSD_5_3:1.11.0.2
	OPENBSD_5_3_BASE:1.11
	OPENBSD_5_2:1.7.0.2
	OPENBSD_5_2_BASE:1.7
	OPENBSD_5_1_BASE:1.6
	OPENBSD_5_1:1.6.0.2
	OPENBSD_5_0:1.3.0.2
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_9:1.1.0.2
	OPENBSD_4_9_BASE:1.1;
locks; strict;
comment	@# @;


1.23
date	2013.09.26.14.11.06;	author ajacoutot;	state dead;
branches;
next	1.22;

1.22
date	2013.09.11.14.02.53;	author ajacoutot;	state Exp;
branches;
next	1.21;

1.21
date	2013.09.11.09.24.56;	author ajacoutot;	state Exp;
branches;
next	1.20;

1.20
date	2013.08.16.21.08.29;	author naddy;	state Exp;
branches;
next	1.19;

1.19
date	2013.08.15.16.07.27;	author ajacoutot;	state Exp;
branches;
next	1.18;

1.18
date	2013.08.15.14.49.35;	author ajacoutot;	state dead;
branches;
next	1.17;

1.17
date	2013.08.11.13.17.41;	author ajacoutot;	state Exp;
branches;
next	1.16;

1.16
date	2013.08.06.19.09.27;	author ajacoutot;	state Exp;
branches;
next	1.15;

1.15
date	2013.06.09.09.17.49;	author ajacoutot;	state Exp;
branches;
next	1.14;

1.14
date	2013.03.29.15.17.01;	author ajacoutot;	state Exp;
branches;
next	1.13;

1.13
date	2013.03.07.08.18.20;	author ajacoutot;	state Exp;
branches;
next	1.12;

1.12
date	2013.03.07.07.53.47;	author jasper;	state dead;
branches;
next	1.11;

1.11
date	2013.01.23.15.36.53;	author ajacoutot;	state Exp;
branches;
next	1.10;

1.10
date	2012.11.11.18.10.01;	author ajacoutot;	state Exp;
branches;
next	1.9;

1.9
date	2012.10.18.13.54.56;	author ajacoutot;	state Exp;
branches;
next	1.8;

1.8
date	2012.09.28.06.35.36;	author ajacoutot;	state Exp;
branches;
next	1.7;

1.7
date	2012.03.29.06.45.21;	author ajacoutot;	state Exp;
branches;
next	1.6;

1.6
date	2011.12.29.09.23.19;	author ajacoutot;	state Exp;
branches;
next	1.5;

1.5
date	2011.09.21.13.26.03;	author jasper;	state Exp;
branches;
next	1.4;

1.4
date	2011.09.12.07.26.19;	author ajacoutot;	state Exp;
branches;
next	1.3;

1.3
date	2011.03.29.11.20.02;	author ajacoutot;	state Exp;
branches;
next	1.2;

1.2
date	2011.03.07.19.35.30;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2010.09.30.07.32.09;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.23
log
@Update to evolution-data-server-3.10.0.
@
text
@$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.22 2013/09/11 14:02:53 ajacoutot Exp $

From fa37efaf26d366a3d0d5256283455a28025ddbde Mon Sep 17 00:00:00 2001
From: Antoine Jacoutot <antoine@@mtier.org>
Date: Wed, 11 Sep 2013 13:57:57 +0000
Subject: do not assume time_t is long

--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Sun Aug 11 00:00:52 2013
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Sun Aug 11 14:57:25 2013
@@@@ -1283,11 +1283,11 @@@@ create_dn_from_contact (EContact *contact,
 	}
 
 	dn = g_strdup_printf (
-		"%s=%s%s%lu",
+		"%s=%s%s%" G_GINT64_FORMAT,
 		get_dn_attribute_name (rootdn, contact),
 		(cn_part && *cn_part) ? cn_part : "",
 		(cn_part && *cn_part) ? "." : "",
-		time (NULL));
+		(gint64) time (NULL));
 
 	g_free (cn_part);
 	g_free (cn);
@


1.22
log
@Committed upstream with some tweaks.
@
text
@d1 1
a1 1
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.21 2013/09/11 09:24:56 ajacoutot Exp $
@


1.21
log
@Fixes for 64-bit time_t. Still a moving target but better than what we
currently have.
@
text
@d1 1
a1 1
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.20 2013/08/16 21:08:29 naddy Exp $
d3 4
a6 1
https://bugzilla.gnome.org/show_bug.cgi?id=707900
d20 1
a20 1
+		(gint64)time (NULL));
@


1.20
log
@fix previous backout
@
text
@d1 1
a1 1
$OpenBSD$
d3 1
a3 1
XXX remove when we have a 64-bit time_t
d12 1
a12 1
+		"%s=%s%s%llu",
d17 1
a17 1
+		(long long)time (NULL));
@


1.19
log
@Revert previous on these 3 ports.
kettenis@@ says there is more work involved since we are different from the
others... I have no time to take care of it properly so put back whatever
was there before which seemed to work fine.
@
text
@d1 1
a1 1
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.15 2013/06/09 09:17:49 ajacoutot Exp $
d5 3
a7 3
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Sat Jun  8 16:24:32 2013
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Sun Jun  9 10:53:22 2013
@@@@ -1257,11 +1257,11 @@@@ create_dn_from_contact (EContact *contact,
d13 1
a13 1
 		get_dn_attribute_name (rootdn),
d20 1
a20 1
 
@


1.18
log
@Remove these, we have 64-bit time_t now.
@
text
@d1 1
a1 1
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.17 2013/08/11 13:17:41 ajacoutot Exp $
d5 3
a7 3
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Sun Aug 11 00:00:52 2013
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Sun Aug 11 14:57:25 2013
@@@@ -1283,11 +1283,11 @@@@ create_dn_from_contact (EContact *contact,
d13 1
a13 1
 		get_dn_attribute_name (rootdn, contact),
d20 1
a20 1
 	g_free (cn);
@


1.17
log
@Update to evolution-data-server-3.8.5.
@
text
@d1 1
a1 1
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.16 2013/08/06 19:09:27 ajacoutot Exp $
@


1.16
log
@Update to evolution-data-server 3.8.4.
@
text
@d1 1
a1 1
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.15 2013/06/09 09:17:49 ajacoutot Exp $
d5 3
a7 3
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Tue Jul 23 14:01:51 2013
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Wed Jul 24 09:29:22 2013
@@@@ -1270,11 +1270,11 @@@@ create_dn_from_contact (EContact *contact,
d13 1
a13 1
 		get_dn_attribute_name (rootdn),
d20 1
a20 1
 
@


1.15
log
@Update to evolution-data-server-3.8.3.
@
text
@d1 1
a1 1
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.14 2013/03/29 15:17:01 ajacoutot Exp $
d5 3
a7 3
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Sat Jun  8 16:24:32 2013
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Sun Jun  9 10:53:22 2013
@@@@ -1257,11 +1257,11 @@@@ create_dn_from_contact (EContact *contact,
@


1.14
log
@Update to evolution-data-server-3.8.0.
@
text
@d1 1
a1 1
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.13 2013/03/07 08:18:20 ajacoutot Exp $
d5 3
a7 3
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Sun Mar 17 13:46:02 2013
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Fri Mar 29 13:32:31 2013
@@@@ -1255,11 +1255,11 @@@@ create_dn_from_contact (EContact *contact,
@


1.13
log
@Re-add patch that was removed by mistake in previous.
@
text
@d1 1
a1 1
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.11 2013/01/23 15:36:53 ajacoutot Exp $
d5 3
a7 3
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Tue Feb 26 15:58:36 2013
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Thu Mar  7 08:47:07 2013
@@@@ -1276,11 +1276,11 @@@@ create_dn_from_contact (EContact *contact,
@


1.12
log
@- update to evolution-data-server-3.6.4
@
text
@a2 5
From a84d0269dcd3978232cf5dce77ae4a6d7f6107fd Mon Sep 17 00:00:00 2001
From: Milan Crha <mcrha@@redhat.com>
Date: Tue, 22 Jan 2013 19:44:41 +0000
Subject: Bug #692278 - LDAP backend mutex deadlock on finalize

d5 3
a7 71
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Wed Jan 23 16:17:06 2013
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Wed Jan 23 16:17:10 2013
@@@@ -214,7 +214,7 @@@@ struct _EBookBackendLDAPPrivate {
 	gboolean marked_for_offline;
 
 	/* our operations */
-	GStaticRecMutex op_hash_mutex;
+	GStaticRecMutex op_hash_mutex; /* lock also eds_ldap_handler_lock before this lock */
 	GHashTable *id_to_op;
 	gint active_ops;
 	guint poll_timeout;
@@@@ -1147,6 +1147,7 @@@@ ldap_op_add (LDAPOp *op,
 	op->handler = handler;
 	op->dtor = dtor;
 
+	g_static_rec_mutex_lock (&eds_ldap_handler_lock);
 	g_static_rec_mutex_lock (&bl->priv->op_hash_mutex);
 	if (g_hash_table_lookup (bl->priv->id_to_op, &op->id)) {
 		g_warning ("conflicting ldap msgid's");
@@@@ -1161,6 +1162,7 @@@@ ldap_op_add (LDAPOp *op,
 			LDAP_POLL_INTERVAL,
 			(GSourceFunc) poll_ldap, bl);
 	g_static_rec_mutex_unlock (&bl->priv->op_hash_mutex);
+	g_static_rec_mutex_unlock (&eds_ldap_handler_lock);
 }
 
 static void
@@@@ -1169,6 +1171,7 @@@@ ldap_op_finished (LDAPOp *op)
 	EBookBackend *backend = op->backend;
 	EBookBackendLDAP *bl = E_BOOK_BACKEND_LDAP (backend);
 
+	g_static_rec_mutex_lock (&eds_ldap_handler_lock);
 	g_static_rec_mutex_lock (&bl->priv->op_hash_mutex);
 	g_hash_table_remove (bl->priv->id_to_op, &op->id);
 
@@@@ -1176,10 +1179,8 @@@@ ldap_op_finished (LDAPOp *op)
 	book_view_notify_status (bl, find_book_view (bl), "");
 
 	/* should handle errors here */
-	g_static_rec_mutex_lock (&eds_ldap_handler_lock);
 	if (bl->priv->ldap)
 		ldap_abandon (bl->priv->ldap, op->id);
-	g_static_rec_mutex_unlock (&eds_ldap_handler_lock);
 
 	if (op->dtor)
 		op->dtor (op);
@@@@ -1193,6 +1194,7 @@@@ ldap_op_finished (LDAPOp *op)
 		}
 	}
 	g_static_rec_mutex_unlock (&bl->priv->op_hash_mutex);
+	g_static_rec_mutex_unlock (&eds_ldap_handler_lock);
 }
 
 static void
@@@@ -1202,6 +1204,7 @@@@ ldap_op_change_id (LDAPOp *op,
 	EBookBackend *backend = op->backend;
 	EBookBackendLDAP *bl = E_BOOK_BACKEND_LDAP (backend);
 
+	g_static_rec_mutex_lock (&eds_ldap_handler_lock);
 	g_static_rec_mutex_lock (&bl->priv->op_hash_mutex);
 	g_hash_table_remove (bl->priv->id_to_op, &op->id);
 
@@@@ -1209,6 +1212,7 @@@@ ldap_op_change_id (LDAPOp *op,
 
 	g_hash_table_insert (bl->priv->id_to_op, &op->id, op);
 	g_static_rec_mutex_unlock (&bl->priv->op_hash_mutex);
+	g_static_rec_mutex_unlock (&eds_ldap_handler_lock);
 }
 
 static GError *
@@@@ -1272,11 +1276,11 @@@@ create_dn_from_contact (EContact *contact,
a20 53
@@@@ -5226,10 +5230,11 @@@@ ldap_cancel_op (gpointer key,
 	LDAPOp *op = value;
 
 	/* ignore errors, its only best effort? */
-	g_static_rec_mutex_lock (&eds_ldap_handler_lock);
+	/* lock is held by the caller */
+	/* g_static_rec_mutex_lock (&eds_ldap_handler_lock); */
 	if (bl->priv->ldap)
 		ldap_abandon (bl->priv->ldap, op->id);
-	g_static_rec_mutex_unlock (&eds_ldap_handler_lock);
+	/* g_static_rec_mutex_unlock (&eds_ldap_handler_lock); */
 }
 
 static void
@@@@ -5237,9 +5242,11 @@@@ ldap_cancel_all_operations (EBookBackend *backend)
 {
 	EBookBackendLDAP *bl = E_BOOK_BACKEND_LDAP (backend);
 
+	g_static_rec_mutex_lock (&eds_ldap_handler_lock);
 	g_static_rec_mutex_lock (&bl->priv->op_hash_mutex);
 	g_hash_table_foreach (bl->priv->id_to_op, ldap_cancel_op, bl);
 	g_static_rec_mutex_unlock (&bl->priv->op_hash_mutex);
+	g_static_rec_mutex_unlock (&eds_ldap_handler_lock);
 }
 
 static void
@@@@ -5533,10 +5540,11 @@@@ call_dtor (gint msgid,
 
 	bl = E_BOOK_BACKEND_LDAP (op->backend);
 
-	g_static_rec_mutex_lock (&eds_ldap_handler_lock);
+	/* lock is held by the caller */
+	/* g_static_rec_mutex_lock (&eds_ldap_handler_lock); */
 	if (bl->priv->ldap)
 		ldap_abandon (bl->priv->ldap, op->id);
-	g_static_rec_mutex_unlock (&eds_ldap_handler_lock);
+	/* g_static_rec_mutex_unlock (&eds_ldap_handler_lock); */
 
 	op->dtor (op);
 
@@@@ -5550,10 +5558,12 @@@@ e_book_backend_ldap_finalize (GObject *object)
 
 	priv = E_BOOK_BACKEND_LDAP_GET_PRIVATE (object);
 
+	g_static_rec_mutex_lock (&eds_ldap_handler_lock);
 	g_static_rec_mutex_lock (&priv->op_hash_mutex);
 	g_hash_table_foreach_remove (priv->id_to_op, (GHRFunc) call_dtor, NULL);
 	g_hash_table_destroy (priv->id_to_op);
 	g_static_rec_mutex_unlock (&priv->op_hash_mutex);
+	g_static_rec_mutex_unlock (&eds_ldap_handler_lock);
 	g_static_rec_mutex_free (&priv->op_hash_mutex);
 
 	/* Remove the timeout before unbinding to avoid a race. */
@


1.11
log
@Bug #692278 - LDAP backend mutex deadlock on finalize
@
text
@d1 1
a1 1
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.10 2012/11/11 18:10:01 ajacoutot Exp $
@


1.10
log
@Bugfix update to evolution-data-server-3.6.2.
@
text
@d1 6
a6 1
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.9 2012/10/18 13:54:56 ajacoutot Exp $
d10 71
a80 3
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Sun Oct 21 03:22:03 2012
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Sun Nov 11 18:44:42 2012
@@@@ -1272,11 +1272,11 @@@@ create_dn_from_contact (EContact *contact,
d94 53
@


1.9
log
@We are getting fucked by our 32-bits time_t :(
@
text
@d1 1
a1 1
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.8 2012/09/28 06:35:36 ajacoutot Exp $
d5 3
a7 4
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Sun Sep 16 17:05:38 2012
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Thu Oct 18 14:12:14 2012
@@@@ -1264,11 +1264,11 @@@@ create_dn_from_contact (EContact *contact,
 		}
d10 8
a17 7
-	dn = g_strdup_printf ("%s=%s%s%lu",
+	dn = g_strdup_printf ("%s=%s%s%llu",
 			      get_dn_attribute_name (rootdn),
 			      (cn_part && *cn_part) ? cn_part : "",
 			      (cn_part && *cn_part) ? "." : "",
-			      time (NULL));
+			      (long long)time (NULL));
@


1.8
log
@Update to evolution-data-server-3.6.0.
@
text
@d1 1
a1 1
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.7 2012/03/29 06:45:21 ajacoutot Exp $
d3 1
a3 1
On OpenBSD, time_t is an int.
d5 3
a7 3
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Sun Sep 16 17:41:56 2012
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Thu Sep 27 20:30:27 2012
@@@@ -1264,7 +1264,7 @@@@ create_dn_from_contact (EContact *contact,
d12 1
a12 1
+	dn = g_strdup_printf ("%s=%s%s%d",
d16 5
@


1.7
log
@Update to evolution-data-server-3.4.0.
@
text
@d1 1
a1 1
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.6 2011/12/29 09:23:19 ajacoutot Exp $
d5 3
a7 3
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Tue Feb 28 06:01:01 2012
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Fri Mar 23 23:05:19 2012
@@@@ -1248,7 +1248,7 @@@@ create_dn_from_contact (EContact *contact,
@


1.6
log
@Tweak patches to please our time_t.
@
text
@d1 1
a1 1
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.5 2011/09/21 13:26:03 jasper Exp $
d5 3
a7 3
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Thu Oct 20 12:32:50 2011
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Thu Dec 29 09:13:44 2011
@@@@ -1235,7 +1235,7 @@@@ create_dn_from_contact (EContact *contact,
@


1.5
log
@- update to 3.1.92
- hardcode (but with XXX) 3.2 for now
@
text
@d1 7
a7 4
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.4 2011/09/12 07:26:19 ajacoutot Exp $
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Sun Sep  4 00:50:05 2011
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Sat Sep 17 09:57:03 2011
@@@@ -1235,11 +1235,11 @@@@ create_dn_from_contact (EContact *contact,
d12 1
a12 1
+	dn = g_strdup_printf ("%s=%s%s%llu",
a15 5
-			      time (NULL));
+			      (long long)time (NULL));
 
 	g_free (cn_part);
 
@


1.4
log
@Start the GNOME3 merge armageddon... breakage expected.
@
text
@d1 4
a4 4
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.2 2011/08/31 09:21:54 ajacoutot Exp $
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Tue Jul 26 09:35:39 2011
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Wed Aug 31 09:42:39 2011
@@@@ -1209,11 +1209,11 @@@@ create_dn_from_contact (EContact *contact, gchar *root
@


1.3
log
@Tweak some patches and remove -DGTK_DISABLE_DEPRECATED to fix a crash in
evolution calendar.
@
text
@d1 4
a4 4
$OpenBSD$
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Fri Oct  1 14:16:05 2010
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Tue Mar 29 12:29:16 2011
@@@@ -1204,11 +1204,11 @@@@ create_dn_from_contact (EContact *contact, gchar *root
@


1.2
log
@Maintenance update to evolution-data-server-2.32.2.
Unbreak with new gtk+2.
@
text
@d1 4
a4 4
$OpenBSD: patch-addressbook_backends_ldap_e-book-backend-ldap_c,v 1.1 2010/09/30 07:32:09 ajacoutot Exp $
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Fri Oct 29 12:22:59 2010
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Mon Jan 31 17:49:28 2011
@@@@ -1204,7 +1204,7 @@@@ create_dn_from_contact (EContact *contact, gchar *root
d9 1
a9 1
+	dn = g_strdup_printf ("%s=%s%s%d",
d13 5
@


1.1
log
@Update to evolution-data-server-2.32.0.

ok jasper@@
@
text
@d1 4
a4 4
$OpenBSD$
--- addressbook/backends/ldap/e-book-backend-ldap.c.orig	Tue Sep 28 07:49:59 2010
+++ addressbook/backends/ldap/e-book-backend-ldap.c	Tue Sep 28 07:51:32 2010
@@@@ -1194,7 +1194,7 @@@@ create_dn_from_contact (EContact *contact, gchar *root
@

