head	1.2;
access;
symbols
	OPENBSD_5_7:1.1.0.2
	OPENBSD_5_7_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2015.06.01.08.23.47;	author pea;	state dead;
branches;
next	1.1;
commitid	e36nnVhtg77MitAe;

1.1
date	2015.02.17.12.43.08;	author jca;	state Exp;
branches
	1.1.2.1;
next	;
commitid	ptvl6zq7GEqrMDL6;

1.1.2.1
date	2015.06.01.08.25.24;	author pea;	state dead;
branches;
next	;
commitid	0NJVxtR69vYaa1gJ;


desc
@@


1.2
log
@Security / reliability update to 9.4.2

go ahead ajacoutot@@
@
text
@$OpenBSD: patch-src_backend_libpq_hba_c,v 1.1 2015/02/17 12:43:08 jca Exp $
--- src/backend/libpq/hba.c.orig	Mon Feb 16 21:53:21 2015
+++ src/backend/libpq/hba.c	Mon Feb 16 23:08:38 2015
@@@@ -700,8 +700,13 @@@@ check_ip(SockAddr *raddr, struct sockaddr * addr, stru
 		struct sockaddr_storage addrcopy,
 					maskcopy;
 
-		memcpy(&addrcopy, &addr, sizeof(addrcopy));
-		memcpy(&maskcopy, &mask, sizeof(maskcopy));
+		memcpy(&addrcopy, addr, sizeof(struct sockaddr_in));
+		/*
+		 * On some OSes, if mask is obtained from eg. getifaddrs(3), sa_len
+		 * can vary wildly. We already know that addr->sa_family == AF_INET,
+		 * so just use sizeof(struct sockaddr_in).
+		 */
+		memcpy(&maskcopy, mask, sizeof(struct sockaddr_in));
 		pg_promote_v4_to_v6_addr(&addrcopy);
 		pg_promote_v4_to_v6_mask(&maskcopy);
 
@


1.1
log
@Fix hba with IPv6 connections.

The incorrect code was generating memcpy calls with src and dest
overlapping, which raises SIGABRT, making the server unreachable
using IPv6.  The fix consists in passing the right parameters to
memcpy, including sizeof(struct sockaddr_in) as len, since
sizeof(struct sockaddr_storage) would be too much, and sa_len
is unusable in netmask sockaddrs.  Debugged with sthen@@ and lteo@@

Problem reported by Hugo Osvaldo Barrera.

ok sthen@@
@
text
@d1 1
a1 1
$OpenBSD$
@


1.1.2.1
log
@Security / reliability update to 9.4.2

go ahead ajacoutot@@
@
text
@d1 1
a1 1
$OpenBSD: patch-src_backend_libpq_hba_c,v 1.1 2015/02/17 12:43:08 jca Exp $
@


