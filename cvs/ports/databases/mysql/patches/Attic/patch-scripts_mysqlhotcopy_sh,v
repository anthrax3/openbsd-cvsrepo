head	1.4;
access;
symbols
	OPENBSD_3_6:1.1.0.6
	OPENBSD_3_6_BASE:1.1
	OPENBSD_3_4:1.1.0.4
	OPENBSD_3_5:1.1.0.2;
locks; strict;
comment	@# @;


1.4
date	2005.01.20.02.49.25;	author brad;	state dead;
branches;
next	1.3;

1.3
date	2005.01.14.01.42.58;	author brad;	state Exp;
branches;
next	1.2;

1.2
date	2004.10.20.01.54.05;	author brad;	state Exp;
branches;
next	1.1;

1.1
date	2004.08.20.09.21.19;	author robert;	state Exp;
branches
	1.1.2.1
	1.1.4.1;
next	;

1.1.2.1
date	2004.08.23.17.34.57;	author robert;	state Exp;
branches;
next	;

1.1.4.1
date	2004.08.23.17.36.11;	author robert;	state Exp;
branches;
next	;


desc
@@


1.4
log
@go away 0 byte file.
@
text
@@


1.3
log
@upgrade to MySQL 4.0.23

fixes some crashing issues among many other bug fixes,
seems to have resolved a crashing issue henning@@ was
experiencing on sparc64.
@
text
@@


1.2
log
@sync
@
text
@a0 50
$OpenBSD: patch-scripts_mysqlhotcopy_sh,v 1.1 2004/08/20 09:21:19 robert Exp $
--- scripts/mysqlhotcopy.sh.orig	Thu May 13 20:53:38 2004
+++ scripts/mysqlhotcopy.sh	Tue Oct 19 21:46:12 2004
@@@@ -7,6 +7,7 @@@@ use File::Basename;
 use File::Path;
 use DBI;
 use Sys::Hostname;
+use File::Temp;
 
 =head1 NAME
 
@@@@ -610,7 +611,6 @@@@ sub copy_files {
 sub copy_index
 {
   my ($method, $files, $source, $target) = @@_;
-  my $tmpfile="$opt_tmpdir/mysqlhotcopy$$";
   
   print "Copying indices for ".@@$files." files...\n" unless $opt{quiet};  
   foreach my $file (@@$files)
@@@@ -636,23 +636,23 @@@@ sub copy_index
       }
       close OUTPUT	   || die "Error on close of $to: $!\n";
     }
-    elsif ($opt{method} eq 'scp')
+    elsif ($opt{method} =~ /^scp\b/)
     {
-      my $tmp=$tmpfile;
-      open(OUTPUT,">$tmp") || die "Can\'t create file $tmp: $!\n";
-      if (syswrite(OUTPUT,$buff) != length($buff))
+      my ($fh, $tmp)=tempfile('mysqlhotcopy-XXXXXX', DIR => $opt_tmpdir);
+      die "Can\'t create/open file in $opt_tmpdir\n" unless defined $fh;
+      if (syswrite($fh,$buff) != length($buff))
       {
 	die "Error when writing data to $tmp: $!\n";
       }
-      close OUTPUT	     || die "Error on close of $tmp: $!\n";
-      safe_system("scp $tmp $to");
+      close $fh || die "Error on close of $tmp: $!\n";
+      safe_system("$opt{method} $tmp $to");
+      unlink $tmp;
     }
     else
     {
       die "Can't use unsupported method '$opt{method}'\n";
     }
   }
-  unlink "$tmpfile" if  ($opt{method} eq 'scp');
 }
 
 
@


1.1
log
@SECURITY:
Jeroen van Wolffelaar <jeroen@@wolffelaar.nl> discovered an
insecure temporary file vulnerability in the mysqlhotcopy
script when using the scp method.

ok naddy, brad, pvalchev
@
text
@d1 4
a4 4
$OpenBSD$
--- scripts/mysqlhotcopy.sh.orig	Fri May 14 02:53:38 2004
+++ scripts/mysqlhotcopy.sh	Fri Aug 20 01:21:57 2004
@@@@ -7,6 +7,7 @@@@
d12 1
a12 1
@@@@ -610,7 +611,6 @@@@
d20 1
a20 1
@@@@ -636,23 +636,23 @@@@
@


1.1.4.1
log
@SECURITY:
Jeroen van Wolffelaar <jeroen@@wolffelaar.nl> discovered an
insecure temporary file vulnerability in the mysqlhotcopy
script when using the scp method.

ok brad@@
@
text
@@


1.1.2.1
log
@SECURITY:
Jeroen van Wolffelaar <jeroen@@wolffelaar.nl> discovered an
insecure temporary file vulnerability in the mysqlhotcopy
script when using the scp method.

ok brad@@
@
text
@@

