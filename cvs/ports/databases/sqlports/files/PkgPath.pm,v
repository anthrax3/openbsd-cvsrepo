head	1.5;
access;
symbols
	OPENBSD_6_2:1.5.0.10
	OPENBSD_6_2_BASE:1.5
	OPENBSD_6_1:1.5.0.8
	OPENBSD_6_1_BASE:1.5
	OPENBSD_6_0:1.5.0.6
	OPENBSD_6_0_BASE:1.5
	OPENBSD_5_9:1.5.0.2
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.5.0.4
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.4.0.8
	OPENBSD_5_7_BASE:1.4
	OPENBSD_5_6:1.4.0.6
	OPENBSD_5_6_BASE:1.4
	OPENBSD_5_5:1.4.0.4
	OPENBSD_5_5_BASE:1.4
	OPENBSD_5_4:1.4.0.2
	OPENBSD_5_4_BASE:1.4
	OPENBSD_5_3:1.3.0.4
	OPENBSD_5_3_BASE:1.3
	OPENBSD_5_2:1.3.0.2
	OPENBSD_5_2_BASE:1.3;
locks; strict;
comment	@# @;


1.5
date	2015.04.19.12.08.02;	author espie;	state Exp;
branches;
next	1.4;
commitid	tB9sPkOJYeMqAhV4;

1.4
date	2013.04.06.12.52.35;	author espie;	state Exp;
branches;
next	1.3;

1.3
date	2012.05.22.12.04.02;	author espie;	state Exp;
branches;
next	1.2;

1.2
date	2012.05.20.11.06.07;	author espie;	state Exp;
branches;
next	1.1;

1.1
date	2012.05.18.12.11.28;	author espie;	state Exp;
branches;
next	;


desc
@@


1.5
log
@track first dependency parent so that we can display it, instead
of the user having to figure out where the broken dependency comes from
by inspecting the partial database.
@
text
@# ex:ts=8 sw=4:
# $OpenBSD: PkgPath.pm,v 1.4 2013/04/06 12:52:35 espie Exp $
#
# Copyright (c) 2012 Marc Espie <espie@@openbsd.org>
#
# Permission to use, copy, modify, and distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

BEGIN {
	$ports1 = $ENV{PORTSDIR} || '/usr/ports';
}
use lib ("$ports1/infrastructure/lib");

use DPB::BasePkgPath;

package PkgPath;
our @@ISA = qw(DPB::BasePkgPath);
use Info;

sub init
{
}

sub clone_properties
{
	my ($n, $o) = @@_;
	$n->{info} //= $o->{info};
}

sub subpackage
{
	my $self = shift;
	return $self->{info}->value('SUBPACKAGE');
}

sub flavor
{
	my $self = shift;
	my $value = $self->{info}->value('FLAVOR');
	$value =~ s/^\s+//;
	$value =~ s/\s+$//;
	my @@l = split(/\s+/, $value);
	my %values = map {($_,1)}  @@l;
	
	return \%values;
}

sub equates
{
}

sub simplifies_to
{
}

sub change_multi
{
	my ($path, $multi) = @@_;
	# make a tmp copy, non registered
	my $tmp = ref($path)->create($path->fullpkgpath);
	if ($multi eq '-main') {
		$tmp->{m} = undef;
	} else {
		$tmp->{m} = $multi;
	}
	return $tmp->normalize;
}

sub break
{
	my ($path, $message) = @@_;
	$path->{parent} //= '?';
	print STDERR $path->fullpkgpath, "(", $path->{parent}, "):", 
	    $message, "\n";
}

1;
@


1.4
log
@needed for error messages
@
text
@d2 1
a2 1
# $OpenBSD: PkgPath.pm,v 1.3 2012/05/22 12:04:02 espie Exp $
d81 3
a83 1
	print STDERR $path->fullpkgpath, ": " , $message, "\n";
@


1.3
log
@tweak: MULTI table now holds pointer to the corresponding subpackage path
@
text
@d2 1
a2 1
# $OpenBSD: PkgPath.pm,v 1.2 2012/05/20 11:06:07 espie Exp $
d76 6
@


1.2
log
@more surgery:
- don't ask the database about existing pathkeys, it's simpler to have
our hash.
- in dependencies, don't like for non normalized pathkeys
- add CANONICAL column, and fill it.
@
text
@d2 1
a2 1
# $OpenBSD: PkgPath.pm,v 1.1 2012/05/18 12:11:28 espie Exp $
d63 13
@


1.1
log
@bite the bullet, reuse dpb's algorithm to make sure we get correct
PkgPath.

This implies restructuring the database code, and the start of a
better separation between variables handling, and actual insertion
in the database.

bump version to 2.0: this changes the paths that actually get recorded,
and pkglocatedb will need to be aware of that.
@
text
@d2 1
a2 1
# $OpenBSD$
a62 1
	my ($self, $other, $inserter) = @@_;
@

