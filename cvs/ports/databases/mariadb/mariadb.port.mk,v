head	1.4;
access;
symbols
	OPENBSD_6_1:1.4.0.8
	OPENBSD_6_1_BASE:1.4
	OPENBSD_6_0:1.4.0.6
	OPENBSD_6_0_BASE:1.4
	OPENBSD_5_9:1.4.0.2
	OPENBSD_5_9_BASE:1.4
	OPENBSD_5_8:1.4.0.4
	OPENBSD_5_8_BASE:1.4;
locks; strict;
comment	@# @;


1.4
date	2015.07.19.12.42.20;	author zhuk;	state Exp;
branches;
next	1.3;
commitid	AuPP6ZdeNA54Si13;

1.3
date	2015.07.19.12.34.41;	author zhuk;	state Exp;
branches;
next	1.2;
commitid	pqcQq9HPSzF52mxu;

1.2
date	2015.07.17.20.56.59;	author zhuk;	state Exp;
branches;
next	1.1;
commitid	GI1SK2TGFG4DfvVL;

1.1
date	2015.07.17.14.41.58;	author zhuk;	state Exp;
branches;
next	;
commitid	vJqGchYtbgXWlstW;


desc
@@


1.4
log
@Run test commands in a subshell to avoid potential clutter of variables
coming from those modules.
@
text
@# $OpenBSD: mariadb.port.mk,v 1.3 2015/07/19 12:34:41 zhuk Exp $
#
# Helps testing MySQL/MariaDB-based software, no B/L/R-DEPS here.

MODMARIADB_TEST_CMD ?= \
	${MAKE_PROGRAM} ${ALL_TEST_FLAGS} -f ${MAKE_FILE} ${TEST_TARGET}

MODMARIADB_TEST_DBNAME ?=
MODMARIADB_TEST_SOCKET =	${WRKDIR}/mariadb.sock
_MODMARIADB_TEST_DATA_DIR =	${WRKDIR}/testdb-mariadb

MODMARIADB_SERVER_ARGS = \
	--no-defaults \
	--datadir=${_MODMARIADB_TEST_DATA_DIR} \
	--skip-grant-tables \
	--skip-networking \
	--socket=${MODMARIADB_TEST_SOCKET}

MODMARIADB_ADMIN_ARGS = \
	--no-defaults \
	--host=localhost \
	--protocol=socket \
	--socket=${MODMARIADB_TEST_SOCKET}

MODMARIADB_CLIENT_ARGS =	${MODMARIADB_ADMIN_ARGS}

.if !empty(MODMARIADB_TEST_DBNAME)
MODMARIADB_CLIENT_ARGS +=	--database=${MODMARIADB_TEST_DBNAME}
.endif

TEST_DEPENDS +=		databases/mariadb,-server
TEST_ENV += \
	MYSQL_HOME=${WRKDIR} \
	MYSQL_HOST=localhost \
	MYSQL_UNIX_PORT=${MODMARIADB_TEST_SOCKET}

MODMARIADB_TEST_TARGET = \
	rm -Rf ${_MODMARIADB_TEST_DATA_DIR}; \
	export ${ALL_TEST_ENV}; \
	${LOCALBASE}/bin/mysql_install_db \
		--skip-name-resolve \
		${MODMARIADB_SERVER_ARGS}; \
	${LOCALBASE}/libexec/mysqld \
		${MODMARIADB_SERVER_ARGS} & \
	started=false; \
	for i in $$(jot 10); do \
		sleep 1; \
		if mysqladmin ${MODMARIADB_ADMIN_ARGS} \
		    ping >/dev/null 2>&1; then \
			started=true; \
			break; \
		fi; \
	done; \
	$$started || { echo "mysqld didn't start" >&2; kill $$!; exit 1; };
.if !empty(MODMARIADB_TEST_DBNAME)
MODMARIADB_TEST_TARGET += \
	${LOCALBASE}/bin/mysqladmin ${MODMARIADB_ADMIN_ARGS} \
	    create ${MODMARIADB_TEST_DBNAME} || \
	    { kill $$!; exit 1; };
.endif
MODMARIADB_TEST_TARGET += \
	set +e; \
	cd ${WRKBUILD}; \
	( ${MODMARIADB_TEST_CMD} ); \
	Q=$$?; \
	kill $$!; \
	exit $$Q

.if !target(do-test)
do-test:
	${MODMARIADB_TEST_TARGET}
.endif
@


1.3
log
@Don't use same directory for both mariadb.port.mk and postgresql.port.mk:
they could be used at the same time, and each of them wipes the database
directory before running server.
@
text
@d1 1
a1 1
# $OpenBSD: mariadb.port.mk,v 1.2 2015/07/17 20:56:59 zhuk Exp $
d64 1
a64 1
	${MODMARIADB_TEST_CMD}; \
@


1.2
log
@Improve mysqld readiness detection a bit:

  - Don't issue ping immediately, mysqld won't be ready for sure.

  - Don't print mysqladmin ping output: it confuses a careful reader and
    doesn't provide any useful info; we'd better say that mysqld could not
    start explicitly, if needed.

Discovered while moving ports to mariadb.port.mk.
@
text
@d1 1
a1 1
# $OpenBSD: mariadb.port.mk,v 1.1 2015/07/17 14:41:58 zhuk Exp $
d10 1
a10 1
_MODMARIADB_TEST_DATA_DIR =	${WRKDIR}/testdb
@


1.1
log
@Add mariadb.port.mk, a test-support module for MySQL/MariaDB-based ports.

This is an analog of postgresql.port.mk, but for MariaDB. p5-DBD-mysql
is on its way to use this module soon, others to follow.

Documentation bits will go in soon as well.

okay giovanni@@
@
text
@d1 1
a1 1
# $OpenBSD$
d47 3
a49 1
		if mysqladmin ${MODMARIADB_ADMIN_ARGS} ping; then \
a52 1
		sleep 1; \
d54 1
a54 1
	$$started || { kill $$!; exit 1; };
@

