head	1.2;
access;
symbols
	OPENBSD_6_0:1.2.0.14
	OPENBSD_6_0_BASE:1.2
	OPENBSD_5_9:1.2.0.10
	OPENBSD_5_9_BASE:1.2
	OPENBSD_5_8:1.2.0.12
	OPENBSD_5_8_BASE:1.2
	OPENBSD_5_7:1.2.0.8
	OPENBSD_5_7_BASE:1.2
	OPENBSD_5_6:1.2.0.6
	OPENBSD_5_6_BASE:1.2
	OPENBSD_5_5:1.2.0.4
	OPENBSD_5_5_BASE:1.2
	OPENBSD_5_4:1.2.0.2
	OPENBSD_5_4_BASE:1.2
	OPENBSD_5_3:1.1.1.1.0.2
	OPENBSD_5_3_BASE:1.1.1.1
	jmatthew_20120824:1.1.1.1
	jmatthew:1.1.1;
locks; strict;
comment	@# @;


1.2
date	2013.03.26.05.26.30;	author jmatthew;	state Exp;
branches;
next	1.1;

1.1
date	2012.08.24.07.26.29;	author jmatthew;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2012.08.24.07.26.29;	author jmatthew;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Update to riak 1.3.0

ok ajacoutot@@
@
text
@$OpenBSD: patch-erlang-js-spidermonkey_c,v 1.1.1.1 2012/08/24 07:26:29 jmatthew Exp $

Cope with API change between bundled spidermonkey 1.8 and external 1.9.
Use JS_SetOperationCallback instead of JS_SetBranchCallback to perform
periodic gc, and fix some compiler warnings in the call to JS_DefineFunction.

--- deps/erlang_js/c_src/spidermonkey.c.orig	Wed Jan 30 06:13:01 2013
+++ deps/erlang_js/c_src/spidermonkey.c	Sat Feb 23 10:27:33 2013
@@@@ -78,19 +78,19 @@@@ void on_error(JSContext *context, const char *message,
   }
 }
 
-JSBool on_branch(JSContext *context, JSScript *script) {
+JSBool on_operation(JSContext *context) {
   JSBool return_value = JS_TRUE;
   spidermonkey_state *state = (spidermonkey_state *) JS_GetContextPrivate(context);
-  state->branch_count++;
+  state->operation_count++;
 
   if (state->terminate)  {
       return_value = JS_FALSE;
   }
-  else if (state->branch_count == 550) {
+  else if (state->operation_count == 550) {
     JS_GC(context);
-    state->branch_count = 0;
+    state->operation_count = 0;
   }
-  else if(state->branch_count % 100 == 0) {
+  else if(state->operation_count % 100 == 0) {
     JS_MaybeGC(context);
   }
 
@@@@ -140,7 +140,7 @@@@ void sm_configure_locale(void) {
 spidermonkey_vm *sm_initialize(long thread_stack, long heap_size) {
   spidermonkey_vm *vm = ejs_alloc(sizeof(spidermonkey_vm));
   spidermonkey_state *state = ejs_alloc(sizeof(spidermonkey_state));
-  state->branch_count = 0;
+  state->operation_count = 0;
   state->error = NULL;
   state->terminate = 0;
   int gc_size = (int) heap_size * 0.25;
@@@@ -158,10 +158,9 @@@@ spidermonkey_vm *sm_initialize(long thread_stack, long
   vm->global = JS_NewObject(vm->context, &global_class, NULL, NULL);
   JS_InitStandardClasses(vm->context, vm->global);
   JS_SetErrorReporter(vm->context, on_error);
-  JS_SetBranchCallback(vm->context, on_branch);
+  JS_SetOperationCallback(vm->context, on_operation);
   JS_SetContextPrivate(vm->context, state);
-  JSNative funptr = (JSNative) &js_log;
-  JS_DefineFunction(vm->context, JS_GetGlobalObject(vm->context), "ejsLog", funptr,
+  JS_DefineFunction(vm->context, JS_GetGlobalObject(vm->context), "ejsLog", (JSNative)js_log,
                     0, JSFUN_FAST_NATIVE);
   end_request(vm);
 
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
$OpenBSD$
d7 2
a8 2
--- deps/erlang_js/c_src/spidermonkey.c.orig	Fri Jul 13 23:29:23 2012
+++ deps/erlang_js/c_src/spidermonkey.c	Wed Aug  8 11:35:56 2012
d50 2
a51 2
-  JSNative *funptr = (JSNative *) *js_log;
-  JS_DefineFunction(vm->context, JS_GetGlobalObject(vm->context), "ejsLog", *funptr,
@


1.1.1.1
log
@import riak

Riak combines a decentralized key-value store, a flexible map/reduce engine, 
and a friendly HTTP/JSON query interface to provide a database ideally suited 
for Web applications.

ok dlg@@
@
text
@@
