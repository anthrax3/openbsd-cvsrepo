head	1.1;
access;
symbols
	OPENBSD_6_0:1.1.0.18
	OPENBSD_6_0_BASE:1.1
	OPENBSD_5_9:1.1.0.14
	OPENBSD_5_9_BASE:1.1
	OPENBSD_5_8:1.1.0.16
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.12
	OPENBSD_5_7_BASE:1.1
	OPENBSD_5_6:1.1.0.10
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.8
	OPENBSD_5_5_BASE:1.1
	OPENBSD_5_4:1.1.0.6
	OPENBSD_5_4_BASE:1.1
	OPENBSD_5_3:1.1.0.4
	OPENBSD_5_3_BASE:1.1
	OPENBSD_5_2:1.1.0.2
	OPENBSD_5_2_BASE:1.1;
locks; strict;
comment	@# @;


1.1
date	2012.04.03.10.56.03;	author giovanni;	state Exp;
branches;
next	;


desc
@@


1.1
log
@
Fix incremental backups
@
text
@$OpenBSD$
--- usr/share/mysql-zrm/plugins/ssh-copy.pl.orig	Thu Feb  4 01:19:25 2010
+++ usr/share/mysql-zrm/plugins/ssh-copy.pl	Tue Apr  3 12:41:10 2012
@@@@ -52,7 +52,7 @@@@ $ENV{"PATH"}="/usr/local/bin:/opt/csw/bin:/bin:/usr/bi
 
 my $SSH="ssh";
 my @@SSH_ARR;
-my $TAR="tar";
+my $TAR="gtar";
 my $RM="rm";
 my $MKDIR="mkdir";
 my $LS="ls";
@@@@ -273,7 +273,7 @@@@ sub doCreateLinks()
 
 	my $f = basename($tmpFile);
 	my $d = dirname( $tmpFile);
-	$r = system( "$TAR --same-owner $compress -cphsC $d $f | $SSH $REMOTE_USER\@@$host $TAR --same-owner $compress -xphsC $TMP_DIR" );
+	$r = system( "$TAR --same-owner $compress -f- -cphsC $d $f | $SSH $REMOTE_USER\@@$host $TAR --same-owner $compress -f- -xphsC $TMP_DIR" );
 
 	unlink( $tmpFile );	
 	if( $r > 0 ){
@@@@ -291,7 +291,7 @@@@ sub doCreateLinks()
 sub doTar()
 {
 	my $cmd;
-	my $tarCmd = "$TAR --same-owner $compress -phsC ";
+	my $tarCmd = "$TAR --same-owner $compress -f- -phsC ";
 	
 	my $fileList = $srcFile;
 	my $lsCmd = "";
@@@@ -336,7 +336,7 @@@@ sub doMySQLHotCopy()
 		die( "mysqlhotcopy on host $host failed" );
 	}
 	
-	$r = system( "$SSH $REMOTE_USER\@@$host $TAR --same-owner $compress -cphsC $TMP_DIR . | $TAR --same-owner $compress -xphsC $destDir" );
+	$r = system( "$SSH $REMOTE_USER\@@$host $TAR --same-owner $compress -f- -cphsC $TMP_DIR . | $TAR --same-owner $compress -f- -xphsC $destDir" );
 	
 	&removeTmpDir();
 	if( $r > 0 ){
@@@@ -440,7 +440,7 @@@@ sub doSnapshotCommand()
 
 	my $f = basename($fName);
 	my $d = dirname( $fName);
-	$r = system( "$TAR --same-owner $compress -cphsC $d $f | $SSH $REMOTE_USER\@@$host $TAR --same-owner $compress -xphsC $TMP_DIR" );
+	$r = system( "$TAR --same-owner $compress -f- -cphsC $d $f | $SSH $REMOTE_USER\@@$host $TAR --same-owner $compress -f- -xphsC $TMP_DIR" );
 
 	unlink( $fName );	
 	if( $r > 0 ){
@
