head	1.5;
access;
symbols
	OPENBSD_6_1:1.5.0.12
	OPENBSD_6_1_BASE:1.5
	OPENBSD_6_0:1.5.0.10
	OPENBSD_6_0_BASE:1.5
	OPENBSD_5_9:1.5.0.6
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.5.0.8
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.5.0.4
	OPENBSD_5_7_BASE:1.5
	OPENBSD_5_6:1.5.0.2
	OPENBSD_5_6_BASE:1.5
	OPENBSD_5_5:1.4.0.8
	OPENBSD_5_5_BASE:1.4
	OPENBSD_5_4:1.4.0.6
	OPENBSD_5_4_BASE:1.4
	OPENBSD_5_3:1.4.0.4
	OPENBSD_5_3_BASE:1.4
	OPENBSD_5_2:1.4.0.2
	OPENBSD_5_2_BASE:1.4
	OPENBSD_5_1_BASE:1.3
	OPENBSD_5_1:1.3.0.8
	OPENBSD_5_0:1.3.0.6
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_9:1.3.0.4
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.3.0.2
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.2.0.6
	OPENBSD_4_7_BASE:1.2
	OPENBSD_4_6:1.2.0.4
	OPENBSD_4_6_BASE:1.2
	OPENBSD_4_5:1.2.0.2
	OPENBSD_4_5_BASE:1.2
	giovanni_20081018:1.1.1.1
	sthen:1.1.1;
locks; strict;
comment	@# @;


1.5
date	2014.05.13.14.00.45;	author giovanni;	state Exp;
branches;
next	1.4;

1.4
date	2012.03.29.09.30.05;	author giovanni;	state Exp;
branches;
next	1.3;

1.3
date	2010.05.05.17.03.19;	author giovanni;	state Exp;
branches;
next	1.2;

1.2
date	2008.12.22.14.44.26;	author giovanni;	state Exp;
branches;
next	1.1;

1.1
date	2008.10.17.23.05.41;	author sthen;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2008.10.17.23.05.41;	author sthen;	state Exp;
branches;
next	;


desc
@@


1.5
log
@
Update to 3.0
remove archivers/gtar dependency
fix backup verification
optional integration with databases/mydumper to speed up backups
@
text
@$OpenBSD: patch-usr_bin_mysql-zrm-backup,v 1.4 2012/03/29 09:30:05 giovanni Exp $
--- usr/bin/mysql-zrm-backup.orig	Mon Aug 26 22:45:36 2013
+++ usr/bin/mysql-zrm-backup	Tue May 13 15:31:42 2014
@@@@ -40,7 +40,7 @@@@ $SIG{'TERM'} = sub { $abort_flag = 1; };
 $SIG{'PIPE'} = sub { &printWarning( "Communication pipe broke. Continuing\n" ); };
 
 
-my $MD5SUM="md5sum";
+my $MD5SUM="md5";
 
 
 my $MAILCMD="";
@@@@ -1692,8 +1692,11 @@@@ sub doMyDumper()
         if( $abort_flag ){
                 &abortAndDie( );
         }
-	    my $command = "";
-	    $command .= " ".$_[0]." --outputdir ".$inputs{"destination"};
+	    my $command = " ";
+	    if ( defined $_[0] ) {
+		$command .= $_[0];
+	    }
+	    $command .= " --outputdir ".$inputs{"destination"};
 	    if( defined $inputs{"extra-mydumper-options"} ){
                 $command .= " ".$inputs{"extra-mydumper-options"};
         }
@@@@ -1834,7 +1837,7 @@@@ sub doMySqlDump()
         $command .= " 2>>$CMDERR";
         $command = $p.$command;
         my $pipestatus =tmpnam();
-        $command ="bash -c '$command;echo \${PIPESTATUS[@@]} > $pipestatus 2>>$CMDERR'";
+        $command ="sh -c '$command;echo \${PIPESTATUS[@@]} > $pipestatus 2>>$CMDERR'";
 	if( $verbose ) {
 		&printLog( "Command used for logical backup is ".$p.$command."\n" );
 	}
@@@@ -2035,13 +2038,13 @@@@ sub totalSize()
 				    $inputs{"synchronous-checksum"} == 1 ){
 					my $file = $File::Find::fullname;
 					if( -f $file ){
-						my $x = $MD5SUM." -b "."\"$file\"";
+						my $x = $MD5SUM." -q "."\"$file\"";
         					$x = &execCmdAndGetOutput($x);
+						chomp($x);
 						if( !defined $x ){
 							&printError( "Could not get md5 checksum\n" );
 						}else{
-                                			my @@a = split( / /, $x );
-                                			$mdcheck{$file}=$a[0];
+                                			$mdcheck{$file}=$x;
 						}
 					}
 				}
@@@@ -2369,7 +2372,7 @@@@ sub runAsyncChecksumProcess()
 		my $f = catfile( $inputs{"destination"}, ".checksum_pending" );
 		open( TP, ">$f" );
 		close( TP );
-		system( "/usr/bin/mysql-zrm-verify-backup --create-checksum --source-directory $inputs{'destination'} --backup-set $backupset 2>/dev/null" );
+		system( "${TRUEPREFIX}/bin/mysql-zrm-verify-backup --create-checksum --source-directory $inputs{'destination'} --backup-set $backupset 2>/dev/null" );
 	}
 }
 
@


1.4
log
@
Fix scheduler and backup checksum handling in synchronous mode
@
text
@d1 3
a3 3
$OpenBSD: patch-usr_bin_mysql-zrm-backup,v 1.3 2010/05/05 17:03:19 giovanni Exp $
--- usr/bin/mysql-zrm-backup.orig	Thu Feb  4 01:19:25 2010
+++ usr/bin/mysql-zrm-backup	Thu Mar 29 11:05:57 2012
d13 24
a36 1
@@@@ -1889,8 +1889,9 @@@@ sub totalSize()
d47 15
@


1.3
log
@
Update to 2.2.0
help and ok sthen@@
@
text
@d1 1
a1 1
$OpenBSD: patch-usr_bin_mysql-zrm-backup,v 1.2 2008/12/22 14:44:26 giovanni Exp $
d3 1
a3 1
+++ usr/bin/mysql-zrm-backup	Wed May  5 12:11:16 2010
d13 1
a13 1
@@@@ -1889,7 +1889,7 @@@@ sub totalSize()
d18 1
a18 1
+						my $x = $MD5SUM." -bq "."\"$file\"";
d20 1
d23 1
@


1.2
log
@
Update to mysql-zrm 2.1
Regen patches
ok sthen@@
@
text
@d1 5
a5 4
$OpenBSD: patch-usr_bin_mysql-zrm-backup,v 1.1.1.1 2008/10/17 23:05:41 sthen Exp $
--- usr/bin/mysql-zrm-backup.orig	Fri Dec  5 01:46:01 2008
+++ usr/bin/mysql-zrm-backup	Fri Dec 19 11:05:27 2008
@@@@ -38,7 +38,7 @@@@ use ZRM::MySQL;
a6 1
 $SIG{'TERM'} = sub { $abort_flag = 1; };
a9 1
 my $MAILCMD="mail";
d11 3
a13 2
 #Neither mysqlhotcopy not mysqldump will do a --flush-logs 
@@@@ -1585,7 +1585,7 @@@@ sub totalSize()
@


1.1
log
@Initial revision
@
text
@d1 3
a3 3
$OpenBSD$
--- usr/bin/mysql-zrm-backup.orig	Mon Oct 13 19:26:13 2008
+++ usr/bin/mysql-zrm-backup	Mon Oct 13 19:26:33 2008
d13 1
a13 1
@@@@ -1504,7 +1504,7 @@@@ sub totalSize()
@


1.1.1.1
log
@import mysql-zrm:

Zmanda recovery manager for MySQL (MySQL ZRM) is a backup and
recovery manager for MySQL database server. It also provides backup
scheduling and reporting features.

It supports backup of MySQL databases/tables using various methods
(both running on same machine as the MySQL server as well as on a
remote machine).

From maintainer Giovanni Bechis, thanks!
@
text
@@
