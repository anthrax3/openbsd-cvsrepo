head	1.2;
access;
symbols
	OPENBSD_6_0:1.1.1.1.0.24
	OPENBSD_6_0_BASE:1.1.1.1
	OPENBSD_5_9:1.1.1.1.0.20
	OPENBSD_5_9_BASE:1.1.1.1
	OPENBSD_5_8:1.1.1.1.0.22
	OPENBSD_5_8_BASE:1.1.1.1
	OPENBSD_5_7:1.1.1.1.0.18
	OPENBSD_5_7_BASE:1.1.1.1
	OPENBSD_5_6:1.1.1.1.0.16
	OPENBSD_5_6_BASE:1.1.1.1
	OPENBSD_5_5:1.1.1.1.0.14
	OPENBSD_5_5_BASE:1.1.1.1
	OPENBSD_5_4:1.1.1.1.0.12
	OPENBSD_5_4_BASE:1.1.1.1
	OPENBSD_5_3:1.1.1.1.0.10
	OPENBSD_5_3_BASE:1.1.1.1
	OPENBSD_5_2:1.1.1.1.0.8
	OPENBSD_5_2_BASE:1.1.1.1
	OPENBSD_5_1_BASE:1.1.1.1
	OPENBSD_5_1:1.1.1.1.0.6
	OPENBSD_5_0:1.1.1.1.0.4
	OPENBSD_5_0_BASE:1.1.1.1
	OPENBSD_4_9:1.1.1.1.0.2
	OPENBSD_4_9_BASE:1.1.1.1
	pea_20110107:1.1.1.1
	pea:1.1.1;
locks; strict;
comment	@# @;


1.2
date	2016.11.16.19.55.30;	author jca;	state Exp;
branches;
next	1.1;
commitid	883qzZc4bk9EDmFr;

1.1
date	2011.01.07.10.17.04;	author pea;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2011.01.07.10.17.04;	author pea;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Unbreak after last libssl cleanup.

Just don't use ssl3_send_alert(), as done in more recent openldap
versions.  Diff from guenther@@, ok henning@@ sthen@@
@
text
@$OpenBSD: patch-libraries_libldap_tls_c,v 1.1.1.1 2011/01/07 10:17:04 pea Exp $
--- libraries/libldap/tls.c.orig	Tue Feb 12 00:24:12 2008
+++ libraries/libldap/tls.c	Mon Nov 14 18:45:14 2016
@@@@ -918,10 +918,6 @@@@ tls_get_cert( SSL *s )
 {
 	/* If peer cert was bad, treat as if no cert was given */
 	if (SSL_get_verify_result(s)) {
-		/* If we can send an alert, do so */
-		if (SSL_version(s) != SSL2_VERSION) {
-			ssl3_send_alert(s,SSL3_AL_WARNING,SSL3_AD_BAD_CERTIFICATE);
-		}
 		return NULL;
 	}
 	return SSL_get_peer_certificate(s);
@@@@ -981,7 +977,7 @@@@ ldap_pvt_tls_check_hostname( LDAP *ld, void *s, const 
 	X509 *x;
 	const char *name;
 	char *ptr;
-	int ntype = IS_DNS;
+	int ntype = IS_DNS, nlen;
 #ifdef LDAP_PF_INET6
 	struct in6_addr addr;
 #else
@@@@ -995,6 +991,7 @@@@ ldap_pvt_tls_check_hostname( LDAP *ld, void *s, const 
 	} else {
 		name = name_in;
 	}
+	nlen = strlen(name);
 
 	x = tls_get_cert((SSL *)s);
 	if (!x) {
@@@@ -1028,15 +1025,14 @@@@ ldap_pvt_tls_check_hostname( LDAP *ld, void *s, const 
 		ex = X509_get_ext(x, i);
 		alt = X509V3_EXT_d2i(ex);
 		if (alt) {
-			int n, len1 = 0, len2 = 0;
+			int n, len2 = 0;
 			char *domain = NULL;
 			GENERAL_NAME *gn;
 
 			if (ntype == IS_DNS) {
-				len1 = strlen(name);
 				domain = strchr(name, '.');
 				if (domain) {
-					len2 = len1 - (domain-name);
+					len2 = nlen - (domain-name);
 				}
 			}
 			n = sk_GENERAL_NAME_num(alt);
@@@@ -1054,7 +1050,7 @@@@ ldap_pvt_tls_check_hostname( LDAP *ld, void *s, const 
 					if (sl == 0) continue;
 
 					/* Is this an exact match? */
-					if ((len1 == sl) && !strncasecmp(name, sn, len1)) {
+					if ((nlen == sl) && !strncasecmp(name, sn, nlen)) {
 						break;
 					}
 
@@@@ -1094,13 +1090,28 @@@@ ldap_pvt_tls_check_hostname( LDAP *ld, void *s, const 
 
 	if (ret != LDAP_SUCCESS) {
 		X509_NAME *xn;
-		char buf[2048];
-		buf[0] = '\0';
+		X509_NAME_ENTRY *ne;
+		ASN1_OBJECT *obj;
+		ASN1_STRING *cn = NULL;
+		int navas;
 
+		/* find the last CN */
+		obj = OBJ_nid2obj( NID_commonName );
+		if ( !obj ) goto no_cn; /* should never happen */
+
 		xn = X509_get_subject_name(x);
-		if( X509_NAME_get_text_by_NID( xn, NID_commonName,
-			buf, sizeof(buf)) == -1)
+		navas = X509_NAME_entry_count( xn );
+		for ( i=navas-1; i>=0; i-- ) {
+			ne = X509_NAME_get_entry( xn, i );
+			if ( !OBJ_cmp( ne->object, obj )) {
+				cn = X509_NAME_ENTRY_get_data( ne );
+				break;
+			}
+		}
+		
+		if( !cn )
 		{
+no_cn:
 			Debug( LDAP_DEBUG_ANY,
 				"TLS: unable to get common name from peer certificate.\n",
 				0, 0, 0 );
@@@@ -1111,21 +1122,20 @@@@ ldap_pvt_tls_check_hostname( LDAP *ld, void *s, const 
 			ld->ld_error = LDAP_STRDUP(
 				_("TLS: unable to get CN from peer certificate"));
 
-		} else if (strcasecmp(name, buf) == 0 ) {
+		} else if ( cn->length == nlen &&
+			strncasecmp( name, (char *) cn->data, nlen ) == 0 ) {
 			ret = LDAP_SUCCESS;
 
-		} else if (( buf[0] == '*' ) && ( buf[1] == '.' )) {
+		} else if (( cn->data[0] == '*' ) && ( cn->data[1] == '.' )) {
 			char *domain = strchr(name, '.');
 			if( domain ) {
-				size_t dlen = 0;
-				size_t sl;
+				size_t dlen;
 
-				sl = strlen(name);
-				dlen = sl - (domain-name);
-				sl = strlen(buf);
+				dlen = nlen - (domain-name);
 
 				/* Is this a wildcard match? */
-				if ((dlen == sl-1) && !strncasecmp(domain, &buf[1], dlen)) {
+				if ((dlen == cn->length-1) &&
+					!strncasecmp(domain, (char *) &cn->data[1], dlen)) {
 					ret = LDAP_SUCCESS;
 				}
 			}
@@@@ -1133,8 +1143,8 @@@@ ldap_pvt_tls_check_hostname( LDAP *ld, void *s, const 
 
 		if( ret == LDAP_LOCAL_ERROR ) {
 			Debug( LDAP_DEBUG_ANY, "TLS: hostname (%s) does not match "
-				"common name in certificate (%s).\n", 
-				name, buf, 0 );
+				"common name in certificate (%.*s).\n",
+				name, cn->length, cn->data );
 			ret = LDAP_CONNECT_ERROR;
 			if ( ld->ld_error ) {
 				LDAP_FREE( ld->ld_error );
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
$OpenBSD$
d3 13
a15 2
+++ libraries/libldap/tls.c	Thu Dec  3 12:03:47 2009
@@@@ -981,7 +981,7 @@@@ ldap_pvt_tls_check_hostname( LDAP *ld, void *s, const 
d24 1
a24 1
@@@@ -995,6 +995,7 @@@@ ldap_pvt_tls_check_hostname( LDAP *ld, void *s, const 
d32 1
a32 1
@@@@ -1028,15 +1029,14 @@@@ ldap_pvt_tls_check_hostname( LDAP *ld, void *s, const 
d50 1
a50 1
@@@@ -1054,7 +1054,7 @@@@ ldap_pvt_tls_check_hostname( LDAP *ld, void *s, const 
d59 1
a59 1
@@@@ -1094,13 +1094,28 @@@@ ldap_pvt_tls_check_hostname( LDAP *ld, void *s, const 
d92 1
a92 1
@@@@ -1111,21 +1126,20 @@@@ ldap_pvt_tls_check_hostname( LDAP *ld, void *s, const 
d121 1
a121 1
@@@@ -1133,8 +1147,8 @@@@ ldap_pvt_tls_check_hostname( LDAP *ld, void *s, const 
@


1.1.1.1
log
@First step for the OpenLDAP upgrade: import the server side of OpenLDAP 2.3

ok landry@@, ajacoutot@@, jasper@@, stephan@@
@
text
@@
