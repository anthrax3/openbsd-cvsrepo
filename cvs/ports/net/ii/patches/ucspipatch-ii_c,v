head	1.2;
access;
symbols
	OPENBSD_6_0:1.1.0.2
	OPENBSD_6_0_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2016.09.02.15.08.50;	author gsoares;	state Exp;
branches;
next	1.1;
commitid	UGdGRXbS66QsGj42;

1.1
date	2016.06.06.11.02.05;	author gsoares;	state Exp;
branches;
next	;
commitid	eKvwyJNeFW3uy5c7;


desc
@@


1.2
log
@patch merged upstream
@
text
@$OpenBSD: ucspipatch-ii_c,v 1.1 2016/06/06 11:02:05 gsoares Exp $

Patch merged upstream
http://git.suckless.org/ii/commit/?id=f79e2f09534d92a6fe4e062b06449a925fef1c41

uses pledge():
  - stdio rpath wpath cpath dpath: ii(1) will create directory
    structure and fifos on demand (when joining a new channel for
    example).

--- ii.c.orig	Mon Jun  6 00:46:07 2016
+++ ii.c	Mon Jun  6 01:47:57 2016
@@@@ -386,7 +386,7 @@@@ static void handle_server_output() {
 }
 
 static void run() {
-	Channel *c;
+	Channel *c, *n;
 	int r, maxfd;
 	fd_set rd;
 	struct timeval tv;
@@@@ -423,9 +423,11 @@@@ static void run() {
 			handle_server_output();
 			last_response = time(NULL);
 		}
-		for(c = channels; c; c = c->next)
+		for(c = channels; c; c = n) {
+			n = c->next;
 			if(FD_ISSET(c->fd, &rd))
 				handle_channels_input(c);
+		}
 	}
 }
 
@@@@ -455,6 +457,14 @@@@ int main(int argc, char *argv[]) {
 			default: usage(); break;
 		}
 	}
+
+#ifdef __OpenBSD__
+	if (pledge("stdio rpath wpath cpath dpath", NULL) == -1) {
+		fputs("ii: pledge\n", stderr);
+		exit(EXIT_FAILURE);
+	}
+#endif
+
 	if(!snprintf(path, sizeof(path), "%s/%s", prefix, host)) {
 		fputs("ii: path to irc directory too long\n", stderr);
 		exit(EXIT_FAILURE);
@


1.1
log
@- Fix channel use after freeing in main loop
(spotted the hard way by Ray Lai)
patch from upstream git

- Add pledge(2) to ii(1)
    stdio rpath wpath cpath dpath: ii(1) will create directory
    structure and fifos on demand (when joining a new channel for
    example)
    inet net: required for tcpopen(), but pledge(2) is used after
    tcpopen() call. ucspi flavor doesn't need "inet dns" since
    that ucspi backend take care of network capabilities of ii(1).


diff from ray with tweaks from me and semarie.

OK semarie ray
@
text
@d1 1
a1 1
$OpenBSD$
d3 1
@

