head	1.1;
access;
symbols
	OPENBSD_5_2:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2013.03.04.18.54.56;	author jasper;	state dead;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2013.03.04.18.54.56;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.1
log
@file patch-lib_ext_wocky_wocky_wocky-caps-hash_c was initially added on branch OPENBSD_5_2.
@
text
@@


1.1.2.1
log
@SECURITY FIX for CVE-2013-1769: remotely-triggered NULL pointer dereference in telepathy-gabble
@
text
@a0 65
$OpenBSD$

From 3e17bf71aa47e7fe52c7053ec5cf44836cf5bd03 Mon Sep 17 00:00:00 2001
From: Will Thompson <will.thompson@@collabora.co.uk>
Date: Mon, 25 Feb 2013 09:35:13 +0000
Subject: caps_hash_compute_from_lists: skip anonymous fields

From 565f2ed54f53adc7bd6793a0e746ceb349843408 Mon Sep 17 00:00:00 2001
From: Will Thompson <will.thompson@@collabora.co.uk>
Date: Tue, 26 Feb 2013 10:18:37 +0000
Subject: caps_hash: don't crash if FORM_TYPE has no <value>

Fixes CVE-2013-1769: remotely-triggered NULL pointer dereference
  in telepathy-gabble
https://bugs.freedesktop.org/show_bug.cgi?id=61433

--- lib/ext/wocky/wocky/wocky-caps-hash.c.orig	Mon Mar  4 19:45:54 2013
+++ lib/ext/wocky/wocky/wocky-caps-hash.c	Mon Mar  4 19:46:31 2013
@@@@ -80,8 +80,17 @@@@ dataforms_cmp (gconstpointer a,
   else if (left_type != NULL && right_type == NULL)
     return 1;
   else /* left_type != NULL && right_type != NULL */
-    return strcmp (g_value_get_string (left_type->default_value),
-        g_value_get_string (right_type->default_value));
+    {
+      const gchar *left_value = NULL, *right_value = NULL;
+
+      if (left_type->raw_value_contents != NULL)
+        left_value = left_type->raw_value_contents[0];
+
+      if (right_type->raw_value_contents != NULL)
+        right_value = right_type->raw_value_contents[0];
+
+      return g_strcmp0 (left_value, right_value);
+    }
 }
 
 static GPtrArray *
@@@@ -190,15 +199,21 @@@@ wocky_caps_hash_compute_from_lists (
           continue;
         }
 
-      form_name = g_value_get_string (field->default_value);
-
       if (field->type != WOCKY_DATA_FORM_FIELD_TYPE_HIDDEN)
         {
-          DEBUG ("FORM_TYPE field of form '%s' is not hidden; "
-              "ignoring form and moving onto next one",
-                 form_name);
+          DEBUG ("FORM_TYPE field is not hidden; "
+              "ignoring form and moving onto next one");
           continue;
         }
+
+      if (field->raw_value_contents == NULL ||
+          g_strv_length (field->raw_value_contents) != 1)
+        {
+          DEBUG ("FORM_TYPE field does not have exactly one value; failing");
+          goto cleanup;
+        }
+
+      form_name = field->raw_value_contents[0];
 
       if (g_hash_table_lookup (form_names, form_name) != NULL)
         {
@

