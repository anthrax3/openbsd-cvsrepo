head	1.3;
access;
symbols
	OPENBSD_3_8:1.2.0.2
	OPENBSD_3_8_BASE:1.2
	OPENBSD_3_6:1.1.0.4
	OPENBSD_3_7:1.1.0.2;
locks; strict;
comment	@# @;


1.3
date	2005.11.05.19.09.38;	author bernd;	state dead;
branches;
next	1.2;

1.2
date	2005.06.13.20.33.17;	author naddy;	state Exp;
branches
	1.2.2.1;
next	1.1;

1.1
date	2005.05.26.03.34.21;	author robert;	state Exp;
branches
	1.1.2.1
	1.1.4.1;
next	;

1.1.2.1
date	2005.05.26.04.01.57;	author robert;	state Exp;
branches;
next	1.1.2.2;

1.1.2.2
date	2005.11.07.21.09.03;	author sturm;	state dead;
branches;
next	;

1.1.4.1
date	2005.05.26.04.03.09;	author robert;	state Exp;
branches;
next	;

1.2.2.1
date	2005.11.07.21.15.27;	author sturm;	state dead;
branches;
next	;


desc
@@


1.3
log
@Security update to net-snmp-5.1.3.

- fix potential race condition in fixproc script
- fix DOS vulnerability on tcp connections

help & ok sturm@@
@
text
@$OpenBSD: patch-local_fixproc,v 1.2 2005/06/13 20:33:17 naddy Exp $
--- local/fixproc.orig	Sat Apr 20 09:30:13 2002
+++ local/fixproc	Mon Jun 13 22:31:57 2005
@@@@ -129,6 +129,8 @@@@
 #
 # Timothy Kong		3/1995
 
+use File::Temp qw(tempfile);
+
 $database_file = '/local/etc/fixproc.conf';
 
 $debug = 0;			# specify debug level using -dN
@@@@ -191,20 +193,19 @@@@ for $proc ( @@proc_list )
 sub create_sh_script
 {
   local ($file) = pop (@@_);
+  local ($fh) = pop (@@_);
   local ($i) = pop (@@_);
 
   printf (stderr "create_sh_script\n") if ($debug > 0);
 
   $! = $fixproc_error;
-  open (file, ">"."$file") || die "$0: cannot open $file\n";
   while ( $shell_lines[$i] ne $shell_end_marker )
     {
-      printf (file "%s", $shell_lines[$i]);
+      printf ($fh "%s", $shell_lines[$i]);
       $i++;
     }
-  close (file);
-  system "chmod +x $file";
-  return file;
+  close ($fh);
+  chmod 0755, $file;
 }
 
 
@@@@ -230,14 +231,13 @@@@ sub do_fix
   else
     {
       # it must be "shell", so execute the shell script defined in database
+      local ($tmpfh, $tmpfile) = tempfile("fix_XXXXXXXX", DIR => "/tmp");
 
-      local ($tmpfile) = "/tmp/fix_$$";
+      &create_sh_script ($fix{$proc}, $tmpfh, $tmpfile);
 
-      &create_sh_script ($fix{$proc}, $tmpfile);
-
       	# return code is number divided by 256
       $error_code = (system "$tmpfile") / 256;
-      system "rm $tmpfile";
+      unlink($tmpfile);
       return ($fix_failed_error) if ($error_code != 0);
         # sleep needed here?
       return &do_exist ($proc);
@@@@ -262,13 +262,13 @@@@ sub do_check
       # if not "exist", then it must be "shell", so execute the shell script
       # defined in database
 
-      local ($tmpfile) = "/tmp/check_$$";
+      local ($tmpfh, $tmpfile) = tempfile("check_XXXXXXXX", DIR => "/tmp");
 
-      &create_sh_script ($check{$proc}, $tmpfile);
+      &create_sh_script ($fix{$proc}, $tmpfh, $tmpfile);
 
       	# return code is number divided by 256
       $error_code = (system "$tmpfile") / 256;
-      system "rm $tmpfile";
+      unlink($tmpfile);
       return ($check_failed_error) if ($error_code != 0);
 
       # check passed, continue
@


1.2
log
@sync patches
@
text
@d1 1
a1 1
$OpenBSD: patch-local_fixproc,v 1.1 2005/05/26 03:34:21 robert Exp $
@


1.2.2.1
log
@MFC:
Security update to net-snmp-5.1.3.

- fix potential race condition in fixproc script
- fix DOS vulnerability on tcp connections
@
text
@d1 1
a1 1
$OpenBSD: patch-local_fixproc,v 1.2 2005/06/13 20:33:17 naddy Exp $
@


1.1
log
@SECURITY:
fix an insecure temporary file creation in fixproc; bump PKGNAME
http://www.vuxml.org/openbsd/75ecb34c-cc7d-11d9-8e94-00065bd5b0b6.html

ok naddy@@
@
text
@d1 3
a3 3
$OpenBSD$
--- local/fixproc.orig	Wed May 25 19:21:01 2005
+++ local/fixproc	Wed May 25 19:24:51 2005
d13 1
a13 1
@@@@ -191,20 +193,19 @@@@
d38 1
a38 1
@@@@ -230,14 +231,13 @@@@
d56 1
a56 1
@@@@ -262,13 +262,13 @@@@
@


1.1.4.1
log
@SECURITY:
fix an insecure temporary file creation in fixproc; bump PKGNAME
http://www.vuxml.org/openbsd/75ecb34c-cc7d-11d9-8e94-00065bd5b0b6.html

ok brad@@
@
text
@@


1.1.2.1
log
@SECURITY:
fix an insecure temporary file creation in fixproc; bump PKGNAME
http://www.vuxml.org/openbsd/75ecb34c-cc7d-11d9-8e94-00065bd5b0b6.html

ok brad@@
@
text
@@


1.1.2.2
log
@MFC:
Security update to net-snmp-5.1.3.

- fix potential race condition in fixproc script
- fix DOS vulnerability on tcp connections
@
text
@d1 1
a1 1
$OpenBSD: patch-local_fixproc,v 1.1.2.1 2005/05/26 04:01:57 robert Exp $
@


