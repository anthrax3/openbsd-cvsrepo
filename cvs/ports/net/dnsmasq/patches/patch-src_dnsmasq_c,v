head	1.4;
access;
symbols
	OPENBSD_6_1:1.4.0.2;
locks; strict;
comment	@# @;


1.4
date	2017.04.16.10.40.07;	author sthen;	state Exp;
branches
	1.4.2.1;
next	1.3;
commitid	qGkEJiNOZfrUnUTu;

1.3
date	2012.06.08.14.26.22;	author ajacoutot;	state dead;
branches;
next	1.2;

1.2
date	2012.05.23.09.16.19;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2012.05.14.13.57.09;	author ajacoutot;	state Exp;
branches;
next	;

1.4.2.1
date	2017.04.16.10.41.10;	author sthen;	state Exp;
branches;
next	;
commitid	j1ZIFkwFmEVU8dyo;


desc
@@


1.4
log
@Disable use of IP_SENDSRCADDR in dnsmasq for now, for some
yet-to-be-determined reason it results in no reply being sent to the
client. Problem reported by Harald Dunkel. OK Brad.
@
text
@$OpenBSD$

Fails. Currently disabled pending investigation.

--- src/dnsmasq.c.orig	Wed May 18 15:51:54 2016
+++ src/dnsmasq.c	Sat Apr 15 22:47:55 2017
@@@@ -144,7 +144,7 @@@@ int main (int argc, char **argv)
       open("/dev/null", O_RDWR); 
 
 #ifndef HAVE_LINUX_NETWORK
-#  if !(defined(IP_RECVDSTADDR) && defined(IP_RECVIF) && defined(IP_SENDSRCADDR))
+#  if defined(__OpenBSD__) || !(defined(IP_RECVDSTADDR) && defined(IP_RECVIF) && defined(IP_SENDSRCADDR))
   if (!option_bool(OPT_NOWILD))
     {
       bind_fallback = 1;
@


1.4.2.1
log
@MFC: Disable use of IP_SENDSRCADDR in dnsmasq for now, for some
yet-to-be-determined reason it results in no reply being sent to the
client. Problem reported by Harald Dunkel. OK Brad.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_dnsmasq_c,v 1.4 2017/04/16 10:40:07 sthen Exp $
@


1.3
log
@Update to dnsmasq 2.62.

from Brad
@
text
@d1 1
a1 1
$OpenBSD: patch-src_dnsmasq_c,v 1.2 2012/05/23 09:16:19 ajacoutot Exp $
d3 1
a3 3
- code-size tweak.
- Fix non-response to router-solicitations when router-advertisement
  configured, but DHCPv6 not configured.
d5 4
a8 4
--- src/dnsmasq.c.orig	Sun Apr 29 11:01:28 2012
+++ src/dnsmasq.c	Mon May 21 13:57:13 2012
@@@@ -849,14 +849,11 @@@@ int main (int argc, char **argv)
 	}
d10 6
a15 33
 #ifdef HAVE_DHCP6
-      if (daemon->dhcp6)
-	{
-	  if (FD_ISSET(daemon->dhcp6fd, &rset))
-	    dhcp6_packet(now);
+      if (daemon->dhcp6 && FD_ISSET(daemon->dhcp6fd, &rset))
+	dhcp6_packet(now);
 
-	  if (daemon->ra_contexts && FD_ISSET(daemon->icmp6fd, &rset))
-	    icmp6_packet();
-	}
+      if (daemon->ra_contexts && FD_ISSET(daemon->icmp6fd, &rset))
+	icmp6_packet();
 #endif
 
 #  ifdef HAVE_SCRIPT
@@@@ -1209,13 +1206,9 @@@@ void clear_cache_and_reload(time_t now)
     }
 #ifdef HAVE_DHCP6
   else if (daemon->ra_contexts)
-    {
-      /* Not doing DHCP, so no lease system, manage 
-	 alarms for ra only */
-      time_t next_event = periodic_ra(now);
-      if (next_event != 0)
-	alarm((unsigned)difftime(next_event, now)); 
-    }
+    /* Not doing DHCP, so no lease system, manage 
+       alarms for ra only */
+    send_alarm(periodic_ra(now), now);
 #endif
 #endif
 }
@


1.2
log
@Several fixes from upstream:
- Fix non-response to router-solicitations when router-advertisement
  configured, but DHCPv6 not configured.
- Fix a bug which broke DHCPv6/RA with prefix lengths which are not
  divisible by 8.

from Brad
@
text
@d1 1
a1 1
$OpenBSD: patch-src_dnsmasq_c,v 1.1 2012/05/14 13:57:09 ajacoutot Exp $
@


1.1
log
@Several fixes from upstream:
- Fixed bug which caused missing periodic router advertisements with some configurations.
- Cope with router-solict packets which don't have a valid source address.

from Brad
@
text
@d1 1
a1 1
$OpenBSD$
d3 3
a5 1
code-size tweak.
d7 22
a28 3
--- src/dnsmasq.c.orig	Sun May 13 00:37:29 2012
+++ src/dnsmasq.c	Sun May 13 00:38:19 2012
@@@@ -1209,13 +1209,9 @@@@ void clear_cache_and_reload(time_t now)
@

