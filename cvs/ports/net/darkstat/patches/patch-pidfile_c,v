head	1.1;
access;
symbols
	OPENBSD_6_2:1.1.0.16
	OPENBSD_6_2_BASE:1.1
	OPENBSD_6_1:1.1.0.14
	OPENBSD_6_1_BASE:1.1
	OPENBSD_6_0:1.1.0.12
	OPENBSD_6_0_BASE:1.1
	OPENBSD_5_9:1.1.0.8
	OPENBSD_5_9_BASE:1.1
	OPENBSD_5_8:1.1.0.10
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.6
	OPENBSD_5_7_BASE:1.1
	OPENBSD_5_6:1.1.0.4
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.2
	OPENBSD_5_5_BASE:1.1;
locks; strict;
comment	@# @;


1.1
date	2014.02.07.08.56.53;	author brad;	state Exp;
branches;
next	;


desc
@@


1.1
log
@Update to darkstat 3.0.718.

- Contains additional time_t related fixes.
- The author removed an assertion in timer_stop() I had run into and even
  though monotonic time is used somehow time went backwards.
- Change the rc.d script to use localhost instead of 127.0.0.1 to have
  darkstat also bind to the v6 address.

ok sthen@@
@
text
@$OpenBSD$

Re-instate the chroot by default code.

--- pidfile.c.orig	Thu Feb  6 02:56:16 2014
+++ pidfile.c	Thu Feb  6 02:57:38 2014
@@@@ -29,9 +29,10 @@@@
 static int pidfd = -1;
 static const char *pidname = NULL;
 
-void pidfile_create(const char *chroot_dir,
-                    const char *filename,
-                    const char *privdrop_user) {
+void
+pidfile_create(const char *chroot_dir, const char *filename,
+   const char *privdrop_user)
+{
    struct passwd *pw;
 
    if (pidfd != -1)
@@@@ -47,11 +48,8 @@@@ void pidfile_create(const char *chroot_dir,
          err(1, "getpwnam(\"%s\") failed", privdrop_user);
    }
 
-   if (chroot_dir != NULL) {
-      if (chdir(chroot_dir) == -1) {
-         err(1, "chdir(\"%s\") failed", chroot_dir);
-      }
-   }
+   if (chdir(chroot_dir) == -1)
+      err(1, "chdir(\"%s\") failed", chroot_dir);
    pidname = filename;
    pidfd = open(filename, O_WRONLY | O_CREAT | O_TRUNC | O_EXCL, 0600);
    if (pidfd == -1)
@
