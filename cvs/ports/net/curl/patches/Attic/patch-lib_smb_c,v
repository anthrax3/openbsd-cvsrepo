head	1.1;
access;
symbols
	OPENBSD_5_7:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2015.06.20.19.52.54;	author naddy;	state dead;
branches
	1.1.2.1;
next	;
commitid	Qu3ZDQxnp3vYUrrb;

1.1.2.1
date	2015.06.20.19.52.54;	author naddy;	state Exp;
branches;
next	;
commitid	Qu3ZDQxnp3vYUrrb;


desc
@@


1.1
log
@file patch-lib_smb_c was initially added on branch OPENBSD_5_7.
@
text
@@


1.1.2.1
log
@Security fixes:
CVE-2015-3236: lingering HTTP credentials in connection re-use
CVE-2015-3237: SMB send off unrelated memory contents
@
text
@a0 26
$OpenBSD$

CVE-2015-3237: SMB send off unrelated memory contents
http://curl.haxx.se/docs/adv_20150617B.html

--- lib/smb.c.orig	Wed Jan  7 22:53:57 2015
+++ lib/smb.c	Sat Jun 20 21:16:06 2015
@@@@ -783,9 +783,15 @@@@ static CURLcode smb_request_state(struct connectdata *
     off = Curl_read16_le(((unsigned char *) msg) +
                          sizeof(struct smb_header) + 13);
     if(len > 0) {
-      result = Curl_client_write(conn, CLIENTWRITE_BODY,
-                                 (char *)msg + off + sizeof(unsigned int),
-                                 len);
+      struct smb_conn *smbc = &conn->proto.smbc;
+      if(off + sizeof(unsigned int) + len > smbc->got) {
+        failf(conn->data, "Invalid input packet");
+        result = CURLE_RECV_ERROR;
+      }
+      else
+        result = Curl_client_write(conn, CLIENTWRITE_BODY,
+                                   (char *)msg + off + sizeof(unsigned int),
+                                   len);
       if(result) {
         req->result = result;
         next_state = SMB_CLOSE;
@

