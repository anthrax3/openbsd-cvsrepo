head	1.4;
access;
symbols
	OPENBSD_6_2:1.4.0.20
	OPENBSD_6_2_BASE:1.4
	OPENBSD_6_1:1.4.0.18
	OPENBSD_6_1_BASE:1.4
	OPENBSD_6_0:1.4.0.16
	OPENBSD_6_0_BASE:1.4
	OPENBSD_5_9:1.4.0.12
	OPENBSD_5_9_BASE:1.4
	OPENBSD_5_8:1.4.0.14
	OPENBSD_5_8_BASE:1.4
	OPENBSD_5_7:1.4.0.10
	OPENBSD_5_7_BASE:1.4
	OPENBSD_5_6:1.4.0.8
	OPENBSD_5_6_BASE:1.4
	OPENBSD_5_5:1.4.0.6
	OPENBSD_5_5_BASE:1.4
	OPENBSD_5_4:1.4.0.4
	OPENBSD_5_4_BASE:1.4
	OPENBSD_5_3:1.4.0.2
	OPENBSD_5_3_BASE:1.4
	OPENBSD_5_2:1.3.0.22
	OPENBSD_5_2_BASE:1.3
	OPENBSD_5_1_BASE:1.3
	OPENBSD_5_1:1.3.0.20
	OPENBSD_5_0:1.3.0.18
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_9:1.3.0.16
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.3.0.14
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.3.0.12
	OPENBSD_4_7_BASE:1.3
	OPENBSD_4_6:1.3.0.10
	OPENBSD_4_6_BASE:1.3
	OPENBSD_4_5:1.3.0.8
	OPENBSD_4_5_BASE:1.3
	OPENBSD_4_4:1.3.0.6
	OPENBSD_4_4_BASE:1.3
	OPENBSD_4_3:1.3.0.4
	OPENBSD_4_3_BASE:1.3
	OPENBSD_4_2:1.3.0.2
	OPENBSD_4_2_BASE:1.3
	OPENBSD_4_1:1.1.0.30
	OPENBSD_4_1_BASE:1.1
	OPENBSD_4_0:1.1.0.28
	OPENBSD_4_0_BASE:1.1
	OPENBSD_3_9:1.1.0.26
	OPENBSD_3_9_BASE:1.1
	OPENBSD_3_8:1.1.0.24
	OPENBSD_3_8_BASE:1.1
	OPENBSD_3_7:1.1.0.22
	OPENBSD_3_7_BASE:1.1
	OPENBSD_3_6:1.1.0.20
	OPENBSD_3_6_BASE:1.1
	OPENBSD_3_5:1.1.0.18
	OPENBSD_3_5_BASE:1.1
	OPENBSD_3_4:1.1.0.16
	OPENBSD_3_4_BASE:1.1
	OPENBSD_3_3:1.1.0.14
	OPENBSD_3_3_BASE:1.1
	OPENBSD_3_2:1.1.0.12
	OPENBSD_3_2_BASE:1.1
	OPENBSD_3_1:1.1.0.10
	OPENBSD_3_1_BASE:1.1
	OPENBSD_3_0:1.1.0.8
	OPENBSD_3_0_BASE:1.1
	OPENBSD_2_9_TRACKING_SWITCH:1.1
	OPENBSD_2_9:1.1.0.6
	OPENBSD_2_9_BASE:1.1
	OPENBSD_2_8:1.1.0.4
	OPENBSD_2_8_BASE:1.1
	OPENBSD_2_7:1.1.0.2;
locks; strict;
comment	@# @;


1.4
date	2012.08.19.22.30.37;	author ajacoutot;	state Exp;
branches;
next	1.3;

1.3
date	2007.03.20.00.45.22;	author pvalchev;	state Exp;
branches;
next	1.2;

1.2
date	2007.03.20.00.35.52;	author pvalchev;	state Exp;
branches;
next	1.1;

1.1
date	2000.05.19.04.56.48;	author form;	state Exp;
branches;
next	;


desc
@@


1.4
log
@RCS id cleanup; also add OpenBSD RCS Id where missing...
@
text
@$OpenBSD: patch-ftp-pl,v 1.3 2007/03/20 00:45:22 pvalchev Exp $
--- ftp.pl.orig	Mon Mar 19 18:42:57 2007
+++ ftp.pl	Mon Mar 19 18:43:02 2007
@@@@ -162,6 +162,8 @@@@ $max_get_size = -1;
 # Where I am connected to.
 $connect_site = '';
 
+$try_epsv = 1;
+
 # &ftp'debug( debugging_level )
 # Turn on debugging ranging from 1 = some to 10 = everything
 sub ftp'debug
@@@@ -233,7 +235,7 @@@@ sub timed_open
 			}
 			else {
 				print $showfd "proxy connection failed " if $proxy;
-				print $showfd "Cannot open ftp to $connect_site\n" if $ftp_show;
+				print $showfd "Cannot open ftp to $newhost:$newport\n" if $ftp_show;
 				return 0;
 			}
 		}
@@@@ -270,6 +272,14 @@@@ sub ftp'set_signals
 	$SIG{ 'PIPE' } = "ftp'ftp__sighandler";
 }
 
+# Setup a signal handler for user interrupts.
+sub ftp'set_user_signals
+{
+ 	$ftp_logger = @@_;
+ 	$SIG{ 'INT' } = "ftp'ftp__sighandler";
+}
+ 
+
 # &ftp'set_namemap( function to map outgoing name,  function to map incoming )
 sub ftp'set_namemap
 {
@@@@ -465,48 +475,96 @@@@ sub pasv
 		return undef;
 	}
 
-	&send( "PASV" );
-	$ret = &expect( $timeout,
-		150, 0, # reading directory
-		227, 1, # entering passive mode
-		125, 1, # data connection already open? transfer starting
-			   
-		4, 0, # file unavailable
-
-		5, 0, # error
+	if ($try_epsv) {
+		&send( "EPSV" );
+		$ret = &expect( $timeout,
+			150, 98, # reading directory
+			229, 1, # entering passive mode
+			125, 98, # data connection already open? transfer starting
+				   
+			4, 98, # file unavailable
 	
-	        421, 99 ); # service unavailable, closing connection
-	if( $ret == 99 ){
-		&service_closed();
-		$ret = 0;
-	}
-
-	if( ! $ret ){
-		&close_data_socket;
-		return 0;
-	}
-	if( $ret == 1 ) {
-		if( $response =~ m/^227 Entering Passive Mode \((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/ ){
-			$newhost = sprintf( "%d.%d.%d.%d", $1, $2, $3, $4 );
-			$newport = $5 * 256 + $6;
+			5, 98, # error
+	
+		        421, 99 ); # service unavailable, closing connection
+		if( $ret == 98 ){
+			$try_epsv = 0;
 		}
-		else {
-			print $showfd "Cannot parse passive response\n" if $ftp_show;
+		if( $ret == 99 ){
+			&service_closed();
+			$ret = 0;
+		}
+		if( ! $ret ){
+			&close_data_socket;
 			return 0;
 		}
-	}
+		if( $ret == 1 ) {
+			if($response =~ m/^229 .*\(\|\|\|(\d+)\|\)/){
+				$newport = $1;
+			}
+			else {
+				print $showfd "Cannot parse epsv response\n" if $ftp_show;
+				return 0;
+			}
+		}
 
-	# now need to connect() the new socket
-	if( ! &chat'open_newport( $newhost, $newport, *S2 ) ){
-		if( $retry_call ){
-			print $showfd "Failed to connect newport\n" if $ftp_show;
-			next;
+		# now need to connect() the new socket
+		if( ! &chat'open_newport( $connect_site, $newport, *S2 ) ){
+			if( $retry_call ){
+				print $showfd "Failed to connect to epsv newport $newport\n" if $ftp_show;
+				next;
+			}
+			else {
+				print $showfd "proxy connection failed " if $proxy;
+				print $showfd "Cannot open epsv ftp to $connect_site\n" if $ftp_show;
+				return 0;
+			}
 		}
-		else {
-			print $showfd "proxy connection failed " if $proxy;
-			print $showfd "Cannot open pasv ftp to $connect_site\n" if $ftp_show;
+	}
+	if (!$try_epsv) {
+		&send( "PASV" );
+		$ret = &expect( $timeout,
+			150, 0, # reading directory
+			227, 1, # entering passive mode
+			125, 1, # data connection already open? transfer starting
+				   
+			4, 0, # file unavailable
+	
+			5, 0, # error
+	
+		        421, 99 ); # service unavailable, closing connection
+		if( $ret == 99 ){
+			&service_closed();
+			$ret = 0;
+		}
+
+		if( ! $ret ){
+			&close_data_socket;
 			return 0;
 		}
+		if( $ret == 1 ) {
+			if($response =~ m/^227 .*\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/){
+				$newhost = sprintf( "%d.%d.%d.%d", $1, $2, $3, $4 );
+				$newport = $5 * 256 + $6;
+			}
+			else {
+				print $showfd "Cannot parse passive response\n" if $ftp_show;
+				return 0;
+			}
+		}
+
+		# now need to connect() the new socket
+		if( ! &chat'open_newport( $newhost, $newport, *S2 ) ){
+			if( $retry_call ){
+				print $showfd "Failed to connect newport\n" if $ftp_show;
+				next;
+			}
+			else {
+				print $showfd "proxy connection failed " if $proxy;
+				print $showfd "Cannot open pasv ftp to $connect_site\n" if $ftp_show;
+				return 0;
+			}
+		}
 	}
 }
 
@@@@ -581,6 +639,9 @@@@ sub ftp'dir_close
 		return 0;
 	}
 
+ 	# shut down our end of the socket
+ 	&close_data_socket;
+
 	# read the close
 	#
 	$ret = &expect($timeout,
@@@@ -590,8 +651,6 @@@@ sub ftp'dir_close
 		$ret = 0;
 	}
 
-	# shut down our end of the socket
-	&close_data_socket;
 
 	if( ! $ret ){
 		return 0;
@@@@ -708,6 +767,7 @@@@ sub ftp'get
 	if( ! $service_open ){
 		return 0;
 	}
+	chmod 0600, $loc_fname;
 
 	if( $loc_fname eq "" ){
 		$loc_fname = $rem_fname;
@


1.3
log
@hack ftp.pl to support ESVP much like our ftp(1); from beck
@
text
@d1 1
a1 3
# $NetBSD: patch-ae,v 1.6 2000/04/20 03:22:50 kim Exp $
# $OpenBSD: patch-ftp-pl,v 1.2 2007/03/20 00:35:52 pvalchev Exp $

@


1.2
log
@regenerate patches
@
text
@d2 1
a2 1
# $OpenBSD: patch-ftp-pl,v 1.1 2000/05/19 04:56:48 form Exp $
d4 12
a15 3
--- ftp.pl.orig	Fri Jun  5 03:10:27 1998
+++ ftp.pl	Mon Mar 19 18:31:12 2007
@@@@ -233,7 +233,7 @@@@ sub timed_open
d24 1
a24 1
@@@@ -270,6 +270,14 @@@@ sub ftp'set_signals
d39 2
a40 2
@@@@ -486,7 +494,7 @@@@ sub pasv
 		return 0;
d42 30
a71 1
 	if( $ret == 1 ) {
d73 45
a117 3
+		if($response =~ m/^227 .*\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/){
 			$newhost = sprintf( "%d.%d.%d.%d", $1, $2, $3, $4 );
 			$newport = $5 * 256 + $6;
d119 52
a170 1
@@@@ -581,6 +589,9 @@@@ sub ftp'dir_close
d180 1
a180 1
@@@@ -590,8 +601,6 @@@@ sub ftp'dir_close
d189 1
a189 1
@@@@ -708,6 +717,7 @@@@ sub ftp'get
@


1.1
log
@/usr/local -> PREFIX
fix network functions
remove scripts/configure
@
text
@d2 1
a2 1
# $OpenBSD$
d4 3
a6 3
--- ftp.pl.orig	Fri Jun  5 05:10:27 1998
+++ ftp.pl	Wed Apr 19 23:14:00 2000
@@@@ -233,7 +233,7 @@@@
d15 1
a15 1
@@@@ -270,6 +270,14 @@@@
d30 1
a30 1
@@@@ -486,7 +494,7 @@@@
d39 1
a39 1
@@@@ -581,6 +589,9 @@@@
d49 1
a49 1
@@@@ -590,8 +601,6 @@@@
d58 1
a58 1
@@@@ -708,6 +717,7 @@@@
@

