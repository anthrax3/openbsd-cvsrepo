head	1.5;
access;
symbols
	OPENBSD_6_2:1.5.0.18
	OPENBSD_6_2_BASE:1.5
	OPENBSD_6_1:1.5.0.16
	OPENBSD_6_1_BASE:1.5
	OPENBSD_6_0:1.5.0.14
	OPENBSD_6_0_BASE:1.5
	OPENBSD_5_9:1.5.0.10
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.5.0.12
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.5.0.8
	OPENBSD_5_7_BASE:1.5
	OPENBSD_5_6:1.5.0.6
	OPENBSD_5_6_BASE:1.5
	OPENBSD_5_5:1.5.0.4
	OPENBSD_5_5_BASE:1.5
	OPENBSD_5_4:1.5.0.2
	OPENBSD_5_4_BASE:1.5
	OPENBSD_5_3:1.2.0.12
	OPENBSD_5_3_BASE:1.2
	OPENBSD_5_2:1.2.0.10
	OPENBSD_5_2_BASE:1.2
	OPENBSD_5_1_BASE:1.2
	OPENBSD_5_1:1.2.0.8
	OPENBSD_5_0:1.2.0.6
	OPENBSD_5_0_BASE:1.2
	OPENBSD_4_9:1.2.0.4
	OPENBSD_4_9_BASE:1.2
	OPENBSD_4_8:1.2.0.2
	OPENBSD_4_8_BASE:1.2
	OPENBSD_4_7:1.1.0.2
	OPENBSD_4_7_BASE:1.1;
locks; strict;
comment	@# @;


1.5
date	2013.05.03.12.17.08;	author sthen;	state Exp;
branches;
next	1.4;

1.4
date	2013.05.03.11.38.32;	author sthen;	state Exp;
branches;
next	1.3;

1.3
date	2013.04.16.08.51.21;	author sthen;	state Exp;
branches;
next	1.2;

1.2
date	2010.03.20.23.05.17;	author sthen;	state Exp;
branches;
next	1.1;

1.1
date	2010.02.26.23.00.56;	author sthen;	state Exp;
branches;
next	;


desc
@@


1.5
log
@switch p5-SNMP_Session to Socket (from base Perl) for v6, tested against
snmpd (which, as an aside, could benefit from supporting multiple "listen on"
so that it could be made to listen to both v4+v6 at the same time..).
@
text
@$OpenBSD: patch-lib_SNMP_Session_pm,v 1.4 2013/05/03 11:38:32 sthen Exp $
--- lib/SNMP_Session.pm.orig	Fri Nov 21 05:25:17 2008
+++ lib/SNMP_Session.pm	Fri May  3 13:11:57 2013
@@@@ -144,9 +144,8 @@@@ BEGIN {
     $SNMP_Session::ipv6available = 0;
     $dont_wait_flags = 0;
 
-    if (eval {local $SIG{__DIE__};require Socket6;} &&
-       eval {local $SIG{__DIE__};require IO::Socket::INET6; IO::Socket::INET6->VERSION("1.26");}) {
-	import Socket6;
+    if (eval {local $SIG{__DIE__};require IO::Socket::INET6; IO::Socket::INET6->VERSION("1.26");}) {
+	Socket->import(qw(getaddrinfo inet_pton inet_ntop));
 	$ipv6_addr_len = length(pack_sockaddr_in6(161, inet_pton(AF_INET6(), "::1")));
 	$SNMP_Session::ipv6available = 1;
     }
@@@@ -605,7 +604,7 @@@@ use Carp;
 BEGIN {
     if($SNMP_Session::ipv6available) {
 	import IO::Socket::INET6;
-	import Socket6;
+	Socket->import(qw(getaddrinfo inet_pton inet_ntop));
     }
 }
 
@@@@ -659,13 +658,13 @@@@ sub open {
 	    $remote_hostname = $1;
 	}
 
-	my (@@res, $socktype_tmp, $proto_tmp, $canonname_tmp);
-	@@res = getaddrinfo($remote_hostname, $port, AF_UNSPEC, SOCK_DGRAM);
-	($sockfamily, $socktype_tmp, $proto_tmp, $remote_addr, $canonname_tmp) = @@res;
-	if (scalar(@@res) < 5) {
-	    return $this->error_return ("can't resolve \"$remote_hostname\" to IPv6 address");
-	}
-
+	my ($err, @@res) = getaddrinfo($remote_hostname, $port, {socktype => SOCK_DGRAM});
+	return $this->error_return ("can't resolve \"$remote_hostname\" to IPv6 address - $err") if ($err);
+	# XXX only looks at first address returned
+	# XXX this should actually cycle through them
+	my $ai = shift @@res;
+	$sockfamily = $ai->{family};
+	$remote_addr = $ai->{addr};
 	if ($SNMP_Session::recycle_socket && exists $the_socket{$sockfamily}) {
 	    $socket = $the_socket{$sockfamily};
 	} elsif ($sockfamily == AF_INET) {
@


1.4
log
@Unbreak v6 on p5-SNMP_Session by importing inet_ntop as well.
Import inet_ntop and inet_pton from Session.
getaddrinfo remains imported from p5-Session6 as the API is different.
@
text
@d1 1
a1 1
$OpenBSD: patch-lib_SNMP_Session_pm,v 1.3 2013/04/16 08:51:21 sthen Exp $
d3 4
a6 2
+++ lib/SNMP_Session.pm	Fri May  3 12:18:55 2013
@@@@ -146,7 +146,8 @@@@ BEGIN {
d8 2
a9 2
     if (eval {local $SIG{__DIE__};require Socket6;} &&
        eval {local $SIG{__DIE__};require IO::Socket::INET6; IO::Socket::INET6->VERSION("1.26");}) {
d11 2
a12 2
+	Socket6->import(qw(getaddrinfo));
+	Socket->import(qw(inet_pton inet_ntop));
d16 1
a16 1
@@@@ -605,7 +606,8 @@@@ use Carp;
d21 1
a21 2
+	Socket6->import(qw(getaddrinfo));
+	Socket->import(qw(inet_pton inet_ntop));
d25 21
@


1.3
log
@Newer perl has pack_sockaddr_in6; avoid importing it here to avoid warnings.
Problem reported by brad@@
@
text
@d1 1
a1 1
$OpenBSD: patch-lib_SNMP_Session_pm,v 1.2 2010/03/20 23:05:17 sthen Exp $
d3 2
a4 2
+++ lib/SNMP_Session.pm	Tue Mar 16 16:14:22 2010
@@@@ -146,7 +146,7 @@@@ BEGIN {
d9 2
a10 1
+	Socket6->import(qw(inet_pton getaddrinfo));
d14 1
a14 1
@@@@ -605,7 +605,7 @@@@ use Carp;
d19 2
a20 1
+	Socket6->import(qw(inet_pton getaddrinfo));
@


1.2
log
@fix a problem introduced by the last commit which inadvertently broke
some hostname lookups.
@
text
@d1 1
a1 1
$OpenBSD$
d9 1
a9 1
+	Socket6->import(qw(pack_sockaddr_in6 inet_pton getaddrinfo));
d18 1
a18 1
+	Socket6->import(qw(pack_sockaddr_in6 inet_pton getaddrinfo));
@


1.1
log
@Don't pull in conflicting functions (which do seem to work, but cause
a lot of warning spam on the console e.g. with mrtg).

Fedora diff identified by giovanni@@ as fixing the problem, further
research and diff from okan@@.

ok jasper@@
(reminder, ports is not fully open, do not commit without specific permission)
@
text
@d2 2
a3 2
--- lib/SNMP_Session.pm.orig	Fri Jan  8 23:23:52 2010
+++ lib/SNMP_Session.pm	Fri Jan  8 23:24:48 2010
d9 1
a9 1
+	Socket6->import(qw(pack_sockaddr_in6 inet_pton));
d18 1
a18 1
+	Socket6->import(qw(pack_sockaddr_in6 inet_pton));
@

