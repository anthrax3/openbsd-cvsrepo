head	1.1;
access;
symbols
	OPENBSD_4_6:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2010.04.08.03.16.48;	author william;	state dead;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2010.04.08.03.16.48;	author william;	state Exp;
branches;
next	;


desc
@@


1.1
log
@file patch-Client_cpp was initially added on branch OPENBSD_4_6.
@
text
@@


1.1.2.1
log
@SECURITY FIX

Resolves CVE-2009-2658

ok jasper@@
@
text
@a0 26
$OpenBSD$

SECURITY FIX

Resolves CVE-2009-2658


--- Client.cpp.orig	Wed May 20 05:30:19 2009
+++ Client.cpp	Tue Dec 29 18:50:33 2009
@@@@ -421,9 +421,14 @@@@ void CClient::ReadLine(const CString& sData) {
 								return;
 							}
 
-							CString sLocalFile = sPath + "/" + sFile;
+							CString sAbsolutePath = CDir::CheckPathPrefix(sPath, sFile);
 
-							m_pUser->GetFile(GetNick(), CUtils::GetIP(uLongIP), uPort, sLocalFile, uFileSize);
+							if (sAbsolutePath.empty()) {
+								PutStatus("Illegal path.");
+								return;
+							}
+
+							m_pUser->GetFile(GetNick(), CUtils::GetIP(uLongIP), uPort, sAbsolutePath, uFileSize);
 						} else {
 							MODULECALL(OnDCCUserSend(CString(m_pUser->GetStatusPrefix() + sTarget), uLongIP, uPort, sFile, uFileSize), m_pUser, this, return);
 						}
@

