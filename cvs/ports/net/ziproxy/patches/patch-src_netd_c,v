head	1.2;
access;
symbols
	OPENBSD_6_1:1.2.0.18
	OPENBSD_6_1_BASE:1.2
	OPENBSD_6_0:1.2.0.16
	OPENBSD_6_0_BASE:1.2
	OPENBSD_5_9:1.2.0.12
	OPENBSD_5_9_BASE:1.2
	OPENBSD_5_8:1.2.0.14
	OPENBSD_5_8_BASE:1.2
	OPENBSD_5_7:1.2.0.10
	OPENBSD_5_7_BASE:1.2
	OPENBSD_5_6:1.2.0.8
	OPENBSD_5_6_BASE:1.2
	OPENBSD_5_5:1.2.0.6
	OPENBSD_5_5_BASE:1.2
	OPENBSD_5_4:1.2.0.4
	OPENBSD_5_4_BASE:1.2
	OPENBSD_5_3:1.2.0.2
	OPENBSD_5_3_BASE:1.2
	OPENBSD_5_2:1.1.1.1.0.12
	OPENBSD_5_2_BASE:1.1.1.1
	OPENBSD_5_1_BASE:1.1.1.1
	OPENBSD_5_1:1.1.1.1.0.10
	OPENBSD_5_0:1.1.1.1.0.8
	OPENBSD_5_0_BASE:1.1.1.1
	OPENBSD_4_9:1.1.1.1.0.6
	OPENBSD_4_9_BASE:1.1.1.1
	OPENBSD_4_8:1.1.1.1.0.4
	OPENBSD_4_8_BASE:1.1.1.1
	OPENBSD_4_7:1.1.1.1.0.2
	OPENBSD_4_7_BASE:1.1.1.1
	edd_20091027:1.1.1.1
	edd:1.1.1;
locks; strict;
comment	@# @;


1.2
date	2012.09.27.13.17.12;	author gonzalo;	state Exp;
branches;
next	1.1;

1.1
date	2009.10.27.16.46.10;	author edd;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2009.10.27.16.46.10;	author edd;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Update for Ziproxy to 3.2.1:

* Changed HTTP authentication code to a modular one.
* Added SASL support for HTTP authentication.
* Fixed compilation issues with libpng 1.5.x.

And other, while here GROFF is not needed, change
configure style, add rc.d(8) script, and edd@@ drop
maintership, I take care of this now.

Tested on amd64 and i386.

Ok edd@@
@
text
@$OpenBSD: patch-src_netd_c,v 1.1.1.1 2009/10/27 16:46:10 edd Exp $
--- src/netd.c.orig	Wed Feb  8 10:02:15 2012
+++ src/netd.c	Fri Sep  7 10:00:52 2012
@@@@ -77,7 +77,10 @@@@
 #include <sys/wait.h>
 #include <time.h>
 #include <assert.h>
+#include <pwd.h>
 
+#define ZIPROXY_USER "_ziproxy"
+
 #include "cfgfile.h"
 #include "log.h"
 #include "ziproxy.h"
@@@@ -221,6 +224,27 @@@@ int main(int argc, char **argv, char *env[])
 	i = ReadCfgFile(cfg_file);
 	if (i != 0)
 		return (5);
+
+	if (geteuid() == 0) {
+		/* We are root; drop privileges */
+		struct passwd *pw;
+
+		if ((pw = getpwnam(ZIPROXY_USER)) == NULL) {
+			fprintf(stderr, "No user %s.\n", ZIPROXY_USER);
+			exit(1);
+		}
+
+		if (setgroups(1, &pw->pw_gid) ||
+				setegid(pw->pw_gid) ||
+				setgid(pw->pw_gid) ||
+				seteuid(pw->pw_uid) ||
+				setuid(pw->pw_uid)) {
+			fprintf(stderr, "can not drop privileges to '%s'\n",
+					ZIPROXY_USER);
+			exit(1);
+		}
+		endpwent();
+	}
 
 	/* is that a 'stop daemon' request? */
 	if (command_options.stop_daemon != 0) {
@


1.1
log
@Initial revision
@
text
@d1 4
a4 4
$OpenBSD$
--- src/netd.c.orig	Mon Sep 28 16:07:39 2009
+++ src/netd.c	Thu Oct 15 23:58:01 2009
@@@@ -37,7 +37,10 @@@@
d12 7
a18 7
 typedef int SOCKET;
 typedef unsigned int UINT;
 
@@@@ -132,6 +135,27 @@@@ int main(int argc, char **argv, char *env[])
 	struct tm *btime;
 	time_t cas;
 	int pipedes[2],logdes, i;
d33 1
a33 1
+			       	setuid(pw->pw_uid)) {
a39 2
 	
 	command_options.addr_low.s_addr=0;
d41 2
@


1.1.1.1
log
@import ziproxy

Ziproxy is forwarding, non-caching, compressing HTTP proxy server.
Basically it squeezes images by converting them to lower quality JPEGs
or JPEG 2000 and compresses (gzip) HTML and other text-like data.  It
also provides other features such as: HTML/JS/CSS optimization,
preemptive hostname resolution, transparent proxying and more.

OK sthen@@

@
text
@@
