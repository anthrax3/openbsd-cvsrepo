head	1.4;
access;
symbols
	OPENBSD_6_2:1.4.0.20
	OPENBSD_6_2_BASE:1.4
	OPENBSD_6_1:1.4.0.18
	OPENBSD_6_1_BASE:1.4
	OPENBSD_6_0:1.4.0.16
	OPENBSD_6_0_BASE:1.4
	OPENBSD_5_9:1.4.0.12
	OPENBSD_5_9_BASE:1.4
	OPENBSD_5_8:1.4.0.14
	OPENBSD_5_8_BASE:1.4
	OPENBSD_5_7:1.4.0.10
	OPENBSD_5_7_BASE:1.4
	OPENBSD_5_6:1.4.0.8
	OPENBSD_5_6_BASE:1.4
	OPENBSD_5_5:1.4.0.6
	OPENBSD_5_5_BASE:1.4
	OPENBSD_5_4:1.4.0.4
	OPENBSD_5_4_BASE:1.4
	OPENBSD_5_3:1.4.0.2
	OPENBSD_5_3_BASE:1.4
	OPENBSD_5_2:1.3.0.12
	OPENBSD_5_2_BASE:1.3
	OPENBSD_5_1_BASE:1.3
	OPENBSD_5_1:1.3.0.10
	OPENBSD_5_0:1.3.0.8
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_9:1.3.0.6
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.3.0.4
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.3.0.2
	OPENBSD_4_7_BASE:1.3
	OPENBSD_4_6:1.2.0.10
	OPENBSD_4_6_BASE:1.2
	OPENBSD_4_5:1.2.0.8
	OPENBSD_4_5_BASE:1.2
	OPENBSD_4_4:1.2.0.6
	OPENBSD_4_4_BASE:1.2
	OPENBSD_4_3:1.2.0.4
	OPENBSD_4_3_BASE:1.2
	OPENBSD_4_2:1.2.0.2
	OPENBSD_4_2_BASE:1.2
	OPENBSD_4_1:1.1.0.20
	OPENBSD_4_1_BASE:1.1
	OPENBSD_4_0:1.1.0.18
	OPENBSD_4_0_BASE:1.1
	OPENBSD_3_9:1.1.0.16
	OPENBSD_3_9_BASE:1.1
	OPENBSD_3_8:1.1.0.14
	OPENBSD_3_8_BASE:1.1
	OPENBSD_3_7:1.1.0.12
	OPENBSD_3_7_BASE:1.1
	OPENBSD_3_6:1.1.0.10
	OPENBSD_3_6_BASE:1.1
	OPENBSD_3_5:1.1.0.8
	OPENBSD_3_5_BASE:1.1
	OPENBSD_3_4:1.1.0.6
	OPENBSD_3_4_BASE:1.1
	OPENBSD_3_3:1.1.0.4
	OPENBSD_3_3_BASE:1.1
	OPENBSD_3_2:1.1.0.2
	OPENBSD_3_2_BASE:1.1;
locks; strict;
comment	@# @;


1.4
date	2012.08.06.17.35.34;	author naddy;	state Exp;
branches;
next	1.3;

1.3
date	2010.02.23.21.35.37;	author sthen;	state Exp;
branches;
next	1.2;

1.2
date	2007.05.12.21.36.28;	author rui;	state Exp;
branches;
next	1.1;

1.1
date	2002.09.17.09.06.23;	author pvalchev;	state Exp;
branches;
next	;


desc
@@


1.4
log
@fix prototypes; no need for groff
@
text
@$OpenBSD: patch-bing_c,v 1.3 2010/02/23 21:35:37 sthen Exp $
--- bing.c.orig	Fri Jan 19 19:28:53 2001
+++ bing.c	Mon Aug  6 19:33:05 2012
@@@@ -170,6 +170,7 @@@@ static char rcsid[] = "$Id: bing.c,v 1.16.2.1 2001/01/
 #include <netdb.h>
 #include <unistd.h>
 #include <stdio.h>
+#include <stdlib.h>
 #include <ctype.h>
 #include <errno.h>
 #include <string.h>
@@@@ -755,7 +756,7 @@@@ int pr_pack(buf, cc, from)
 	static int old_rrlen;
 	static char old_rr[MAX_IPOPTLEN];
 	struct ip *ip;
-	struct timeval tv, *tp;
+	struct timeval tv, tv2, *tp;
 	double triptime;
 	int hlen, dupflag;
 
@@@@ -798,9 +799,12 @@@@ int pr_pack(buf, cc, from)
 	cc -= hlen;
 	icp = (struct icmp *)(buf + hlen);
 	if (icp->icmp_type == ICMP_ECHOREPLY) {
+		char *tmp;
 		if (icp->icmp_id != ident)
 			return -1;			/* 'Twas not our ECHO */
-		tp = (struct timeval *)ICMP_TO_DATA(icp);
+		tmp = (char *)ICMP_TO_DATA(icp);
+		memcpy(&tv2, tmp, sizeof(tv2));
+		tp = &tv2;
 		tvsub(&tv, tp);
 		triptime = tv_usval(&tv);
 
@@@@ -1231,17 +1235,30 @@@@ int main(argc, argv)
 	struct hoststats *hs1, *hs2;
 	int ntrans, nloops, bits;
 	int i;
-	int ch, hold, recv_packlen, preload;
+	int ch, hold = 1, recv_packlen, preload;
 	u_char *datap, *recv_packet;
-	char *target1, *target2, *malloc();
+	char *target1, *target2;
 	u_char ttl, loop;
 #ifdef IP_OPTIONS
 	char rspace[3 + 4 * NROUTES + 1];	/* record route space */
 #endif
-
 	hs1 = &hoststats1;
 	hs2 = &hoststats2;
 
+        if (!(proto = getprotobyname("icmp"))) {
+                (void)fprintf(stderr, "bing: unknown protocol icmp.\n");
+                exit(1);
+        }
+        if ((s = socket(AF_INET, SOCK_RAW, proto->p_proto)) < 0) {
+                perror("bing: socket");
+                exit(1);
+        }
+        /* Revoke privileges */
+       if (seteuid(getuid()) == -1 || setuid(getuid()) == -1) {
+               err(1, "unable to drop permissions");
+               exit(1);
+       }
+
 	preload = 0;
 	datap = &outpack[8 + sizeof(struct timeval)];
 	while ((ch = getopt(argc, argv, "I:LRc:dDe:fh:i:l:nPp:rS:s:t:vVwz")) != EOF)
@@@@ -1398,15 +1415,6 @@@@ int main(argc, argv)
 
 	ident = getpid() & 0xFFFF;
 
-	if (!(proto = getprotobyname("icmp"))) {
-		(void)fprintf(stderr, "bing: unknown protocol icmp.\n");
-		exit(1);
-	}
-	if ((s = socket(AF_INET, SOCK_RAW, proto->p_proto)) < 0) {
-		perror("bing: socket");
-		exit(1);
-	}
-	hold = 1;
 	if (options & F_SO_DEBUG)
 		(void)setsockopt(s, SOL_SOCKET, SO_DEBUG, (char *)&hold,
 		    sizeof(hold));
@


1.3
log
@Fix an LP64 segfault and flesh out PLIST. Original diff from
Aaron Stellman, revised by Daniel Dickman and myself.

ok jasper@@

ports is unlocked for a while only for those who have been informed.
IF JASPER DID NOT MAIL YOU, DO NOT COMMIT!
@
text
@d1 11
a11 11
$OpenBSD: patch-bing_c,v 1.2 2007/05/12 21:36:28 rui Exp $
--- bing.c.orig	Fri Jan 19 13:28:53 2001
+++ bing.c	Thu Feb 18 12:35:25 2010
@@@@ -162,6 +162,7 @@@@ static char rcsid[] = "$Id: bing.c,v 1.16.2.1 2001/01/
 
 #include <netinet/in_systm.h>
 #include <netinet/in.h>
+#include <arpa/inet.h>
 #include <netinet/ip.h>
 #include <netinet/ip_icmp.h>
 #ifndef linux
d42 2
a43 1
 	char *target1, *target2, *malloc();
@


1.2
log
@update bing to 1.0.5
- fixes a memory alignment on sparc64 (from pedro@@)
- ok steven@@
@
text
@d1 12
a12 4
$OpenBSD$
--- bing.c.orig	Fri Jan 19 18:28:53 2001
+++ bing.c	Sat May 12 14:52:52 2007
@@@@ -755,7 +755,7 @@@@ int pr_pack(buf, cc, from)
d21 1
a21 1
@@@@ -798,9 +798,12 @@@@ int pr_pack(buf, cc, from)
d35 1
a35 1
@@@@ -1231,17 +1234,30 @@@@ int main(argc, argv)
d68 1
a68 1
@@@@ -1398,15 +1414,6 @@@@ int main(argc, argv)
@


1.1
log
@This is installed setuid root because it uses SOCK_RAW, so open socket
as early as possible and revoke privileges immediately after
bump PKGNAME to reflect change
@
text
@d2 26
a27 3
--- bing.c.orig	Thu Jul 20 17:45:32 1995
+++ bing.c	Tue Sep 17 02:56:49 2002
@@@@ -1228,17 +1228,30 @@@@ int main(argc, argv)
d43 13
a55 13
+	if (!(proto = getprotobyname("icmp"))) {
+		(void)fprintf(stderr, "bing: unknown protocol icmp.\n");
+		exit(1);
+	}
+	if ((s = socket(AF_INET, SOCK_RAW, proto->p_proto)) < 0) {
+		perror("bing: socket");
+		exit(1);
+	}
+	/* Revoke privileges */
+	if (seteuid(getuid()) == -1 || setuid(getuid()) == -1) {
+		err(1, "unable to drop permissions");
+		exit(1);
+	}
d60 1
a60 1
@@@@ -1395,15 +1408,6 @@@@ int main(argc, argv)
@

