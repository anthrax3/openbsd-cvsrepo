head	1.1;
access;
symbols
	OPENBSD_5_8:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2015.11.16.12.40.25;	author jasper;	state dead;
branches
	1.1.2.1;
next	;
commitid	yZ1UvyN4rLsu7ggF;

1.1.2.1
date	2015.11.16.12.40.25;	author jasper;	state Exp;
branches;
next	;
commitid	yZ1UvyN4rLsu7ggF;


desc
@@


1.1
log
@file patch-pdns_dnspacket_cc was initially added on branch OPENBSD_5_8.
@
text
@@


1.1.2.1
log
@Security fix for CVE-2015-5311; from upstream
@
text
@a0 41
$OpenBSD$

Security fix for CVE-2015-5311
https://doc.powerdns.com/md/security/powerdns-advisory-2015-03/

--- pdns/dnspacket.cc.orig	Tue Jun  9 14:29:04 2015
+++ pdns/dnspacket.cc	Mon Nov 16 13:28:06 2015
@@@@ -458,10 +458,15 @@@@ bool DNSPacket::getTSIGDetails(TSIGRecordContent* trc,
   bool gotit=false;
   for(MOADNSParser::answers_t::const_iterator i=mdp.d_answers.begin(); i!=mdp.d_answers.end(); ++i) {          
     if(i->first.d_type == QType::TSIG) {
-      *trc = *boost::dynamic_pointer_cast<TSIGRecordContent>(i->first.d_content);
-      
-      gotit=true;
+      // cast can fail, f.e. if d_content is an UnknownRecordContent.
+      shared_ptr<TSIGRecordContent> content = boost::dynamic_pointer_cast<TSIGRecordContent>(i->first.d_content);
+      if (!content) {
+        L<<Logger::Error<<"TSIG record has no or invalid content (invalid packet)"<<endl;
+        return false;
+      }
+      *trc = *content;
       *keyname = i->first.d_label;
+      gotit=true;
       if(!keyname->empty())
         keyname->resize(keyname->size()-1); // drop the trailing dot
     }
@@@@ -486,7 +491,13 @@@@ bool DNSPacket::getTKEYRecord(TKEYRecordContent *tr, s
     }
 
     if(i->first.d_type == QType::TKEY) {
-      *tr = *boost::dynamic_pointer_cast<TKEYRecordContent>(i->first.d_content);
+      // cast can fail, f.e. if d_content is an UnknownRecordContent.
+      shared_ptr<TKEYRecordContent> content = boost::dynamic_pointer_cast<TKEYRecordContent>(i->first.d_content);
+      if (!content) {
+        L<<Logger::Error<<"TKEY record has no or invalid content (invalid packet)"<<endl;
+        return false;
+      }
+      *tr = *content;
       *keyname = i->first.d_label;
       gotit=true;
     }
@

