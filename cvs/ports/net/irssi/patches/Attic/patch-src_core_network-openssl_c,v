head	1.5;
access;
symbols
	OPENBSD_5_5:1.4.0.10
	OPENBSD_5_5_BASE:1.4
	OPENBSD_5_4:1.4.0.8
	OPENBSD_5_4_BASE:1.4
	OPENBSD_5_3:1.4.0.6
	OPENBSD_5_3_BASE:1.4
	OPENBSD_5_2:1.4.0.4
	OPENBSD_5_2_BASE:1.4
	OPENBSD_5_1_BASE:1.4
	OPENBSD_5_1:1.4.0.2
	OPENBSD_5_0:1.3.0.6
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_9:1.3.0.4
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.3.0.2
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.2.0.4
	OPENBSD_4_7_BASE:1.2
	OPENBSD_4_6:1.2.0.2
	OPENBSD_4_6_BASE:1.2
	OPENBSD_4_5:1.1.0.2
	OPENBSD_4_5_BASE:1.1;
locks; strict;
comment	@# @;


1.5
date	2014.06.02.16.50.42;	author sthen;	state dead;
branches;
next	1.4;
commitid	xrHPdyoqipq1W2DI;

1.4
date	2011.11.16.10.16.57;	author sthen;	state Exp;
branches;
next	1.3;

1.3
date	2010.05.19.15.04.28;	author sthen;	state Exp;
branches;
next	1.2;

1.2
date	2009.05.23.17.47.01;	author martynas;	state Exp;
branches;
next	1.1;

1.1
date	2008.12.22.19.40.33;	author matthieu;	state Exp;
branches;
next	;


desc
@@


1.5
log
@update to irssi 0.8.16, from viq (maintainer), and remove no-longer-used
function pointed out by viq but not in his original diff
@
text
@$OpenBSD: patch-src_core_network-openssl_c,v 1.4 2011/11/16 10:16:57 sthen Exp $
--- src/core/network-openssl.c.orig	Sun Nov  6 04:52:49 2011
+++ src/core/network-openssl.c	Sun Nov  6 05:11:41 2011
@@@@ -43,6 +43,8 @@@@ typedef struct
 	const char *hostname;
 } GIOSSLChannel;
 
+void irssi_redraw(void);
+
 static int ssl_inited = FALSE;
 
 static void irssi_ssl_free(GIOChannel *handle)
@@@@ -97,28 +99,28 @@@@ static char *tls_text_name(X509_NAME *name, int nid)
 
 	if (name == 0 || (pos = X509_NAME_get_index_by_NID(name, nid, -1)) < 0) {
 		return NULL;
-    }
+	}
 
-    entry = X509_NAME_get_entry(name, pos);
-    g_return_val_if_fail(entry != NULL, NULL);
-    entry_str = X509_NAME_ENTRY_get_data(entry);
-    g_return_val_if_fail(entry_str != NULL, NULL);
+	entry = X509_NAME_get_entry(name, pos);
+	g_return_val_if_fail(entry != NULL, NULL);
+	entry_str = X509_NAME_ENTRY_get_data(entry);
+	g_return_val_if_fail(entry_str != NULL, NULL);
 
-    /* Convert everything into UTF-8. It's up to OpenSSL to do something
+	/* Convert everything into UTF-8. It's up to OpenSSL to do something
 	   reasonable when converting ASCII formats that contain non-ASCII
 	   content. */
-    if ((utf8_length = ASN1_STRING_to_UTF8(&utf8_value, entry_str)) < 0) {
-    	g_warning("Error decoding ASN.1 type=%d", ASN1_STRING_type(entry_str));
-    	return NULL;
-    }
+	if ((utf8_length = ASN1_STRING_to_UTF8(&utf8_value, entry_str)) < 0) {
+		g_warning("Error decoding ASN.1 type=%d", ASN1_STRING_type(entry_str));
+		return NULL;
+	}
 
-    if (has_internal_nul((char *)utf8_value, utf8_length)) {
-    	g_warning("NUL character in hostname in certificate");
-    	OPENSSL_free(utf8_value);
-    	return NULL;
-    }
+	if (has_internal_nul((char *)utf8_value, utf8_length)) {
+		g_warning("NUL character in hostname in certificate");
+		OPENSSL_free(utf8_value);
+		return NULL;
+	}
 
-    result = g_strdup((char *) utf8_value);
+	result = g_strdup((char *) utf8_value);
 	OPENSSL_free(utf8_value);
 	return result;
 }
@@@@ -168,10 +170,10 @@@@ static gboolean irssi_ssl_verify_hostname(X509 *cert, 
 			if (cert_dns_name && *cert_dns_name) {
 				matched = match_hostname(cert_dns_name, hostname);
 			}
-    	}
+		}
 
-	    /* Free stack *and* member GENERAL_NAME objects */
-	    sk_GENERAL_NAME_pop_free(gens, GENERAL_NAME_free);
+		/* Free stack *and* member GENERAL_NAME objects */
+		sk_GENERAL_NAME_pop_free(gens, GENERAL_NAME_free);
 	}
 
 	if (has_dns_name) {
@@@@ -182,15 +184,15 @@@@ static gboolean irssi_ssl_verify_hostname(X509 *cert, 
 		return matched;
 	} else { /* No subjectAltNames, look at CommonName */
 		cert_subject_cn = tls_text_name(X509_get_subject_name(cert), NID_commonName);
-	    if (cert_subject_cn && *cert_subject_cn) {
-	    	matched = match_hostname(cert_subject_cn, hostname);
-	    	if (! matched) {
+		if (cert_subject_cn && *cert_subject_cn) {
+			matched = match_hostname(cert_subject_cn, hostname);
+			if (! matched) {
 				g_warning("SSL certificate common name '%s' doesn't match host name '%s'", cert_subject_cn, hostname);
-	    	}
-	    } else {
-	    	g_warning("No subjectAltNames and no valid common name in certificate");
-	    }
-	    free(cert_subject_cn);
+			}
+		} else {
+			g_warning("No subjectAltNames and no valid common name in certificate");
+		}
+		free(cert_subject_cn);
 	}
 
 	return matched;
@@@@ -247,6 +249,7 @@@@ static GIOStatus irssi_ssl_read(GIOChannel *handle, gc
 	GIOSSLChannel *chan = (GIOSSLChannel *)handle;
 	gint ret1, err;
 	const char *errstr;
+	gchar *errmsg;
 
 	ret1 = SSL_read(chan->ssl, buf, len);
 	if(ret1 <= 0)
@@@@ -271,9 +274,10 @@@@ static GIOStatus irssi_ssl_read(GIOChannel *handle, gc
 			if (errstr == NULL)
 				errstr = "unknown SSL error";
 		}
-		g_warning("SSL read error: %s", errstr);
+		errmsg = g_strdup_printf("SSL read error: %s", errstr);
 		*gerr = g_error_new_literal(G_IO_CHANNEL_ERROR, G_IO_CHANNEL_ERROR_FAILED,
-					    errstr);
+					    errmsg);
+		g_free(errmsg);
 		return G_IO_STATUS_ERROR;
 	}
 	else
@@@@ -290,6 +294,7 @@@@ static GIOStatus irssi_ssl_write(GIOChannel *handle, c
 	GIOSSLChannel *chan = (GIOSSLChannel *)handle;
 	gint ret1, err;
 	const char *errstr;
+	gchar *errmsg;
 
 	ret1 = SSL_write(chan->ssl, (const char *)buf, len);
 	if(ret1 <= 0)
@@@@ -314,9 +319,10 @@@@ static GIOStatus irssi_ssl_write(GIOChannel *handle, c
 			if (errstr == NULL)
 				errstr = "unknown SSL error";
 		}
-		g_warning("SSL write error: %s", errstr);
+		errmsg = g_strdup_printf("SSL write error: %s", errstr);
 		*gerr = g_error_new_literal(G_IO_CHANNEL_ERROR, G_IO_CHANNEL_ERROR_FAILED,
-					    errstr);
+					    errmsg);
+		g_free(errmsg);
 		return G_IO_STATUS_ERROR;
 	}
 	else
@@@@ -374,6 +380,17 @@@@ static GIOFuncs irssi_ssl_channel_funcs = {
     irssi_ssl_get_flags
 };
 
+static int getpass_cb(char *buf, int size, int rwflag, void *keyname)
+{
+	char *pp, prompt[256];
+	snprintf(prompt, 256, "Enter Passphrase for %s:", keyname);
+	pp = getpass(prompt);
+	strncpy(buf, pp, size);
+	buf[size - 1] = '\0';
+	irssi_redraw();
+	return(strlen(buf));
+}
+
 static gboolean irssi_ssl_init(void)
 {
 	SSL_library_init();
@@@@ -406,12 +423,15 @@@@ static GIOChannel *irssi_ssl_get_iochannel(GIOChannel 
 		g_error("Could not allocate memory for SSL context");
 		return NULL;
 	}
+	SSL_CTX_set_options(ctx, SSL_OP_ALL | SSL_OP_NO_SSLv2);
 
 	if (mycert && *mycert) {
 		char *scert = NULL, *spkey = NULL;
 		scert = convert_home(mycert);
 		if (mypkey && *mypkey)
 			spkey = convert_home(mypkey);
+		SSL_CTX_set_default_passwd_cb(ctx, getpass_cb);
+		SSL_CTX_set_default_passwd_cb_userdata(ctx, mypkey ? mypkey : mycert);
 		if (! SSL_CTX_use_certificate_file(ctx, scert, SSL_FILETYPE_PEM))
 			g_warning("Loading of client certificate '%s' failed", mycert);
 		else if (! SSL_CTX_use_PrivateKey_file(ctx, spkey ? spkey : scert, SSL_FILETYPE_PEM))
@


1.4
log
@Various tweaks to the irssi port, from Brad. Tested by a few people,
viq (maintainer) doesn't have time to look at it properly but is
generally ok with this.

- Remove USE_GROFF
- Remove --enable-ipv6 from CONFIGURE_ARGS since its enabled by default
- Backport fixes from SVN repo..
  - Replace deprecated glib functions
  - Do not go beyond the end of the string when processing an octal escape
  - glib iochannel fixes
  - Fix segfault generated by SSL disconnections
  - Do not use SSLv2 protocol
  - When sending a signal to an /exec'd command, send it to the process
    group id instead of the process id.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_core_network-openssl_c,v 1.3 2010/05/19 15:04:28 sthen Exp $
@


1.3
log
@update to 0.18.5 from Simon Kuhnle, ok viq (maintainer)
@
text
@d1 3
a3 3
$OpenBSD: patch-src_core_network-openssl_c,v 1.2 2009/05/23 17:47:01 martynas Exp $
--- src/core/network-openssl.c.orig	Sat Apr  3 18:19:38 2010
+++ src/core/network-openssl.c	Sun Apr  4 16:34:00 2010
d13 126
a138 1
@@@@ -374,6 +376,17 @@@@ static GIOFuncs irssi_ssl_channel_funcs = {
d156 8
a163 1
@@@@ -412,6 +425,8 @@@@ static GIOChannel *irssi_ssl_get_iochannel(GIOChannel 
d168 1
a168 1
+		SSL_CTX_set_default_passwd_cb_userdata(ctx, mypkey?mypkey:mycert);
@


1.2
log
@update to irssi-0.8.13: http://www.irssi.org/news/ChangeLog
from Colin Didier, tweaks by maintainer Wiktor Izdebski and myself
tested by Simon Kuhnle, sthen@@ and myself.  ok sthen@@
@
text
@d1 5
a5 5
$OpenBSD: patch-src_core_network-openssl_c,v 1.1 2008/12/22 19:40:33 matthieu Exp $
--- src/core/network-openssl.c.orig	Tue Mar 31 22:50:02 2009
+++ src/core/network-openssl.c	Sun Apr  5 01:25:29 2009
@@@@ -41,6 +41,8 @@@@ typedef struct
 	unsigned int verify:1;
d10 1
a10 1
 static SSL_CTX *ssl_ctx = NULL;
d13 1
a13 1
@@@@ -225,6 +227,17 @@@@ static GIOFuncs irssi_ssl_channel_funcs = {
d31 1
a31 1
@@@@ -266,6 +279,8 @@@@ static GIOChannel *irssi_ssl_get_iochannel(GIOChannel 
@


1.1
log
@Add a patch adapted from bugs.irrsi.org for double echoed characters
after reading a certificate's password.
(http://bugs.irssi.org/index.php?do=details&task_id=305)
Regen patches.
Add @@bin marker to plist.
from maintainer (viq at vic dot ath dot cx)
@
text
@d1 4
a4 5
$OpenBSD$
--- src/core/network-openssl.c.orig	Sat Oct  6 11:38:20 2007
+++ src/core/network-openssl.c	Wed Dec  3 23:21:23 2008
@@@@ -40,6 +40,8 @@@@ typedef struct
 	SSL_CTX *ctx;
d7 2
a9 2
+void irssi_redraw(void);
 	
d12 2
a13 1
@@@@ -201,6 +203,17 @@@@ static GIOFuncs irssi_ssl_channel_funcs = {
d31 1
a31 1
@@@@ -242,6 +255,8 @@@@ static GIOChannel *irssi_ssl_get_iochannel(GIOChannel 
@

