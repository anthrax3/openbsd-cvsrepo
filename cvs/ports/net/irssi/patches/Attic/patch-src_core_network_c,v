head	1.2;
access;
symbols
	OPENBSD_5_5:1.1.0.10
	OPENBSD_5_5_BASE:1.1
	OPENBSD_5_4:1.1.0.8
	OPENBSD_5_4_BASE:1.1
	OPENBSD_5_3:1.1.0.6
	OPENBSD_5_3_BASE:1.1
	OPENBSD_5_2:1.1.0.4
	OPENBSD_5_2_BASE:1.1
	OPENBSD_5_1_BASE:1.1
	OPENBSD_5_1:1.1.0.2;
locks; strict;
comment	@# @;


1.2
date	2014.06.02.16.50.42;	author sthen;	state dead;
branches;
next	1.1;
commitid	xrHPdyoqipq1W2DI;

1.1
date	2011.11.16.10.16.57;	author sthen;	state Exp;
branches;
next	;


desc
@@


1.2
log
@update to irssi 0.8.16, from viq (maintainer), and remove no-longer-used
function pointed out by viq but not in his original diff
@
text
@$OpenBSD: patch-src_core_network_c,v 1.1 2011/11/16 10:16:57 sthen Exp $
--- src/core/network.c.orig	Sun Nov  6 04:53:30 2011
+++ src/core/network.c	Sun Nov  6 04:53:34 2011
@@@@ -42,11 +42,18 @@@@ union sockaddr_union {
 #  define SIZEOF_SOCKADDR(so) (sizeof(so.sin))
 #endif
 
+GIOChannel *g_io_channel_new(int handle)
+{
+	GIOChannel *chan;
 #ifdef WIN32
-#  define g_io_channel_new(handle) g_io_channel_win32_new_stream_socket(handle)
+	chan = g_io_channel_win32_new_socket(handle);
 #else
-#  define g_io_channel_new(handle) g_io_channel_unix_new(handle)
+	chan = g_io_channel_unix_new(handle);
 #endif
+	g_io_channel_set_encoding(chan, NULL, NULL);
+	g_io_channel_set_buffered(chan, FALSE);
+	return chan;
+}
 
 /* Cygwin need this, don't know others.. */
 /*#define BLOCKING_SOCKETS 1*/
@@@@ -341,36 +348,42 @@@@ GIOChannel *net_accept(GIOChannel *handle, IPADDR *add
 int net_receive(GIOChannel *handle, char *buf, int len)
 {
         gsize ret;
-	int err;
+	GIOStatus status;
+	GError *err = NULL;
 
 	g_return_val_if_fail(handle != NULL, -1);
 	g_return_val_if_fail(buf != NULL, -1);
 
-	err = g_io_channel_read(handle, buf, len, &ret);
-	if (err == 0 && ret == 0)
+	status = g_io_channel_read_chars(handle, buf, len, &ret, &err);
+	if (err != NULL) {
+	        g_warning(err->message);
+	        g_error_free(err);
+	}
+	if (status == G_IO_STATUS_ERROR || status == G_IO_STATUS_EOF)
 		return -1; /* disconnected */
 
-	if (err == G_IO_ERROR_AGAIN || (err != 0 && errno == EINTR))
-		return 0; /* no bytes received */
-
-	return err == 0 ? (int)ret : -1;
+	return ret;
 }
 
 /* Transmit data, return number of bytes sent, -1 = error */
 int net_transmit(GIOChannel *handle, const char *data, int len)
 {
         gsize ret;
-	int err;
+	GIOStatus status;
+	GError *err = NULL;
 
 	g_return_val_if_fail(handle != NULL, -1);
 	g_return_val_if_fail(data != NULL, -1);
 
-	err = g_io_channel_write(handle, (char *) data, len, &ret);
-	if (err == G_IO_ERROR_AGAIN ||
-	    (err != 0 && (errno == EINTR || errno == EPIPE)))
-		return 0;
+	status = g_io_channel_write_chars(handle, (char *) data, len, &ret, &err);
+	if (err != NULL) {
+	        g_warning(err->message);
+	        g_error_free(err);
+	}
+	if (status == G_IO_STATUS_ERROR)
+		return -1;
 
-	return err == 0 ? (int)ret : -1;
+	return ret;
 }
 
 /* Get socket address/port */
@


1.1
log
@Various tweaks to the irssi port, from Brad. Tested by a few people,
viq (maintainer) doesn't have time to look at it properly but is
generally ok with this.

- Remove USE_GROFF
- Remove --enable-ipv6 from CONFIGURE_ARGS since its enabled by default
- Backport fixes from SVN repo..
  - Replace deprecated glib functions
  - Do not go beyond the end of the string when processing an octal escape
  - glib iochannel fixes
  - Fix segfault generated by SSL disconnections
  - Do not use SSLv2 protocol
  - When sending a signal to an /exec'd command, send it to the process
    group id instead of the process id.
@
text
@d1 1
a1 1
$OpenBSD$
@

