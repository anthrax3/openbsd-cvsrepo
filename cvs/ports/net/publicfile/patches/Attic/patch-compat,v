head	1.3;
access;
symbols
	OPENBSD_2_9:1.2.0.4
	OPENBSD_2_9_BASE:1.2
	OPENBSD_2_8:1.2.0.2
	OPENBSD_2_8_BASE:1.2;
locks; strict;
comment	@# @;


1.3
date	2001.08.14.21.21.20;	author camield;	state dead;
branches;
next	1.2;

1.2
date	2000.09.21.08.49.32;	author camield;	state Exp;
branches;
next	1.1;

1.1
date	2000.09.21.08.14.56;	author camield;	state Exp;
branches;
next	;


desc
@@


1.3
log
@license does not permit modification, to allow for proper
integration in OpenBSD
@
text
@$OpenBSD: patch-compat,v 1.2 2000/09/21 08:49:32 camield Exp $

Output in /bin/ls format instead of EPLF. EPLF is not yet compatible
with some major FTP clients.

/bin/ls format complies with: http://cr.yp.to/ftp/list/binls.html
For information on EPLF see:  http://cr.yp.to/ftp/list/eplf.html

Patch by Camiel Dobbelaar, <cd@@sentia.nl>

--- fetch.c.orig	Tue Nov  9 08:23:46 1999
+++ fetch.c	Thu Sep 21 10:35:18 2000
@@@@ -40,24 +40,35 @@@@
 
 static void printstat()
 {
-  substdio_puts(&ss,"+i");
-  substdio_put(&ss,strnum,fmt_ulong(strnum,(unsigned long) st.st_dev));
-  substdio_puts(&ss,".");
-  substdio_put(&ss,strnum,fmt_ulong(strnum,(unsigned long) st.st_ino));
+  char *longstring;
+  int len;
 
-  if (st.st_mtime > 0)
-    if (st.st_mtime < now - 60) {
-      substdio_puts(&ss,",m");
-      substdio_put(&ss,strnum,fmt_ulong(strnum,(unsigned long) st.st_mtime));
-    }
-
-  if ((st.st_mode & S_IFMT) == S_IFDIR)
-    substdio_puts(&ss,",/");
-  if (((st.st_mode & S_IFMT) == S_IFREG) && ((st.st_mode & 0444) == 0444)) {
-    substdio_puts(&ss,",r,s");
-    substdio_put(&ss,strnum,fmt_ulong(strnum,(unsigned long) st.st_size));
+  /* rights, links, user, group */
+  if (((st.st_mode & S_IFMT) == S_IFREG) && ((st.st_mode & 0444) == 0444)) 
+    substdio_puts(&ss,"-rw-r--r--  1 owner group ");
+  else if ((st.st_mode & S_IFMT) == S_IFDIR)
+    substdio_puts(&ss,"drwxr-xr-x  1 owner group ");
+  else {
+    substdio_puts(&ss,"----------  1 owner group ");
+    /* do not reveal size, the EPLF implementation does not either */
+    st.st_size = 0;
   }
-  substdio_puts(&ss,",\t");
+
+  /* size */
+  len = fmt_ulong(strnum,(unsigned long) st.st_size);
+  /* right justify in 13-byte field */
+  substdio_put(&ss,"             ",((13-len) > 0) ? (13-len):0);
+  substdio_put(&ss,strnum,len);
+  substdio_puts(&ss," ");
+
+  /* date, time/year */
+  longstring = ctime(&st.st_mtime);
+  substdio_put(&ss,longstring+4,7);
+  if (st.st_mtime + ((365/2)*86400) > now)
+    substdio_put(&ss,longstring+11,5);
+  else
+    substdio_put(&ss,longstring+19,5);
+  substdio_puts(&ss," ");
 }
 
 static void list(char *fn,int flaglong)
@


1.2
log
@make it comply with http://cr.yp.to/ftp/list/binls.html
@
text
@d1 1
a1 1
$OpenBSD: patch-compat,v 1.1 2000/09/21 08:14:56 camield Exp $
@


1.1
log
@add 'compat' flavor: it patches publicfile to generate ``old-style''
/bin/ls output instead of EPLF, on FTP directory listings.
@
text
@d1 1
a1 1
$OpenBSD$
d6 2
a7 1
For information on EPLF see: http://cr.yp.to/ftp/list/eplf.html
d12 2
a13 2
+++ fetch.c	Tue Sep 19 11:48:13 2000
@@@@ -40,24 +40,36 @@@@
d37 1
a37 1
+    substdio_puts(&ss,"-r--r--r--  1 pub  pub ");
d39 1
a39 1
+    substdio_puts(&ss,"dr-xr-xr-x  2 pub  pub ");
d41 1
a41 1
+    substdio_puts(&ss,"----------  1 pub  pub ");
d49 2
a50 3
+  /* Internet Explorer gets deeply confused when using tabs, so */
+  /* align size using this ugly hack, to suit textmode clients. */
+  substdio_put(&ss,"          ",((10-len) > 0) ? (10-len):0);
@

