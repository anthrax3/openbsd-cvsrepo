head	1.4;
access;
symbols
	OPENBSD_5_6:1.3.0.10
	OPENBSD_5_6_BASE:1.3
	OPENBSD_5_5:1.3.0.8
	OPENBSD_5_5_BASE:1.3
	OPENBSD_5_4:1.3.0.6
	OPENBSD_5_4_BASE:1.3
	OPENBSD_5_3:1.3.0.4
	OPENBSD_5_3_BASE:1.3
	OPENBSD_5_2:1.3.0.2
	OPENBSD_5_2_BASE:1.3
	OPENBSD_5_1_BASE:1.2
	OPENBSD_5_1:1.2.0.14
	OPENBSD_5_0:1.2.0.12
	OPENBSD_5_0_BASE:1.2
	OPENBSD_4_9:1.2.0.10
	OPENBSD_4_9_BASE:1.2
	OPENBSD_4_8:1.2.0.8
	OPENBSD_4_8_BASE:1.2
	OPENBSD_4_7:1.2.0.6
	OPENBSD_4_7_BASE:1.2
	OPENBSD_4_6:1.2.0.4
	OPENBSD_4_6_BASE:1.2
	OPENBSD_4_5:1.2.0.2
	OPENBSD_4_5_BASE:1.2
	OPENBSD_4_4:1.1.0.4
	OPENBSD_4_4_BASE:1.1
	OPENBSD_4_3:1.1.0.2
	OPENBSD_4_3_BASE:1.1;
locks; strict;
comment	@# @;


1.4
date	2014.10.08.16.44.58;	author stsp;	state dead;
branches;
next	1.3;
commitid	7jWfdOcvyxIGBB1b;

1.3
date	2012.06.25.14.06.26;	author naddy;	state Exp;
branches;
next	1.2;

1.2
date	2008.11.11.16.23.26;	author naddy;	state Exp;
branches;
next	1.1;

1.1
date	2007.10.23.22.13.38;	author naddy;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Send net/pptp to the attic. It requires an MPPE-capable ppp client
which we don't have in base anymore. No objections from ports@@
@
text
@$OpenBSD: patch-pptp_gre_c,v 1.3 2012/06/25 14:06:26 naddy Exp $
--- pptp_gre.c.orig	Wed May 14 00:33:55 2008
+++ pptp_gre.c	Mon Jun 25 07:49:13 2012
@@@@ -11,6 +11,9 @@@@
 #include <sys/socket.h>
 #include <sys/stat.h>
 #include <sys/time.h>
+#include <sys/param.h>
+#include <sys/sysctl.h>
+#include <netinet/ip_gre.h>
 #include <unistd.h>
 #include <stdlib.h>
 #include <string.h>
@@@@ -78,12 +81,36 @@@@ uint64_t time_now_usecs()
     return (tv.tv_sec * 1000000) + tv.tv_usec;
 }
 
+static int set_gre_sysctl(int value)
+{
+    int mib[4];
+
+    /* "net.inet.gre.allow" */
+    mib[0] = CTL_NET;
+    mib[1] = PF_INET;
+    mib[2] = IPPROTO_GRE;
+    mib[3] = GRECTL_ALLOW;
+    
+    if (sysctl(mib, 4, NULL, 0, &value, sizeof(value)) == -1)
+        return 0;
+    return 1;
+}
+
 /*** Open IP protocol socket **************************************************/
 int pptp_gre_bind(struct in_addr inetaddr)
 {
     struct sockaddr_in src_addr, loc_addr;
     extern struct in_addr localbind;
-    int s = socket(AF_INET, SOCK_RAW, PPTP_PROTO);
+    int s;
+    
+    /* On OpenBSD, we need to enable GRE via sysctl before
+     * it can be used. */
+    if (! set_gre_sysctl(1)) {
+	    warn("Could not enable net.inet.gre.allow sysctl");
+	    return -1;
+    }
+
+    s = socket(AF_INET, SOCK_RAW, PPTP_PROTO);
     if (s < 0) { warn("socket: %s", strerror(errno)); return -1; }
     if (localbind.s_addr != INADDR_NONE) {
         bzero(&loc_addr, sizeof(loc_addr));
@


1.3
log
@explicitly include <sys/param.h> before <sys/sysctl.h> and don't rely on
it being pulled in by some other header file
@
text
@d1 1
a1 1
$OpenBSD: patch-pptp_gre_c,v 1.2 2008/11/11 16:23:26 naddy Exp $
@


1.2
log
@update to 1.7.2; from maintainer Stefan Sperling
@
text
@d1 4
a4 4
$OpenBSD: patch-pptp_gre_c,v 1.1 2007/10/23 22:13:38 naddy Exp $
--- pptp_gre.c.orig	Wed May 14 08:33:55 2008
+++ pptp_gre.c	Sat Sep 20 17:44:51 2008
@@@@ -11,6 +11,8 @@@@
d8 1
d14 1
a14 1
@@@@ -78,12 +80,36 @@@@ uint64_t time_now_usecs()
@


1.1
log
@* Update maintainer email address.
* Add detailed option descriptions to pptp(8) man page.
* Move OpenBSD configuration examples from text file
  ${PREFIX}/share/doc/pptp/USING into pptp(8) man page,
  and remove patch to ${WRKSRC}/USING. Extend and
  revise examples while at it.
* Add patch to ${WRKSRC}/util.c to make pptp log normal
  informational messages with level LOG_INFO instead of LOG_NOTICE.
* Update pkg/DESCR with a new description based on upstream web site.
* Fix URL to list of pptp security flaws in pkg/MESSAGE.
* [Re-]Create patches with `make update-patches'.
* Add patch to ${WRKSRC}/pptp_gre.c to automatically enable
  the net.inet.gre.allow sysctl before trying to bind
  the GRE socket.
* Remove '@@sysctl net.inet.gre.allow=1' from PLIST.

From: maintainer Stefan Sperling
@
text
@d1 3
a3 3
$OpenBSD$
--- pptp_gre.c.orig	Mon Feb 13 04:07:42 2006
+++ pptp_gre.c	Tue Oct 23 10:49:46 2007
d11 1
d13 1
a13 2
 #include <errno.h>
@@@@ -73,12 +75,36 @@@@ uint64_t time_now_usecs()
@

