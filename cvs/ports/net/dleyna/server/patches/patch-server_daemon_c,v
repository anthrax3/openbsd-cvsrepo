head	1.1;
branch	1.1.1;
access;
symbols
	OPENBSD_6_2:1.1.1.1.0.10
	OPENBSD_6_2_BASE:1.1.1.1
	OPENBSD_6_1:1.1.1.1.0.8
	OPENBSD_6_1_BASE:1.1.1.1
	OPENBSD_6_0:1.1.1.1.0.6
	OPENBSD_6_0_BASE:1.1.1.1
	OPENBSD_5_9:1.1.1.1.0.2
	OPENBSD_5_9_BASE:1.1.1.1
	OPENBSD_5_8:1.1.1.1.0.4
	OPENBSD_5_8_BASE:1.1.1.1
	ajacoutot_20150417:1.1.1.1
	ajacoutot:1.1.1;
locks; strict;
comment	@# @;


1.1
date	2015.04.17.18.39.00;	author ajacoutot;	state Exp;
branches
	1.1.1.1;
next	;
commitid	rBErTOavbpe1rMfc;

1.1.1.1
date	2015.04.17.18.39.00;	author ajacoutot;	state Exp;
branches;
next	;
commitid	rBErTOavbpe1rMfc;


desc
@@



1.1
log
@Initial revision
@
text
@$OpenBSD$

https://github.com/01org/dleyna-renderer/commit/bee9a8963b485312cbe738c435e929ead16a9435.patch

--- server/daemon.c.orig	Fri Apr 17 14:51:58 2015
+++ server/daemon.c	Fri Apr 17 14:54:07 2015
@@@@ -22,82 +22,30 @@@@
  */
 
 #include <glib.h>
-#include <sys/signalfd.h>
+#include <glib-unix.h>
 
 #include <libdleyna/core/main-loop.h>
 #include <libdleyna/server/control-point-server.h>
 
 #define DLS_SERVER_SERVICE_NAME "dleyna-server-service"
 
-static guint g_sig_id;
-
-static gboolean prv_quit_handler(GIOChannel *source, GIOCondition condition,
-				 gpointer user_data)
+static gboolean prv_quit_handler(gpointer user_data)
 {
 	dleyna_main_loop_quit();
-	g_sig_id = 0;
 
 	return FALSE;
 }
 
-static gboolean prv_init_signal_handler(sigset_t mask)
-{
-	gboolean retval = FALSE;
-	int fd = -1;
-	GIOChannel *channel = NULL;
-
-	fd = signalfd(-1, &mask, SFD_NONBLOCK);
-	if (fd == -1)
-		goto on_error;
-
-	channel = g_io_channel_unix_new(fd);
-	g_io_channel_set_close_on_unref(channel, TRUE);
-
-	if (g_io_channel_set_flags(channel, G_IO_FLAG_NONBLOCK, NULL) !=
-	    G_IO_STATUS_NORMAL)
-		goto on_error;
-
-	if (g_io_channel_set_encoding(channel, NULL, NULL) !=
-	    G_IO_STATUS_NORMAL)
-		goto on_error;
-
-	g_sig_id = g_io_add_watch(channel, G_IO_IN | G_IO_PRI,
-				  prv_quit_handler,
-				  NULL);
-
-	retval = TRUE;
-
-on_error:
-
-	if (channel)
-		g_io_channel_unref(channel);
-
-	return retval;
-}
-
 int main(int argc, char *argv[])
 {
-	sigset_t mask;
-	int retval = 1;
+	int retval;
 
-	sigemptyset(&mask);
-	sigaddset(&mask, SIGTERM);
-	sigaddset(&mask, SIGINT);
+	g_unix_signal_add (SIGTERM, prv_quit_handler, NULL);
+	g_unix_signal_add (SIGINT, prv_quit_handler, NULL);
 
-	if (sigprocmask(SIG_BLOCK, &mask, NULL) == -1)
-		goto out;
-
-	if (!prv_init_signal_handler(mask))
-		goto out;
-
 	retval = dleyna_main_loop_start(DLS_SERVER_SERVICE_NAME,
 					dleyna_control_point_get_server(),
 					NULL);
-
-out:
-
-	if (g_sig_id)
-		(void) g_source_remove(g_sig_id);
 
 	return retval;
 }
@


1.1.1.1
log
@Import dleyna-core-0.5.0, dleyna-connector-dbus-0.2.0, dleyna-renderer-0.5.0,
       dleyna-server-0.5.0

dLeyna-core is a library of utility functions that are used by the
higher level dLeyna libraries that communicate with DLNA devices, e.g.,
dleyna-server.
<...>

ok jasper@@
@
text
@@
