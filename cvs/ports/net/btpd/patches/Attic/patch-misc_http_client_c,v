head	1.2;
access;
symbols
	OPENBSD_4_8:1.1.0.4
	OPENBSD_4_8_BASE:1.1
	OPENBSD_4_7:1.1.0.2
	OPENBSD_4_7_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2010.08.24.17.24.20;	author nicm;	state dead;
branches;
next	1.1;

1.1
date	2010.01.11.22.53.35;	author nicm;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Update to 0.16, ok jasper
@
text
@$OpenBSD: patch-misc_http_client_c,v 1.1 2010/01/11 22:53:35 nicm Exp $
--- misc/http_client.c.orig	Mon Jan 12 14:43:18 2009
+++ misc/http_client.c	Tue Dec 22 23:19:29 2009
@@@@ -230,6 +230,12 @@@@ again:
             else
                 goto error;
         }
+
+        /* req->rbuf.buf may be reallocated inside iobuf_write()
+         * so we should calculate the offset before that happens
+         */
+        size_t consumed = end - (char *)req->rbuf.buf + dlen;
+
         if (!iobuf_write(&req->rbuf, "", 1))
             goto error;
         req->rbuf.off--;
@@@@ -237,7 +243,7 @@@@ again:
             goto error;
         if (req->cancel)
             goto cancel;
-        iobuf_consumed(&req->rbuf, end - (char *)req->rbuf.buf + dlen);
+        iobuf_consumed(&req->rbuf, consumed);
         goto again;
     case PS_CHUNK_SIZE:
         assert(req->chunked);
@


1.1
log
@Add patches to fix two annoying crashes, from Aaron Stellman.

ok sthen
@
text
@d1 1
a1 1
$OpenBSD$
@

