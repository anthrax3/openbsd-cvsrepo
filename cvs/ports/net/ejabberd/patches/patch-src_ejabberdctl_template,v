head	1.6;
access;
symbols
	OPENBSD_6_1:1.6.0.16
	OPENBSD_6_1_BASE:1.6
	OPENBSD_6_0:1.6.0.14
	OPENBSD_6_0_BASE:1.6
	OPENBSD_5_9:1.6.0.10
	OPENBSD_5_9_BASE:1.6
	OPENBSD_5_8:1.6.0.12
	OPENBSD_5_8_BASE:1.6
	OPENBSD_5_7:1.6.0.8
	OPENBSD_5_7_BASE:1.6
	OPENBSD_5_6:1.6.0.6
	OPENBSD_5_6_BASE:1.6
	OPENBSD_5_5:1.6.0.4
	OPENBSD_5_5_BASE:1.6
	OPENBSD_5_4:1.6.0.2
	OPENBSD_5_4_BASE:1.6
	OPENBSD_5_3:1.5.0.6
	OPENBSD_5_3_BASE:1.5
	OPENBSD_5_2:1.5.0.4
	OPENBSD_5_2_BASE:1.5
	OPENBSD_5_1_BASE:1.5
	OPENBSD_5_1:1.5.0.2
	OPENBSD_5_0:1.4.0.4
	OPENBSD_5_0_BASE:1.4
	OPENBSD_4_9:1.4.0.2
	OPENBSD_4_9_BASE:1.4
	OPENBSD_4_8:1.3.0.2
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.2.0.6
	OPENBSD_4_7_BASE:1.2
	OPENBSD_4_6:1.2.0.4
	OPENBSD_4_6_BASE:1.2
	OPENBSD_4_5:1.2.0.2
	OPENBSD_4_5_BASE:1.2
	OPENBSD_4_4:1.1.0.2
	OPENBSD_4_4_BASE:1.1;
locks; strict;
comment	@# @;


1.6
date	2013.05.05.16.17.19;	author gonzalo;	state Exp;
branches;
next	1.5;

1.5
date	2012.01.23.10.54.47;	author ajacoutot;	state Exp;
branches;
next	1.4;

1.4
date	2010.09.13.17.17.06;	author sebastia;	state Exp;
branches;
next	1.3;

1.3
date	2010.04.11.10.07.10;	author sthen;	state Exp;
branches;
next	1.2;

1.2
date	2009.02.12.09.58.11;	author sthen;	state Exp;
branches;
next	1.1;

1.1
date	2008.06.02.18.13.15;	author martynas;	state Exp;
branches;
next	;


desc
@@


1.6
log
@Update for Ejabberd to 2.1.12:

Mostly bugfixes

https://github.com/processone/ejabberd/blob/master/doc/release_notes_2.1.12.txt

Ok aja@@ abieber@@
@
text
@$OpenBSD: patch-src_ejabberdctl_template,v 1.5 2012/01/23 10:54:47 ajacoutot Exp $
--- src/ejabberdctl.template.orig	Tue Feb  5 09:22:34 2013
+++ src/ejabberdctl.template	Mon Apr 22 12:03:23 2013
@@@@ -1,7 +1,7 @@@@
 #!/bin/sh
 
 # define default configuration
-POLL=true
+POLL=false
 SMP=auto
 ERL_MAX_PORTS=32000
 ERL_PROCESSES=250000
@@@@ -9,10 +9,10 @@@@ ERL_MAX_ETS_TABLES=1400
 
 # define default environment variables
 NODE=ejabberd
-HOST=localhost
+HOST=`hostname -s`
 ERLANG_NODE=$NODE@@$HOST
 ERL=@@erl@@
-INSTALLUSER=@@installuser@@
+INSTALLUSER=${JABBERDUSER}
 
 # parse command line parameters
 ARGS=
@@@@ -33,7 +33,7 @@@@ done
 
 # Define ejabberd variable if they have not been defined from the command line
 if [ "$ETCDIR" = "" ] ; then
-    ETCDIR=@@SYSCONFDIR@@/ejabberd
+    ETCDIR=${SYSCONFDIR}/ejabberd
 fi
 if [ "$EJABBERD_CONFIG_PATH" = "" ] ; then
     EJABBERD_CONFIG_PATH=$ETCDIR/ejabberd.cfg
@@@@ -43,10 +43,10 @@@@ if [ "$EJABBERDCTL_CONFIG_PATH" = "" ] ; then
 fi
 [ -f "$EJABBERDCTL_CONFIG_PATH" ] && . "$EJABBERDCTL_CONFIG_PATH"
 if [ "$LOGS_DIR" = "" ] ; then
-    LOGS_DIR=@@LOCALSTATEDIR@@/log/ejabberd
+    LOGS_DIR=${EJLOGDIR}
 fi
 if [ "$SPOOLDIR" = "" ] ; then
-    SPOOLDIR=@@LOCALSTATEDIR@@/lib/ejabberd
+    SPOOLDIR=${EJDBDIR}/${NODE}
 fi
 if [ "$EJABBERD_DOC_PATH" = "" ] ; then
     EJABBERD_DOC_PATH=@@DOCDIR@@
@@@@ -62,7 +62,7 @@@@ EJID=`id -g $INSTALLUSER`
 EXEC_CMD="false"
 for GID in $GIDS; do
     if [ $GID -eq 0 ] ; then
-	EXEC_CMD="su ${INSTALLUSER} -p -c"
+	EXEC_CMD="su ${INSTALLUSER} -m -c"
     fi
 done
 if [ "$ID" -eq "$EJID" ] ; then
@@@@ -88,7 +88,7 @@@@ ERLANG_OPTS="+K $POLL -smp $SMP +P $ERL_PROCESSES $ERL
 
 # define additional environment variables
 if [ "$EJABBERDDIR" = "" ]; then
-    EJABBERDDIR=@@LIBDIR@@/ejabberd
+    EJABBERDDIR=${LOCALBASE}/lib/ejabberd
 fi
 if [ "$EJABBERD_EBIN_PATH" = "" ]; then
     EJABBERD_EBIN_PATH=$EJABBERDDIR/ebin
@@@@ -114,7 +114,7 @@@@ ERL_INETRC=$ETCDIR/inetrc
 HOME=$SPOOLDIR
 
 # create the home dir with the proper user if doesn't exist, because it stores cookie file
-[ -d $HOME ] || $EXEC_CMD "mkdir -p $HOME"
+#[ -d $HOME ] || $EXEC_CMD "mkdir -p $HOME"
 
 # Change to a directory readable by INSTALLUSER to
 # prevent "File operation error: eacces." messages
@@@@ -250,7 +250,7 @@@@ ctl ()
     # using flock if available. Expects a linux-style
     # flock that can lock a file descriptor.
     MAXCONNID=100
-    CONNLOCKDIR=@@LOCALSTATEDIR@@/lock/ejabberdctl
+    CONNLOCKDIR=/tmp
     FLOCK='/usr/bin/flock'
     if [ ! -x "$FLOCK" ] || [ ! -d "$CONNLOCKDIR" ] ; then
 	JOT='/usr/bin/jot'
@


1.5
log
@Update to ejabberd-2.1.10.

from "viq"
@
text
@d1 3
a3 3
$OpenBSD: patch-src_ejabberdctl_template,v 1.4 2010/09/13 17:17:06 sebastia Exp $
--- src/ejabberdctl.template.orig	Fri Dec 23 12:27:30 2011
+++ src/ejabberdctl.template	Sun Jan 22 20:11:03 2012
d75 1
a75 1
@@@@ -244,7 +244,7 @@@@ ctl ()
@


1.4
log
@update from maintainer to latest ejabberd 2.1.5

OK, jasper@@
@
text
@d1 3
a3 3
$OpenBSD: patch-src_ejabberdctl_template,v 1.3 2010/04/11 10:07:10 sthen Exp $
--- src/ejabberdctl.template.orig	Mon Aug  2 18:33:20 2010
+++ src/ejabberdctl.template	Wed Aug 18 00:30:24 2010
d57 1
a57 1
@@@@ -86,7 +86,7 @@@@ ERLANG_OPTS="+K $POLL -smp $SMP +P $ERL_PROCESSES $ERL
d66 1
a66 1
@@@@ -112,7 +112,7 @@@@ ERL_INETRC=$ETCDIR/inetrc
d73 3
a75 3
 # export global variables
 export EJABBERD_CONFIG_PATH
@@@@ -237,7 +237,7 @@@@ ctl ()
@


1.3
log
@update to 2.1.3, from viq (maintainer).
@
text
@d1 3
a3 3
$OpenBSD: patch-src_ejabberdctl_template,v 1.2 2009/02/12 09:58:11 sthen Exp $
--- src/ejabberdctl.template.orig	Fri Mar 12 11:40:41 2010
+++ src/ejabberdctl.template	Sat Apr  3 20:49:01 2010
d75 1
a75 1
@@@@ -234,7 +234,7 @@@@ ctl ()
d82 1
a82 1
     if [ ! -x "$FLOCK" ] ; then
@


1.2
log
@bugfix update to 2.0.3, from viq (maintainer).
@
text
@d1 3
a3 3
$OpenBSD: patch-src_ejabberdctl_template,v 1.1 2008/06/02 18:13:15 martynas Exp $
--- src/ejabberdctl.template.orig	Sun Oct 19 22:00:39 2008
+++ src/ejabberdctl.template	Sun Oct 19 22:05:49 2008
d13 1
a13 1
@@@@ -9,16 +9,18 @@@@ ERL_MAX_ETS_TABLES=1400
d21 2
a22 14
 ROOTDIR=@@rootdir@@
-EJABBERD_CONFIG_PATH=$ROOTDIR/etc/ejabberd/ejabberd.cfg
-LOGS_DIR=$ROOTDIR/var/log/ejabberd/
-EJABBERD_DB=$ROOTDIR/var/lib/ejabberd/db/$NODE
+EJABBERD_CONFIG_PATH=${SYSCONFDIR}/ejabberd/ejabberd.cfg
+LOGS_DIR=${EJLOGDIR}
+EJABBERD_DB=${EJDBDIR}/${NODE}
+ID=`id -g`
+EJID=`id -g ${JABBERDUSER}`
 
 # read custom configuration
-CONFIG=$ROOTDIR/etc/ejabberd/ejabberdctl.cfg
+CONFIG=${SYSCONFDIR}/ejabberd/ejabberdctl.cfg
 [ -f "$CONFIG" ] && . "$CONFIG"
d25 30
a54 2
@@@@ -37,23 +39,33 @@@@ while [ $# -ne 0 ] ; do
     esac
d56 2
d59 13
a71 7
+NODE="${ERLANG_NODE%@@*}"
+EJABBERD_DB=${EJDBDIR}/$NODE
+
 NAME=-name
 [ "$ERLANG_NODE" = "${ERLANG_NODE%.*}" ] && NAME=-sname
 
 ERLANG_OPTS="+K $POLL -smp $SMP +P $ERL_PROCESSES"
a72 28
 # define additional environment variables
-EJABBERD_EBIN=$ROOTDIR/var/lib/ejabberd/ebin
-EJABBERD_MSGS_PATH=$ROOTDIR/var/lib/ejabberd/priv/msgs
-EJABBERD_SO_PATH=$ROOTDIR/var/lib/ejabberd/priv/lib
-EJABBERD_BIN_PATH=$ROOTDIR/var/lib/ejabberd/priv/bin
-EJABBERD_LOG_PATH=$LOGS_DIR/ejabberd.log
-SASL_LOG_PATH=$LOGS_DIR/sasl.log
+EJABBERD_EBIN=${LOCALBASE}/lib/ejabberd/ebin
+EJABBERD_MSGS_PATH=${LOCALBASE}/lib/ejabberd/priv/msgs
+EJABBERD_SO_PATH=${LOCALBASE}/lib/ejabberd/priv/lib
+EJABBERD_BIN_PATH=${LOCALBASE}/lib/ejabberd/priv/bin
+EJABBERD_LOG_PATH=${LOGS_DIR}/${NODE}.log
+SASL_LOG_PATH=${LOGS_DIR}/${NODE}_sasl.log
 DATETIME=`date "+%Y%m%d-%H%M%S"`
-ERL_CRASH_DUMP=$LOGS_DIR/erl_crash_$DATETIME.dump
-ERL_INETRC=$ROOTDIR/etc/ejabberd/inetrc
-HOME=$ROOTDIR/var/lib/ejabberd
+ERL_CRASH_DUMP=${LOGS_DIR}/erl_crash_${DATETIME}.dump
+ERL_INETRC=${SYSCONFDIR}/ejabberd/inetrc
+HOME=${EJDBDIR}
 
+# make sure we execute commands as proper user
+if [ $ID -eq 0 ]; then
+	EXEC_CMD='sudo -c - -u ${JABBERDUSER}'
+else
+	EXEC_CMD=''
+fi
+
d75 9
a83 84
 export EJABBERD_MSGS_PATH
@@@@ -64,23 +76,24 @@@@ export ERL_CRASH_DUMP
 export ERL_INETRC
 export ERL_MAX_PORTS
 export ERL_MAX_ETS_TABLES
+export EXEC_CMD
 export HOME
 
-[ -d $EJABBERD_DB ] || mkdir -p $EJABBERD_DB
-[ -d $LOGS_DIR ] || mkdir -p $LOGS_DIR
-
 # Compatibility in ZSH
 #setopt shwordsplit 2>/dev/null
 
 # start server
 start ()
 {
-    $ERL \
+    ${EXEC_CMD} $ERL \
       $NAME $ERLANG_NODE \
       -noinput -detached \
       -pa $EJABBERD_EBIN \
+      -kernel inetrc \"${ERL_INETRC}\" \
       -mnesia dir "\"$EJABBERD_DB\"" \
       -s ejabberd \
+      -ejabberd config \"${EJABBERD_CONFIG_PATH}\" \
+      log_path \"${EJABBERD_LOG_PATH}\" \
       -sasl sasl_error_logger \{file,\"$SASL_LOG_PATH\"\} \
       $ERLANG_OPTS $ARGS "$@@"
 }
@@@@ -104,7 +117,7 @@@@ debug ()
     echo "Press any key to continue"
     read foo
     echo ""
-    $ERL \
+    ${EXEC_CMD} $ERL \
       $NAME ${NODE}debug \
       -remsh $ERLANG_NODE \
       $ERLANG_OPTS $ARGS "$@@"
@@@@ -128,18 +141,21 @@@@ live ()
     echo "Press any key to continue"
     read foo
     echo ""
-    $ERL \
+    ${EXEC_CMD} $ERL \
       $NAME $ERLANG_NODE \
       -pa $EJABBERD_EBIN \
+      -kernel inetrc \"${ERL_INETRC}\" \
       -mnesia dir "\"$EJABBERD_DB\"" \
       -s ejabberd \
+      -ejabberd config \"${EJABBERD_CONFIG_PATH}\" \
+      log_path \"${EJABBERD_LOG_PATH}\" \
       $ERLANG_OPTS $ARGS "$@@"
 }
 
 # common control function
 ctl ()
 {
-    $ERL \
+    ${EXEC_CMD} $ERL \
       $NAME ejabberdctl \
       -noinput \
       -pa $EJABBERD_EBIN \
@@@@ -171,6 +187,20 @@@@ usage ()
     ctl
     exit
 }
+
+# check if we're a user that can execute commands
+if [ "$ID" -ne 0 -a "$ID" -ne "$EJID" ]; then
+	echo "this command can only be run by root or the _ejabberd user" >&2
+	EXEC_CMD='false'
+	usage
+fi
+
+if [ ! -d $EJABBERD_DB -o ! -w $EJABBERD_DB ] ; then
+	if [ ! -d ${EJABBERD_DB%/*} -o ! -w ${EJABBERD_DB%/*} ] ; then
+		echo "${EJABBERD_DB} does not exist and I can't create it!"
+		exit 1
+	fi
+fi
 
 case $ARGS in
     ' start') start;;
@


1.1
log
@- update to ejabberd-2.0.1
- drop privilegies in ejabberdctl
- add README.OpenBSD
from maintainer Wiktor Izdebski;  with tweaks from me
tested by Wiktor Izdebski, Simon Kuhnle and sthen@@
ok sthen@@
@
text
@d1 3
a3 3
$OpenBSD$
--- src/ejabberdctl.template.orig	Tue May 20 12:22:03 2008
+++ src/ejabberdctl.template	Sun Jun  1 21:08:43 2008
d13 1
a13 1
@@@@ -9,15 +9,17 @@@@ ERL_MAX_ETS_TABLES=1400
d20 1
d27 1
a27 1
+EJABBERD_DB=${EJDBDIR}/$NODE
d37 1
a37 1
@@@@ -36,23 +38,33 @@@@ while [ $# -ne 0 ] ; do
d60 2
a61 2
+EJABBERD_LOG_PATH=$LOGS_DIR/${NODE}.log
+SASL_LOG_PATH=$LOGS_DIR/${NODE}_sasl.log
d63 1
a63 1
 ERL_CRASH_DUMP=$LOGS_DIR/erl_crash_$DATETIME.dump
d66 1
d72 1
a72 1
+	EXEC_CMD='sudo -u ${JABBERDUSER}'
d80 1
a80 1
@@@@ -63,23 +75,24 @@@@ export ERL_CRASH_DUMP
d96 2
a97 2
-    erl \
+    $EXEC_CMD ${LOCALBASE}/bin/erl \
d109 1
a109 1
@@@@ -103,7 +116,7 @@@@ debug ()
d113 2
a114 2
-    erl \
+    $EXEC_CMD ${LOCALBASE}/bin/erl \
d118 1
a118 1
@@@@ -127,19 +140,22 @@@@ live ()
d122 2
a123 2
-    erl \
+    $EXEC_CMD ${LOCALBASE}/bin/erl \
a124 1
       $ERLANG_OPTS \
d137 2
a138 2
-    erl \
+    $EXEC_CMD ${LOCALBASE}/bin/erl \
d142 1
a142 9
@@@@ -159,6 +175,7 @@@@ ctl ()
         echo "  --ctl-config file  Config file of ejabberdctl: $CONFIG"
         echo "  --logs dir         Directory for logs:         $LOGS_DIR"
         echo "  --spool dir        Database spool dir:         $EJABBERD_DB"
+        echo "  --node node_name   Ejabberd node name:         $ERLANG_NODE"
         echo "";;
     esac
     return $result
@@@@ -170,6 +187,20 @@@@ usage ()
@

