head	1.6;
access;
symbols
	OPENBSD_4_3:1.5.0.2
	OPENBSD_4_3_BASE:1.5
	OPENBSD_4_2:1.4.0.4
	OPENBSD_4_2_BASE:1.4
	OPENBSD_4_1:1.4.0.2
	OPENBSD_4_1_BASE:1.4
	OPENBSD_4_0:1.3.0.2
	OPENBSD_4_0_BASE:1.3
	OPENBSD_3_9:1.2.0.6
	OPENBSD_3_9_BASE:1.2
	OPENBSD_3_8:1.2.0.4
	OPENBSD_3_8_BASE:1.2
	OPENBSD_3_7:1.2.0.2
	OPENBSD_3_7_BASE:1.2
	OPENBSD_3_6:1.1.0.2
	OPENBSD_3_6_BASE:1.1;
locks; strict;
comment	@# @;


1.6
date	2008.04.09.22.13.12;	author merdely;	state dead;
branches;
next	1.5;

1.5
date	2007.11.19.11.44.33;	author martynas;	state Exp;
branches;
next	1.4;

1.4
date	2007.01.14.21.53.01;	author simon;	state Exp;
branches;
next	1.3;

1.3
date	2006.04.11.15.11.33;	author naddy;	state Exp;
branches;
next	1.2;

1.2
date	2004.10.21.14.48.51;	author naddy;	state Exp;
branches;
next	1.1;

1.1
date	2004.06.20.16.27.49;	author naddy;	state Exp;
branches;
next	;


desc
@@


1.6
log
@Update to 1.2.
V1.2 adds nice "account set #" feature to manage accounts.
Remove a lot of string handling patches.
Remove patches to rename bitlbee "root" user to "bitlbee".

tested by Andrew Dalgleish (MAINTAINER), James Turner and Wiktor Izdebski
ok martynas@@, simon@@, okan@@, wcmaier@@
@
text
@$OpenBSD: patch-irc_c,v 1.5 2007/11/19 11:44:33 martynas Exp $
--- irc.c.orig	Mon Aug 20 16:34:05 2007
+++ irc.c	Mon Nov 19 13:39:01 2007
@@@@ -59,7 +59,7 @@@@ irc_t *irc_new( int fd )
 	irc->userhash = g_hash_table_new( g_str_hash, g_str_equal );
 	irc->watches = g_hash_table_new( g_str_hash, g_str_equal );
 	
-	strcpy( irc->umode, UMODE );
+	strlcpy( irc->umode, UMODE, sizeof(irc->umode) );
 	irc->mynick = g_strdup( ROOT_NICK );
 	irc->channel = g_strdup( ROOT_CHAN );
 	
@@@@ -117,9 +117,9 @@@@ irc_t *irc_new( int fd )
 	set_add( irc, "buddy_sendbuffer_delay", "200", set_eval_int );
 	set_add( irc, "charset", "iso8859-1", set_eval_charset );
 	set_add( irc, "debug", "false", set_eval_bool );
-	set_add( irc, "default_target", "root", NULL );
+	set_add( irc, "default_target", ROOT_NICK, NULL );
 	set_add( irc, "display_namechanges", "false", set_eval_bool );
-	set_add( irc, "handle_unknown", "root", NULL );
+	set_add( irc, "handle_unknown", ROOT_NICK, NULL );
 	set_add( irc, "lcnicks", "true", set_eval_bool );
 	set_add( irc, "ops", "both", set_eval_ops );
 	set_add( irc, "private", "true", set_eval_bool );
@@@@ -617,7 +617,7 @@@@ int irc_exec( irc_t *irc, char **cmd )
 				
 				if( g_strcasecmp( t, "last" ) == 0 && irc->last_target )
 					cmd[1] = irc->last_target;
-				else if( g_strcasecmp( t, "root" ) == 0 )
+				else if( g_strcasecmp( t, ROOT_NICK ) == 0  || g_strcasecmp( t, "root" ) == 0 )
 					cmd[1] = irc->mynick;
 				
 				for( i = 0; i < strlen( cmd[2] ); i ++ )
@@@@ -704,8 +704,8 @@@@ int irc_exec( irc_t *irc, char **cmd )
 					if( lenleft < 0 )
 						break;
 					
-					strcat( buff, u->nick );
-					strcat( buff, " " );
+					strlcat( buff, u->nick, sizeof(buff) );
+					strlcat( buff, " ", sizeof(buff) );
 				}
 				
 				if( next )
@@@@ -865,7 +865,7 @@@@ void irc_reply( irc_t *irc, int code, char *format, ..
 	va_list params;
 	
 	va_start( params, format );
-	g_vsnprintf( text, IRC_MAX_LINE, format, params );
+	g_vsnprintf( text, sizeof(text), format, params );
 	va_end( params );
 	irc_write( irc, ":%s %03d %s %s", irc->myhost, code, irc->nick?irc->nick:"*", text );
 	
@@@@ -919,14 +919,14 @@@@ void irc_vawrite( irc_t *irc, char *format, va_list pa
 		
 		conv[IRC_MAX_LINE] = 0;
 		if( do_iconv( "UTF-8", cs, line, conv, 0, IRC_MAX_LINE - 2 ) != -1 )
-			strcpy( line, conv );
+			strlcpy( line, conv, sizeof(line) );
 	}
-	strcat( line, "\r\n" );
+	strlcat( line, "\r\n", sizeof(line) );
 	
 	if( irc->sendbuffer != NULL ) {
-		size = strlen( irc->sendbuffer ) + strlen( line );
-		irc->sendbuffer = g_renew ( char, irc->sendbuffer, size + 1 );
-		strcpy( ( irc->sendbuffer + strlen( irc->sendbuffer ) ), line );
+		size = strlen( irc->sendbuffer ) + strlen( line ) + 1;
+		irc->sendbuffer = g_renew ( char, irc->sendbuffer, size );
+		strlcat( irc->sendbuffer, line, size);
 	}
 	else 
 		irc->sendbuffer = g_strdup(line);	
@@@@ -996,7 +996,7 @@@@ void irc_names( irc_t *irc, char *channel )
 			}
 			else if( !u->gc )
 			{
-				if( strcmp( u->nick, irc->mynick ) == 0 && ( strcmp( set_getstr( irc, "ops" ), "root" ) == 0 || strcmp( set_getstr( irc, "ops" ), "both" ) == 0 ) )
+				if( strcmp( u->nick, irc->mynick ) == 0 && ( strcmp( set_getstr( irc, "ops" ), ROOT_NICK ) == 0 || strcmp( set_getstr( irc, "ops" ), "root" ) == 0 || strcmp( set_getstr( irc, "ops" ), "both" ) == 0 ) )
 					s = "@@";
 				else if( strcmp( u->nick, irc->nick ) == 0 && ( strcmp( set_getstr( irc, "ops" ), "user" ) == 0 || strcmp( set_getstr( irc, "ops" ), "both" ) == 0 ) )
 					s = "@@";
@@@@ -1116,15 +1116,19 @@@@ void irc_motd( irc_t *irc )
 		irc_reply( irc, 375, ":- %s Message Of The Day - ", irc->myhost );
 		while( read( fd, linebuf + len, 1 ) == 1 )
 		{
-			if( linebuf[len] == '\n' || len == max )
+			/* If we have a LF, output the line and START AGAIN */
+			if( linebuf[len] == '\n')
 			{
 				linebuf[len] = 0;
 				irc_reply( irc, 372, ":- %s", linebuf );
 				len = 0;
+				continue;
 			}
-			else if( linebuf[len] == '%' )
+
+			if( linebuf[len] == '%' )
 			{
-				read( fd, linebuf + len, 1 );
+				if (read( fd, linebuf + len, 1 ) != 1)
+					break;
 				if( linebuf[len] == 'h' )
 					add = irc->myhost;
 				else if( linebuf[len] == 'v' )
@@@@ -1133,14 +1137,30 @@@@ void irc_motd( irc_t *irc )
 					add = irc->nick;
 				else
 					add = "%";
-				
-				strncpy( linebuf + len, add, max - len );
+
+				/* If the expanded string would be too long, output the line */
+				if ((len + strlen(add)) > max) {
+					linebuf[len] = 0;
+					irc_reply( irc, 372, ":- %s", linebuf );
+					len = 0;
+				}
+
+				/* Append the string to the line */
+				strlcpy( linebuf + len, add, max - len );
 				while( linebuf[++len] );
 			}
-			else if( len < max )
+			else
 			{
 				len ++;
 			}
+
+			/* If we have reached the maximum, output the line */
+			if( len == max )
+			{
+				linebuf[len] = 0;
+				irc_reply( irc, 372, ":- %s", linebuf );
+				len = 0;
+			}
 		}
 		irc_reply( irc, 376, ":End of MOTD" );
 		close( fd );
@@@@ -1471,8 +1491,8 @@@@ int buddy_send_handler( irc_t *irc, user_t *u, char *m
 			u->sendbuf = g_renew ( char, u->sendbuf, u->sendbuf_len );
 		}
 		
-		strcat( u->sendbuf, msg );
-		strcat( u->sendbuf, "\n" );
+		strlcat( u->sendbuf, msg, u->sendbuf_len );
+		strlcat( u->sendbuf, "\n", u->sendbuf_len );
 		
 		delay = set_getint( irc, "buddy_sendbuffer_delay" );
 		if( delay <= 5 )
@


1.5
log
@update to bitlbee-1.0.4
ok simon@@ and maintainer Andrew Dalgleish;  tested by Wiktor Izdebski
@
text
@d1 1
a1 1
$OpenBSD: patch-irc_c,v 1.4 2007/01/14 21:53:01 simon Exp $
@


1.4
log
@update to version 1.0.3

from Martynas Venckus <martynas at altroot dot org>
@
text
@d1 3
a3 3
$OpenBSD: patch-irc_c,v 1.3 2006/04/11 15:11:33 naddy Exp $
--- irc.c.orig	Sat Jun 24 17:00:43 2006
+++ irc.c	Fri Dec 15 21:21:27 2006
d25 1
a25 1
@@@@ -621,7 +621,7 @@@@ int irc_exec( irc_t *irc, char **cmd )
d34 1
a34 1
@@@@ -708,8 +708,8 @@@@ int irc_exec( irc_t *irc, char **cmd )
d45 1
a45 1
@@@@ -869,7 +869,7 @@@@ void irc_reply( irc_t *irc, int code, ch
d54 1
a54 1
@@@@ -923,14 +923,14 @@@@ void irc_vawrite( irc_t *irc, char *form
d74 1
a74 1
@@@@ -1000,7 +1000,7 @@@@ void irc_names( irc_t *irc, char *channe
d83 1
a83 1
@@@@ -1120,15 +1120,19 @@@@ void irc_motd( irc_t *irc )
d106 1
a106 1
@@@@ -1137,14 +1141,30 @@@@ void irc_motd( irc_t *irc )
d140 1
a140 1
@@@@ -1475,8 +1495,8 @@@@ int buddy_send_handler( irc_t *irc, user
@


1.3
log
@update to 1.0.2; from maintainer Andrew Dalgleish
@
text
@d1 3
a3 3
$OpenBSD: patch-irc_c,v 1.2 2004/10/21 14:48:51 naddy Exp $
--- irc.c.orig	Sun Apr  2 04:53:39 2006
+++ irc.c	Thu Apr  6 23:42:45 2006
d34 9
a42 3
@@@@ -709,8 +709,8 @@@@ int irc_exec( irc_t *irc, char **cmd )
 				 * cares?
 				 */
d44 2
a45 8
-				strcat( buff, u->nick );
-				strcat( buff, " " );
+				strlcat( buff, u->nick, sizeof(buff) );
+				strlcat( buff, " ", sizeof(buff) );
 			}
 		}
 		
@@@@ -861,7 +861,7 @@@@ void irc_reply( irc_t *irc, int code, ch
d54 1
a54 1
@@@@ -915,14 +915,14 @@@@ void irc_vawrite( irc_t *irc, char *form
d74 1
a74 1
@@@@ -992,7 +992,7 @@@@ void irc_names( irc_t *irc, char *channe
d83 1
a83 1
@@@@ -1112,15 +1112,19 @@@@ void irc_motd( irc_t *irc )
d106 1
a106 1
@@@@ -1129,14 +1133,30 @@@@ void irc_motd( irc_t *irc )
d140 1
a140 1
@@@@ -1467,8 +1487,8 @@@@ int buddy_send_handler( irc_t *irc, user
@


1.2
log
@Updated to 0.91; from Andrew Dalgleish <openbsd@@ajd.net.au>.
@
text
@d1 4
a4 5
$OpenBSD: patch-irc_c,v 1.1 2004/06/20 16:27:49 naddy Exp $
--- irc.c.orig	Sat Sep 25 04:48:04 2004
+++ irc.c	Thu Oct 14 15:43:33 2004
@@@@ -44,7 +44,7 @@@@ irc_t *irc_new( int fd )
 	
d6 1
d13 22
a34 34
@@@@ -282,7 +282,7 @@@@ int irc_fill_buffer( irc_t *irc ) 
 	
 	while( select( irc->fd + 1, readfds, NULL, NULL, tv ) > 0 )
 	{
-		st = read( irc->fd, line, 255 );
+		st = read( irc->fd, line, sizeof(line)-1);
 		if( st <= 0 )
 			return( 0 );
 		line[st]='\0';
@@@@ -290,8 +290,9 @@@@ int irc_fill_buffer( irc_t *irc ) 
 			irc->readbuffer = g_strdup( line );
 		else 
 		{
-			irc->readbuffer = bitlbee_realloc(irc->readbuffer, strlen( irc->readbuffer ) + strlen ( line ) + 1 );
-			strcpy( ( irc->readbuffer+strlen( irc->readbuffer ) ), line ); 
+			size_t new_len  = strlen(irc->readbuffer) + strlen(line) + 1;
+			irc->readbuffer = bitlbee_realloc(irc->readbuffer, new_len);
+			strlcat( irc->readbuffer, line, new_len ); 
 		}
 	}
 	return 1;
@@@@ -353,8 +354,9 @@@@ int irc_write_buffer( irc_t *irc ) 
 		}
 		else
 		{
-			temp = bitlbee_alloc( size - st + 1 );
-			strcpy( temp, ( irc->sendbuffer + st ) );
+			size_t new_len = size - st + 1;
+			temp = bitlbee_alloc( new_len );
+			strlcpy( temp, ( irc->sendbuffer + st ), new_len );
 			g_free( irc->sendbuffer );
 			irc->sendbuffer = temp;
 		}
@@@@ -718,8 +720,8 @@@@ int irc_exec( irc_t *irc, char **cmd )
d45 1
a45 1
@@@@ -828,7 +830,7 @@@@ void irc_reply( irc_t *irc, int code, ch
d54 7
a60 8
@@@@ -871,9 +873,10 @@@@ void irc_vawrite( irc_t *irc, char *form
 	if( irc->quit )
 		return;
 
-	g_vsnprintf( line, IRC_MAX_LINE - 3, format, params );
+	/* allow 2 for \r\n */
+	g_vsnprintf( line, sizeof(line)-2, format, params );
 
d63 1
a63 1
 
d65 2
a66 5
 		size=strlen( irc->sendbuffer ) + strlen( line );
@@@@ -893,7 +896,7 @@@@ void irc_vawrite( irc_t *irc, char *form
 		}
 #endif
 		irc->sendbuffer=bitlbee_realloc( irc->sendbuffer, size + 1 );
d68 3
a70 1
+		strlcat( irc->sendbuffer, line, size+1 );
d74 10
a83 1
@@@@ -1063,15 +1066,19 @@@@ void irc_motd( irc_t *irc )
d106 1
a106 1
@@@@ -1080,14 +1087,30 @@@@ void irc_motd( irc_t *irc )
d139 3
a141 3
 		closesocket( fd );
@@@@ -1361,8 +1384,8 @@@@ int buddy_send_handler( irc_t *irc, user
 			u->sendbuf = bitlbee_realloc( u->sendbuf, u->sendbuf_len );
d149 2
a150 11
 		if( u->sendbuf_timer > 0 )
 			g_source_remove( u->sendbuf_timer );
@@@@ -1426,7 +1449,7 @@@@ int irc_msgfrom( irc_t *irc, char *nick,
 	
 	if( !u->is_private && nick_cmp( u->nick, irc->mynick ) != 0 )
 	{
-		int len = strlen( irc->nick) + 3;
+		size_t len = strlen( irc->nick) + 3;
 		prefix = bitlbee_alloc( len );
 		g_snprintf( prefix, len, "%s%s", irc->nick, set_getstr( irc, "to_char" ) );
 		prefix[len-1] = 0;
@


1.1
log
@Update to 0.90.
Partial audit for string handling.

From: Andrew Dalgleish <openbsd@@ajd.net.au>
@
text
@d1 3
a3 3
$OpenBSD$
--- irc.c.orig	2004-05-15 23:15:12.000000000 +1000
+++ irc.c	2004-06-09 22:09:00.000000000 +1000
d13 1
a13 1
@@@@ -299,7 +299,7 @@@@ int irc_fill_buffer( irc_t *irc ) 
d22 1
a22 1
@@@@ -307,8 +307,9 @@@@ int irc_fill_buffer( irc_t *irc ) 
d34 1
a34 1
@@@@ -370,8 +371,9 @@@@ int irc_write_buffer( irc_t *irc ) 
d46 1
a46 1
@@@@ -735,8 +737,8 @@@@ int irc_exec( irc_t *irc, char **cmd )
d57 1
a57 1
@@@@ -845,7 +847,7 @@@@ void irc_reply( irc_t *irc, int code, ch
d66 1
a66 1
@@@@ -888,9 +890,10 @@@@ void irc_vawrite( irc_t *irc, char *form
d79 1
a79 1
@@@@ -910,7 +913,7 @@@@ void irc_vawrite( irc_t *irc, char *form
d88 1
a88 1
@@@@ -1080,15 +1083,19 @@@@ void irc_motd( irc_t *irc )
d111 1
a111 1
@@@@ -1097,14 +1104,30 @@@@ void irc_motd( irc_t *irc )
d145 1
a145 1
@@@@ -1367,8 +1390,8 @@@@ int buddy_send_handler( irc_t *irc, user
d156 1
a156 1
@@@@ -1432,7 +1455,7 @@@@ int irc_msgfrom( irc_t *irc, char *nick,
@

