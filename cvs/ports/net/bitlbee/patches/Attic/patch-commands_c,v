head	1.6;
access;
symbols
	OPENBSD_4_3:1.5.0.2
	OPENBSD_4_3_BASE:1.5
	OPENBSD_4_2:1.4.0.4
	OPENBSD_4_2_BASE:1.4
	OPENBSD_4_1:1.4.0.2
	OPENBSD_4_1_BASE:1.4
	OPENBSD_4_0:1.3.0.2
	OPENBSD_4_0_BASE:1.3
	OPENBSD_3_9:1.2.0.6
	OPENBSD_3_9_BASE:1.2
	OPENBSD_3_8:1.2.0.4
	OPENBSD_3_8_BASE:1.2
	OPENBSD_3_7:1.2.0.2
	OPENBSD_3_7_BASE:1.2
	OPENBSD_3_6:1.1.0.2
	OPENBSD_3_6_BASE:1.1;
locks; strict;
comment	@# @;


1.6
date	2008.04.09.22.13.12;	author merdely;	state dead;
branches;
next	1.5;

1.5
date	2007.11.19.11.44.33;	author martynas;	state Exp;
branches;
next	1.4;

1.4
date	2007.01.14.21.53.01;	author simon;	state Exp;
branches;
next	1.3;

1.3
date	2006.04.11.15.11.33;	author naddy;	state Exp;
branches;
next	1.2;

1.2
date	2004.10.21.14.48.51;	author naddy;	state Exp;
branches;
next	1.1;

1.1
date	2004.06.20.16.27.49;	author naddy;	state Exp;
branches;
next	;


desc
@@


1.6
log
@Update to 1.2.
V1.2 adds nice "account set #" feature to manage accounts.
Remove a lot of string handling patches.
Remove patches to rename bitlbee "root" user to "bitlbee".

tested by Andrew Dalgleish (MAINTAINER), James Turner and Wiktor Izdebski
ok martynas@@, simon@@, okan@@, wcmaier@@
@
text
@$OpenBSD: patch-commands_c,v 1.5 2007/11/19 11:44:33 martynas Exp $
--- commands.c.orig	Mon Aug 20 16:27:13 2007
+++ commands.c	Mon Nov 19 13:39:01 2007
@@@@ -63,8 +63,8 @@@@ int cmd_help( irc_t *irc, char **cmd )
 	memset( param, 0, sizeof(param) );
 	for ( i = 1; (cmd[i] != NULL && ( strlen(param) < (sizeof(param)-1) ) ); i++ ) {
 		if ( i != 1 )	// prepend space except for the first parameter
-			strcat(param, " ");
-		strncat( param, cmd[i], sizeof(param) - strlen(param) - 1 );
+			strlcat(param, " ", sizeof(param));
+		strlcat( param, cmd[i], sizeof(param));
 	}
 
 	s = help_get( &(global.help), param );
@@@@ -118,10 +118,10 @@@@ int cmd_register( irc_t *irc, char **cmd )
 		return( 0 );
 	}
 	
-	g_snprintf( path, 511, "%s%s%s", global.conf->configdir, irc->nick, ".accounts" );
+	g_snprintf( path, sizeof(path), "%s%s%s", global.conf->configdir, irc->nick, ".accounts" );
 	checkie = access( path, F_OK );
 	
-	g_snprintf( path, 511, "%s%s%s", global.conf->configdir, irc->nick, ".nicks" );
+	g_snprintf( path, sizeof(path), "%s%s%s", global.conf->configdir, irc->nick, ".nicks" );
 	checkie += access( path, F_OK );
 	
 	if( checkie == -2 )
@@@@ -143,7 +143,7 @@@@ int cmd_drop( irc_t *irc, char **cmd )
 	char s[512];
 	FILE *fp;
 	
-	g_snprintf( s, 511, "%s%s%s", global.conf->configdir, irc->nick, ".accounts" );
+	g_snprintf( s, sizeof(s), "%s%s%s", global.conf->configdir, irc->nick, ".accounts" );
 	fp = fopen( s, "r" );
 	if( !fp )
 	{
@@@@ -151,6 +151,7 @@@@ int cmd_drop( irc_t *irc, char **cmd )
 		return( 0 );
 	}
 	
+	COMPILE_TIME_ASSERT(32 < sizeof(s));
 	fscanf( fp, "%32[^\n]s", s );
 	fclose( fp );
 	if( setpass( irc, cmd[1], s ) < 0 )
@@@@ -159,10 +160,10 @@@@ int cmd_drop( irc_t *irc, char **cmd )
 		return( 0 );
 	}
 	
-	g_snprintf( s, 511, "%s%s%s", global.conf->configdir, irc->nick, ".accounts" );
+	g_snprintf( s, sizeof(s), "%s%s%s", global.conf->configdir, irc->nick, ".accounts" );
 	unlink( s );
 	
-	g_snprintf( s, 511, "%s%s%s", global.conf->configdir, irc->nick, ".nicks" );
+	g_snprintf( s, sizeof(s), "%s%s%s", global.conf->configdir, irc->nick, ".nicks" );
 	unlink( s );
 	
 	setpassnc( irc, NULL );
@@@@ -718,21 +719,21 @@@@ int cmd_blist( irc_t *irc, char **cmd )
 	
 	if( online == 1 ) for( u = irc->users; u; u = u->next ) if( u->gc && u->online && !u->away )
 	{
-		g_snprintf( s, 63, "%s@@%s (%s)", u->user, u->host, proto_name[u->gc->user->protocol] );
+		g_snprintf( s, sizeof(s), "%s@@%s (%s)", u->user, u->host, proto_name[u->gc->user->protocol] );
 		irc_usermsg( irc, "%-16.16s  %-40.40s  %s", u->nick, s, "Online" );
 		n_online ++;
 	}
 
 	if( away == 1 ) for( u = irc->users; u; u = u->next ) if( u->gc && u->online && u->away )
 	{
-		g_snprintf( s, 63, "%s@@%s (%s)", u->user, u->host, proto_name[u->gc->user->protocol] );
+		g_snprintf( s, sizeof(s), "%s@@%s (%s)", u->user, u->host, proto_name[u->gc->user->protocol] );
 		irc_usermsg( irc, "%-16.16s  %-40.40s  %s", u->nick, s, u->away );
 		n_away ++;
 	}
 	
 	if( offline == 1 ) for( u = irc->users; u; u = u->next ) if( u->gc && !u->online )
 	{
-		g_snprintf( s, 63, "%s@@%s (%s)", u->user, u->host, proto_name[u->gc->user->protocol] );
+		g_snprintf( s, sizeof(s), "%s@@%s (%s)", u->user, u->host, proto_name[u->gc->user->protocol] );
 		irc_usermsg( irc, "%-16.16s  %-40.40s  %s", u->nick, s, "Offline" );
 		n_offline ++;
 	}
@


1.5
log
@update to bitlbee-1.0.4
ok simon@@ and maintainer Andrew Dalgleish;  tested by Wiktor Izdebski
@
text
@d1 1
a1 1
$OpenBSD: patch-commands_c,v 1.4 2007/01/14 21:53:01 simon Exp $
@


1.4
log
@update to version 1.0.3

from Martynas Venckus <martynas at altroot dot org>
@
text
@d1 3
a3 3
$OpenBSD: patch-commands_c,v 1.3 2006/04/11 15:11:33 naddy Exp $
--- commands.c.orig	Sat Jun 24 17:00:43 2006
+++ commands.c	Fri Dec 15 21:20:07 2006
d15 1
a15 1
@@@@ -118,10 +118,10 @@@@ int cmd_register( irc_t *irc, char **cmd
@


1.3
log
@update to 1.0.2; from maintainer Andrew Dalgleish
@
text
@d1 3
a3 3
$OpenBSD: patch-commands_c,v 1.2 2004/10/21 14:48:51 naddy Exp $
--- commands.c.orig	Sun Apr  2 04:53:38 2006
+++ commands.c	Thu Apr  6 23:39:32 2006
d58 1
a58 1
@@@@ -706,21 +707,21 @@@@ int cmd_blist( irc_t *irc, char **cmd )
@


1.2
log
@Updated to 0.91; from Andrew Dalgleish <openbsd@@ajd.net.au>.
@
text
@d1 3
a3 3
$OpenBSD: patch-commands_c,v 1.1 2004/06/20 16:27:49 naddy Exp $
--- commands.c.orig	Tue Sep 21 07:07:16 2004
+++ commands.c	Fri Oct 15 14:30:16 2004
d58 1
a58 1
@@@@ -663,21 +664,21 @@@@ int cmd_blist( irc_t *irc, char **cmd )
@


1.1
log
@Update to 0.90.
Partial audit for string handling.

From: Andrew Dalgleish <openbsd@@ajd.net.au>
@
text
@d1 3
a3 3
$OpenBSD$
--- commands.c.orig	2004-05-12 21:36:25.000000000 +1000
+++ commands.c	2004-06-08 19:59:37.000000000 +1000
d15 1
a15 9
@@@@ -111,6 +111,7 @@@@ int cmd_register( irc_t *irc, char **cmd
 {
 	int checkie;
 	char *path, *file;
+	size_t file_len;
 	
 	if( global.conf->authmode == AUTHMODE_REGISTERED )
 	{
@@@@ -118,17 +119,18 @@@@ int cmd_register( irc_t *irc, char **cmd
d19 11
a29 23
-	file = (char *) bitlbee_alloc( strlen( irc->nick ) + strlen( ".accounts" ) + 1 );
+	file_len = strlen( irc->nick ) + strlen( ".accounts" ) + 1;
+	file = (char *) bitlbee_alloc( file_len );
 	
-	strcpy( file, irc->nick );
-	strcat( file, ".accounts" );
+	strlcpy( file, irc->nick,   file_len );
+	strlcat( file, ".accounts", file_len );
 	path = g_build_path( G_DIR_SEPARATOR_S, global.conf->configdir, file, NULL );
 	
 	checkie = g_file_test( path, G_FILE_TEST_EXISTS ) ? 0 : -1 ;
 	g_free( path );
 	
-	strcpy( file, irc->nick );
-	strcat( file, ".nicks" );
+	strlcpy( file, irc->nick, file_len );
+	strlcat( file, ".nicks",  file_len );
 	path = g_build_path( G_DIR_SEPARATOR_S, global.conf->configdir, file, NULL );
 	
 	checkie += g_file_test( path, G_FILE_TEST_EXISTS ) ? 0 : -1;
@@@@ -154,11 +156,13 @@@@ int cmd_drop( irc_t *irc, char **cmd )
 {
 	char *path, *file, s[512];
a30 1
+	size_t file_len;
d32 6
a37 12
-	file = (char *) bitlbee_alloc( strlen( irc->nick ) + strlen( ".accounts" ) + 1 );
+	file_len = strlen( irc->nick ) + strlen( ".accounts" ) + 1;
+	file = (char *) bitlbee_alloc( file_len );
 	
-	strcpy( file, irc->nick );
-	strcat( file, ".accounts" );
+	strlcpy( file, irc->nick,   file_len );
+	strlcat( file, ".accounts", file_len );
 	path = g_build_path( G_DIR_SEPARATOR_S, global.conf->configdir, file, NULL );
 	
 	fp = fopen( path, "r" );
@@@@ -170,6 +174,7 @@@@ int cmd_drop( irc_t *irc, char **cmd )
d45 11
a55 9
@@@@ -183,8 +188,8 @@@@ int cmd_drop( irc_t *irc, char **cmd )
 	unlink( path );
 	g_free( path );
 	
-	strcpy( file, irc->nick );
-	strcat( file, ".nicks" );
+	strlcpy( file, irc->nick, file_len );
+	strlcat( file, ".nicks",  file_len );
 	path = g_build_path( G_DIR_SEPARATOR_S, global.conf->configdir, file, NULL );
d57 2
a58 2
 	unlink( path );
@@@@ -676,21 +681,21 @@@@ int cmd_blist( irc_t *irc, char **cmd )
@

