head	1.6;
access;
symbols
	OPENBSD_4_3:1.5.0.2
	OPENBSD_4_3_BASE:1.5
	OPENBSD_4_2:1.4.0.6
	OPENBSD_4_2_BASE:1.4
	OPENBSD_4_1:1.4.0.4
	OPENBSD_4_1_BASE:1.4
	OPENBSD_4_0:1.4.0.2
	OPENBSD_4_0_BASE:1.4
	OPENBSD_3_9:1.3.0.6
	OPENBSD_3_9_BASE:1.3
	OPENBSD_3_8:1.3.0.4
	OPENBSD_3_8_BASE:1.3
	OPENBSD_3_7:1.3.0.2
	OPENBSD_3_7_BASE:1.3
	OPENBSD_3_6:1.2.0.2
	OPENBSD_3_6_BASE:1.2;
locks; strict;
comment	@# @;


1.6
date	2008.04.09.22.13.12;	author merdely;	state dead;
branches;
next	1.5;

1.5
date	2007.11.19.11.44.33;	author martynas;	state Exp;
branches;
next	1.4;

1.4
date	2006.04.11.15.11.33;	author naddy;	state Exp;
branches;
next	1.3;

1.3
date	2004.10.21.14.48.51;	author naddy;	state Exp;
branches;
next	1.2;

1.2
date	2004.07.01.16.11.59;	author naddy;	state Exp;
branches;
next	1.1;

1.1
date	2004.06.20.16.27.49;	author naddy;	state Exp;
branches;
next	;


desc
@@


1.6
log
@Update to 1.2.
V1.2 adds nice "account set #" feature to manage accounts.
Remove a lot of string handling patches.
Remove patches to rename bitlbee "root" user to "bitlbee".

tested by Andrew Dalgleish (MAINTAINER), James Turner and Wiktor Izdebski
ok martynas@@, simon@@, okan@@, wcmaier@@
@
text
@$OpenBSD: patch-protocols_yahoo_libyahoo2_c,v 1.5 2007/11/19 11:44:33 martynas Exp $
--- protocols/yahoo/libyahoo2.c.orig	Mon Aug 20 16:27:16 2007
+++ protocols/yahoo/libyahoo2.c	Mon Nov 19 13:39:01 2007
@@@@ -634,7 +634,7 @@@@ static void yahoo_packet_read(struct yahoo_packet *pkt
 	}
 }
 
-static void yahoo_packet_write(struct yahoo_packet *pkt, unsigned char *data)
+static void yahoo_packet_write(struct yahoo_packet *pkt, unsigned char *data, size_t data_len)
 {
 	YList *l;
 	int pos = 0;
@@@@ -644,12 +644,12 @@@@ static void yahoo_packet_write(struct yahoo_packet *pk
 		unsigned char buf[100];
 
 		snprintf((char *)buf, sizeof(buf), "%d", pair->key);
-		strcpy((char *)data + pos, (char *)buf);
+		strlcpy((char *)data + pos, (char *)buf, data_len - pos);
 		pos += strlen((char *)buf);
 		data[pos++] = 0xc0;
 		data[pos++] = 0x80;
 
-		strcpy((char *)data + pos, pair->value);
+		strlcpy((char *)data + pos, pair->value, data_len - pos);
 		pos += strlen(pair->value);
 		data[pos++] = 0xc0;
 		data[pos++] = 0x80;
@@@@ -758,7 +758,7 @@@@ static void yahoo_send_packet(struct yahoo_input_data 
 	pos += yahoo_put32(data + pos, pkt->status);
 	pos += yahoo_put32(data + pos, pkt->id);
 
-	yahoo_packet_write(pkt, data + pos);
+	yahoo_packet_write(pkt, data + pos, len - pos);
 
 	yahoo_packet_dump(data, len);
 	
@@@@ -1557,8 +1557,10 @@@@ static void yahoo_process_auth_pre_0x0b(struct yahoo_i
 	char *crypt_result;
 	unsigned char *password_hash = malloc(25);
 	unsigned char *crypt_hash = malloc(25);
-	unsigned char *hash_string_p = malloc(50 + strlen(sn));
-	unsigned char *hash_string_c = malloc(50 + strlen(sn));
+	size_t p_len = 50 + strlen(sn);
+	size_t c_len = 50 + strlen(sn);
+	unsigned char *hash_string_p = malloc(p_len);
+	unsigned char *hash_string_c = malloc(c_len);
 	
 	char checksum;
 	
@@@@ -1585,37 +1587,37 @@@@ static void yahoo_process_auth_pre_0x0b(struct yahoo_i
 	switch (sv) {
 	case 0:
 		checksum = seed[seed[7] % 16];
-		snprintf((char *)hash_string_p, strlen(sn) + 50,
+		snprintf((char *)hash_string_p, p_len,
 			"%c%s%s%s", checksum, password_hash, yd->user, seed);
-		snprintf((char *)hash_string_c, strlen(sn) + 50,
+		snprintf((char *)hash_string_c, c_len,
 			"%c%s%s%s", checksum, crypt_hash, yd->user, seed);
 		break;
 	case 1:
 		checksum = seed[seed[9] % 16];
-		snprintf((char *)hash_string_p, strlen(sn) + 50,
+		snprintf((char *)hash_string_p, p_len,
 			"%c%s%s%s", checksum, yd->user, seed, password_hash);
-		snprintf((char *)hash_string_c, strlen(sn) + 50,
+		snprintf((char *)hash_string_c, c_len,
 			"%c%s%s%s", checksum, yd->user, seed, crypt_hash);
 		break;
 	case 2:
 		checksum = seed[seed[15] % 16];
-		snprintf((char *)hash_string_p, strlen(sn) + 50,
+		snprintf((char *)hash_string_p, p_len,
 			"%c%s%s%s", checksum, seed, password_hash, yd->user);
-		snprintf((char *)hash_string_c, strlen(sn) + 50,
+		snprintf((char *)hash_string_c, c_len,
 			"%c%s%s%s", checksum, seed, crypt_hash, yd->user);
 		break;
 	case 3:
 		checksum = seed[seed[1] % 16];
-		snprintf((char *)hash_string_p, strlen(sn) + 50,
+		snprintf((char *)hash_string_p, p_len,
 			"%c%s%s%s", checksum, yd->user, password_hash, seed);
-		snprintf((char *)hash_string_c, strlen(sn) + 50,
+		snprintf((char *)hash_string_c, c_len,
 			"%c%s%s%s", checksum, yd->user, crypt_hash, seed);
 		break;
 	case 4:
 		checksum = seed[seed[3] % 16];
-		snprintf((char *)hash_string_p, strlen(sn) + 50,
+		snprintf((char *)hash_string_p, p_len,
 			"%c%s%s%s", checksum, password_hash, seed, yd->user);
-		snprintf((char *)hash_string_c, strlen(sn) + 50,
+		snprintf((char *)hash_string_c, c_len,
 			"%c%s%s%s", checksum, crypt_hash, seed, yd->user);
 		break;
 	}
@@@@ -1941,29 +1943,29 @@@@ static void yahoo_process_auth_0x0b(struct yahoo_input
 		lookup &= 0x1f;
 		if (lookup >= strlen(alphabet1))
 			break;
-		sprintf(byte, "%c", alphabet1[lookup]);
-		strcat(resp_6, byte);
-		strcat(resp_6, "=");
+		snprintf(byte, sizeof(byte), "%c", alphabet1[lookup]);
+		strlcat(resp_6, byte, sizeof(resp_6));
+		strlcat(resp_6, "=",  sizeof(resp_6));
 
 		lookup = (val >> 0x06);
 		lookup &= 0x1f;
 		if (lookup >= strlen(alphabet2))
 			break;
-		sprintf(byte, "%c", alphabet2[lookup]);
-		strcat(resp_6, byte);
+		snprintf(byte, sizeof(byte), "%c", alphabet2[lookup]);
+		strlcat(resp_6, byte, sizeof(resp_6));
 
 		lookup = (val >> 0x01);
 		lookup &= 0x1f;
 		if (lookup >= strlen(alphabet2))
 			break;
-		sprintf(byte, "%c", alphabet2[lookup]);
-		strcat(resp_6, byte);
+		snprintf(byte, sizeof(byte), "%c", alphabet2[lookup]);
+		strlcat(resp_6, byte, sizeof(resp_6));
 
 		lookup = (val & 0x01);
 		if (lookup >= strlen(delimit_lookup))
 			break;
-		sprintf(byte, "%c", delimit_lookup[lookup]);
-		strcat(resp_6, byte);
+		snprintf(byte, sizeof(byte), "%c", delimit_lookup[lookup]);
+		strlcat(resp_6, byte, sizeof(resp_6));
 	}
 
 	/* Our second authentication response is based off 
@@@@ -2032,29 +2034,29 @@@@ static void yahoo_process_auth_0x0b(struct yahoo_input
 		lookup &= 0x1f;
 		if (lookup >= strlen(alphabet1))
 			break;
-		sprintf(byte, "%c", alphabet1[lookup]);
-		strcat(resp_96, byte);
-		strcat(resp_96, "=");
+		snprintf(byte, sizeof(byte), "%c", alphabet1[lookup]);
+		strlcat(resp_96, byte, sizeof(resp_96));
+		strlcat(resp_96, "=", sizeof(resp_96));
 
 		lookup = (val >> 0x06);
 		lookup &= 0x1f;
 		if (lookup >= strlen(alphabet2))
 			break;
-		sprintf(byte, "%c", alphabet2[lookup]);
-		strcat(resp_96, byte);
+		snprintf(byte, sizeof(byte), "%c", alphabet2[lookup]);
+		strlcat(resp_96, byte, sizeof(resp_96));
 
 		lookup = (val >> 0x01);
 		lookup &= 0x1f;
 		if (lookup >= strlen(alphabet2))
 			break;
-		sprintf(byte, "%c", alphabet2[lookup]);
-		strcat(resp_96, byte);
+		snprintf(byte, sizeof(byte), "%c", alphabet2[lookup]);
+		strlcat(resp_96, byte, sizeof(resp_96));
 
 		lookup = (val & 0x01);
 		if (lookup >= strlen(delimit_lookup))
 			break;
-		sprintf(byte, "%c", delimit_lookup[lookup]);
-		strcat(resp_96, byte);
+		snprintf(byte, sizeof(byte), "%c", delimit_lookup[lookup]);
+		strlcat(resp_96, byte, sizeof(resp_96));
 	}
 
 	pack = yahoo_packet_new(YAHOO_SERVICE_AUTHRESP, yd->initial_status, yd->session_id);
@@@@ -3075,11 +3077,9 @@@@ static void yahoo_process_yab_connection(struct yahoo_
 				if(yab->nname) {
 					bud->real_name = strdup(yab->nname);
 				} else if(yab->fname && yab->lname) {
-					bud->real_name = y_new0(char, 
-							strlen(yab->fname)+
-							strlen(yab->lname)+2
-							);
-					sprintf(bud->real_name, "%s %s",
+					size_t len = strlen(yab->fname) + strlen(yab->lname) + 2;
+					bud->real_name = y_new0(char,  len);
+					snprintf(bud->real_name, len, "%s %s",
 							yab->fname, yab->lname);
 				} else if(yab->fname) {
 					bud->real_name = strdup(yab->fname);
@@@@ -3678,7 +3678,7 @@@@ void yahoo_get_yab(int id)
 	yid->yd = yd;
 	yid->type = YAHOO_CONNECTION_YAB;
 
-	snprintf(url, 1024, "http://insider.msg.yahoo.com/ycontent/?ab2=0");
+	snprintf(url, sizeof(url), "http://insider.msg.yahoo.com/ycontent/?ab2=0");
 
 	snprintf(buff, sizeof(buff), "Y=%s; T=%s",
 			yd->cookie_y, yd->cookie_t);
@@@@ -3705,63 +3705,63 @@@@ void yahoo_set_yab(int id, struct yab * yab)
 	yid->type = YAHOO_CONNECTION_YAB;
 	yid->yd = yd;
 
-	strncpy(url, "http://insider.msg.yahoo.com/ycontent/?addab2=0", size);
+	strlcpy(url, "http://insider.msg.yahoo.com/ycontent/?addab2=0", size);
 
 	if(yab->dbid) {
 		/* change existing yab */
 		char tmp[32];
-		strncat(url, "&ee=1&ow=1&id=", size - strlen(url));
+		strlcat(url, "&ee=1&ow=1&id=", sizeof(url));
 		snprintf(tmp, sizeof(tmp), "%d", yab->dbid);
-		strncat(url, tmp, size - strlen(url));
+		strlcat(url, tmp, sizeof(url));
 	}
 
 	if(yab->fname) {
-		strncat(url, "&fn=", size - strlen(url));
+		strlcat(url, "&fn=", sizeof(url));
 		temp = yahoo_urlencode(yab->fname);
-		strncat(url, temp, size - strlen(url));
+		strlcat(url, temp, sizeof(url));
 		free(temp);
 	}
 	if(yab->lname) {
-		strncat(url, "&ln=", size - strlen(url));
+		strlcat(url, "&ln=", sizeof(url));
 		temp = yahoo_urlencode(yab->lname);
-		strncat(url, temp, size - strlen(url));
+		strlcat(url, temp, sizeof(url));
 		free(temp);
 	}
-	strncat(url, "&yid=", size - strlen(url));
+	strlcat(url, "&yid=", sizeof(url));
 	temp = yahoo_urlencode(yab->id);
-	strncat(url, temp, size - strlen(url));
+	strlcat(url, temp, sizeof(url));
 	free(temp);
 	if(yab->nname) {
-		strncat(url, "&nn=", size - strlen(url));
+		strlcat(url, "&nn=", sizeof(url));
 		temp = yahoo_urlencode(yab->nname);
-		strncat(url, temp, size - strlen(url));
+		strlcat(url, temp, sizeof(url));
 		free(temp);
 	}
 	if(yab->email) {
-		strncat(url, "&e=", size - strlen(url));
+		strlcat(url, "&e=", sizeof(url));
 		temp = yahoo_urlencode(yab->email);
-		strncat(url, temp, size - strlen(url));
+		strlcat(url, temp, sizeof(url));
 		free(temp);
 	}
 	if(yab->hphone) {
-		strncat(url, "&hp=", size - strlen(url));
+		strlcat(url, "&hp=", sizeof(url));
 		temp = yahoo_urlencode(yab->hphone);
-		strncat(url, temp, size - strlen(url));
+		strlcat(url, temp, sizeof(url));
 		free(temp);
 	}
 	if(yab->wphone) {
-		strncat(url, "&wp=", size - strlen(url));
+		strlcat(url, "&wp=", sizeof(url));
 		temp = yahoo_urlencode(yab->wphone);
-		strncat(url, temp, size - strlen(url));
+		strlcat(url, temp, sizeof(url));
 		free(temp);
 	}
 	if(yab->mphone) {
-		strncat(url, "&mp=", size - strlen(url));
+		strlcat(url, "&mp=", sizeof(url));
 		temp = yahoo_urlencode(yab->mphone);
-		strncat(url, temp, size - strlen(url));
+		strlcat(url, temp, sizeof(url));
 		free(temp);
 	}
-	strncat(url, "&pp=0", size - strlen(url));
+	strlcat(url, "&pp=0", sizeof(url));
 
 	snprintf(buff, sizeof(buff), "Y=%s; T=%s",
 			yd->cookie_y, yd->cookie_t);
@@@@ -4132,9 +4132,9 @@@@ void yahoo_get_chatrooms(int id, int chatroomid)
 	yid->type = YAHOO_CONNECTION_CHATCAT;
 
 	if (chatroomid == 0) {
-		snprintf(url, 1024, "http://insider.msg.yahoo.com/ycontent/?chatcat=0");
+		snprintf(url, sizeof(url), "http://insider.msg.yahoo.com/ycontent/?chatcat=0");
 	} else {
-		snprintf(url, 1024, "http://insider.msg.yahoo.com/ycontent/?chatroom_%d=0",chatroomid);
+		snprintf(url, sizeof(url), "http://insider.msg.yahoo.com/ycontent/?chatroom_%d=0",chatroomid);
 	}
 
 	snprintf(buff, sizeof(buff), "Y=%s; T=%s", yd->cookie_y, yd->cookie_t);
@@@@ -4369,7 +4369,7 @@@@ static void yahoo_search_internal(int id, int t, const
 	while((p = strchr(ctext, ' ')))
 		*p = '+';
 
-	snprintf(url, 1024, "http://members.yahoo.com/interests?.oc=m&.kw=%s&.sb=%d&.g=%d&.ar=0%s%s%s",
+	snprintf(url, sizeof(url), "http://members.yahoo.com/interests?.oc=m&.kw=%s&.sb=%d&.g=%d&.ar=0%s%s%s",
 			ctext, t, g, photo ? "&.p=y" : "", yahoo_only ? "&.pg=y" : "",
 			startpos ? buff : "");
 
@


1.5
log
@update to bitlbee-1.0.4
ok simon@@ and maintainer Andrew Dalgleish;  tested by Wiktor Izdebski
@
text
@d1 1
a1 1
$OpenBSD: patch-protocols_yahoo_libyahoo2_c,v 1.4 2006/04/11 15:11:33 naddy Exp $
@


1.4
log
@update to 1.0.2; from maintainer Andrew Dalgleish
@
text
@d1 4
a4 4
$OpenBSD: patch-protocols_yahoo_libyahoo2_c,v 1.3 2004/10/21 14:48:51 naddy Exp $
--- protocols/yahoo/libyahoo2.c.orig	Wed Nov 30 23:07:40 2005
+++ protocols/yahoo/libyahoo2.c	Sun Jan 29 03:23:16 2006
@@@@ -634,7 +634,7 @@@@ static void yahoo_packet_read(struct yah
d13 1
a13 1
@@@@ -644,12 +644,12 @@@@ static void yahoo_packet_write(struct ya
d28 1
a28 1
@@@@ -758,7 +758,7 @@@@ static void yahoo_send_packet(struct yah
d37 1
a37 1
@@@@ -1557,8 +1557,10 @@@@ static void yahoo_process_auth_pre_0x0b(
d50 1
a50 1
@@@@ -1585,37 +1587,37 @@@@ static void yahoo_process_auth_pre_0x0b(
d98 1
a98 1
@@@@ -1941,29 +1943,29 @@@@ static void yahoo_process_auth_0x0b(stru
d137 1
a137 1
@@@@ -2032,29 +2034,29 @@@@ static void yahoo_process_auth_0x0b(stru
d176 1
a176 1
@@@@ -3075,11 +3077,9 @@@@ static void yahoo_process_yab_connection
d200 1
a200 1
@@@@ -3705,63 +3705,63 @@@@ void yahoo_set_yab(int id, struct yab * 
d284 1
a284 1
@@@@ -4132,9 +4132,9 @@@@ void yahoo_get_chatrooms(int id, int cha
d296 1
a296 1
@@@@ -4369,7 +4369,7 @@@@ static void yahoo_search_internal(int id
@


1.3
log
@Updated to 0.91; from Andrew Dalgleish <openbsd@@ajd.net.au>.
@
text
@d1 4
a4 4
$OpenBSD: patch-protocols_yahoo_libyahoo2_c,v 1.2 2004/07/01 16:11:59 naddy Exp $
--- protocols/yahoo/libyahoo2.c.orig	Sat Sep 25 21:26:09 2004
+++ protocols/yahoo/libyahoo2.c	Thu Oct 14 15:43:35 2004
@@@@ -638,7 +638,7 @@@@ static void yahoo_packet_read(struct yah
d13 1
a13 1
@@@@ -648,12 +648,12 @@@@ static void yahoo_packet_write(struct ya
d28 1
a28 1
@@@@ -762,7 +762,7 @@@@ static void yahoo_send_packet(struct yah
d37 1
a37 1
@@@@ -1561,8 +1561,10 @@@@ static void yahoo_process_auth_pre_0x0b(
d50 1
a50 1
@@@@ -1589,37 +1591,37 @@@@ static void yahoo_process_auth_pre_0x0b(
d98 1
a98 1
@@@@ -1945,29 +1947,29 @@@@ static void yahoo_process_auth_0x0b(stru
d137 1
a137 1
@@@@ -2036,29 +2038,29 @@@@ static void yahoo_process_auth_0x0b(stru
d176 1
a176 1
@@@@ -3079,11 +3081,9 @@@@ static void yahoo_process_yab_connection
d191 1
a191 1
@@@@ -3682,7 +3682,7 @@@@ void yahoo_get_yab(int id)
d200 1
a200 1
@@@@ -3709,63 +3709,63 @@@@ void yahoo_set_yab(int id, struct yab * 
d284 1
a284 1
@@@@ -4136,9 +4136,9 @@@@ void yahoo_get_chatrooms(int id, int cha
d296 1
a296 1
@@@@ -4373,7 +4373,7 @@@@ static void yahoo_search_internal(int id
@


1.2
log
@Update to 0.90a: fixes Yahoo support.
From: Andrew Dalgleish <openbsd@@ajd.net.au>
@
text
@d1 4
a4 4
$OpenBSD: patch-protocols_yahoo_libyahoo2_c,v 1.1 2004/06/20 16:27:49 naddy Exp $
--- protocols/yahoo/libyahoo2.c.orig	Sun Jun 27 16:50:35 2004
+++ protocols/yahoo/libyahoo2.c	Sun Jun 27 16:50:36 2004
@@@@ -626,7 +626,7 @@@@ static void yahoo_packet_read(struct yah
d13 1
a13 1
@@@@ -636,12 +636,12 @@@@ static void yahoo_packet_write(struct ya
d28 1
a28 1
@@@@ -750,7 +750,7 @@@@ static void yahoo_send_packet(struct yah
d37 1
a37 1
@@@@ -1549,8 +1549,10 @@@@ static void yahoo_process_auth_pre_0x0b(
d50 1
a50 1
@@@@ -1577,37 +1579,37 @@@@ static void yahoo_process_auth_pre_0x0b(
d98 1
a98 1
@@@@ -1933,29 +1935,29 @@@@ static void yahoo_process_auth_0x0b(stru
d137 1
a137 1
@@@@ -2024,29 +2026,29 @@@@ static void yahoo_process_auth_0x0b(stru
d176 1
a176 1
@@@@ -3067,11 +3069,9 @@@@ static void yahoo_process_yab_connection
d191 1
a191 1
@@@@ -3670,7 +3670,7 @@@@ void yahoo_get_yab(int id)
d200 1
a200 1
@@@@ -3697,63 +3697,63 @@@@ void yahoo_set_yab(int id, struct yab * 
d284 1
a284 1
@@@@ -4124,9 +4124,9 @@@@ void yahoo_get_chatrooms(int id, int cha
d296 1
a296 1
@@@@ -4361,7 +4361,7 @@@@ static void yahoo_search_internal(int id
@


1.1
log
@Update to 0.90.
Partial audit for string handling.

From: Andrew Dalgleish <openbsd@@ajd.net.au>
@
text
@d1 3
a3 3
$OpenBSD$
--- protocols/yahoo/libyahoo2.c.orig	2004-03-26 10:11:09.000000000 +1100
+++ protocols/yahoo/libyahoo2.c	2004-06-09 21:14:22.000000000 +1000
d98 1
a98 1
@@@@ -1931,29 +1933,29 @@@@ static void yahoo_process_auth_0x0b(stru
d137 1
a137 1
@@@@ -2020,29 +2022,29 @@@@ static void yahoo_process_auth_0x0b(stru
d176 1
a176 1
@@@@ -3063,11 +3065,9 @@@@ static void yahoo_process_yab_connection
d191 1
a191 1
@@@@ -3666,7 +3666,7 @@@@ void yahoo_get_yab(int id)
d200 1
a200 1
@@@@ -3693,63 +3693,63 @@@@ void yahoo_set_yab(int id, struct yab * 
d284 1
a284 1
@@@@ -4120,9 +4120,9 @@@@ void yahoo_get_chatrooms(int id, int cha
d296 1
a296 1
@@@@ -4357,7 +4357,7 @@@@ static void yahoo_search_internal(int id
@

