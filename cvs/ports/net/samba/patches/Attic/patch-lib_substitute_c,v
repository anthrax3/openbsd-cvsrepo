head	1.2;
access;
symbols
	OPENBSD_5_1_BASE:1.1
	OPENBSD_5_1:1.1.0.2;
locks; strict;
comment	@# @;


1.2
date	2012.02.16.21.36.08;	author sthen;	state dead;
branches;
next	1.1;

1.1
date	2012.01.31.09.12.59;	author sthen;	state Exp;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2012.04.11.14.14.29;	author sthen;	state dead;
branches;
next	;


desc
@@


1.2
log
@Update to samba 3.6.3; various bugfixes. From maintainer Ian McWilliam,
also tested by nigel@@.

This rolls in the DoS fix which we previously handled via a patch.
@
text
@$OpenBSD: patch-lib_substitute_c,v 1.1 2012/01/31 09:12:59 sthen Exp $

http://ftp.samba.org/pub/samba/patches/security/samba-3.6.2-CVE-2012-0817.patch

--- lib/substitute.c.orig	Tue Oct 18 19:48:48 2011
+++ lib/substitute.c	Tue Jan 31 08:45:43 2012
@@@@ -195,7 +195,7 @@@@ void sub_set_smb_name(const char *name)
 }
 
 static char sub_peeraddr[INET6_ADDRSTRLEN];
-static const char *sub_peername = "";
+static const char *sub_peername = NULL;
 static char sub_sockaddr[INET6_ADDRSTRLEN];
 
 void sub_set_socket_ids(const char *peeraddr, const char *peername,
@@@@ -208,6 +208,11 @@@@ void sub_set_socket_ids(const char *peeraddr, const ch
 	}
 	strlcpy(sub_peeraddr, addr, sizeof(sub_peeraddr));
 
+	if (sub_peername != NULL &&
+			sub_peername != sub_peeraddr) {
+		free(discard_const_p(char,sub_peername));
+		sub_peername = NULL;
+	}
 	sub_peername = SMB_STRDUP(peername);
 	if (sub_peername == NULL) {
 		sub_peername = sub_peeraddr;
@@@@ -646,7 +651,7 @@@@ static char *alloc_sub_basic(const char *smb_name, con
 			break;
 		case 'M' :
 			a_string = realloc_string_sub(a_string, "%M",
-						      sub_peername);
+						      sub_peername ? sub_peername : "");
 			break;
 		case 'R' :
 			a_string = realloc_string_sub(a_string, "%R", remote_proto);
@


1.1
log
@SECURITY fix for CVE-2012-0817, memory leak affecting samba 3.6.0 to 3.6.2
can cause DoS. Pointed out by maintainer.

http://ftp.samba.org/pub/samba/patches/security/samba-3.6.2-CVE-2012-0817.patch

ok ajacoutot@@
@
text
@d1 1
a1 1
$OpenBSD$
@


1.1.2.1
log
@MFC samba update to 5.1-stable. From Ian McWilliam.

*NASTY* security update to samba 3.6.4: remote code execution as root by
anonymous user.  https://www.samba.org/samba/security/CVE-2012-1182
@
text
@d1 1
a1 1
$OpenBSD: patch-lib_substitute_c,v 1.1 2012/01/31 09:12:59 sthen Exp $
@


