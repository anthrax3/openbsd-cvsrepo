head	1.1;
access;
symbols
	OPENBSD_6_0:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2017.03.27.23.26.24;	author jca;	state dead;
branches
	1.1.2.1;
next	;
commitid	d41s9RCNlh5gGwWp;

1.1.2.1
date	2017.03.27.23.26.24;	author jca;	state Exp;
branches;
next	;
commitid	d41s9RCNlh5gGwWp;


desc
@@


1.1
log
@file patch-source3_smbd_smb2_query_directory_c was initially added on branch OPENBSD_6_0.
@
text
@@


1.1.2.1
log
@SECURITY fixes for CVE-2017-2619

(Symlink race allows access outside share definition)
@
text
@a0 38
$OpenBSD$

CVE-2017-2619 (Symlink race allows access outside share definition)

--- source3/smbd/smb2_query_directory.c.orig	Sat Mar 25 17:19:26 2017
+++ source3/smbd/smb2_query_directory.c	Sat Mar 25 17:19:50 2017
@@@@ -24,6 +24,7 @@@@
 #include "../libcli/smb/smb_common.h"
 #include "trans2.h"
 #include "../lib/util/tevent_ntstatus.h"
+#include "system/filesys.h"
 
 static struct tevent_req *smbd_smb2_query_directory_send(TALLOC_CTX *mem_ctx,
 					      struct tevent_context *ev,
@@@@ -322,7 +323,23 @@@@ static struct tevent_req *smbd_smb2_query_directory_se
 	}
 
 	if (in_flags & SMB2_CONTINUE_FLAG_REOPEN) {
+		int flags;
+
 		dptr_CloseDir(fsp);
+
+		/*
+		 * dptr_CloseDir() will close and invalidate the fsp's file
+		 * descriptor, we have to reopen it.
+		 */
+
+		flags = O_RDONLY;
+#ifdef O_DIRECTORY
+		flags |= O_DIRECTORY;
+#endif
+		status = fd_open(conn, fsp, flags, 0);
+		if (tevent_req_nterror(req, status)) {
+			return tevent_req_post(req, ev);
+		}
 	}
 
 	if (!smbreq->posix_pathnames) {
@

