head	1.3;
access;
symbols
	OPENBSD_4_5:1.2.0.2
	OPENBSD_4_5_BASE:1.2;
locks; strict;
comment	@# @;


1.3
date	2009.03.17.15.35.37;	author sthen;	state dead;
branches;
next	1.2;

1.2
date	2009.01.23.11.01.06;	author sthen;	state Exp;
branches;
next	1.1;

1.1
date	2009.01.12.00.31.45;	author sthen;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Upgrade to 1.1.16, fixes several major causes of crashes.
"Upgrading is highly recommended."

From Brad (maintainer).
@
text
@$OpenBSD: patch-apps_silcd_command_reply_c,v 1.2 2009/01/23 11:01:06 sthen Exp $
--- apps/silcd/command_reply.c.orig	Sat Oct 25 09:59:17 2008
+++ apps/silcd/command_reply.c	Sat Jan 17 07:57:46 2009
@@@@ -236,6 +236,10 @@@@ silc_server_command_reply_whois_save(SilcServerCommand
     client->data.status &= ~SILC_IDLIST_STATUS_RESOLVING;
     client->mode = mode;
     client->servername = servername[0] ? strdup(servername) : NULL;
+
+    SILC_LOG_DEBUG(("stat.clients %d->%d", server->stat.clients,
+		    server->stat.clients + 1));
+    server->stat.clients++;
   } else {
     /* We have the client already, update the data */
 
@@@@ -660,6 +664,10 @@@@ silc_server_command_reply_identify_save(SilcServerComm
       client->data.status |= SILC_IDLIST_STATUS_REGISTERED;
       client->data.status |= SILC_IDLIST_STATUS_RESOLVED;
       client->data.status &= ~SILC_IDLIST_STATUS_RESOLVING;
+
+      SILC_LOG_DEBUG(("stat.clients %d->%d", server->stat.clients,
+		      server->stat.clients + 1));
+      server->stat.clients++;
     } else {
       /* We have the client already, update the data */
 
@@@@ -1241,6 +1249,8 @@@@ SILC_SERVER_CMD_REPLY_FUNC(stats)
 			 SILC_STR_UI_INT(&server->stat.router_ops),
 			 SILC_STR_END);
   }
+
+  SILC_LOG_DEBUG(("stat.clients = %d", server->stat.clients));
 
  out:
   SILC_SERVER_PENDING_EXEC(cmd, SILC_COMMAND_STATS);
@


1.2
log
@patch from upstream git via Brad; increment stat.clients statistics
whenever adding new client. Otherwise it is possible to go under zero
when removing clients from the server.
@
text
@d1 1
a1 1
$OpenBSD: patch-apps_silcd_command_reply_c,v 1.1 2009/01/12 00:31:45 sthen Exp $
@


1.1
log
@add patches from upstream git;
- Added debug logs for updating stat.clients value
- Take stream reference correctly in packet error callback

from Brad (maintainer).
@
text
@d1 27
a27 4
$OpenBSD$
--- apps/silcd/command_reply.c.orig	Fri Jan  9 22:23:02 2009
+++ apps/silcd/command_reply.c	Fri Jan  9 22:23:38 2009
@@@@ -1242,6 +1242,8 @@@@ SILC_SERVER_CMD_REPLY_FUNC(stats)
d30 2
a32 2
+  SILC_LOG_DEBUG(("stat.clients = %d\n", server->stat.clients));
+
a34 1
  err:
@

