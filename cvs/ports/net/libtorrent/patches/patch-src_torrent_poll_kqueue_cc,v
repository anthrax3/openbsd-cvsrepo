head	1.7;
access;
symbols
	OPENBSD_6_0:1.7.0.6
	OPENBSD_6_0_BASE:1.7
	OPENBSD_5_9:1.7.0.2
	OPENBSD_5_9_BASE:1.7
	OPENBSD_5_8:1.7.0.4
	OPENBSD_5_8_BASE:1.7
	OPENBSD_5_7:1.6.0.12
	OPENBSD_5_7_BASE:1.6
	OPENBSD_5_6:1.6.0.10
	OPENBSD_5_6_BASE:1.6
	OPENBSD_5_5:1.6.0.8
	OPENBSD_5_5_BASE:1.6
	OPENBSD_5_4:1.6.0.6
	OPENBSD_5_4_BASE:1.6
	OPENBSD_5_3:1.6.0.4
	OPENBSD_5_3_BASE:1.6
	OPENBSD_5_2:1.6.0.2
	OPENBSD_5_2_BASE:1.6
	OPENBSD_5_1_BASE:1.3
	OPENBSD_5_1:1.3.0.2
	OPENBSD_5_0:1.2.0.4
	OPENBSD_5_0_BASE:1.2
	OPENBSD_4_9:1.2.0.2
	OPENBSD_4_9_BASE:1.2
	OPENBSD_4_8:1.1.0.8
	OPENBSD_4_8_BASE:1.1
	OPENBSD_4_7:1.1.0.6
	OPENBSD_4_7_BASE:1.1
	OPENBSD_4_6:1.1.0.4
	OPENBSD_4_6_BASE:1.1
	OPENBSD_4_5:1.1.0.2
	OPENBSD_4_5_BASE:1.1;
locks; strict;
comment	@# @;


1.7
date	2015.03.24.13.35.09;	author dcoppa;	state Exp;
branches;
next	1.6;
commitid	Y8aqtGprCkAwt0Os;

1.6
date	2012.07.15.10.20.07;	author dcoppa;	state Exp;
branches;
next	1.5;

1.5
date	2012.07.11.08.33.39;	author dcoppa;	state Exp;
branches;
next	1.4;

1.4
date	2012.05.02.14.06.03;	author dcoppa;	state Exp;
branches;
next	1.3;

1.3
date	2011.12.01.17.10.40;	author dcoppa;	state Exp;
branches;
next	1.2;

1.2
date	2011.01.31.14.59.38;	author naddy;	state Exp;
branches;
next	1.1;

1.1
date	2008.11.25.16.21.28;	author naddy;	state Exp;
branches;
next	;


desc
@@


1.7
log
@
Update to libtorrent-0.13.4, now that the (in)famous ipi storm
problem has been finally fixed.

Initial diff by Michael <gmail/lesniewskister>
@
text
@$OpenBSD: patch-src_torrent_poll_kqueue_cc,v 1.6 2012/07/15 10:20:07 dcoppa Exp $

Fix a crash when total number of connections exceeds 1024.

The number of events is used to index an array of maxOpenSockets
(file descriptors) elements. If there are fewer fds than maxEvents,
this will cause a segfault.
Limit the number of events to the number of fds with an upper limit of
maxEvents.

--- src/torrent/poll_kqueue.cc.orig	Tue May  6 03:22:57 2014
+++ src/torrent/poll_kqueue.cc	Tue Mar 24 03:43:10 2015
@@@@ -37,6 +37,7 @@@@
 #include "config.h"
 
 #include <cerrno>
+#include <cassert>
 
 #include <algorithm>
 #include <unistd.h>
@@@@ -121,12 +122,12 @@@@ PollKQueue::create(int maxOpenSockets) {
   if (fd == -1)
     return NULL;
 
-  return new PollKQueue(fd, 1024, maxOpenSockets);
+  return new PollKQueue(fd, 16384, maxOpenSockets);
 }
 
 PollKQueue::PollKQueue(int fd, int maxEvents, int maxOpenSockets) :
   m_fd(fd),
-  m_maxEvents(maxEvents),
+  m_maxEvents((maxOpenSockets < maxEvents) ? maxOpenSockets : maxEvents),
   m_waitingEvents(0),
   m_changedEvents(0),
   m_stdinEvent(NULL) {
@


1.6
log
@Back out the update to 0.13.2/0.9.2; too much problems to make
release.

OK sthen@@, naddy@@
@
text
@d1 1
a1 1
$OpenBSD: patch-src_torrent_poll_kqueue_cc,v 1.5 2012/07/11 08:33:39 dcoppa Exp $
d3 1
a3 2
Fix a crash when total number of connections exceeds 1024
(http://libtorrent.rakshasa.no/ticket/1581)
d11 2
a12 2
--- src/torrent/poll_kqueue.cc.orig	Tue Apr  5 12:25:53 2011
+++ src/torrent/poll_kqueue.cc	Fri Jul 13 10:59:11 2012
d21 1
a21 1
@@@@ -111,12 +112,12 @@@@ PollKQueue::create(int maxOpenSockets) {
@


1.5
log
@Fix a crash when total number of connections exceeds 1024
(from FreeBSD)

Fix a bug where manual tracker update for a preferred tracker that
fails would end up rerequesting instantly
(upstream git commit 78f56ee74cecd8e82d39baaea10395301fbec4b8)
@
text
@d1 1
a1 1
$OpenBSD: patch-src_torrent_poll_kqueue_cc,v 1.4 2012/05/02 14:06:03 dcoppa Exp $
d12 2
a13 2
--- src/torrent/poll_kqueue.cc.orig	Wed Feb 15 05:14:30 2012
+++ src/torrent/poll_kqueue.cc	Wed Jul 11 09:33:45 2012
d22 1
a22 1
@@@@ -120,12 +121,12 @@@@ PollKQueue::create(int maxOpenSockets) {
@


1.4
log
@Update to libtorrent-0.13.2
@
text
@d1 4
a4 1
$OpenBSD: patch-src_torrent_poll_kqueue_cc,v 1.3 2011/12/01 17:10:40 dcoppa Exp $
a8 1

d13 1
a13 1
+++ src/torrent/poll_kqueue.cc	Thu Apr 12 12:39:01 2012
d22 7
a28 1
@@@@ -125,7 +126,7 @@@@ PollKQueue::create(int maxOpenSockets) {
@


1.3
log
@Update to libtorrent-0.12.9 / rtorrent-0.8.9

I also take maintainership, as per naddy@@'s request
@
text
@d1 1
a1 1
$OpenBSD: patch-src_torrent_poll_kqueue_cc,v 1.2 2011/01/31 14:59:38 naddy Exp $
d10 2
a11 2
--- src/torrent/poll_kqueue.cc.orig	Tue Apr  5 12:25:53 2011
+++ src/torrent/poll_kqueue.cc	Wed Oct 19 21:42:06 2011
d20 1
a20 1
@@@@ -116,7 +117,7 @@@@ PollKQueue::create(int maxOpenSockets) {
@


1.2
log
@Fix a segfault in rTorrent when running a large number of torrents.
From Tobias Ulmer; ok espie@@
@
text
@d1 1
a1 1
$OpenBSD: patch-src_torrent_poll_kqueue_cc,v 1.1 2008/11/25 16:21:28 naddy Exp $
d10 2
a11 2
--- src/torrent/poll_kqueue.cc.orig	Thu Nov 12 09:03:58 2009
+++ src/torrent/poll_kqueue.cc	Sat Jan 29 01:04:59 2011
d20 1
a20 1
@@@@ -115,7 +116,7 @@@@ PollKQueue::create(int maxOpenSockets) {
@


1.1
log
@Update to libtorrent 0.12.4/rtorrent 0.8.4.
- Adds support for DHT.
- Many ill-documented scripting changes.
- The session file format has changed.
@
text
@d1 11
a11 3
$OpenBSD$
--- src/torrent/poll_kqueue.cc.orig	Tue Oct 28 04:48:48 2008
+++ src/torrent/poll_kqueue.cc	Sun Nov 23 21:17:59 2008
d20 9
@

