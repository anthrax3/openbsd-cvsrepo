head	1.2;
access;
symbols
	OPENBSD_6_0:1.2.0.4
	OPENBSD_6_0_BASE:1.2
	OPENBSD_5_9:1.2.0.2
	OPENBSD_5_9_BASE:1.2
	OPENBSD_5_8:1.1.0.12
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.8
	OPENBSD_5_7_BASE:1.1
	OPENBSD_5_6:1.1.0.6
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.4
	OPENBSD_5_5_BASE:1.1
	OPENBSD_5_4:1.1.0.2
	OPENBSD_5_4_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2015.09.19.12.21.04;	author sthen;	state Exp;
branches;
next	1.1;
commitid	7bkerzGl6R6nU7UV;

1.1
date	2013.03.28.12.38.56;	author sthen;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Unbreak check_email_delivery with SSL (add basic handling of the changes
to cert verification in IO::Socket::SSL).
@
text
@$OpenBSD: patch-check_imap_receive_epn,v 1.1 2013/03/28 12:38:56 sthen Exp $
--- check_imap_receive_epn.orig	Sun Feb 26 01:03:10 2012
+++ check_imap_receive_epn	Sat Sep 19 13:13:36 2015
@@@@ -47,7 +47,7 @@@@ my $download_max = "";
 my $peek = "";
 my $template = "";
 my $ssl = 0;
-my $ssl_ca_file = "";
+my $ssl_ca_file = "/etc/ssl/cert.pem";
 my $tls = 0;
 my $time_hires = "";
 my $ok;
@@@@ -126,13 +126,16 @@@@ eval {
 	alarm $timeout;
 	
 	if( $ssl || $tls ) {
+		use IO::Socket::SSL;
 		$imap_port = $default_imap_ssl_port unless $imap_port;
 		my %ssl_args = ();
 		if( length($ssl_ca_file) > 0 ) {
-			$ssl_args{SSL_verify_mode} = 1;
+			$ssl_args{SSL_verify_mode} = SSL_VERIFY_PEER;
 			$ssl_args{SSL_ca_file} = $ssl_ca_file;
 			$ssl_args{SSL_verifycn_scheme} = 'imap';
 			$ssl_args{SSL_verifycn_name} = $imap_server;
+		} else {
+			$ssl_args{SSL_verify_mode} = SSL_VERIFY_NONE;
 		}
 		my $socket = IO::Socket::SSL->new(PeerAddr=>"$imap_server:$imap_port", %ssl_args);
 		die IO::Socket::SSL::errstr() . " (if you get this only when using both --ssl and --ssl-ca-file, but not when using just --ssl, the server SSL certificate failed validation)" unless $socket;
@


1.1
log
@SSL_verify_mode handling changed in Perl; stop check_imap_receive /
imap_ssl_cert from whining.
@
text
@d1 3
a3 3
$OpenBSD$
--- check_imap_receive_epn.orig	Thu Mar 28 12:26:36 2013
+++ check_imap_receive_epn	Thu Mar 28 12:35:45 2013
d13 5
a17 1
@@@@ -129,7 +129,7 @@@@ eval {
d22 1
a22 1
+			$ssl_args{SSL_verify_mode} = qw(SSL_VERIFY_PEER);
d26 5
@

