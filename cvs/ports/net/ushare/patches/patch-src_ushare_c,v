head	1.5;
access;
symbols
	OPENBSD_6_1:1.5.0.8
	OPENBSD_6_1_BASE:1.5
	OPENBSD_6_0:1.5.0.6
	OPENBSD_6_0_BASE:1.5
	OPENBSD_5_9:1.5.0.2
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.5.0.4
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.4.0.10
	OPENBSD_5_7_BASE:1.4
	OPENBSD_5_6:1.4.0.8
	OPENBSD_5_6_BASE:1.4
	OPENBSD_5_5:1.4.0.6
	OPENBSD_5_5_BASE:1.4
	OPENBSD_5_4:1.4.0.4
	OPENBSD_5_4_BASE:1.4
	OPENBSD_5_3:1.4.0.2
	OPENBSD_5_3_BASE:1.4
	OPENBSD_5_2:1.2.0.4
	OPENBSD_5_2_BASE:1.2
	OPENBSD_5_1_BASE:1.2
	OPENBSD_5_1:1.2.0.2
	OPENBSD_5_0:1.1.1.1.0.6
	OPENBSD_5_0_BASE:1.1.1.1
	OPENBSD_4_9:1.1.1.1.0.4
	OPENBSD_4_9_BASE:1.1.1.1
	OPENBSD_4_8:1.1.1.1.0.2
	OPENBSD_4_8_BASE:1.1.1.1
	ajacoutot_20100322:1.1.1.1
	ajacoutot:1.1.1;
locks; strict;
comment	@# @;


1.5
date	2015.06.19.09.07.32;	author ajacoutot;	state Exp;
branches;
next	1.4;
commitid	hXHwhE3ALoBRTThB;

1.4
date	2012.11.07.14.53.59;	author dcoppa;	state Exp;
branches;
next	1.3;

1.3
date	2012.11.06.11.50.04;	author dcoppa;	state Exp;
branches;
next	1.2;

1.2
date	2011.12.03.13.59.37;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2010.03.22.22.26.59;	author ajacoutot;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2010.03.22.22.26.59;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.5
log
@Clean up port/patches.
@
text
@$OpenBSD: patch-src_ushare_c,v 1.4 2012/11/07 14:53:59 dcoppa Exp $

Unbreak build with libupnp>=1.6.17

--- src/ushare.c.orig	Sun Dec  9 14:03:36 2007
+++ src/ushare.c	Fri Nov  2 16:13:38 2012
@@@@ -188,7 +188,7 @@@@ handle_action_request (struct Upnp_Action_Request *req
   if (strcmp (request->DevUDN + 5, ut->udn))
     return;
 
-  ip = request->CtrlPtIPAddr.s_addr;
+  ip = (*(struct sockaddr_in*)&request->CtrlPtIPAddr).sin_addr.s_addr;
   ip = ntohl (ip);
   sprintf (val, "%d.%d.%d.%d",
            (ip >> 24) & 0xFF, (ip >> 16) & 0xFF, (ip >> 8) & 0xFF, ip & 0xFF);
@@@@ -348,7 +348,47 @@@@ init_upnp (struct ushare_t *ut)
 
   UpnpEnableWebserver (TRUE);
 
-  res = UpnpSetVirtualDirCallbacks (&virtual_dir_callbacks);
+  res = UpnpVirtualDir_set_WriteCallback(http_write);
+  if (res != UPNP_E_SUCCESS)
+  {
+    log_error (_("Cannot set virtual directory callbacks\n"));
+    free (description);
+    return -1;
+  }
+
+  res = UpnpVirtualDir_set_GetInfoCallback(http_get_info);
+  if (res != UPNP_E_SUCCESS)
+  {
+    log_error (_("Cannot set virtual directory callbacks\n"));
+    free (description);
+    return -1;
+  }
+
+  res = UpnpVirtualDir_set_ReadCallback(http_read);
+  if (res != UPNP_E_SUCCESS)
+  {
+    log_error (_("Cannot set virtual directory callbacks\n"));
+    free (description);
+    return -1;
+  }
+
+  res = UpnpVirtualDir_set_OpenCallback(http_open);
+  if (res != UPNP_E_SUCCESS)
+  {
+    log_error (_("Cannot set virtual directory callbacks\n"));
+    free (description);
+    return -1;
+  }
+
+  res = UpnpVirtualDir_set_SeekCallback(http_seek);
+  if (res != UPNP_E_SUCCESS)
+  {
+    log_error (_("Cannot set virtual directory callbacks\n"));
+    free (description);
+    return -1;
+  }
+
+  res = UpnpVirtualDir_set_CloseCallback(http_close);
   if (res != UPNP_E_SUCCESS)
   {
     log_error (_("Cannot set virtual directory callbacks\n"));
@


1.4
log
@Additional bugfixes and add comments to patches
@
text
@d1 1
a1 1
$OpenBSD: patch-src_ushare_c,v 1.3 2012/11/06 11:50:04 dcoppa Exp $
a6 22
@@@@ -28,6 +28,10 @@@@
 #include <errno.h>
 #include <getopt.h>
 
+#if (defined(__unix__) || defined(unix)) && !defined(USG)
+#include <sys/param.h>
+#endif
+
 #if (defined(BSD) || defined(__FreeBSD__) || defined(__APPLE__))
 #include <sys/socket.h>
 #include <sys/sysctl.h>
@@@@ -49,10 +53,6 @@@@
 #include <ifaddrs.h>
 #endif
 
-#if (defined(__unix__) || defined(unix)) && !defined(USG)
-#include <sys/param.h>
-#endif
-
 #include <upnp/upnp.h>
 #include <upnp/upnptools.h>
 
@


1.3
log
@Unbreak with newer libupnp; patch stolen from Arch Linux

"if it works, go ahead" ajacoutot@@
@
text
@d1 4
a4 1
$OpenBSD: patch-src_ushare_c,v 1.2 2011/12/03 13:59:37 ajacoutot Exp $
@


1.2
log
@Remove MSG_NOSIGNAL patch now that we support that.
Move MESSAGE to README.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_ushare_c,v 1.1.1.1 2010/03/22 22:26:59 ajacoutot Exp $
d3 1
a3 1
+++ src/ushare.c	Tue Feb  9 15:32:22 2010
d26 58
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
$OpenBSD$
a25 10
@@@@ -845,6 +845,9 @@@@ main (int argc, char **argv)
 
   signal (SIGINT, UPnPBreak);
   signal (SIGHUP, reload_config);
+#ifndef MSG_NOSIGNAL
+  signal (SIGPIPE, SIG_IGN);
+#endif
 
   if (ut->use_telnet)
   {
@


1.1.1.1
log
@Import ushare-1.1a

uShare is a UPnP (TM) A/V & DLNA Media Server. It implements the server
component that provides UPnP media devices with information on available
multimedia files. uShare uses the built-in http server of libupnp to
stream the files to clients.

GeeXboX uShare is able to provide access to both images, videos, music
or playlists files (see below for a complete file format support list
It does not act as an UPnP Media Adaptor and thus, can't transcode
streams to fit the client requirements.

Note that DLNA support is not enabled on OpenBSD.
@
text
@@
