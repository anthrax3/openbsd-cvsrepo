head	1.2;
access;
symbols
	OPENBSD_5_8:1.1.1.1.0.8
	OPENBSD_5_8_BASE:1.1.1.1
	OPENBSD_5_7:1.1.1.1.0.4
	OPENBSD_5_7_BASE:1.1.1.1
	OPENBSD_5_6:1.1.1.1.0.2
	OPENBSD_5_6_BASE:1.1.1.1
	zhuk_20140504:1.1.1.1
	zhuk:1.1.1;
locks; strict;
comment	@# @;


1.2
date	2015.08.25.16.21.13;	author jca;	state dead;
branches;
next	1.1;
commitid	nNA5e3zj19AGK9NL;

1.1
date	2014.05.04.16.08.29;	author zhuk;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2014.05.04.16.08.29;	author zhuk;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Bye bye net/samba4, thanks for all the headaches.

If you need details about how something ended up in net/samba, go look
in the Attic.

ok ajacoutot@@ sthen@@
@
text
@$OpenBSD: patch-buildtools_wafadmin_Tools_ccroot_py,v 1.1 2014/05/04 16:08:29 zhuk Exp $
Make Samba4 WAF respect OpenBSD shared libraries versioning conventions.
BUG: https://bugzilla.samba.org/show_bug.cgi?id=9774
--- buildtools/wafadmin/Tools/ccroot.py.orig	Mon May 27 17:48:53 2013
+++ buildtools/wafadmin/Tools/ccroot.py	Mon May 27 18:06:35 2013
@@@@ -568,7 +568,7 @@@@ def apply_implib(self):
 @@before('apply_lib_vars', 'default_link_install')
 def apply_vnum(self):
 	"""
-	libfoo.so is installed as libfoo.so.1.2.3
+	libfoo.so is installed as libfoo.so.1.2.3, unless there is OS-specific scheme
 	"""
 	if not getattr(self, 'vnum', '') or not 'cshlib' in self.features or os.name != 'posix' or self.env.DEST_BINFMT not in ('elf', 'mac-o'):
 		return
@@@@ -576,19 +576,33 @@@@ def apply_vnum(self):
 	self.meths.remove('default_link_install')
 
 	link = self.link_task
-	nums = self.vnum.split('.')
 	node = link.outputs[0]
-
 	libname = node.name
+
+	# OpenBSD-like library handling:
+	#  * each shared library should be named libfoo.so.MAJOR.MINOR
+	#  * no symlinks should be created
+	target_name = self.target
+	osvnum = os.getenv('LIB' + target_name.replace('-', '_') + '_VERSION')
+	if osvnum:
+		self.vnum = osvnum
+	nums = self.vnum.split('.')
+
+	name2 = None
 	if libname.endswith('.dylib'):
 		name3 = libname.replace('.dylib', '.%s.dylib' % self.vnum)
-		name2 = libname.replace('.dylib', '.%s.dylib' % nums[0])
+		if not osvnum:
+			name2 = libname.replace('.dylib', '.%s.dylib' % nums[0])
 	else:
 		name3 = libname + '.' + self.vnum
-		name2 = libname + '.' + nums[0]
+		if not osvnum:
+			name2 = libname + '.' + nums[0]
 
 	if self.env.SONAME_ST:
-		v = self.env.SONAME_ST % name2
+		if name2:
+			v = self.env.SONAME_ST % name2
+		else:
+			v = self.env.SONAME_ST % name3
 		self.env.append_value('LINKFLAGS', v.split())
 
 	bld = self.bld
@@@@ -598,11 +612,11 @@@@ def apply_vnum(self):
 	if not path: return
 
 	bld.install_as(path + os.sep + name3, node, env=self.env)
-	bld.symlink_as(path + os.sep + name2, name3)
-	bld.symlink_as(path + os.sep + libname, name3)
-
-	# the following task is just to enable execution from the build dir :-/
-	self.create_task('vnum', node, [node.parent.find_or_declare(name2), node.parent.find_or_declare(name3)])
+	if not osvnum:
+		bld.symlink_as(path + os.sep + name2, name3)
+		bld.symlink_as(path + os.sep + libname, name3)
+		# the following task is just to enable execution from the build dir :-/
+		self.create_task('vnum', node, [node.parent.find_or_declare(name2), node.parent.find_or_declare(name3)])
 
 def exec_vnum_link(self):
 	for x in self.outputs:
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
$OpenBSD$
@


1.1.1.1
log
@Import Samba 4.0.17 WIP port. In openbsd-wip for more than a year.
Most of work by yours truly, with help from kirby@@, ian@@ and others.

Notable change: libtalloc became a part of -util subpackage. Stuff
in this package has circular dependencies (at least, it was so
during beta times), so it's not possible to have libtalloc as
a separate package.

Now that Heimdal leaved base system, we could get rid of dirty, nasty
pool of hacks that renamed almost every symbol of bundled Heimdal.

okay ajacoutot@@, also support from ian@@ and sthen@@ at least.
@
text
@@
