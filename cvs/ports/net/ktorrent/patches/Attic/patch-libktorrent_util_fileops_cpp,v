head	1.4;
access;
symbols
	OPENBSD_4_3:1.3.0.2
	OPENBSD_4_3_BASE:1.3;
locks; strict;
comment	@# @;


1.4
date	2008.04.24.00.19.40;	author sthen;	state dead;
branches;
next	1.3;

1.3
date	2008.02.05.19.17.15;	author naddy;	state Exp;
branches;
next	1.2;

1.2
date	2008.01.30.12.18.59;	author sthen;	state Exp;
branches;
next	1.1;

1.1
date	2007.12.27.10.24.51;	author sthen;	state Exp;
branches;
next	;


desc
@@


1.4
log
@maintenance update from Brad - most patches are now upstream.
@
text
@$OpenBSD: patch-libktorrent_util_fileops_cpp,v 1.3 2008/02/05 19:17:15 naddy Exp $
--- libktorrent/util/fileops.cpp.orig	Sun Jan 27 07:06:02 2008
+++ libktorrent/util/fileops.cpp	Sat Feb  2 13:27:40 2008
@@@@ -61,10 +61,13 @@@@ typedef	int64_t		__s64;
 #define O_LARGEFILE 0
 #endif
 
-				 
+#if HAVE_STATVFS
 #include <sys/statvfs.h>
+#else
+#include <sys/param.h>
+#include <sys/mount.h>
+#endif
 
-
 namespace bt
 {
 	void MakeDir(const QString & dir,bool nothrow)
@@@@ -445,7 +448,19 @@@@ namespace bt
 			return false;
 		}
 #else
-		return false;
+		struct statfs stfs;
+		if (statfs(path.local8Bit(), &stfs) == 0)
+		{
+			bytes_free = ((Uint64)stfs.f_bavail) * ((Uint64)stfs.f_bsize);
+			return true;
+		}
+		else
+		{
+			Out(SYS_GEN|LOG_DEBUG) << "Error : statfs for " << path << " failed :  "
+						<< QString(strerror(errno)) << endl;
+
+			return false;
+		}
 #endif
 	}
 }
@


1.3
log
@fix build if statvfs() is available; from brad@@
@
text
@d1 1
a1 1
$OpenBSD: patch-libktorrent_util_fileops_cpp,v 1.2 2008/01/30 12:18:59 sthen Exp $
@


1.2
log
@update to 2.2.5, add my patch to use statfs where statvfs isn't available
from brad, tested by me
@
text
@d1 11
a11 7
$OpenBSD: patch-libktorrent_util_fileops_cpp,v 1.1 2007/12/27 10:24:51 sthen Exp $
--- libktorrent/util/fileops.cpp.orig	Sun Jan 27 12:06:02 2008
+++ libktorrent/util/fileops.cpp	Tue Jan 29 20:36:58 2008
@@@@ -29,6 +29,8 @@@@
 #include <kio/netaccess.h>
 #include <sys/stat.h>
 #include <sys/types.h>
d14 1
a14 9
 #include <fcntl.h>
 #include <qdir.h>
 #include <qfile.h>
@@@@ -62,7 +64,6 @@@@ typedef	int64_t		__s64;
 #endif
 
 				 
-#include <sys/statvfs.h>
 
d16 1
d18 3
a20 1
@@@@ -445,7 +446,19 @@@@ namespace bt
@


1.1
log
@update KTorrent from Brad
"commit it if it works for you" ajacoutot
@
text
@d1 13
a13 4
$OpenBSD$
--- libktorrent/util/fileops.cpp.orig	Mon Aug 27 12:45:55 2007
+++ libktorrent/util/fileops.cpp	Sat Sep 29 02:31:07 2007
@@@@ -62,7 +62,6 @@@@ typedef	int64_t		__s64;
d21 21
@

