head	1.3;
access;
symbols
	OPENBSD_2_8:1.2.0.2;
locks; strict;
comment	@# @;


1.3
date	2001.04.19.14.51.28;	author danh;	state dead;
branches;
next	1.2;

1.2
date	2001.04.06.13.40.18;	author danh;	state Exp;
branches
	1.2.2.1;
next	1.1;

1.1
date	2001.04.05.13.56.54;	author danh;	state Exp;
branches;
next	;

1.2.2.1
date	2001.04.10.11.59.58;	author naddy;	state Exp;
branches;
next	;


desc
@@


1.3
log
@update to version 4.0.99k23
@
text
@$OpenBSD: patch-ntpd_ntp_control_c,v 1.2 2001/04/06 13:40:18 danh Exp $
--- ntpd/ntp_control.c.orig	Thu Apr  5 22:38:59 2001
+++ ntpd/ntp_control.c	Thu Apr  5 22:57:03 2001
@@@@ -1782,7 +1782,7 @@@@ ctl_getitem(
 	 * Delete leading commas and white space
 	 */
 	while (reqpt < reqend && (*reqpt == ',' ||
-	    isspace((int)*reqpt)))
+	    isspace((unsigned char)*reqpt)))
 		reqpt++;
 	if (reqpt >= reqend)
 		return (0);
@@@@ -1805,7 +1805,8 @@@@ ctl_getitem(
 				tp++;
 			}
 			if ((*tp == '\0') || (*tp == '=')) {
-				while (cp < reqend && isspace((int)*cp))
+				while (cp < reqend 
+				    && isspace((unsigned char)*cp))
 					cp++;
 				if (cp == reqend || *cp == ',') {
 					buf[0] = '\0';
@@@@ -1819,16 +1820,18 @@@@ ctl_getitem(
 					cp++;
 					tp = buf;
 					while (cp < reqend &&
-					    isspace((int)*cp))
+					    isspace((unsigned char)*cp))
 						cp++;
-					while (cp < reqend && *cp !=
-					    ',')
+					while (cp < reqend 
+					    && *cp != ','
+					    && tp < buf + sizeof(buf) - 1)
 						*tp++ = *cp++;
 					if (cp < reqend)
 						cp++;
-					*tp = '\0';
-					while (isspace((int)(*(tp-1))))
-						*(--tp) = '\0';
+					*tp-- = '\0';
+					while (tp >= buf 
+					    && isspace((unsigned char)*tp))
+						*tp-- = '\0';
 					reqpt = cp;
 					*data = buf;
 					return (v);
@


1.2
log
@better fix
@
text
@d1 1
a1 1
$OpenBSD: update-patches,v 1.4 2001/03/31 22:54:41 espie Exp $
@


1.2.2.1
log
@MFC:
SECURITY FIX: Import ntp-4.0.99k with a fix against remote (x)ntp root
exploit.  This replaces sysutils/xntpd.
@
text
@d1 1
a1 1
$OpenBSD: patch-ntpd_ntp_control_c,v 1.2 2001/04/06 13:40:18 danh Exp $
@


1.1
log
@pull in security patch from FreeBSD
@
text
@d2 24
a25 3
--- ntpd/ntp_control.c.orig	Sat Jul 15 10:46:05 2000
+++ ntpd/ntp_control.c	Thu Apr  5 09:40:13 2001
@@@@ -1821,9 +1821,18 @@@@ ctl_getitem(
d27 2
a28 1
 					    isspace((int)*cp))
d32 3
a34 1
+					while (cp < reqend && *cp != ',') {
a35 10
+						if (tp > buf + sizeof(buf)) {
+							msyslog(LOG_WARNING, "Attempted \"ntpdx\" exploit from IP %d.%d.%d.%d:%d (possibly spoofed)\n",
+    (ntohl(rmt_addr->sin_addr.s_addr) >> 24) & 0xff,
+    (ntohl(rmt_addr->sin_addr.s_addr) >> 16) & 0xff,
+    (ntohl(rmt_addr->sin_addr.s_addr) >> 8) & 0xff,
+    (ntohl(rmt_addr->sin_addr.s_addr) >> 0) & 0xff,
+    ntohs(rmt_addr->sin_port) );
+                                                	return 0;
+                                        	}
+					}
d38 10
a47 1
 					*tp = '\0';
@

