head	1.2;
access;
symbols
	OPENBSD_4_1:1.1.0.2
	OPENBSD_4_1_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2007.03.27.16.04.37;	author martynas;	state dead;
branches;
next	1.1;

1.1
date	2007.03.01.22.46.06;	author robert;	state Exp;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2007.05.01.16.22.32;	author sturm;	state dead;
branches;
next	;


desc
@@


1.2
log
@- update to 2.0.0.3;
- don't force -Os;
ok naddy@@, kurt@@
@
text
@$OpenBSD: patch-js_src_jsemit_c,v 1.1 2007/03/01 22:46:06 robert Exp $
--- js/src/jsemit.c.orig	Wed Jan 17 01:07:07 2007
+++ js/src/jsemit.c	Wed Feb 28 17:56:46 2007
@@@@ -1324,7 +1324,9 @@@@ EmitNonLocalJumpFixup(JSContext *cx, JSC
         JS_ASSERT(*returnop == JSOP_RETURN);
         for (stmt = cg->treeContext.topStmt; stmt != toStmt;
              stmt = stmt->down) {
-            if (stmt->type == STMT_FINALLY) {
+            if (stmt->type == STMT_FINALLY ||
+                ((cg->treeContext.flags & TCF_FUN_HEAVYWEIGHT) &&
+                 STMT_MAYBE_SCOPE(stmt))) {
                 if (js_Emit1(cx, cg, JSOP_SETRVAL) < 0)
                     return JS_FALSE;
                 *returnop = JSOP_RETRVAL;
@@@@ -4000,7 +4002,9 @@@@ js_EmitTree(JSContext *cx, JSCodeGenerat
             if (stmt && stmt->type == STMT_BLOCK &&
                 stmt->down && stmt->down->type == STMT_BLOCK &&
                 (stmt->down->flags & SIF_SCOPE)) {
-                cg->treeContext.flags |= TCF_HAS_BLOCKLOCALFUN;
+                obj = ATOM_TO_OBJECT(stmt->down->atom);
+                JS_ASSERT(LOCKED_OBJ_GET_CLASS(obj) == &js_BlockClass);
+                OBJ_SET_PARENT(cx, fun->object, obj);
             }
 
             if (atomIndex >= JS_BIT(16)) {
@


1.1
log
@- update to version 2.0.0.2 and apply several security fixes,
therefore bump the PKGNAME to p0 now;
- enable official branding by default
- fix some WANTLIB markers

work done by Martynas Venckus; thanks.

tested by many many people; ok pvalchev@@
@
text
@d1 1
a1 1
$OpenBSD$
@


1.1.2.1
log
@MFC:
- update to 2.0.0.3;
- don't force -Os;
@
text
@d1 1
a1 1
$OpenBSD: patch-js_src_jsemit_c,v 1.1 2007/03/01 22:46:06 robert Exp $
@


