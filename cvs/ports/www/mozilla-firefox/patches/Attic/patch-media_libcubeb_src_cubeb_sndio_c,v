head	1.4;
access;
symbols
	OPENBSD_6_0:1.3.0.2
	OPENBSD_6_0_BASE:1.3;
locks; strict;
comment	@# @;


1.4
date	2016.08.02.17.50.03;	author landry;	state dead;
branches;
next	1.3;
commitid	C4uQzGWx3WTtTKku;

1.3
date	2016.04.27.13.50.27;	author landry;	state Exp;
branches;
next	1.2;
commitid	15LuhcSbzffxjAi3;

1.2
date	2015.07.06.05.07.04;	author landry;	state dead;
branches;
next	1.1;
commitid	iH1yFVJtAtUV6pED;

1.1
date	2015.03.23.21.02.03;	author landry;	state Exp;
branches;
next	;
commitid	WmKgFwPRmsexbf7u;


desc
@@


1.4
log
@Update to firefox 48.0.

- See https://www.mozilla.org/en-US/firefox/48.0/releasenotes/
- Fixes MFSA 2016-62->84
- See
  https://blog.mozilla.org/blog/2016/08/02/exciting-improvements-in-firefox-for-desktop-and-android/
for user-facing changes
- Switch CONFIGURE_STYLE to simple as it's really not a gnu script
  anymore..
- Remove gtk 3.20 jumbo patch, most gtk3 issues are either fixed or
  being worked on, and the patch isnt maintainable
- Remove patch-gfx_skia_moz_build, it isn't needed anymore on i386, and
  SSE2 will soon be a hard runtime requirement anyway
- Remove patch-media_libcubeb_src_cubeb_sndio_c, merged upstream (#1153151 & #1153179)
- Remove
  patch-toolkit_components_protobuf_src_google_protobuf_stubs_atomicops_h,
merged upstream (#1192556)
- Note that WebRT was removed
@
text
@$OpenBSD: patch-media_libcubeb_src_cubeb_sndio_c,v 1.3 2016/04/27 13:50:27 landry Exp $

https://github.com/kinetiknz/cubeb/commit/af33b71675a90b501c7510bb793c10bbc27642b0
https://github.com/kinetiknz/cubeb/commit/658d7eba38d4b8de932dba367165834b8ac9c130

--- media/libcubeb/src/cubeb_sndio.c.orig	Mon Mar 28 19:56:03 2016
+++ media/libcubeb/src/cubeb_sndio.c	Mon Mar 28 19:57:27 2016
@@@@ -67,7 +67,7 @@@@ sndio_onmove(void *arg, int delta)
 {
   cubeb_stream *s = (cubeb_stream *)arg;
 
-  s->rdpos += delta;
+  s->rdpos += delta * s->bpf;
 }
 
 static void *
@@@@ -135,7 +135,7 @@@@ sndio_mainloop(void *arg)
         state = CUBEB_STATE_ERROR;
         break;
       }
-      s->wrpos = 0;
+      s->wrpos += n;
       start += n;
     }
   }
@@@@ -197,7 +197,7 @@@@ sndio_stream_init(cubeb * context,
   if (s == NULL)
     return CUBEB_ERROR;
   s->context = context;
-  s->hdl = sio_open(NULL, SIO_PLAY, 0);
+  s->hdl = sio_open(NULL, SIO_PLAY, 1);
   if (s->hdl == NULL) {
     free(s);
     DPR("sndio_stream_init(), sio_open() failed\n");
@@@@ -336,7 +336,7 @@@@ sndio_stream_get_position(cubeb_stream *s, uint64_t *p
 {
   pthread_mutex_lock(&s->mtx);
   DPR("sndio_stream_get_position() %lld\n", s->rdpos);
-  *p = s->rdpos;
+  *p = s->rdpos / s->bpf;
   pthread_mutex_unlock(&s->mtx);
   return CUBEB_OK;
 }
@@@@ -356,7 +356,7 @@@@ sndio_stream_get_latency(cubeb_stream * stm, uint32_t 
 {
   // http://www.openbsd.org/cgi-bin/man.cgi?query=sio_open
   // in the "Measuring the latency and buffers usage" paragraph.
-  *latency = stm->wrpos - stm->rdpos;
+  *latency = (stm->wrpos - stm->rdpos) / stm->bpf;
   return CUBEB_OK;
 }
 
@


1.3
log
@Update to firefox 46.0.

- See https://www.mozilla.org/en-US/firefox/46.0/releasenotes/
- Fixes MFSA 2016-39 -> 48
- Switch to use Gtk3 by default (finally!), following the upstream move
- Add a jumbo patch from Fedora to fix several issues with Gtk 3.20
  (#1234158)
- Leave WebRTC enabled. The code builds, sort-of works, sound support
  is not really there, but this way ppl will dogfood/test it. If you
  encounter issues, go to bugzilla.mozilla.org and get involved with
  upstream.
- If you want to disable WebRTC, just toggle media.peerconnection.enabled
  to false in about:config.
- Stop using systemwide sqlite, build the bundled one instead. Simpler,
  as it often forced us to update sqlite in base...
- Add patch from #1239550 to fix the build in ffvpx
- Backport two cubeb patches from ratchov@@ already commited upstream
  (#1153151 & #1153179)
- Remove the obsolete gstreamer section from README, from Brad (and others)
@
text
@d1 1
a1 1
$OpenBSD$
@


1.2
log
@Remove patches from #1144087 and #1143411 which were merged in 39.
Both reported by David Hill and Pavel Korovin.
Because cvs...
@
text
@d1 8
a8 14
$OpenBSD: patch-media_libcubeb_src_cubeb_sndio_c,v 1.1 2015/03/23 21:02:03 landry Exp $
https://hg.mozilla.org/mozilla-central/raw-rev/535571bc0164
https://bugzilla.mozilla.org/show_bug.cgi?id=1144087
--- media/libcubeb/src/cubeb_sndio.c.orig	Sat Mar 21 04:42:39 2015
+++ media/libcubeb/src/cubeb_sndio.c	Mon Mar 23 21:48:37 2015
@@@@ -4,6 +4,7 @@@@
  * This program is made available under an ISC-style license.  See the
  * accompanying file LICENSE for details.
  */
+#include <math.h>
 #include <poll.h>
 #include <pthread.h>
 #include <sndio.h>
@@@@ -49,9 +50,16 @@@@ float_to_s16(void *ptr, long nsamp)
d10 1
a10 3
   int16_t *dst = ptr;
   float *src = ptr;
+  int s;
d12 39
a50 10
-  while (nsamp-- > 0)
-    *(dst++) = *(src++) * 32767;
+  while (nsamp-- > 0) {
+    s = lrintf(*(src++) * 32768);
+    if (s < -32768)
+      s = -32768;
+    else if (s > 32767)
+      s = 32767;
+    *(dst++) = s;
+  }
a52 1
 static void
@


1.1
log
@Security update to firefox 36.0.4.

- See https://www.mozilla.org/en-US/firefox/36.0.4/releasenotes/
- Fixes MFSA 2015-28/29 (Pwn2Own)
- While here, backport commit from ratchov@@ in #1144087 fixing audio
  glitches in the sndio backend when playing youtube videos
@
text
@d1 1
a1 1
$OpenBSD$
@

