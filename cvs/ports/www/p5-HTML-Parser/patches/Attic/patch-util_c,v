head	1.1;
access;
symbols
	OPENBSD_4_6:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2009.11.14.03.10.06;	author william;	state dead;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2009.11.14.03.10.06;	author william;	state Exp;
branches;
next	;


desc
@@


1.1
log
@file patch-util_c was initially added on branch OPENBSD_4_6.
@
text
@@


1.1.2.1
log
@SECURITY FIX

http://permalink.gmane.org/gmane.comp.security.oss.general/2237

diff adapted from upstream
http://github.com/gisle/html-parser/commit/b9aae1e43eb2c8e989510187cff0ba3e996f9a4c

ok Srebrenko Sehic (MAINTAINER)
@
text
@a0 54
$OpenBSD$

SECURITY FIX

decode_entities confused by trailing incomplete entity


--- util.c.orig	Thu Nov 12 23:54:44 2009
+++ util.c	Fri Nov 13 00:02:16 2009
@@@@ -94,14 +94,14 @@@@ decode_entities(pTHX_ SV* sv, HV* entity2char, bool ex
 	ent_start = s;
 	repl = 0;
 
-	if (*s == '#') {
+	if (s < end && *s == '#') {
 	    UV num = 0;
 	    UV prev = 0;
 	    int ok = 0;
 	    s++;
-	    if (*s == 'x' || *s == 'X') {
+	    if (s < end && (*s == 'x' || *s == 'X')) {
 		s++;
-		while (*s) {
+		while (s < end) {
 		    char *tmp = strchr(PL_hexdigit, *s);
 		    if (!tmp)
 			break;
@@@@ -117,7 +117,7 @@@@ decode_entities(pTHX_ SV* sv, HV* entity2char, bool ex
 		}
 	    }
 	    else {
-		while (isDIGIT(*s)) {
+		while (s < end && isDIGIT(*s)) {
 		    num = num * 10 + (*s - '0');
 		    if (prev && num < prev) {
 			/* overflow */
@@@@ -180,7 +180,7 @@@@ decode_entities(pTHX_ SV* sv, HV* entity2char, bool ex
 	}
 	else {
 	    char *ent_name = s;
-	    while (isALNUM(*s))
+	    while (s < end && isALNUM(*s))
 		s++;
 	    if (ent_name != s && entity2char) {
 		SV** svp;
@@@@ -216,7 +216,7 @@@@ decode_entities(pTHX_ SV* sv, HV* entity2char, bool ex
 
 	if (repl) {
 	    char *repl_allocated = 0;
-	    if (*s == ';')
+	    if (s < end && *s == ';')
 		s++;
 	    t--;  /* '&' already copied, undo it */
 
@

