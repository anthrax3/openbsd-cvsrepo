head	1.2;
access;
symbols
	OPENBSD_6_2:1.2.0.8
	OPENBSD_6_2_BASE:1.2
	OPENBSD_6_1:1.2.0.6
	OPENBSD_6_1_BASE:1.2
	OPENBSD_6_0:1.2.0.4
	OPENBSD_6_0_BASE:1.2
	OPENBSD_5_9:1.2.0.2
	OPENBSD_5_9_BASE:1.2;
locks; strict;
comment	@# @;


1.2
date	2015.10.23.07.53.46;	author sebastia;	state Exp;
branches;
next	1.1;
commitid	iZSF3or5d1Vzyt9t;

1.1
date	2015.09.26.14.29.22;	author sebastia;	state Exp;
branches;
next	;
commitid	S9Qb6uAlmCorHjCl;


desc
@@


1.2
log
@Fix the DB schema update scripts, that somehow got lost with the
update to 2.3.2
@
text
@$OpenBSD: patch-Scripts_sql-update-2_2_17_to_2_3_0_sh,v 1.1 2015/09/26 14:29:22 sebastia Exp $
--- Scripts/sql-update-2.2.17_to_2.3.0.sh.orig	Wed Sep 16 20:41:29 2015
+++ Scripts/sql-update-2.2.17_to_2.3.0.sh	Fri Oct 23 09:40:24 2015
@@@@ -1,4 +1,4 @@@@
-#!/bin/bash
+#!/bin/sh
 
 set -e 
 # This script only works with PostgreSQL
@@@@ -11,15 +11,19 @@@@ defaultusername=$USER
 defaulthostname=localhost
 defaultdatabase=$USER
 #indextable=sogo_folder_info
-indextable=$(sogo-tool dump-defaults -f /etc/sogo/sogo.conf | awk -F\" '/ OCSFolderInfoURL =/  {print $2}' |  awk -F/ '{print $NF}')
+if [ -f /etc/sogo/sogo.conf ];then
+  indextable=$(sogo-tool dump-defaults -f /etc/sogo/sogo.conf | awk -F\" '/ OCSFolderInfoURL =/  {print $2}' |  awk -F/ '{print $NF}')
+else
+  indextable=$(sogo-tool dump-defaults | awk -F\" '/ OCSFolderInfoURL =/  {print $2}' |  awk -F/ '{print $NF}')
+fi
 if [ -z "$indextable" ]; then
   echo "Couldn't fetch OCSFolderInfoURL value, aborting" >&2
   exit 1
 fi
 
-read -p "Username ($defaultusername): " username
-read -p "Hostname ($defaulthostname): " hostname
-read -p "Database ($defaultdatabase): " database
+read username?"Username ($defaultusername): "
+read hostname?"Hostname ($defaulthostname): "
+read database?"Database ($defaultdatabase): "
 
 if [ -z "$username" ]
 then
@@@@ -36,7 +40,7 @@@@ fi
 
 sqlscript=""
 
-function adjustSchema() {
+adjustSchema() {
     oldIFS="$IFS"
     IFS=" "
     part1="`echo -e \"ALTER TABLE $table ALTER COLUMN c_partstates TYPE TEXT;\\n\"`";
@


1.1
log
@Update to 2.3.2

Major verion jump, on upgrade, which includes a DB schema change.
For additional upgrade instructions to the usual ones, check the README.

Enable a couple of tests that don't require a configuration, and DB etc.
Thought 3 are failing.

OK giovanni@@ (who also gave OK for www/sogo)
@
text
@d1 1
a1 1
$OpenBSD$
d3 1
a3 1
+++ Scripts/sql-update-2.2.17_to_2.3.0.sh	Mon Sep 21 13:17:17 2015
d34 9
@

