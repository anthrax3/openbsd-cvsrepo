head	1.1;
access;
symbols
	OPENBSD_6_0:1.1.0.18
	OPENBSD_6_0_BASE:1.1
	OPENBSD_5_9:1.1.0.14
	OPENBSD_5_9_BASE:1.1
	OPENBSD_5_8:1.1.0.16
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.12
	OPENBSD_5_7_BASE:1.1
	OPENBSD_5_6:1.1.0.10
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.8
	OPENBSD_5_5_BASE:1.1
	OPENBSD_5_4:1.1.0.6
	OPENBSD_5_4_BASE:1.1
	OPENBSD_5_3:1.1.0.4
	OPENBSD_5_3_BASE:1.1
	OPENBSD_5_2:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2012.08.20.09.51.20;	author jasper;	state Exp;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2012.08.20.17.20.58;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.1
log
@Security fix for CVE-2012-3505, tinyproxy: multiple headers hashmap DoS
@
text
@$OpenBSD$

Security fix for CVE-2012-3505, tinyproxy: multiple headers hashmap DoS
Patch from https://bugzilla.redhat.com/show_bug.cgi?id=849368
CVE-2012-3505-tinyproxy-limit-headers.patch

--- src/reqs.c.orig	Mon Feb  7 13:31:03 2011
+++ src/reqs.c	Mon Aug 20 11:46:43 2012
@@@@ -610,6 +610,11 @@@@ add_header_to_connection (hashmap_t hashofheaders, cha
         return hashmap_insert (hashofheaders, header, sep, len);
 }
 
+/* define max number of headers. big enough to handle legitimate cases,
+ * but limited to avoid DoS 
+ */
+#define MAX_HEADERS 10000
+
 /*
  * Read all the headers from the stream
  */
@@@@ -617,6 +622,7 @@@@ static int get_all_headers (int fd, hashmap_t hashofhe
 {
         char *line = NULL;
         char *header = NULL;
+	int count;
         char *tmp;
         ssize_t linelen;
         ssize_t len = 0;
@@@@ -625,7 +631,7 @@@@ static int get_all_headers (int fd, hashmap_t hashofhe
         assert (fd >= 0);
         assert (hashofheaders != NULL);
 
-        for (;;) {
+        for (count = 0; count < MAX_HEADERS; count++) {
                 if ((linelen = readline (fd, &line)) <= 0) {
                         safefree (header);
                         safefree (line);
@@@@ -691,6 +697,12 @@@@ static int get_all_headers (int fd, hashmap_t hashofhe
 
                 safefree (line);
         }
+
+	/* if we get there, this is we reached MAX_HEADERS count.
+	   bail out with error */
+	safefree (header);
+	safefree (line);
+	return -1;
 }
 
 /*
@


1.1.2.1
log
@Security fix for CVE-2012-3505, tinyproxy: multiple headers hashmap DoS
@
text
@@

