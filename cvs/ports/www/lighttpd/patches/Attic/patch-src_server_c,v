head	1.18;
access;
symbols
	OPENBSD_5_7:1.14.0.4
	OPENBSD_5_7_BASE:1.14
	OPENBSD_5_6:1.14.0.2
	OPENBSD_5_6_BASE:1.14
	OPENBSD_5_4:1.11.0.2
	OPENBSD_4_9:1.8.0.2
	OPENBSD_4_9_BASE:1.8
	OPENBSD_4_8:1.7.0.6
	OPENBSD_4_8_BASE:1.7
	OPENBSD_4_7:1.7.0.4
	OPENBSD_4_7_BASE:1.7
	OPENBSD_4_6:1.7.0.2
	OPENBSD_4_3:1.5.0.2
	OPENBSD_4_3_BASE:1.5;
locks; strict;
comment	@# @;


1.18
date	2016.11.11.10.23.34;	author sthen;	state dead;
branches;
next	1.17;
commitid	zcSafSSsrSci3osM;

1.17
date	2016.10.12.08.09.26;	author ajacoutot;	state Exp;
branches;
next	1.16;
commitid	RcsywKx0OmgVaY4K;

1.16
date	2016.09.17.20.22.41;	author ajacoutot;	state Exp;
branches;
next	1.15;
commitid	erqZjU8459iZzz15;

1.15
date	2015.07.27.08.44.40;	author ajacoutot;	state dead;
branches;
next	1.14;
commitid	snxUuQF7GtUjXo3P;

1.14
date	2014.04.13.07.03.19;	author brad;	state Exp;
branches
	1.14.4.1;
next	1.13;

1.13
date	2014.01.23.23.24.14;	author brad;	state dead;
branches;
next	1.12;

1.12
date	2013.11.30.20.35.44;	author brad;	state Exp;
branches;
next	1.11;

1.11
date	2013.11.08.21.39.43;	author brad;	state Exp;
branches
	1.11.2.1;
next	1.10;

1.10
date	2011.07.07.14.34.36;	author sthen;	state dead;
branches;
next	1.9;

1.9
date	2011.04.25.09.39.36;	author sthen;	state Exp;
branches;
next	1.8;

1.8
date	2010.08.18.11.16.55;	author sthen;	state Exp;
branches
	1.8.2.1;
next	1.7;

1.7
date	2009.10.27.23.02.11;	author sthen;	state Exp;
branches
	1.7.2.1;
next	1.6;

1.6
date	2008.03.16.18.43.31;	author brad;	state dead;
branches;
next	1.5;

1.5
date	2008.03.02.10.04.22;	author jasper;	state Exp;
branches;
next	1.4;

1.4
date	2007.07.25.21.31.46;	author rui;	state dead;
branches;
next	1.3;

1.3
date	2007.07.22.19.44.17;	author rui;	state Exp;
branches;
next	1.2;

1.2
date	2006.03.09.19.00.59;	author brad;	state dead;
branches;
next	1.1;

1.1
date	2006.03.06.06.21.02;	author sturm;	state Exp;
branches;
next	;

1.7.2.1
date	2009.12.05.22.43.33;	author william;	state Exp;
branches;
next	;

1.8.2.1
date	2011.05.02.12.05.38;	author jasper;	state Exp;
branches;
next	;

1.11.2.1
date	2013.11.22.08.42.13;	author jasper;	state Exp;
branches;
next	1.11.2.2;

1.11.2.2
date	2013.12.01.10.08.23;	author jasper;	state Exp;
branches;
next	1.11.2.3;

1.11.2.3
date	2014.03.25.18.42.26;	author brad;	state dead;
branches;
next	;

1.14.4.1
date	2015.07.27.08.56.06;	author jasper;	state dead;
branches;
next	;
commitid	9wLX2kXy9Meu7YwA;


desc
@@


1.18
log
@update to lighttpd-1.4.43, from Brad
@
text
@$OpenBSD: patch-src_server_c,v 1.17 2016/10/12 08:09:26 ajacoutot Exp $

- [core] fix crash if ready events on abandoned fd (fixes #2748)
- performance: use Linux extended syscalls and flags

--- src/server.c.orig	Mon Oct 10 18:06:08 2016
+++ src/server.c	Mon Oct 10 18:04:38 2016
@@@@ -926,7 +926,7 @@@@ int main (int argc, char **argv) {
 
 	/* open pid file BEFORE chroot */
 	if (!buffer_string_is_empty(srv->srvconf.pid_file)) {
-		if (-1 == (pid_fd = open(srv->srvconf.pid_file->ptr, O_WRONLY | O_CREAT | O_EXCL | O_TRUNC, S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH))) {
+		if (-1 == (pid_fd = fdevent_open_cloexec(srv->srvconf.pid_file->ptr, O_WRONLY | O_CREAT | O_EXCL | O_TRUNC, S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH))) {
 			struct stat st;
 			if (errno != EEXIST) {
 				log_error_write(srv, __FILE__, __LINE__, "sbs",
@@@@ -951,7 +951,6 @@@@ int main (int argc, char **argv) {
 				return -1;
 			}
 		}
-		fd_close_on_exec(pid_fd);
 	}
 
 	if (srv->event_handler == FDEVENT_HANDLER_SELECT) {
@@@@ -1484,6 +1483,7 @@@@ int main (int argc, char **argv) {
 		FAMNoExists(&srv->stat_cache->fam);
 #endif
 
+		fd_close_on_exec(FAMCONNECTION_GETFD(&srv->stat_cache->fam));
 		fdevent_register(srv->ev, FAMCONNECTION_GETFD(&srv->stat_cache->fam), stat_cache_handle_fdevent, NULL);
 		fdevent_event_set(srv->ev, &(srv->stat_cache->fam_fcce_ndx), FAMCONNECTION_GETFD(&srv->stat_cache->fam), FDEVENT_IN);
 	}
@@@@ -1497,7 +1497,7 @@@@ int main (int argc, char **argv) {
 	for (i = 0; i < srv->srv_sockets.used; i++) {
 		server_socket *srv_socket = srv->srv_sockets.ptr[i];
 		if (srv->sockets_disabled) continue; /* lighttpd -1 (one-shot mode) */
-		if (-1 == fdevent_fcntl_set(srv->ev, srv_socket->fd)) {
+		if (-1 == fdevent_fcntl_set_nb_cloexec_sock(srv->ev, srv_socket->fd)) {
 			log_error_write(srv, __FILE__, __LINE__, "ss", "fcntl failed:", strerror(errno));
 			return -1;
 		}
@@@@ -1792,8 +1792,11 @@@@ int main (int argc, char **argv) {
 				fd      = fdevent_event_get_fd     (srv->ev, fd_ndx);
 				handler = fdevent_get_handler(srv->ev, fd);
 				context = fdevent_get_context(srv->ev, fd);
-				(*handler)(srv, context, revents);
+				if (NULL != handler) {
+					(*handler)(srv, context, revents);
+				}
 			} while (--n > 0);
+			fdevent_sched_run(srv, srv->ev);
 		} else if (n < 0 && errno != EINTR) {
 			log_error_write(srv, __FILE__, __LINE__, "ss",
 					"fdevent_poll failed:",
@


1.17
log
@Bring in a commit from upstream
- performance: use Linux extended syscalls and flags

from Brad (maintainer)
@
text
@d1 1
a1 1
$OpenBSD: patch-src_server_c,v 1.16 2016/09/17 20:22:41 ajacoutot Exp $
@


1.16
log
@Update to lighttpd-1.4.41.

from Brad (maintainer)
@
text
@d1 1
a1 1
$OpenBSD$
d3 2
a4 1
[core] fix crash if ready events on abandoned fd (fixes #2748)
d6 36
a41 2
--- src/server.c.orig	Wed Sep 14 21:07:23 2016
+++ src/server.c	Wed Sep 14 21:04:56 2016
@


1.15
log
@SECURITY update to lighttpd-1.4.36.
CVE-2015-3200: escape all strings for logging (fixes #2646 log file injection)

from Brad (maintainer)
@
text
@d1 1
a1 1
$OpenBSD: patch-src_server_c,v 1.14 2014/04/13 07:03:19 brad Exp $
d3 1
a3 2
Use keep-alive timeout while waiting for HTTP headers; use always the read
timeout while waiting for the HTTP body.
d5 15
a19 37
--- src/server.c.orig	Fri Apr 11 21:54:28 2014
+++ src/server.c	Fri Apr 11 21:59:07 2014
@@@@ -1296,23 +1296,25 @@@@ int main (int argc, char **argv) {
 
 					if (con->state == CON_STATE_READ ||
 					    con->state == CON_STATE_READ_POST) {
-						if (con->request_count == 1) {
+						if (con->request_count == 1 || con->state == CON_STATE_READ_POST) {
 							if (srv->cur_ts - con->read_idle_ts > con->conf.max_read_idle) {
 								/* time - out */
-#if 0
-								log_error_write(srv, __FILE__, __LINE__, "sd",
-										"connection closed - read-timeout:", con->fd);
-#endif
+								if (con->conf.log_request_handling) {
+									log_error_write(srv, __FILE__, __LINE__, "sd",
+											"connection closed - read-timeout:", con->fd);
+								}
+
 								connection_set_state(srv, con, CON_STATE_ERROR);
 								changed = 1;
 							}
 						} else {
 							if (srv->cur_ts - con->read_idle_ts > con->keep_alive_idle) {
 								/* time - out */
-#if 0
-								log_error_write(srv, __FILE__, __LINE__, "sd",
-										"connection closed - read-timeout:", con->fd);
-#endif
+								if (con->conf.log_request_handling) {
+									log_error_write(srv, __FILE__, __LINE__, "sd",
+											"connection closed - keep-alive:", con->fd);
+								}
+
 								connection_set_state(srv, con, CON_STATE_ERROR);
 								changed = 1;
 							}
@


1.14
log
@Upstream bug fix:

Use keep-alive timeout while waiting for HTTP headers; use always the read
timeout while waiting for the HTTP body.

ok sthen@@
@
text
@d1 1
a1 1
$OpenBSD$
@


1.14.4.1
log
@SECURITY update to lighttpd-1.4.36.
CVE-2015-3200: escape all strings for logging (fixes #2646 log file injection)
@
text
@d1 1
a1 1
$OpenBSD: patch-src_server_c,v 1.14 2014/04/13 07:03:19 brad Exp $
@


1.13
log
@Update to lighttpd 1.4.34.

ok sthen@@
@
text
@d1 1
a1 1
$OpenBSD: patch-src_server_c,v 1.12 2013/11/30 20:35:44 brad Exp $
d3 2
a4 2
- Fix SNI handling; only use key+cert from SNI specific config. CVE-2013-4508
- Check success of setuid, setgid, setgroups. CVE-2013-4559
d6 37
a42 41
--- src/server.c.orig	Fri Aug 30 14:46:26 2013
+++ src/server.c	Fri Nov 29 20:39:39 2013
@@@@ -314,6 +314,9 @@@@ static void server_free(server *srv) {
 			buffer_free(s->ssl_verifyclient_username);
 #ifdef USE_OPENSSL
 			SSL_CTX_free(s->ssl_ctx);
+			EVP_PKEY_free(s->ssl_pemfile_pkey);
+			X509_free(s->ssl_pemfile_x509);
+			if (NULL != s->ssl_ca_file_cert_names) sk_X509_NAME_pop_free(s->ssl_ca_file_cert_names, X509_NAME_free);
 #endif
 			free(s);
 		}
@@@@ -817,8 +820,14 @@@@ int main (int argc, char **argv) {
 		 * to /etc/group
 		 * */
 		if (NULL != grp) {
-			setgid(grp->gr_gid);
-			setgroups(0, NULL);
+			if (-1 == setgid(grp->gr_gid)) {
+				log_error_write(srv, __FILE__, __LINE__, "ss", "setgid failed: ", strerror(errno));
+				return -1;
+			}
+			if (-1 == setgroups(0, NULL)) {
+				log_error_write(srv, __FILE__, __LINE__, "ss", "setgroups failed: ", strerror(errno));
+				return -1;
+			}
 			if (srv->srvconf.username->used) {
 				initgroups(srv->srvconf.username->ptr, grp->gr_gid);
 			}
@@@@ -841,7 +850,10 @@@@ int main (int argc, char **argv) {
 #ifdef HAVE_PWD_H
 		/* drop root privs */
 		if (NULL != pwd) {
-			setuid(pwd->pw_uid);
+			if (-1 == setuid(pwd->pw_uid)) {
+				log_error_write(srv, __FILE__, __LINE__, "ss", "setuid failed: ", strerror(errno));
+				return -1;
+			}
 		}
 #endif
 #if defined(HAVE_SYS_PRCTL_H) && defined(PR_SET_DUMPABLE)
@


1.12
log
@Two fixes from upstream..

- Check success of setuid, setgid, setgroups. CVE-2013-4559
- Fix regression from CVE-2013-4508 (client-cert sessions were broken)

ok sthen@@
@
text
@d1 1
a1 1
$OpenBSD: patch-src_server_c,v 1.11 2013/11/08 21:39:43 brad Exp $
@


1.11
log
@Fix SNI handling; only use key+cert from SNI specific config. CVE-2013-4508

ok sthen@@
@
text
@d1 1
a1 1
$OpenBSD$
d3 2
a4 1
Fix SNI handling; only use key+cert from SNI specific config. CVE-2013-4508
d7 1
a7 1
+++ src/server.c	Fri Nov  8 16:17:55 2013
d18 29
@


1.11.2.1
log
@- update lighttpd to 1.4.33 and apply the security fixes for CVE-2013-4508

testing/ok sthen@@
@
text
@d1 1
a1 1
$OpenBSD: patch-src_server_c,v 1.11 2013/11/08 21:39:43 brad Exp $
@


1.11.2.2
log
@backport security fixes for CVE-2013-4559 and fix regression of CVE-2013-4508
@
text
@d1 1
a1 1
$OpenBSD: patch-src_server_c,v 1.12 2013/11/30 20:35:44 brad Exp $
d3 1
a3 2
- Fix SNI handling; only use key+cert from SNI specific config. CVE-2013-4508
- Check success of setuid, setgid, setgroups. CVE-2013-4559
d6 1
a6 1
+++ src/server.c	Fri Nov 29 20:39:39 2013
a16 29
@@@@ -817,8 +820,14 @@@@ int main (int argc, char **argv) {
 		 * to /etc/group
 		 * */
 		if (NULL != grp) {
-			setgid(grp->gr_gid);
-			setgroups(0, NULL);
+			if (-1 == setgid(grp->gr_gid)) {
+				log_error_write(srv, __FILE__, __LINE__, "ss", "setgid failed: ", strerror(errno));
+				return -1;
+			}
+			if (-1 == setgroups(0, NULL)) {
+				log_error_write(srv, __FILE__, __LINE__, "ss", "setgroups failed: ", strerror(errno));
+				return -1;
+			}
 			if (srv->srvconf.username->used) {
 				initgroups(srv->srvconf.username->ptr, grp->gr_gid);
 			}
@@@@ -841,7 +850,10 @@@@ int main (int argc, char **argv) {
 #ifdef HAVE_PWD_H
 		/* drop root privs */
 		if (NULL != pwd) {
-			setuid(pwd->pw_uid);
+			if (-1 == setuid(pwd->pw_uid)) {
+				log_error_write(srv, __FILE__, __LINE__, "ss", "setuid failed: ", strerror(errno));
+				return -1;
+			}
 		}
 #endif
 #if defined(HAVE_SYS_PRCTL_H) && defined(PR_SET_DUMPABLE)
@


1.11.2.3
log
@MFC security update to lighttpd 1.4.35. CVE-2014-2323, CVE-2014-2324
http://download.lighttpd.net/lighttpd/security/lighttpd_sa_2014_01.txt

ok sthen@@
@
text
@d1 1
a1 1
$OpenBSD: patch-src_server_c,v 1.11.2.2 2013/12/01 10:08:23 jasper Exp $
@


1.10
log
@update lighttpd to 1.4.29, from Brad

- while there, remove patch-src_server_c too, all the various /dev/*random
are equivalent now, ok Brad
@
text
@d1 16
a16 21
$OpenBSD: patch-src_server_c,v 1.9 2011/04/25 09:39:36 sthen Exp $
--- src/server.c.orig	Tue Aug 17 05:04:38 2010
+++ src/server.c	Sun Apr 24 22:28:50 2011
@@@@ -211,7 +211,7 @@@@ static server *server_init(void) {
 		srv->mtime_cache[i].str = buffer_init();
 	}
 
-	if ((NULL != (frandom = fopen("/dev/urandom", "rb")) || NULL != (frandom = fopen("/dev/random", "rb")))
+	if ((NULL != (frandom = fopen("/dev/arandom", "rb")) || NULL != (frandom = fopen("/dev/urandom", "rb")))
 	            && 1 == fread(srv->entropy, sizeof(srv->entropy), 1, frandom)) {
 		unsigned int e;
 		memcpy(&e, srv->entropy, sizeof(e) < sizeof(srv->entropy) ? sizeof(e) : sizeof(srv->entropy));
@@@@ -306,6 +306,8 @@@@ static void server_free(server *srv) {
 			buffer_free(s->ssl_pemfile);
 			buffer_free(s->ssl_ca_file);
 			buffer_free(s->ssl_cipher_list);
+			buffer_free(s->ssl_dh_file);
+			buffer_free(s->ssl_ec_curve);
 			buffer_free(s->error_handler);
 			buffer_free(s->errorfile_prefix);
 			array_free(s->mimetypes);
@


1.9
log
@- backport a patch from upstream to avoid a conflict between OpenSSL and
internal implementations of MD5. Fixes SSL problems with some clients.

From Brad
@
text
@d1 1
a1 1
$OpenBSD: patch-src_server_c,v 1.8 2010/08/18 11:16:55 sthen Exp $
@


1.8
log
@lighttpd 1.4.27; various fixes/cleanup. From Brad, small conf tweak from me.
@
text
@d1 3
a3 3
$OpenBSD: patch-src_server_c,v 1.7 2009/10/27 23:02:11 sthen Exp $
--- src/server.c.orig	Sat Aug  7 07:00:16 2010
+++ src/server.c	Sun Aug  8 22:18:55 2010
d13 9
@


1.8.2.1
log
@- Fixes from upstream via Brad (maintainer)
* mod_proxy: fix delayed connect
* mod_cgi: make read buffer as big as incoming data block
* ssl: Support for Diffie-Hellman and Elliptic-Curve Diffie-Hellman
key exchange (add ssl.use-sslv3)

- backport a patch from upstream to avoid a conflict between OpenSSL and
internal implementations of MD5. Fixes SSL problems with some clients.
@
text
@d1 3
a3 3
$OpenBSD: patch-src_server_c,v 1.9 2011/04/25 09:39:36 sthen Exp $
--- src/server.c.orig	Tue Aug 17 05:04:38 2010
+++ src/server.c	Sun Apr 24 22:28:50 2011
a12 9
@@@@ -306,6 +306,8 @@@@ static void server_free(server *srv) {
 			buffer_free(s->ssl_pemfile);
 			buffer_free(s->ssl_ca_file);
 			buffer_free(s->ssl_cipher_list);
+			buffer_free(s->ssl_dh_file);
+			buffer_free(s->ssl_ec_curve);
 			buffer_free(s->error_handler);
 			buffer_free(s->errorfile_prefix);
 			array_free(s->mimetypes);
@


1.7
log
@update to 1.4.24, from Brad (maintainer).
@
text
@d1 3
a3 3
$OpenBSD$
--- src/server.c.orig	Wed Oct 14 14:05:43 2009
+++ src/server.c	Mon Oct 19 16:44:37 2009
d11 2
a12 2
 		srand(*(unsigned int*)srv->entropy);
 		srv->is_real_entropy = 1;
@


1.7.2.1
log
@MFC:

lighttpd-1.4.25

bugfix / stability update

requested by Brad, MAINTAINER

ok Brad, jasper@@
@
text
@@


1.6
log
@upgrade to lighttpd 1.4.19. security and bug fix update. CVE-2008-1270

looks good jasper@@
@
text
@d1 6
a6 6
$OpenBSD: patch-src_server_c,v 1.5 2008/03/02 10:04:22 jasper Exp $
--- src/server.c.orig	Fri Feb 29 15:52:04 2008
+++ src/server.c	Fri Feb 29 18:59:11 2008
@@@@ -697,9 +697,6 @@@@ int main (int argc, char **argv) {
 			}
 		}
d8 5
a12 42
-		/* #372: solaris need some fds extra for devpoll */
-		if (rlim.rlim_cur > 10) rlim.rlim_cur -= 10;
-
 		if (srv->event_handler == FDEVENT_HANDLER_SELECT) {
 			srv->max_fds = rlim.rlim_cur < FD_SETSIZE - 200 ? rlim.rlim_cur : FD_SETSIZE - 200;
 		} else {
@@@@ -759,6 +756,19 @@@@ int main (int argc, char **argv) {
 
 			return -1;
 		}
+
+#ifdef HAVE_PWD_H
+		/**
+		 * initgroups() has to be called before chroot()
+		 */
+		if (srv->srvconf.groupname->used) {
+			setgid(grp->gr_gid);
+			setgroups(0, NULL);
+			if (srv->srvconf.username->used) {
+				initgroups(srv->srvconf.username->ptr, grp->gr_gid);
+			}
+		}
+#endif
 #ifdef HAVE_CHROOT
 		if (srv->srvconf.changeroot->used) {
 			tzset();
@@@@ -775,15 +785,7 @@@@ int main (int argc, char **argv) {
 #endif
 #ifdef HAVE_PWD_H
 		/* drop root privs */
-		if (srv->srvconf.groupname->used) {
-			setgid(grp->gr_gid);
-			setgroups(0, NULL);
-		}
-
 		if (srv->srvconf.username->used) {
-			if (srv->srvconf.groupname->used) {
-				initgroups(srv->srvconf.username->ptr, grp->gr_gid);
-			}
 			setuid(pwd->pw_uid);
 		}
 #endif
@


1.5
log
@- SECURITY FIX for CVE-2008-0983
  ( http://secunia.com/cve_reference/CVE-2008-0983/ )
- add a patch to fix issues with group permissions,
  provided by Antti Harri ( already accepted upstream )

ok naddy@@ brad@@ (MAINTAINER)
@
text
@d1 1
a1 1
$OpenBSD$
@


1.4
log
@update lighttpd to 1.4.16

ok brad (maintainer), simon@@
@
text
@d1 15
a15 4
$OpenBSD: patch-src_server_c,v 1.3 2007/07/22 19:44:17 rui Exp $
--- src/server.c.orig	Fri Apr 13 16:26:31 2007
+++ src/server.c	Sat Jul 21 11:21:46 2007
@@@@ -775,6 +775,22 @@@@ int main (int argc, char **argv) {
d18 2
a19 1
 
d21 1
a21 1
+		 * we are not root can can't increase the fd-limit, but we can reduce it
d23 5
a27 10
+		if (srv->srvconf.max_fds && srv->srvconf.max_fds < rlim.rlim_cur) {
+			/* set rlimits */
+
+			rlim.rlim_cur = srv->srvconf.max_fds;
+
+			if (0 != setrlimit(RLIMIT_NOFILE, &rlim)) {
+				log_error_write(srv, __FILE__, __LINE__,
+						"ss", "couldn't set 'max filedescriptors'",
+						strerror(errno));
+				return -1;
d30 20
a49 4
+
 		if (srv->event_handler == FDEVENT_HANDLER_SELECT) {
 			srv->max_fds = rlim.rlim_cur < FD_SETSIZE - 200 ? rlim.rlim_cur : FD_SETSIZE - 200;
 		} else {
@


1.3
log
@roll in some distribution patches which fix multiple vulnerabilities.
Reference: http://secunia.com/advisories/26130/

ok kili@@, simon@@
@
text
@d1 1
a1 1
$OpenBSD$
@


1.2
log
@upgrade to lighttpd 1.4.11
@
text
@d1 6
a6 11
$OpenBSD: patch-src_server_c,v 1.1 2006/03/06 06:21:02 sturm Exp $
--- src/server.c.orig	Sun Mar  5 09:31:35 2006
+++ src/server.c	Sun Mar  5 09:31:43 2006
@@@@ -118,8 +118,6 @@@@ static void daemonize(void) {
 	if (0 != fork()) exit(0);
 	
 	if (0 != chdir("/")) exit(0);
-	
-	umask(0);
 }
 #endif
d8 19
@


1.1
log
@don't set umask to 0 when daemonizing (changed upstream as well)

from Matthias Kilian <kili at outback.escape.de>
ok brad
@
text
@d1 1
a1 1
$OpenBSD$
@

