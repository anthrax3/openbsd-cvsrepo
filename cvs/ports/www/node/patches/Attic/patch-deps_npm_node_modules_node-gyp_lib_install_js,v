head	1.3;
access;
symbols;
locks; strict;
comment	@# @;


1.3
date	2012.05.23.15.13.41;	author jasper;	state dead;
branches;
next	1.2;

1.2
date	2012.05.10.18.29.52;	author sthen;	state Exp;
branches;
next	1.1;

1.1
date	2012.05.09.06.37.49;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.3
log
@be gone, you belong in lang/ now.
@
text
@$OpenBSD: patch-deps_npm_node_modules_node-gyp_lib_install_js,v 1.2 2012/05/10 18:29:52 sthen Exp $

Allow building of sub-packages (ie. node-sqlite3) with USE_SYSTRACE
set, also prevents downloading of the node distfile again.

--- deps/npm/node_modules/node-gyp/lib/install.js.orig	Thu May 10 07:09:14 2012
+++ deps/npm/node_modules/node-gyp/lib/install.js	Thu May 10 07:15:41 2012
@@@@ -166,10 +166,19 @@@@ function install (gyp, argv, callback) {
     extracter.on('error', cb)
     extracter.on('end', afterTarball)
 
-    // download the tarball, gunzip and extract!
-    var req = download(tarballUrl, downloadError)
-      .pipe(gunzip)
-      .pipe(extracter)
+	// OpenBSD fix
+	var filePath = '${PREFIX}/lib/node/${DISTFILES}';
+	fs.stat(filePath, function(err, stat) {
+		if (err) {
+			throw err;
+		} else {
+			// use packaged tarball
+			fs.createReadStream(filePath)
+			  .pipe(gunzip)
+			  .pipe(extracter)
+		}
+	});
+	// OpenBSD fix 
 
     // something went wrong downloading the tarball?
     function downloadError (err, res) {
@


1.2
log
@tweaks to node:

- install tar.gz source, and patch node-gyp to use it rather than
attempting to download from the 'net when building a native extension,
from Aaron Bieber (maintainer).

- set V=1 in node-gyp to avoid hiding compiler command lines
(from me, ok jasper).
@
text
@d1 1
a1 1
$OpenBSD: patch-deps_npm_node_modules_node-gyp_lib_install_js,v 1.1 2012/05/09 06:37:49 jasper Exp $
@


1.1
log
@- Allow building of sub-packages (ie. node-sqlite3) with USE_SYSTRACE
set, also prevents downloading of the node distfile again.

from MAINTAINER

- add run dependency on sysutils/flock.

now node-sqlite3 builds fine.
@
text
@d1 1
a1 1
$OpenBSD$
d6 3
a8 3
--- deps/npm/node_modules/node-gyp/lib/install.js.orig	Tue May  8 20:06:20 2012
+++ deps/npm/node_modules/node-gyp/lib/install.js	Tue May  8 20:08:56 2012
@@@@ -166,11 +166,21 @@@@ function install (gyp, argv, callback) {
d16 2
a17 3
-
+	var filePath = '${DISTDIR}/node-v' + version + '.tar.gz';
+	gyp.info('If this fails, please ensure ' + filePath + ' exists!!')
d20 1
a20 4
+			// download the tarball
+			var req = download(tarballUrl, downloadError)
+			  .pipe(gunzip)
+			  .pipe(extracter)
d22 1
a22 1
+			// use existing tarball
d28 2
a31 1
       if (err || res.statusCode != 200) {
@

