head	1.3;
access;
symbols
	OPENBSD_5_7:1.2.0.4
	OPENBSD_5_7_BASE:1.2
	OPENBSD_5_6:1.2.0.2
	OPENBSD_5_6_BASE:1.2
	OPENBSD_5_5:1.1.0.10
	OPENBSD_5_5_BASE:1.1
	OPENBSD_5_4:1.1.0.8
	OPENBSD_5_4_BASE:1.1
	OPENBSD_5_3:1.1.0.6
	OPENBSD_5_3_BASE:1.1
	OPENBSD_5_2:1.1.0.4
	OPENBSD_5_2_BASE:1.1
	OPENBSD_5_1_BASE:1.1
	OPENBSD_5_1:1.1.0.2;
locks; strict;
comment	@# @;


1.3
date	2015.07.26.01.33.26;	author jeremy;	state dead;
branches;
next	1.2;
commitid	XHDvbHl3gYXQ5RX5;

1.2
date	2014.06.24.21.45.06;	author jeremy;	state Exp;
branches;
next	1.1;
commitid	l38n2YOWdyClHIIT;

1.1
date	2011.12.13.18.38.18;	author jeremy;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Update to passenger 5.0.14

Remove subpackages, revert to a single package, since standalone package
is now only 10% the size of the main package.
@
text
@$OpenBSD: patch-lib_phusion_passenger_standalone_start_command_rb,v 1.2 2014/06/24 21:45:06 jeremy Exp $

The if false removes a method that tries to download and compile nginx and
install it into the user's home directory (even if you change HOME!)

We compile the standalone version of nginx in advance and place it in the
gem standalone directory so there isn't a need to compile at runtime.

Add a rescue clause so that attempting to kill a process that may or may not
exist doesn't raise an error.

--- lib/phusion_passenger/standalone/start_command.rb.orig	Thu May 29 05:13:26 2014
+++ lib/phusion_passenger/standalone/start_command.rb	Thu Jun  5 14:16:51 2014
@@@@ -389,13 +389,13 @@@@ private
 				sockaddr = Socket.pack_sockaddr_in(port, address)
 				begin
 					socket.connect_nonblock(sockaddr)
-				rescue Errno::ENOENT, Errno::EINPROGRESS, Errno::EAGAIN, Errno::EWOULDBLOCK
+				rescue Errno::ENOENT, Errno::EINPROGRESS, Errno::EAGAIN, Errno::EWOULDBLOCK, Errno::EINVAL
 					if select(nil, [socket], nil, 0.1)
 						begin
 							socket.connect_nonblock(sockaddr)
 						rescue Errno::EISCONN
 						rescue Errno::EINVAL
-							if PlatformInfo.os_name =~ /freebsd/i
+							if PlatformInfo.os_name =~ /bsd/i
 								raise Errno::ECONNREFUSED
 							else
 								raise
@@@@ -477,24 +477,12 @@@@ private
 			:dont_compile_runtime => @@options[:dont_compile_runtime],
 			:plugin      => @@plugin)
 		return installer.run
-	end
+	end if false
 
 	def ensure_runtime_installed
-		if @@runtime_locator.everything_installed?
-			if !File.exist?(@@runtime_locator.find_nginx_binary)
-				error "The web helper binary '#{@@runtime_locator.find_nginx_binary}' does not exist."
-				exit 1
-			end
-		else
-			if !@@runtime_locator.find_support_dir && PhusionPassenger.natively_packaged?
-				error "Your Phusion Passenger Standalone installation is broken: the support " +
-					"files could not be found. Please reinstall Phusion Passenger Standalone. " +
-					"If this problem persists, please contact your packager."
-				exit 1
-			end
-			install_runtime(@@runtime_locator) || exit(1)
-			@@runtime_locator.reload
-		end
+		gem_root_dir = File.dirname(File.dirname(File.dirname(File.dirname(__FILE__))))
+		@@options[:runtime_dir] = File.join(gem_root_dir, 'standalone')
+		@@runtime_locator.reload
 	end
 
 	def set_stdout_stderr_binmode
@@@@ -675,7 +663,7 @@@@ private
 			if @@options[:socket_file]
 				socket = UNIXSocket.new(@@options[:socket_file])
 			else
-				socket = TCPSocket.new(@@options[:address], nginx_ping_port)
+				socket = TCPSocket.new(@@options[:address] == '0.0.0.0' ? '127.0.0.1' : @@options[:address], nginx_ping_port)
 			end
 			begin
 				socket.read rescue nil
@


1.2
log
@Update passenger to 4.0.44.  Update the nginx version used by
passenger standalone to 1.4.7.

Thanks to Frank Groeneveld for feedback and testing.
@
text
@d1 1
a1 1
$OpenBSD: patch-lib_phusion_passenger_standalone_start_command_rb,v 1.1 2011/12/13 18:38:18 jeremy Exp $
@


1.1
log
@Update to 3.0.11.  Support by the standalone version of passenger by
splitting into a multipackage, with a subpackage for the standalone
version (which embeds a version of nginx).  The standalone version
operates much like other ruby webservers, serving a single ruby/rack
application.

Switch to using the gem version of passenger.  Because the gem
installs into a versioned directory, setup symlinks to the
versioned directory so that nginx configuration files don't need
to be modified when the version is updated.
@
text
@d1 1
a1 1
$OpenBSD$
d12 20
a31 4
--- lib/phusion_passenger/standalone/start_command.rb.orig	Thu Jan  1 01:00:00 1970
+++ lib/phusion_passenger/standalone/start_command.rb	Wed Nov 16 13:46:41 2011
@@@@ -292,7 +292,7 @@@@ private
 			:binaries_url_root => @@options[:binaries_url_root],
d33 1
a33 1
 		installer.start
d36 13
a48 22
 	
 	def passenger_support_files_dir
 		return "#{@@runtime_dir}/support"
@@@@ -303,23 +303,9 @@@@ private
 	end
 	
 	def ensure_nginx_installed
-		if @@options[:nginx_bin] && !File.exist?(@@options[:nginx_bin])
-			error "The given Nginx binary '#{@@options[:nginx_bin]}' does not exist."
-			exit 1
-		end
-		
-		home           = Etc.getpwuid.dir
-		@@runtime_dir   = "#{GLOBAL_STANDALONE_RESOURCE_DIR}/#{runtime_version_string}"
-		if !File.exist?("#{nginx_dir}/sbin/nginx")
-			if Process.euid == 0
-				install_runtime
-			else
-				@@runtime_dir = "#{home}/#{LOCAL_STANDALONE_RESOURCE_DIR}/#{runtime_version_string}"
-				if !File.exist?("#{nginx_dir}/sbin/nginx")
-					install_runtime
-				end
d50 2
d54 2
a55 17
+		@@options[:nginx_bin] = File.join(gem_root_dir, 'standalone', 'nginx')
+		@@runtime_dir = File.join(gem_root_dir, 'standalone')
 	end
 	
 	def ensure_directory_exists(dir)
@@@@ -417,7 +403,11 @@@@ private
 					end
 				end
 			ensure
-				Process.kill('TERM', f.pid)
+				begin
+					Process.kill('TERM', f.pid)
+				rescue SystemCallError
+					nil
+				end
 			end
 		end
d57 3
a59 1
@@@@ -448,7 +438,7 @@@@ private
@

