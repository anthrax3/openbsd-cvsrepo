head	1.1;
branch	1.1.1;
access;
symbols
	OPENBSD_6_1:1.1.1.1.0.14
	OPENBSD_6_1_BASE:1.1.1.1
	OPENBSD_6_0:1.1.1.1.0.12
	OPENBSD_6_0_BASE:1.1.1.1
	OPENBSD_5_9:1.1.1.1.0.8
	OPENBSD_5_9_BASE:1.1.1.1
	OPENBSD_5_8:1.1.1.1.0.10
	OPENBSD_5_8_BASE:1.1.1.1
	OPENBSD_5_7:1.1.1.1.0.6
	OPENBSD_5_7_BASE:1.1.1.1
	OPENBSD_5_6:1.1.1.1.0.4
	OPENBSD_5_6_BASE:1.1.1.1
	OPENBSD_5_5:1.1.1.1.0.2
	OPENBSD_5_5_BASE:1.1.1.1
	brad_20130809:1.1.1.1
	brad:1.1.1;
locks; strict;
comment	@# @;


1.1
date	2013.08.10.02.48.26;	author brad;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2013.08.10.02.48.26;	author brad;	state Exp;
branches;
next	;


desc
@@



1.1
log
@Initial revision
@
text
@$OpenBSD$

Make sure that the logfile is created or reopened as read/write
by thttpd user only. CVE-2013-0348

--- src/thttpd.c.orig	Thu Mar 14 04:08:35 2013
+++ src/thttpd.c	Thu Mar 14 04:10:23 2013
@@@@ -326,6 +326,7 @@@@ static void
 re_open_logfile( void )
     {
     FILE* logfp;
+    int retchmod;
 
     if ( no_log || hs == (httpd_server*) 0 )
 	return;
@@@@ -335,7 +336,8 @@@@ re_open_logfile( void )
 	{
 	syslog( LOG_NOTICE, "re-opening logfile" );
 	logfp = fopen( logfile, "a" );
-	if ( logfp == (FILE*) 0 )
+	retchmod = chmod( logfile, S_IRUSR|S_IWUSR );
+	if ( logfp == (FILE*) 0 || retchmod != 0 )
 	    {
 	    syslog( LOG_CRIT, "re-opening %.80s - %m", logfile );
 	    return;
@@@@ -355,6 +357,7 @@@@ main( int argc, char** argv )
     gid_t gid = 32767;
     char cwd[MAXPATHLEN+1];
     FILE* logfp;
+    int retchmod;
     int num_ready;
     int cnum;
     connecttab* c;
@@@@ -424,7 +427,8 @@@@ main( int argc, char** argv )
 	else
 	    {
 	    logfp = fopen( logfile, "a" );
-	    if ( logfp == (FILE*) 0 )
+	    retchmod = chmod( logfile, S_IRUSR|S_IWUSR );
+	    if ( logfp == (FILE*) 0 || retchmod != 0 )
 		{
 		syslog( LOG_CRIT, "%.80s - %m", logfile );
 		perror( logfile );
@


1.1.1.1
log
@sthttpd is a simple, small, fast, and secure HTTP server. It doesn't have
a lot of special features, but it suffices for most uses of the web,
it's about as fast as the best full-featured servers (Apache, NCSA,
Netscape), and it has one extremely useful feature (URL-traffic-based
throttling) that no other server currently has.

ok sthen@@
@
text
@@
