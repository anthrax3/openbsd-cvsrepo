head	1.5;
access;
symbols
	OPENBSD_6_0:1.5.0.8
	OPENBSD_6_0_BASE:1.5
	OPENBSD_5_9:1.5.0.4
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.5.0.6
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.5.0.2
	OPENBSD_5_7_BASE:1.5
	OPENBSD_5_6:1.3.0.16
	OPENBSD_5_6_BASE:1.3
	OPENBSD_5_5:1.3.0.14
	OPENBSD_5_5_BASE:1.3
	OPENBSD_5_4:1.3.0.12
	OPENBSD_5_4_BASE:1.3
	OPENBSD_5_3:1.3.0.10
	OPENBSD_5_3_BASE:1.3
	OPENBSD_5_2:1.3.0.8
	OPENBSD_5_2_BASE:1.3
	OPENBSD_5_1_BASE:1.3
	OPENBSD_5_1:1.3.0.6
	OPENBSD_5_0:1.3.0.4
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_9:1.3.0.2
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.2.0.12
	OPENBSD_4_8_BASE:1.2
	OPENBSD_4_7:1.2.0.10
	OPENBSD_4_7_BASE:1.2
	OPENBSD_4_6:1.2.0.8
	OPENBSD_4_6_BASE:1.2
	OPENBSD_4_5:1.2.0.6
	OPENBSD_4_5_BASE:1.2
	OPENBSD_4_4:1.2.0.4
	OPENBSD_4_4_BASE:1.2
	OPENBSD_4_3:1.2.0.2
	OPENBSD_4_3_BASE:1.2
	OPENBSD_4_2:1.1.0.24
	OPENBSD_4_2_BASE:1.1
	OPENBSD_4_1:1.1.0.22
	OPENBSD_4_1_BASE:1.1
	OPENBSD_4_0:1.1.0.20
	OPENBSD_4_0_BASE:1.1
	OPENBSD_3_9:1.1.0.18
	OPENBSD_3_9_BASE:1.1
	OPENBSD_3_8:1.1.0.16
	OPENBSD_3_8_BASE:1.1
	OPENBSD_3_7:1.1.0.14
	OPENBSD_3_7_BASE:1.1
	OPENBSD_3_6:1.1.0.12
	OPENBSD_3_6_BASE:1.1
	OPENBSD_3_5:1.1.0.10
	OPENBSD_3_5_BASE:1.1
	OPENBSD_3_4:1.1.0.8
	OPENBSD_3_4_BASE:1.1
	OPENBSD_3_3:1.1.0.6
	OPENBSD_3_3_BASE:1.1
	OPENBSD_3_1:1.1.0.4
	OPENBSD_3_2:1.1.0.2
	OPENBSD_3_2_BASE:1.1;
locks; strict;
comment	@# @;


1.5
date	2015.01.03.09.11.22;	author ajacoutot;	state Exp;
branches;
next	1.4;
commitid	lvEcilaAeU95kxn2;

1.4
date	2014.12.10.15.51.59;	author jasper;	state Exp;
branches;
next	1.3;
commitid	WYEDCGwFwhxt9d9H;

1.3
date	2011.01.05.08.19.18;	author giovanni;	state Exp;
branches;
next	1.2;

1.2
date	2008.01.30.20.06.48;	author mbalmer;	state Exp;
branches;
next	1.1;

1.1
date	2002.04.17.16.17.45;	author danh;	state Exp;
branches
	1.1.4.1;
next	;

1.1.4.1
date	2002.12.10.15.20.56;	author brad;	state Exp;
branches;
next	;


desc
@@


1.5
log
@memmove() to prevent a backwards copy.
@
text
@$OpenBSD: patch-graphs_c,v 1.4 2014/12/10 15:51:59 jasper Exp $

- use memmove() instead of memcpy() to prevent a backwards copy

--- graphs.c.orig	Tue Apr  8 20:58:18 2014
+++ graphs.c	Wed Dec 10 11:05:24 2014
@@@@ -214,7 +214,7 @@@@ int year_graph6x(char *fname, char *title, struct hist
             if (j>28)
             {
                /* format the year string */
-               sprintf(maxvaltxt, "%04d", data[i].year);
+               snprintf(maxvaltxt, sizeof(maxvaltxt), "%04d", data[i].year);
                gdImageString(im,gdFontSmall,ci+((i-s_mth)*cs)+(j/2)-12,
                              236, (unsigned char *)maxvaltxt, CHLEGENDCOLOR);
             }
@@@@ -227,7 +227,7 @@@@ int year_graph6x(char *fname, char *title, struct hist
       if (data[i].page  > maxval) maxval = data[i].page;
    }
    if (maxval <= 0) maxval = 1;
-   sprintf(maxvaltxt, "%llu", maxval);
+   snprintf(maxvaltxt, sizeof(maxvaltxt), "%llu", maxval);
    gdImageStringUp(im,gdFontSmall,6,26+(strlen(maxvaltxt)*6),
                    (unsigned char *)maxvaltxt,CHLEGENDCOLOR);
 
@@@@ -274,7 +274,7 @@@@ int year_graph6x(char *fname, char *title, struct hist
        if (data[i].visit > maxval) maxval = data[i].visit;
    }
    if (maxval <= 0) maxval = 1;
-   sprintf(maxvaltxt, "%llu", maxval);
+   snprintf(maxvaltxt, sizeof(maxvaltxt), "%llu", maxval);
    gdImageStringUp(im, gdFontSmall,493,26+(strlen(maxvaltxt)*6),
                    (unsigned char *)maxvaltxt, CHLEGENDCOLOR);
 
@@@@ -310,10 +310,10 @@@@ int year_graph6x(char *fname, char *title, struct hist
    for (i=s_mth; i<HISTSIZE; i++)
        if (data[i].xfer > fmaxval) fmaxval = data[i].xfer;
    if (fmaxval <= 0.0) fmaxval = 1.0;
-   sprintf(maxvaltxt, "%s", hr_size(fmaxval*1024));
+   snprintf(maxvaltxt, sizeof(maxvaltxt), "%s", hr_size(fmaxval*1024));
    i=strstr(maxvaltxt,"&")-maxvaltxt; /* search for HTML-tag &nbsp;*/
    memset(maxvaltxt+i,' ',1); /* add space */
-   memcpy(maxvaltxt+i+1,maxvaltxt+i+6,strlen(maxvaltxt)-i); /* remove &nbsp; */
+   memmove(maxvaltxt+i+1,maxvaltxt+i+6,strlen(maxvaltxt)-i); /* remove &nbsp; */
    gdImageStringUp(im, gdFontSmall,493,130+(strlen(maxvaltxt)*6),
                    (unsigned char *)maxvaltxt,CHLEGENDCOLOR);
    
@@@@ -427,7 +427,7 @@@@ int month_graph6(     char  *fname,        /* filename
        if (data7[i] > maxval) maxval = data7[i];
    }
    if (maxval <= 0) maxval = 1;
-   sprintf(maxvaltxt, "%llu", maxval);
+   snprintf(maxvaltxt, sizeof(maxvaltxt), "%llu", maxval);
    gdImageStringUp(im, gdFontSmall,8,26+(strlen(maxvaltxt)*6),
                    (unsigned char *)maxvaltxt,CHLEGENDCOLOR);
 
@@@@ -549,7 +549,7 @@@@ int month_graph6(     char  *fname,        /* filename
       if (data8[i]>maxval) maxval = data8[i];
    }
    if (maxval <= 0) maxval = 1;
-   sprintf(maxvaltxt, "%llu", maxval);
+   snprintf(maxvaltxt, sizeof(maxvaltxt), "%llu", maxval);
    gdImageStringUp(im, gdFontSmall,8,224+(strlen(maxvaltxt)*6),
                    (unsigned char *)maxvaltxt, CHLEGENDCOLOR);
    
@@@@ -588,10 +588,10 @@@@ int month_graph6(     char  *fname,        /* filename
       }
    }
    if (fmaxval <= 0.0) fmaxval = 1.0;
-   sprintf(maxvaltxt, "%s", hr_size(fmaxval));
+   snprintf(maxvaltxt, sizeof(maxvaltxt), "%s", hr_size(fmaxval));
    i=strstr(maxvaltxt,"&")-maxvaltxt; /* search for HTML-tag &nbsp;*/
    memset(maxvaltxt+i,' ',1); /* add space */
-   memcpy(maxvaltxt+i+1,maxvaltxt+i+6,strlen(maxvaltxt)-i); /* remove &nbsp; */
+   memmove(maxvaltxt+i+1,maxvaltxt+i+6,strlen(maxvaltxt)-i); /* remove &nbsp; */
    gdImageStringUp(im, gdFontSmall,8,352+(strlen(maxvaltxt)*6),
                    (unsigned char *)maxvaltxt, CHLEGENDCOLOR);
    
@@@@ -696,7 +696,7 @@@@ int day_graph3(     char  *fname,
       if (data3[i] > maxval) maxval = data3[i];
    }
    if (maxval <= 0) maxval = 1;
-   sprintf(maxvaltxt, "%llu", maxval);
+   snprintf(maxvaltxt, sizeof(maxvaltxt), "%llu", maxval);
    gdImageStringUp(im, gdFontSmall, 8, 26+(strlen(maxvaltxt)*6),
                    (unsigned char *)maxvaltxt, CHLEGENDCOLOR);
    
@


1.4
log
@use memmove() instead of memcpy() to prevent a backwards copy (and thus crash)

reported by Scott Vanderbilt
ok sthen@@
@
text
@d1 1
a1 1
$OpenBSD: patch-graphs_c,v 1.3 2011/01/05 08:19:18 giovanni Exp $
a2 1
- use snprintf()
@


1.3
log
@
Update to 2.23.03.28 and take maintainership
ok benoit@@
@
text
@d1 7
a7 3
$OpenBSD: patch-graphs_c,v 1.2 2008/01/30 20:06:48 mbalmer Exp $
--- graphs.c.orig	Thu Dec 30 14:52:23 2010
+++ graphs.c	Tue Jan  4 08:52:28 2011
d35 1
a35 1
@@@@ -310,7 +310,7 @@@@ int year_graph6x(char *fname, char *title, struct hist
d43 5
a47 1
    memcpy(maxvaltxt+i+1,maxvaltxt+i+6,strlen(maxvaltxt)-i); /* remove &nbsp; */
d66 1
a66 1
@@@@ -588,7 +588,7 @@@@ int month_graph6(     char  *fname,        /* filename
d74 5
a78 1
    memcpy(maxvaltxt+i+1,maxvaltxt+i+6,strlen(maxvaltxt)-i); /* remove &nbsp; */
@


1.2
log
@Switch to webalizer xtended by Patrick Frei, which adds IPv6 support and
detailed http 404 error reports.  Webalizer author hinted me at this,
he does not intend to update. danh@@ is ok with the maintainer change.

ok stehn, okan.
@
text
@d1 14
a14 13
$OpenBSD: patch-graphs_c,v 1.1 2002/04/17 16:17:45 danh Exp $
--- graphs.c.orig	Tue Aug  7 13:25:17 2007
+++ graphs.c	Wed Jan 30 13:42:39 2008
@@@@ -30,6 +30,7 @@@@
 #include <stdio.h>
 #include <string.h>
 #include <sys/types.h>
+#include <sys/socket.h>
 #include <gd.h>
 #include <gdfontt.h>
 #include <gdfonts.h>
@@@@ -198,7 +199,7 @@@@ int year_graph6x(  char *fname,            /* file nam
       if (data7[i] > maxval) maxval = data7[i];
d17 4
a20 3
-   sprintf(maxvaltxt, "%lu", maxval);
+   snprintf(maxvaltxt, sizeof maxvaltxt, "%lu", maxval);
    gdImageStringUp(im,gdFontSmall,8,26+(strlen(maxvaltxt)*6),maxvaltxt,CHLEGENDCOLOR);
d22 2
a23 3
    if (graph_legend)                          /* print color coded legends? */
@@@@ -292,7 +293,7 @@@@ int year_graph6x(  char *fname,            /* file nam
        if (data8[i] > maxval) maxval = data8[i];
d26 2
a27 2
-   sprintf(maxvaltxt, "%lu", maxval);
+   snprintf(maxvaltxt, sizeof maxvaltxt, "%lu", maxval);
d29 1
a29 1
                    maxvaltxt,CHLEGENDCOLOR);
d31 3
a33 3
@@@@ -331,7 +332,7 @@@@ int year_graph6x(  char *fname,            /* file nam
        if (data6[i] > fmaxval) fmaxval = data6[i];         /* get max val    */
    }
d35 6
a40 6
-   sprintf(maxvaltxt, "%.0f", fmaxval);
+   snprintf(maxvaltxt, sizeof maxvaltxt, "%.0f", fmaxval);
    gdImageStringUp(im, gdFontSmall,493,130+(strlen(maxvaltxt)*6),
                    maxvaltxt,CHLEGENDCOLOR);
 
@@@@ -458,7 +459,7 @@@@ int month_graph6(  char *fname,            /* filename
d44 2
a45 2
-   sprintf(maxvaltxt, "%lu", maxval);
+   snprintf(maxvaltxt, sizeof maxvaltxt, "%lu", maxval);
d47 1
a47 1
                    maxvaltxt,CHLEGENDCOLOR);
d49 1
a49 1
@@@@ -555,7 +556,7 @@@@ int month_graph6(  char *fname,            /* filename
d53 2
a54 2
-   sprintf(maxvaltxt, "%lu", maxval);
+   snprintf(maxvaltxt, sizeof maxvaltxt, "%lu", maxval);
d56 1
a56 1
                    maxvaltxt,CHLEGENDCOLOR);
d58 2
a59 2
@@@@ -590,7 +591,7 @@@@ int month_graph6(  char *fname,            /* filename
       if (data6[i]>fmaxval) fmaxval = data6[i];
d62 6
a67 6
-   sprintf(maxvaltxt, "%.0f", fmaxval/1024);
+   snprintf(maxvaltxt, sizeof maxvaltxt, "%.0f", fmaxval/1024);
    gdImageStringUp(im, gdFontSmall,8,352+(strlen(maxvaltxt)*6),
                    maxvaltxt,CHLEGENDCOLOR);
 
@@@@ -679,7 +680,7 @@@@ int day_graph3(  char *fname,
d71 2
a72 2
-   sprintf(maxvaltxt, "%lu", maxval);
+   snprintf(maxvaltxt, sizeof maxvaltxt, "%lu", maxval);
d74 1
a74 1
                    maxvaltxt,CHLEGENDCOLOR);
@


1.1
log
@update to webalizer 2.01-10
* bump NEED_VERSION
* security fix: buffer overflow in DNS resolver
* includes other bugfixes
* some strcpy/strncpy/sprintf calls changed to strlcpy/snprintf
@
text
@d1 13
a13 5
$OpenBSD$
--- graphs.c.orig	Wed Apr 17 11:07:33 2002
+++ graphs.c	Wed Apr 17 11:11:43 2002
@@@@ -137,7 +137,7 @@@@ int year_graph6x(  char *fname,         
       if (data5[i] > maxval) maxval = data5[i];
d18 1
a18 1
    gdImageStringUp(im,gdFontSmall,8,26+(strlen(maxvaltxt)*6),maxvaltxt,black);
d21 2
a22 2
@@@@ -221,7 +221,7 @@@@ int year_graph6x(  char *fname,         
        if (data6[i] > maxval) maxval = data6[i];
d28 1
a28 1
                    maxvaltxt, black);
d30 3
a32 3
@@@@ -257,7 +257,7 @@@@ int year_graph6x(  char *fname,         
    for (i=0; i<12; i++)
        if (data4[i] > fmaxval) fmaxval = data4[i];         /* get max val    */
d37 1
a37 1
                    maxvaltxt,black);
d39 2
a40 2
@@@@ -354,7 +354,7 @@@@ int month_graph6(  char *fname,         
        if (data5[i] > maxval) maxval = data5[i];
d46 1
a46 1
                    maxvaltxt,black);
d48 2
a49 2
@@@@ -434,7 +434,7 @@@@ int month_graph6(  char *fname,         
       if (data6[i]>maxval) maxval = data6[i];
d54 2
a55 2
    gdImageStringUp(im, gdFontSmall,8,180+(strlen(maxvaltxt)*6),
                    maxvaltxt, black);
d57 3
a59 3
@@@@ -467,7 +467,7 @@@@ int month_graph6(  char *fname,         
    for (i=0; i<31; i++)
       if (data4[i]>fmaxval) fmaxval = data4[i];
d63 4
a66 4
    gdImageStringUp(im, gdFontSmall,8,280+(strlen(maxvaltxt)*6),
                    maxvaltxt, black);
    
@@@@ -531,7 +531,7 @@@@ int day_graph3(  char *fname,
d73 1
a73 1
                    maxvaltxt, black);
a74 18
@@@@ -654,7 +654,7 @@@@ int pie_chart(char *fname, char *title, 
          gdImageLine(im, CX, CY, gdata.x, gdata.y, black);
          gdImageFill(im, gdata.mx, gdata.my, i+4);
 
-         sprintf(buffer,"%s (%d%%)",legend[i], percent);
+         snprintf(buffer, sizeof buffer, "%s (%d%%)",legend[i], percent);
          x=480-(strlen(buffer)*7);
          gdImageString(im,gdFontMediumBold, x+1, y+1, buffer, black);
          gdImageString(im,gdFontMediumBold, x, y, buffer, i+4);
@@@@ -667,7 +667,7 @@@@ int pie_chart(char *fname, char *title, 
       gdata=*calc_arc(s_arc,1.0);
 
       gdImageFill(im, gdata.mx, gdata.my, white);
-      sprintf(buffer,"%s (%d%%)",msg_h_other,100-(int)(s_arc*100));
+      snprintf(buffer, sizeof buffer, "%s (%d%%)",msg_h_other,100-(int)(s_arc*100));
       x=480-(strlen(buffer)*7);
       gdImageString(im,gdFontMediumBold, x+1, y+1, buffer, black);
       gdImageString(im,gdFontMediumBold, x, y, buffer, white);
@


1.1.4.1
log
@MFC:
update to webalizer 2.01-10
* security fix: buffer overflow in DNS resolver
* includes other bugfixes
* some strcpy/strncpy/sprintf calls changed to strlcpy/snprintf
--
From: Nick Nauwelaerts <nick@@nauwelaerts.net>
@
text
@d1 1
a1 1
$OpenBSD: patch-graphs_c,v 1.1 2002/04/17 16:17:45 danh Exp $
@

