head	1.3;
access;
symbols
	OPENBSD_5_9:1.2.0.14
	OPENBSD_5_9_BASE:1.2
	OPENBSD_5_8:1.2.0.16
	OPENBSD_5_8_BASE:1.2
	OPENBSD_5_7:1.2.0.12
	OPENBSD_5_7_BASE:1.2
	OPENBSD_5_6:1.2.0.10
	OPENBSD_5_6_BASE:1.2
	OPENBSD_5_5:1.2.0.8
	OPENBSD_5_5_BASE:1.2
	OPENBSD_5_4:1.2.0.6
	OPENBSD_5_4_BASE:1.2
	OPENBSD_5_3:1.2.0.4
	OPENBSD_5_3_BASE:1.2
	OPENBSD_5_2:1.2.0.2
	OPENBSD_5_2_BASE:1.2
	OPENBSD_5_1_BASE:1.1
	OPENBSD_5_1:1.1.0.16
	OPENBSD_5_0:1.1.0.14
	OPENBSD_5_0_BASE:1.1
	OPENBSD_4_9:1.1.0.12
	OPENBSD_4_9_BASE:1.1
	OPENBSD_4_8:1.1.0.10
	OPENBSD_4_8_BASE:1.1
	OPENBSD_4_7:1.1.0.8
	OPENBSD_4_7_BASE:1.1
	OPENBSD_4_6:1.1.0.6
	OPENBSD_4_6_BASE:1.1
	OPENBSD_4_5:1.1.0.4
	OPENBSD_4_5_BASE:1.1
	OPENBSD_4_4:1.1.0.2
	OPENBSD_4_4_BASE:1.1;
locks; strict;
comment	@# @;


1.3
date	2016.04.28.17.43.23;	author sthen;	state dead;
branches;
next	1.2;
commitid	l20MhochuRfAT0hn;

1.2
date	2012.06.13.12.41.14;	author okan;	state Exp;
branches;
next	1.1;

1.1
date	2008.05.09.08.24.31;	author mbalmer;	state Exp;
branches;
next	;


desc
@@


1.3
log
@unhook mod_perl, everything using it has been moved to ap2-mod_perl (mod_perl2)
@
text
@$OpenBSD: patch-src_modules_perl_Connection_xs,v 1.2 2012/06/13 12:41:14 okan Exp $
--- src/modules/perl/Connection.xs.orig	Fri Mar 30 07:12:42 2007
+++ src/modules/perl/Connection.xs	Wed Dec  5 17:41:08 2007
@@@@ -23,8 +23,8 @@@@ BOOT: 
   
 #  /* Who is the client? */
   
-#  struct sockaddr_in local_addr; /* local address */
-#  struct sockaddr_in remote_addr;/* remote address */
+#  struct sockaddr_storage local_addr; /* local address */
+#  struct sockaddr_storage remote_addr;/* remote address */
 #  char *remote_ip;		/* Client's IP address */
 #  char *remote_host;		/* Client's DNS name, if known.
 #                                 * NULL if DNS hasn't been checked,
@@@@ -78,7 +78,7 @@@@ remote_addr(conn, sv_addr=Nullsv)
     RETVAL = newSVpv((char *)&conn->remote_addr,
                       sizeof conn->remote_addr);
     if(sv_addr) {
-        struct sockaddr_in addr; 
+        struct sockaddr_storage addr; 
         STRLEN sockaddrlen; 
         char * new_addr = SvPV(sv_addr,sockaddrlen); 
         if (sockaddrlen != sizeof(addr)) { 
@@@@ -97,7 +97,9 @@@@ remote_ip(conn, ...)
 
     CODE:
     RETVAL = conn->remote_ip;
- 
+
+    struct addrinfo rhints, *res, *res0;
+    int error;
     if(items > 1) {
 #ifdef SGI_BOOST
         ap_cpystrn(conn->remote_ip, (char *)SvPV(ST(1),na),
@@@@ -106,7 +108,18 @@@@ remote_ip(conn, ...)
 #else
         conn->remote_ip = pstrdup(conn->pool, (char *)SvPV(ST(1),na));
 #endif
-        conn->remote_addr.sin_addr.s_addr = inet_addr(conn->remote_ip);
+        memset(&rhints, 0, sizeof(rhints));
+        rhints.ai_family = PF_UNSPEC;
+        rhints.ai_socktype = SOCK_STREAM;
+        error = getaddrinfo(conn->remote_ip, NULL, &rhints, &res0);
+        if (!error) {
+            memcpy(&conn->remote_addr, (const void *)res0->ai_addr,
+                (size_t) res0->ai_addrlen);
+            freeaddrinfo(res0);
+        } else {
+            croak("Bad IP address in remote_ip getaddrinfo failed %s",
+                gai_strerror(error));
+        }
     }
 
     OUTPUT:
@


1.2
log
@rename local variable to avoid conflict with perl; from Brad.

ok landry@@
@
text
@d1 1
a1 1
$OpenBSD: patch-src_modules_perl_Connection_xs,v 1.1 2008/05/09 08:24:31 mbalmer Exp $
@


1.1
log
@Fix for new httpd module ABI.
@
text
@d1 1
a1 1
$OpenBSD$
d30 1
a30 1
+    struct addrinfo hints, *res, *res0;
d40 4
a43 4
+        memset(&hints, 0, sizeof(hints));
+        hints.ai_family = PF_UNSPEC;
+        hints.ai_socktype = SOCK_STREAM;
+        error = getaddrinfo(conn->remote_ip, NULL, &hints, &res0);
@

