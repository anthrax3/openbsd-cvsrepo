head	1.3;
access;
symbols
	OPENBSD_4_8:1.2.0.8
	OPENBSD_4_8_BASE:1.2
	OPENBSD_4_7:1.2.0.6
	OPENBSD_4_7_BASE:1.2
	OPENBSD_4_6:1.2.0.4
	OPENBSD_4_6_BASE:1.2
	OPENBSD_4_5:1.2.0.2
	OPENBSD_4_5_BASE:1.2
	OPENBSD_4_4:1.1.0.2
	OPENBSD_4_4_BASE:1.1;
locks; strict;
comment	@# @;


1.3
date	2010.09.27.12.21.24;	author stephan;	state dead;
branches;
next	1.2;

1.2
date	2008.08.19.23.44.48;	author espie;	state Exp;
branches;
next	1.1;

1.1
date	2008.03.15.09.36.48;	author espie;	state Exp;
branches;
next	;


desc
@@


1.3
log
@remove drupal5, which will soon be end-of-life. Switch to drupal6, please. explicit ok sthen@@, aja@@
@
text
@$OpenBSD: patch-includes_form_inc,v 1.2 2008/08/19 23:44:48 espie Exp $
--- includes/form.inc.orig	Mon Aug  4 06:00:24 2008
+++ includes/form.inc	Thu Aug 14 11:29:23 2008
@@@@ -1123,6 +1123,13 @@@@ function expand_password_confirm($element) {
     '#value' => $element['#value']['pass2'],
     '#required' => $element['#required'],
   );
+  if (isset($element['#autogen'])) {
+    $element['autogen'] = array(
+      '#type' => 'checkbox',
+      '#title' => t('Autogenerate password'),
+      '#value' => $element['#value']['autogen']
+    );
+  }
   $element['#validate'] = array('password_confirm_validate' => array());
   $element['#tree'] = TRUE;
 
@@@@ -1133,19 +1140,51 @@@@ function expand_password_confirm($element) {
   return $element;
 }
 
+ /**
+ * Generate a random alphanumeric password.
+ */
+function new_password($length = 10) {
+  // This variable contains the list of allowable characters for the
+  // password. Note that the number 0 and the letter 'O' have been
+  // removed to avoid confusion between the two. The same is true
+  // of 'I', 1, and l.
+  $allowable_characters = 'abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ23456789';
+
+  // Zero-based count of characters in the allowable list:
+  $len = strlen($allowable_characters) - 1;
+
+  // Declare the password as a blank string.
+  $pass = '';
+
+  // Loop the number of times specified by $length.
+  for ($i = 0; $i < $length; $i++) {
+
+    // Each iteration, pick a random character from the
+    // allowable string and append it to the password:
+    $pass .= $allowable_characters[mt_rand(0, $len)];
+  }
+
+  return $pass;
+}
+
 /**
  * Validate password_confirm element.
  */
 function password_confirm_validate($form) {
-  $pass1 = trim($form['pass1']['#value']);
-  if (!empty($pass1)) {
-    $pass2 = trim($form['pass2']['#value']);
-    if ($pass1 != $pass2) {
-      form_error($form, t('The specified passwords do not match.'));
-    }
+  if (isset($form['autogen']) && $form['autogen']['#value']) {
+    $pass1 = new_password();
   }
-  elseif ($form['#required'] && !empty($form['#post'])) {
-    form_error($form, t('Password field is required.'));
+  else {
+    $pass1 = trim($form['pass1']['#value']);
+    if (!empty($pass1)) {
+      $pass2 = trim($form['pass2']['#value']);
+      if ($pass1 != $pass2) {
+	form_error($form, t('The specified passwords do not match.'));
+      }
+    }
+    elseif ($form['#required'] && !empty($form['#post'])) {
+      form_error($form, t('Password field is required.'));
+    }
   }
 
   // Password field must be converted from a two-element array into a single
@


1.2
log
@security update
@
text
@d1 1
a1 1
$OpenBSD: patch-includes_form_inc,v 1.1 2008/03/15 09:36:48 espie Exp $
@


1.1
log
@a few tweaks to core:
- allow autogen passwords for new users
- put the names of roles more often on the rights page.
- extra hook for jquery_update, to avoid having to overwrite jquery
@
text
@d1 4
a4 4
$OpenBSD$
--- includes/form.inc.orig	Sun Feb 17 13:00:26 2008
+++ includes/form.inc	Sun Feb 17 13:00:40 2008
@@@@ -1122,6 +1122,13 @@@@ function expand_password_confirm($element) {
d18 1
a18 1
@@@@ -1132,19 +1139,51 @@@@ function expand_password_confirm($element) {
@

