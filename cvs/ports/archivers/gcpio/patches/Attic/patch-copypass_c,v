head	1.1;
access;
symbols
	OPENBSD_3_8:1.1.0.6
	OPENBSD_3_7:1.1.0.4
	OPENBSD_3_6:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2005.10.30.07.11.45;	author sturm;	state dead;
branches
	1.1.2.1
	1.1.4.1
	1.1.6.1;
next	;

1.1.2.1
date	2005.10.30.07.11.45;	author sturm;	state Exp;
branches;
next	;

1.1.4.1
date	2005.10.30.07.22.47;	author sturm;	state Exp;
branches;
next	;

1.1.6.1
date	2005.11.01.11.33.12;	author sturm;	state Exp;
branches;
next	;


desc
@@


1.1
log
@file patch-copypass_c was initially added on branch OPENBSD_3_6.
@
text
@@


1.1.6.1
log
@Debian/Ubuntu patches for CAN-2005-1111 (chmod races) and
CAN-2005-1229 (path traversal)

ok brad@@
@
text
@a0 29
$OpenBSD$
--- copypass.c.orig	Fri Dec  7 02:03:34 2001
+++ copypass.c	Fri Oct 28 22:54:18 2005
@@@@ -186,19 +186,20 @@@@ process_copy_pass ()
 		}
 	      if (close (in_file_des) < 0)
 		error (0, errno, "%s", input_name.ds_string);
-	      if (close (out_file_des) < 0)
-		error (0, errno, "%s", output_name.ds_string);
-
 	      /* Set the attributes of the new file.  */
 	      if (!no_chown_flag)
-		if ((chown (output_name.ds_string,
+		if ((fchown (out_file_des,
 			    set_owner_flag ? set_owner : in_file_stat.st_uid,
 		      set_group_flag ? set_group : in_file_stat.st_gid) < 0)
 		    && errno != EPERM)
 		  error (0, errno, "%s", output_name.ds_string);
 	      /* chown may have turned off some permissions we wanted. */
-	      if (chmod (output_name.ds_string, in_file_stat.st_mode) < 0)
+	      if (fchmod (out_file_des, in_file_stat.st_mode) < 0)
 		error (0, errno, "%s", output_name.ds_string);
+		
+	      if (close (out_file_des) < 0)
+		error (0, errno, "%s", output_name.ds_string);
+
 	      if (reset_time_flag)
 		{
 		  times.actime = in_file_stat.st_atime;
@


1.1.4.1
log
@Debian/Ubuntu patches for CAN-2005-1111 (chmod races) and
CAN-2005-1229 (path traversal)

ok brad@@
@
text
@a0 29
$OpenBSD$
--- copypass.c.orig	Fri Dec  7 02:03:34 2001
+++ copypass.c	Fri Oct 28 22:54:18 2005
@@@@ -186,19 +186,20 @@@@ process_copy_pass ()
 		}
 	      if (close (in_file_des) < 0)
 		error (0, errno, "%s", input_name.ds_string);
-	      if (close (out_file_des) < 0)
-		error (0, errno, "%s", output_name.ds_string);
-
 	      /* Set the attributes of the new file.  */
 	      if (!no_chown_flag)
-		if ((chown (output_name.ds_string,
+		if ((fchown (out_file_des,
 			    set_owner_flag ? set_owner : in_file_stat.st_uid,
 		      set_group_flag ? set_group : in_file_stat.st_gid) < 0)
 		    && errno != EPERM)
 		  error (0, errno, "%s", output_name.ds_string);
 	      /* chown may have turned off some permissions we wanted. */
-	      if (chmod (output_name.ds_string, in_file_stat.st_mode) < 0)
+	      if (fchmod (out_file_des, in_file_stat.st_mode) < 0)
 		error (0, errno, "%s", output_name.ds_string);
+		
+	      if (close (out_file_des) < 0)
+		error (0, errno, "%s", output_name.ds_string);
+
 	      if (reset_time_flag)
 		{
 		  times.actime = in_file_stat.st_atime;
@


1.1.2.1
log
@add Debian/Ubuntu patches for CAN-2005-1111 (chmod races) and
CAN-2005-1229 (path traversal)

ok brad@@
@
text
@a0 29
$OpenBSD$
--- copypass.c.orig	Fri Dec  7 02:03:34 2001
+++ copypass.c	Fri Oct 28 22:54:18 2005
@@@@ -186,19 +186,20 @@@@ process_copy_pass ()
 		}
 	      if (close (in_file_des) < 0)
 		error (0, errno, "%s", input_name.ds_string);
-	      if (close (out_file_des) < 0)
-		error (0, errno, "%s", output_name.ds_string);
-
 	      /* Set the attributes of the new file.  */
 	      if (!no_chown_flag)
-		if ((chown (output_name.ds_string,
+		if ((fchown (out_file_des,
 			    set_owner_flag ? set_owner : in_file_stat.st_uid,
 		      set_group_flag ? set_group : in_file_stat.st_gid) < 0)
 		    && errno != EPERM)
 		  error (0, errno, "%s", output_name.ds_string);
 	      /* chown may have turned off some permissions we wanted. */
-	      if (chmod (output_name.ds_string, in_file_stat.st_mode) < 0)
+	      if (fchmod (out_file_des, in_file_stat.st_mode) < 0)
 		error (0, errno, "%s", output_name.ds_string);
+		
+	      if (close (out_file_des) < 0)
+		error (0, errno, "%s", output_name.ds_string);
+
 	      if (reset_time_flag)
 		{
 		  times.actime = in_file_stat.st_atime;
@

