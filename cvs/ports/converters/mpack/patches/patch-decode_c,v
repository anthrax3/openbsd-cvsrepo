head	1.5;
access;
symbols
	OPENBSD_6_1:1.5.0.18
	OPENBSD_6_1_BASE:1.5
	OPENBSD_6_0:1.5.0.16
	OPENBSD_6_0_BASE:1.5
	OPENBSD_5_9:1.5.0.12
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.5.0.14
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.5.0.10
	OPENBSD_5_7_BASE:1.5
	OPENBSD_5_6:1.5.0.8
	OPENBSD_5_6_BASE:1.5
	OPENBSD_5_5:1.5.0.6
	OPENBSD_5_5_BASE:1.5
	OPENBSD_5_4:1.5.0.4
	OPENBSD_5_4_BASE:1.5
	OPENBSD_5_3:1.5.0.2
	OPENBSD_5_3_BASE:1.5
	OPENBSD_5_2:1.4.0.4
	OPENBSD_5_2_BASE:1.4
	OPENBSD_5_1_BASE:1.4
	OPENBSD_5_1:1.4.0.2
	OPENBSD_5_0:1.3.0.24
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_9:1.3.0.22
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.3.0.20
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.3.0.18
	OPENBSD_4_7_BASE:1.3
	OPENBSD_4_6:1.3.0.16
	OPENBSD_4_6_BASE:1.3
	OPENBSD_4_5:1.3.0.14
	OPENBSD_4_5_BASE:1.3
	OPENBSD_4_4:1.3.0.12
	OPENBSD_4_4_BASE:1.3
	OPENBSD_4_3:1.3.0.10
	OPENBSD_4_3_BASE:1.3
	OPENBSD_4_2:1.3.0.8
	OPENBSD_4_2_BASE:1.3
	OPENBSD_4_1:1.3.0.6
	OPENBSD_4_1_BASE:1.3
	OPENBSD_4_0:1.3.0.4
	OPENBSD_4_0_BASE:1.3
	OPENBSD_3_9:1.3.0.2
	OPENBSD_3_9_BASE:1.3
	OPENBSD_3_8:1.1.0.16
	OPENBSD_3_8_BASE:1.1
	OPENBSD_3_7:1.1.0.14
	OPENBSD_3_7_BASE:1.1
	OPENBSD_3_6:1.1.0.12
	OPENBSD_3_6_BASE:1.1
	OPENBSD_3_5:1.1.0.10
	OPENBSD_3_5_BASE:1.1
	OPENBSD_3_4:1.1.0.8
	OPENBSD_3_4_BASE:1.1
	OPENBSD_3_3:1.1.0.6
	OPENBSD_3_3_BASE:1.1
	OPENBSD_3_2:1.1.0.4
	OPENBSD_3_2_BASE:1.1
	OPENBSD_3_1:1.1.0.2;
locks; strict;
comment	@# @;


1.5
date	2012.12.11.11.01.31;	author sthen;	state Exp;
branches;
next	1.4;

1.4
date	2012.01.08.00.12.12;	author sthen;	state Exp;
branches;
next	1.3;

1.3
date	2005.10.06.21.09.22;	author aanriot;	state Exp;
branches
	1.3.24.1;
next	1.2;

1.2
date	2005.10.06.20.46.02;	author aanriot;	state Exp;
branches;
next	1.1;

1.1
date	2002.08.09.01.15.19;	author naddy;	state Exp;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2002.08.09.21.01.50;	author naddy;	state Exp;
branches;
next	;

1.3.24.1
date	2012.01.08.00.15.23;	author sthen;	state Exp;
branches;
next	;


desc
@@


1.5
log
@- fix unpacking of multiple parts (from Gentoo, possibly via FreeBSD).

- recognise PNG files and set appropriate mime type (from FreeBSD).

- remove botched mkstemp() conversion which broke mpack(1);
a proper mkstemp conversion is intrusive.

- use some additional XXXX in the temporary filename.

- let this build with CLang scan-build.
@
text
@$OpenBSD: patch-decode_c,v 1.4 2012/01/08 00:12:12 sthen Exp $
--- decode.c.orig	Mon Jul 21 21:47:54 2003
+++ decode.c	Tue Dec 11 10:47:55 2012
@@@@ -28,10 +28,11 @@@@
 #include <stdio.h>
 #include <string.h>
 #include <ctype.h>
+#include <stdlib.h>
+#include <md5.h>
 #include "xmalloc.h"
 #include "common.h"
 #include "part.h"
-#include "md5.h"
 
 extern char *os_idtodir(char *id);
 extern FILE *os_newtypedfile(char *fname, char *contentType, int flags, params contentParams);
@@@@ -545,8 +546,8 @@@@ getDispositionFilename(char *disposition)
 	SkipWhitespace(&disposition);
 	if (!disposition) return 0;
 
-	/* If we're looking at a ";", we found what we're looking for */
-	if (*disposition++ == ';') break;
+	/* If we're looking at an "=", we found what we're looking for */
+	if (*disposition++ == '=') break;
     }
 
     SkipWhitespace(&disposition);
@@@@ -632,7 +633,7 @@@@ int handlePartial(struct part *inpart, char *headers, 
 	}
 	/* Store number of parts in reassembly directory */
 	sprintf(buf, "%sCT", dir);
-	partfile = os_createnewfile(buf);
+	partfile = os_resetfile(buf);
 	if (!partfile) {
 	    os_perror(buf);
 	    goto ignore;
@


1.4
log
@update to mpack 1.6 plus various patches from Sebastian Pipping:
- SECURITY: don't create world readable files. CVE-2011-4919
- avoid conflicting prototypes
@
text
@d1 1
a1 1
$OpenBSD: patch-decode_c,v 1.2 2005/10/06 20:46:02 aanriot Exp $
d3 1
a3 1
+++ decode.c	Sun Jan  8 00:02:59 2012
d23 1
a23 1
+	/* If we're looking at a "=", we found what we're looking for */
d28 9
@


1.3
log
@backout previous commit, misunderstanding. Unsecure str* calls have to
be fixed before.
@
text
@d1 4
a4 4
$OpenBSD: patch-decode_c,v 1.1 2002/08/09 01:15:19 naddy Exp $
--- decode.c.orig	Thu Feb 16 22:39:44 1995
+++ decode.c	Fri Aug  9 03:03:32 2002
@@@@ -28,10 +28,10 @@@@
d8 1
d15 10
a24 5
 extern char *os_idtodir();
 extern FILE *os_newtypedfile();
@@@@ -416,6 +416,15 @@@@ char **headerp;
 	}
 	if (*header) *header++ = '\0';
d26 2
a27 44
+
+    /*
+     * Debian fix: if there was only an empty parameter list (a bare
+     * semicolon) then there is no guarantee that param[nparam] exists.
+     * Therefore, treat it as if there is no parameter list.
+     */
+    if (nparam == 0)
+	return 0;
+
     param[nparam] = 0;
     return param;
 }
@@@@ -466,6 +475,7 @@@@ char *key;
 	while (*from && *from != '\"') {
 	    if (!--left) {
 		alloced += VALUEGROWSIZE;
+		left += VALUEGROWSIZE;
 		value = xrealloc(value, alloced);
 		to = value + alloced - left - 2;
 	    }
@@@@ -482,6 +492,7 @@@@ char *key;
 	while (*from && !isspace(*from)) {
 	    if (!--left) {
 		alloced += VALUEGROWSIZE;
+		left += VALUEGROWSIZE;
 		value = xrealloc(value, alloced);
 		to = value + alloced - left - 2;
 	    }
@@@@ -571,6 +582,7 @@@@ char *disposition;
 	while (*disposition && *disposition != '\"') {
 	    if (!--left) {
 		alloced += VALUEGROWSIZE;
+		left += VALUEGROWSIZE;
 		value = xrealloc(value, alloced);
 		to = value + alloced - left - 2;
 	    }
@@@@ -588,6 +600,7 @@@@ char *disposition;
 	       *disposition != '(') {
 	    if (!--left) {
 		alloced += VALUEGROWSIZE;
+		left += VALUEGROWSIZE;
 		value = xrealloc(value, alloced);
 		to = value + alloced - left - 2;
 	    }
@


1.3.24.1
log
@MFC

update to mpack 1.6 plus various patches from Sebastian Pipping:
- SECURITY: don't create world readable files. CVE-2011-4919
- avoid conflicting prototypes
@
text
@d1 4
a4 4
$OpenBSD: patch-decode_c,v 1.4 2012/01/08 00:12:12 sthen Exp $
--- decode.c.orig	Mon Jul 21 21:47:54 2003
+++ decode.c	Sun Jan  8 00:02:59 2012
@@@@ -28,10 +28,11 @@@@
a7 1
+#include <stdlib.h>
d14 5
a18 10
 extern char *os_idtodir(char *id);
 extern FILE *os_newtypedfile(char *fname, char *contentType, int flags, params contentParams);
@@@@ -545,8 +546,8 @@@@ getDispositionFilename(char *disposition)
 	SkipWhitespace(&disposition);
 	if (!disposition) return 0;
 
-	/* If we're looking at a ";", we found what we're looking for */
-	if (*disposition++ == ';') break;
+	/* If we're looking at a "=", we found what we're looking for */
+	if (*disposition++ == '=') break;
d20 44
a63 2
 
     SkipWhitespace(&disposition);
@


1.2
log
@update to 1.6.

ok fgsch@@
@
text
@d2 2
a3 2
--- decode.c.orig	Mon Jul 21 22:47:54 2003
+++ decode.c	Mon Oct  3 16:26:38 2005
d14 50
a63 2
 extern char *os_idtodir(char *id);
 extern FILE *os_newtypedfile(char *fname, char *contentType, int flags, params contentParams);
@


1.1
log
@SECURITY fixes, submitted by Nick Nauwelaerts <nick@@wanadoo.be>:

* Fix buffer overflow.  (Obtained from Debian)
* Strip leading "../" when creating new files.  (Obtained from Debian)

Clean-up by yours truly:

* Parameter parsing fix.  (Obtained from Debian)
* Prefer native getopt() and MD5 functions over the included ones.
* Make munpack synopsis agree with actual parameters.
* Respect CC.
@
text
@d1 3
a3 3
$OpenBSD$
--- decode.c.orig	Thu Feb 16 22:39:44 1995
+++ decode.c	Fri Aug  9 03:03:32 2002
d14 2
a15 50
 extern char *os_idtodir();
 extern FILE *os_newtypedfile();
@@@@ -416,6 +416,15 @@@@ char **headerp;
 	}
 	if (*header) *header++ = '\0';
     }
+
+    /*
+     * Debian fix: if there was only an empty parameter list (a bare
+     * semicolon) then there is no guarantee that param[nparam] exists.
+     * Therefore, treat it as if there is no parameter list.
+     */
+    if (nparam == 0)
+	return 0;
+
     param[nparam] = 0;
     return param;
 }
@@@@ -466,6 +475,7 @@@@ char *key;
 	while (*from && *from != '\"') {
 	    if (!--left) {
 		alloced += VALUEGROWSIZE;
+		left += VALUEGROWSIZE;
 		value = xrealloc(value, alloced);
 		to = value + alloced - left - 2;
 	    }
@@@@ -482,6 +492,7 @@@@ char *key;
 	while (*from && !isspace(*from)) {
 	    if (!--left) {
 		alloced += VALUEGROWSIZE;
+		left += VALUEGROWSIZE;
 		value = xrealloc(value, alloced);
 		to = value + alloced - left - 2;
 	    }
@@@@ -571,6 +582,7 @@@@ char *disposition;
 	while (*disposition && *disposition != '\"') {
 	    if (!--left) {
 		alloced += VALUEGROWSIZE;
+		left += VALUEGROWSIZE;
 		value = xrealloc(value, alloced);
 		to = value + alloced - left - 2;
 	    }
@@@@ -588,6 +600,7 @@@@ char *disposition;
 	       *disposition != '(') {
 	    if (!--left) {
 		alloced += VALUEGROWSIZE;
+		left += VALUEGROWSIZE;
 		value = xrealloc(value, alloced);
 		to = value + alloced - left - 2;
 	    }
@


1.1.2.1
log
@SECURITY fixes, submitted by Nick Nauwelaerts <nick@@wanadoo.be>:
* Fix buffer overflow.  (Obtained from Debian)
* Strip leading "../" when creating new files.  (Obtained from Debian)
@
text
@d1 1
a1 1
$OpenBSD: patch-decode_c,v 1.1 2002/08/09 01:15:19 naddy Exp $
@

