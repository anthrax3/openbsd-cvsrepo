head	1.2;
access;
symbols
	OPENBSD_4_5:1.1.0.6
	OPENBSD_4_5_BASE:1.1
	OPENBSD_4_4:1.1.0.4
	OPENBSD_4_4_BASE:1.1
	OPENBSD_4_3:1.1.0.2
	OPENBSD_4_3_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2009.05.21.14.11.51;	author pirofti;	state dead;
branches;
next	1.1;

1.1
date	2007.10.26.21.04.25;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Bring wine-1.1.21 in tree.

This is still work in progress. That means its not working yet, its not
linked to the build and it still has a long way to go.
We're adding this here so that developers can more easily work on it.

Okay sthen@@.
@
text
@$OpenBSD: patch-msdos_dpmi_c,v 1.1 2007/10/26 21:04:25 ajacoutot Exp $
--- msdos/dpmi.c.orig	Thu Feb 25 18:32:56 1999
+++ msdos/dpmi.c	Fri Oct 26 22:55:04 2007
@@@@ -20,6 +20,7 @@@@
 #include "process.h"
 #include "callback.h"
 #include "debug.h"
+#include "stackframe.h"
 
 #define DOS_GET_DRIVE(reg) ((reg) ? (reg) - 1 : DRIVE_GetCurrentDrive())
 
@@@@ -211,22 +212,24 @@@@ static void DPMI_CallRMCBProc( CONTEXT *context, RMCB 
          * real-mode call structure. */
         if (flag & 1) {
             /* 32-bit DPMI client */
-            __asm__ __volatile__("
-                 pushl %%es
-                 pushl %%ds
-                 pushfl
-                 movl %4,%%es
-                 movl %3,%%ds
-                 lcall %2
-                 popl %%ds
-                 movl %%es,%0
-                 popl %%es
-             "
+            __asm__ __volatile__("\n"
+"                 pushl %%si\n"
+"                 pushl %%es\n"
+"                 pushl %%ds\n"
+"                 pushfl\n"
+"                 movl %4,%%es\n"
+"                 movl %3,%%ds\n"
+"                 lcall %2\n"
+"                 popl %%ds\n"
+"                 movl %%es,%0\n"
+"                 popl %%es\n"
+"                 popl %%si\n"
+"             "
              : "=g" (es), "=D" (edi)
              : "m" (rmcb->proc_ofs),
                "g" (ss), "g" (rmcb->regs_sel),
                "S" (ESP_reg(context)), "D" (rmcb->regs_ofs)
-             : "eax", "ecx", "edx", "esi", "ebp" );
+             : "eax", "ecx", "edx", "ebp" );
         } else {
             /* 16-bit DPMI client */
             CONTEXT ctx = *context;
@


1.1
log
@ - use our naming scheme for patches
@
text
@d1 1
a1 1
$OpenBSD$
@

