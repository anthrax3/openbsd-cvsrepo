head	1.2;
access;
symbols
	OPENBSD_4_3:1.1.0.4
	OPENBSD_4_3_BASE:1.1
	OPENBSD_4_2:1.1.0.2
	OPENBSD_4_2_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2008.04.28.22.52.38;	author todd;	state dead;
branches;
next	1.1;

1.1
date	2007.05.01.12.55.14;	author todd;	state Exp;
branches;
next	;


desc
@@


1.2
log
@o update to 0.9.1, lots from brad@@
o see http://qemu.org/changelog.html for details
o see README.OpenBSD for an intro to qemu on OpenBSD
o disable broken arm host support for now
@
text
@$OpenBSD: patch-block-qcow2_c,v 1.1 2007/05/01 12:55:14 todd Exp $
--- block-qcow2.c.orig	Mon Feb  5 17:01:54 2007
+++ block-qcow2.c	Fri Apr  6 13:05:45 2007
@@@@ -1884,6 +1884,8 @@@@ static int grow_refcount_table(BlockDriverState *bs, i
     int new_table_size, new_table_size2, refcount_table_clusters, i, ret;
     uint64_t *new_table;
     int64_t table_offset;
+    int old_table_size;
+    int64_t old_table_offset;
     uint64_t data64;
     uint32_t data32;
 
@@@@ -1931,10 +1933,14 @@@@ static int grow_refcount_table(BlockDriverState *bs, i
                     &data32, sizeof(data32)) != sizeof(data32))
         goto fail;
     qemu_free(s->refcount_table);
+    old_table_offset = s->refcount_table_offset;
+    old_table_size = s->refcount_table_size;
     s->refcount_table = new_table;
     s->refcount_table_size = new_table_size;
+    s->refcount_table_offset = table_offset;
 
     update_refcount(bs, table_offset, new_table_size2, 1);
+    free_clusters(bs, old_table_offset, old_table_size * sizeof(uint64_t));
     return 0;
  fail:
     free_clusters(bs, table_offset, new_table_size2);
@


1.1
log
@update to 0.9.0, thanks to all who gave feedback
see http://qemu.org/changelog.html for details
new in OpenBSD, support for raw block devices
@
text
@d1 1
a1 1
$OpenBSD$
@

