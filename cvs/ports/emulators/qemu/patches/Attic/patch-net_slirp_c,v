head	1.4;
access;
symbols
	OPENBSD_5_9:1.3.0.6
	OPENBSD_5_9_BASE:1.3
	OPENBSD_5_8:1.3.0.4
	OPENBSD_5_7:1.3.0.2;
locks; strict;
comment	@# @;


1.4
date	2016.03.14.19.46.12;	author ajacoutot;	state dead;
branches;
next	1.3;
commitid	ZypCecrzOxeE8g1E;

1.3
date	2015.08.11.21.28.53;	author sthen;	state Exp;
branches
	1.3.2.1
	1.3.4.1;
next	1.2;
commitid	bEQ3qdmOkJ4uPZfR;

1.2
date	2011.10.17.20.27.17;	author sthen;	state dead;
branches;
next	1.1;

1.1
date	2011.09.21.09.02.30;	author sthen;	state Exp;
branches;
next	;

1.3.2.1
date	2015.08.14.06.39.38;	author jasper;	state Exp;
branches;
next	;
commitid	Px3KHwTLTWPaYnGe;

1.3.4.1
date	2015.08.24.09.35.36;	author jasper;	state Exp;
branches;
next	;
commitid	U0ZAwVDx3wCcvGa4;


desc
@@


1.4
log
@Major update to qemu-2.5.0.
Please direct any runtime fallout to Brad.

from Brad (maintainer)
@
text
@$OpenBSD: patch-net_slirp_c,v 1.3 2015/08/11 21:28:53 sthen Exp $

slirp: use less predictable directory name in /tmp for smb config (CVE-2015-4037)

In this version I used mkdtemp(3) which is:

        _BSD_SOURCE
        || /* Since glibc 2.10: */
            (_POSIX_C_SOURCE >= 200809L || _XOPEN_SOURCE >= 700)

(POSIX.1-2008), so should be available on systems we care about.

While at it, reset the resulting directory name within smb structure
on error so cleanup function wont try to remove directory which we
failed to create.

--- net/slirp.c.orig	Wed Aug  5 03:42:41 2015
+++ net/slirp.c	Wed Aug  5 03:43:55 2015
@@@@ -481,7 +481,6 @@@@ static void slirp_smb_cleanup(SlirpState *s)
 static int slirp_smb(SlirpState* s, const char *exported_dir,
                      struct in_addr vserver_addr)
 {
-    static int instance;
     char smb_conf[128];
     char smb_cmdline[128];
     struct passwd *passwd;
@@@@ -505,10 +504,10 @@@@ static int slirp_smb(SlirpState* s, const char *export
         return -1;
     }
 
-    snprintf(s->smb_dir, sizeof(s->smb_dir), "/tmp/qemu-smb.%ld-%d",
-             (long)getpid(), instance++);
-    if (mkdir(s->smb_dir, 0700) < 0) {
+    snprintf(s->smb_dir, sizeof(s->smb_dir), "/tmp/qemu-smb.XXXXXX");
+    if (!mkdtemp(s->smb_dir)) {
         error_report("could not create samba server dir '%s'", s->smb_dir);
+        s->smb_dir[0] = 0;
         return -1;
     }
     snprintf(smb_conf, sizeof(smb_conf), "%s/%s", s->smb_dir, "smb.conf");
@


1.3
log
@Backport SECURITY fixes for qemu, from Brad.

ide/atapi: Fix START STOP UNIT command completion
rtl8139: avoid nested ifs in IP header parsing (CVE-2015-5165)
rtl8139: drop tautologous if (ip) {...} statement (CVE-2015-5165)
rtl8139: skip offload on short Ethernet/IP header (CVE-2015-5165)
rtl8139: check IP Header Length field (CVE-2015-5165)
rtl8139: check IP Total Length field (CVE-2015-5165)
rtl8139: skip offload on short TCP header (CVE-2015-5165)
rtl8139: check TCP Data Offset field (CVE-2015-5165)
scsi: fix buffer overflow in scsi_req_parse_cdb (CVE-2015-5158)
slirp: use less predictable directory name in /tmp for smb config (CVE-2015-4037)
i8254: fix out-of-bounds memory access in pit_ioport_read() (CVE-2015-3214)
incrementally decode websocket frames (CVE-2015-1779)
limit size of HTTP headers from websockets clients (CVE-2015-1779)
@
text
@d1 1
a1 1
$OpenBSD$
@


1.3.4.1
log
@Backport SECURITY fixes for qemu

ide/atapi: Fix START STOP UNIT command completion
rtl8139: avoid nested ifs in IP header parsing (CVE-2015-5165)
rtl8139: drop tautologous if (ip) {...} statement (CVE-2015-5165)
rtl8139: skip offload on short Ethernet/IP header (CVE-2015-5165)
rtl8139: check IP Header Length field (CVE-2015-5165)
rtl8139: check IP Total Length field (CVE-2015-5165)
rtl8139: skip offload on short TCP header (CVE-2015-5165)
rtl8139: check TCP Data Offset field (CVE-2015-5165)
scsi: fix buffer overflow in scsi_req_parse_cdb (CVE-2015-5158)
slirp: use less predictable directory name in /tmp for smb config (CVE-2015-4037)
i8254: fix out-of-bounds memory access in pit_ioport_read() (CVE-2015-3214)
incrementally decode websocket frames (CVE-2015-1779)
limit size of HTTP headers from websockets clients (CVE-2015-1779)
@
text
@d1 1
a1 1
$OpenBSD: patch-net_slirp_c,v 1.3 2015/08/11 21:28:53 sthen Exp $
@


1.3.2.1
log
@backport security fixes from -current, ok brad

ide/atapi: Fix START STOP UNIT command completion
rtl8139: avoid nested ifs in IP header parsing (CVE-2015-5165)
rtl8139: drop tautologous if (ip) {...} statement (CVE-2015-5165)
rtl8139: skip offload on short Ethernet/IP header (CVE-2015-5165)
rtl8139: check IP Header Length field (CVE-2015-5165)
rtl8139: check IP Total Length field (CVE-2015-5165)
rtl8139: skip offload on short TCP header (CVE-2015-5165)
rtl8139: check TCP Data Offset field (CVE-2015-5165)
scsi: fix buffer overflow in scsi_req_parse_cdb (CVE-2015-5158)
slirp: use less predictable directory name in /tmp for smb config (CVE-2015-4037)
i8254: fix out-of-bounds memory access in pit_ioport_read() (CVE-2015-3214)
incrementally decode websocket frames (CVE-2015-1779)
limit size of HTTP headers from websockets clients (CVE-2015-1779)
@
text
@d1 1
a1 1
$OpenBSD: patch-net_slirp_c,v 1.3 2015/08/11 21:28:53 sthen Exp $
@


1.2
log
@update to QEMU 0.15.1, from Brad (maintainer).
@
text
@d1 29
a29 5
$OpenBSD: patch-net_slirp_c,v 1.1 2011/09/21 09:02:30 sthen Exp $
--- net/slirp.c.orig	Tue Sep  6 22:49:47 2011
+++ net/slirp.c	Tue Sep  6 22:50:01 2011
@@@@ -529,7 +529,7 @@@@ static int slirp_smb(SlirpState* s, const char *export
     fclose(f);
d31 10
a40 6
     snprintf(smb_cmdline, sizeof(smb_cmdline), "%s -s %s",
-             SMBD_COMMAND, smb_conf);
+             CONFIG_SMBD_COMMAND, smb_conf);
 
     if (slirp_add_exec(s->slirp, 0, smb_cmdline, &vserver_addr, 139) < 0) {
         slirp_smb_cleanup(s);
@


1.1
log
@Backport some upstream qemu fixes, from Brad (maintainer) -

- Fix install(1) usage to be compatible with OpenBSD's install(1).
- Allow overriding the location of Samba's smbd,

From Brad

- Remove PROVIDE_HIDDEN and ONLY_IF_{RO,RW} from linker scripts to make
  them work with older binutils versions. Fixes *-bsd-user build on
  OpenBSD 4.9 which ships binutils 2.15.

From Gerd Hoffmann <kraxel at redhat dot com>
@
text
@d1 1
a1 1
$OpenBSD$
@

