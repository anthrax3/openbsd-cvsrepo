head	1.51;
access;
symbols
	OPENBSD_6_1:1.50.0.2
	OPENBSD_6_1_BASE:1.50
	OPENBSD_6_0:1.47.0.2
	OPENBSD_6_0_BASE:1.47
	OPENBSD_5_9:1.44.0.4
	OPENBSD_5_9_BASE:1.44
	OPENBSD_5_8:1.44.0.6
	OPENBSD_5_8_BASE:1.44
	OPENBSD_5_7:1.44.0.2
	OPENBSD_5_7_BASE:1.44
	OPENBSD_5_6:1.41.0.2
	OPENBSD_5_6_BASE:1.41
	OPENBSD_5_5:1.38.0.2
	OPENBSD_5_5_BASE:1.38
	OPENBSD_5_4:1.35.0.2
	OPENBSD_5_4_BASE:1.35
	OPENBSD_5_3:1.29.0.2
	OPENBSD_5_3_BASE:1.29
	OPENBSD_5_2:1.23.0.2
	OPENBSD_5_2_BASE:1.23
	OPENBSD_5_1_BASE:1.21
	OPENBSD_5_1:1.21.0.2
	OPENBSD_5_0:1.17.0.2
	OPENBSD_5_0_BASE:1.17
	OPENBSD_4_9:1.15.0.2
	OPENBSD_4_9_BASE:1.15
	OPENBSD_4_8:1.14.0.2
	OPENBSD_4_8_BASE:1.14
	OPENBSD_4_7:1.12.0.2
	OPENBSD_4_7_BASE:1.12
	OPENBSD_4_6:1.11.0.6
	OPENBSD_4_6_BASE:1.11
	OPENBSD_4_5:1.11.0.4
	OPENBSD_4_5_BASE:1.11
	OPENBSD_4_4:1.11.0.2
	OPENBSD_4_4_BASE:1.11
	OPENBSD_4_3:1.9.0.2
	OPENBSD_4_3_BASE:1.9
	OPENBSD_4_2:1.8.0.2
	OPENBSD_4_2_BASE:1.8
	OPENBSD_4_1:1.7.0.2
	OPENBSD_4_1_BASE:1.7
	OPENBSD_4_0:1.5.0.2
	OPENBSD_4_0_BASE:1.5
	OPENBSD_3_9:1.4.0.2
	OPENBSD_3_9_BASE:1.4
	OPENBSD_3_8:1.2.0.2
	OPENBSD_3_8_BASE:1.2
	OPENBSD_3_7:1.1.1.1.0.2
	OPENBSD_3_7_BASE:1.1.1.1
	todd_20050307:1.1.1.1
	todd:1.1.1;
locks; strict;
comment	@# @;


1.51
date	2017.04.23.13.24.17;	author ajacoutot;	state Exp;
branches;
next	1.50;
commitid	gPX2SDVWfkzQZiy5;

1.50
date	2016.12.22.09.05.06;	author ajacoutot;	state Exp;
branches;
next	1.49;
commitid	sJbSyhFGZ1IRixbo;

1.49
date	2016.09.03.15.31.07;	author ajacoutot;	state Exp;
branches;
next	1.48;
commitid	NWgBn03iuey8agUy;

1.48
date	2016.08.21.12.04.23;	author ajacoutot;	state Exp;
branches;
next	1.47;
commitid	9Tf4JPbtR4q0Gi0t;

1.47
date	2016.05.13.07.20.46;	author ajacoutot;	state Exp;
branches;
next	1.46;
commitid	dF53LaUBYmEM2Sg2;

1.46
date	2016.03.15.08.26.06;	author ajacoutot;	state Exp;
branches;
next	1.45;
commitid	nXQNBI0aCc8hdfIH;

1.45
date	2016.03.14.19.46.12;	author ajacoutot;	state Exp;
branches;
next	1.44;
commitid	ZypCecrzOxeE8g1E;

1.44
date	2014.12.15.18.19.51;	author brad;	state Exp;
branches;
next	1.43;
commitid	I8kHOEaYPfsvTEn6;

1.43
date	2014.09.20.03.03.19;	author brad;	state Exp;
branches;
next	1.42;
commitid	CAZIPYgsShMsATyE;

1.42
date	2014.08.14.01.05.03;	author brad;	state Exp;
branches;
next	1.41;
commitid	ejiIL7GjEJGAPEiv;

1.41
date	2014.04.25.20.59.43;	author brad;	state Exp;
branches;
next	1.40;

1.40
date	2014.03.26.14.14.47;	author brad;	state Exp;
branches;
next	1.39;

1.39
date	2014.03.09.22.50.17;	author brad;	state Exp;
branches;
next	1.38;

1.38
date	2013.11.29.21.21.38;	author brad;	state Exp;
branches;
next	1.37;

1.37
date	2013.10.30.19.53.29;	author brad;	state Exp;
branches;
next	1.36;

1.36
date	2013.09.08.14.15.01;	author brad;	state Exp;
branches;
next	1.35;

1.35
date	2013.07.18.20.20.18;	author brad;	state Exp;
branches;
next	1.34;

1.34
date	2013.06.23.21.27.55;	author brad;	state Exp;
branches;
next	1.33;

1.33
date	2013.06.03.22.34.24;	author brad;	state Exp;
branches;
next	1.32;

1.32
date	2013.05.24.22.05.51;	author brad;	state Exp;
branches;
next	1.31;

1.31
date	2013.04.19.02.47.43;	author brad;	state Exp;
branches;
next	1.30;

1.30
date	2013.03.20.00.46.01;	author brad;	state Exp;
branches;
next	1.29;

1.29
date	2013.02.02.23.51.45;	author brad;	state Exp;
branches;
next	1.28;

1.28
date	2013.02.02.11.30.34;	author brad;	state Exp;
branches;
next	1.27;

1.27
date	2012.12.12.18.01.08;	author brad;	state Exp;
branches;
next	1.26;

1.26
date	2012.11.21.11.41.02;	author brad;	state Exp;
branches;
next	1.25;

1.25
date	2012.09.24.17.55.36;	author brad;	state Exp;
branches;
next	1.24;

1.24
date	2012.08.08.10.44.44;	author sthen;	state Exp;
branches;
next	1.23;

1.23
date	2012.06.15.11.53.28;	author ajacoutot;	state Exp;
branches;
next	1.22;

1.22
date	2012.03.16.11.40.53;	author fgsch;	state Exp;
branches;
next	1.21;

1.21
date	2011.12.12.10.56.56;	author sthen;	state Exp;
branches;
next	1.20;

1.20
date	2011.10.17.20.27.17;	author sthen;	state Exp;
branches;
next	1.19;

1.19
date	2011.09.21.09.02.30;	author sthen;	state Exp;
branches;
next	1.18;

1.18
date	2011.08.16.21.24.42;	author sthen;	state Exp;
branches;
next	1.17;

1.17
date	2011.05.23.23.43.28;	author sthen;	state Exp;
branches;
next	1.16;

1.16
date	2011.03.12.23.28.39;	author sthen;	state Exp;
branches;
next	1.15;

1.15
date	2010.11.22.11.32.01;	author fgsch;	state Exp;
branches;
next	1.14;

1.14
date	2010.06.17.09.57.55;	author fgsch;	state Exp;
branches;
next	1.13;

1.13
date	2010.05.27.17.55.05;	author fgsch;	state Exp;
branches;
next	1.12;

1.12
date	2009.10.27.13.07.49;	author jasper;	state Exp;
branches;
next	1.11;

1.11
date	2008.06.19.05.51.17;	author todd;	state Exp;
branches;
next	1.10;

1.10
date	2008.04.28.22.52.38;	author todd;	state Exp;
branches;
next	1.9;

1.9
date	2008.01.19.23.53.58;	author todd;	state Exp;
branches;
next	1.8;

1.8
date	2007.05.01.12.55.14;	author todd;	state Exp;
branches;
next	1.7;

1.7
date	2007.02.19.12.43.38;	author robert;	state Exp;
branches;
next	1.6;

1.6
date	2006.12.22.17.31.45;	author todd;	state Exp;
branches;
next	1.5;

1.5
date	2006.06.08.14.33.38;	author todd;	state Exp;
branches;
next	1.4;

1.4
date	2006.02.08.13.44.17;	author todd;	state Exp;
branches;
next	1.3;

1.3
date	2005.12.27.07.56.15;	author todd;	state Exp;
branches;
next	1.2;

1.2
date	2005.08.11.01.15.17;	author todd;	state Exp;
branches;
next	1.1;

1.1
date	2005.03.07.16.41.28;	author todd;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2005.03.07.16.41.28;	author todd;	state Exp;
branches;
next	;


desc
@@


1.51
log
@Update to qemu-2.9.0.

from Brad (maintainer)
@
text
@$OpenBSD: patch-configure,v 1.50 2016/12/22 09:05:06 ajacoutot Exp $
--- configure.orig	Tue Apr 11 14:00:36 2017
+++ configure	Tue Apr 11 21:38:09 2017
@@@@ -4787,10 +4787,6 @@@@ fi
 if test "$gcov" = "yes" ; then
   CFLAGS="-fprofile-arcs -ftest-coverage -g $CFLAGS"
   LDFLAGS="-fprofile-arcs -ftest-coverage $LDFLAGS"
-elif test "$fortify_source" = "yes" ; then
-  CFLAGS="-O2 -U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=2 $CFLAGS"
-elif test "$debug" = "no"; then
-  CFLAGS="-O2 $CFLAGS"
 fi
 
 ##########################################
@@@@ -4939,7 +4935,7 @@@@ if test \( "$cpu" = "i386" -o "$cpu" = "x86_64" \) -a 
     # Different host OS linkers have different ideas about the name of the ELF
     # emulation. Linux and OpenBSD use 'elf_i386'; FreeBSD uses the _fbsd
     # variant; and Windows uses i386pe.
-    for emu in elf_i386 elf_i386_fbsd i386pe; do
+    for emu in elf_i386 elf_i386_fbsd elf_i386_obsd i386pe; do
         if "$ld" -verbose 2>&1 | grep -q "^[[:space:]]*$emu[[:space:]]*$"; then
             ld_i386_emulation="$emu"
             roms="optionrom"
@


1.50
log
@Update to qemu-2.8.0.

from Brad (maintainer)
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.49 2016/09/03 15:31:07 ajacoutot Exp $
--- configure.orig	Tue Dec  6 22:54:54 2016
+++ configure	Sat Dec 10 23:54:52 2016
@@@@ -4740,10 +4740,6 @@@@ fi
d15 1
a15 1
@@@@ -4892,7 +4888,7 @@@@ if test \( "$cpu" = "i386" -o "$cpu" = "x86_64" \) -a 
@


1.49
log
@Update to qemu-2.7.0.

from Brad (maintainer)
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.48 2016/08/21 12:04:23 ajacoutot Exp $
--- configure.orig	Tue Aug 16 15:10:41 2016
+++ configure	Sun Aug 21 12:55:31 2016
@@@@ -4549,10 +4549,6 @@@@ fi
d15 1
a15 1
@@@@ -4702,7 +4698,7 @@@@ if test \( "$cpu" = "i386" -o "$cpu" = "x86_64" \) -a 
@


1.48
log
@Update to qemu-2.6.1.

from Brad (maintainer)
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.47 2016/05/13 07:20:46 ajacoutot Exp $
--- configure.orig	Wed Aug 17 11:26:51 2016
+++ configure	Fri Aug 19 19:57:21 2016
@@@@ -4516,10 +4516,6 @@@@ fi
d15 9
@


1.47
log
@Update to qemu-2.6.0.

from Brad (maintainer)
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.46 2016/03/15 08:26:06 ajacoutot Exp $
--- configure.orig	Mon May  2 13:29:24 2016
+++ configure	Mon May  2 19:08:15 2016
@@@@ -4515,10 +4515,6 @@@@ fi
@


1.46
log
@Tweak for CFLAGS handling. No change in resulting binary.

from Brad (maintainer)
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.45 2016/03/14 19:46:12 ajacoutot Exp $
--- configure.orig	Wed Dec 16 17:04:48 2015
+++ configure	Mon Mar 14 16:36:34 2016
@@@@ -4500,10 +4500,6 @@@@ fi
@


1.45
log
@Major update to qemu-2.5.0.
Please direct any runtime fallout to Brad.

from Brad (maintainer)
@
text
@d1 1
a1 1
$OpenBSD: patch-configure,v 1.44 2014/12/15 18:19:51 brad Exp $
d3 4
a6 2
+++ configure	Sun Mar 13 17:15:51 2016
@@@@ -4502,8 +4502,6 @@@@ if test "$gcov" = "yes" ; then
d8 2
a9 2
 elif test "$fortify_source" = "yes" ; then
   CFLAGS="-O2 -U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=2 $CFLAGS"
@


1.44
log
@Update to QEMU 2.2.0.

ok rpe@@
@
text
@d1 4
a4 6
$OpenBSD: patch-configure,v 1.43 2014/09/20 03:03:19 brad Exp $
--- configure.orig	Tue Nov 11 13:52:06 2014
+++ configure	Thu Nov 13 01:40:45 2014
@@@@ -4069,8 +4069,6 @@@@ fi
 if test "$gcov" = "yes" ; then
   CFLAGS="-fprofile-arcs -ftest-coverage -g $CFLAGS"
d6 4
a9 2
-elif test "$debug" = "no" ; then
-  CFLAGS="-O2 -U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=2 $CFLAGS"
@


1.43
log
@Update to QEMU 2.1.1.

ok bcallah@@
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.42 2014/08/14 01:05:03 brad Exp $
--- configure.orig	Wed Sep 10 15:44:03 2014
+++ configure	Sun Sep 14 13:30:08 2014
@@@@ -3991,8 +3991,6 @@@@ fi
@


1.42
log
@Update to QEMU 2.1.0

ok bcallah@@ rpe@@
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.41 2014/04/25 20:59:43 brad Exp $
--- configure.orig	Tue Jul 15 17:49:14 2014
+++ configure	Wed Jul 16 14:19:59 2014
@@@@ -3990,8 +3990,6 @@@@ fi
@


1.41
log
@Update to QEMU 2.0.0

ok bcallah@@ gsoares@@ rpe@@
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.40 2014/03/26 14:14:47 brad Exp $
--- configure.orig	Mon Apr 14 19:31:26 2014
+++ configure	Mon Apr 14 20:47:16 2014
@@@@ -3910,8 +3910,6 @@@@ fi
@


1.40
log
@Update to QEMU 1.7.1.

ok gsoares@@
@
text
@d1 4
a4 17
$OpenBSD: patch-configure,v 1.39 2014/03/09 22:50:17 brad Exp $
--- configure.orig	Tue Mar 25 10:01:10 2014
+++ configure	Tue Mar 25 17:44:02 2014
@@@@ -1290,9 +1290,9 @@@@ for flag in $gcc_flags; do
     fi
 done
 
-if compile_prog "-Werror -fstack-protector-all" "" ; then
-    QEMU_CFLAGS="$QEMU_CFLAGS -fstack-protector-all"
-    LIBTOOLFLAGS="$LIBTOOLFLAGS -Wc,-fstack-protector-all"
+if compile_prog "-Werror -fstack-protector-strong" "" ; then
+    QEMU_CFLAGS="$QEMU_CFLAGS -fstack-protector-strong"
+    LIBTOOLFLAGS="$LIBTOOLFLAGS -Wc,-fstack-protector-strong"
 fi
 
 # Workaround for http://gcc.gnu.org/PR55489.  Happens with -fPIE/-fPIC and
@@@@ -3554,8 +3554,6 @@@@ fi
d12 1
a12 1
 
@


1.39
log
@- Sync PIE bits with what was commited upstream
- Use stack protector strong instead of all

ok sthen@@
@
text
@d1 3
a3 3
$OpenBSD: patch-configure,v 1.38 2013/11/29 21:21:38 brad Exp $
--- configure.orig	Wed Nov 27 17:15:55 2013
+++ configure	Sat Feb  1 23:04:03 2014
d17 1
a17 13
@@@@ -1357,6 +1357,11 @@@@ EOF
       pie="no"
     fi
   fi
+
+  if compile_prog "-fno-pie" "-nopie"; then
+    CFLAGS_NOPIE="-fno-pie"
+    LDFLAGS_NOPIE="-nopie"
+  fi 
 fi
 
 ##########################################
@@@@ -3549,8 +3554,6 @@@@ fi
a25 16
@@@@ -4288,6 +4291,7 @@@@ echo "LD=$ld" >> $config_host_mak
 echo "WINDRES=$windres" >> $config_host_mak
 echo "LIBTOOL=$libtool" >> $config_host_mak
 echo "CFLAGS=$CFLAGS" >> $config_host_mak
+echo "CFLAGS_NOPIE=$CFLAGS_NOPIE" >> $config_host_mak
 echo "QEMU_CFLAGS=$QEMU_CFLAGS" >> $config_host_mak
 echo "QEMU_INCLUDES=$QEMU_INCLUDES" >> $config_host_mak
 if test "$sparse" = "yes" ; then
@@@@ -4301,6 +4305,7 @@@@ else
   echo "AUTOCONF_HOST := "                             >> $config_host_mak
 fi
 echo "LDFLAGS=$LDFLAGS" >> $config_host_mak
+echo "LDFLAGS_NOPIE=$LDFLAGS_NOPIE" >> $config_host_mak
 echo "LIBTOOLFLAGS=$LIBTOOLFLAGS" >> $config_host_mak
 echo "LIBS+=$LIBS" >> $config_host_mak
 echo "LIBS_TOOLS+=$libs_tools" >> $config_host_mak
@


1.38
log
@Update to QEMU 1.7.0.

ok rpe@@
@
text
@d1 29
a29 15
$OpenBSD: patch-configure,v 1.37 2013/10/30 19:53:29 brad Exp $
--- configure.orig	Tue Nov 26 12:47:18 2013
+++ configure	Wed Nov 27 00:04:27 2013
@@@@ -1345,6 +1345,10 @@@@ EOF
   if compile_prog "-fPIE -DPIE" "-pie"; then
     QEMU_CFLAGS="-fPIE -DPIE $QEMU_CFLAGS"
     LDFLAGS="-pie $LDFLAGS"
+    if test "$targetos" = OpenBSD; then
+      CC_NOPIE="-fno-pie"
+      LD_NOPIE="-nopie"
+    fi
     pie="yes"
     if compile_prog "" "-Wl,-z,relro -Wl,-z,now" ; then
       LDFLAGS="-Wl,-z,relro -Wl,-z,now $LDFLAGS"
@@@@ -3549,8 +3553,6 @@@@ fi
d38 10
a47 3
@@@@ -4312,6 +4314,8 @@@@ if test "$gcov" = "yes" ; then
   echo "CONFIG_GCOV=y" >> $config_host_mak
   echo "GCOV=$gcov_tool" >> $config_host_mak
d49 5
a53 5
+echo "CC_NOPIE=$CC_NOPIE" >> $config_host_mak
+echo "LD_NOPIE=$LD_NOPIE" >> $config_host_mak
 
 # use included Linux headers
 if test "$linux" = "yes" ; then
@


1.37
log
@Update to QEMU 1.6.1.

ok sthen@@
@
text
@d1 15
a15 4
$OpenBSD: patch-configure,v 1.36 2013/09/08 14:15:01 brad Exp $
--- configure.orig	Wed Oct  9 15:20:32 2013
+++ configure	Wed Oct  9 19:35:53 2013
@@@@ -3397,8 +3397,6 @@@@ fi
d20 1
a20 1
-  CFLAGS="-O2 -D_FORTIFY_SOURCE=2 $CFLAGS"
d24 9
@


1.36
log
@Update to QEMU 1.6.0.

ok sthen@@ rpe@@
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.35 2013/07/18 20:20:18 brad Exp $
--- configure.orig	Thu Aug  1 18:01:00 2013
+++ configure	Thu Aug  1 23:49:10 2013
@@@@ -3379,8 +3379,6 @@@@ fi
@


1.35
log
@Update to QEMU 1.5.1.

ok sthen@@
@
text
@d1 4
a4 36
$OpenBSD: patch-configure,v 1.34 2013/06/23 21:27:55 brad Exp $
--- configure.orig	Wed Jun 26 17:47:29 2013
+++ configure	Fri Jun 28 00:47:20 2013
@@@@ -2517,9 +2517,31 @@@@ fi
 
 ##########################################
 # fdt probe
+# fdt support is mandatory for at least some target architectures,
+# so insist on it if we're building those system emulators.
+fdt_required=no
+for target in $target_list; do
+  case $target in
+    arm*-softmmu|ppc*-softmmu|microblaze*-softmmu)
+      fdt_required=yes
+    ;;
+  esac
+done
+
+if test "$fdt_required" = "yes"; then
+  if test "$fdt" = "no"; then
+    error_exit "fdt disabled but some requested targets require it." \
+      "You can turn off fdt only if you also disable all the system emulation" \
+      "targets which need it (by specifying a cut down --target-list)."
+  fi
+  fdt=yes
+fi
+
 if test "$fdt" != "no" ; then
   fdt_libs="-lfdt"
+  # explicitly check for libfdt_env.h as it is missing in some stable installs
   cat > $TMPC << EOF
+#include <libfdt_env.h>
 int main(void) { return 0; }
 EOF
   if compile_prog "" "$fdt_libs" ; then
@@@@ -3389,8 +3411,6 @@@@ fi
@


1.34
log
@Back port a commit from master to make use of external libfdt
instead of the integrated copy.

ok sthen@@
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.33 2013/06/03 22:34:24 brad Exp $
--- configure.orig	Fri Jun 21 16:18:42 2013
+++ configure	Fri Jun 21 16:18:37 2013
@@@@ -2518,9 +2518,31 @@@@ fi
d36 1
a36 1
@@@@ -3390,8 +3412,6 @@@@ fi
@


1.33
log
@Update to QEMU 1.5.0.

ok sthen@@
@
text
@d1 36
a36 4
$OpenBSD: patch-configure,v 1.32 2013/05/24 22:05:51 brad Exp $
--- configure.orig	Mon May 20 11:34:39 2013
+++ configure	Fri May 24 18:10:09 2013
@@@@ -3390,8 +3390,6 @@@@ fi
@


1.32
log
@Update to QEMU 1.4.2. Includes a fix for CVE-2013-2007.

ok sthen@@
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.31 2013/04/19 02:47:43 brad Exp $
--- configure.orig	Fri May 24 09:37:57 2013
+++ configure	Fri May 24 14:39:02 2013
@@@@ -3198,8 +3198,6 @@@@ fi
@


1.31
log
@Update to QEMU 1.4.1. Includes a fix for CVE-2013-1922.

ok sthen@@
@
text
@d1 4
a4 92
$OpenBSD: patch-configure,v 1.30 2013/03/20 00:46:01 brad Exp $
--- configure.orig	Mon Apr 15 16:25:18 2013
+++ configure	Mon Apr 15 20:55:05 2013
@@@@ -3035,34 +3035,67 @@@@ fi
 ##########################################
 # check and set a backend for coroutine
 
-# default is ucontext, but always fallback to gthread
-# windows autodetected by make
-if test "$coroutine" = "" -o "$coroutine" = "ucontext"; then
-  if test "$darwin" != "yes"; then
-    cat > $TMPC << EOF
+# We prefer ucontext, but it's not always possible. The fallback
+# is sigcontext. gthread is not selectable except explicitly, because
+# it is not functional enough to run QEMU proper. (It is occasionally
+# useful for debugging purposes.)  On Windows the only valid backend
+# is the Windows-specific one.
+
+ucontext_works=no
+if test "$darwin" != "yes"; then
+  cat > $TMPC << EOF
 #include <ucontext.h>
 #ifdef __stub_makecontext
 #error Ignoring glibc stub makecontext which will always fail
 #endif
 int main(void) { makecontext(0, 0, 0); return 0; }
 EOF
-    if compile_prog "" "" ; then
-        coroutine_backend=ucontext
-    else
-	coroutine_backend=gthread
-    fi
+  if compile_prog "" "" ; then
+    ucontext_works=yes
   fi
-elif test "$coroutine" = "gthread" ; then
-  coroutine_backend=gthread
-elif test "$coroutine" = "windows" ; then
-  coroutine_backend=windows
-elif test "$coroutine" = "sigaltstack" ; then
-  coroutine_backend=sigaltstack
+fi
+
+if test "$coroutine" = ""; then
+  if test "$mingw32" = "yes"; then
+    coroutine=win32
+  elif test "$ucontext_works" = "yes"; then
+    coroutine=ucontext
+  else
+    coroutine=sigaltstack
+  fi
 else
-  echo
-  echo "Error: unknown coroutine backend $coroutine"
-  echo
-  exit 1
+  case $coroutine in
+  windows)
+    if test "$mingw32" != "yes"; then
+      echo
+      echo "Error: 'windows' coroutine backend only valid for Windows"
+      echo
+      exit 1
+    fi
+    # Unfortunately the user visible backend name doesn't match the
+    # coroutine-*.c filename for this case, so we have to adjust it here.
+    coroutine=win32
+    ;;
+  ucontext)
+    if test "$ucontext_works" != "yes"; then
+      feature_not_found "ucontext"
+    fi
+    ;;
+  gthread|sigaltstack)
+    if test "$mingw32" = "yes"; then
+      echo
+      echo "Error: only the 'windows' coroutine backend is valid for Windows"
+      echo
+      exit 1
+    fi
+    ;;
+  *)
+    echo
+    echo "Error: unknown coroutine backend $coroutine"
+    echo
+    exit 1
+    ;;
+  esac
 fi
 
 ##########################################
@@@@ -3164,8 +3197,6 @@@@ fi
a12 22
@@@@ -3345,7 +3376,7 @@@@ echo "OpenGL support    $opengl"
 echo "libiscsi support  $libiscsi"
 echo "build guest agent $guest_agent"
 echo "seccomp support   $seccomp"
-echo "coroutine backend $coroutine_backend"
+echo "coroutine backend $coroutine"
 echo "GlusterFS support $glusterfs"
 echo "virtio-blk-data-plane $virtio_blk_data_plane"
 echo "gcov              $gcov_tool"
@@@@ -3668,11 +3699,7 @@@@ if test "$rbd" = "yes" ; then
   echo "CONFIG_RBD=y" >> $config_host_mak
 fi
 
-if test "$coroutine_backend" = "ucontext" ; then
-  echo "CONFIG_UCONTEXT_COROUTINE=y" >> $config_host_mak
-elif test "$coroutine_backend" = "sigaltstack" ; then
-  echo "CONFIG_SIGALTSTACK_COROUTINE=y" >> $config_host_mak
-fi
+echo "CONFIG_COROUTINE_BACKEND=$coroutine" >> $config_host_mak
 
 if test "$open_by_handle_at" = "yes" ; then
   echo "CONFIG_OPEN_BY_HANDLE=y" >> $config_host_mak
@


1.30
log
@Upgrade to QEMU 1.4.0. Enable the VNC TLS support.

Tested by todd@@ kirby@@ sthen@@ and OK kirby@@ sthen@@
@
text
@d1 92
a92 4
$OpenBSD: patch-configure,v 1.29 2013/02/02 23:51:45 brad Exp $
--- configure.orig	Fri Feb  1 20:21:48 2013
+++ configure	Sat Feb  2 07:47:01 2013
@@@@ -3158,8 +3158,6 @@@@ fi
d101 22
@


1.29
log
@- Build option ROM .S files with separate preprocessor and
  assembler steps because the C compiler could be unsuitable.
- When the pxa2xx performance counter related cp14 registers were converted
  from a switch-statement implementation to the new table driven cpregs
  format in commit dc2a9045c, the crn and crm values for all these
  registers were accidentally transposed. Fixes being able to boot
  OpenBSD/zaurus.

ok sthen@@
@
text
@d1 10
a10 8
$OpenBSD: patch-configure,v 1.28 2013/02/02 11:30:34 brad Exp $

Build option ROM .S files with separate preprocessor and
assembler steps because the C compiler could be unsuitable.

--- configure.orig	Mon Jan 28 16:05:15 2013
+++ configure	Sat Feb  2 12:46:09 2013
@@@@ -252,6 +252,8 @@@@ done
a11 10
 cc="${CC-${cross_prefix}gcc}"
 ar="${AR-${cross_prefix}ar}"
+as="${AS-${cross_prefix}as}"
+cpp="${CPP-$cc -E}"
 objcopy="${OBJCOPY-${cross_prefix}objcopy}"
 ld="${LD-${cross_prefix}ld}"
 libtool="${LIBTOOL-${cross_prefix}libtool}"
@@@@ -3066,10 +3068,6 @@@@ fi
 # End of CC checks
 # After here, no more $cc or $ld runs
a12 28
-if test "$debug" = "no" ; then
-  CFLAGS="-O2 -D_FORTIFY_SOURCE=2 $CFLAGS"
-fi
-
 # Disable zero malloc errors for official releases unless explicitly told to
 # enable/disable
 if test -z "$zero_malloc" ; then
@@@@ -3652,6 +3650,8 @@@@ echo "CC_I386=$cc_i386" >> $config_host_mak
 echo "HOST_CC=$host_cc" >> $config_host_mak
 echo "OBJCC=$objcc" >> $config_host_mak
 echo "AR=$ar" >> $config_host_mak
+echo "AS=$as" >> $config_host_mak
+echo "CPP=$cpp" >> $config_host_mak
 echo "OBJCOPY=$objcopy" >> $config_host_mak
 echo "LD=$ld" >> $config_host_mak
 echo "WINDRES=$windres" >> $config_host_mak
@@@@ -4209,9 +4209,10 @@@@ for rom in seabios vgabios ; do
     config_mak=roms/$rom/config.mak
     echo "# Automatically generated by configure - do not modify" > $config_mak
     echo "SRC_PATH=$source_path/roms/$rom" >> $config_mak
+    echo "AS=$as" >> $config_mak
     echo "CC=$cc" >> $config_mak
     echo "BCC=bcc" >> $config_mak
-    echo "CPP=${cross_prefix}cpp" >> $config_mak
+    echo "CPP=$cpp" >> $config_mak
     echo "OBJCOPY=objcopy" >> $config_mak
     echo "IASL=iasl" >> $config_mak
     echo "LD=$ld" >> $config_mak
@


1.28
log
@Update to QEMU 1.3.1.

ok sthen@@
@
text
@d1 17
a17 4
$OpenBSD: patch-configure,v 1.27 2012/12/12 18:01:08 brad Exp $
--- configure.orig	Mon Dec  3 14:37:05 2012
+++ configure	Mon Dec  3 15:59:33 2012
@@@@ -3066,10 +3066,6 @@@@ fi
d28 21
@


1.27
log
@Upgrade to QEMU 1.2.2.

ok sthen@@
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.26 2012/11/21 11:41:02 brad Exp $
--- configure.orig	Tue Dec 11 17:04:49 2012
+++ configure	Tue Dec 11 19:47:53 2012
@@@@ -2990,10 +2990,6 @@@@ fi
@


1.26
log
@Update to QEMU 1.2.1.

ok ajacoutot@@
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.25 2012/09/24 17:55:36 brad Exp $
--- configure.orig	Mon Nov 19 20:08:21 2012
+++ configure	Mon Nov 19 22:03:34 2012
@@@@ -2991,10 +2991,6 @@@@ fi
@


1.25
log
@Update to QEMU 1.2.0.

Ok sthen@@
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.24 2012/08/08 10:44:44 sthen Exp $
--- configure.orig	Fri Aug 24 05:09:49 2012
+++ configure	Fri Aug 24 05:10:05 2012
@@@@ -2995,10 +2995,6 @@@@ fi
@


1.24
log
@update to QEMU 1.1.1, from Brad.
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.23 2012/06/15 11:53:28 ajacoutot Exp $
--- configure.orig	Tue Jul 17 14:11:14 2012
+++ configure	Wed Jul 18 11:40:41 2012
@@@@ -2854,10 +2854,6 @@@@ fi
d9 1
a9 1
-  CFLAGS="-O2 $CFLAGS"
d12 3
a14 3
 # Consult white-list to determine whether to enable werror
 # by default.  Only enable by default for git builds
 z_version=`cut -f3 -d. $source_path/VERSION`
@


1.23
log
@Update to QEMU 1.1.0.

from Brad (maintainer)
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.22 2012/03/16 11:40:53 fgsch Exp $
--- configure.orig	Wed May 30 20:54:30 2012
+++ configure	Thu May 31 22:41:49 2012
@@@@ -2850,10 +2850,6 @@@@ fi
@


1.22
log
@Update to qemu 1.0.1, from Brad.
@
text
@d1 4
a4 18
$OpenBSD: patch-configure,v 1.21 2011/12/12 10:56:56 sthen Exp $
--- configure.orig	Fri Feb 17 14:45:39 2012
+++ configure	Fri Feb 17 16:02:57 2012
@@@@ -235,13 +235,11 @@@@ sdl_config="${SDL_CONFIG-${cross_prefix}sdl-config}"
 
 # default flags for all hosts
 QEMU_CFLAGS="-fno-strict-aliasing $QEMU_CFLAGS"
-CFLAGS="-g $CFLAGS"
 QEMU_CFLAGS="-Wall -Wundef -Wwrite-strings -Wmissing-prototypes $QEMU_CFLAGS"
 QEMU_CFLAGS="-Wstrict-prototypes -Wredundant-decls $QEMU_CFLAGS"
 QEMU_CFLAGS="-D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE $QEMU_CFLAGS"
 QEMU_CFLAGS="-D_FORTIFY_SOURCE=2 $QEMU_CFLAGS"
 QEMU_INCLUDES="-I. -I\$(SRC_PATH) -I\$(SRC_PATH)/fpu"
-LDFLAGS="-g $LDFLAGS"
 
 # make source path absolute
 source_path=`cd "$source_path"; pwd`
@@@@ -2684,8 +2682,9 @@@@ fi
d10 2
a11 5
+if test "$debug" = "yes" ; then
+  CFLAGS="$CFLAGS -O0 -g"
+  LDFLAGS="$LDFLAGS -g"
 fi
 
d13 2
@


1.21
log
@Update to QEMU 1.0, from Brad.

- disable the BSD userland emulation support for now, it's not widely useful yet
- workaround for incorrect time_t type assumption, from stsp@@

N.B. As of QEMU 1.0 the i386 target has been renamed from qemu to
qemu-system-i386, you will need to change scripts/command lines as necessary.

ok stsp@@ dcoppa@@
@
text
@d1 3
a3 3
$OpenBSD: patch-configure,v 1.20 2011/10/17 20:27:17 sthen Exp $
--- configure.orig	Mon Nov 28 17:22:15 2011
+++ configure	Mon Nov 28 18:32:45 2011
a17 9
@@@@ -1116,7 +1114,7 @@@@ fi
 
 if test "$pie" = ""; then
   case "$cpu-$targetos" in
-    i386-Linux|x86_64-Linux)
+    i386-Linux|x86_64-Linux|i386-OpenBSD|x86_64-OpenBSD)
       ;;
     *)
       pie="no"
@


1.20
log
@update to QEMU 0.15.1, from Brad (maintainer).
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.19 2011/09/21 09:02:30 sthen Exp $
--- configure.orig	Wed Oct 12 12:41:43 2011
+++ configure	Thu Oct 13 05:12:57 2011
@@@@ -229,13 +229,11 @@@@ sdl_config="${cross_prefix}${SDL_CONFIG-sdl-config}"
d13 1
a13 1
 QEMU_INCLUDES="-I. -I\$(SRC_PATH)"
d18 10
a27 23
@@@@ -281,6 +279,12 @@@@ elif check_define __s390__ ; then
   else
     cpu="s390"
   fi
+elif check_define __ARMEB__ ; then
+  cpu="armv4b"
+elif check_define __ARMEL__ ; then
+  cpu="armv4l"
+elif check_define __hppa__ ; then
+  cpu="hppa"
 else
   cpu=`uname -m`
 fi
@@@@ -301,7 +305,7 @@@@ case "$cpu" in
   armv*l)
     cpu="armv4l"
   ;;
-  parisc|parisc64)
+  hppa|parisc|parisc64)
     cpu="hppa"
   ;;
   mips*)
@@@@ -2557,8 +2561,9 @@@@ fi
@


1.19
log
@Backport some upstream qemu fixes, from Brad (maintainer) -

- Fix install(1) usage to be compatible with OpenBSD's install(1).
- Allow overriding the location of Samba's smbd,

From Brad

- Remove PROVIDE_HIDDEN and ONLY_IF_{RO,RW} from linker scripts to make
  them work with older binutils versions. Fixes *-bsd-user build on
  OpenBSD 4.9 which ships binutils 2.15.

From Gerd Hoffmann <kraxel at redhat dot com>
@
text
@d1 3
a3 3
$OpenBSD: patch-configure,v 1.18 2011/08/16 21:24:42 sthen Exp $
--- configure.orig	Mon Aug  8 14:28:42 2011
+++ configure	Tue Sep  6 22:49:25 2011
d40 1
a40 61
@@@@ -409,6 +413,7 @@@@ SunOS)
   make="${MAKE-gmake}"
   install="${INSTALL-ginstall}"
   ld="gld"
+  smbd="${SMBD-/usr/sfw/sbin/smbd}"
   needs_libsunmath="no"
   solarisrev=`uname -r | cut -f2 -d.`
   # have to select again, because `uname -m` returns i86pc
@@@@ -477,6 +482,7 @@@@ fi
 : ${make=${MAKE-make}}
 : ${install=${INSTALL-install}}
 : ${python=${PYTHON-python}}
+: ${smbd=${SMBD-/usr/sbin/smbd}}
 
 if test "$mingw32" = "yes" ; then
   EXESUF=".exe"
@@@@ -520,6 +526,8 @@@@ for opt do
   ;;
   --python=*) python="$optarg"
   ;;
+  --smbd=*) smbd="$optarg"
+  ;;
   --extra-cflags=*)
   ;;
   --extra-ldflags=*)
@@@@ -932,6 +940,7 @@@@ echo "  --extra-ldflags=LDFLAGS  append extra linker f
 echo "  --make=MAKE              use specified make [$make]"
 echo "  --install=INSTALL        use specified install [$install]"
 echo "  --python=PYTHON          use specified python [$python]"
+echo "  --smbd=SMBD              use specified smbd [$smbd]"
 echo "  --static                 enable static build [$static]"
 echo "  --mandir=PATH            install man pages in PATH"
 echo "  --datadir=PATH           install firmware in PATH"
@@@@ -1513,11 +1522,17 @@@@ int main(void) {
     return 0;
 }
 EOF
+  if $pkg_config libpng --modversion >/dev/null 2>&1; then
+    vnc_png_cflags=`$pkg_config libpng --cflags 2> /dev/null`
+    vnc_png_libs=`$pkg_config libpng --libs 2> /dev/null`
+  else
     vnc_png_cflags=""
     vnc_png_libs="-lpng"
+  fi
   if compile_prog "$vnc_png_cflags" "$vnc_png_libs" ; then
     vnc_png=yes
     libs_softmmu="$vnc_png_libs $libs_softmmu"
+    QEMU_CFLAGS="$QEMU_CFLAGS $vnc_png_cflags"
   else
     if test "$vnc_png" = "yes" ; then
       feature_not_found "vnc-png"
@@@@ -1844,7 +1859,7 @@@@ fi
 
 ##########################################
 # pthread probe
-PTHREADLIBS_LIST="-lpthread -lpthreadGC2"
+PTHREADLIBS_LIST="-pthread -lpthread -lpthreadGC2"
 
 pthread=no
 cat > $TMPC << EOF
@@@@ -2546,8 +2561,9 @@@@ fi
a51 31
@@@@ -2638,6 +2654,9 @@@@ echo "LDFLAGS           $LDFLAGS"
 echo "make              $make"
 echo "install           $install"
 echo "python            $python"
+if test "$slirp" = "yes" ; then
+    echo "smbd              $smbd"
+fi
 echo "host CPU          $cpu"
 echo "host big endian   $bigendian"
 echo "target list       $target_list"
@@@@ -2796,6 +2815,7 @@@@ if test $profiler = "yes" ; then
 fi
 if test "$slirp" = "yes" ; then
   echo "CONFIG_SLIRP=y" >> $config_host_mak
+  echo "CONFIG_SMBD_COMMAND=\"$smbd\"" >> $config_host_mak
   QEMU_INCLUDES="-I\$(SRC_PATH)/slirp $QEMU_INCLUDES"
 fi
 if test "$vde" = "yes" ; then
@@@@ -3048,9 +3068,9 @@@@ echo "TOOLS=$tools" >> $config_host_mak
 echo "ROMS=$roms" >> $config_host_mak
 echo "MAKE=$make" >> $config_host_mak
 echo "INSTALL=$install" >> $config_host_mak
-echo "INSTALL_DIR=$install -d -m0755 -p" >> $config_host_mak
-echo "INSTALL_DATA=$install -m0644 -p" >> $config_host_mak
-echo "INSTALL_PROG=$install -m0755 -p" >> $config_host_mak
+echo "INSTALL_DIR=$install -d -m 0755" >> $config_host_mak
+echo "INSTALL_DATA=$install -c -m 0644" >> $config_host_mak
+echo "INSTALL_PROG=$install -c -m 0755" >> $config_host_mak
 echo "PYTHON=$python" >> $config_host_mak
 echo "CC=$cc" >> $config_host_mak
 echo "CC_I386=$cc_i386" >> $config_host_mak
@


1.18
log
@update to qemu 0.15.0, from Brad (maintainer)
- handle qemu-old/kqemu removal in PLISTs, allowing seamless updates to
the new version
@
text
@d1 3
a3 3
$OpenBSD: patch-configure,v 1.17 2011/05/23 23:43:28 sthen Exp $
--- configure.orig	Thu Aug  4 17:24:34 2011
+++ configure	Sun Aug  7 21:47:00 2011
d40 34
a73 1
@@@@ -1513,11 +1517,17 @@@@ int main(void) {
d91 1
a91 1
@@@@ -1844,7 +1854,7 @@@@ fi
d100 1
a100 1
@@@@ -2546,8 +2556,9 @@@@ fi
d112 19
a130 1
@@@@ -3048,7 +3059,7 @@@@ echo "TOOLS=$tools" >> $config_host_mak
d135 5
a139 3
+echo "INSTALL_DIR=$install -d -m0755" >> $config_host_mak
 echo "INSTALL_DATA=$install -m0644 -p" >> $config_host_mak
 echo "INSTALL_PROG=$install -m0755 -p" >> $config_host_mak
d141 2
a142 13
@@@@ -3520,7 +3531,11 @@@@ if test "$gprof" = "yes" ; then
   fi
 fi
 
-linker_script="-Wl,-T../config-host.ld -Wl,-T,\$(SRC_PATH)/\$(ARCH).ld"
+if test "$targetos" != "OpenBSD"; then
+  linker_script="-Wl,-T../config-host.ld -Wl,-T,\$(SRC_PATH)/\$(ARCH).ld"
+else
+  linker_script=""
+fi
 if test "$target_linux_user" = "yes" -o "$target_bsd_user" = "yes" ; then
   case "$ARCH" in
   sparc)
@


1.17
log
@qemu Makefile/patch changes, from Brad.

- Sort the arch list.
- Remove some local patching from the configure script
  which is not necessary.
- Remove debug option from linker command line when not using --enable-debug.
- Recognize arm / hppa OpenBSD.
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.16 2011/03/12 23:28:39 sthen Exp $
--- configure.orig	Fri May  6 15:01:43 2011
+++ configure	Mon May 23 12:58:28 2011
@@@@ -223,13 +223,11 @@@@ sdl_config="${cross_prefix}${SDL_CONFIG-sdl-config}"
d9 1
a9 1
 QEMU_CFLAGS="-Wall -Wundef -Wendif-labels -Wwrite-strings -Wmissing-prototypes $QEMU_CFLAGS"
d18 1
a18 1
@@@@ -275,6 +273,12 @@@@ elif check_define __s390__ ; then
d31 1
a31 1
@@@@ -295,7 +299,7 @@@@ case "$cpu" in
d40 2
a41 9
@@@@ -934,7 +938,6 @@@@ fi
 gcc_flags="-Wold-style-declaration -Wold-style-definition -Wtype-limits"
 gcc_flags="-Wformat-security -Wformat-y2k -Winit-self -Wignored-qualifiers $gcc_flags"
 gcc_flags="-Wmissing-include-dirs -Wempty-body -Wnested-externs $gcc_flags"
-gcc_flags="-fstack-protector-all $gcc_flags"
 cat > $TMPC << EOF
 int main(void) { return 0; }
 EOF
@@@@ -1345,7 +1348,7 @@@@ int main(void) {
d44 4
d49 2
a50 2
-    vnc_png_libs="-lpng"
+    vnc_png_libs="-lpng -lz -lm"
d54 5
a58 1
@@@@ -1760,7 +1763,7 @@@@ fi
d67 1
a67 1
@@@@ -2329,8 +2332,9 @@@@ fi
d74 2
a75 2
+  CFLAGS="-O0 -g $CFLAGS"
+  LDFLAGS="-g $LDFLAGS"
d79 1
a79 1
@@@@ -2788,7 +2792,7 @@@@ echo "TOOLS=$tools" >> $config_host_mak
d87 2
a88 2
 echo "CC=$cc" >> $config_host_mak
@@@@ -3223,7 +3227,11 @@@@ if test "$gprof" = "yes" ; then
@


1.16
log
@update qemu to 0.14.0, from Brad.
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.15 2010/11/22 11:32:01 fgsch Exp $
--- configure.orig	Mon Feb 14 17:02:07 2011
+++ configure	Tue Feb 15 20:46:07 2011
@@@@ -223,9 +223,8 @@@@ sdl_config="${cross_prefix}${SDL_CONFIG-sdl-config}"
d10 1
a10 2
-QEMU_CFLAGS="-Wstrict-prototypes -Wredundant-decls $QEMU_CFLAGS"
+QEMU_CFLAGS="-Wstrict-prototypes $QEMU_CFLAGS"
d14 16
a29 2
@@@@ -931,10 +930,9 @@@@ else
     exit 1
d31 11
a41 3
 
-gcc_flags="-Wold-style-declaration -Wold-style-definition -Wtype-limits"
+gcc_flags="-Wold-style-definition -Wtype-limits"
d48 1
a48 1
@@@@ -1345,7 +1343,7 @@@@ int main(void) {
d57 1
a57 1
@@@@ -1760,7 +1758,7 @@@@ fi
d62 1
a62 1
+PTHREADLIBS_LIST="-pthread"
d66 1
a66 1
@@@@ -2329,8 +2327,8 @@@@ fi
d74 1
d78 1
a78 1
@@@@ -2788,7 +2786,7 @@@@ echo "TOOLS=$tools" >> $config_host_mak
d87 1
a87 1
@@@@ -3223,7 +3221,11 @@@@ if test "$gprof" = "yes" ; then
@


1.15
log
@Update to qemu 0.13.0. fmt README and sync with reality.
with input and ok sthen@@
@
text
@d1 4
a4 19
$OpenBSD: patch-configure,v 1.14 2010/06/17 09:57:55 fgsch Exp $
--- configure.orig	Fri Oct 15 21:56:09 2010
+++ configure	Thu Nov 18 21:05:53 2010
@@@@ -69,12 +69,12 @@@@ interp_prefix="/usr/gnemul/qemu-%M"
 static="no"
 sparc_cpu=""
 cross_prefix=""
-cc="gcc"
+cc="${CC:-cc}"
 audio_drv_list=""
 audio_card_list="ac97 es1370 sb16"
 audio_possible_cards="ac97 es1370 sb16 cs4231a adlib gus"
 block_drv_whitelist=""
-host_cc="gcc"
+host_cc="${CC:-cc}"
 ar="ar"
 make="make"
 install="install"
@@@@ -128,15 +128,15 @@@@ ld="${cross_prefix}${ld}"
a8 1
+CFLAGS="$CFLAGS"
d14 4
a17 2
 QEMU_CFLAGS="-I. -I\$(SRC_PATH) $QEMU_CFLAGS"
 LDFLAGS="-g $LDFLAGS"
d19 5
a23 2
-gcc_flags="-Wold-style-declaration -Wold-style-definition -fstack-protector-all"
+gcc_flags="-Wold-style-definition"
d27 1
a27 1
@@@@ -1300,7 +1300,7 @@@@ int main(void) {
d36 1
a36 1
@@@@ -1677,7 +1677,7 @@@@ fi
d45 2
a46 1
@@@@ -2061,7 +2061,9 @@@@ fi
d49 1
a49 1
 if test "$debug" = "no" ; then
d51 1
a51 2
+  CFLAGS="$CFLAGS"
+else
d56 1
a56 1
@@@@ -2452,7 +2454,7 @@@@ echo "TOOLS=$tools" >> $config_host_mak
d65 1
a65 1
@@@@ -2889,7 +2891,11 @@@@ if test "$gprof" = "yes" ; then
@


1.14
log
@Add debug flavor.
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.13 2010/05/27 17:55:05 fgsch Exp $
--- configure.orig	Tue May  4 16:27:48 2010
+++ configure	Wed Jun 16 21:24:04 2010
@@@@ -34,12 +34,12 @@@@ interp_prefix="/usr/gnemul/qemu-%M"
d19 1
a19 1
@@@@ -93,7 +93,7 @@@@ ld="${cross_prefix}${ld}"
d26 2
a27 1
 QEMU_CFLAGS="-Wstrict-prototypes -Wredundant-decls $QEMU_CFLAGS"
d29 28
a56 1
@@@@ -1788,7 +1788,9 @@@@ fi
d63 1
a63 1
+  CFLAGS="-g $CFLAGS"
d67 2
a68 11
@@@@ -1836,7 +1838,7 @@@@ else
   if test -z "$prefix" ; then
       prefix="/usr/local"
   fi
-  mansuffix="/share/man"
+  mansuffix="/man"
   datasuffix="/share/qemu"
   docsuffix="/share/doc/qemu"
   binsuffix="/bin"
@@@@ -2167,7 +2169,7 @@@@ echo "datadir=\${prefix}$datasuffix" >> $config_host_m
 echo "docdir=\${prefix}$docsuffix" >> $config_host_mak
d76 1
a76 1
@@@@ -2575,7 +2577,11 @@@@ if test "$gprof" = "yes" ; then
@


1.13
log
@Update to qemu 0.12.3. Work in progress so not linked to the tree yet.
@
text
@d1 3
a3 3
$OpenBSD$
--- configure.orig	Tue Feb 23 20:54:38 2010
+++ configure	Tue Mar  9 08:12:32 2010
d28 1
a28 1
@@@@ -1788,7 +1788,7 @@@@ fi
d34 2
d39 1
a39 1
@@@@ -1836,7 +1836,7 @@@@ else
d48 1
a48 1
@@@@ -2167,7 +2167,7 @@@@ echo "datadir=\${prefix}$datasuffix" >> $config_host_m
d57 1
a57 1
@@@@ -2575,7 +2575,11 @@@@ if test "$gprof" = "yes" ; then
@


1.12
log
@- adapt patch now that we have ENOTSUP defined
@
text
@d1 4
a4 5
$OpenBSD: patch-configure,v 1.11 2008/06/19 05:51:17 todd Exp $
--- configure.orig	Sun Jan  6 20:38:42 2008
+++ configure	Tue Oct 27 14:01:40 2009
@@@@ -21,10 +21,10 @@@@ prefix=""
 interp_prefix="/usr/gnemul/qemu-%M"
d6 1
d10 4
a13 2
 gcc3_search="yes"
 gcc3_list="gcc-3.4.6 gcc-3.4 gcc34 gcc-3.3.6 gcc-3.3 gcc33 gcc-3.2 gcc32"
d19 1
a19 38
@@@@ -44,7 +44,7 @@@@ case "$cpu" in
   alpha)
     cpu="alpha"
   ;;
-  "Power Macintosh"|ppc|ppc64)
+  "Power Macintosh"|macppc|ppc|ppc64)
     cpu="powerpc"
   ;;
   mips)
@@@@ -74,6 +74,9 @@@@ case "$cpu" in
   x86_64|amd64)
     cpu="x86_64"
   ;;
+  armish|zaurus)
+    cpu="arm"
+  ;;
   *)
     cpu="unknown"
   ;;
@@@@ -142,7 +145,11 @@@@ oss="yes"
 ;;
 OpenBSD)
 bsd="yes"
+openbsd="yes"
 oss="yes"
+if [ "$cpu" = "i386" -o "$cpu" = "x86_64" ] ; then
+    kqemu="yes"
+fi
 ;;
 Darwin)
 bsd="yes"
@@@@ -191,12 +198,14 @@@@ linux_user="yes"
 if [ "$cpu" = "i386" -o "$cpu" = "x86_64" ] ; then
     kqemu="yes"
 fi
+usb="linux"
 ;;
 esac
d21 13
a33 5
 if [ "$bsd" = "yes" ] ; then
   if [ "$darwin" != "yes" ] ; then
     make="gmake"
+    usb="bsd"
   fi
d36 2
a37 10
@@@@ -329,7 +338,7 @@@@ else
 fi
 
 # default flags for all hosts
-CFLAGS="$CFLAGS -Wall -O2 -g -fno-strict-aliasing"
+CFLAGS="$CFLAGS -Wall -g -fno-strict-aliasing"
 LDFLAGS="$LDFLAGS -g"
 if test "$werror" = "yes" ; then
 CFLAGS="$CFLAGS -Werror"
@@@@ -680,7 +689,7 @@@@ else
d46 11
a56 41
@@@@ -709,9 +718,7 @@@@ if test "$darwin" = "yes" ; then
     echo "Cocoa support     $cocoa"
 fi
 echo "SDL support       $sdl"
-if test "$sdl" != "no" ; then
-    echo "SDL static link   $sdl_static"
-fi
+echo "SDL static link   $sdl_static"
 echo "mingw32 support   $mingw32"
 echo "Adlib support     $adlib"
 echo "CoreAudio support $coreaudio"
@@@@ -772,6 +779,7 @@@@ echo "mandir=\${prefix}$mansuffix" >> $config_mak
 echo "datadir=\${prefix}$datasuffix" >> $config_mak
 echo "docdir=\${prefix}$docsuffix" >> $config_mak
 echo "#define CONFIG_QEMU_SHAREDIR \"$prefix$datasuffix\"" >> $config_h
+echo "#define CONFIG_NO_AIO 1" >> $config_h
 echo "MAKE=$make" >> $config_mak
 echo "INSTALL=$install" >> $config_mak
 echo "CC=$cc" >> $config_mak
@@@@ -793,6 +801,9 @@@@ if test "$cpu" = "i386" ; then
 elif test "$cpu" = "x86_64" ; then
   echo "ARCH=x86_64" >> $config_mak
   echo "#define HOST_X86_64 1" >> $config_h
+elif test "$cpu" = "arm" ; then
+  echo "ARCH=arm" >> $config_mak
+  echo "#define HOST_ARM 1" >> $config_h
 elif test "$cpu" = "armv4b" ; then
   echo "ARCH=arm" >> $config_mak
   echo "#define HOST_ARM 1" >> $config_h
@@@@ -892,6 +903,9 @@@@ fi
 if test "$oss" = "yes" ; then
   echo "CONFIG_OSS=yes" >> $config_mak
   echo "#define CONFIG_OSS 1" >> $config_h
+  if test "$openbsd"="yes" ; then
+     echo "CONFIG_OSS_LIBRARY=yes" >> $config_mak
+  fi
 fi
 if test "$coreaudio" = "yes" ; then
   echo "CONFIG_COREAUDIO=yes" >> $config_mak
@@@@ -953,6 +967,12 @@@@ if test "$cocoa" = "yes" ; then
     echo "CONFIG_COCOA=yes" >> $config_mak
d59 3
a61 2
+if [ "$openbsd" = "yes" ] ; then
+  echo "#define qemu_siginfo siginfo_t" >> $config_h
d63 5
a67 26
+  echo "#define qemu_siginfo struct siginfo" >> $config_h
+fi     
+
 # XXX: suppress that
 if [ "$bsd" = "yes" ] ; then
   echo "#define O_LARGEFILE 0" >> $config_h
@@@@ -961,6 +981,19 @@@@ if [ "$bsd" = "yes" ] ; then
 fi
 
 echo "#define CONFIG_UNAME_RELEASE \"$uname_release\"" >> $config_h
+
+# USB host support
+case "$usb" in
+linux)
+  echo "HOST_USB=linux" >> $config_mak
+;;
+bsd)
+  echo "HOST_USB=bsd" >> $config_mak
+;;
+*)
+  echo "HOST_USB=stub" >> $config_mak
+;;
+esac
 
 tools=
 if test `expr "$target_list" : ".*softmmu.*"` != 0 ; then
@


1.11
log
@add usb host support, from jcs@@
bump pkgname
@
text
@d1 3
a3 3
$OpenBSD: patch-configure,v 1.10 2008/04/28 22:52:38 todd Exp $
--- configure.orig	Sun Jan  6 13:38:42 2008
+++ configure	Tue Jun 17 19:36:42 2008
d120 1
a120 1
@@@@ -953,6 +967,13 @@@@ if test "$cocoa" = "yes" ; then
a124 1
+  echo "#define ENOTSUP 4096" >> $config_h
d133 1
a133 1
@@@@ -961,6 +982,19 @@@@ if [ "$bsd" = "yes" ] ; then
@


1.10
log
@o update to 0.9.1, lots from brad@@
o see http://qemu.org/changelog.html for details
o see README.OpenBSD for an intro to qemu on OpenBSD
o disable broken arm host support for now
@
text
@d1 3
a3 3
$OpenBSD: patch-configure,v 1.9 2008/01/19 23:53:58 todd Exp $
--- configure.orig	Sun Jan  6 14:38:42 2008
+++ configure	Thu Apr 10 01:34:20 2008
d48 16
a63 1
@@@@ -329,7 +336,7 @@@@ else
d72 1
a72 1
@@@@ -680,7 +687,7 @@@@ else
d81 1
a81 1
@@@@ -709,9 +716,7 @@@@ if test "$darwin" = "yes" ; then
d92 1
a92 1
@@@@ -772,6 +777,7 @@@@ echo "mandir=\${prefix}$mansuffix" >> $config_mak
d100 1
a100 1
@@@@ -793,6 +799,9 @@@@ if test "$cpu" = "i386" ; then
d110 1
a110 1
@@@@ -892,6 +901,9 @@@@ fi
d120 1
a120 2
@@@@ -952,6 +964,13 @@@@ if test "$cocoa" = "yes" ; then
     echo "#define CONFIG_COCOA 1" >> $config_h
d123 1
a123 1
+
d130 1
a130 1
 
d133 21
@


1.9
log
@kqemu flavor, tested by several in an unflavored earlier version
prodded by marco@@
@
text
@d1 3
a3 3
$OpenBSD: patch-configure,v 1.8 2007/05/01 12:55:14 todd Exp $
--- configure.orig	Mon Feb  5 17:01:54 2007
+++ configure	Wed Jan 16 11:23:08 2008
d11 1
a11 1
 gcc3_list="gcc-3.4 gcc34 gcc-3.3 gcc33 gcc-3.2 gcc32"
d26 1
a26 1
@@@@ -68,6 +68,9 @@@@ case "$cpu" in
d36 1
a36 1
@@@@ -122,7 +125,11 @@@@ oss="yes"
d42 1
a42 1
+if [ "$USE_KQEMU" = "yes" ] ; then
d48 1
a48 3
@@@@ -573,7 +580,7 @@@@ else
 if test -z "$prefix" ; then
     prefix="/usr/local"
d50 17
a66 6
-mandir="$prefix/share/man"
+mandir="$prefix/man"
 datadir="$prefix/share/qemu"
 docdir="$prefix/share/doc/qemu"
 bindir="$prefix/bin"
@@@@ -601,9 +608,7 @@@@ if test "$darwin" = "yes" ; then
d77 4
a80 4
@@@@ -648,6 +653,7 @@@@ echo "mandir=$mandir" >> $config_mak
 echo "datadir=$datadir" >> $config_mak
 echo "docdir=$docdir" >> $config_mak
 echo "#define CONFIG_QEMU_SHAREDIR \"$datadir\"" >> $config_h
d85 1
a85 1
@@@@ -667,6 +673,9 @@@@ if test "$cpu" = "i386" ; then
d95 1
a95 1
@@@@ -746,6 +755,9 @@@@ fi
d105 3
a107 3
@@@@ -777,6 +789,13 @@@@ echo "TARGET_DIRS=$target_list" >> $config_mak
 if [ "$build_docs" = "yes" ] ; then
   echo "BUILD_DOCS=yes" >> $config_mak
@


1.8
log
@update to 0.9.0, thanks to all who gave feedback
see http://qemu.org/changelog.html for details
new in OpenBSD, support for raw block devices
@
text
@d1 1
a1 1
$OpenBSD$
d3 1
a3 1
+++ configure	Tue Apr  3 08:21:26 2007
d36 1
a36 1
@@@@ -122,6 +125,7 @@@@ oss="yes"
d42 3
d47 2
a48 1
@@@@ -573,7 +577,7 @@@@ else
d57 1
a57 1
@@@@ -601,9 +605,7 @@@@ if test "$darwin" = "yes" ; then
d68 1
a68 1
@@@@ -648,6 +650,7 @@@@ echo "mandir=$mandir" >> $config_mak
d76 1
a76 1
@@@@ -667,6 +670,9 @@@@ if test "$cpu" = "i386" ; then
d86 1
a86 1
@@@@ -746,6 +752,9 @@@@ fi
d96 1
a96 1
@@@@ -777,6 +786,13 @@@@ echo "TARGET_DIRS=$target_list" >> $config_mak
@


1.7
log
@- allow building on armish
- fix the build on the arm architecture by moving the cpu_get_real_ticks()
function for non-optimized to the correct place
- add correct REGRESS_TARGET even if the regressions tests are utterly broken
- bump PKGNAME
@
text
@d1 4
a4 4
$OpenBSD: patch-configure,v 1.6 2006/12/22 17:31:45 todd Exp $
--- configure.orig	Sat Jul 22 19:23:34 2006
+++ configure	Tue Feb 13 09:22:48 2007
@@@@ -21,8 +21,8 @@@@ prefix=""
d9 3
a12 1
+cc="${CC:-cc}"
d17 1
a17 1
@@@@ -42,7 +42,7 @@@@ case "$cpu" in
d26 1
a26 1
@@@@ -66,6 +66,9 @@@@ case "$cpu" in
d36 1
a36 1
@@@@ -121,6 +124,7 @@@@ oss="yes"
d44 1
a44 1
@@@@ -509,7 +513,7 @@@@ else
d53 1
a53 1
@@@@ -537,9 +541,7 @@@@ if test "$darwin" = "yes" ; then
d64 9
a72 1
@@@@ -602,6 +604,9 @@@@ if test "$cpu" = "i386" ; then
d82 1
a82 1
@@@@ -681,6 +686,9 @@@@ fi
d92 3
a94 3
@@@@ -715,6 +723,13 @@@@ fi
 if [ "$build_acpi_tables" = "yes" ] ; then
   echo "BUILD_ACPI_TABLES=yes" >> $config_mak
@


1.6
log
@update qemu to 0.8.2, from brad@@

See http://fabrice.bellard.free.fr/qemu/changelog.html for details.
@
text
@d1 3
a3 3
$OpenBSD: patch-configure,v 1.5 2006/06/08 14:33:38 todd Exp $
--- configure.orig	Sat Jul 22 13:23:34 2006
+++ configure	Sun Nov 12 17:10:10 2006
d28 1
a28 1
+  zaurus)
@


1.5
log
@update to 0.8.1, see http://qemu.org/changelog.html for details
@
text
@d1 3
a3 3
$OpenBSD: patch-configure,v 1.4 2006/02/08 13:44:17 todd Exp $
--- configure.orig	Wed May  3 15:32:58 2006
+++ configure	Fri May  5 22:07:38 2006
d34 1
a34 1
@@@@ -119,6 +122,7 @@@@ oss="yes"
d42 1
a42 1
@@@@ -495,7 +499,7 @@@@ else
d51 1
a51 1
@@@@ -523,9 +527,7 @@@@ if test "$darwin" = "yes" ; then
d62 1
a62 1
@@@@ -586,6 +588,9 @@@@ if test "$cpu" = "i386" ; then
d72 1
a72 1
@@@@ -665,6 +670,9 @@@@ fi
d82 3
a84 3
@@@@ -703,6 +711,13 @@@@ if [ "$bsd" = "yes" ] ; then
   echo "#define MAP_ANONYMOUS MAP_ANON" >> $config_h
   echo "#define _BSD 1" >> $config_h
d94 2
a95 2
 for target in $target_list; do
 target_dir="$target"
@


1.4
log
@o from the qemu mailing list, prompted by brad@@, improve userland
  networking througput since otherwise the emulated NICs didn't
  have a way of indicating the receive queue is full and would
  drop packets.
o bump PKGNAME
o inttypes.h made irrelevent a few chunks of patches, so use it instead
@
text
@d1 3
a3 3
$OpenBSD: patch-configure,v 1.3 2005/12/27 07:56:15 todd Exp $
--- configure.orig	Mon Dec 19 16:51:53 2005
+++ configure	Wed Feb  8 06:05:57 2006
d14 2
a15 2
 strip="strip"
@@@@ -41,7 +41,7 @@@@ case "$cpu" in
d24 1
a24 1
@@@@ -65,6 +65,9 @@@@ case "$cpu" in
d34 1
a34 1
@@@@ -113,6 +116,7 @@@@ oss="yes"
d42 1
a42 1
@@@@ -400,7 +404,7 @@@@ else
d51 1
a51 1
@@@@ -468,9 +472,7 @@@@ if test "$darwin" = "yes" ; then
d62 1
a62 1
@@@@ -539,6 +541,9 @@@@ if test "$cpu" = "i386" ; then
d72 1
a72 1
@@@@ -611,6 +616,9 @@@@ fi
d82 1
a82 1
@@@@ -655,6 +663,13 @@@@ if [ "$bsd" = "yes" ] ; then
d95 1
a95 1
 
@


1.3
log
@update to 0.8.0, see qemu.org for full ChangeLog
for OpenBSD, amd64 simulation on i386 appars to work ok now
@
text
@d1 1
a1 1
$OpenBSD: patch-configure,v 1.2 2005/08/11 01:15:17 todd Exp $
d3 1
a3 1
+++ configure	Tue Dec 20 08:06:20 2005
d82 1
a82 1
@@@@ -655,6 +663,14 @@@@ if [ "$bsd" = "yes" ] ; then
a88 1
+  echo "#define PRIx64 \"llX\"" >> $config_h
@


1.2
log
@update to 0.7.1 (http://qemu.org/changelog.html)
add pcnet nic support
@
text
@d1 3
a3 3
$OpenBSD: patch-configure,v 1.1.1.1 2005/03/07 16:41:28 todd Exp $
--- configure.orig	Sun Jul 24 13:52:08 2005
+++ configure	Tue Aug  9 22:34:48 2005
d24 11
a34 1
@@@@ -109,6 +109,7 @@@@ oss="yes"
d42 1
a42 1
@@@@ -366,7 +367,7 @@@@ else
d51 1
a51 1
@@@@ -434,9 +435,7 @@@@ if test "$darwin" = "yes" ; then
d61 12
a72 2
 echo -n "FMOD support      $fmod"
@@@@ -567,6 +566,9 @@@@ fi
d80 3
a82 3
 if test "$fmod" = "yes" ; then
   echo "CONFIG_FMOD=yes" >> $config_mak
@@@@ -599,6 +601,14 @@@@ if [ "$bsd" = "yes" ] ; then
d95 1
a95 1
 for target in $target_list; do 
@


1.1
log
@Initial revision
@
text
@d1 14
a14 3
$OpenBSD$
--- configure.orig	Sat Feb 19 11:24:28 2005
+++ configure	Sun Feb 27 15:47:13 2005
d24 1
a24 1
@@@@ -100,6 +100,7 @@@@ oss="yes"
d32 1
a32 1
@@@@ -341,7 +342,7 @@@@ else
d41 12
a52 1
@@@@ -533,6 +534,9 @@@@ fi
d57 1
a57 1
+    echo "CONFIG_OSS_LIBRARY=yes" >> $config_mak
d62 1
a62 1
@@@@ -563,6 +567,15 @@@@ if [ "$bsd" = "yes" ] ; then
a73 1
+
@


1.1.1.1
log
@Import qemu snapshot from 2005-02-27

QEMU is a generic and open source processor emulator 
which achieves a good emulation speed by using dynamic translation.

QEMU has two operating modes:

* Full system emulation. In this mode, QEMU emulates 
a full system (for example a PC), including a processor and 
various peripherials. It can be used to launch different
Operating Systems without rebooting the PC or to debug system code.

* User mode emulation (Linux host only). In this mode, 

.. many thanks for feedback from many people, and for Lars Hansson and 
   Michael Schmidt for posting early work on the port of qemu to ports@@

For now, only for macppc and i386, as these are currently the only archs
that have reported success building qemu.
QEMU can launch Linux processes compiled for one CPU on another CPU. 
@
text
@@
