head	1.3;
access;
symbols
	OPENBSD_4_4:1.2.0.6
	OPENBSD_4_4_BASE:1.2
	OPENBSD_4_3:1.2.0.4
	OPENBSD_4_3_BASE:1.2
	OPENBSD_4_2:1.2.0.2
	OPENBSD_4_2_BASE:1.2
	OPENBSD_4_1:1.1.0.4
	OPENBSD_4_1_BASE:1.1
	OPENBSD_4_0:1.1.0.2
	OPENBSD_4_0_BASE:1.1;
locks; strict;
comment	@# @;


1.3
date	2008.09.30.17.39.24;	author brad;	state dead;
branches;
next	1.2;

1.2
date	2007.05.31.20.31.36;	author aanriot;	state Exp;
branches;
next	1.1;

1.1
date	2006.07.16.15.13.27;	author mcbride;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Remove this ancient VMware 3 port for the kernel LKMs. They have never
really worked very well and with newer kernels they do not work at all.

PR 5893.
@
text
@$OpenBSD: patch-source_vmmon_openbsd_host_c,v 1.2 2007/05/31 20:31:36 aanriot Exp $
--- source/vmmon/openbsd/host.c.orig	Sun Mar 14 14:58:50 2004
+++ source/vmmon/openbsd/host.c	Wed May 30 23:07:39 2007
@@@@ -59,6 +59,8 @@@@ lyaev Exp $
 #include <sys/proc.h>
 
 #include <machine/pio.h>
+#include <uvm/uvm_extern.h>
+#include <machine/pmap.h>
 
 #include <uvm/uvm_extern.h>
 #include <uvm/uvm_param.h>
@@@@ -153,14 +155,11 @@@@ int host_unlock_ppn(PPN ppn)
 static INLINE MPN
 HostifVa2Mpn(VA addr)
 {
-	pt_entry_t *pteptr = (pt_entry_t *)vtopte((vaddr_t)addr);
-	PTE pte;
-   
-	pte = *pteptr;
-	if (pte & PTE_P)
-		return PTE_2_PFN(pte);
-	else
+	paddr_t pa;
+	if (pmap_extract(vm_map_pmap(&curproc->p_vmspace->vm_map), addr, &pa)
+	    == FALSE)
 		return 0;
+	return (pa >> PAGE_SHIFT);
 }
 
 /*
@@@@ -665,7 +664,6 @@@@ HostIF_UserToDriverPtr(VMDriver *vm, // IN
 	if (vm->crossvaddr != NULL)
 		Warning("KernelAddr already allocated\n");
 
-	PHOLD(CURLWP);
 	uvm_vslock(curproc, addr, PAGE_SIZE,
 	    VM_PROT_READ|VM_PROT_WRITE|VM_PROT_EXECUTE);
 
@@@@ -674,7 +672,6 @@@@ HostIF_UserToDriverPtr(VMDriver *vm, // IN
 	pmap_extract(vm_map_pmap(&curproc->p_vmspace->vm_map), uaddr, &paddr);
 	pmap_kenter_pa(kvaddr, paddr,
 	    VM_PROT_READ | VM_PROT_WRITE | VM_PROT_EXECUTE);
-	PRELE(CURLWP);
 	vm->crossvaddr = (void *)kvaddr;
 	vm->crossuaddr = addr;
 #ifdef DEBUG
@


1.2
log
@- unbreak vmmon/vmnet removing the PHOLD/PRELE calls that are not
present anymore.
- while there, regen patches.

ok todd@@
@
text
@d1 1
a1 1
$OpenBSD: patch-source_vmmon_openbsd_host_c,v 1.1 2006/07/16 15:13:27 mcbride Exp $
@


1.1
log
@Make vmware work with pae. Most of the fixups from drahn@@

ok todd@@
@
text
@d1 3
a3 3
$OpenBSD$
--- source/vmmon/openbsd/host.c.orig	Sun Mar 14 21:58:50 2004
+++ source/vmmon/openbsd/host.c	Sun Jul 16 12:31:29 2006
d32 16
@

