head	1.1;
access;
symbols
	OPENBSD_6_0:1.1.0.12
	OPENBSD_6_0_BASE:1.1
	OPENBSD_5_9:1.1.0.8
	OPENBSD_5_9_BASE:1.1
	OPENBSD_5_8:1.1.0.10
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.6
	OPENBSD_5_7_BASE:1.1
	OPENBSD_5_6:1.1.0.4
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.2
	OPENBSD_5_5_BASE:1.1;
locks; strict;
comment	@# @;


1.1
date	2013.12.02.16.32.12;	author naddy;	state Exp;
branches;
next	;


desc
@@


1.1
log
@replace ftime() with gettimeofday() and drop -lcompat; ok edd@@ jca@@
@
text
@$OpenBSD$

Replace ftime() by gettimeofday().

--- src/blkdev_cdimage.cpp.orig	Tue Jun 25 21:21:17 2013
+++ src/blkdev_cdimage.cpp	Sun Dec  1 23:41:31 2013
@@@@ -13,7 +13,7 @@@@
 #include "sysconfig.h"
 #include "sysdeps.h"
 
-#include <sys/timeb.h>
+#include <sys/time.h>
 
 #include "options.h"
 #include "blkdev.h"
@@@@ -375,11 +375,11 @@@@ static void *cdda_play_func (void *v)
 		if (oldplay != cdu->cdda_play) {
 			struct cdtoc *t;
 			int sector, diff;
-			struct _timeb tb1, tb2;
+			struct timeval tb1, tb2;
 
 			idleframes = 0;
 			foundsub = false;
-			_ftime (&tb1);
+			gettimeofday (&tb1, NULL);
 			cdda_pos = cdu->cdda_start;
 			oldplay = cdu->cdda_play;
 			sector = cdu->cd_last_pos = cdda_pos;
@@@@ -434,8 +434,8 @@@@ static void *cdda_play_func (void *v)
 			}
 			cdda_pos -= idleframes;
 
-			_ftime (&tb2);
-			diff = (tb2.time * (uae_s64)1000 + tb2.millitm) - (tb1.time * (uae_s64)1000 + tb1.millitm);
+			gettimeofday (&tb2, NULL);
+			diff = (tb2.tv_sec * (uae_s64)1000 + tb2.tv_usec / 1000) - (tb1.tv_sec * (uae_s64)1000 + tb1.tv_usec / 1000);
 			diff -= cdu->cdda_delay;
 			if (idleframes >= 0 && diff < 0 && cdu->cdda_play > 0)
 				Sleep (-diff);
@
