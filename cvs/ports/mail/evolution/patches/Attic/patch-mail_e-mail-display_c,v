head	1.4;
access;
symbols
	OPENBSD_5_3:1.1.0.2
	OPENBSD_5_3_BASE:1.1;
locks; strict;
comment	@# @;


1.4
date	2014.04.13.16.14.19;	author ajacoutot;	state dead;
branches;
next	1.3;

1.3
date	2014.04.08.15.23.15;	author ajacoutot;	state Exp;
branches;
next	1.2;

1.2
date	2013.03.07.08.56.00;	author ajacoutot;	state dead;
branches;
next	1.1;

1.1
date	2013.01.30.07.21.01;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Update to evolution-3.12.1.
@
text
@$OpenBSD: patch-mail_e-mail-display_c,v 1.3 2014/04/08 15:23:15 ajacoutot Exp $

From ab955f205453f98b9276a7c267dfb452114faa9d Mon Sep 17 00:00:00 2001
From: Tomas Popela <tpopela@@redhat.com>
Date: Fri, 4 Apr 2014 10:37:25 +0200
Subject: EMailDisplay: Install HTML click event handlers on images in all

--- mail/e-mail-display.c.orig	Sun Mar 16 14:29:41 2014
+++ mail/e-mail-display.c	Tue Apr  8 16:40:58 2014
@@@@ -887,26 +887,14 @@@@ initialize_web_view_colors (EMailDisplay *display)
 }
 
 static void
-setup_dom_bindings (GObject *object,
-                    GParamSpec *pspec,
-                    gpointer user_data)
+setup_image_click_event_listeners_on_document (WebKitDOMDocument *document,
+                                                WebKitWebView *web_view)
 {
-	WebKitWebView *web_view;
-	WebKitWebFrame *frame;
-	WebKitLoadStatus load_status;
-	WebKitDOMDocument *document;
+	gint length, ii = 0;
 	WebKitDOMElement *button;
 	WebKitDOMNodeList *list;
-	gint length, ii = 0;
 
-	frame = WEBKIT_WEB_FRAME (object);
-	load_status = webkit_web_frame_get_load_status (frame);
-	if (load_status != WEBKIT_LOAD_FINISHED)
-		return;
-
-	web_view = webkit_web_frame_get_web_view (frame);
-	document = webkit_web_view_get_dom_document (web_view);
-
+	/* Install event listeners on document */
 	button = webkit_dom_document_get_element_by_id (
 		document, "__evo-collapse-headers-img");
 	if (button != NULL)
@@@@ -930,6 +918,18 @@@@ setup_dom_bindings (GObject *object,
 }
 
 static void
+setup_dom_bindings (WebKitWebView *web_view,
+                    WebKitWebFrame *frame,
+                    gpointer user_data)
+{
+	WebKitDOMDocument *document;
+
+	document = webkit_web_frame_get_dom_document (frame);
+
+	setup_image_click_event_listeners_on_document (document, web_view);
+}
+
+static void
 mail_parts_bind_dom (GObject *object,
                      GParamSpec *pspec,
                      gpointer user_data)
@@@@ -1526,6 +1526,12 @@@@ e_mail_display_init (EMailDisplay *display)
 	g_signal_connect (
 		display, "notify::uri",
 		G_CALLBACK (mail_display_uri_changed), NULL);
+	g_signal_connect (
+		display, "document-load-finished",
+		G_CALLBACK (setup_dom_bindings), NULL);
+	g_signal_connect (
+		display, "document-load-finished",
+		G_CALLBACK (initialize_web_view_colors), NULL);
 
 	display->priv->settings = g_settings_new ("org.gnome.evolution.mail");
 	g_signal_connect_swapped (
@@@@ -1543,13 +1549,7 @@@@ e_mail_display_init (EMailDisplay *display)
 	main_frame = webkit_web_view_get_main_frame (WEBKIT_WEB_VIEW (display));
 	g_signal_connect (
 		main_frame, "notify::load-status",
-		G_CALLBACK (setup_dom_bindings), NULL);
-	g_signal_connect (
-		main_frame, "notify::load-status",
 		G_CALLBACK (mail_parts_bind_dom), NULL);
-	g_signal_connect (
-		display, "document-load-finished",
-		G_CALLBACK (initialize_web_view_colors), NULL);
 
 	actions = e_web_view_get_action_group (E_WEB_VIEW (display), "mailto");
 	gtk_action_group_add_actions (
@


1.3
log
@Start unbreaking the evolution stack by merging relevant commits from
upstream.
@
text
@d1 1
a1 1
$OpenBSD$
@


1.2
log
@Update to evolution-3.6.4.
@
text
@d1 1
a1 1
$OpenBSD: patch-mail_e-mail-display_c,v 1.1 2013/01/30 07:21:01 ajacoutot Exp $
d3 4
a6 4
From d25c6ff68132221ae1369aff29b8d7acbb2fb3aa Mon Sep 17 00:00:00 2001
From: Milan Crha <mcrha@@redhat.com>
Date: Thu, 24 Jan 2013 12:11:00 +0000
Subject: Bug #692009 - text/css always formatted as attachment
d8 4
a11 8
--- mail/e-mail-display.c.orig	Sat Jan 19 18:35:13 2013
+++ mail/e-mail-display.c	Wed Jan 30 07:34:36 2013
@@@@ -354,7 +354,7 @@@@ mail_display_resource_requested (WebKitWebView *web_vi
 		new_uri = e_mail_part_build_uri (
 			part_list->folder, part_list->message_uid,
 			"part_id", G_TYPE_STRING, uri,
-			"mode", G_TYPE_INT, E_MAIL_FORMATTER_MODE_RAW, NULL);
+			"mode", G_TYPE_INT, E_MAIL_FORMATTER_MODE_CID, NULL);
d13 15
a27 1
 		webkit_network_request_set_uri (request, new_uri);
d29 58
@


1.1
log
@Merge upstream fixes for the followings nasty bugs:
#692777 - Crash on folder rename
#692009 - text/css always formatted as attachment
#692775 - Double-quoting message with HTML and text
#692783 - Crash on edit prompt cancel
#692781 - Abort on book failure during contact import
@
text
@d1 1
a1 1
$OpenBSD$
@

