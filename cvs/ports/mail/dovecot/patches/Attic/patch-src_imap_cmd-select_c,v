head	1.4;
access;
symbols
	OPENBSD_3_8:1.1.0.10
	OPENBSD_3_8_BASE:1.1
	OPENBSD_3_7:1.1.0.8
	OPENBSD_3_7_BASE:1.1
	OPENBSD_3_6:1.1.0.6
	OPENBSD_3_6_BASE:1.1
	OPENBSD_3_5:1.1.0.4
	OPENBSD_3_5_BASE:1.1
	OPENBSD_3_4:1.1.0.2
	OPENBSD_3_4_BASE:1.1;
locks; strict;
comment	@# @;


1.4
date	2010.10.03.23.25.52;	author sthen;	state dead;
branches;
next	1.3;

1.3
date	2010.09.17.13.11.14;	author sthen;	state Exp;
branches;
next	1.2;

1.2
date	2005.09.04.18.22.30;	author brad;	state dead;
branches;
next	1.1;

1.1
date	2003.07.23.06.03.01;	author jolan;	state Exp;
branches;
next	;


desc
@@


1.4
log
@update to 1.2.15, from Brad
@
text
@$OpenBSD: patch-src_imap_cmd-select_c,v 1.3 2010/09/17 13:11:14 sthen Exp $
--- src/imap/cmd-select.c.orig	Mon Aug 23 10:37:53 2010
+++ src/imap/cmd-select.c	Mon Sep  6 17:06:13 2010
@@@@ -327,10 +327,28 @@@@ select_open(struct imap_select_context *ctx, const cha
 	return 0;
 }
 
+static void close_selected_mailbox(struct client *client)
+{
+	struct mail_storage *old_storage;
+	struct mailbox *box;
+
+	if (client->mailbox == NULL)
+		return;
+
+	old_storage = mailbox_get_storage(client->mailbox);
+	client_search_updates_free(client);
+	box = client->mailbox;
+	client->mailbox = NULL;
+
+	if (mailbox_close(&box) < 0)
+		client_send_untagged_storage_error(client, old_storage);
+	/* CLOSED response is required by QRESYNC */
+	client_send_line(client, "* OK [CLOSED] Previous mailbox closed.");
+}
+
 bool cmd_select_full(struct client_command_context *cmd, bool readonly)
 {
 	struct client *client = cmd->client;
-	struct mailbox *box;
 	struct imap_select_context *ctx;
 	const struct imap_arg *args;
 	const char *mailbox;
@@@@ -342,6 +360,7 @@@@ bool cmd_select_full(struct client_command_context *cm
 
 	if (!IMAP_ARG_TYPE_IS_STRING(args[0].type)) {
 		client_send_command_error(cmd, "Invalid arguments.");
+		close_selected_mailbox(client);
 		return FALSE;
 	}
 	mailbox = IMAP_ARG_STR(&args[0]);
@@@@ -349,12 +368,15 @@@@ bool cmd_select_full(struct client_command_context *cm
 	ctx = p_new(cmd->pool, struct imap_select_context, 1);
 	ctx->cmd = cmd;
 	ctx->storage = client_find_storage(cmd, &mailbox);
-	if (ctx->storage == NULL)
+	if (ctx->storage == NULL) {
+		close_selected_mailbox(client);
 		return TRUE;
+	}
 
 	if (args[1].type == IMAP_ARG_LIST) {
 		if (!select_parse_options(ctx, IMAP_ARG_LIST_ARGS(&args[1]))) {
 			select_context_free(ctx);
+			close_selected_mailbox(client);
 			return TRUE;
 		}
 	}
@@@@ -362,20 +384,7 @@@@ bool cmd_select_full(struct client_command_context *cm
 	i_assert(client->mailbox_change_lock == NULL);
 	client->mailbox_change_lock = cmd;
 
-	if (client->mailbox != NULL) {
-		struct mail_storage *old_storage =
-			mailbox_get_storage(client->mailbox);
-
-		client_search_updates_free(client);
-		box = client->mailbox;
-		client->mailbox = NULL;
-
-		if (mailbox_close(&box) < 0)
-			client_send_untagged_storage_error(client, old_storage);
-		/* CLOSED response is required by QRESYNC */
-		client_send_line(client,
-				 "* OK [CLOSED] Previous mailbox closed.");
-	}
+	close_selected_mailbox(client);
 
 	if (ctx->condstore) {
 		/* Enable while no mailbox is opened to avoid sending
@


1.3
log
@fixes from upstream via Brad;
- Fixed setgid() failure error message.
- imap: If selecting a mailbox fails, close the already selected mailbox.
@
text
@d1 1
a1 1
$OpenBSD$
@


1.2
log
@upgrade to Dovecot 1.0alpha1
@
text
@d1 27
a27 4
$OpenBSD: patch-src_imap_cmd-select_c,v 1.1 2003/07/23 06:03:01 jolan Exp $
--- src/imap/cmd-select.c.orig	Sun Apr  6 09:58:14 2003
+++ src/imap/cmd-select.c	Tue Jul 15 15:17:10 2003
@@@@ -7,6 +7,7 @@@@ int _cmd_select_full(struct client *clie
d29 4
a32 3
 	struct mailbox *box;
 	struct mailbox_status status;
+	enum mailbox_open_flags flags;
d34 17
d52 6
a57 3
 	/* <mailbox> */
@@@@ -20,8 +21,10 @@@@ int _cmd_select_full(struct client *clie
                         client_send_untagged_storage_error(client);
d59 19
d79 2
a80 9
-	box = client->storage->open_mailbox(client->storage, mailbox,
-					    readonly, FALSE);
+	flags = mailbox_open_flags;
+	if (readonly)
+		flags |= MAILBOX_OPEN_READONLY;
+	box = client->storage->open_mailbox(client->storage, mailbox, flags);
 	if (box == NULL) {
 		client_send_storage_error(client);
 		return TRUE;
@


1.1
log
@incorporate megadiff from the author which allows mmaping of index data
on openbsd, related to pr/3291.  bump PKGNAME
@
text
@d1 1
a1 1
$OpenBSD$
@

