head	1.4;
access;
symbols
	OPENBSD_4_5:1.1.0.2
	OPENBSD_4_5_BASE:1.1;
locks; strict;
comment	@# @;


1.4
date	2009.11.10.23.20.22;	author sthen;	state dead;
branches;
next	1.3;

1.3
date	2009.11.06.17.08.50;	author sthen;	state Exp;
branches;
next	1.2;

1.2
date	2009.03.17.09.09.10;	author sthen;	state dead;
branches;
next	1.1;

1.1
date	2009.02.08.14.54.21;	author sthen;	state Exp;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2009.09.23.03.37.03;	author william;	state dead;
branches;
next	;


desc
@@


1.4
log
@Update to 1.1.20, from Brad.
@
text
@$OpenBSD: patch-src_lib-storage_index_maildir_maildir-sync-index_c,v 1.3 2009/11/06 17:08:50 sthen Exp $
--- src/lib-storage/index/maildir/maildir-sync-index.c.orig	Tue Nov  3 19:47:59 2009
+++ src/lib-storage/index/maildir/maildir-sync-index.c	Tue Nov  3 19:49:35 2009
@@@@ -413,8 +413,8 @@@@ int maildir_sync_index(struct maildir_index_sync_conte
 
 	mbox->syncing_commit = TRUE;
 	seq = prev_uid = 0; first_recent_uid = I_MAX(hdr->first_recent_uid, 1);
-	t_array_init(&ctx->keywords, MAILDIR_MAX_KEYWORDS);
-	t_array_init(&ctx->idx_keywords, MAILDIR_MAX_KEYWORDS);
+	i_array_init(&ctx->keywords, MAILDIR_MAX_KEYWORDS);
+	i_array_init(&ctx->idx_keywords, MAILDIR_MAX_KEYWORDS);
 	iter = maildir_uidlist_iter_init(mbox->uidlist);
 	while (maildir_uidlist_iter_next(iter, &uid, &uflags, &filename)) {
 		maildir_filename_get_flags(ctx->keywords_sync_ctx, filename,
@@@@ -586,6 +586,8 @@@@ int maildir_sync_index(struct maildir_index_sync_conte
 			offsetof(struct mail_index_header, first_recent_uid),
 			&first_recent_uid, sizeof(first_recent_uid), FALSE);
 	}
+	array_free(&ctx->keywords);
+	array_free(&ctx->idx_keywords);
 	return ret < 0 ? -1 : (full_rescan ? 0 : 1);
 }
 
@


1.3
log
@add two patches from upstream repo;

- maildir: Having a lot of keywords assert-crashed with "stack frame changed".
- master: When creating login processes, don't close any fds after dup2()s.

from Brad (maintainer).
@
text
@d1 1
a1 1
$OpenBSD$
@


1.2
log
@maintenance update to Dovecot 1.1.12 plus a couple of post-release
patches from the upstream repo - from Brad (maintainer).
@
text
@d1 23
a23 12
$OpenBSD: patch-src_lib-storage_index_maildir_maildir-sync-index_c,v 1.1 2009/02/08 14:54:21 sthen Exp $
--- src/lib-storage/index/maildir/maildir-sync-index.c.orig	Thu Feb  5 16:19:12 2009
+++ src/lib-storage/index/maildir/maildir-sync-index.c	Thu Feb  5 16:19:48 2009
@@@@ -336,7 +336,7 @@@@ maildir_sync_mail_keywords(struct maildir_index_sync_c
 	   ones. we can get these lists easily by removing common elements
 	   from old and new keywords. */
 	new_indexes = array_get_modifiable(&ctx->keywords, &new_count);
-	for (i = 0; i < old_count && j < new_count; ) {
+	for (i = j = 0; i < old_count && j < new_count; ) {
 		diff = (int)old_indexes[i] - (int)new_indexes[j];
 		if (diff == 0) {
 			array_delete(&ctx->keywords, j, 1);
@


1.1
log
@roll in fixes from upstream repo; from Brad.

- mail_index_lookup_first() didn't always find the result.
  This caused SELECT not to return UNSEEN number always.
- Maildir: Fix to earlier >26 keywords handling change.
- i_stream_read(): Added a few more asserts.
- istream-tee: Minor cleanups, assert and a potential fix.
@
text
@d1 1
a1 1
$OpenBSD$
@


1.1.2.1
log
@MFC:

- SECURITY update of dovecot-sieve (based on the Cyrus sieve library)
- bugfix update of dovecot

originally from brad@@, -stable diff partly from sthen@@, thanks!

ok brad@@ (MAINTAINER)
@
text
@d1 1
a1 1
$OpenBSD: patch-src_lib-storage_index_maildir_maildir-sync-index_c,v 1.1 2009/02/08 14:54:21 sthen Exp $
@


