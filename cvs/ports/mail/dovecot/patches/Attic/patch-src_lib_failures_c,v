head	1.4;
access;
symbols
	OPENBSD_4_4:1.1.0.2
	OPENBSD_4_4_BASE:1.1;
locks; strict;
comment	@# @;


1.4
date	2010.10.03.23.25.52;	author sthen;	state dead;
branches;
next	1.3;

1.3
date	2010.09.17.22.00.18;	author sthen;	state Exp;
branches;
next	1.2;

1.2
date	2008.08.20.02.07.04;	author brad;	state dead;
branches;
next	1.1;

1.1
date	2008.07.21.09.37.36;	author brad;	state Exp;
branches;
next	;


desc
@@


1.4
log
@update to 1.2.15, from Brad
@
text
@$OpenBSD: patch-src_lib_failures_c,v 1.3 2010/09/17 22:00:18 sthen Exp $
--- src/lib/failures.c.orig	Fri Sep 17 09:48:50 2010
+++ src/lib/failures.c	Fri Sep 17 09:50:37 2010
@@@@ -81,7 +81,6 @@@@ static int log_fd_write(int fd, const unsigned char *d
 	struct ioloop *ioloop;
 	struct io *io;
 	ssize_t ret;
-	unsigned int eintr_count = 0;
 
 	while ((ret = write(fd, data, len)) != (ssize_t)len) {
 		if (ret > 0) {
@@@@ -95,9 +94,9 @@@@ static int log_fd_write(int fd, const unsigned char *d
 			errno = ENOSPC;
 			return -1;
 		}
-		if (errno == EINTR && ++eintr_count < 3) {
+		if (errno == EINTR) {
 			/* we don't want to die because of this.
-			   try again a couple of times. */
+			   especially SIGCHLD signals can be coming rapidly. */
 			continue;
 		}
 		if (errno != EAGAIN)
@


1.3
log
@Dovecot fixes from upstream via Brad.

- maildir: If uidlist isn't read, don't mark its UIDs as being known when
saving.
- maildir: Avoid unnecessary uidlist recreation during mail delivery.
- Removed "die after 3 EINTR write() failures to log".
@
text
@d1 1
a1 1
$OpenBSD$
@


1.2
log
@Upgrade to Dovecot 1.1.2.

ok jakob@@
@
text
@d1 8
a8 26
$OpenBSD: patch-src_lib_failures_c,v 1.1 2008/07/21 09:37:36 brad Exp $
--- src/lib/failures.c.orig	Tue Dec 11 13:52:08 2007
+++ src/lib/failures.c	Mon Jul 21 02:03:52 2008
@@@@ -376,9 +376,15 @@@@ void i_set_failure_file(const char *path, const char *
 
 static int internal_handler(char log_type, const char *format, va_list args)
 {
+	static int recursed = 0;
 	string_t *str;
 	int ret;
 
+	if (recursed != 0)
+		return -1;
+
+	recursed++;
+
 	t_push();
 	str = t_str_new(512);
 	str_append_c(str, 1);
@@@@ -388,6 +394,7 @@@@ static int internal_handler(char log_type, const char 
 	ret = write_full(2, str_data(str), str_len(str));
 	t_pop();
 
+	recursed--;
 	return ret;
 }
d10 14
@


1.1
log
@Three fixes for Dovecot 1.0..

- Maildir: Group of the created shared directory wasn't set.
- Logging: Make sure we don't recurse infinitely when running out of memory.
- rfc822_parse_phrase(): Don't read outside data boundaries if input is empty.

From the Dovecot Mercurial repo.

ok sthen@@
@
text
@d1 1
a1 1
$OpenBSD$
@

