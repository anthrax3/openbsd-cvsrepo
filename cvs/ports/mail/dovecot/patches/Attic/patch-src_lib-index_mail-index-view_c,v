head	1.2;
access;
symbols
	OPENBSD_4_5:1.1.0.2
	OPENBSD_4_5_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2009.03.17.09.09.10;	author sthen;	state dead;
branches;
next	1.1;

1.1
date	2009.02.08.14.54.21;	author sthen;	state Exp;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2009.09.23.03.37.03;	author william;	state dead;
branches;
next	;


desc
@@


1.2
log
@maintenance update to Dovecot 1.1.12 plus a couple of post-release
patches from the upstream repo - from Brad (maintainer).
@
text
@$OpenBSD: patch-src_lib-index_mail-index-view_c,v 1.1 2009/02/08 14:54:21 sthen Exp $
--- src/lib-index/mail-index-view.c.orig	Thu Jan 15 15:09:54 2009
+++ src/lib-index/mail-index-view.c	Sat Feb  7 12:44:21 2009
@@@@ -304,26 +304,27 @@@@ static void view_lookup_first(struct mail_index_view *
 {
 #define LOW_UPDATE(x) \
 	STMT_START { if ((x) > low_uid) low_uid = x; } STMT_END
+	const struct mail_index_header *hdr = &view->map->hdr;
 	const struct mail_index_record *rec;
-	uint32_t seq, low_uid = 1;
+	uint32_t seq, seq2, low_uid = 1;
 
 	*seq_r = 0;
 
 	if ((flags_mask & MAIL_SEEN) != 0 && (flags & MAIL_SEEN) == 0)
-		LOW_UPDATE(view->map->hdr.first_unseen_uid_lowwater);
+		LOW_UPDATE(hdr->first_unseen_uid_lowwater);
 	if ((flags_mask & MAIL_DELETED) != 0 && (flags & MAIL_DELETED) != 0)
-		LOW_UPDATE(view->map->hdr.first_deleted_uid_lowwater);
+		LOW_UPDATE(hdr->first_deleted_uid_lowwater);
 
 	if (low_uid == 1)
 		seq = 1;
 	else {
-		if (!mail_index_lookup_seq(view, low_uid, &seq))
+		if (!mail_index_lookup_seq_range(view, low_uid, hdr->next_uid,
+						 &seq, &seq2))
 			return;
 	}
 
-	i_assert(view->map->hdr.messages_count <=
-		 view->map->rec_map->records_count);
-	for (; seq <= view->map->hdr.messages_count; seq++) {
+	i_assert(hdr->messages_count <= view->map->rec_map->records_count);
+	for (; seq <= hdr->messages_count; seq++) {
 		rec = MAIL_INDEX_MAP_IDX(view->map, seq-1);
 		if ((rec->flags & flags_mask) == (uint8_t)flags) {
 			*seq_r = seq;
@


1.1
log
@roll in fixes from upstream repo; from Brad.

- mail_index_lookup_first() didn't always find the result.
  This caused SELECT not to return UNSEEN number always.
- Maildir: Fix to earlier >26 keywords handling change.
- i_stream_read(): Added a few more asserts.
- istream-tee: Minor cleanups, assert and a potential fix.
@
text
@d1 1
a1 1
$OpenBSD$
@


1.1.2.1
log
@MFC:

- SECURITY update of dovecot-sieve (based on the Cyrus sieve library)
- bugfix update of dovecot

originally from brad@@, -stable diff partly from sthen@@, thanks!

ok brad@@ (MAINTAINER)
@
text
@d1 1
a1 1
$OpenBSD: patch-src_lib-index_mail-index-view_c,v 1.1 2009/02/08 14:54:21 sthen Exp $
@


