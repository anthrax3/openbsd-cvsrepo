head	1.4;
access;
symbols
	OPENBSD_4_7:1.3.0.6
	OPENBSD_4_7_BASE:1.3
	OPENBSD_4_5:1.3.0.4
	OPENBSD_4_6:1.3.0.2
	OPENBSD_4_6_BASE:1.3;
locks; strict;
comment	@# @;


1.4
date	2010.03.23.21.32.07;	author pea;	state dead;
branches;
next	1.3;

1.3
date	2009.05.04.11.40.41;	author sthen;	state Exp;
branches
	1.3.4.1;
next	1.2;

1.2
date	2008.06.03.00.16.51;	author sthen;	state dead;
branches;
next	1.1;

1.1
date	2008.05.22.07.55.08;	author sthen;	state Exp;
branches;
next	;

1.3.4.1
date	2009.09.23.03.37.03;	author william;	state Exp;
branches;
next	;


desc
@@


1.4
log
@MAJOR update to Dovecot 1.2.11
The old cmusieve is removed in favor of the new sieve implementation.
Be very careful when upgrading.
Small howto here: http://openbsd.raveland.org/ports/dovecot/UPGRADE_HOWTO

With tweaks from brad (maintainer) and sthen@@: thanks
Lot of tests from Robert (robert at openbsd.pap.st), thanks !


ok brad (maintainer), sthen@@
@
text
@$OpenBSD: patch-src_lib_randgen_c,v 1.3 2009/05/04 11:40:41 sthen Exp $
--- src/lib/randgen.c.orig	Sun May  3 21:25:41 2009
+++ src/lib/randgen.c	Sun May  3 21:27:14 2009
@@@@ -7,7 +7,11 @@@@
 
 #ifdef HAVE_DEV_URANDOM
 
+#ifdef __OpenBSD__
+#define URANDOM_PATH "/dev/arandom"
+#else
 #define URANDOM_PATH "/dev/urandom"
+#endif
 
 #include "fd-close-on-exec.h"
 #include <unistd.h>
@


1.3
log
@use /dev/arandom; from Brad.
@
text
@d1 1
a1 1
$OpenBSD$
@


1.3.4.1
log
@MFC:

- SECURITY update of dovecot-sieve (based on the Cyrus sieve library)
- bugfix update of dovecot

originally from brad@@, -stable diff partly from sthen@@, thanks!

ok brad@@ (MAINTAINER)
@
text
@d1 1
a1 1
$OpenBSD: patch-src_lib_randgen_c,v 1.3 2009/05/04 11:40:41 sthen Exp $
@


1.2
log
@Maintenance update, recent patches are now rolled into the
distfile from upstream.  From Brad.
@
text
@d1 4
a4 4
$OpenBSD: patch-src_lib_randgen_c,v 1.1 2008/05/22 07:55:08 sthen Exp $
--- src/lib/randgen.c.orig	Sun May 18 22:32:41 2008
+++ src/lib/randgen.c	Sun May 18 22:35:41 2008
@@@@ -7,6 +7,8 @@@@
d8 6
a13 2
+#define URANDOM_PATH "/dev/urandom"
+
a15 38
 #include <fcntl.h>
@@@@ -22,10 +24,16 @@@@ void random_fill(void *buf, size_t size)
 	i_assert(init_refcount > 0);
 	i_assert(size < SSIZE_T_MAX);
 
-	for (pos = 0; pos < size; pos += ret) {
+	for (pos = 0; pos < size; ) {
 		ret = read(urandom_fd, (char *) buf + pos, size - pos);
-		if (ret < 0 && errno != EINTR)
-			i_fatal("Error reading from /dev/urandom: %m");
+		if (ret <= 0) {
+			if (ret == 0)
+				i_fatal("EOF when reading from "URANDOM_PATH);
+			else if (errno != EINTR)
+				i_fatal("read("URANDOM_PATH") failed: %m");
+		} else {
+			pos += ret;
+		}
 	}
 }
 
@@@@ -36,13 +44,13 @@@@ void random_init(void)
 	if (init_refcount++ > 0)
 		return;
 
-	urandom_fd = open("/dev/urandom", O_RDONLY);
+	urandom_fd = open(URANDOM_PATH, O_RDONLY);
 	if (urandom_fd == -1) {
 		if (errno == ENOENT) {
-			i_fatal("/dev/urandom doesn't exist, "
+			i_fatal(URANDOM_PATH" doesn't exist, "
 				"currently we require it");
 		} else {
-			i_fatal("Can't open /dev/urandom: %m");
+			i_fatal("Can't open "URANDOM_PATH": %m");
 		}
 	}
 
@


1.1
log
@Add some bug-fix patches; at this point in the Dovecot release cycle
most work is on 1.1, so it makes sense to add them locally for now.

- If SSL function fails and there are no errors, return "Unknown error"
instead of "Success" as the reason.
- Fixed a memory leak in ACL plugin.
- Send the success reply in one write.
- If remote disconnects, log "Connection closed: reason" just like IMAP does.
- STORE: Ignore flag changes for read-only (especially EXAMINEd) mailboxes.
- random_fill(): If read(/dev/urandom) returned EINTR, it could have written
random data before the given buffer.
- BODY/BODYSTRUCTURE fetch: Don't crash if we already had message parts
parsed.

From Brad, tested on various arch production servers.
@
text
@d1 1
a1 1
$OpenBSD$
@

