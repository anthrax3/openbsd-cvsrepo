head	1.6;
access;
symbols
	OPENBSD_3_8:1.3.0.4
	OPENBSD_3_8_BASE:1.3
	OPENBSD_3_7:1.3.0.2
	OPENBSD_3_7_BASE:1.3
	OPENBSD_3_6:1.2.0.2
	OPENBSD_3_6_BASE:1.2
	OPENBSD_3_5:1.1.0.4
	OPENBSD_3_5_BASE:1.1
	OPENBSD_3_4:1.1.0.2
	OPENBSD_3_4_BASE:1.1;
locks; strict;
comment	@# @;


1.6
date	2008.06.03.00.16.51;	author sthen;	state dead;
branches;
next	1.5;

1.5
date	2008.05.22.07.55.08;	author sthen;	state Exp;
branches;
next	1.4;

1.4
date	2005.09.04.18.22.30;	author brad;	state dead;
branches;
next	1.3;

1.3
date	2005.02.12.12.17.07;	author brad;	state Exp;
branches;
next	1.2;

1.2
date	2004.05.27.16.38.30;	author brad;	state Exp;
branches;
next	1.1;

1.1
date	2003.07.23.06.03.01;	author jolan;	state Exp;
branches
	1.1.2.1
	1.1.4.1;
next	;

1.1.2.1
date	2004.05.28.21.23.22;	author brad;	state Exp;
branches;
next	;

1.1.4.1
date	2004.05.28.20.46.46;	author brad;	state Exp;
branches;
next	;


desc
@@


1.6
log
@Maintenance update, recent patches are now rolled into the
distfile from upstream.  From Brad.
@
text
@$OpenBSD: patch-src_pop3_client_c,v 1.5 2008/05/22 07:55:08 sthen Exp $
--- src/pop3/client.c.orig	Sun May 18 22:37:55 2008
+++ src/pop3/client.c	Sun May 18 22:38:38 2008
@@@@ -231,11 +231,20 @@@@ static const char *client_stats(struct client *client)
 	return str_c(str);
 }
 
+static const char *client_get_disconnect_reason(struct client *client)
+{
+	errno = client->input->stream_errno != 0 ?
+		client->input->stream_errno :
+		client->output->stream_errno;
+	return errno == 0 || errno == EPIPE ? "Connection closed" :
+		t_strdup_printf("Connection closed: %m");
+}
+
 void client_destroy(struct client *client, const char *reason)
 {
 	if (!client->disconnected) {
 		if (reason == NULL)
-			reason = "Disconnected";
+			reason = client_get_disconnect_reason(client);
 		i_info("%s %s", reason, client_stats(client));
 	}
 
@


1.5
log
@Add some bug-fix patches; at this point in the Dovecot release cycle
most work is on 1.1, so it makes sense to add them locally for now.

- If SSL function fails and there are no errors, return "Unknown error"
instead of "Success" as the reason.
- Fixed a memory leak in ACL plugin.
- Send the success reply in one write.
- If remote disconnects, log "Connection closed: reason" just like IMAP does.
- STORE: Ignore flag changes for read-only (especially EXAMINEd) mailboxes.
- random_fill(): If read(/dev/urandom) returned EINTR, it could have written
random data before the given buffer.
- BODY/BODYSTRUCTURE fetch: Don't crash if we already had message parts
parsed.

From Brad, tested on various arch production servers.
@
text
@d1 1
a1 1
$OpenBSD$
@


1.4
log
@upgrade to Dovecot 1.0alpha1
@
text
@d1 17
a17 5
$OpenBSD: patch-src_pop3_client_c,v 1.3 2005/02/12 12:17:07 brad Exp $
--- src/pop3/client.c.orig	Wed Sep  1 10:28:02 2004
+++ src/pop3/client.c	Fri Oct  1 02:40:01 2004
@@@@ -108,6 +108,7 @@@@ static int init_mailbox(struct client *c
 struct client *client_create(int hin, int hout, struct mail_storage *storage)
d19 6
a24 8
 	struct client *client;
+	enum mailbox_open_flags flags;
 
 	client = i_new(struct client, 1);
 	client->input = i_stream_create_file(hin, default_pool,
@@@@ -124,7 +125,9 @@@@ struct client *client_create(int hin, in
 
 	storage->set_callbacks(storage, &mail_storage_callbacks, client);
a25 7
-	client->mailbox = storage->open_mailbox(storage, "INBOX", FALSE, FALSE);
+	flags = getenv("MMAP_INVALIDATE") != NULL ?
+		MAILBOX_OPEN_MMAP_INVALIDATE : 0;
+	client->mailbox = storage->open_mailbox(storage, "INBOX", flags);
 	if (client->mailbox == NULL) {
 		i_error("Couldn't open INBOX: %s",
 			storage->get_last_error(storage, NULL));
@


1.3
log
@upgrade to Dovecot 0.99.14
@
text
@d1 1
a1 1
$OpenBSD: patch-src_pop3_client_c,v 1.2 2004/05/27 16:38:30 brad Exp $
@


1.2
log
@upgrade to Dovecot 0.99.10.5
--
ok MAINTAINER
@
text
@d1 3
a3 3
$OpenBSD: patch-src_pop3_client_c,v 1.1 2003/07/23 06:03:01 jolan Exp $
--- src/pop3/client.c.orig	2004-05-25 14:26:20.000000000 -0400
+++ src/pop3/client.c	2004-05-27 01:24:18.000000000 -0400
d21 2
a22 2
 		client_send_line(client, "-ERR No INBOX for user.");
 		return NULL;
@


1.1
log
@incorporate megadiff from the author which allows mmaping of index data
on openbsd, related to pr/3291.  bump PKGNAME
@
text
@d1 4
a4 4
$OpenBSD$
--- src/pop3/client.c.orig	Mon May 26 10:27:13 2003
+++ src/pop3/client.c	Tue Jul 15 15:18:28 2003
@@@@ -106,6 +106,7 @@@@ static int init_mailbox(struct client *c
d12 1
a12 1
@@@@ -122,7 +123,9 @@@@ struct client *client_create(int hin, in
@


1.1.2.1
log
@MFC:
upgrade to Dovecot 0.99.10.5

Dovecot 0.99.10.{4,5} fix some possible mail box corruption issues.
@
text
@d1 4
a4 4
$OpenBSD: patch-src_pop3_client_c,v 1.2 2004/05/27 16:38:30 brad Exp $
--- src/pop3/client.c.orig	2004-05-25 14:26:20.000000000 -0400
+++ src/pop3/client.c	2004-05-27 01:24:18.000000000 -0400
@@@@ -108,6 +108,7 @@@@ static int init_mailbox(struct client *c
d12 1
a12 1
@@@@ -124,7 +125,9 @@@@ struct client *client_create(int hin, in
@


1.1.4.1
log
@MFC:
upgrade to Dovecot 0.99.10.5

Dovecot 0.99.10.{4,5} fix some possible mail box corruption issues.
@
text
@d1 4
a4 4
$OpenBSD: patch-src_pop3_client_c,v 1.2 2004/05/27 16:38:30 brad Exp $
--- src/pop3/client.c.orig	2004-05-25 14:26:20.000000000 -0400
+++ src/pop3/client.c	2004-05-27 01:24:18.000000000 -0400
@@@@ -108,6 +108,7 @@@@ static int init_mailbox(struct client *c
d12 1
a12 1
@@@@ -124,7 +125,9 @@@@ struct client *client_create(int hin, in
@


