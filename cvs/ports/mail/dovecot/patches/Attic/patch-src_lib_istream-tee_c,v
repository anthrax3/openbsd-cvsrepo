head	1.2;
access;
symbols
	OPENBSD_4_5:1.1.0.2
	OPENBSD_4_5_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2009.03.17.09.09.10;	author sthen;	state dead;
branches;
next	1.1;

1.1
date	2009.02.08.14.54.21;	author sthen;	state Exp;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2009.09.23.03.37.03;	author william;	state dead;
branches;
next	;


desc
@@


1.2
log
@maintenance update to Dovecot 1.1.12 plus a couple of post-release
patches from the upstream repo - from Brad (maintainer).
@
text
@$OpenBSD: patch-src_lib_istream-tee_c,v 1.1 2009/02/08 14:54:21 sthen Exp $
--- src/lib/istream-tee.c.orig	Thu Feb  5 16:21:43 2009
+++ src/lib/istream-tee.c	Thu Feb  5 16:24:20 2009
@@@@ -112,12 +112,20 @@@@ static ssize_t i_stream_tee_read(struct istream_privat
 	uoff_t last_high_offset;
 	ssize_t ret;
 
+	if (stream->buffer == NULL) {
+		/* initial read */
+		tee_streams_update_buffer(tstream->tee);
+	}
 	data = i_stream_get_data(input, &size);
 
+	/* last_high_offset contains how far we have read this child tee stream
+	   so far. input->v_offset + size contains how much is available in
+	   the parent stream without having to read more. */
 	last_high_offset = stream->istream.v_offset +
-		(tstream->istream.pos - tstream->istream.skip);
+		(stream->pos - stream->skip);
 	i_assert(last_high_offset <= input->v_offset + size);
 	if (last_high_offset == input->v_offset + size) {
+		/* we've read everything, need to read more */
 		tee_streams_skip(tstream->tee);
 		ret = i_stream_read(input);
 		if (ret <= 0) {
@@@@ -133,9 +141,9 @@@@ static ssize_t i_stream_tee_read(struct istream_privat
 		}
 		tee_streams_update_buffer(tstream->tee);
 		data = i_stream_get_data(input, &size);
-	} else if (stream->buffer == NULL) {
-		tee_streams_update_buffer(tstream->tee);
 	} else {
+		/* there's still some data available from parent */
+		i_assert(stream->pos < size);
 		stream->buffer = data;
 	}
 
@


1.1
log
@roll in fixes from upstream repo; from Brad.

- mail_index_lookup_first() didn't always find the result.
  This caused SELECT not to return UNSEEN number always.
- Maildir: Fix to earlier >26 keywords handling change.
- i_stream_read(): Added a few more asserts.
- istream-tee: Minor cleanups, assert and a potential fix.
@
text
@d1 1
a1 1
$OpenBSD$
@


1.1.2.1
log
@MFC:

- SECURITY update of dovecot-sieve (based on the Cyrus sieve library)
- bugfix update of dovecot

originally from brad@@, -stable diff partly from sthen@@, thanks!

ok brad@@ (MAINTAINER)
@
text
@d1 1
a1 1
$OpenBSD: patch-src_lib_istream-tee_c,v 1.1 2009/02/08 14:54:21 sthen Exp $
@


