head	1.2;
access;
symbols;
locks; strict;
comment	@# @;


1.2
date	2010.07.24.09.51.12;	author sthen;	state dead;
branches;
next	1.1;

1.1
date	2010.06.27.09.46.18;	author sthen;	state Exp;
branches;
next	;


desc
@@


1.2
log
@update to 1.2.13, from Brad
@
text
@$OpenBSD: patch-src_lib-storage_index_index-mail-headers_c,v 1.1 2010/06/27 09:46:18 sthen Exp $
--- src/lib-storage/index/index-mail-headers.c.orig	Sun Jan 24 18:14:17 2010
+++ src/lib-storage/index/index-mail-headers.c	Sat Jun 26 22:34:15 2010
@@@@ -722,13 +722,14 @@@@ index_mail_headers_decode(struct index_mail *mail, con
 	for (i = 0; i < count; i++) {
 		str_truncate(str, 0);
 		input = list[i];
-		if (message_header_decode_utf8((const unsigned char *)input,
-					       strlen(list[i]), str, FALSE))
-			input = str_c(str);
+		/* unfold all lines into a single line */
 		if (unfold_header(mail->data_pool, &input) < 0)
 			return -1;
-		if (input == str->data)
-			input = p_strdup(mail->data_pool, input);
+
+		/* decode MIME encoded-words. decoding may also add new LFs. */
+		if (message_header_decode_utf8((const unsigned char *)input,
+					       strlen(list[i]), str, FALSE))
+			input = p_strdup(mail->data_pool, str_c(str));
 		decoded_list[i] = input;
 	}
 	*_list = decoded_list;
@


1.1
log
@2 fixes from upstream via Brad

- lib-charset: Don't assert-crash when iconv() skips lots of invalid input.
- lib-storage: When getting decoded headers, don't fail when MIME encoded-words
expand to LFs.
@
text
@d1 1
a1 1
$OpenBSD$
@

