head	1.3;
access;
symbols
	OPENBSD_5_5:1.2.0.6
	OPENBSD_5_5_BASE:1.2
	OPENBSD_5_4:1.2.0.4
	OPENBSD_5_4_BASE:1.2
	OPENBSD_5_3:1.2.0.2
	OPENBSD_5_3_BASE:1.2
	OPENBSD_5_2:1.1.0.10
	OPENBSD_5_2_BASE:1.1
	OPENBSD_5_1_BASE:1.1
	OPENBSD_5_1:1.1.0.8
	OPENBSD_5_0:1.1.0.6
	OPENBSD_5_0_BASE:1.1
	OPENBSD_4_9:1.1.0.4
	OPENBSD_4_9_BASE:1.1
	OPENBSD_4_8:1.1.0.2
	OPENBSD_4_8_BASE:1.1;
locks; strict;
comment	@# @;


1.3
date	2014.06.05.21.04.51;	author giovanni;	state dead;
branches;
next	1.2;
commitid	xjDUpxYFqHop8Shi;

1.2
date	2012.09.04.11.33.35;	author gonzalo;	state Exp;
branches;
next	1.1;

1.1
date	2010.07.08.20.32.01;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.3
log
@
Update to 2.7.1, bugs fixed and utf-8 improvements
Add a no_trashquota flavor to keep it in sync with mail/courier-imap
Take maintainership
@
text
@$OpenBSD: patch-maildrop_deliver_C,v 1.2 2012/09/04 11:33:35 gonzalo Exp $

maildrop adds a newline to mbox files before delivering new messages.
This effectively alters the final message in the mbox, causing a
running mutt (and maybe other MUAs) with that mbox open to freak out
and lose unsaved state [1]. The maildrop folks prefer to keep this
(out of spec) behaviour to keep from breaking users working
configurations as well as to avoid problems caused by other out of
spec mail delivery agents (which may aberrantly neglect to leave a
blank line at the end of the mbox) [2].

This patch disables this behaviour of maildrop allowing an MUA to
gracefully handle the delivery of new mail to an open folder.

[1] http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=132411
[2] http://markmail.org/message/w5mwn3jpmn3qeo5x

--- maildrop/deliver.C.orig	Mon Apr  4 12:58:58 2011
+++ maildrop/deliver.C	Mon Sep  3 14:44:36 2012
@@@@ -230,15 +230,7 @@@@ Buffer	b;
 		{
 			format_mbox.Init(1);
 
-			if ((stat_buf.st_size > 0 &&
-			     mio.write(
-#if	CRLF_TERM
-				       "\r\n", 2
-#else
-				       "\n", 1
-#endif
-				       ) < 0) ||
-			    format_mbox.DeliverTo(mio))
+			if (format_mbox.DeliverTo(mio))
 			{
 				dotlock.truncate();
 				log(mailbox, -1, format_mbox);
@


1.2
log
@Update for Maildrop to 2.5.5:

* rfc2045/rfc2045reply.c (mkreply): Fix copying of the contents
  of the original message.
* rfc2045/reformime.c (do_print_info): rfc2231_udecodeDisposition()
  failure is not fatal.
* rfc2045/reformime.c (get_suitable_filename): Ditto.
* rfc2045/reformime.c (main2): Fixed segfault on some arches
  from an initial null given to strtok.
* mailbot: add "feedback" and "replyfeedback" formats,
  generating RFC 5965-formatted feedback report. -a option attaches the
  entire original message, instead of only its headers, for "replydsn",
  "feedback", and "replyfeedback" formats.

Ok giovanni@@
@
text
@d1 1
a1 1
$OpenBSD: patch-maildrop_deliver_C,v 1.1 2010/07/08 20:32:01 jasper Exp $
@


1.1
log
@- prevent maildrop from appending a newline to mbox files before delivering
new messages. which would alter the final message in the mbox; which mutt,
among others wasn't fond of.

from debian via nima hoda.
@
text
@d1 1
a1 1
$OpenBSD$
d18 3
a20 3
--- maildrop/deliver.C.orig	Sat Jun 27 13:26:54 2009
+++ maildrop/deliver.C	Wed Jun 23 15:45:28 2010
@@@@ -231,15 +231,7 @@@@ Buffer	b;
@

