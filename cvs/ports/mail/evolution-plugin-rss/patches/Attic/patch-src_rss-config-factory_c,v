head	1.8;
access;
symbols
	OPENBSD_4_6:1.1.0.4
	OPENBSD_4_6_BASE:1.1
	OPENBSD_4_5:1.1.0.2
	OPENBSD_4_5_BASE:1.1;
locks; strict;
comment	@# @;


1.8
date	2011.07.14.05.34.54;	author ajacoutot;	state dead;
branches;
next	1.7;

1.7
date	2011.04.22.15.57.19;	author ajacoutot;	state Exp;
branches;
next	1.6;

1.6
date	2011.04.22.14.13.56;	author ajacoutot;	state dead;
branches;
next	1.5;

1.5
date	2011.03.07.19.40.44;	author ajacoutot;	state Exp;
branches;
next	1.4;

1.4
date	2010.10.01.13.42.57;	author ajacoutot;	state dead;
branches;
next	1.3;

1.3
date	2010.09.30.16.13.32;	author ajacoutot;	state Exp;
branches;
next	1.2;

1.2
date	2009.09.14.15.39.05;	author jasper;	state dead;
branches;
next	1.1;

1.1
date	2009.02.13.09.47.58;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.8
log
@Rename evolution-plugin-rss -> evolution-rss.
@
text
@$OpenBSD: patch-src_rss-config-factory_c,v 1.7 2011/04/22 15:57:19 ajacoutot Exp $

Revert:
From 7d264518c2c6741e81842e7c4e6ba62f9f9a240b Mon Sep 17 00:00:00 2001
From: Lucian Langa <lucilanga@@gnome.org>
Date: Fri, 28 Jan 2011 16:57:36 +0000
Subject: allow to select feed location from properties menu

--- src/rss-config-factory.c.orig	Fri Apr 22 16:16:04 2011
+++ src/rss-config-factory.c	Fri Apr 22 17:13:07 2011
@@@@ -46,11 +46,7 @@@@
 #include <e-util/e-alert-dialog.h>
 #include <misc/e-preferences-window.h>
 #include <mail/e-mail-local.h>
-#include <mail/em-folder-selector.h>
-
-#include <mail/em-utils.h>
 #include <shell/e-shell.h>
-#include <shell/e-shell-view.h>
 #endif
 
 
@@@@ -60,14 +56,12 @@@@
 #endif
 
 extern int rss_verbose_debug;
-extern EShellView *rss_shell_view;
 
 #include "rss.h"
 #include "misc.h"
 #include "parser.h"
 #include "rss-config.h"
 #include "rss-config-factory.h"
-#include "rss-evo-common.h"
 #include "network-soup.h"
 #include "notification.h"
 
@@@@ -437,76 +431,6 @@@@ disable_widget_cb(GtkWidget *widget, GtkBuilder *data)
 	gtk_widget_set_sensitive(authpass, auth_enabled);
 }
 
-void
-folder_cb (GtkWidget *widget, gpointer data);
-
-void
-folder_cb (GtkWidget *widget, gpointer data)
-{
-	EMailBackend *backend;
-	EMailSession *session;
-	CamelFolderInfo *folderinfo;
-	GtkWidget *folder_tree;
-	GtkWidget *dialog;
-	GtkWindow *window;
-	const gchar *uri;
-	struct _copy_folder_data *cfd;
-
-	EMailReader *reader;
-	EShellContent *shell_content;
-
-	gchar *text = (gchar *)gtk_label_get_text(GTK_LABEL(data));
-
-	shell_content = e_shell_view_get_shell_content (rss_shell_view);
-	reader = E_MAIL_READER (shell_content);
-	backend = e_mail_reader_get_backend (reader);
-
-	session = e_mail_backend_get_session (backend);
-
-	window = e_mail_reader_get_window (reader);
-
-	folder_tree = em_folder_tree_new (session);
-	emu_restore_folder_tree_state (EM_FOLDER_TREE (folder_tree));
-
-	em_folder_tree_set_excluded (
-		EM_FOLDER_TREE (folder_tree),
-		EMFT_EXCLUDE_NOSELECT | EMFT_EXCLUDE_VIRTUAL |
-		EMFT_EXCLUDE_VTRASH);
-
-	dialog = em_folder_selector_new (
-			window, EM_FOLDER_TREE (folder_tree),
-			EM_FOLDER_SELECTOR_CAN_CREATE,
-			_("Move to Folder"), NULL, _("M_ove"));
-
-	if ((uri = lookup_uri_by_folder_name(text)))
-		em_folder_selector_set_selected (
-			EM_FOLDER_SELECTOR (dialog),
-			uri);
-
-	folderinfo = em_folder_tree_get_selected_folder_info ((EMFolderTree *)folder_tree);
-
-	cfd = g_malloc (sizeof (*cfd));
-	cfd->fi = folderinfo;
-	cfd->delete = 1;
-
-	if (gtk_dialog_run (GTK_DIALOG (dialog)) == GTK_RESPONSE_OK) {
-		gchar *tmp;
-		gchar *name = g_path_get_basename(text);
-		uri = em_folder_selector_get_selected_uri (
-			EM_FOLDER_SELECTOR (dialog));
-		rss_emfu_copy_folder_selected (backend, uri, cfd);
-		tmp = g_build_path(G_DIR_SEPARATOR_S,
-				em_utils_folder_name_from_uri(uri),
-				name, NULL);
-		g_free(name);
-		gtk_label_set_text(GTK_LABEL(data), tmp);
-		g_free(tmp);
-	}
-
-	gtk_widget_destroy (dialog);
-}
-
-
 add_feed *
 build_dialog_add(gchar *url, gchar *feed_text)
 {
@@@@ -618,9 +542,6 @@@@ build_dialog_add(gchar *url, gchar *feed_text)
 		location_button = GTK_WIDGET (gtk_builder_get_object(gui, "location_button"));
 
 		gtk_widget_show(location_button);
-		g_signal_connect (
-			GTK_BUTTON (location_button),
-			"clicked", G_CALLBACK (folder_cb), entry2);
 		location_label = GTK_WIDGET (
 			gtk_builder_get_object(gui,
 			"location_label"));
@@@@ -942,8 +863,7 @@@@ store_redraw(GtkTreeView *data)
 {
 	GtkTreeModel *model;
 
-	if (!data)
-		return FALSE;
+	g_return_val_if_fail(data, FALSE);
 
 	if (!store_redrawing) {
 		store_redrawing = 1;
@@@@ -1297,10 +1217,8 @@@@ delete_feed_folder_alloc(gchar *old_name)
 	feed_file = g_strdup_printf("%s/feed_folders", feed_dir);
 	g_free(feed_dir);
 	f = fopen(feed_file, "wb");
-	if (!f) {
-		g_free(feed_file);
+	if (!f)
 		return;
-	}
 
 	orig_name = g_hash_table_lookup(
 			rf->feed_folders,
@


1.7
log
@Update to the most recent git release.
* fixes _lots_ of bugs
@
text
@d1 1
a1 1
$OpenBSD$
@


1.6
log
@Update to evolution-plugin-rss-0.2.90 (git made tarball, with some local
patches). This unbreaks runtime now.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_rss-config-factory_c,v 1.5 2011/03/07 19:40:44 ajacoutot Exp $
d3 5
a7 1
GtkFunction -> GSourceFunc: fix build with newer glib2/gtk+2
d9 31
a39 19
--- src/rss-config-factory.c.orig	Wed Feb  2 08:16:25 2011
+++ src/rss-config-factory.c	Wed Feb  2 08:16:32 2011
@@@@ -271,7 +271,7 @@@@ rep_check_cb (GtkWidget *widget, gpointer data)
 			g_source_remove(rf->rc_id);
 		rf->rc_id = g_timeout_add (
 				60 * 1000 * gtk_spin_button_get_value((GtkSpinButton *)data),
-				(GtkFunction) update_articles,
+				(GSourceFunc) update_articles,
 				(gpointer)1);
 		}
 }
@@@@ -290,7 +290,7 @@@@ rep_check_timeout_cb (GtkWidget *widget, gpointer data
 			g_source_remove(rf->rc_id);
 		rf->rc_id = g_timeout_add (
 			60 * 1000 * gtk_spin_button_get_value((GtkSpinButton *)widget),
-			(GtkFunction) update_articles,
+			(GSourceFunc) update_articles,
 			(gpointer)1);
 	}
d41 106
@


1.5
log
@GtkFunction -> GSourceFunc: fix build with newer glib2/gtk+2.
Bring a patche from upstream to fix a crasher.
@
text
@d1 1
a1 1
$OpenBSD$
@


1.4
log
@Merge and tweak lots of changes from upstream via an external patch file.
The plugin now works much better.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_rss-config-factory_c,v 1.3 2010/09/30 16:13:32 ajacoutot Exp $
d3 1
a3 4
From 37ebcebeae4e85024ef6689266a611841b58da2e Mon Sep 17 00:00:00 2001
From: Lucian Langa <lucilanga@@gnome.org>
Date: Fri, 09 Jul 2010 14:38:06 +0000
Subject: adapt to GError camel modifications
d5 10
a14 32
--- src/rss-config-factory.c.orig	Tue Jul 20 22:32:03 2010
+++ src/rss-config-factory.c	Thu Sep 30 17:20:07 2010
@@@@ -976,7 +976,7 @@@@ destroy_delete(GtkWidget *selector, gpointer user_data
 //this function resembles emfu_delete_rec in mail/em-folder-utils.c
 //which is not exported ?
 static void
-rss_delete_rec (CamelStore *store, CamelFolderInfo *fi, CamelException *ex)
+rss_delete_rec (CamelStore *store, CamelFolderInfo *fi, GError **error)
 {
 	int i;
 	GPtrArray *uids;
@@@@ -986,7 +986,7 @@@@ rss_delete_rec (CamelStore *store, CamelFolderInfo *fi
 
 		d("deleting folder '%s'\n", fi->full_name);
 
-		if (!(folder = camel_store_get_folder (store, fi->full_name, 0, ex)))
+		if (!(folder = camel_store_get_folder (store, fi->full_name, 0, error)))
 			return;
 
 			uids = camel_folder_get_uids (folder);
@@@@ -1004,8 +1004,8 @@@@ rss_delete_rec (CamelStore *store, CamelFolderInfo *fi
 
 		d("do camel_store_delete_folder()\n");
 
-		camel_store_delete_folder (store, fi->full_name, ex);
-		if (camel_exception_is_set (ex))
+		camel_store_delete_folder (store, fi->full_name, error);
+		if (error != NULL)
 			return;
 
 		fi = fi->next;
@@@@ -1013,8 +1013,9 @@@@ rss_delete_rec (CamelStore *store, CamelFolderInfo *fi
d16 8
a23 24
 
 void
-rss_delete_folders (
-	CamelStore *store, const char *full_name, CamelException *ex)
+rss_delete_folders (CamelStore *store,
+		const char *full_name,
+		GError **error)
 {
 	guint32 flags = CAMEL_STORE_FOLDER_INFO_RECURSIVE
 		| CAMEL_STORE_FOLDER_INFO_FAST
@@@@ -1025,12 +1026,12 @@@@ rss_delete_folders (
 	fi = camel_store_get_folder_info (
 		store,
 		full_name,
-		flags, ex);
-	if (!fi || camel_exception_is_set (ex))
+		flags, error);
+	if (!fi || error != NULL)
 		return;
 
 	d("call rss_delete_rec()\n");
-	rss_delete_rec (store, fi, ex);
+	rss_delete_rec (store, fi, error);
 	camel_store_free_folder_info (store, fi);
a24 36
 
@@@@ -1407,7 +1408,7 @@@@ process_dialog_edit(add_feed *feed, gchar *url, gchar 
 	gpointer key = lookup_key(feed_name);
 	gchar *prefix = NULL;
 	hrfeed *saved_feed;
-	CamelException ex;
+	GError *error = NULL;
 	CamelStore *store = rss_component_peek_local_store();
 	GtkWidget *msg_feeds, *progress;
 
@@@@ -1516,21 +1517,13 @@@@ process_dialog_edit(add_feed *feed, gchar *url, gchar 
 				gchar *b = g_build_path(
 						G_DIR_SEPARATOR_S,
 						dir, feed->feed_name, NULL);
-				camel_exception_init (&ex);
-				camel_store_rename_folder (store, a, b, &ex);
-				if (camel_exception_is_set (&ex)) {
-#if EVOLUTION_VERSION < 22904
-					e_error_run(GTK_WINDOW(
-						rf->preferences),
-						"mail:no-rename-folder",
-						a, b, ex.desc, NULL);
-#else
+				camel_store_rename_folder (store, a, b, &error);
+				if (error != NULL) {
 					e_alert_run_dialog_for_args(
 						GTK_WINDOW(rf->preferences),
 						"mail:no-rename-folder",
-						a, b, ex.desc, NULL);
-#endif
-					camel_exception_clear (&ex);
+						a, b, error->message, NULL);
+					g_clear_error(&error);
 				}
 				g_free(dir);
 				g_free(b);
@


1.3
log
@Update to evolution-plugin-rss-0.2.0.
@
text
@d1 1
a1 1
$OpenBSD$
@


1.2
log
@- update evolution-plugin-rss to 0.1.4
* lots of bugfixes and new features

ok ajacoutot@@
@
text
@d1 1
a1 1
$OpenBSD: patch-src_rss-config-factory_c,v 1.1 2009/02/13 09:47:58 jasper Exp $
d3 4
a6 3
First chunk:
Fix seg. fault when adding new feeds (bz #568857).
From upstream svn -r413.
d8 94
a101 33
Second/third chunk:
Fix seg. fault with "realloc(): error: modified chunk-pointer" (bz #562249)
From upstream svn -r444.

--- src/rss-config-factory.c.orig	Fri Feb 13 08:55:44 2009
+++ src/rss-config-factory.c	Fri Feb 13 09:01:14 2009
@@@@ -279,7 +279,7 @@@@ create_dialog_add(gchar *text, gchar *feed_text)
         char *gladefile;
   	add_feed *feed = g_new0(add_feed, 1);
 	GladeXML  *gui;
-	gchar *flabel;
+	gchar *flabel = NULL;
   	gboolean fhtml = FALSE;
   	gboolean enabled = TRUE;
   	gboolean del_unread = FALSE;
@@@@ -521,7 +521,7 @@@@ feeds_dialog_add(GtkDialog *d, gpointer data)
         add_feed *feed = create_dialog_add(NULL, NULL);
 	if (feed->dialog)
                 gtk_widget_destroy(feed->dialog);
-        GtkWidget *msg_feeds = e_error_new(NULL, "org-gnome-evolution-rss:rssmsg", NULL);
+        GtkWidget *msg_feeds = e_error_new(NULL, "org-gnome-evolution-rss:rssmsg", "", NULL);
 	GtkWidget *progress = gtk_progress_bar_new();
         gtk_box_pack_start(GTK_BOX(((GtkDialog *)msg_feeds)->vbox), progress, FALSE, FALSE, 0);
         gtk_progress_bar_set_fraction((GtkProgressBar *)progress, 0);
@@@@ -873,7 +873,7 @@@@ feeds_dialog_edit(GtkDialog *d, gpointer data)
                         add_feed *feed = create_dialog_add(name, feed_name);
                     	if (feed->dialog)
                                 gtk_widget_destroy(feed->dialog);
-        		GtkWidget *msg_feeds = e_error_new(NULL, "org-gnome-evolution-rss:rssmsg", NULL);
+        		GtkWidget *msg_feeds = e_error_new(NULL, "org-gnome-evolution-rss:rssmsg", "", NULL);
 	GtkWidget *progress = gtk_progress_bar_new();
         gtk_box_pack_start(GTK_BOX(((GtkDialog *)msg_feeds)->vbox), progress, FALSE, FALSE, 0);
         gtk_progress_bar_set_fraction((GtkProgressBar *)progress, 0);
@


1.1
log
@- fix two crashers when adding feeds, evolution-plugin-rss now works
as expected again. patch from upstream svn.
@
text
@d1 1
a1 1
$OpenBSD$
@

