head	1.6;
access;
symbols
	OPENBSD_6_1:1.6.0.10
	OPENBSD_6_1_BASE:1.6
	OPENBSD_6_0:1.6.0.8
	OPENBSD_6_0_BASE:1.6
	OPENBSD_5_9:1.6.0.4
	OPENBSD_5_9_BASE:1.6
	OPENBSD_5_8:1.6.0.6
	OPENBSD_5_8_BASE:1.6
	OPENBSD_5_7:1.6.0.2
	OPENBSD_5_7_BASE:1.6
	OPENBSD_5_6:1.5.0.4
	OPENBSD_5_6_BASE:1.5
	OPENBSD_5_5:1.5.0.2
	OPENBSD_5_5_BASE:1.5
	OPENBSD_5_4:1.4.0.10
	OPENBSD_5_4_BASE:1.4
	OPENBSD_5_3:1.4.0.8
	OPENBSD_5_3_BASE:1.4
	OPENBSD_5_2:1.4.0.6
	OPENBSD_5_2_BASE:1.4
	OPENBSD_5_1_BASE:1.4
	OPENBSD_5_1:1.4.0.4
	OPENBSD_5_0:1.4.0.2
	OPENBSD_5_0_BASE:1.4
	OPENBSD_4_9:1.3.0.10
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.3.0.8
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.3.0.6
	OPENBSD_4_7_BASE:1.3
	OPENBSD_4_6:1.3.0.4
	OPENBSD_4_6_BASE:1.3
	OPENBSD_4_5:1.3.0.2
	OPENBSD_4_5_BASE:1.3
	OPENBSD_4_4:1.2.0.2
	OPENBSD_4_4_BASE:1.2
	OPENBSD_4_3:1.1.0.8
	OPENBSD_4_3_BASE:1.1
	OPENBSD_4_2:1.1.0.6
	OPENBSD_4_2_BASE:1.1
	OPENBSD_4_1:1.1.0.4
	OPENBSD_4_1_BASE:1.1
	OPENBSD_4_0:1.1.0.2
	OPENBSD_4_0_BASE:1.1;
locks; strict;
comment	@# @;


1.6
date	2014.08.19.13.54.56;	author giovanni;	state Exp;
branches;
next	1.5;
commitid	AYbj76hybRlav67V;

1.5
date	2013.11.12.22.24.57;	author sthen;	state Exp;
branches;
next	1.4;

1.4
date	2011.05.06.08.40.06;	author sthen;	state Exp;
branches;
next	1.3;

1.3
date	2008.08.22.21.57.49;	author jakob;	state Exp;
branches;
next	1.2;

1.2
date	2008.03.31.21.26.15;	author jakob;	state Exp;
branches;
next	1.1;

1.1
date	2006.06.18.08.28.56;	author jakob;	state Exp;
branches;
next	;


desc
@@


1.6
log
@
bugfix update to 1.35
maintainer timeout
@
text
@# $OpenBSD: patch-postgrey,v 1.5 2013/11/12 22:24:57 sthen Exp $

default path/uid/gid changes, plus untaint for Perl 5.18

From 9673b54064691a5b9c295ffea340d8a1f9ee1cb8 Mon Sep 17 00:00:00 2001
From: Yasuhiro KIMURA <yasu@@utahime.org>
Date: Sat, 17 Aug 2013 22:05:27 +0900
Subject: [PATCH] Make postgrey work with Perl 5.18

--- postgrey.orig	Wed Jun 11 15:13:50 2014
+++ postgrey	Sat Jul 12 17:18:21 2014
@@@@ -23,7 +23,7 @@@@ use vars qw(@@ISA);
 @@ISA = qw(Net::Server::Multiplex);
 
 my $VERSION = '1.35';
-my $DEFAULT_DBDIR = '/var/spool/postfix/postgrey';
+my $DEFAULT_DBDIR = '/var/db/postgrey';
 my $CONFIG_DIR = '/etc/postfix';
 
 sub cidr_parse($)
@@@@ -551,6 +551,16 @@@@ sub main()
                 "       followed by 'h' for hours ('6h' for example).\n";
         }
     }
+    # untaint what is given on --pidfile. It is not security sensitive since
+    # it is provided by the admin
+    if($opt{pidfile}) {
+        $opt{pidfile} =~ /^(.*)$/; $opt{pidfile} = $1;
+    }
+    # untaint what is given on --inet. It is not security sensitive since
+    # it is provided by the admin
+    if($opt{inet}) {
+        $opt{inet} =~ /^(.*)$/; $opt{inet} = $1;
+    }
 
     # untaint what is given on --dbdir. It is not security sensitive since
     # it is provided by the admin
@@@@ -595,8 +605,8 @@@@ sub main()
             commandline      => [ 'postgrey', @@ARGV_saved ],
             port             => [ $opt{inet} ? $opt{inet} : $opt{unix}."|unix" ],
             proto            => $opt{inet} ? 'tcp' : 'unix',
-            user             => $opt{user} || 'postgrey',
-            group            => $opt{group} || 'nogroup',
+            user             => $opt{user} || '_postgrey',
+            group            => $opt{group} || '_postgrey',
             dbdir            => $opt{dbdir} || $DEFAULT_DBDIR,
             setsid           => $opt{daemonize} ? 1 : undef,
             pid_file         => $opt{daemonize} ? $opt{pidfile} : undef,
@@@@ -804,9 +814,9 @@@@ B<postgrey> [I<options>...]
  -i, --inet=[HOST:]PORT  listen on PORT, localhost if HOST is not specified
  -d, --daemonize         run in the background
      --pidfile=PATH      put daemon pid into this file
-     --user=USER         run as USER (default: postgrey)
-     --group=GROUP       run as group GROUP (default: nogroup)
-     --dbdir=PATH        put db files in PATH (default: /var/spool/postfix/postgrey)
+     --user=USER         run as USER (default: _postgrey)
+     --group=GROUP       run as group GROUP (default: _postgrey)
+     --dbdir=PATH        put db files in PATH (default: /var/db/postgrey)
      --delay=N           greylist for N seconds (default: 300)
      --max-age=N         delete entries older than N days since the last time
                          that they have been seen (default: 35)
@


1.5
log
@preemptively fix postgrey for taint changes in newer perl (since I just
happened to run across the diff when looking for something else).
@
text
@d1 1
a1 1
# $OpenBSD$
d10 2
a11 2
--- postgrey.orig	Wed May  4 21:54:15 2011
+++ postgrey	Tue Nov 12 22:21:49 2013
d15 1
a15 1
 my $VERSION = '1.34';
d21 3
a23 3
@@@@ -557,6 +557,16 @@@@ sub main()
     if($opt{dbdir}) {
         $opt{dbdir} =~ /^(.*)$/; $opt{dbdir} = $1;
d36 4
a39 4
     # determine proper "logsock" for Sys::Syslog
     my $syslog_logsock;
@@@@ -585,8 +595,8 @@@@ sub main()
             commandline      => [ $0, @@ARGV_saved ],
d49 1
a49 1
@@@@ -794,9 +804,9 @@@@ B<postgrey> [I<options>...]
@


1.4
log
@- update postgrey to 1.34
- add an rc script (reload works).

ok jakob@@
@
text
@d1 9
d11 5
a15 2
+++ postgrey	Thu May  5 16:44:16 2011
@@@@ -26,4 +26,4 @@@@ use vars qw(@@ISA);
d21 18
a38 1
@@@@ -585,8 +585,8 @@@@ sub main()
d49 1
a49 1
@@@@ -794,9 +794,9 @@@@ B<postgrey> [I<options>...]
@


1.3
log
@upgrade postgrey to v1.32; from David Hill
@
text
@d1 3
a3 6
--- postgrey.orig	Thu Jul 31 12:51:39 2008
+++ postgrey	Thu Jul 31 12:54:15 2008
@@@@ -23,7 +23,7 @@@@
 @@ISA = qw(Net::Server::Multiplex);
 
 my $VERSION = '1.32';
d9 1
a9 1
@@@@ -574,8 +574,8 @@@@
d20 1
a20 1
@@@@ -782,9 +782,9 @@@@
@


1.2
log
@upadate to postgrey v1.31; based on patch from Giovanni Bechis
@
text
@d1 3
a3 4
$OpenBSD: patch-postgrey,v 1.1 2006/06/18 08:28:56 jakob Exp $
--- postgrey.orig	Thu Sep  6 16:32:58 2007
+++ postgrey	Fri Mar 21 10:19:05 2008
@@@@ -23,7 +23,7 @@@@ use vars qw(@@ISA);
d6 1
a6 1
 my $VERSION = '1.31';
d12 1
a12 1
@@@@ -556,8 +556,8 @@@@ sub main()
d23 1
a23 1
@@@@ -763,9 +763,9 @@@@ B<postgrey> [I<options>...]
@


1.1
log
@update to postgrey version 1.24
- install manpage
- use _postgrey user be default
- move database directory to /var/db/postgrey
@
text
@d1 13
a13 4
$OpenBSD$
--- postgrey.orig	Mon Jan 16 08:32:15 2006
+++ postgrey	Sun Jun 18 10:26:14 2006
@@@@ -431,9 +431,9 @@@@ sub main()
a18 1
-            dbdir            => $opt{dbdir} || '/var/spool/postfix/postgrey',
d21 1
a21 1
+            dbdir            => $opt{dbdir} || '/var/db/postgrey',
d24 1
a24 11
             log_level        => $opt{verbose} ? 4 : 2,
@@@@ -444,7 +444,7 @@@@ sub main()
         },
         postgrey => {
             delay            => $opt{delay}     || 300,
-            dbdir            => $opt{dbdir}     || '/var/spool/postfix/postgrey',
+            dbdir            => $opt{dbdir}     || '/var/db/postgrey',
             max_age          => $opt{'max-age'} || 35,
             last_maint       => time,
             last_maint_keys  => 0, # do it on the first night
@@@@ -608,9 +608,9 @@@@ B<postgrey> [I<options>...]
@

