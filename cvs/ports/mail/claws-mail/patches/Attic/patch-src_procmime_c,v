head	1.12;
access;
symbols
	OPENBSD_5_8:1.11.0.6
	OPENBSD_5_8_BASE:1.11
	OPENBSD_5_7:1.11.0.2
	OPENBSD_5_7_BASE:1.11
	OPENBSD_5_6:1.10.0.2
	OPENBSD_5_6_BASE:1.10
	OPENBSD_5_5:1.9.0.2
	OPENBSD_5_5_BASE:1.9
	OPENBSD_5_4:1.8.0.4
	OPENBSD_5_4_BASE:1.8
	OPENBSD_5_3:1.8.0.2
	OPENBSD_5_3_BASE:1.8
	OPENBSD_5_2:1.7.0.2
	OPENBSD_5_2_BASE:1.7
	OPENBSD_5_1_BASE:1.6
	OPENBSD_5_1:1.6.0.14
	OPENBSD_5_0:1.6.0.12
	OPENBSD_5_0_BASE:1.6
	OPENBSD_4_9:1.6.0.10
	OPENBSD_4_9_BASE:1.6
	OPENBSD_4_8:1.6.0.8
	OPENBSD_4_8_BASE:1.6
	OPENBSD_4_7:1.6.0.6
	OPENBSD_4_7_BASE:1.6
	OPENBSD_4_6:1.6.0.4
	OPENBSD_4_6_BASE:1.6
	OPENBSD_4_5:1.6.0.2
	OPENBSD_4_5_BASE:1.6
	OPENBSD_4_4:1.5.0.4
	OPENBSD_4_4_BASE:1.5
	OPENBSD_4_3:1.5.0.2
	OPENBSD_4_3_BASE:1.5
	OPENBSD_4_2:1.2.0.2
	OPENBSD_4_2_BASE:1.2
	deanna_20070323:1.1.1.1
	deanna:1.1.1;
locks; strict;
comment	@# @;


1.12
date	2015.09.12.14.14.17;	author sthen;	state dead;
branches;
next	1.11;
commitid	T2m2Snx964xWJhWt;

1.11
date	2015.01.14.12.18.43;	author landry;	state Exp;
branches;
next	1.10;
commitid	9dscizohMcjzS98o;

1.10
date	2014.04.21.17.40.19;	author sthen;	state Exp;
branches;
next	1.9;

1.9
date	2013.09.25.08.03.16;	author landry;	state Exp;
branches;
next	1.8;

1.8
date	2012.10.09.17.01.16;	author sthen;	state Exp;
branches;
next	1.7;

1.7
date	2012.06.29.14.02.54;	author landry;	state Exp;
branches;
next	1.6;

1.6
date	2008.10.17.12.46.33;	author landry;	state Exp;
branches;
next	1.5;

1.5
date	2008.02.13.13.17.26;	author landry;	state Exp;
branches;
next	1.4;

1.4
date	2008.01.08.23.13.23;	author landry;	state Exp;
branches;
next	1.3;

1.3
date	2007.09.28.22.12.01;	author pyr;	state Exp;
branches;
next	1.2;

1.2
date	2007.05.10.07.43.39;	author steven;	state Exp;
branches;
next	1.1;

1.1
date	2007.03.23.17.38.22;	author deanna;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2007.03.23.17.38.22;	author deanna;	state Exp;
branches;
next	;


desc
@@


1.12
log
@update to claws-mail-3.12.0, from Daniel Jakots who takes maintainer
@
text
@$OpenBSD: patch-src_procmime_c,v 1.11 2015/01/14 12:18:43 landry Exp $
http://www.thewildbeast.co.uk/claws-mail/bugzilla/show_bug.cgi?id=2640
http://www.thewildbeast.co.uk/claws-mail/bugzilla/show_bug.cgi?id=2641
http://www.thewildbeast.co.uk/claws-mail/bugzilla/show_bug.cgi?id=2642
http://www.thewildbeast.co.uk/claws-mail/bugzilla/show_bug.cgi?id=2743
--- src/procmime.c.orig	Mon Oct 27 19:58:13 2014
+++ src/procmime.c	Mon Jan 12 23:00:15 2015
@@@@ -634,10 +634,22 @@@@ gboolean procmime_encode_content(MimeInfo *mimeinfo, E
 			g_free(tmp_file);
 		}
 	} else if (encoding == ENC_QUOTED_PRINTABLE) {
-		gchar inbuf[BUFFSIZE], outbuf[BUFFSIZE * 4];
+		gchar inbuf[79], outbuf[77];
+		gint n, len = 0;
+		gboolean firstrun = TRUE;
 
-		while (SC_FGETS(inbuf, sizeof(inbuf), infp) != NULL) {
-			qp_encode_line(outbuf, inbuf);
+		while ((len += fread(inbuf + len, 1,
+			sizeof(inbuf) - len - 1,
+			infp)) > 0)
+		{
+			if (firstrun == FALSE)
+				if (fputs("\r\n", outfp) == EOF)
+					err = TRUE;
+			inbuf[len] = '\0';
+			n = qp_encode(mimeinfo->type == MIMETYPE_TEXT,
+					outbuf, inbuf, len);
+			len -= n;
+			memmove(inbuf, inbuf + n, len);
 
 			if (!strncmp("From ", outbuf, sizeof("From ")-1)) {
 				gchar *tmpbuf = outbuf;
@@@@ -652,14 +664,39 @@@@ gboolean procmime_encode_content(MimeInfo *mimeinfo, E
 				if (SC_FPUTS(outbuf, outfp) == EOF)
 					err = TRUE;
 			}
+			firstrun = FALSE;
 		}
 	} else {
-		gchar buf[BUFFSIZE];
+		gchar buf[MAXSMTPTEXTLEN+1];
+		gint leftover = 0;
 
-		while (SC_FGETS(buf, sizeof(buf), infp) != NULL) {
-			strcrchomp(buf);
-			if (SC_FPUTS(buf, outfp) == EOF)
+		while (fgets(buf + leftover,
+				sizeof(buf) - leftover,
+				infp) != NULL)
+		{
+			gchar *l, *c = buf;
+			leftover = 0;
+
+			while (*c != '\0') {
+				if (
+					*c == '\n'
+					|| (*c == '\r' && *(c+1) == '\n'))
+				{
+					*c = '\0';
+					break;
+				}
+				c++;
+			}
+			while (c - buf > MAXSMTPTEXTLEN - 2) {
+				*c = *(c-1);
+				*--c = '\0';
+				leftover++;
+			}
+			if (fputs(buf, outfp) == EOF || putc('\n', outfp) == EOF)
+
 				err = TRUE;
+			for (l = buf; l-buf < leftover; l++)
+				*l = *++c;
 		}
 	}
 
@@@@ -1203,7 +1240,7 @@@@ GList *procmime_get_mime_type_list(void)
 #endif
 	{
 		fp_is_glob_file = FALSE;
-		if ((fp = procmime_fopen("/etc/mime.types", "rb")) == NULL) {
+		if ((fp = procmime_fopen("/var/www/conf/mime.types", "rb")) == NULL) {
 			if ((fp = procmime_fopen(SYSCONFDIR "/mime.types", "rb")) 
 				== NULL) {
 				FILE_OP_ERROR(SYSCONFDIR "/mime.types", 
@@@@ -1283,11 +1320,12 @@@@ EncodingType procmime_get_encoding_for_text_file(const
 {
 	FILE *fp;
 	guchar buf[BUFFSIZE];
+	gboolean cr = FALSE;
 	size_t len;
+	gint linelen = 0, maxlinelen = 0;
 	size_t octet_chars = 0;
 	size_t total_len = 0;
 	gfloat octet_percentage;
-	gboolean force_b64 = FALSE;
 
 	if ((fp = procmime_fopen(file, "rb")) == NULL) {
 		FILE_OP_ERROR(file, "fopen");
@@@@ -1299,11 +1337,27 @@@@ EncodingType procmime_get_encoding_for_text_file(const
 		gint i;
 
 		for (p = buf, i = 0; i < len; ++p, ++i) {
-			if (*p & 0x80)
-				++octet_chars;
-			if (*p == '\0') {
-				force_b64 = TRUE;
-				*has_binary = TRUE;
+			switch (*p) {
+				case '\n':
+					if (cr) linelen--;
+					maxlinelen = MAX(linelen, maxlinelen);
+					linelen = 0;
+					cr = FALSE;
+					break;
+				case '\r':
+					cr = TRUE;
+					linelen++;
+					break;
+				case '\0':
+					*has_binary = TRUE;
+					maxlinelen = G_MAXINT;
+					cr = FALSE;
+					break;
+				default:
+					if (*p & 0x80)
+						octet_chars++;
+					linelen++;
+					cr = FALSE;
 			}
 		}
 		total_len += len;
@@@@ -1317,15 +1371,20 @@@@ EncodingType procmime_get_encoding_for_text_file(const
 		octet_percentage = 0.0;
 
 	debug_print("procmime_get_encoding_for_text_file(): "
-		    "8bit chars: %zd / %zd (%f%%)\n", octet_chars, total_len,
-		    100.0 * octet_percentage);
+			"8bit chars: %zd / %zd (%f%%). "
+			"maximum line length: %d chars\n",
+			octet_chars, total_len, 100.0 * octet_percentage,
+			maxlinelen);
 
-	if (octet_percentage > 0.20 || force_b64) {
+	if (octet_percentage > 0.20) {
 		debug_print("using BASE64\n");
 		return ENC_BASE64;
-	} else if (octet_chars > 0) {
+	} else if (maxlinelen > MAXSMTPTEXTLEN-2) {
 		debug_print("using quoted-printable\n");
 		return ENC_QUOTED_PRINTABLE;
+	} else if (octet_chars > 0) {
+		debug_print("using 8bit\n");
+		return ENC_8BIT;
 	} else {
 		debug_print("using 7bit\n");
 		return ENC_7BIT;
@


1.11
log
@Update to claws-mail 3.11.1

See http://www.claws-mail.org/news.php for list of bugfixes.

Tested by Daniel Jakots and Benjamin Baier, thanks!
@
text
@d1 1
a1 1
$OpenBSD: patch-src_procmime_c,v 1.10 2014/04/21 17:40:19 sthen Exp $
@


1.10
log
@sync patches
@
text
@d1 1
a1 1
$OpenBSD: patch-src_procmime_c,v 1.9 2013/09/25 08:03:16 landry Exp $
d6 3
a8 3
--- src/procmime.c.orig	Sat Dec 14 10:15:01 2013
+++ src/procmime.c	Mon Apr 21 18:40:02 2014
@@@@ -616,10 +616,22 @@@@ gboolean procmime_encode_content(MimeInfo *mimeinfo, E
d34 1
a34 1
@@@@ -634,14 +646,39 @@@@ gboolean procmime_encode_content(MimeInfo *mimeinfo, E
d78 1
a78 1
@@@@ -1182,7 +1219,7 @@@@ GList *procmime_get_mime_type_list(void)
d87 1
a87 1
@@@@ -1262,11 +1299,12 @@@@ EncodingType procmime_get_encoding_for_text_file(const
d101 1
a101 1
@@@@ -1278,11 +1316,27 @@@@ EncodingType procmime_get_encoding_for_text_file(const
d134 1
a134 1
@@@@ -1296,15 +1350,20 @@@@ EncodingType procmime_get_encoding_for_text_file(const
@


1.9
log
@Update to claws-mail 3.9.2.

- all the plugins which were distributed separately are now bundled in.
- @@conflict/@@pkgpath markers added for upgrade path.
- add a pdfviewer plugin using poppler
- replace the dead gtkhtml2-based htmlviewer plugin by one using webkit.
- given the deps, pdfviewer and htmlviewer are subpackages.
- remove BDEP on libgcrypt, shouldnt be needed with gnutls >= 2.11.
- remove patches merged upstream.

From Ido Admon, thanks!
@
text
@d1 1
a1 1
$OpenBSD: patch-src_procmime_c,v 1.8 2012/10/09 17:01:16 sthen Exp $
d6 2
a7 2
--- src/procmime.c.orig	Wed May  8 04:46:17 2013
+++ src/procmime.c	Sun Sep 22 23:00:18 2013
d78 1
a78 1
@@@@ -1183,7 +1220,7 @@@@ GList *procmime_get_mime_type_list(void)
d87 1
a87 1
@@@@ -1263,11 +1300,12 @@@@ EncodingType procmime_get_encoding_for_text_file(const
d101 1
a101 1
@@@@ -1279,11 +1317,27 @@@@ EncodingType procmime_get_encoding_for_text_file(const
d134 1
a134 1
@@@@ -1297,15 +1351,20 @@@@ EncodingType procmime_get_encoding_for_text_file(const
@


1.8
log
@avoid a null pointer deref in claws-mail;
http://www.thewildbeast.co.uk/claws-mail/bugzilla/show_bug.cgi?id=2743
@
text
@d1 1
a1 1
$OpenBSD: patch-src_procmime_c,v 1.7 2012/06/29 14:02:54 landry Exp $
d6 3
a8 3
--- src/procmime.c.orig	Wed Jun 27 11:05:22 2012
+++ src/procmime.c	Tue Oct  9 18:51:08 2012
@@@@ -562,16 +562,29 @@@@ gboolean procmime_encode_content(MimeInfo *mimeinfo, E
d17 1
a17 1
-		while (fgets(inbuf, sizeof(inbuf), infp) != NULL) {
a25 1
 
d31 1
a31 1
+
d34 2
a35 10
-				
+
 				tmpbuf += sizeof("From ")-1;
-				
+
 				if (fputs("=46rom ", outfp) == EOF)
 					err = TRUE;
 				if (fputs(tmpbuf, outfp) == EOF)
@@@@ -580,14 +593,40 @@@@ gboolean procmime_encode_content(MimeInfo *mimeinfo, E
 				if (fputs(outbuf, outfp) == EOF)
d45 1
a45 1
-		while (fgets(buf, sizeof(buf), infp) != NULL) {
d47 1
a47 1
-			if (fputs(buf, outfp) == EOF)
d69 2
a70 1
+				}
a71 1
+			if (fputs(buf, outfp) == EOF || putc('\n', outfp) == EOF)
a72 1
+
d78 1
a78 1
@@@@ -1094,7 +1133,7 @@@@ GList *procmime_get_mime_type_list(void)
d82 3
a84 3
-		if ((fp = g_fopen("/etc/mime.types", "rb")) == NULL) {
+		if ((fp = g_fopen("/var/www/conf/mime.types", "rb")) == NULL) {
 			if ((fp = g_fopen(SYSCONFDIR "/mime.types", "rb")) 
d87 1
a87 1
@@@@ -1174,11 +1213,12 @@@@ EncodingType procmime_get_encoding_for_text_file(const
d99 1
a99 1
 	if ((fp = g_fopen(file, "rb")) == NULL) {
d101 1
a101 1
@@@@ -1190,11 +1230,27 @@@@ EncodingType procmime_get_encoding_for_text_file(const
d109 1
d111 20
a130 20
+			case '\n':
+				if (cr) linelen--;
+				maxlinelen = MAX(linelen, maxlinelen);
+				linelen = 0;
+				cr = FALSE;
+				break;
+			case '\r':
+				cr = TRUE;
+				linelen++;
+				break;
+			case '\0':
 				*has_binary = TRUE;
+				maxlinelen = G_MAXINT;
+				cr = FALSE;
+				break;
+			default:
+				if (*p & 0x80)
+					octet_chars++;
+				linelen++;
+				cr = FALSE;
d134 1
a134 1
@@@@ -1208,15 +1264,20 @@@@ EncodingType procmime_get_encoding_for_text_file(const
d140 4
a143 4
+		    "8bit chars: %zd / %zd (%f%%). "
+		    "maximum line length: %d chars\n",
+		    octet_chars, total_len, 100.0 * octet_percentage,
+		    maxlinelen);
a158 9
@@@@ -1753,6 +1814,8 @@@@ static void parse_parameters(const gchar *parameters, 
 			continue;
 
 		charset = value;
+		if (charset == NULL)
+			continue;
 		lang = strchr(charset, '\'');
 		if (lang == NULL)
 			continue;
@


1.7
log
@Update to claws-mail 3.8.1 and plugins :

- attremover 1.0.14
- htmlviewer 0.32
- notification 0.30
- rssyl 0.33
- vcalendar 2.0.13

While here add patches for upstream bugs #2840, #2841 and #2842. Add
links to corresponding patches for tracking purposes.

All from Christopher Zimmermann, thanks!
@
text
@d1 1
a1 1
$OpenBSD: patch-src_procmime_c,v 1.6 2008/10/17 12:46:33 landry Exp $
d5 3
a7 2
--- src/procmime.c.orig	Fri Dec 16 09:09:32 2011
+++ src/procmime.c	Tue Apr  3 14:59:40 2012
d168 9
@


1.6
log
@Update to claws-mail 3.6.1.
Due to some licensing mess, it now uses GnuTLS instead of OpenSSL.
Switched to textproc/enchant instead of textproc/aspell for spelling.

No objection from ajacoutot@@, looks good to MAINTAINER.
@
text
@d1 87
a87 4
$OpenBSD: patch-src_procmime_c,v 1.5 2008/02/13 13:17:26 landry Exp $
--- src/procmime.c.orig	Wed Oct  1 03:10:29 2008
+++ src/procmime.c	Sat Oct  4 16:02:19 2008
@@@@ -1085,7 +1085,7 @@@@ GList *procmime_get_mime_type_list(void)
d96 71
@


1.5
log
@Update to claws-mail 3.3.0, from Ulrich Kahl (maintainer) with some tweaks
by me to clean/reorder LIB_DEPENDS/WANTLIB. Remove two integrated patches.
clamav plugin is not part of it anymore due to licence issues, it will be
reimported soon in a standalone port.

Tested too by Pierre-Emmanuel Andre @@i386, thanks !
ok ajacoutot@@ pyr@@
@
text
@d1 4
a4 4
$OpenBSD: patch-src_procmime_c,v 1.4 2008/01/08 23:13:23 landry Exp $
--- src/procmime.c.orig	Fri Feb  8 06:33:17 2008
+++ src/procmime.c	Fri Feb  8 18:19:56 2008
@@@@ -1083,7 +1083,7 @@@@ GList *procmime_get_mime_type_list(void)
@


1.4
log
@Long due update to 3.2.0, diff mostly from Ulrich Kahl (MAINTAINER)
- gnomeprint flavor has been removed, it uses gtkprint now
- patch-src_procmime_c updated to fix a problem reported by Marten King
- pgp* plugins are built but not installed, due to a severe threading bug :
see http://www.thewildbeast.co.uk/claws-mail/bugzilla/show_bug.cgi?id=1348

tested by many, ok ajacoutot@@ kili@@ and MAINTAINER
@
text
@d1 4
a4 12
$OpenBSD: patch-src_procmime_c,v 1.3 2007/09/28 22:12:01 pyr Exp $
--- src/procmime.c.orig	Mon Dec 17 06:37:02 2007
+++ src/procmime.c	Fri Dec 28 23:49:56 2007
@@@@ -1055,14 +1055,14 @@@@ GList *procmime_get_mime_type_list(void)
 	if (mime_type_list) 
 		return mime_type_list;
 	
-#if defined(__NetBSD__)
+#if defined(__NetBSD__) || defined(__OpenBSD__)
 	if ((fp = g_fopen(DATAROOTDIR "/mime/globs", "rb")) == NULL) 
 #else
 	if ((fp = g_fopen("/usr/share/mime/globs", "rb")) == NULL) 
@


1.3
log
@Update to 3.0.1 from brad.
Tested on many workstations.
ok brad@@
@
text
@d1 12
a12 4
$OpenBSD: patch-src_procmime_c,v 1.2 2007/05/10 07:43:39 steven Exp $
--- src/procmime.c.orig	Mon Sep 17 04:14:33 2007
+++ src/procmime.c	Tue Sep 18 21:45:32 2007
@@@@ -1154,7 +1154,7 @@@@ GList *procmime_get_mime_type_list(void)
@


1.2
log
@update to 2.9.2, various bugfixes

from brad
@
text
@d1 4
a4 4
$OpenBSD: patch-src_procmime_c,v 1.1.1.1 2007/03/23 17:38:22 deanna Exp $
--- src/procmime.c.orig	Tue May  8 03:59:22 2007
+++ src/procmime.c	Tue May  8 13:19:20 2007
@@@@ -1128,7 +1128,7 @@@@ GList *procmime_get_mime_type_list(void)
@


1.1
log
@Initial revision
@
text
@d1 4
a4 4
$OpenBSD: patch-src_procmime_c,v 1.3 2005/04/12 20:29:26 naddy Exp $
--- src/procmime.c.orig	Mon Mar  5 23:44:47 2007
+++ src/procmime.c	Sun Mar 18 15:36:24 2007
@@@@ -1130,7 +1130,7 @@@@ GList *procmime_get_mime_type_list(void)
@


1.1.1.1
log
@Import claws-mail 2.8.1, a many-featured mail and news reader.

From Ulrich Kahl, with work by pyr@@, brad, myself and various people
on ports@@.  Not quite finished, but with this many contributers, it's
nice to have some version control.

ok pvalchev

----------------------------------------------------------------------
----------------------------------------------------------------------
@
text
@@
