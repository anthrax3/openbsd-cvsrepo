head     1.1;
branch   1.1.1;
access   ;
symbols  robert_20170913:1.1.1.1 robert:1.1.1;
locks    ; strict;
comment  @# @;


1.1
date     2017.09.13.10.38.41;  author robert;  state Exp;
branches 1.1.1.1;
next     ;
commitid        EUPcYe0im3Fq9qvW;

1.1.1.1
date     2017.09.13.10.38.41;  author robert;  state Exp;
branches ;
next     ;
commitid        EUPcYe0im3Fq9qvW;


desc
@@



1.1
log
@Initial revision
@
text
@$OpenBSD$

Index: common/platform.linux.cpp
--- common/platform.linux.cpp.orig
+++ common/platform.linux.cpp
@@@@ -45,7 +45,7 @@@@
 #else
 #	include <uuid.h>
 #endif
-#if defined(__linux__) && defined(__GLIBC__)
+#if (defined(__linux__) && defined(__GLIBC__)) || defined(__OpenBSD__)
 #	include <cxxabi.h>
 #	include <execinfo.h>
 #endif
@@@@ -54,9 +54,6 @@@@
 #ifdef __APPLE__
 // bsd
 #define ICONV_CONST const
-#elif OPENBSD
-// bsd
-#define ICONV_CONST const
 #else
 // linux
 #define ICONV_CONST
@@@@ -79,22 +76,10 @@@@ HRESULT CoCreateGuid(LPGUID pNewGUID) {
 		return MAPI_E_INVALID_PARAMETER;
 
 #if HAVE_UUID_CREATE
-#ifdef OPENBSD
-	uuid_t *g = NULL;
-	void *vp = NULL;
-	size_t n = 0;
-	// error codes are not checked!
-	uuid_create(&g);
-	uuid_make(g, UUID_MAKE_V1);
-	uuid_export(g, UUID_FMT_BIN, &vp, &n);
-	memcpy(pNewGUID, &vp, UUID_LEN_BIN);
-	uuid_destroy(g);
-#else
 	uuid_t g;
 	uint32_t uid_ret;
 	uuid_create(&g, &uid_ret);
 	memcpy(pNewGUID, &g, sizeof(g));
-#endif // OPENBSD
 #else
 	uuid_t g;
 	uuid_generate(g);
@@@@ -142,6 +127,12 @@@@ void Sleep(unsigned int msec) {
 
 namespace KC {
 
+#ifdef HAVE_ARC4RANDOM_BUF
+void rand_get(char *p, int n)
+{
+	arc4random_buf(p, n);
+}
+#else
 static void rand_fail(void)
 {
 	fprintf(stderr, "Cannot access/use /dev/urandom, this is fatal (%s)\n", strerror(errno));
@@@@ -178,6 +169,7 @@@@ void rand_get(char *p, int n)
 
 		close(fd);
 	}
+#endif
 	
 void rand_init() {
 	unsigned int seed = 0;
@


1.1.1.1
log
@import of kopano-{core,mapi,webapp}-8.3.5.1335

Kopano is a replacement of the deprecated Zarafa (ZCP) suite.

Joint work with pirofti@@

For upgrading please refer to the README.

ok ajacoutot@@
@
text
@@
