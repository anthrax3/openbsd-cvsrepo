head	1.2;
access;
symbols
	OPENBSD_4_9:1.2.0.2;
locks; strict;
comment	@# @;


1.2
date	2010.12.02.08.56.32;	author ajacoutot;	state dead;
branches
	1.2.2.1;
next	1.1;

1.1
date	2010.10.29.09.26.58;	author ajacoutot;	state Exp;
branches;
next	;

1.2.2.1
date	2011.05.10.14.22.15;	author gsoares;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Remove some un-needed patches. Add some better defaults.
Properly bump this time.
@
text
@$OpenBSD: patch-lib_prot_c,v 1.1 2010/10/29 09:26:58 ajacoutot Exp $
--- lib/prot.c.orig	Fri Oct 22 21:54:45 2010
+++ lib/prot.c	Fri Oct 22 21:55:04 2010
@@@@ -715,7 +715,7 @@@@ int prot_fill(struct protstream *s)
 	char timebuf[20];
 
 	time(&newtime);
-	snprintf(timebuf, sizeof(timebuf), "<%ld<", newtime);
+	snprintf(timebuf, sizeof(timebuf), "<%d<", newtime);
 	n = write(s->logfd, timebuf, strlen(timebuf));
 
 	left = s->cnt;
@@@@ -758,7 +758,7 @@@@ static void prot_flush_log(struct protstream *s) 
 	char timebuf[20];
 	
 	time(&newtime);
-	snprintf(timebuf, sizeof(timebuf), ">%ld>", newtime);
+	snprintf(timebuf, sizeof(timebuf), ">%d>", newtime);
 	n = write(s->logfd, timebuf, strlen(timebuf));
 
 	do {
@


1.2.2.1
log
@Security Fix CVE-2011-0411
Fixed bug #3423 - STARTTLS plaintext command injection vulnerability

ok jasper@@
@
text
@d1 5
a5 9
$OpenBSD$

Security Fix CVE-2011-0411
Fixed bug #3423 - STARTTLS plaintext command injection vulnerability

--- lib/prot.c.orig	Mon Dec 20 10:15:49 2010
+++ lib/prot.c	Tue May  3 11:34:26 2011
@@@@ -740,10 +740,30 @@@@ int prot_fill(struct protstream *s)
 }
d7 4
a10 27
 /*
+ * If 's' is an input stream, discard any pending/buffered data.  Otherwise,
  * Write out any buffered data in the stream 's'
  */
 int prot_flush(struct protstream *s) 
 {
+    if (!s->write) {
+	int c, save_dontblock = s->dontblock;
+
+	/* Set stream to nonblocking mode */
+	if (!save_dontblock) nonblock(s->fd, (s->dontblock = 1));
+
+	/* Ingest any pending input */
+	while ((c = prot_fill(s)) != EOF);
+
+	/* Reset stream to previous blocking mode */
+	if (!save_dontblock) nonblock(s->fd, (s->dontblock = 0));
+
+	/* Discard any buffered input */
+	s->cnt = 0;
+	s->can_unget = 0;
+
+	return 0;
+    }
+
     return prot_flush_internal(s, 1);
 }
d12 10
@


1.1
log
@Update to cyrus-imapd-2.4.2 and add an rc script.
@
text
@d1 1
a1 1
$OpenBSD$
@

