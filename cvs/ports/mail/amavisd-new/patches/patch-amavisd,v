head	1.15;
access;
symbols
	OPENBSD_6_0:1.14.0.2
	OPENBSD_6_0_BASE:1.14
	OPENBSD_5_9:1.12.0.2
	OPENBSD_5_9_BASE:1.12
	OPENBSD_5_8:1.11.0.8
	OPENBSD_5_8_BASE:1.11
	OPENBSD_5_7:1.11.0.4
	OPENBSD_5_7_BASE:1.11
	OPENBSD_5_6:1.11.0.2
	OPENBSD_5_6_BASE:1.11
	OPENBSD_5_5:1.10.0.8
	OPENBSD_5_5_BASE:1.10
	OPENBSD_5_4:1.10.0.6
	OPENBSD_5_4_BASE:1.10
	OPENBSD_5_3:1.10.0.4
	OPENBSD_5_3_BASE:1.10
	OPENBSD_5_2:1.10.0.2
	OPENBSD_5_2_BASE:1.10
	OPENBSD_5_1_BASE:1.9
	OPENBSD_5_1:1.9.0.4
	OPENBSD_5_0:1.9.0.2
	OPENBSD_5_0_BASE:1.9
	OPENBSD_4_9:1.8.0.6
	OPENBSD_4_9_BASE:1.8
	OPENBSD_4_8:1.8.0.4
	OPENBSD_4_8_BASE:1.8
	OPENBSD_4_7:1.8.0.2
	OPENBSD_4_7_BASE:1.8
	OPENBSD_4_6:1.7.0.2
	OPENBSD_4_6_BASE:1.7
	OPENBSD_4_5:1.6.0.2
	OPENBSD_4_5_BASE:1.6
	OPENBSD_4_4:1.4.0.4
	OPENBSD_4_4_BASE:1.4
	OPENBSD_4_3:1.4.0.2
	OPENBSD_4_3_BASE:1.4
	OPENBSD_4_2:1.3.0.4
	OPENBSD_4_2_BASE:1.3
	OPENBSD_4_1:1.3.0.2
	OPENBSD_4_1_BASE:1.3
	OPENBSD_4_0:1.2.0.6
	OPENBSD_4_0_BASE:1.2
	OPENBSD_3_9:1.2.0.4
	OPENBSD_3_9_BASE:1.2
	OPENBSD_3_8:1.2.0.2
	OPENBSD_3_8_BASE:1.2
	OPENBSD_3_7:1.1.1.1.0.4
	OPENBSD_3_7_BASE:1.1.1.1
	OPENBSD_3_6:1.1.1.1.0.2
	OPENBSD_3_6_BASE:1.1.1.1
	robert_20040423:1.1.1.1
	robert:1.1.1;
locks; strict;
comment	@# @;


1.15
date	2016.08.05.12.53.57;	author giovanni;	state Exp;
branches;
next	1.14;
commitid	NdHvjU8MfB105ZBk;

1.14
date	2016.07.01.13.19.29;	author giovanni;	state Exp;
branches
	1.14.2.1;
next	1.13;
commitid	5eRqXtBV7dars66j;

1.13
date	2016.03.02.14.30.50;	author sthen;	state Exp;
branches;
next	1.12;
commitid	1FLbCzDILbGcFUKi;

1.12
date	2016.02.02.21.58.32;	author sthen;	state Exp;
branches;
next	1.11;
commitid	ldcmnxZltC6DsYYS;

1.11
date	2014.06.19.22.17.32;	author sthen;	state Exp;
branches;
next	1.10;
commitid	AwAJBMQ57fttUbVS;

1.10
date	2012.07.07.19.09.36;	author giovanni;	state Exp;
branches;
next	1.9;

1.9
date	2011.07.20.14.46.20;	author giovanni;	state Exp;
branches;
next	1.8;

1.8
date	2009.10.13.13.29.18;	author giovanni;	state Exp;
branches;
next	1.7;

1.7
date	2009.04.28.09.01.56;	author giovanni;	state Exp;
branches;
next	1.6;

1.6
date	2009.01.27.17.59.05;	author giovanni;	state Exp;
branches;
next	1.5;

1.5
date	2008.09.23.21.39.21;	author kili;	state Exp;
branches;
next	1.4;

1.4
date	2007.11.27.13.53.19;	author okan;	state Exp;
branches;
next	1.3;

1.3
date	2006.10.31.20.41.40;	author pvalchev;	state Exp;
branches;
next	1.2;

1.2
date	2005.08.07.21.25.55;	author sturm;	state Exp;
branches;
next	1.1;

1.1
date	2004.04.23.15.24.54;	author robert;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2004.04.23.15.24.54;	author robert;	state Exp;
branches;
next	;

1.14.2.1
date	2016.08.24.09.08.42;	author giovanni;	state Exp;
branches;
next	;
commitid	bTQ4RF2efmOpyD01;


desc
@@


1.15
log
@More DKIM fixes
@
text
@$OpenBSD: patch-amavisd,v 1.14 2016/07/01 13:19:29 giovanni Exp $

Hunks 1, 4: Disable File::LibMagic in favour of safer file(1) from base.
Hunks 2, 5: fix DKIM signing

--- amavisd.orig	Tue Apr 26 21:24:33 2016
+++ amavisd	Fri Aug  5 12:32:39 2016
@@@@ -12928,7 +12928,7 @@@@ sub after_chroot_init() {
                grep(/\.pm\z/, keys %INC)) {
     next  if !grep($_ eq $m, qw(Amavis::Conf
       Archive::Tar Archive::Zip Compress::Zlib Compress::Raw::Zlib
-      Convert::TNEF Convert::UUlib File::LibMagic
+      Convert::TNEF Convert::UUlib
       MIME::Entity MIME::Parser MIME::Tools Mail::Header Mail::Internet
       Digest::MD5 Digest::SHA Digest::SHA1 Crypt::OpenSSL::RSA
       Authen::SASL Authen::SASL::XS Authen::SASL::Cyrus Authen::SASL::Perl
@@@@ -22806,6 +22806,7 @@@@ sub process_smtp_request($$$$) {
         }
         # load policy banks from the 'client_ipaddr_policy' lookup
         Amavis::load_policy_bank($_,$msginfo) for @@bank_names_cl;
+        $msginfo->originating(c('originating'));
 
         $msginfo->client_addr($cl_ip);      # ADDR
         $msginfo->client_port($cl_port);    # PORT
@@@@ -30584,7 +30585,7 @@@@ sub new_SpamAssassin_instance {
 #   PREFIX            => '/usr/local',
 #   DEF_RULES_DIR     => '/usr/local/share/spamassassin',
 #   LOCAL_RULES_DIR   => '/etc/mail/spamassassin',
-#   LOCAL_STATE_DIR   => '/var/lib/spamassassin',
+    LOCAL_STATE_DIR   => '/var/db/spamassassin',
 #see Mail::SpamAssassin man page for other options
   };
   if ($sa_version_num < 3.001005 && !defined $sa_args->{LOCAL_STATE_DIR})
@@@@ -31348,17 +31349,8 @@@@ BEGIN {
   import Amavis::Unpackers::NewFilename qw(consumed_bytes);
 }
 
-BEGIN {
   use vars qw($filemagic);
-  eval {
-    require File::LibMagic;
-    File::LibMagic->VERSION(1.00);
-    import File::LibMagic;
-    $filemagic = File::LibMagic->new;
-  } or do {
     undef $filemagic;
-  };
-}
 
 use subs @@EXPORT_OK;
 
@@@@ -34338,6 +34330,7 @@@@ sub collect_some_dkim_info($) {
     $sig_ind++;
   }
   Amavis::load_policy_bank($_,$msginfo) for @@bank_names;
+  $msginfo->originating(c('originating'));
   $msginfo->dkim_signatures_valid(\@@signatures_valid)  if @@signatures_valid;
 # if (ll(5) && $sig_ind > 0) {
 #   # show which header fields are covered by which signature
@


1.14
log
@Unbreak DKIM signing after 2.11.0 upgrade
problem spotted by sthen@@
ok sthen@@
@
text
@d1 1
a1 1
$OpenBSD: patch-amavisd,v 1.13 2016/03/02 14:30:50 sthen Exp $
d3 2
a4 2
Hunks 1, 3: Disable File::LibMagic in favour of safer file(1) from base.
Hunk 4: fix DKIM signing
d7 1
a7 1
+++ amavisd	Fri Jul  1 01:03:15 2016
d17 9
a25 1
@@@@ -30584,7 +30584,7 @@@@ sub new_SpamAssassin_instance {
d34 1
a34 1
@@@@ -31348,17 +31348,8 @@@@ BEGIN {
d52 1
a52 1
@@@@ -34338,6 +34329,7 @@@@ sub collect_some_dkim_info($) {
@


1.14.2.1
log
@More DKIM fixes
ok sthen@@
@
text
@d1 1
a1 1
$OpenBSD: patch-amavisd,v 1.14 2016/07/01 13:19:29 giovanni Exp $
d3 2
a4 2
Hunks 1, 4: Disable File::LibMagic in favour of safer file(1) from base.
Hunks 2, 5: fix DKIM signing
d7 1
a7 1
+++ amavisd	Fri Aug  5 12:32:39 2016
d17 1
a17 9
@@@@ -22806,6 +22806,7 @@@@ sub process_smtp_request($$$$) {
         }
         # load policy banks from the 'client_ipaddr_policy' lookup
         Amavis::load_policy_bank($_,$msginfo) for @@bank_names_cl;
+        $msginfo->originating(c('originating'));
 
         $msginfo->client_addr($cl_ip);      # ADDR
         $msginfo->client_port($cl_port);    # PORT
@@@@ -30584,7 +30585,7 @@@@ sub new_SpamAssassin_instance {
d26 1
a26 1
@@@@ -31348,17 +31349,8 @@@@ BEGIN {
d44 1
a44 1
@@@@ -34338,6 +34330,7 @@@@ sub collect_some_dkim_info($) {
@


1.13
log
@Patch amavisd-new to avoid using libmagic in favour of calling out to
file(1) from base, which is a modern sandboxed implementation. I've pushed
around 300K emails through this so far without problems. ok giovanni@@
@
text
@d1 1
a1 1
$OpenBSD: patch-amavisd,v 1.12 2016/02/02 21:58:32 sthen Exp $
d4 1
d6 3
a8 3
--- amavisd.orig	Sun Oct 26 00:06:00 2014
+++ amavisd	Tue Feb  2 22:08:33 2016
@@@@ -12557,7 +12557,7 @@@@ sub after_chroot_init() {
d17 1
a17 1
@@@@ -29847,7 +29847,7 @@@@ sub new_SpamAssassin_instance {
d26 1
a26 1
@@@@ -30595,17 +30595,8 @@@@ BEGIN {
d44 8
@


1.12
log
@regen patches, no pkg change
@
text
@d1 4
a4 1
$OpenBSD: patch-amavisd,v 1.11 2014/06/19 22:17:32 sthen Exp $
d6 10
a15 1
+++ amavisd	Tue Feb  2 21:57:58 2016
d25 18
@


1.11
log
@Add .gadget files to the commented-out "bad extension" lines in amavisd's
sample config, they can contain active content (including trojans) used by
windows sidebar. OK giovanni@@
@
text
@d1 4
a4 4
$OpenBSD: patch-amavisd,v 1.10 2012/07/07 19:09:36 giovanni Exp $
--- amavisd.orig	Fri Jun 28 20:04:02 2013
+++ amavisd	Thu Jun 19 22:31:13 2014
@@@@ -27307,7 +27307,7 @@@@ sub new_SpamAssassin_instance {
@


1.10
log
@
Update to 2.8.0
new monitoring utilities are not enabled yet.
ok sthen@@
@
text
@d1 4
a4 4
$OpenBSD: patch-amavisd,v 1.9 2011/07/20 14:46:20 giovanni Exp $
--- amavisd.orig	Sat Jun 30 15:43:31 2012
+++ amavisd	Tue Jul  3 18:09:39 2012
@@@@ -26609,7 +26609,7 @@@@ sub new_SpamAssassin_instance {
@


1.9
log
@
Update to 2.7.0
Database schema has changed, you should read carefully release notes
and README.sql if you use MySQL or Postgres for storage or lookups.
Release notes available at http://www.amavis.org/release-notes.txt
@
text
@d1 4
a4 8
$OpenBSD: patch-amavisd,v 1.8 2009/10/13 13:29:18 giovanni Exp $
--- amavisd.orig	Fri Jul  1 18:21:07 2011
+++ amavisd	Tue Jul 12 10:39:35 2011
@@@@ -24679,6 +24679,7 @@@@ sub new_SpamAssassin_instance {
     rules_filename       => $sa_configpath,
     site_rules_filename  => $sa_siteconfigpath,
 #   LOCAL_STATE_DIR   => '/var/lib',
+    LOCAL_STATE_DIR   => '/var/db/spamassassin',
d7 6
a12 1
 #   LOCAL_RULES_DIR   => '/usr/local/etc/mail/spamassassin',
@


1.8
log
@
Update to 2.6.4 and enable p7zip compression

This version provides a true SNMP agent and a MIB, facilitating monitoring the health
of a content filtering system, its performance and mail characteristics.
Full changelog available at http://www.ijs.si/software/amavisd/release-notes.txt
@
text
@d1 4
a4 4
$OpenBSD: patch-amavisd,v 1.7 2009/04/28 09:01:56 giovanni Exp $
--- amavisd.orig	Thu Jun 25 14:39:01 2009
+++ amavisd	Mon Jul 20 17:49:14 2009
@@@@ -22083,6 +22083,7 @@@@ sub initializeSpamAssassin {
@


1.7
log
@
Update to 2.6.3
- security/clamav added as a run dependency
- regen patches
"Looks good ports-wise and builds ok" sthen@@
@
text
@d1 4
a4 4
$OpenBSD: patch-amavisd,v 1.6 2009/01/27 17:59:05 giovanni Exp $
--- amavisd.orig	Wed Apr 22 02:24:12 2009
+++ amavisd	Tue Apr 28 09:11:49 2009
@@@@ -21775,6 +21775,7 @@@@ sub initializeSpamAssassin {
@


1.6
log
@
Update to 2.6.2 and regen patches
ok kili@@
@
text
@d1 6
a6 15
$OpenBSD: patch-amavisd,v 1.5 2008/09/23 21:39:21 kili Exp $
--- amavisd.orig	Mon Dec 15 01:50:09 2008
+++ amavisd	Tue Jan 27 13:21:17 2009
@@@@ -215,7 +215,7 @@@@ BEGIN {
     File::Glob->import(':globally');  # use the same module as Perl 5.8 uses
   }
   fetch_modules('REQUIRED BASIC MODULES', 1, qw(
-    Exporter POSIX Fcntl Socket Errno Carp Time::HiRes
+    Exporter POSIX Fcntl Socket Errno Carp Carp::Heavy Time::HiRes
     IO::Handle IO::File IO::Socket IO::Socket::UNIX IO::Socket::INET
     IO::Stringy Digest::MD5 Unix::Syslog File::Basename
     Compress::Zlib MIME::Base64 MIME::QuotedPrint MIME::Words
@@@@ -21039,6 +21039,7 @@@@ sub initializeSpamAssassin {
     stop_at_threshold => 0,
     need_tags         => 'TIMING,LANGUAGES,RELAYCOUNTRY,ASN,ASNCIDR',
@


1.5
log
@
Update to 2.6.1. From maintainer Giovanni Bechis <g.bechis@@snb.it>.

ok (portwise) simon@@ sthen@@
@
text
@d1 4
a4 4
$OpenBSD: patch-amavisd,v 1.4 2007/11/27 13:53:19 okan Exp $
--- amavisd.orig	Sun Jun 29 02:37:58 2008
+++ amavisd	Wed Sep  3 20:40:21 2008
@@@@ -213,7 +213,7 @@@@ BEGIN {
d11 1
a11 1
     IO::Wrap IO::Stringy Digest::MD5 Unix::Syslog File::Basename
d13 1
a13 1
@@@@ -20210,6 +20210,7 @@@@ sub initializeSpamAssassin {
@


1.4
log
@update to 2.5.2 from new MAINTAINER (Giovanni Bechis), plus a tweak or two by me

ok sturm@@ simon@@
@
text
@d1 6
a6 6
$OpenBSD: patch-amavisd,v 1.3 2006/10/31 20:41:40 pvalchev Exp $
--- amavisd.orig	Wed Jun 27 12:43:00 2007
+++ amavisd	Sat Nov 24 10:18:12 2007
@@@@ -153,7 +153,7 @@@@ sub fetch_modules($$@@) {
 
 BEGIN {
d13 1
a13 3
@@@@ -17909,7 +17909,7 @@@@ sub initializeSpamAssassin {
     local_tests_only  => $sa_local_tests_only,
     home_dir_for_helpers => $helpers_home,
d15 2
a16 1
-#   LOCAL_STATE_DIR   => '/var/lib',
@


1.3
log
@fix so sa-update's rulesets get parsed and used under amavisd-new
from bsd@@openbsd.rutgers.edu, ok maintainer
@
text
@d1 4
a4 4
$OpenBSD: patch-amavisd,v 1.2 2005/08/07 21:25:55 sturm Exp $
--- amavisd.orig	Wed Jun 29 06:26:11 2005
+++ amavisd	Tue Oct 31 08:15:59 2006
@@@@ -128,7 +128,7 @@@@ sub fetch_modules($$@@) {
d12 2
a13 2
     Mail::Field Mail::Address Mail::Header Mail::Internet Compress::Zlib
@@@@ -12566,6 +12566,7 @@@@ sub init() {
d17 1
d19 1
d21 1
a21 2
 #   LOCAL_RULES_DIR   => '/etc/mail/spamassassin',
 #see man Mail::SpamAssassin for other options
@


1.2
log
@update to amavisd-new 2.3.2

from Sigfred Haversen <bsdlist at mumak.com>
@
text
@d1 3
a3 3
$OpenBSD$
--- amavisd.orig	Sat Jul 16 21:05:50 2005
+++ amavisd	Sat Jul 16 21:07:13 2005
d13 8
@


1.1
log
@Initial revision
@
text
@d2 3
a4 3
--- amavisd.orig	2004-04-21 21:29:30.000000000 -0500
+++ amavisd	2004-04-21 21:31:06.000000000 -0500
@@@@ -109,7 +109,7 @@@@ sub fetch_modules($$@@) {
d7 6
a12 6
     fetch_modules('REQUIRED BASIC MODULES', 1, qw(
-	Exporter POSIX Fcntl Socket Errno Carp Time::HiRes
+	Exporter POSIX Fcntl Socket Errno Carp Carp::Heavy Time::HiRes
 	IO::File IO::Socket IO::Socket::UNIX IO::Socket::INET
 	IO::Handle IO::Wrap IO::Stringy
 	Digest::MD5 Unix::Syslog File::Basename File::Copy
@


1.1.1.1
log
@Import amavisd-new 20030616pl9; submitted by Peter Hessler <spambox@@theapt.org>.

amavisd-new is a high-performance interface between mailer (MTA) and
content checkers like SpamAssassin or virus scanners.
ok naddy@@
@
text
@@
