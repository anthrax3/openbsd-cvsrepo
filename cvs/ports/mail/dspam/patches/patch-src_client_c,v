head	1.5;
access;
symbols
	OPENBSD_6_2:1.5.0.16
	OPENBSD_6_2_BASE:1.5
	OPENBSD_6_1:1.5.0.14
	OPENBSD_6_1_BASE:1.5
	OPENBSD_6_0:1.5.0.12
	OPENBSD_6_0_BASE:1.5
	OPENBSD_5_9:1.5.0.8
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.5.0.10
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.5.0.6
	OPENBSD_5_7_BASE:1.5
	OPENBSD_5_6:1.5.0.4
	OPENBSD_5_6_BASE:1.5
	OPENBSD_5_5:1.5.0.2
	OPENBSD_5_5_BASE:1.5
	OPENBSD_5_4:1.4.0.24
	OPENBSD_5_4_BASE:1.4
	OPENBSD_5_3:1.4.0.22
	OPENBSD_5_3_BASE:1.4
	OPENBSD_5_2:1.4.0.20
	OPENBSD_5_2_BASE:1.4
	OPENBSD_5_1_BASE:1.4
	OPENBSD_5_1:1.4.0.18
	OPENBSD_5_0:1.4.0.16
	OPENBSD_5_0_BASE:1.4
	OPENBSD_4_9:1.4.0.14
	OPENBSD_4_9_BASE:1.4
	OPENBSD_4_8:1.4.0.12
	OPENBSD_4_8_BASE:1.4
	OPENBSD_4_7:1.4.0.10
	OPENBSD_4_7_BASE:1.4
	OPENBSD_4_6:1.4.0.8
	OPENBSD_4_6_BASE:1.4
	OPENBSD_4_5:1.4.0.6
	OPENBSD_4_5_BASE:1.4
	OPENBSD_4_4:1.4.0.4
	OPENBSD_4_4_BASE:1.4
	OPENBSD_4_3:1.4.0.2
	OPENBSD_4_3_BASE:1.4
	OPENBSD_4_2:1.3.0.6
	OPENBSD_4_2_BASE:1.3
	OPENBSD_4_1:1.3.0.4
	OPENBSD_4_1_BASE:1.3
	OPENBSD_4_0:1.3.0.2
	OPENBSD_4_0_BASE:1.3
	OPENBSD_3_9:1.1.0.2
	OPENBSD_3_9_BASE:1.1;
locks; strict;
comment	@# @;


1.5
date	2013.09.14.17.12.12;	author landry;	state Exp;
branches;
next	1.4;

1.4
date	2007.12.21.14.42.23;	author todd;	state Exp;
branches;
next	1.3;

1.3
date	2006.04.28.01.13.37;	author brad;	state Exp;
branches;
next	1.2;

1.2
date	2006.03.23.17.17.40;	author todd;	state Exp;
branches;
next	1.1;

1.1
date	2005.10.26.06.18.38;	author jakob;	state Exp;
branches;
next	;


desc
@@


1.5
log
@Update to dspam 3.10.2.

- remove 6 out of the 10 flavors maze, only keep the ones that make
  sense (ie clamav, ldap, domainscale & largescale)
- build pgsql & mysql drivers as subpackages, as $DEITY intended
- @@pkgpath & PFRAG.[flavor]-main tweaks from sthen@@ (thanks!)
- remove init_pwent_cache() patch until i can make some sense of it
- remove painful strlcpy patches
- add patches to fix pgsql support with PSQL > 9.1 from
  http://sourceforge.net/p/dspam/bug-tracker/112/ &
http://sourceforge.net/p/dspam/bug-tracker/141
- add an rc script running dspam --daemon as _dspam
- patch default dspam.conf to trust user _dspam (pointed out by jca@@;
  thanks!) and to use port 2424 by default. Taken from debian.

Discussed at length with todd@@ (MAINTAINER), been running on amd64 with
pgsql &| sqlite backend since a while, also tested on sqlite/ppc.

Some tweaks might still be needed (a README ? Fix some weird crashers ?),
but at least it's better than what we had for the past years.
@
text
@$OpenBSD: patch-src_client_c,v 1.4 2007/12/21 14:42:23 todd Exp $
--- src/client.c.orig	Wed Apr 11 20:48:33 2012
+++ src/client.c	Sun Sep  8 22:16:35 2013
@@@@ -108,7 +108,7 @@@@ int client_process(AGENT_CTX *ATX, buffer *message) {
 
   /* RCPT TO - Send recipient information */
 
-  strcpy(buf, "RCPT TO: ");
+  strlcpy(buf, "RCPT TO: ", sizeof (buf));
   node_nt = c_nt_first(ATX->users, &c_nt);
   while(node_nt != NULL) {
     const char *ptr = (const char *) node_nt->ptr;
@@@@ -211,7 +211,7 @@@@ int client_process(AGENT_CTX *ATX, buffer *message) {
     if (ATX->flags & DAF_SUMMARY)
       head = 1;
 
-    line = client_getline(&TTX, 300);
+    line = client_getline(&TTX, 900);
 
     while(line != NULL && strcmp(line, ".")) {
       chomp(line);
@@@@ -231,13 +231,13 @@@@ int client_process(AGENT_CTX *ATX, buffer *message) {
         printf("%s\n", line);
       } 
       free(line);
-      line = client_getline(&TTX, 300);
+      line = client_getline(&TTX, 900);
       if (line) chomp(line);
     }
     free(line);
   } else {
     for(i=0;i<ATX->users->items;i++) {
-      char *input = client_getline(&TTX, 300);
+      char *input = client_getline(&TTX, 900);
       char *x;
       int code = 500;
 
@@@@ -304,7 +304,7 @@@@ int client_connect(AGENT_CTX *ATX, int flags) {
   struct sockaddr_un saun;
   int sockfd;
   int yes = 1;
-  int port = 24;
+  int port = 2424;
   int domain = 0;
   int addr_len;
   char *host;
@@@@ -354,7 +354,7 @@@@ int client_connect(AGENT_CTX *ATX, int flags) {
   if (domain) {
     sockfd = socket(AF_UNIX, SOCK_STREAM, 0);
     saun.sun_family = AF_UNIX;
-    strcpy(saun.sun_path, host);
+    strlcpy(saun.sun_path, host, sizeof (saun.sun_path));
     addr_len = sizeof(saun.sun_family) + strlen(saun.sun_path) + 1;
 
     LOGDEBUG(INFO_CLIENT_CONNECTING, host, 0);
@@@@ -484,7 +484,7 @@@@ char * client_expect(THREAD_CTX *TTX, int code, char *
   char *inp, *dup, *ptr, *ptrptr;
   int recv_code;
 
-  inp = client_getline(TTX, 300);
+  inp = client_getline(TTX, 900);
   while(inp != NULL) {
     recv_code = 0;
     dup = strdup(inp);
@@@@ -508,7 +508,7 @@@@ char * client_expect(THREAD_CTX *TTX, int code, char *
     
     strlcpy(err, inp, len);
     free(inp);
-    inp = client_getline(TTX, 300);
+    inp = client_getline(TTX, 900);
   }
 
   return NULL;
@@@@ -553,13 +553,13 @@@@ int client_getcode(THREAD_CTX *TTX, char *err, size_t 
   char *inp, *ptr, *ptrptr = NULL;
   int i;
 
-  inp = client_getline(TTX, 300);
+  inp = client_getline(TTX, 900);
   if (!inp)
     return EFAILURE;
 
   while(inp && !strncmp(inp, "250-", 4)) {
     free(inp);
-    inp = client_getline(TTX, 300);
+    inp = client_getline(TTX, 900);
   }
 
   strlcpy(err, inp, len);
@


1.4
log
@o update to dspam 3.8.0 mostly from brad@@
o fix dspamc that was busted in the 3.8.0 release, verified to work via testing
@
text
@d1 3
a3 3
$OpenBSD: patch-src_client_c,v 1.3 2006/04/28 01:13:37 brad Exp $
--- src/client.c.orig	Thu May 25 17:36:39 2006
+++ src/client.c	Sun Apr 29 17:57:52 2007
d13 1
a13 1
@@@@ -170,7 +170,7 @@@@ int client_process(AGENT_CTX *ATX, buffer *message) {
d22 2
a23 2
@@@@ -192,7 +192,7 @@@@ int client_process(AGENT_CTX *ATX, buffer *message) {
           break;
a30 2
@@@@ -200,7 +200,7 @@@@ int client_process(AGENT_CTX *ATX, buffer *message) {
       goto BAIL;
d38 10
a47 1
@@@@ -313,7 +313,7 @@@@ int client_connect(AGENT_CTX *ATX, int flags) {
d56 1
a56 1
@@@@ -443,7 +443,7 @@@@ char * client_expect(THREAD_CTX *TTX, int code, char *
d65 1
a65 1
@@@@ -467,7 +467,7 @@@@ char * client_expect(THREAD_CTX *TTX, int code, char *
d74 2
a75 2
@@@@ -512,13 +512,13 @@@@ int client_getcode(THREAD_CTX *TTX, char *err, size_t 
   char *inp, *ptr, *ptrptr;
@


1.3
log
@upgrade to dspam 3.6.5; from Frank Denis
@
text
@d1 4
a4 4
$OpenBSD: patch-src_client_c,v 1.2 2006/03/23 17:17:40 todd Exp $
--- src/client.c.orig	Wed Feb 15 21:06:35 2006
+++ src/client.c	Thu Apr 27 10:03:28 2006
@@@@ -108,7 +108,7 @@@@ int client_process(AGENT_CTX *ATX, buffe
d13 1
a13 1
@@@@ -170,7 +170,7 @@@@ int client_process(AGENT_CTX *ATX, buffe
d22 1
a22 1
@@@@ -192,7 +192,7 @@@@ int client_process(AGENT_CTX *ATX, buffe
d31 1
a31 1
@@@@ -200,7 +200,7 @@@@ int client_process(AGENT_CTX *ATX, buffe
d40 1
a40 1
@@@@ -313,7 +313,7 @@@@ int client_connect(AGENT_CTX *ATX, int f
d49 1
a49 1
@@@@ -443,7 +443,7 @@@@ char * client_expect(THREAD_CTX *TTX, in
d58 1
a58 1
@@@@ -467,7 +467,7 @@@@ char * client_expect(THREAD_CTX *TTX, in
d67 1
a67 1
@@@@ -512,13 +512,13 @@@@ int client_getcode(THREAD_CTX *TTX, char
@


1.2
log
@take maintainership, ok jakob@@
update to 3.6.4
(see http://dspam.nuclearelephant.com/text/RELEASE-3.6.4.txt for details)
Additionally:
- fix a typo in a printf
- give postgresql a chance of decent performance
- timeout at 15min not 5min per message by default
@
text
@d1 3
a3 3
$OpenBSD: patch-src_client_c,v 1.1 2005/10/26 06:18:38 jakob Exp $
--- src/client.c.orig	Tue Jan 31 14:25:46 2006
+++ src/client.c	Mon Mar  6 17:08:36 2006
d13 3
a15 3
@@@@ -165,7 +165,7 @@@@ int client_process(AGENT_CTX *ATX, buffe
     char *line = NULL;
     int head = !(ATX->flags & DAF_STDOUT);
d22 2
a23 2
@@@@ -185,7 +185,7 @@@@ int client_process(AGENT_CTX *ATX, buffe
         printf("%s\n", line);
d31 1
a31 1
@@@@ -193,7 +193,7 @@@@ int client_process(AGENT_CTX *ATX, buffe
d40 1
a40 1
@@@@ -306,7 +306,7 @@@@ int client_connect(AGENT_CTX *ATX, int f
d49 1
a49 1
@@@@ -436,7 +436,7 @@@@ char * client_expect(THREAD_CTX *TTX, in
d58 1
a58 1
@@@@ -460,7 +460,7 @@@@ char * client_expect(THREAD_CTX *TTX, in
d67 1
a67 1
@@@@ -505,13 +505,13 @@@@ int client_getcode(THREAD_CTX *TTX, char
@


1.1
log
@upgrade to dspam 3.6.0; work by Frank Denis, tested by several
@
text
@d1 3
a3 3
$OpenBSD$
--- src/client.c.orig	Sat Sep 24 19:49:48 2005
+++ src/client.c	Mon Oct 17 14:48:42 2005
d13 28
a40 1
@@@@ -308,7 +308,7 @@@@ int client_connect(AGENT_CTX *ATX, int f
d49 34
@

