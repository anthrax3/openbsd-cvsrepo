head	1.12;
access;
symbols
	OPENBSD_6_1:1.8.0.2
	OPENBSD_6_1_BASE:1.8
	OPENBSD_5_5:1.6.0.2
	OPENBSD_5_5_BASE:1.6
	OPENBSD_5_0:1.1.1.1.0.2
	OPENBSD_5_0_BASE:1.1.1.1
	ajacoutot:1.1.1.1
	ajacoutot_20110714:1.1.1;
locks; strict;
comment	@# @;


1.12
date	2017.05.24.08.43.04;	author ajacoutot;	state Exp;
branches;
next	1.11;
commitid	oKhfCEYopHQenJBw;

1.11
date	2017.05.24.07.08.59;	author ajacoutot;	state Exp;
branches;
next	1.10;
commitid	XLOvtQFa5H1sKzbJ;

1.10
date	2017.05.23.21.00.59;	author espie;	state Exp;
branches;
next	1.9;
commitid	J09JUMYe8hKleOaL;

1.9
date	2017.04.17.16.53.25;	author ajacoutot;	state Exp;
branches;
next	1.8;
commitid	Br2ko1ssz482vH39;

1.8
date	2016.10.31.12.34.30;	author ajacoutot;	state Exp;
branches;
next	1.7;
commitid	Oim47EmaZJp8Ob8Y;

1.7
date	2014.03.28.06.56.25;	author ajacoutot;	state dead;
branches;
next	1.6;

1.6
date	2013.12.15.08.42.41;	author ajacoutot;	state Exp;
branches;
next	1.5;

1.5
date	2011.10.07.08.22.04;	author ajacoutot;	state dead;
branches;
next	1.4;

1.4
date	2011.09.22.10.55.13;	author jasper;	state Exp;
branches;
next	1.3;

1.3
date	2011.09.22.10.33.00;	author jasper;	state Exp;
branches;
next	1.2;

1.2
date	2011.09.12.07.26.19;	author ajacoutot;	state dead;
branches;
next	1.1;

1.1
date	2011.07.14.05.33.45;	author ajacoutot;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2011.07.14.05.33.45;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.12
log
@Upstream actually fixed it 2 years ago.
@
text
@$OpenBSD: patch-src_rss_c,v 1.11 2017/05/24 07:08:59 ajacoutot Exp $

From c78ce3988f68d030b01723fa33ebb64d7a86ed7d Mon Sep 17 00:00:00 2001
From: Milan Crha <mcrha@@redhat.com>
Date: Tue, 8 Nov 2016 15:56:44 +0100
Subject: Bug 764065 - [Camel] Port more classes to GObject

From 7741ef0cf3327cb5c719912358443b6aef3bdb59 Mon Sep 17 00:00:00 2001
From: Milan Crha <mcrha@@redhat.com>
Date: Wed, 17 Aug 2016 18:43:48 +0200
Subject: Adapt to changes in evolution 3.21.90

From bdeee6ed97b7dce337bc145e3e060214fe963cf9 Mon Sep 17 00:00:00 2001
From: Lucian Langa <lucilanga@@gnome.org>
Date: Tue, 20 Oct 2015 00:33:05 +0200
Subject: various cleanups III

Index: src/rss.c
--- src/rss.c.orig
+++ src/rss.c
@@@@ -1302,15 +1302,24 @@@@ org_gnome_evolution_presend (EPlugin *ep, EMEventTarge
 
 #if EVOLUTION_VERSION >= 31303
 	EHTMLEditor *editor;
+#if EVOLUTION_VERSION >= 32190
+	EContentEditor *cnt_editor;
+#else
 	EHTMLEditorView *view;
+#endif
 
 	editor = e_msg_composer_get_editor (t->composer);
+#if EVOLUTION_VERSION >= 32190
+	cnt_editor = e_html_editor_get_content_editor (editor);
+	text = e_content_editor_get_content (cnt_editor, E_CONTENT_EDITOR_GET_TEXT_HTML, NULL, NULL);
+#else
 	view = e_html_editor_get_view (editor);
 #if EVOLUTION_VERSION >= 31390
 	text = e_html_editor_view_get_text_html (view, NULL, NULL);
 #else
 	text = e_html_editor_view_get_text_html (view);
 #endif
+#endif /* EVOLUTION_VERSION >= 32190 */
 	length = strlen (text);
 #else
 	/* unfortunately e_msg_composer does not have raw get/set text body
@@@@ -1328,8 +1337,17 @@@@ org_gnome_evolution_presend (EPlugin *ep, EMEventTarge
 		g_free (text);
 		text = g_strndup ((gchar *) buff, size);
 		editor = e_msg_composer_get_editor (t->composer);
+#if EVOLUTION_VERSION >= 32190
+		cnt_editor = e_html_editor_get_content_editor (editor);
+		e_content_editor_insert_content (
+			cnt_editor,
+			text,
+			E_CONTENT_EDITOR_INSERT_TEXT_HTML |
+			E_CONTENT_EDITOR_INSERT_REPLACE_ALL);
+#else
 		view = e_html_editor_get_view (editor);
 		e_html_editor_view_set_text_html (view, text);
+#endif
 #else
 		gtkhtml_editor_set_text_html((GtkhtmlEditor *)t->composer, (gchar *)buff, size);
 #endif
@@@@ -3933,7 +3951,8 @@@@ create_mail(create_feed *CF)
 #endif
 
 	info = camel_message_info_new(NULL);
-	camel_message_info_set_flags(info, CAMEL_MESSAGE_SEEN, 1);
+	/* Unset the Seen flag, thus the messages are marked as new/unread */
+	camel_message_info_set_flags(info, CAMEL_MESSAGE_SEEN, 0);
 
 	tmp = decode_entities(CF->subj);
 	tmp2 = markup_decode(tmp);
@@@@ -4221,7 +4240,11 @@@@ out:
 	camel_object_unref(mail_folder);
 #endif
 #if (DATASERVER_VERSION >= 3011001)
+	#if (DATASERVER_VERSION >= 3023002)
+	g_clear_object (&info);
+	#else
 	camel_message_info_unref(info);
+	#endif
 #else
 	camel_message_info_free(info);
 #endif
@@@@ -4356,7 +4379,7 @@@@ process_attachments(create_feed *CF)
 	gdouble emax;
 	guint proc = 0;
 
-	g_return_if_fail(CF->attachments != NULL);
+	g_return_val_if_fail(CF->attachments != NULL, FALSE);
 
 	do {
 		if (!strlen(l->data))
@@@@ -4699,10 +4722,18 @@@@ delete_oldest_article(CamelFolder *folder, guint unrea
 		if (info) {
 			if (rf->current_uid && !strcmp(rf->current_uid, uids->pdata[i]))
 				goto out;
+			#if (DATASERVER_VERSION >= 3023002)
+			date = camel_message_info_get_date_sent (info);
+			#else
 			date = camel_message_info_date_sent(info);
+			#endif
 			if (!date)
 				goto out;
+			#if (DATASERVER_VERSION >= 3023002)
+			flags = camel_message_info_get_flags (info);
+			#else
 			flags = camel_message_info_flags(info);
+			#endif
 			if (flags & CAMEL_MESSAGE_FLAGGED)
 				goto out;
 			if (flags & CAMEL_MESSAGE_DELETED)
@@@@ -4735,7 +4766,11 @@@@ delete_oldest_article(CamelFolder *folder, guint unrea
 //			i, j, q, min_date, ctime(&min_date), imax);
 out:
 #if (DATASERVER_VERSION >= 3011001)
+		#if (DATASERVER_VERSION >= 3023002)
+		g_clear_object (&info);
+		#else
 		camel_message_info_unref(info);
+		#endif
 #else
 		camel_message_info_free(info);
 #endif
@@@@ -4822,7 +4857,11 @@@@ get_feed_age(RDF *r, gpointer name)
 			}
 			if (!match) {
 				info = camel_folder_get_message_info(folder, uids->pdata[i]);
+				#if (DATASERVER_VERSION >= 3023002)
+				flags = camel_message_info_get_flags (info);
+				#else
 				flags = camel_message_info_flags(info);
+				#endif
 				if ((del_unread) && !(flags & CAMEL_MESSAGE_FLAGGED)) {
 					gchar *feed_dir, *feed_name;
 					camel_folder_delete_message(folder, uids->pdata[i]);
@@@@ -4835,7 +4874,11 @@@@ get_feed_age(RDF *r, gpointer name)
 					g_free(feed_name);
 				}
 #if (DATASERVER_VERSION >= 3011001)
+				#if (DATASERVER_VERSION >= 3023002)
+				g_clear_object (&info);
+				#else
 				camel_message_info_unref(info);
+				#endif
 #else
 				camel_folder_free_message_info(folder, info);
 #endif
@@@@ -4864,9 +4907,17 @@@@ get_feed_age(RDF *r, gpointer name)
 			if (info == NULL)
 				continue;
 			if (rf->current_uid && strcmp(rf->current_uid, uids->pdata[i])) {
+				#if (DATASERVER_VERSION >= 3023002)
+				date = camel_message_info_get_date_sent (info);
+				#else
 				date = camel_message_info_date_sent(info);
+				#endif
 				if (date < now - del_days * 86400) {
+					#if (DATASERVER_VERSION >= 3023002)
+					flags = camel_message_info_get_flags (info);
+					#else
 					flags = camel_message_info_flags(info);
+					#endif
 					if (!(flags & CAMEL_MESSAGE_SEEN)) {
 						if ((del_unread) && !(flags & CAMEL_MESSAGE_FLAGGED)) {
 							camel_folder_delete_message(folder, uids->pdata[i]);
@@@@ -4878,7 +4929,11 @@@@ get_feed_age(RDF *r, gpointer name)
 				}
 			}
 #if (DATASERVER_VERSION >= 3011001)
+			#if (DATASERVER_VERSION >= 3023002)
+			g_clear_object (&info);
+			#else
 			camel_message_info_unref(info);
+			#endif
 #else
 			camel_folder_free_message_info(folder, info);
 #endif
@


1.11
log
@Add a comment or this chunk will be lost at next update for sure.
@
text
@d1 1
a1 3
$OpenBSD: patch-src_rss_c,v 1.10 2017/05/23 21:00:59 espie Exp $

Fix build with clang: g_return_if_fail -> g_return_val_if_fail
d12 5
@


1.10
log
@return value
@
text
@d1 3
a3 1
$OpenBSD: patch-src_rss_c,v 1.9 2017/04/17 16:53:25 ajacoutot Exp $
@


1.9
log
@Unbreak with the new evolution stack (from upstream).
@
text
@d1 1
a1 1
$OpenBSD: patch-src_rss_c,v 1.8 2016/10/31 12:34:30 ajacoutot Exp $
d13 3
a15 2
--- src/rss.c.orig	Mon Apr 17 18:45:46 2017
+++ src/rss.c	Mon Apr 17 18:45:42 2017
d81 9
@


1.8
log
@Adapt to changes in evolution 3.21.90 (upstream).
@
text
@d1 6
a6 1
$OpenBSD$
d13 2
a14 2
--- src/rss.c.orig	Thu Mar 26 09:41:11 2015
+++ src/rss.c	Mon Oct 31 13:19:55 2016
d57 107
@


1.7
log
@Unbreak with new evolution and evolution-data-server.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_rss_c,v 1.6 2013/12/15 08:42:41 ajacoutot Exp $
d3 4
a6 4
From 87ae939abd5ef896130bab49d84660309a1826d1 Mon Sep 17 00:00:00 2001
From: Lucian Langa <lucilanga@@gnome.org>
Date: Wed, 09 Oct 2013 20:32:38 +0000
Subject: adapt to Camel changes
d8 8
a15 8
--- src/rss.c.orig	Thu Aug 29 10:10:04 2013
+++ src/rss.c	Sun Dec 15 09:32:24 2013
@@@@ -4134,7 +4134,11 @@@@ create_mail(create_feed *CF)
 	camel_object_unref(new);
 	camel_object_unref(mail_folder);
 #endif
+#if (DATASERVER_VERSION >= 3011001)
+	camel_message_info_unref(info);
d17 1
a17 1
 	camel_message_info_free(info);
a18 2
 	g_free(buf);
 }
d20 4
a23 8
@@@@ -4593,7 +4597,12 @@@@ delete_oldest_article(CamelFolder *folder, guint unrea
 		}
 //		d("uid:%d j:%d/%d, absdate:%d, date:%s, imax:%d\n",
 //			i, j, q, min_date, ctime(&min_date), imax);
-out:		camel_message_info_free(info);
+out:
+#if (DATASERVER_VERSION >= 3011001)
+		camel_message_info_unref(info);
d25 21
a45 11
+		camel_message_info_free(info);
+#endif
 	}
 	camel_folder_freeze(folder);
 	if (min_date) {
@@@@ -4689,7 +4698,11 @@@@ get_feed_age(RDF *r, gpointer name)
 						feedid);
 					g_free(feed_name);
 				}
+#if (DATASERVER_VERSION >= 3011001)
+				camel_message_info_unref(info);
d47 2
a48 1
 				camel_folder_free_message_info(folder, info);
d50 3
a52 15
 			}
 #if (DATASERVER_VERSION >= 2031001)
 			g_object_unref (message);
@@@@ -4728,7 +4741,11 @@@@ get_feed_age(RDF *r, gpointer name)
 						}
 				}
 			}
+#if (DATASERVER_VERSION >= 3011001)
+			camel_message_info_unref(info);
+#else
 			camel_folder_free_message_info(folder, info);
+#endif
 		}
 		camel_folder_free_uids (folder, uids);
 #if (DATASERVER_VERSION >= 2033001)
@


1.6
log
@Adapt to Camel changes (upstream).
@
text
@d1 1
a1 1
$OpenBSD$
@


1.5
log
@Update to a newer git snapshot.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_rss_c,v 1.4 2011/09/22 10:55:13 jasper Exp $
d3 1
a3 1
From 62d6e9a7a68dc90abd244431afb47de9826cb423 Mon Sep 17 00:00:00 2001
d5 2
a6 2
Date: Thu, 07 Jul 2011 20:34:45 +0000
Subject: Avoid camel_stream_printf().
d8 5
a12 9
--- src/rss.c.orig	Sun Jun 19 17:27:29 2011
+++ src/rss.c	Thu Sep 22 12:43:43 2011
@@@@ -2174,6 +2174,7 @@@@ void org_gnome_cooly_format_rss(void *ep, EMFormatHook
 	GdkPixbuf *pix;
 	gchar *feed_dir, *feed_file, *iconfile;
 	gchar *tmp_path, *tmp_file;
+	gchar *str;
 #if EVOLUTION_VERSION >= 22900 //kb//
 	GdkColor color;
d14 7
a20 13
@@@@ -2261,10 +2262,11 @@@@ void org_gnome_cooly_format_rss(void *ep, EMFormatHook
 	pobj->website = g_strstrip(g_strdup((gchar *)website));
 	pobj->stream = t->stream;
 	pobj->object.free = free_rss_controls;
-	camel_stream_printf (
-		t->stream,
+	str = g_strdup_printf (
 		"<object classid=%s></object>\n",
 		classid);
+	camel_stream_write_string (t->stream, str, NULL, NULL);
+	g_free(str);
 	g_free (classid);
 
d22 1
a22 20
@@@@ -2288,14 +2290,18 @@@@ void org_gnome_cooly_format_rss(void *ep, EMFormatHook
 			pobj->format = (EMFormatHTML *)t->format;
 			pobj->object.free = free_rss_browser;
 			pobj->part = t->part;
-			camel_stream_printf(t->stream,
+			str = g_strdup_printf (
 				"<table style=\"border: solid #%06x 1px; background-color: #%06x; color: #%06x;\" cellpadding=1 cellspacing=0><tr><td align=center>",
 				frame_colour & 0xffffff,
 				frame_colour & 0xffffff,
 				text_colour & 0xffffff);
-			camel_stream_printf (t->stream,
+			camel_stream_write_string (t->stream, str, NULL, NULL);
+			g_free (str);
+			str = g_strdup_printf (
 				"<object classid=%s></object></td></tr></table>",//</div>\n",
 				classid);
+			camel_stream_write_string (t->stream, str, NULL, NULL);
+			g_free (str);
 			g_free (classid);
 			goto out;
d24 26
a49 177
@@@@ -2306,16 +2312,17 @@@@ void org_gnome_cooly_format_rss(void *ep, EMFormatHook
 			//we do not need to setup a pop error menu since we're in
 			//formatting process. But instead display mail body an error
 			//such proxy error or transport error
-			camel_stream_printf (t->stream,
+			str = g_strdup_printf (
 				"<div style=\"border: solid #%06x 1px; background-color: #%06x; color: #%06x;\">\n",
 				frame_colour & 0xffffff,
 				content_colour & 0xffffff,
 				text_colour & 0xffffff);
-			camel_stream_printf(t->stream,
-				"<div style=\"border: solid 0px; padding: 4px;\">\n");
-			camel_stream_printf (t->stream, "<h3>Error!</h3>");
-			camel_stream_printf (t->stream, "%s", err->message);
-			camel_stream_printf (t->stream, "</div>");
+			camel_stream_write_string (t->stream, str, NULL, NULL);
+			g_free (str);
+			camel_stream_write_string (t->stream, "<div style=\"border: solid 0px; padding: 4px;\">\n", NULL, NULL);
+			camel_stream_write_string (t->stream, "<h3>Error!</h3>", NULL, NULL);
+			camel_stream_write_string (t->stream, err->message, NULL, NULL);
+			camel_stream_write_string (t->stream, "</div>", NULL, NULL);
 			goto out;
 		}
 
@@@@ -2329,30 +2336,39 @@@@ void org_gnome_cooly_format_rss(void *ep, EMFormatHook
 		} else
 			goto out;
 
-		camel_stream_printf (fstream,
+		str = g_strdup_printf (
 			"<div style=\"border: solid #%06x 1px; background-color: #%06x; color: #%06x;\">\n",
 			frame_colour & 0xffffff,
 			content_colour & 0xffffff,
 			text_colour & 0xffffff);
-		camel_stream_printf (fstream,
+		camel_stream_write_string (fstream, str, NULL, NULL);
+		g_free (str);
+		str = g_strdup_printf (
 			"<div style=\"border: solid 0px; background-color: #%06x; padding: 2px; color: #%06x;\">"
 			"<b><font size=+1><a href=%s>%s</a></font></b></div>",
 			content_colour & 0xEDECEB & 0xffffff,
 			text_colour & 0xffffff,
 			website, subject);
-		if (category)
-			camel_stream_printf(fstream,
+		camel_stream_write_string (fstream, str, NULL, NULL);
+		g_free (str);
+		if (category) {
+			str = g_strdup_printf (
 				"<div style=\"border: solid 0px; background-color: #%06x; padding: 2px; color: #%06x;\">"
 				"<b><font size=-1>%s: %s</font></b></div>",
 				content_colour & 0xEDECEB & 0xffffff, text_colour & 0xffffff,
 				_("Posted under"), category);
-		camel_stream_printf (fstream,
+			camel_stream_write_string (fstream, str, NULL, NULL);
+			g_free (str);
+		}
+		str = g_strdup_printf (
 				"<div style=\"border: solid #%06x 0px; background-color: #%06x; padding: 2px; color: #%06x;\">"
 				"%s</div>",
 				frame_colour & 0xffffff,
 				content_colour & 0xffffff,
 				text_colour & 0xffffff,
 				buff);
+		camel_stream_write_string (fstream, str, NULL, NULL);
+		g_free (str);
 
 		g_string_free(content, 1);
 	} else {
@@@@ -2479,15 +2495,16 @@@@ pixdone:			g_free(real_image);
 		feed_file = g_strdup(tmp_path);
 #endif
 
-		camel_stream_printf (
-			fstream,
+		str = g_strdup_printf (
 			"<div style=\"border: solid #%06x 1px; background-color: #%06x; padding: 2px; color: #%06x;\">",
 			frame_colour & 0xffffff,
 			content_colour & 0xEDECEB & 0xffffff,
 			text_colour & 0xffffff);
+		camel_stream_write_string (fstream, str, NULL, NULL);
+		g_free (str);
 		if (g_file_test(tmp_path, G_FILE_TEST_EXISTS)){
 			if ((pixbuf = gdk_pixbuf_new_from_file(tmp_path, NULL))) {
-				camel_stream_printf (fstream,
+				str = g_strdup_printf (
 					"<div style=\"border: solid 0px; background-color: #%06x; padding: 2px; color: #%06x;\">"
 					"<img height=16 src=%s>"
 					"<b><font size=+1><a href=%s>%s</a></font></b></div>",
@@@@ -2496,6 +2513,8 @@@@ pixdone:			g_free(real_image);
 					feed_file,
 					website,
 					subject);
+				camel_stream_write_string (fstream, str, NULL, NULL);
+				g_free (str);
 				g_object_unref(pixbuf);
 				g_free(feed_file);
 				goto render_body;
@@@@ -2511,38 +2530,47 @@@@ pixdone:			g_free(real_image);
 		iconfile = g_strdup(tmp_file);
 #endif
 		g_free(tmp_file);
-		camel_stream_printf (fstream,
+		str = g_strdup_printf (
 			"<div style=\"border: solid 0px; background-color: #%06x; padding: 2px; color: #%06x;\">"
 			"<img height=16 src=%s>"
 			"<b><font size=+1><a href=%s>%s</a></font></b></div>",
 			content_colour & 0xEDECEB & 0xffffff, text_colour & 0xffffff,
 			iconfile, website, subject);
+		camel_stream_write_string (fstream, str, NULL, NULL);
+		g_free (str);
 		g_free(iconfile);
 		g_free(feed_file);
 
-render_body:	if (category)
-			camel_stream_printf(fstream,
+render_body:	if (category) {
+			str = g_strdup_printf (
 				"<div style=\"border: solid 0px; background-color: #%06x; padding: 2px; color: #%06x;\">"
 				"<b><font size=-1>Posted under: %s</font></b></div>",
 				content_colour & 0xEDECEB & 0xffffff,
 				text_colour & 0xffffff,
 				category);
-		camel_stream_printf (fstream,
-				"<div style=\"border: solid #%06x 0px; background-color: #%06x; padding: 10px; color: #%06x;\">"
-				"%s</div>",
-				frame_colour & 0xffffff,
-				content_colour & 0xffffff,
-				text_colour & 0xffffff,
-				buff);
+			camel_stream_write_string (fstream, str, NULL, NULL);
+			g_free (str);
+		}
+		str = g_strdup_printf (
+			"<div style=\"border: solid #%06x 0px; background-color: #%06x; padding: 10px; color: #%06x;\">"
+			"%s</div>",
+			frame_colour & 0xffffff,
+			content_colour & 0xffffff,
+			text_colour & 0xffffff,
+			buff);
+		camel_stream_write_string (fstream, str, NULL, NULL);
+		g_free (str);
 		if (comments && gconf_client_get_bool (rss_gconf,
 						GCONF_KEY_SHOW_COMMENTS,
 						NULL)) {
 			if (commstream) {
-				camel_stream_printf (fstream,
+				str = g_strdup_printf (
 					"<div style=\"border: solid #%06x 0px; background-color: #%06x; padding: 2px; color: #%06x;\">",
 					frame_colour & 0xffffff,
 					content_colour & 0xEDECEB & 0xffffff,
 					text_colour & 0xffffff);
+				camel_stream_write_string (fstream, str, NULL, NULL);
+				g_free (str);
 				result = print_comments(comments, commstream, (EMFormatHTML *)t->format);
 				g_free(commstream);
 				rfrclsid = g_strdup_printf ("org-gnome-rss-controls-%d",
@@@@ -2558,15 +2586,19 @@@@ render_body:	if (category)
 				pobj->website = g_strdup(comments);
 				//this might not be needed but we want to make sure po->html is destroyed
 				pobj->object.free = free_rss_controls;
-				camel_stream_printf(fstream,
+				str = g_strdup_printf (
 					"<object height=25 classid=%s></object>", rfrclsid);
+				camel_stream_write_string (fstream, str, NULL, NULL);
+				g_free (str);
 				if (result && strlen(result)) {
-					camel_stream_printf(fstream,
+					str = g_strdup_printf (
 					"<div style=\"border: solid #%06x 0px; background-color: #%06x; padding: 10px; color: #%06x;\">%s",
 						frame_colour & 0xffffff,
 						content_colour & 0xffffff,
 						text_colour & 0xffffff,
 						result);
+					camel_stream_write_string (fstream, str, NULL, NULL);
+					g_free (str);
 					g_free(result);
a50 4
 				g_free(rfrclsid);
@@@@ -2576,9 +2608,9 @@@@ render_body:	if (category)
 						rf->hr, g_strstrip(feedid)));
 				fetch_comments(comments, g_strdup(uri), (EMFormatHTML *)t->format);
d52 5
a56 2
-			camel_stream_printf (fstream, "</div>");
+			camel_stream_write_string (fstream, "</div>", NULL, NULL);
d58 1
a58 38
-		camel_stream_printf (fstream, "</div>");
+		camel_stream_write_string (fstream, "</div>", NULL, NULL);
 	}
 
 	//this is required for proper charset rendering when html
@@@@ -2617,16 +2649,19 @@@@ out:	if (addr)
 		g_free(addr);
 	return;
 fmerror:
-	camel_stream_printf (t->stream,
+	str = g_strdup_printf (
 		"<div style=\"border: solid #%06x 1px; background-color: #%06x; color: #%06x;\">\n",
 		frame_colour & 0xffffff, content_colour & 0xffffff, text_colour & 0xffffff);
-	camel_stream_printf(t->stream,
-		"<div style=\"border: solid 0px; padding: 4px;\">\n");
-	camel_stream_printf (t->stream,
+	camel_stream_write_string (t->stream, str, NULL, NULL);
+	g_free (str);
+	camel_stream_write_string (t->stream,
+		"<div style=\"border: solid 0px; padding: 4px;\">\n",
+		NULL, NULL);
+	camel_stream_write_string (t->stream,
 		"<h3>Formatting error!</h3>"
-		"Feed article corrupted! Cannot format article.");
-	camel_stream_printf (t->stream,
-		"</div></div>");
+                "Feed article corrupted! Cannot format article.",
+		NULL, NULL);
+	camel_stream_write_string (t->stream, "</div></div>", NULL, NULL);
 	return;
 }
 
@@@@ -5139,7 +5174,7 @@@@ create_mail(create_feed *CF)
 	camel_content_type_unref (type);
 	stream = camel_stream_mem_new ();
 	// w/out an format argument this throws and seg fault
-	camel_stream_printf (stream, "%s", CF->body);
+	camel_stream_write_string (stream, CF->body, NULL, NULL);
a59 2
 	/*FIXME may block */
 	camel_data_wrapper_construct_from_stream_sync (rtext, stream, NULL, NULL);
@


1.4
log
@properly fix with gtk3 and latest evolution
@
text
@d1 1
a1 1
$OpenBSD$
@


1.3
log
@start making this a bit happier with gtk3, still needs others fixes
@
text
@d3 4
a6 4
From 780e196eb0e7cbeda56413bfdb9654c83372eae3 Mon Sep 17 00:00:00 2001
From: Dominique Leuenberger <dimstar@@opensuse.org>
Date: Mon, 22 Aug 2011 21:28:38 +0000
Subject: Bug 656126 - evolution-rss uses deprecated tk_[hv]box_new
d9 271
a279 33
+++ src/rss.c	Thu Sep 22 12:25:51 2011
@@@@ -1387,11 +1387,7 @@@@ webkit_net_status (WebKitWebView *view,
 				if (resize_pane_hsize+14 > width && width != 1) {
 					gtk_widget_set_size_request(rf->mozembed,
 						-1, -1);
-#if GTK_MAJOR_VERSION < 3
-					gtk_widget_size_request(rf->mozembed, &req);
-#else
 					gtk_widget_get_preferred_size(rf->mozembed, &req, NULL);
-#endif
 
 					if (req.width < resize_pane_hsize+14)
 						w = resize_pane_hsize-14;
@@@@ -1908,7 +1904,7 @@@@ org_gnome_rss_rfrcomm (EMFormatHTML *efh, void *eb,
 {
 	struct _org_gnome_rss_controls_pobject *po =
 			(struct _org_gnome_rss_controls_pobject *) pobject;
-	GtkWidget *hbox = gtk_hbox_new (FALSE, 0);
+	GtkWidget *hbox = gtk_box_new (GTK_ORIENTATION_HORIZONTAL, 0);
 	GtkWidget *button;
 
 	gchar *mem = g_strdup_printf("%s(%d):",  _("Comments"), po->counter);
@@@@ -1931,8 +1927,8 @@@@ org_gnome_rss_controls (EMFormatHTML *efh, void *eb, E
 {
 	struct _org_gnome_rss_controls_pobject *po =
 			(struct _org_gnome_rss_controls_pobject *) pobject;
-	GtkWidget *vbox = gtk_vbox_new (TRUE, 1);
-	GtkWidget *hbox2 = gtk_hbox_new (FALSE, 0);
+	GtkWidget *vbox = gtk_box_new (GTK_ORIENTATION_VERTICAL, 1);
+	GtkWidget *hbox2 = gtk_box_new (GTK_ORIENTATION_HORIZONTAL, 0);
 	GtkWidget *label3 = gtk_label_new ("");
 	GtkWidget *button, *button2, *button3, *button4, *button5;
 	gchar *mem = g_strdup_printf(" <b>%s: </b>", _("Feed view"));
@


1.2
log
@Start the GNOME3 merge armageddon... breakage expected.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_rss_c,v 1.1 2011/07/14 05:33:45 ajacoutot Exp $
d3 4
a6 5
Revert:
From 7d264518c2c6741e81842e7c4e6ba62f9f9a240b Mon Sep 17 00:00:00 2001
From: Lucian Langa <lucilanga@@gnome.org>
Date: Fri, 28 Jan 2011 16:57:36 +0000
Subject: allow to select feed location from properties menu
d8 8
a15 194
From 47391941bbfe48229a707fdd27c541ae10995cd1 Mon Sep 17 00:00:00 2001
From: Antoine Jacoutot <ajacoutot@@openbsd.org>
Date: Fri, 22 Apr 2011 21:31:53 +0000
Subject: Bug 648475 - missing webkit ifdef breaks compilation

--- src/rss.c.orig	Fri Apr 22 17:44:56 2011
+++ src/rss.c	Mon Apr 25 08:09:34 2011
@@@@ -411,6 +411,7 @@@@ update_progress_text(gchar *title)
 	}
 }
 
+#ifdef HAVE_WEBKIT
 void
 rss_webkit_load_string(gchar *str, gchar *base, gchar *encoding)
 {
@@@@ -423,6 +424,7 @@@@ rss_webkit_load_string(gchar *str, gchar *base, gchar 
 	if (strncmp(base, "file:///fake", 12))
 		webkit_set_history(base);
 }
+#endif
 
 void
 update_progress_bar(guint current);
@@@@ -456,11 +458,15 @@@@ update_progress_bar(guint current)
 void
 browser_write(gchar *string, gint length, gchar *base)
 {
-	WEBKITNET *wknet;
-	gchar *str = string;
 	guint engine = fallback_engine();
+#if defined(HAVE_GECKO) || defined (HAVE_WEBKIT)
 	xmlDoc *src = (xmlDoc *)parse_html(base, string, length);
 	gchar *encoding =  (gchar *)htmlGetMetaEncoding(src);
+	gchar *str = string;
+#endif
+#ifdef HAVE_WEBKIT
+	WEBKITNET *wknet;
+#endif
 	switch (engine) {
 	case 2:
 #ifdef HAVE_GECKO
@@@@ -504,8 +510,11 @@@@ void
 browser_stream_write(CamelStream *stream, gchar *base)
 {
 	GString *str = g_string_new(NULL);
-	gchar *line, *encoding;
+	gchar *line;
+#ifdef HAVE_WEBKIT
+	gchar *encoding;
 	xmlDoc *src;
+#endif
 
 	CamelStream *in = camel_stream_buffer_new(stream, CAMEL_STREAM_BUFFER_READ);
 #if (DATASERVER_VERSION >= 2033001)
@@@@ -518,10 +527,10 @@@@ browser_stream_write(CamelStream *stream, gchar *base)
 		g_free(tmp);
 		line = NULL;
 	}
-	src = (xmlDoc *)parse_html(base, str->str, str->len);
-	encoding =  (gchar *)htmlGetMetaEncoding(src);
 #ifdef HAVE_WEBKIT
 #if (WEBKIT_VERSION >= 1001001)
+	src = (xmlDoc *)parse_html(base, str->str, str->len);
+	encoding =  (gchar *)htmlGetMetaEncoding(src);
 	webkit_web_view_load_string(
 		WEBKIT_WEB_VIEW(rf->mozembed),
 		str->str,
@@@@ -943,6 +952,8 @@@@ rss_select_folder(gchar *folder_name)
 	const
 #endif
 	gchar *uri;
+	CamelStore *store;
+	CamelFolder *fold = NULL;
 	EShellSidebar *shell_sidebar;
 
 	d("rss_select_folder() %s:%d\n", __FILE__, __LINE__);
@@@@ -951,12 +962,23 @@@@ rss_select_folder(gchar *folder_name)
 
 	shell_sidebar  = e_shell_view_get_shell_sidebar(rss_shell_view);
 	g_object_get (shell_sidebar, "folder-tree", &folder_tree, NULL);
+	store = rss_component_peek_local_store();
+#if (DATASERVER_VERSION >= 2033001)
+	fold = camel_store_get_folder_sync (store, folder_name, 0, NULL, NULL);
+#else
+	fold = camel_store_get_folder (store, folder_name, 0, NULL);
+#endif
+	if (!fold) return;
+#if EVOLUTION_VERSION >= 29101
+	uri = camel_folder_get_uri (fold);
+#else
+	uri = mail_tools_folder_to_url (fold);
+#endif
 
-	uri = lookup_uri_by_folder_name(folder_name);
 	em_folder_tree_set_selected(folder_tree, uri, 0);
 #endif
 #if EVOLUTION_VERSION < 29101
-	if (uri) g_free(uri);
+	g_free(uri);
 #endif
 }
 
@@@@ -976,9 +998,10 @@@@ summary_cb (GtkWidget *button, EMFormatHTMLPObject *po
 static void
 back_cb (GtkWidget *button, EMFormatHTMLPObject *pobject)
 {
-	guint engine;
-	engine = fallback_engine();
-#ifdef	HAVE_GECKO
+#if defined(HAVE_GECKO) || defined(HAVE_WEBKIT)
+	guint engine = fallback_engine();
+#endif
+#ifdef  HAVE_GECKO
 	if (engine == 2)
 		gtk_moz_embed_go_back((GtkMozEmbed *)rf->mozembed);
 #endif
@@@@ -992,8 +1015,9 @@@@ back_cb (GtkWidget *button, EMFormatHTMLPObject *pobje
 static void
 forward_cb (GtkWidget *button, EMFormatHTMLPObject *pobject)
 {
-	guint engine;
-	engine = fallback_engine();
+#if defined(HAVE_GECKO) || defined(HAVE_WEBKIT)
+	guint engine = fallback_engine();
+#endif
 #ifdef	HAVE_GECKO
 	if (engine == 2)
 		gtk_moz_embed_go_forward((GtkMozEmbed *)rf->mozembed);
@@@@ -1009,8 +1033,9 @@@@ void stop_cb (GtkWidget *button, EMFormatHTMLPObject *
 void
 stop_cb (GtkWidget *button, EMFormatHTMLPObject *pobject)
 {
-	guint engine;
-	engine = fallback_engine();
+#if defined(HAVE_GECKO) || defined(HAVE_WEBKIT)
+	guint engine = fallback_engine();
+#endif
 #ifdef	HAVE_GECKO
 	if (engine == 2)
 		gtk_moz_embed_stop_load((GtkMozEmbed *)rf->mozembed);
@@@@ -2124,7 +2149,6 @@@@ void org_gnome_cooly_format_rss(void *ep, EMFormatHook
 	gchar *comments = NULL;
 	gchar *category = NULL;
 	GdkPixbuf *pixbuf = NULL;
-	guint engine = 0;
 	int size;
 	CamelDataWrapper *dw = camel_data_wrapper_new();
 	CamelMimePart *part = camel_mime_part_new();
@@@@ -2247,8 +2271,8 @@@@ void org_gnome_cooly_format_rss(void *ep, EMFormatHook
 
 
 	if (rf->cur_format || (feedid && is_html && rf->cur_format)) {
-		engine = fallback_engine();
 #ifdef HAVE_RENDERKIT
+		guint engine = fallback_engine();
 		if (engine && engine != 10) {
 			char *classid = g_strdup_printf(
 					"org-gnome-rss-controls-%d",
@@@@ -2269,11 +2293,6 @@@@ void org_gnome_cooly_format_rss(void *ep, EMFormatHook
 			pobj->stopbut =  button2;
 			pobj->backbut = button3;
 			pobj->forwbut = button4;
-//			camel_stream_printf (t->stream,
-//				"<div style=\"border: solid #%06x 1px; background-color: #%06x; color: #%06x;\">\n",
-//				frame_colour & 0xffffff,
-//				content_colour & 0xffffff,
-//				text_colour & 0xffffff);
 			camel_stream_printf(t->stream,
 				"<table style=\"border: solid #%06x 1px; background-color: #%06x; color: #%06x;\" cellpadding=1 cellspacing=0><tr><td align=center>",
 				frame_colour & 0xffffff,
@@@@ -3762,7 +3781,6 @@@@ print_comments(gchar *url, gchar *stream, EMFormatHTML
 
 			return display_comments (r, format);
 	}
-	g_free(r);
 	return NULL;
 }
 
@@@@ -3942,30 +3960,6 @@@@ lookup_chn_name_by_url(gchar *url)
 	return chn_name;
 }
 
-gchar *
-lookup_uri_by_folder_name(gchar *name)
-{
-	CamelFolder *folder;
-	gchar *uri;
-	CamelStore *store = rss_component_peek_local_store();
-
-	if (!name)
-		return NULL;
-
-#if (DATASERVER_VERSION >= 2033001)
-	folder = camel_store_get_folder_sync (store, name, 0, NULL, NULL);
d17 1
a17 1
-	folder = camel_store_get_folder (store, name, 0, NULL);
a18 46
-	if (!folder) return NULL;
-#if EVOLUTION_VERSION >= 29101
-	uri = (gchar *)camel_folder_get_uri (folder);
-#else
-	uri = mail_tools_folder_to_url (folder);
-#endif
-	return uri;
-}
-
 void
 update_main_folder(gchar *new_name)
 {
@@@@ -4029,7 +4023,6 @@@@ search_rebase(gpointer key, gpointer value, gchar *ona
 	if (!strncmp(key, tmp, strlen(tmp))) {
 		rebase_keys = g_list_append(rebase_keys, key);
 	}
-	g_free(tmp);
 }
 
 void
@@@@ -4066,7 +4059,7 @@@@ sync_folders(void)
 	g_free(feed_dir);
 	f = fopen(feed_file, "wb");
 	if (!f)
-		goto out;
+		return;
 
 	if (!g_hash_table_size(rf->feed_folders))
 		goto exit;
@@@@ -4074,6 +4067,7 @@@@ sync_folders(void)
 	g_hash_table_foreach(rf->feed_folders,
 		(GHFunc)write_feeds_folder_line,
 		(gpointer *)f);
+	g_free(feed_file);
 	g_hash_table_destroy(rf->reversed_feed_folders);
 	rf->reversed_feed_folders = g_hash_table_new_full(g_str_hash,
 			g_str_equal,
@@@@ -4083,7 +4077,6 @@@@ sync_folders(void)
 			(GHFunc)populate_reversed,
 			rf->reversed_feed_folders);
 exit:	fclose(f);
-out:	g_free(feed_file);
 	return;
 }
 
@@@@ -4862,7 +4855,7 @@@@ e_plugin_ui_init (GtkUIManager *ui_manager,
d20 22
a41 7
 	rss_shell_view = shell_view;
 	shell_window = e_shell_view_get_shell_window (rss_shell_view);
-	evo_window = (GtkWidget *)shell_window;
+	evo_window = shell_window;
 	g_signal_connect (
 		e_shell_window_get_action (
 			E_SHELL_WINDOW (shell_window),
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
$OpenBSD: patch-src_rss_c,v 1.12 2011/04/25 06:16:49 ajacoutot Exp $
@


1.1.1.1
log
@Re-import evolution-plugin-rss as evolution-rss as it should always has
been. This will prevent some confusion and ease the future gnome3 merge.

discussed with and ok jasper@@
@
text
@@
