head	1.12;
access;
symbols
	OPENBSD_5_2:1.8.0.2
	OPENBSD_5_2_BASE:1.8
	OPENBSD_5_1_BASE:1.5
	OPENBSD_5_1:1.5.0.2
	OPENBSD_5_0:1.2.0.2
	OPENBSD_5_0_BASE:1.2
	OPENBSD_4_9:1.1.0.4
	OPENBSD_4_9_BASE:1.1
	OPENBSD_4_8:1.1.0.2
	OPENBSD_4_8_BASE:1.1;
locks; strict;
comment	@# @;


1.12
date	2012.11.24.10.32.42;	author landry;	state dead;
branches;
next	1.11;

1.11
date	2012.10.10.21.08.05;	author landry;	state Exp;
branches;
next	1.10;

1.10
date	2012.09.01.14.22.45;	author landry;	state Exp;
branches;
next	1.9;

1.9
date	2012.08.07.09.07.04;	author landry;	state Exp;
branches;
next	1.8;

1.8
date	2012.06.11.15.33.26;	author landry;	state Exp;
branches;
next	1.7;

1.7
date	2012.03.16.21.35.25;	author landry;	state Exp;
branches;
next	1.6;

1.6
date	2012.02.20.20.17.49;	author landry;	state Exp;
branches;
next	1.5;

1.5
date	2011.12.08.02.25.59;	author nigel;	state Exp;
branches;
next	1.4;

1.4
date	2011.10.03.21.07.05;	author landry;	state Exp;
branches;
next	1.3;

1.3
date	2011.08.23.20.19.33;	author landry;	state Exp;
branches;
next	1.2;

1.2
date	2011.07.24.07.10.12;	author landry;	state Exp;
branches;
next	1.1;

1.1
date	2010.04.03.09.26.46;	author landry;	state Exp;
branches;
next	;


desc
@@


1.12
log
@Update to thunderbird 17.0/enigmail 1.4.6/lightning 1.9b1.

- see http://www.mozilla.org/en-US/thunderbird/17.0/releasenotes/ for details
- tidy up WANTLIB/CONFIGURE_ARGS
- enable the gio/libnotify interaction. If libnotify is found at
  runtime, a popup will show incoming messages notification.
- install an icon in pixmaps/ for the desktop file, like in ffx
- remove patch-mozilla_browser_app_profile_firefox_js, this is spar^Wthunderbird!
- for the other patches removed/added, same comments as for ffx apply
@
text
@$OpenBSD: patch-mozilla_security_manager_ssl_src_nsNSSComponent_cpp,v 1.11 2012/10/10 21:08:05 landry Exp $
--- mozilla/security/manager/ssl/src/nsNSSComponent.cpp.orig	Wed Aug 29 02:16:04 2012
+++ mozilla/security/manager/ssl/src/nsNSSComponent.cpp	Sun Sep  2 00:04:10 2012
@@@@ -71,6 +71,7 @@@@
 #include "secerr.h"
 #include "sslerr.h"
 #include "cert.h"
+#include "SSLServerCertVerification.h"
 
 #include "nsXULAppAPI.h"
 
@@@@ -356,6 +357,8 @@@@ nsNSSComponent::deleteBackgroundThreads()
     delete mCertVerificationThread;
     mCertVerificationThread = nsnull;
   }
+
+  StopSSLServerCertVerificationThreads();
 }
 
 void
@@@@ -372,14 +375,14 @@@@ nsNSSComponent::createBackgroundThreads()
     delete mCertVerificationThread;
     mCertVerificationThread = nsnull;
   }
+
+  InitializeSSLServerCertVerificationThreads();
 }
 
 nsNSSComponent::~nsNSSComponent()
 {
   PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, ("nsNSSComponent::dtor\n"));
 
-  deleteBackgroundThreads();
-
   if (mUpdateTimerInitialized) {
     {
       MutexAutoLock lock(mCrlTimerLock);
@@@@ -808,7 +811,7 @@@@ nsNSSComponent::InstallLoadableRoots()
 
     if (!possible_ckbi_locations[il])
     {
-      fullLibraryPath = PR_GetLibraryName(nsnull, "nssckbi");
+      fullLibraryPath = PR_GetLibraryName(NSS_LIBDIR, "nssckbi");
     }
     else
     {
@@@@ -1871,6 +1874,8 @@@@ nsNSSComponent::InitializeNSS(bool showWarningBox)
 
       LaunchSmartCardThreads();
 
+      createBackgroundThreads();
+
       PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, ("NSS Initialization done\n"));
     }
   }
@@@@ -2014,16 +2019,6 @@@@ nsNSSComponent::Init()
   if (mClientAuthRememberService)
     mClientAuthRememberService->Init();
 
-  createBackgroundThreads();
-  if (!mCertVerificationThread)
-  {
-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, ("NSS init, could not create threads\n"));
-
-    DeregisterObservers();
-    mPIPNSSBundle = nsnull;
-    return NS_ERROR_OUT_OF_MEMORY;
-  }
-
   InitializeCRLUpdateTimer();
   RegisterPSMContentListener();
 
@@@@ -2238,6 +2233,7 @@@@ nsNSSComponent::Observe(nsISupports *aSubject, const c
     DoProfileChangeTeardown(aSubject);
   }
   else if (nsCRT::strcmp(aTopic, PROFILE_CHANGE_TEARDOWN_VETO_TOPIC) == 0) {
+    createBackgroundThreads();
     mShutdownObjectList->allowUI();
   }
   else if (nsCRT::strcmp(aTopic, PROFILE_BEFORE_CHANGE_TOPIC) == 0) {
@@@@ -2285,6 +2281,7 @@@@ nsNSSComponent::Observe(nsISupports *aSubject, const c
     InitializeCRLUpdateTimer();
   }
   else if (nsCRT::strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID) == 0) {
+    ShutdownSSLServerCertVerification();
 
     PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, ("nsNSSComponent: XPCom shutdown observed\n"));
 
@@@@ -2575,6 +2572,9 @@@@ nsNSSComponent::DoProfileChangeNetTeardown()
 void
 nsNSSComponent::DoProfileChangeTeardown(nsISupports* aSubject)
 {
+  /* XXX this doesn't work well, since nothing expects null pointers */
+  deleteBackgroundThreads();
+
   bool callVeto = false;
 
   if (!mShutdownObjectList->ifPossibleDisallowUI()) {
@@@@ -2628,9 +2628,6 @@@@ nsNSSComponent::DoProfileBeforeChange(nsISupports* aSu
 void
 nsNSSComponent::DoProfileChangeNetRestore()
 {
-  /* XXX this doesn't work well, since nothing expects null pointers */
-  deleteBackgroundThreads();
-  createBackgroundThreads();
   mIsNetworkDown = false;
 }
 
@


1.11
log
@Update to thunderbird 16.0/enigmail 1.4.5/lightning 1.8b1.

- see https://www.mozilla.org/en/thunderbird/16.0/releasenotes/ for details
- remove patch-mozilla_build_unix_mozilla_in, useless since bin/thunderbird
is not a script anymore since a while
- remove patch-mozilla_build_unix_run-mozilla_sh, thunderbird can be
directly debugged in gdb now. update README accordingly
@
text
@d1 1
a1 1
$OpenBSD: patch-mozilla_security_manager_ssl_src_nsNSSComponent_cpp,v 1.10 2012/09/01 14:22:45 landry Exp $
@


1.10
log
@Update to thunderbird 15.0/lightning 1.7b1/enigmail 1.4.4.

- see http://www.mozilla.org/en-US/thunderbird/15.0/releasenotes/
- garbage collect nsSound.cpp, the original one uses libcanberra
properly and thus sndio.
- remove patch from #750620, merged upstream (mfbt/double-conversion)
- remove patches from #691898, merged upstream (yarr jit ppc)
- remove useless crashreporter patch, we don't have breakpad
- garbage collect sunbird.desktop since it's unlikely sunbird will ever
build from tb again..
@
text
@d1 3
a3 3
$OpenBSD: patch-mozilla_security_manager_ssl_src_nsNSSComponent_cpp,v 1.9 2012/08/07 09:07:04 landry Exp $
--- mozilla/security/manager/ssl/src/nsNSSComponent.cpp.orig	Sat Aug 25 02:31:28 2012
+++ mozilla/security/manager/ssl/src/nsNSSComponent.cpp	Sat Sep  1 01:59:41 2012
d21 1
a21 8
@@@@ -363,21 +366,20 @@@@ nsNSSComponent::createBackgroundThreads()
 {
   NS_ASSERTION(mCertVerificationThread == nsnull,
                "Cert verification thread already created.");
-
   mCertVerificationThread = new nsCertVerificationThread;
   nsresult rv = mCertVerificationThread->startThread();
   if (NS_FAILED(rv)) {
d38 1
a38 1
@@@@ -806,7 +808,7 @@@@ nsNSSComponent::InstallLoadableRoots()
d47 1
a47 1
@@@@ -1869,6 +1871,8 @@@@ nsNSSComponent::InitializeNSS(bool showWarningBox)
d56 1
a56 1
@@@@ -2012,16 +2016,6 @@@@ nsNSSComponent::Init()
d73 1
a73 1
@@@@ -2236,6 +2230,7 @@@@ nsNSSComponent::Observe(nsISupports *aSubject, const c
d81 1
a81 1
@@@@ -2283,6 +2278,7 @@@@ nsNSSComponent::Observe(nsISupports *aSubject, const c
d89 1
a89 1
@@@@ -2573,6 +2569,9 @@@@ nsNSSComponent::DoProfileChangeNetTeardown()
d99 1
a99 1
@@@@ -2626,9 +2625,6 @@@@ nsNSSComponent::DoProfileBeforeChange(nsISupports* aSu
@


1.9
log
@Update to thunderbird 14.0/enigmail 1.4.3/lightning 1.6b1.

- see http://www.mozilla.org/en-US/thunderbird/14.0/releasenotes/
- remove the -rpath hack, not needed since matthew's ld.so fix from
  12/06
- backport cset from #750620 to fix ppc (and other exotic archs) build.
@
text
@d1 4
a4 4
$OpenBSD: patch-mozilla_security_manager_ssl_src_nsNSSComponent_cpp,v 1.8 2012/06/11 15:33:26 landry Exp $
--- mozilla/security/manager/ssl/src/nsNSSComponent.cpp.orig	Wed Jun 20 05:50:51 2012
+++ mozilla/security/manager/ssl/src/nsNSSComponent.cpp	Fri Jun 22 22:49:26 2012
@@@@ -111,6 +111,7 @@@@
d12 1
a12 9
@@@@ -124,6 +125,7 @@@@ extern "C" {
 }
 
 using namespace mozilla;
+using namespace mozilla::psm;
 
 #ifdef PR_LOGGING
 PRLogModuleInfo* gPIPNSSLog = nsnull;
@@@@ -395,6 +397,8 @@@@ nsNSSComponent::deleteBackgroundThreads()
d21 1
a21 1
@@@@ -402,21 +406,20 @@@@ nsNSSComponent::createBackgroundThreads()
d45 1
a45 1
@@@@ -844,7 +847,7 @@@@ nsNSSComponent::InstallLoadableRoots()
d54 1
a54 1
@@@@ -1907,6 +1910,8 @@@@ nsNSSComponent::InitializeNSS(bool showWarningBox)
d63 1
a63 1
@@@@ -2049,16 +2054,6 @@@@ nsNSSComponent::Init()
d80 1
a80 1
@@@@ -2273,6 +2268,7 @@@@ nsNSSComponent::Observe(nsISupports *aSubject, const c
d88 1
a88 1
@@@@ -2320,6 +2316,7 @@@@ nsNSSComponent::Observe(nsISupports *aSubject, const c
d96 1
a96 1
@@@@ -2610,6 +2607,9 @@@@ nsNSSComponent::DoProfileChangeNetTeardown()
d106 1
a106 1
@@@@ -2663,9 +2663,6 @@@@ nsNSSComponent::DoProfileBeforeChange(nsISupports* aSu
@


1.8
log
@Update to thunderbird 13.0.

See https://www.mozilla.org/en-US/thunderbird/13.0/releasenotes/ for details
- update enigmail to 1.4.2, lightning to 1.5b1
- adapt Makefile to cope with SEPARATE_BUILD
- add a rpath hack in config/rules.mk, temporary workaround for #668869
@
text
@d1 3
a3 3
$OpenBSD: patch-mozilla_security_manager_ssl_src_nsNSSComponent_cpp,v 1.7 2012/03/16 21:35:25 landry Exp $
--- mozilla/security/manager/ssl/src/nsNSSComponent.cpp.orig	Fri May 18 06:11:01 2012
+++ mozilla/security/manager/ssl/src/nsNSSComponent.cpp	Fri May 18 09:27:58 2012
d62 1
a62 1
@@@@ -1881,6 +1884,8 @@@@ nsNSSComponent::InitializeNSS(bool showWarningBox)
d71 1
a71 1
@@@@ -2023,16 +2028,6 @@@@ nsNSSComponent::Init()
d88 1
a88 1
@@@@ -2247,6 +2242,7 @@@@ nsNSSComponent::Observe(nsISupports *aSubject, const c
d96 1
a96 1
@@@@ -2294,6 +2290,7 @@@@ nsNSSComponent::Observe(nsISupports *aSubject, const c
d104 1
a104 1
@@@@ -2584,6 +2581,9 @@@@ nsNSSComponent::DoProfileChangeNetTeardown()
d114 1
a114 1
@@@@ -2637,9 +2637,6 @@@@ nsNSSComponent::DoProfileBeforeChange(nsISupports* aSu
@


1.7
log
@Update to thunderbird 11.0. (and enigmail 1.4/lightning 1.3b1)
- Fixes MFSA 2012-12->19
- see http://www.mozilla.org/en-US/thunderbird/11.0/releasenotes/ (but
  there's much more!)
- complete patchset for #691898, still fixes build on ppc (and hopefully
commited in firefox 14...)
- add patchset from #706955, workarounds #669050 (xpcshell hangs during
make install and chokes on CSPUtils.csm, threads related..)
- remove obsolete/commited patches
@
text
@d1 4
a4 4
$OpenBSD: patch-mozilla_security_manager_ssl_src_nsNSSComponent_cpp,v 1.6 2012/02/20 20:17:49 landry Exp $
--- mozilla/security/manager/ssl/src/nsNSSComponent.cpp.orig	Tue Mar 13 03:43:40 2012
+++ mozilla/security/manager/ssl/src/nsNSSComponent.cpp	Thu Mar 15 08:47:21 2012
@@@@ -112,6 +112,7 @@@@
d12 1
a12 1
@@@@ -125,6 +126,7 @@@@ extern "C" {
d20 1
a20 1
@@@@ -396,6 +398,8 @@@@ nsNSSComponent::deleteBackgroundThreads()
d29 1
a29 1
@@@@ -403,21 +407,20 @@@@ nsNSSComponent::createBackgroundThreads()
d53 1
a53 1
@@@@ -845,7 +848,7 @@@@ nsNSSComponent::InstallLoadableRoots()
d62 1
a62 1
@@@@ -1863,6 +1866,8 @@@@ nsNSSComponent::InitializeNSS(bool showWarningBox)
d71 1
a71 1
@@@@ -2006,16 +2011,6 @@@@ nsNSSComponent::Init()
d88 1
a88 1
@@@@ -2230,6 +2225,7 @@@@ nsNSSComponent::Observe(nsISupports *aSubject, const c
d96 1
a96 1
@@@@ -2277,6 +2273,7 @@@@ nsNSSComponent::Observe(nsISupports *aSubject, const c
d104 1
a104 1
@@@@ -2565,6 +2562,9 @@@@ nsNSSComponent::DoProfileChangeNetTeardown()
d114 1
a114 1
@@@@ -2618,9 +2618,6 @@@@ nsNSSComponent::DoProfileBeforeChange(nsISupports* aSu
@


1.6
log
@Update to thunderbird-10.0.2.

Same comments as for firefox, plus:
- rename js/src/jscompartment.cpp patch
- remove patch-configure.in, not needed since 'gnome' component is
  disabled via configure args.
- add patch-mail_installer_Makefile_in to not install the sdk
  headers/idl files
@
text
@d1 8
a8 16
$OpenBSD: patch-mozilla_security_manager_ssl_src_nsNSSComponent_cpp,v 1.5 2011/12/08 02:25:59 nigel Exp $
--- mozilla/security/manager/ssl/src/nsNSSComponent.cpp.orig	Wed Jan 18 10:44:10 2012
+++ mozilla/security/manager/ssl/src/nsNSSComponent.cpp	Sun Jan 22 22:18:19 2012
@@@@ -845,11 +845,10 @@@@ nsNSSComponent::InstallLoadableRoots()
     return;
 
   const char *possible_ckbi_locations[] = {
-    NS_XPCOM_CURRENT_PROCESS_DIR,
+    0, // This special value means: 
+       //   search for ckbi in NSS_LIBDIR
     NS_GRE_DIR,
-    0 // This special value means: 
-      //   search for ckbi in the directories on the shared
-      //   library/DLL search path
+    NS_XPCOM_CURRENT_PROCESS_DIR
   };
d10 44
a53 2
   for (size_t il = 0; il < sizeof(possible_ckbi_locations)/sizeof(const char*); ++il) {
@@@@ -858,7 +857,7 @@@@ nsNSSComponent::InstallLoadableRoots()
d62 62
@


1.5
log
@Update thunderbird v7.0.1 to v8.0, enigmail v1.3.4, lightning
@
text
@d1 4
a4 4
$OpenBSD: patch-mozilla_security_manager_ssl_src_nsNSSComponent_cpp,v 1.4 2011/10/03 21:07:05 landry Exp $
--- mozilla/security/manager/ssl/src/nsNSSComponent.cpp.orig	Sat Nov  5 09:21:03 2011
+++ mozilla/security/manager/ssl/src/nsNSSComponent.cpp	Tue Nov  8 15:21:46 2011
@@@@ -847,11 +847,10 @@@@ nsNSSComponent::InstallLoadableRoots()
d19 1
a19 1
@@@@ -860,7 +859,7 @@@@ nsNSSComponent::InstallLoadableRoots()
@


1.4
log
@Update to thunderbird 7.0.1/lightning 1.0beta6.
@
text
@d1 4
a4 4
$OpenBSD: patch-mozilla_security_manager_ssl_src_nsNSSComponent_cpp,v 1.3 2011/08/23 20:19:33 landry Exp $
--- mozilla/security/manager/ssl/src/nsNSSComponent.cpp.orig	Wed Aug 31 23:37:26 2011
+++ mozilla/security/manager/ssl/src/nsNSSComponent.cpp	Thu Sep  1 10:23:18 2011
@@@@ -849,11 +849,10 @@@@ nsNSSComponent::InstallLoadableRoots()
d19 1
a19 1
@@@@ -862,7 +861,7 @@@@ nsNSSComponent::InstallLoadableRoots()
@


1.3
log
@Update to thunderbird 6.0/lightning 1.0b5/enigmail 1.3.
See https://www.mozilla.org/en-US/thunderbird/6.0/releasenotes/
- remove patches merged upstream
- Add a missing patch from firefox for plugin path
- Add a hack to fix ui hangs with enigmail, better solution worked on in
  #681026
testing, feedback & enigmail update from nigel@@, thanks!
@
text
@d1 4
a4 4
$OpenBSD: patch-mozilla_security_manager_ssl_src_nsNSSComponent_cpp,v 1.2 2011/07/24 07:10:12 landry Exp $
--- mozilla/security/manager/ssl/src/nsNSSComponent.cpp.orig	Fri Jul 15 07:51:43 2011
+++ mozilla/security/manager/ssl/src/nsNSSComponent.cpp	Sun Jul 31 22:20:16 2011
@@@@ -821,11 +821,10 @@@@ nsNSSComponent::InstallLoadableRoots()
d19 1
a19 1
@@@@ -834,7 +833,7 @@@@ nsNSSComponent::InstallLoadableRoots()
@


1.2
log
@Update to thunderbird 5.0, based on Gecko 5. See for details :
http://www.mozilla.org/en-US/thunderbird/5.0/releasenotes/
- sync ipc patches from firefox
- install under lib/thunderbird-5.0 instead of using the handmade
  install target
- remove a bunch of pointless patches
Been running with it since a while, tested by a few on ports@@, thanks!
@
text
@d1 4
a4 4
$OpenBSD: patch-mozilla_security_manager_ssl_src_nsNSSComponent_cpp,v 1.1 2010/04/03 09:26:46 landry Exp $
--- mozilla/security/manager/ssl/src/nsNSSComponent.cpp.orig	Sat May 28 00:44:24 2011
+++ mozilla/security/manager/ssl/src/nsNSSComponent.cpp	Mon May 30 14:28:50 2011
@@@@ -846,11 +846,10 @@@@ nsNSSComponent::InstallLoadableRoots()
d19 1
a19 1
@@@@ -859,7 +858,7 @@@@ nsNSSComponent::InstallLoadableRoots()
@


1.1
log
@Major update to mozilla-thunderbird 3.0.4. See for details:
http://www.mozillamessaging.com/en-US/thunderbird/3.0.4/releasenotes/
Backing up your profile before upgrading is recommended..
Update largely based on www/firefox35 port, tested on
i386/amd64/sparc64/powerpc by myself and alpha by naddy@@.

ok naddy@@
@
text
@d1 4
a4 4
$OpenBSD$
--- mozilla/security/manager/ssl/src/nsNSSComponent.cpp.orig	Sat Dec  5 02:56:23 2009
+++ mozilla/security/manager/ssl/src/nsNSSComponent.cpp	Sat Jan 16 16:28:36 2010
@@@@ -812,11 +812,10 @@@@ nsNSSComponent::InstallLoadableRoots()
d19 1
a19 1
@@@@ -825,7 +824,7 @@@@ nsNSSComponent::InstallLoadableRoots()
@

