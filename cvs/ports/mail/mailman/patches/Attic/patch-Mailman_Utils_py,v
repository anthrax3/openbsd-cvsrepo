head	1.2;
access;
symbols
	OPENBSD_5_6:1.2.0.4
	OPENBSD_5_7:1.2.0.2
	OPENBSD_3_7:1.1.0.6
	OPENBSD_3_7_BASE:1.1
	OPENBSD_3_5:1.1.0.4
	OPENBSD_3_6:1.1.0.2;
locks; strict;
comment	@# @;


1.2
date	2005.06.23.07.34.56;	author djm;	state dead;
branches
	1.2.2.1
	1.2.4.1;
next	1.1;

1.1
date	2005.02.11.19.33.55;	author jakob;	state Exp;
branches
	1.1.2.1
	1.1.4.1;
next	;

1.1.2.1
date	2005.02.13.16.50.02;	author sturm;	state Exp;
branches;
next	;

1.1.4.1
date	2005.02.13.16.50.38;	author sturm;	state Exp;
branches;
next	;

1.2.2.1
date	2015.04.09.20.02.26;	author okan;	state Exp;
branches;
next	;
commitid	XRFFnVRLx6SloCKr;

1.2.4.1
date	2015.04.09.20.06.24;	author okan;	state Exp;
branches;
next	;
commitid	CR1e77cmhhBzFvfL;


desc
@@


1.2
log
@mailman-2.16; ok jakob@@
@
text
@$OpenBSD: patch-Mailman_Utils_py,v 1.1 2005/02/11 19:33:55 jakob Exp $
--- Mailman/Utils.py.orig	Fri Dec 26 23:50:04 2003
+++ Mailman/Utils.py	Fri Feb 11 20:23:16 2005
@@@@ -1,4 +1,4 @@@@
-# Copyright (C) 1998-2003 by the Free Software Foundation, Inc.
+# Copyright (C) 1998-2004 by the Free Software Foundation, Inc.
 #
 # This program is free software; you can redistribute it and/or
 # modify it under the terms of the GNU General Public License
@@@@ -27,12 +27,13 @@@@ from __future__ import nested_scopes
 
 import os
 import re
-import random
-import urlparse
+import cgi
 import sha
-import errno
 import time
-import cgi
+import errno
+import base64
+import random
+import urlparse
 import htmlentitydefs
 import email.Header
 import email.Iterators
@@@@ -297,11 +298,52 @@@@ for v in _vowels:
         _syllables.append(v+c)
 del c, v
 
-def MakeRandomPassword(length=6):
+def UserFriendly_MakeRandomPassword(length):
     syls = []
     while len(syls) * 2 < length:
         syls.append(random.choice(_syllables))
     return EMPTYSTRING.join(syls)[:length]
+
+
+def Secure_MakeRandomPassword(length):
+    bytesread = 0
+    bytes = []
+    fd = None
+    try:
+        while bytesread < length:
+            try:
+                # Python 2.4 has this on available systems.
+                newbytes = os.urandom(length - bytesread)
+            except (AttributeError, NotImplementedError):
+                if fd is None:
+                    try:
+                        fd = os.open('/dev/urandom', os.O_RDONLY)
+                    except OSError, e:
+                        if e.errno <> errno.ENOENT:
+                            raise
+                        # We have no available source of cryptographically
+                        # secure random characters.  Log an error and fallback
+                        # to the user friendly passwords.
+                        from Mailman.Logging.Syslog import syslog
+                        syslog('error',
+                               'urandom not available, passwords not secure')
+                        return UserFriendly_MakeRandomPassword(length)
+                newbytes = os.read(fd, length - bytesread)
+            bytes.append(newbytes)
+            bytesread += len(newbytes)
+        s = base64.encodestring(EMPTYSTRING.join(bytes))
+        # base64 will expand the string by 4/3rds
+        return s.replace('\n', '')[:length]
+    finally:
+        if fd is not None:
+            os.close(fd)
+
+
+def MakeRandomPassword(length=mm_cfg.MEMBER_PASSWORD_LENGTH):
+    if mm_cfg.USER_FRIENDLY_PASSWORDS:
+        return UserFriendly_MakeRandomPassword(length)
+    return Secure_MakeRandomPassword(length)
+
 
 def GetRandomSeed():
     chr1 = int(random.random() * 52)
@


1.2.4.1
log
@Cherry pick for CVE-2015-2775: Path traversal vulnerability

requested by jasper@@
@
text
@d1 81
a81 19
$OpenBSD$

CVE-2015-2775: Path traversal vulnerability

--- Mailman/Utils.py.orig	Thu Apr  9 15:40:13 2015
+++ Mailman/Utils.py	Thu Apr  9 15:40:53 2015
@@@@ -92,6 +92,12 @@@@ def list_exists(listname):
     #
     # The former two are for 2.1alpha3 and beyond, while the latter two are
     # for all earlier versions.
+    #
+    # But first ensure the list name doesn't contain a path traversal
+    # attack.
+    if len(re.sub(mm_cfg.ACCEPTABLE_LISTNAME_CHARACTERS, '', listname)) > 0:
+        syslog('mischief', 'Hostile listname: %s', listname)
+        return False
     basepath = Site.get_listpath(listname)
     for ext in ('.pck', '.pck.last', '.db', '.db.last'):
         dbfile = os.path.join(basepath, 'config' + ext)
@


1.2.2.1
log
@Cherry pick for CVE-2015-2775: Path traversal vulnerability

requested by jasper@@
@
text
@d1 81
a81 19
$OpenBSD$

CVE-2015-2775: Path traversal vulnerability

--- Mailman/Utils.py.orig	Thu Apr  9 15:40:13 2015
+++ Mailman/Utils.py	Thu Apr  9 15:40:53 2015
@@@@ -92,6 +92,12 @@@@ def list_exists(listname):
     #
     # The former two are for 2.1alpha3 and beyond, while the latter two are
     # for all earlier versions.
+    #
+    # But first ensure the list name doesn't contain a path traversal
+    # attack.
+    if len(re.sub(mm_cfg.ACCEPTABLE_LISTNAME_CHARACTERS, '', listname)) > 0:
+        syslog('mischief', 'Hostile listname: %s', listname)
+        return False
     basepath = Site.get_listpath(listname)
     for ext in ('.pck', '.pck.last', '.db', '.db.last'):
         dbfile = os.path.join(basepath, 'config' + ext)
@


1.1
log
@fix CAN-2004-1143 (weak password generation)
@
text
@d1 1
a1 1
$OpenBSD$
@


1.1.4.1
log
@MFC:

fix CAN-2004-1143 (weak password generation)

ok brad@@
@
text
@d1 1
a1 1
$OpenBSD: patch-Mailman_Utils_py,v 1.1 2005/02/11 19:33:55 jakob Exp $
@


1.1.2.1
log
@MFC:

fix CAN-2004-1143 (weak password generation)

ok brad@@
@
text
@d1 1
a1 1
$OpenBSD: patch-Mailman_Utils_py,v 1.1 2005/02/11 19:33:55 jakob Exp $
@

