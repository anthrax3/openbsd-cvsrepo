head	1.7;
access;
symbols
	OPENBSD_6_0:1.6.0.4
	OPENBSD_6_0_BASE:1.6
	OPENBSD_5_9:1.6.0.2
	OPENBSD_4_7:1.4.0.6
	OPENBSD_4_7_BASE:1.4
	OPENBSD_4_6:1.4.0.4
	OPENBSD_4_6_BASE:1.4
	OPENBSD_4_5:1.4.0.2
	OPENBSD_4_5_BASE:1.4
	OPENBSD_3_6:1.2.0.4
	OPENBSD_3_5:1.2.0.2
	OPENBSD_3_7:1.1.0.2
	OPENBSD_3_7_BASE:1.1;
locks; strict;
comment	@# @;


1.7
date	2016.11.29.20.00.35;	author naddy;	state dead;
branches;
next	1.6;
commitid	3rYO2yYEq9TuBxfZ;

1.6
date	2016.07.01.11.23.44;	author jasper;	state Exp;
branches
	1.6.2.1
	1.6.4.1;
next	1.5;
commitid	uiTnsFuJVTLXiESc;

1.5
date	2010.06.30.17.10.08;	author naddy;	state dead;
branches;
next	1.4;

1.4
date	2008.10.25.09.39.29;	author naddy;	state Exp;
branches;
next	1.3;

1.3
date	2005.06.18.21.24.40;	author naddy;	state dead;
branches;
next	1.2;

1.2
date	2005.03.27.05.12.15;	author brad;	state Exp;
branches
	1.2.2.1
	1.2.4.1;
next	1.1;

1.1
date	2004.10.20.20.37.48;	author brad;	state Exp;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2005.05.25.05.37.32;	author robert;	state Exp;
branches;
next	;

1.2.2.1
date	2005.03.31.22.02.44;	author sturm;	state Exp;
branches;
next	;

1.2.4.1
date	2005.03.31.22.08.46;	author sturm;	state Exp;
branches;
next	;

1.6.2.1
date	2016.07.01.11.26.07;	author jasper;	state Exp;
branches;
next	1.6.2.2;
commitid	NpzcbySaJV7iAd6d;

1.6.2.2
date	2016.11.30.22.14.18;	author naddy;	state dead;
branches;
next	;
commitid	HYFVXR4DcvEOAZJj;

1.6.4.1
date	2016.11.30.21.36.36;	author naddy;	state dead;
branches;
next	;
commitid	SSUFe7wdxWokBCcs;


desc
@@


1.7
log
@Update to 4.0.7.
* Multiple security fixes, including
  CVE-2016-3622, CVE-2014-8127, CVE-2016-9273, CVE-2016-9448,
  MSVR 35094, MSVR 35095, MSVR 35105
* Remove obsolete tools bmp2tiff, gif2tiff, ras2tiff, sgi2tiff, sgisv, ycbcr
@
text
@$OpenBSD: patch-libtiff_tif_pixarlog_c,v 1.6 2016/07/01 11:23:44 jasper Exp $

CVE-2016-5875(, dup?)
https://marc.info/?l=oss-security&m=146720235906569&w=2

--- libtiff/tif_pixarlog.c.orig	Sat Aug 29 00:16:22 2015
+++ libtiff/tif_pixarlog.c	Fri Jul  1 13:04:52 2016
@@@@ -457,6 +457,7 @@@@ horizontalAccumulate8abgr(uint16 *wp, int n, int strid
 typedef	struct {
 	TIFFPredictorState	predict;
 	z_stream		stream;
+	tmsize_t		tbuf_size; /* only set/used on reading for now */
 	uint16			*tbuf; 
 	uint16			stride;
 	int			state;
@@@@ -692,6 +693,7 @@@@ PixarLogSetupDecode(TIFF* tif)
 	sp->tbuf = (uint16 *) _TIFFmalloc(tbuf_size);
 	if (sp->tbuf == NULL)
 		return (0);
+	sp->tbuf_size = tbuf_size;
 	if (sp->user_datafmt == PIXARLOGDATAFMT_UNKNOWN)
 		sp->user_datafmt = PixarLogGuessDataFmt(td);
 	if (sp->user_datafmt == PIXARLOGDATAFMT_UNKNOWN) {
@@@@ -779,6 +781,12 @@@@ PixarLogDecode(TIFF* tif, uint8* op, tmsize_t occ, uin
 	if (sp->stream.avail_out != nsamples * sizeof(uint16))
 	{
 		TIFFErrorExt(tif->tif_clientdata, module, "ZLib cannot deal with buffers this size");
+		return (0);
+	}
+	/* Check that we will not fill more than what was allocated */
+	if (sp->stream.avail_out > sp->tbuf_size)
+	{
+		TIFFErrorExt(tif->tif_clientdata, module, "sp->stream.avail_out > sp->tbuf_size");
 		return (0);
 	}
 	do {
@


1.6
log
@fixes for CVE-2016-3186 and CVE-2016-5875
@
text
@d1 1
a1 1
$OpenBSD$
@


1.6.4.1
log
@Update to 4.0.7.
* Multiple security fixes, including
CVE-2016-3622, CVE-2014-8127, CVE-2016-9273, CVE-2016-9448,
MSVR 35094, MSVR 35095, MSVR 35105
* Remove obsolete tools bmp2tiff, gif2tiff, ras2tiff, sgi2tiff, sgisv, ycbcr

Minor patches to maintain ABI compatibility with 4.0.6.
@
text
@d1 1
a1 1
$OpenBSD: patch-libtiff_tif_pixarlog_c,v 1.6 2016/07/01 11:23:44 jasper Exp $
@


1.6.2.1
log
@fixes for CVE-2016-3186 and CVE-2016-5875
@
text
@d1 1
a1 1
$OpenBSD: patch-libtiff_tif_pixarlog_c,v 1.6 2016/07/01 11:23:44 jasper Exp $
@


1.6.2.2
log
@Update to 4.0.7.
* Multiple security fixes, including
CVE-2016-3622, CVE-2014-8127, CVE-2016-9273, CVE-2016-9448,
MSVR 35094, MSVR 35095, MSVR 35105
* Remove obsolete tools bmp2tiff, gif2tiff, ras2tiff, sgi2tiff, sgisv, ycbcr

Minor patches to maintain ABI compatibility with 4.0.6.
@
text
@d1 1
a1 1
$OpenBSD: patch-libtiff_tif_pixarlog_c,v 1.6.2.1 2016/07/01 11:26:07 jasper Exp $
@


1.5
log
@SECURITY:
Update to 3.9.4, which includes fixes for CVE-2009-2347 and CVE-2010-1411.
@
text
@d1 1
a1 1
$OpenBSD: patch-libtiff_tif_pixarlog_c,v 1.4 2008/10/25 09:39:29 naddy Exp $
d3 2
a4 1
CVE-2006-3461
d6 31
a36 23
--- libtiff/tif_pixarlog.c.orig	Tue Mar 21 17:42:50 2006
+++ libtiff/tif_pixarlog.c	Fri Oct 24 18:55:09 2008
@@@@ -768,7 +768,19 @@@@ PixarLogDecode(TIFF* tif, tidata_t op, tsize_t occ, ts
 	if (tif->tif_flags & TIFF_SWAB)
 		TIFFSwabArrayOfShort(up, nsamples);
 
-	for (i = 0; i < nsamples; i += llen, up += llen) {
+	/* 
+	 * if llen is not an exact multiple of nsamples, the decode operation
+	 * may overflow the output buffer, so truncate it enough to prevent that
+	 * but still salvage as much data as possible.
+	 * -- taviso@@google.com 14th June 2006
+	 */
+	if (nsamples % llen) 
+		TIFFWarningExt(tif->tif_clientdata, module,
+				"%s: stride %lu is not a multiple of sample count, "
+				"%lu, data truncated.", tif->tif_name, llen, nsamples);
+				
+	
+	for (i = 0; i < nsamples - (nsamples % llen); i += llen, up += llen) {
 		switch (sp->user_datafmt)  {
 		case PIXARLOGDATAFMT_FLOAT:
 			horizontalAccumulateF(up, llen, sp->stride,
@


1.4
log
@SECURITY fixes for CVE-2006-2656 and CVE-2006-3459 through 3465.
Man page fixes.

Mostly via FreeBSD.  Approving noises from bernd@@ and jasper@@
@
text
@d1 1
a1 1
$OpenBSD$
@


1.3
log
@update to 3.7.2 which integrates the numerous security patches
brad@@ drops maintainership
@
text
@d1 9
a9 6
$OpenBSD: patch-libtiff_tif_pixarlog_c,v 1.2 2005/03/27 05:12:15 brad Exp $
--- libtiff/tif_pixarlog.c.orig	Tue Jul  8 02:50:09 2003
+++ libtiff/tif_pixarlog.c	Sat Mar 26 23:07:59 2005
@@@@ -630,11 +630,23 @@@@ PixarLogGuessDataFmt(TIFFDirectory *td)
 	return guess;
 }
d11 17
a27 69
+static uint32
+multiply(size_t m1, size_t m2)
+{
+	uint32	bytes = m1 * m2;
+
+	if (m1 && bytes / m1 != m2)
+		bytes = 0;
+
+	return bytes;
+}
+
 static int
 PixarLogSetupDecode(TIFF* tif)
 {
 	TIFFDirectory *td = &tif->tif_dir;
 	PixarLogState* sp = DecoderState(tif);
+	tsize_t tbuf_size;
 	static const char module[] = "PixarLogSetupDecode";
 
 	assert(sp != NULL);
@@@@ -647,8 +659,13 @@@@ PixarLogSetupDecode(TIFF* tif)
 
 	sp->stride = (td->td_planarconfig == PLANARCONFIG_CONTIG ?
 	    td->td_samplesperpixel : 1);
-	sp->tbuf = (uint16 *) _TIFFmalloc(sp->stride * 
-		td->td_imagewidth * td->td_rowsperstrip * sizeof(uint16));
+	tbuf_size = multiply(multiply(multiply(sp->stride, td->td_imagewidth),
+				      td->td_rowsperstrip), sizeof(uint16));
+	if (tbuf_size == 0)
+		return (0);
+	sp->tbuf = (uint16 *) _TIFFmalloc(tbuf_size);
+	if (sp->tbuf == NULL)
+		return (0);
 	if (sp->user_datafmt == PIXARLOGDATAFMT_UNKNOWN)
 		sp->user_datafmt = PixarLogGuessDataFmt(td);
 	if (sp->user_datafmt == PIXARLOGDATAFMT_UNKNOWN) {
@@@@ -798,6 +815,7 @@@@ PixarLogSetupEncode(TIFF* tif)
 {
 	TIFFDirectory *td = &tif->tif_dir;
 	PixarLogState* sp = EncoderState(tif);
+	tsize_t tbuf_size;
 	static const char module[] = "PixarLogSetupEncode";
 
 	assert(sp != NULL);
@@@@ -806,8 +824,13 @@@@ PixarLogSetupEncode(TIFF* tif)
 
 	sp->stride = (td->td_planarconfig == PLANARCONFIG_CONTIG ?
 	    td->td_samplesperpixel : 1);
-	sp->tbuf = (uint16 *) _TIFFmalloc(sp->stride * 
-		td->td_imagewidth * td->td_rowsperstrip * sizeof(uint16));
+	tbuf_size = multiply(multiply(multiply(sp->stride, td->td_imagewidth),
+				      td->td_rowsperstrip), sizeof(uint16));
+	if (tbuf_size == 0)
+		return (0);
+	sp->tbuf = (uint16 *) _TIFFmalloc(tbuf_size);
+	if (sp->tbuf == NULL)
+		return (0);
 	if (sp->user_datafmt == PIXARLOGDATAFMT_UNKNOWN)
 		sp->user_datafmt = PixarLogGuessDataFmt(td);
 	if (sp->user_datafmt == PIXARLOGDATAFMT_UNKNOWN) {
@@@@ -1208,7 +1231,7 @@@@ PixarLogVSetField(TIFF* tif, ttag_t tag,
 	/*
 	 * Must recalculate sizes should bits/sample change.
 	 */
-	tif->tif_tilesize = TIFFTileSize(tif);
+	tif->tif_tilesize = isTiled(tif) ? TIFFTileSize(tif) : (tsize_t) -1;
 	tif->tif_scanlinesize = TIFFScanlineSize(tif);
 	result = 1;		/* NB: pseudo tag */
 	break;
@


1.2
log
@fix an issue with not being able to open some valid TIFF files.

http://www.sigmasoft.com/~openbsd/archive/openbsd-ports/200503/msg00090.html

From: Bernd Ahlers <b dot ahlers at ba-net dot org>
@
text
@d1 1
a1 1
$OpenBSD: patch-libtiff_tif_pixarlog_c,v 1.1 2004/10/20 20:37:48 brad Exp $
@


1.2.4.1
log
@cumulative update with patches of recent months

MFC:
fix an issue with not being able to open some valid TIFF files.

http://www.sigmasoft.com/~openbsd/archive/openbsd-ports/200503/msg00090.html

From: Bernd Ahlers <b dot ahlers at ba-net dot org>
---
Integer overflow in tif_dirread.c and tif_fax3.c for libtiff allows remote
attackers to execute arbitrary code via a TIFF file containing a TIFF_ASCII
or TIFF_UNDEFINED directory entry with a -1 entry count, which leads to a
heap-based buffer overflow.

CAN-2004-1308
---
fix an issue with alpha channels.

http://bugzilla.remotesensing.org/show_bug.cgi?id=718
---
fix MASTER_SITES; From: Bernd Ahlers <b dot ahlers at ba-net dot org>
---
Fix memory allocation problems and numerous integer overflows.

CAN-2004-0803, CAN-2004-0804, CAN-2004-0886

ok brad@@
@
text
@d1 1
a1 1
$OpenBSD: patch-libtiff_tif_pixarlog_c,v 1.2 2005/03/27 05:12:15 brad Exp $
@


1.2.2.1
log
@cumulative update with patches of recent months

MFC:
fix an issue with not being able to open some valid TIFF files.

http://www.sigmasoft.com/~openbsd/archive/openbsd-ports/200503/msg00090.html

From: Bernd Ahlers <b dot ahlers at ba-net dot org>
---
Integer overflow in tif_dirread.c and tif_fax3.c for libtiff allows remote
attackers to execute arbitrary code via a TIFF file containing a TIFF_ASCII
or TIFF_UNDEFINED directory entry with a -1 entry count, which leads to a
heap-based buffer overflow.

CAN-2004-1308
---
fix an issue with alpha channels.

http://bugzilla.remotesensing.org/show_bug.cgi?id=718
---
fix MASTER_SITES; From: Bernd Ahlers <b dot ahlers at ba-net dot org>
---
Fix memory allocation problems and numerous integer overflows.

CAN-2004-0803, CAN-2004-0804, CAN-2004-0886

ok brad@@
@
text
@d1 1
a1 1
$OpenBSD: patch-libtiff_tif_pixarlog_c,v 1.2 2005/03/27 05:12:15 brad Exp $
@


1.1
log
@Fix memory allocation problems and numerous integer overflows.

CAN-2004-0803, CAN-2004-0804, CAN-2004-0886
@
text
@d1 1
a1 1
$OpenBSD$
d3 1
a3 1
+++ libtiff/tif_pixarlog.c	Wed Oct 20 14:38:11 2004
d68 9
@


1.1.2.1
log
@SECURITY:
fix multiple vulnerabilities; bump PKGNAME
http://www.vuxml.org/openbsd/d045aeb6-9ea6-11d9-9623-00065bd5b0b6.html

ok brad@@
@
text
@d3 1
a3 1
+++ libtiff/tif_pixarlog.c	Sat Mar 26 23:07:59 2005
a67 9
@@@@ -1208,7 +1231,7 @@@@ PixarLogVSetField(TIFF* tif, ttag_t tag,
 	/*
 	 * Must recalculate sizes should bits/sample change.
 	 */
-	tif->tif_tilesize = TIFFTileSize(tif);
+	tif->tif_tilesize = isTiled(tif) ? TIFFTileSize(tif) : (tsize_t) -1;
 	tif->tif_scanlinesize = TIFFScanlineSize(tif);
 	result = 1;		/* NB: pseudo tag */
 	break;
@


