head	1.2;
access;
symbols
	OPENBSD_6_0:1.2.0.2
	OPENBSD_6_0_BASE:1.2
	OPENBSD_5_9:1.1.0.2
	OPENBSD_5_9_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2016.06.04.07.00.28;	author landry;	state Exp;
branches;
next	1.1;
commitid	Z2VkdKOVTyvzf8f4;

1.1
date	2016.02.05.22.27.25;	author sthen;	state Exp;
branches;
next	;
commitid	t6Iyj5kjarsHRgOE;


desc
@@


1.2
log
@Backport bugfix from https://bugs.launchpad.net/inkscape/+bug/1587311 to
fix crashes edd@@ was experiencing.

From Rafael Sadowski (who takes maintainership) thanks!
@
text
@$OpenBSD: patch-src_util_expression-evaluator_cpp,v 1.1 2016/02/05 22:27:25 sthen Exp $

- Fix g_utf8_validate call. get_text() from GtkSpinButton returns an string
  with a wrong encoding.
- fix https://bugs.launchpad.net/inkscape/+bug/1587311

--- src/util/expression-evaluator.cpp.orig	Sun Nov 30 19:45:32 2014
+++ src/util/expression-evaluator.cpp	Sat Jun  4 08:34:35 2016
@@@@ -28,6 +28,8 @@@@
 #include "util/expression-evaluator.h"
 #include "util/units.h"
 
+#include <glib/gconvert.h>
+
 #include <math.h>
 #include <string.h>
 
@@@@ -49,7 +51,7 @@@@ EvaluatorToken::EvaluatorToken()
 }
 
 ExpressionEvaluator::ExpressionEvaluator(const char *string, Unit const *unit) :
-    string(string),
+    string(g_locale_to_utf8(string,-1,0,0,0)),
     unit(unit)
 {
     current_token.type  = TOKEN_END;
@@@@ -206,8 +208,11 @@@@ EvaluatorQuantity ExpressionEvaluator::evaluateFactor(
 {
     EvaluatorQuantity evaluated_factor = EvaluatorQuantity();
     EvaluatorToken consumed_token = EvaluatorToken();
-    
-    if (acceptToken(TOKEN_NUM, &consumed_token)) {
+
+    if (acceptToken(TOKEN_END, &consumed_token)) {
+        return evaluated_factor;
+    }
+    else if (acceptToken(TOKEN_NUM, &consumed_token)) {
         evaluated_factor.value = consumed_token.value.fl;
     } else if (acceptToken('(', NULL)) {
         evaluated_factor = evaluateExpression();
@


1.1
log
@Add a patch to inkscape from Rafael Sadowski, fixing very frequent segfaults
with spinbuttons with malloc's "baby junking" default (indicating a likely
use-after-free). Additional testing from Laurence Tratt.
@
text
@d1 1
a1 1
$OpenBSD$
d3 3
a5 2
Fix g_utf8_validate call. get_text() from GtkSpinButton returns an
string with a wrong encoding.
d8 1
a8 1
+++ src/util/expression-evaluator.cpp	Thu Feb  4 20:46:25 2016
d27 14
@

