head	1.9;
access;
symbols
	OPENBSD_6_0:1.7.0.2
	OPENBSD_6_0_BASE:1.7
	OPENBSD_5_9:1.6.0.2
	OPENBSD_5_9_BASE:1.6;
locks; strict;
comment	@# @;


1.9
date	2016.12.05.09.02.29;	author ajacoutot;	state Exp;
branches;
next	1.8;
commitid	oQI5L2fkLhaPREvJ;

1.8
date	2016.10.17.07.51.00;	author ajacoutot;	state Exp;
branches;
next	1.7;
commitid	Wo4uP395zjJX9ZOv;

1.7
date	2016.03.09.17.29.36;	author ajacoutot;	state Exp;
branches;
next	1.6;
commitid	TFfaaPvpBDwqcHyX;

1.6
date	2016.01.22.07.05.01;	author ajacoutot;	state Exp;
branches;
next	1.5;
commitid	QxWiiXgyevTr4Srf;

1.5
date	2016.01.14.06.09.43;	author ajacoutot;	state Exp;
branches;
next	1.4;
commitid	1MTT7RUn5DsgY3tS;

1.4
date	2015.10.17.06.49.22;	author ajacoutot;	state Exp;
branches;
next	1.3;
commitid	qCaTAupMCq4yvb8q;

1.3
date	2015.10.13.05.44.18;	author ajacoutot;	state Exp;
branches;
next	1.2;
commitid	qst9LZIZleMKOm5n;

1.2
date	2015.09.23.09.16.45;	author ajacoutot;	state Exp;
branches;
next	1.1;
commitid	t74suKYQj33NdaVz;

1.1
date	2015.09.12.09.44.54;	author ajacoutot;	state Exp;
branches;
next	;
commitid	2zCvmn8WdgiiJ5l4;


desc
@@


1.9
log
@Update to ffmpeg-20161203.

from Brad (maintainer)
@
text
@$OpenBSD: patch-libavcodec_aacenc_h,v 1.8 2016/10/17 07:51:00 ajacoutot Exp $

aacenc: copy PRNG from the decoder

AAC encoder: tweak rate-distortion logic

AAC encoder: Extensive improvements

AAC encoder: memoize quantize_band_cost

aacenc: add support for changing options based on a profile

aacenc: increase size of s->planar_samples[] from 6 to 8

aacenc: shorten name of ff_aac_adjust_common_prediction

aacenc: add support for encoding files using Long Term Prediction

aacenc: switch to using the RNG from libavutil

acenc: remove deprecated avctx->frame_bits use

aacenc: remove FAAC-like coder

aacenc: use generational cache instead of resetting.

aacenc: use the decoder's lcg PRNG

aacenc: quit when the audio queue reaches 0 rather than keeping track of empty frames

--- libavcodec/aacenc.h.orig	Sat Aug 27 22:51:19 2016
+++ libavcodec/aacenc.h	Thu Nov 10 19:21:34 2016
@@@@ -33,8 +33,7 @@@@
 #include "lpc.h"
 
 typedef enum AACCoder {
-    AAC_CODER_FAAC = 0,
-    AAC_CODER_ANMR,
+    AAC_CODER_ANMR = 0,
     AAC_CODER_TWOLOOP,
     AAC_CODER_FAST,
 
@@@@ -42,11 +41,12 @@@@ typedef enum AACCoder {
 }AACCoder;
 
 typedef struct AACEncOptions {
-    int stereo_mode;
-    int aac_coder;
+    int coder;
     int pns;
     int tns;
+    int ltp;
     int pred;
+    int mid_side;
     int intensity_stereo;
 } AACEncOptions;
 
@@@@ -60,13 +60,19 @@@@ typedef struct AACCoefficientsEncoder {
     void (*quantize_and_encode_band)(struct AACEncContext *s, PutBitContext *pb, const float *in, float *out, int size,
                                      int scale_idx, int cb, const float lambda, int rtz);
     void (*encode_tns_info)(struct AACEncContext *s, SingleChannelElement *sce);
+    void (*encode_ltp_info)(struct AACEncContext *s, SingleChannelElement *sce, int common_window);
     void (*encode_main_pred)(struct AACEncContext *s, SingleChannelElement *sce);
-    void (*adjust_common_prediction)(struct AACEncContext *s, ChannelElement *cpe);
+    void (*adjust_common_pred)(struct AACEncContext *s, ChannelElement *cpe);
+    void (*adjust_common_ltp)(struct AACEncContext *s, ChannelElement *cpe);
     void (*apply_main_pred)(struct AACEncContext *s, SingleChannelElement *sce);
     void (*apply_tns_filt)(struct AACEncContext *s, SingleChannelElement *sce);
+    void (*update_ltp)(struct AACEncContext *s, SingleChannelElement *sce);
+    void (*ltp_insert_new_frame)(struct AACEncContext *s);
     void (*set_special_band_scalefactors)(struct AACEncContext *s, SingleChannelElement *sce);
     void (*search_for_pns)(struct AACEncContext *s, AVCodecContext *avctx, SingleChannelElement *sce);
+    void (*mark_pns)(struct AACEncContext *s, AVCodecContext *avctx, SingleChannelElement *sce);
     void (*search_for_tns)(struct AACEncContext *s, SingleChannelElement *sce);
+    void (*search_for_ltp)(struct AACEncContext *s, SingleChannelElement *sce, int common_window);
     void (*search_for_ms)(struct AACEncContext *s, ChannelElement *cpe);
     void (*search_for_is)(struct AACEncContext *s, AVCodecContext *avctx, ChannelElement *cpe);
     void (*search_for_pred)(struct AACEncContext *s, SingleChannelElement *sce);
@@@@ -74,6 +80,15 @@@@ typedef struct AACCoefficientsEncoder {
 
 extern AACCoefficientsEncoder ff_aac_coders[];
 
+typedef struct AACQuantizeBandCostCacheEntry {
+    float rd;
+    float energy;
+    int bits;
+    char cb;
+    char rtz;
+    uint16_t generation;
+} AACQuantizeBandCostCacheEntry;
+
 /**
  * AAC encoder context
  */
@@@@ -84,7 +99,7 @@@@ typedef struct AACEncContext {
     FFTContext mdct1024;                         ///< long (1024 samples) frame transform context
     FFTContext mdct128;                          ///< short (128 samples) frame transform context
     AVFloatDSPContext *fdsp;
-    float *planar_samples[6];                    ///< saved preprocessed input
+    float *planar_samples[8];                    ///< saved preprocessed input
 
     int profile;                                 ///< copied from avctx
     LPCContext lpc;                              ///< used by TNS
@@@@ -96,18 +111,28 @@@@ typedef struct AACEncContext {
     FFPsyContext psy;
     struct FFPsyPreprocessContext* psypp;
     AACCoefficientsEncoder *coder;
-    int cur_channel;
-    int last_frame;
+    int cur_channel;                             ///< current channel for coder context
+    int random_state;
     float lambda;
+    int last_frame_pb_count;                     ///< number of bits for the previous frame
+    float lambda_sum;                            ///< sum(lambda), for Qvg reporting
+    int lambda_count;                            ///< count(lambda), for Qvg reporting
+    enum RawDataBlockType cur_type;              ///< channel group type cur_channel belongs to
+
     AudioFrameQueue afq;
     DECLARE_ALIGNED(16, int,   qcoefs)[96];      ///< quantized coefficients
     DECLARE_ALIGNED(32, float, scoefs)[1024];    ///< scaled coefficients
 
+    uint16_t quantize_band_cost_cache_generation;
+    AACQuantizeBandCostCacheEntry quantize_band_cost_cache[256][128]; ///< memoization area for quantize_band_cost
+
     struct {
         float *samples;
     } buffer;
 } AACEncContext;
 
 void ff_aac_coder_init_mips(AACEncContext *c);
+void ff_quantize_band_cost_cache_init(struct AACEncContext *s);
+
 
 #endif /* AVCODEC_AACENC_H */
@


1.8
log
@Some more AAC fixes.

from Brad (maintainer)
@
text
@d1 1
a1 1
$OpenBSD: patch-libavcodec_aacenc_h,v 1.7 2016/03/09 17:29:36 ajacoutot Exp $
d29 2
d32 1
a32 1
+++ libavcodec/aacenc.h	Sat Oct 15 18:50:26 2016
d104 1
a104 1
@@@@ -96,18 +111,29 @@@@ typedef struct AACEncContext {
d109 1
a110 1
     int last_frame;
@


1.7
log
@Moar AAC.

from Brad (maintainer)
@
text
@d1 1
a1 1
$OpenBSD: patch-libavcodec_aacenc_h,v 1.6 2016/01/22 07:05:01 ajacoutot Exp $
d27 5
a31 11
--- libavcodec/aacenc.h.orig	Wed Jan 13 15:27:48 2016
+++ libavcodec/aacenc.h	Tue Mar  8 19:23:38 2016
@@@@ -23,6 +23,7 @@@@
 #define AVCODEC_AACENC_H
 
 #include "libavutil/float_dsp.h"
+#include "libavutil/lfg.h"
 #include "avcodec.h"
 #include "put_bits.h"
 
@@@@ -33,8 +34,7 @@@@
d41 1
a41 1
@@@@ -42,11 +42,12 @@@@ typedef enum AACCoder {
d56 1
a56 1
@@@@ -60,13 +61,19 @@@@ typedef struct AACCoefficientsEncoder {
d77 1
a77 1
@@@@ -74,6 +81,15 @@@@ typedef struct AACCoefficientsEncoder {
d93 1
a93 1
@@@@ -84,7 +100,8 @@@@ typedef struct AACEncContext {
a97 1
+    AVLFG lfg;                                   ///< PRNG needed for PNS
d102 1
a102 1
@@@@ -96,18 +113,29 @@@@ typedef struct AACEncContext {
@


1.6
log
@Yet again mor AAC fixes.

from Brad (maintainer)
@
text
@d1 1
a1 1
$OpenBSD: patch-libavcodec_aacenc_h,v 1.5 2016/01/14 06:09:43 ajacoutot Exp $
d25 2
d28 1
a28 1
+++ libavcodec/aacenc.h	Wed Jan 20 21:25:18 2016
d90 1
a90 1
+    int bits; ///< -1 means uninitialized entry
d93 1
a93 1
+    char padding[2]; ///< Keeps the entry size a multiple of 32 bits
d109 1
a109 1
@@@@ -96,18 +113,28 @@@@ typedef struct AACEncContext {
d127 1
@


1.5
log
@Update to ffmpeg-20160113.

from Brad (maintainer)
@
text
@d1 1
a1 1
$OpenBSD: patch-libavcodec_aacenc_h,v 1.4 2015/10/17 06:49:22 ajacoutot Exp $
d23 2
d26 1
a26 1
+++ libavcodec/aacenc.h	Wed Jan 13 17:11:38 2016
d35 11
a45 1
@@@@ -42,11 +43,12 @@@@ typedef enum AACCoder {
d60 1
a60 1
@@@@ -60,13 +62,19 @@@@ typedef struct AACCoefficientsEncoder {
d81 1
a81 1
@@@@ -74,6 +82,15 @@@@ typedef struct AACCoefficientsEncoder {
d97 1
a97 1
@@@@ -84,7 +101,8 @@@@ typedef struct AACEncContext {
d107 1
a107 1
@@@@ -96,18 +114,28 @@@@ typedef struct AACEncContext {
@


1.4
log
@Guess what... more AAC stuffs.

from Brad (maintainer)
@
text
@d1 1
a1 1
$OpenBSD: patch-libavcodec_aacenc_h,v 1.3 2015/10/13 05:44:18 ajacoutot Exp $
d19 15
a33 3
--- libavcodec/aacenc.h.orig	Mon Sep  7 21:58:01 2015
+++ libavcodec/aacenc.h	Fri Oct 16 23:46:05 2015
@@@@ -42,11 +42,12 @@@@ typedef enum AACCoder {
d48 1
a48 1
@@@@ -60,13 +61,19 @@@@ typedef struct AACCoefficientsEncoder {
d69 1
a69 1
@@@@ -74,6 +81,15 @@@@ typedef struct AACCoefficientsEncoder {
d85 1
a85 1
@@@@ -84,7 +100,7 @@@@ typedef struct AACEncContext {
d90 1
d95 1
a95 1
@@@@ -96,18 +112,27 @@@@ typedef struct AACEncContext {
d104 1
@


1.3
log
@Some more AAC stuffs.

from Brad (maintainer)
@
text
@d1 1
a1 1
$OpenBSD: patch-libavcodec_aacenc_h,v 1.2 2015/09/23 09:16:45 ajacoutot Exp $
d17 2
d20 2
a21 2
+++ libavcodec/aacenc.h	Mon Oct 12 22:06:52 2015
@@@@ -42,11 +42,11 @@@@ typedef enum AACCoder {
d30 1
d36 2
a37 1
@@@@ -61,11 +61,12 @@@@ typedef struct AACCoefficientsEncoder {
d40 1
d44 1
d47 2
d53 1
d56 2
a57 1
@@@@ -74,6 +75,15 @@@@ typedef struct AACCoefficientsEncoder {
d73 1
a73 1
@@@@ -84,7 +94,7 @@@@ typedef struct AACEncContext {
d82 1
a82 1
@@@@ -96,18 +106,27 @@@@ typedef struct AACEncContext {
@


1.2
log
@Yet again more AAC encoder fixes.

from Brad (maintainer)
@
text
@d1 1
a1 1
$OpenBSD: patch-libavcodec_aacenc_h,v 1.1 2015/09/12 09:44:54 ajacoutot Exp $
d7 10
d18 55
a72 2
+++ libavcodec/aacenc.h	Wed Sep 23 03:54:58 2015
@@@@ -96,9 +96,12 @@@@ typedef struct AACEncContext {
d81 2
d88 13
@


1.1
log
@Back port some AAC encoder fixes.

from Brad (maintainer)
@
text
@d1 1
a1 1
$OpenBSD$
d5 7
a11 3
--- libavcodec/aacenc.h.orig	Sat Sep 12 02:09:39 2015
+++ libavcodec/aacenc.h	Sat Sep 12 02:09:54 2015
@@@@ -98,6 +98,7 @@@@ typedef struct AACEncContext {
d13 2
a14 1
     int cur_channel;
d18 2
d22 1
@

