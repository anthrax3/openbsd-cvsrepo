head	1.4;
access;
symbols
	OPENBSD_5_9:1.3.0.4
	OPENBSD_5_9_BASE:1.3
	OPENBSD_5_8:1.3.0.2;
locks; strict;
comment	@# @;


1.4
date	2016.05.03.06.05.49;	author ajacoutot;	state dead;
branches;
next	1.3;
commitid	VfdMmnXKIRQjKU4e;

1.3
date	2016.01.16.09.01.26;	author ajacoutot;	state Exp;
branches
	1.3.2.1;
next	1.2;
commitid	mJ17aVxdt3NrfqC7;

1.2
date	2015.11.16.06.36.55;	author ajacoutot;	state dead;
branches;
next	1.1;
commitid	QCUZ5eWQ2FAYYhVH;

1.1
date	2015.10.03.19.39.47;	author sthen;	state Exp;
branches;
next	;
commitid	DgxpqhOGbZEUfetT;

1.3.2.1
date	2016.01.16.09.40.53;	author jasper;	state Exp;
branches;
next	;
commitid	AqY6BdU4BYWn69k6;


desc
@@


1.4
log
@Update to a newer snapshot: ffmpeg-20160502.

from Brad (maintainer)
@
text
@$OpenBSD: patch-libavformat_hls_c,v 1.3 2016/01/16 09:01:26 ajacoutot Exp $

avformat/hls: forbid all protocols except http(s) & file

avformat/hls: More strict url checks

avformat/hls: Even stricter URL checks

CVE-2016-1897 and CVE-2016-1898

--- libavformat/hls.c.orig	Fri Jan 15 17:56:38 2016
+++ libavformat/hls.c	Fri Jan 15 17:58:41 2016
@@@@ -618,6 +618,18 @@@@ static int open_url(HLSContext *c, URLContext **uc, co
 {
     AVDictionary *tmp = NULL;
     int ret;
+    const char *proto_name = avio_find_protocol_name(url);
+
+    if (!proto_name)
+        return AVERROR_INVALIDDATA;
+
+    // only http(s) & file are allowed
+    if (!av_strstart(proto_name, "http", NULL) && !av_strstart(proto_name, "file", NULL))
+        return AVERROR_INVALIDDATA;
+    if (!strncmp(proto_name, url, strlen(proto_name)) && url[strlen(proto_name)] == ':')
+        ;
+    else if (strcmp(proto_name, "file") || !strncmp(url, "file,", 5))
+        return AVERROR_INVALIDDATA;
 
     av_dict_copy(&tmp, c->avio_opts, 0);
     av_dict_copy(&tmp, opts, 0);
@


1.3
log
@SECURITY fix for the AppleHTTP / HLS demuxers.
CVE-2016-1897 and CVE-2016-1898

from Brad (maintainer)
@
text
@d1 1
a1 1
$OpenBSD$
@


1.3.2.1
log
@SECURITY fix for the AppleHTTP / HLS demuxers.
CVE-2016-1897 and CVE-2016-1898
from Brad (maintainer)
@
text
@d11 6
a16 7
--- libavformat/hls.c.orig	Fri Jan 15 19:54:00 2016
+++ libavformat/hls.c	Fri Jan 15 20:00:39 2016
@@@@ -913,6 +913,23 @@@@ static void update_options(char **dest, const char *na
         av_freep(dest);
 }
 
+static int check_url(const char *url) {
d22 1
a24 1
+
d26 1
a26 1
+        return 0;
a28 17
+
+    return 0;
+}
+
 static int open_input(HLSContext *c, struct playlist *pls)
 {
     AVDictionary *opts = NULL;
@@@@ -940,6 +957,10 @@@@ static int open_input(HLSContext *c, struct playlist *
            seg->url, seg->url_offset, pls->index);
 
     if (seg->key_type == KEY_NONE) {
+        ret = check_url(seg->url);
+        if (ret < 0)
+            goto cleanup;
+
         ret = ffurl_open(&pls->input, seg->url, AVIO_FLAG_READ,
                           &pls->parent->interrupt_callback, &opts);
d30 2
a31 11
@@@@ -947,6 +968,10 @@@@ static int open_input(HLSContext *c, struct playlist *
         char iv[33], key[33], url[MAX_URL_SIZE];
         if (strcmp(seg->key, pls->key_url)) {
             URLContext *uc;
+            ret = check_url(seg->key);
+            if (ret < 0)
+                goto cleanup;
+
             if (ffurl_open(&uc, seg->key, AVIO_FLAG_READ,
                            &pls->parent->interrupt_callback, &opts2) == 0) {
                 if (ffurl_read_complete(uc, pls->key, sizeof(pls->key))
@


1.2
log
@Update to FFmpeg 20151112 (2.8.2).

from Brad (maintainer)
@
text
@d1 1
a1 1
$OpenBSD: patch-libavformat_hls_c,v 1.1 2015/10/03 19:39:47 sthen Exp $
d3 1
a3 5
From 26eb2940079d0ec433cf9b2deae24560707cbcf8 Mon Sep 17 00:00:00 2001
From: wm4 <nfxjfg@@googlemail.com>
Date: Mon, 21 Sep 2015 14:43:06 +0200
Subject: [PATCH] avformat/hls: fix some cases of HLS streams which require
 cookies
d5 26
a30 3
--- libavformat/hls.c.orig	Sat Oct  3 12:33:34 2015
+++ libavformat/hls.c	Sat Oct  3 12:33:55 2015
@@@@ -516,15 +516,11 @@@@ static int url_connect(struct playlist *pls, AVDiction
a31 15
     av_dict_copy(&tmp, opts2, 0);
 
-    if ((ret = av_opt_set_dict(pls->input, &tmp)) < 0)
-        goto fail;
-
-    if ((ret = ffurl_connect(pls->input, NULL)) < 0) {
+    if ((ret = ffurl_connect(pls->input, &tmp)) < 0) {
         ffurl_close(pls->input);
         pls->input = NULL;
     }
 
-fail:
     av_dict_free(&tmp);
     return ret;
 }
@


1.1
log
@backport an FFmpeg fix for problems with some cases of HLS streams
requiring cookies.  ok brad
@
text
@d1 1
a1 1
$OpenBSD$
@

