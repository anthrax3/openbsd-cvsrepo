head	1.2;
access;
symbols
	OPENBSD_6_2:1.2.0.62
	OPENBSD_6_2_BASE:1.2
	OPENBSD_6_1:1.2.0.60
	OPENBSD_6_1_BASE:1.2
	OPENBSD_6_0:1.2.0.58
	OPENBSD_6_0_BASE:1.2
	OPENBSD_5_9:1.2.0.54
	OPENBSD_5_9_BASE:1.2
	OPENBSD_5_8:1.2.0.56
	OPENBSD_5_8_BASE:1.2
	OPENBSD_5_7:1.2.0.52
	OPENBSD_5_7_BASE:1.2
	OPENBSD_5_6:1.2.0.50
	OPENBSD_5_6_BASE:1.2
	OPENBSD_5_5:1.2.0.48
	OPENBSD_5_5_BASE:1.2
	OPENBSD_5_4:1.2.0.46
	OPENBSD_5_4_BASE:1.2
	OPENBSD_5_3:1.2.0.44
	OPENBSD_5_3_BASE:1.2
	OPENBSD_5_2:1.2.0.42
	OPENBSD_5_2_BASE:1.2
	OPENBSD_5_1_BASE:1.2
	OPENBSD_5_1:1.2.0.40
	OPENBSD_5_0:1.2.0.38
	OPENBSD_5_0_BASE:1.2
	OPENBSD_4_9:1.2.0.36
	OPENBSD_4_9_BASE:1.2
	OPENBSD_4_8:1.2.0.34
	OPENBSD_4_8_BASE:1.2
	OPENBSD_4_7:1.2.0.32
	OPENBSD_4_7_BASE:1.2
	OPENBSD_4_6:1.2.0.30
	OPENBSD_4_6_BASE:1.2
	OPENBSD_4_5:1.2.0.28
	OPENBSD_4_5_BASE:1.2
	OPENBSD_4_4:1.2.0.26
	OPENBSD_4_4_BASE:1.2
	OPENBSD_4_3:1.2.0.24
	OPENBSD_4_3_BASE:1.2
	OPENBSD_4_2:1.2.0.22
	OPENBSD_4_2_BASE:1.2
	OPENBSD_4_1:1.2.0.20
	OPENBSD_4_1_BASE:1.2
	OPENBSD_4_0:1.2.0.18
	OPENBSD_4_0_BASE:1.2
	OPENBSD_3_9:1.2.0.16
	OPENBSD_3_9_BASE:1.2
	OPENBSD_3_8:1.2.0.14
	OPENBSD_3_8_BASE:1.2
	OPENBSD_3_7:1.2.0.12
	OPENBSD_3_7_BASE:1.2
	OPENBSD_3_6:1.2.0.10
	OPENBSD_3_6_BASE:1.2
	OPENBSD_3_5:1.2.0.8
	OPENBSD_3_5_BASE:1.2
	OPENBSD_3_4:1.2.0.6
	OPENBSD_3_4_BASE:1.2
	OPENBSD_3_3:1.2.0.4
	OPENBSD_3_3_BASE:1.2
	OPENBSD_3_2:1.2.0.2
	OPENBSD_3_2_BASE:1.2
	OPENBSD_3_1:1.1.1.1.0.4
	OPENBSD_3_1_BASE:1.1.1.1
	OPENBSD_3_0:1.1.1.1.0.2
	OPENBSD_3_0_BASE:1.1.1.1
	OPENBSD_2_9_TRACKING_SWITCH:1.1.1.1
	mplex:1.1.1.1
	angelos:1.1.1;
locks; strict;
comment	@# @;


1.2
date	2002.08.12.19.33.31;	author wcobb;	state Exp;
branches;
next	1.1;

1.1
date	2001.06.19.03.23.26;	author angelos;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2001.06.19.03.23.26;	author angelos;	state Exp;
branches;
next	;


desc
@@


1.2
log
@- pull in missing prototypes.
- fix format strings.
- remove unnecessary statics from headers, reduce executable size.
- disable insane verbosity that just slows down encoding.
@
text
@$OpenBSD: patch-multplex_c,v 1.1.1.1 2001/06/19 03:23:26 angelos Exp $
--- multplex.c.orig	Tue Jun  6 09:16:52 1995
+++ multplex.c	Thu Jul 18 15:57:13 2002
@@@@ -1,4 +1,5 @@@@
 #include "main.h"
+extern int Interactive;
 #ifdef TIMER
     extern long total_sec;
     extern long total_usec;
@@@@ -45,11 +46,11 @@@@ unsigned int    which_streams;
 
 {
 
-    FILE *istream_v;			/* Inputstream Video	*/
-    FILE *istream_a;			/* Inputstream Audio	*/
+    FILE *istream_v = NULL;		/* Inputstream Video	*/
+    FILE *istream_a = NULL;		/* Inputstream Audio	*/
     FILE *ostream;			/* Outputstream MPEG	*/
-    FILE *vunits_info;			/* Input Video Units	*/
-    FILE *aunits_info;			/* Input Audio Units	*/
+    FILE *vunits_info = NULL;		/* Input Video Units	*/
+    FILE *aunits_info = NULL;		/* Input Audio Units	*/
 
     Vaunit_struc video_au;		/* Video Access Unit	*/
     Aaunit_struc audio_au;		/* Audio Access Unit	*/
@@@@ -67,7 +68,6 @@@@ unsigned int    which_streams;
     unsigned int mux_rate;
     unsigned char picture_start;
     unsigned char audio_frame_start;
-    unsigned int bytes_left;
     unsigned int audio_bytes;
     unsigned int video_bytes;
 
@@@@ -76,7 +76,9 @@@@ unsigned int    which_streams;
     unsigned int nsec_p=0;
 
     unsigned char* index;
-	
+
+    extern unsigned int bitrate_index[3][16];
+
     Timecode_struc SCR_audio_delay;
     Timecode_struc SCR_video_delay;
     Timecode_struc current_SCR;
@@@@ -89,7 +91,6 @@@@ unsigned int    which_streams;
     Pack_struc 		pack;
     Sys_header_struc 	sys_header;
     Sector_struc 	sector;
-    Timecode_struc	timestamp;
 
     unsigned long sector_size;
     unsigned long min_packet_data;
@@@@ -129,6 +130,7 @@@@ unsigned int    which_streams;
 	picture_start = TRUE;
     }
 
+if( Interactive ) {
 printf("\nMerging elementary streams to MPEG/SYSTEMS multiplexed stream.\n");
 printf("\n+------------------ MPEG/SYSTEMS INFORMATION -----------------+\n");
     
@@@@ -144,6 +146,12 @@@@ printf("\n+------------------ MPEG/SYSTE
     scanf ("%ld", &video_buffer_size);
     printf   ("STD audio buffer in kB (CSPS: max  4 kB) : ");
     scanf ("%ld", &audio_buffer_size);
+} else {
+    sector_size=2324;
+    packets_per_pack=1;
+    video_buffer_size=46;
+    audio_buffer_size=4;
+}
 
     write_pack = packets_per_pack;
     video_buffer_size *= 1024;
@@@@ -197,21 +205,31 @@@@ printf("\n+------------------ MPEG/SYSTE
 		 (double)(packets_per_pack-1.))) / (double)(packets_per_pack) );
     data_rate = ceil(dmux_rate/50.)*50;
 
+if( Interactive ) {
     printf ("\ncomputed multiplexed stream data rate    : %7.3f\n",dmux_rate);
     printf ("target data rate (e.g. %6u)           : ",data_rate);
     scanf  ("%lf", &dmux_rate);
     printf ("\nstartup sectors_delay                    : ");
-    scanf  ("%u", &sectors_delay);
+    scanf  ("%lu", &sectors_delay);
     printf ("video stream startup offset (ms)         : ");
-    scanf  ("%u", &video_delay_ms);
+    scanf  ("%lu", &video_delay_ms);
     printf ("audio stream startup offset (ms)         : ");
-    scanf  ("%u", &audio_delay_ms);
+    scanf  ("%lu", &audio_delay_ms);
+} else {
+    dmux_rate=data_rate;
+    sectors_delay=8;
+    video_delay_ms=0;
+    audio_delay_ms=0;
+}
 
     video_delay = (double)video_delay_ms*(double)(CLOCKS/1000);
     audio_delay = (double)audio_delay_ms*(double)(CLOCKS/1000);
 
+if( Interactive ) {
     verbose=ask_verbose();
     printf ("\n");
+} else
+    verbose=1;
 
 #ifdef TIMER
     gettimeofday (&tp_global_start,NULL);
@@@@ -501,8 +519,6 @@@@ printf("\n+------------------ MPEG/SYSTE
     if (which_streams & STREAMS_VIDEO) unlink (video_units);
     if (which_streams & STREAMS_AUDIO) unlink (audio_units); 
 
-    printf ("\nDone, tmp files removed.\n\n");
-
 #ifdef TIMER
     gettimeofday (&tp_global_end, NULL);
     global_sec = 10*(tp_global_end.tv_sec - tp_global_start.tv_sec);
@@@@ -1051,8 +1067,6 @@@@ unsigned char marker_pack;
 unsigned int which_streams;
 
 {
-    unsigned int bytes_left;
-    unsigned int temp;
     Pack_struc *pack_ptr;
     Sys_header_struc *sys_header_ptr;
 
@


1.1
log
@Initial revision
@
text
@d1 3
a3 3
$OpenBSD$
--- multplex.c.orig	Tue Jun  6 08:16:52 1995
+++ multplex.c	Sun Jun 10 00:43:14 2001
d10 43
d74 1
a74 1
@@@@ -197,6 +205,7 @@@@ printf("\n+------------------ MPEG/SYSTE
d82 6
a87 2
@@@@ -206,12 +215,21 @@@@ printf("\n+------------------ MPEG/SYSTE
     scanf  ("%u", &video_delay_ms);
d89 2
a90 1
     scanf  ("%u", &audio_delay_ms);
d109 18
@


1.1.1.1
log
@Initial import of mplex, based on FreeBSD port.

Multiplex MPEG video/audio streams.
@
text
@@
