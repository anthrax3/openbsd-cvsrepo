head	1.3;
access;
symbols
	OPENBSD_3_6:1.2.0.26
	OPENBSD_3_6_BASE:1.2
	OPENBSD_3_5:1.2.0.24
	OPENBSD_3_5_BASE:1.2
	OPENBSD_3_4:1.2.0.22
	OPENBSD_3_4_BASE:1.2
	OPENBSD_3_3:1.2.0.20
	OPENBSD_3_3_BASE:1.2
	OPENBSD_3_2:1.2.0.18
	OPENBSD_3_2_BASE:1.2
	OPENBSD_3_1:1.2.0.16
	OPENBSD_3_1_BASE:1.2
	OPENBSD_3_0:1.2.0.14
	OPENBSD_3_0_BASE:1.2
	OPENBSD_2_9_TRACKING_SWITCH:1.2
	OPENBSD_2_9:1.2.0.12
	OPENBSD_2_9_BASE:1.2
	OPENBSD_2_8:1.2.0.10
	OPENBSD_2_8_BASE:1.2
	OPENBSD_2_7:1.2.0.8
	OPENBSD_2_7_BASE:1.2
	OPENBSD_2_6:1.2.0.6
	OPENBSD_2_6_BASE:1.2
	OPENBSD_2_5:1.2.0.4
	OPENBSD_2_5_BASE:1.2
	OPENBSD_2_4:1.2.0.2
	OPENBSD_2_4_BASE:1.2
	OPENBSD_2_3:1.1.1.1.0.2
	OPENBSD_2_3_BASE:1.1.1.1
	marc-1998-mar-20:1.1.1.1
	marc:1.1.1;
locks; strict;
comment	@# @;


1.3
date	2004.09.21.18.46.04;	author sturm;	state dead;
branches;
next	1.2;

1.2
date	98.04.26.00.24.29;	author angelos;	state Exp;
branches
	1.2.24.1
	1.2.26.1;
next	1.1;

1.1
date	98.03.21.05.38.13;	author marc;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	98.03.21.05.38.13;	author marc;	state Exp;
branches;
next	;

1.2.24.1
date	2005.03.15.22.23.45;	author robert;	state Exp;
branches;
next	1.2.24.2;

1.2.24.2
date	2005.04.16.21.18.34;	author sturm;	state dead;
branches;
next	;

1.2.26.1
date	2005.03.15.22.18.44;	author robert;	state Exp;
branches;
next	1.2.26.2;

1.2.26.2
date	2005.04.16.21.22.07;	author sturm;	state dead;
branches;
next	;


desc
@@


1.3
log
@Add some sanity checking in XV. Patches from Marcus Meissner
adapted by rohee@@ by way of millert@@

while here, adapt patches to regular naming scheme
@
text
@*** xv.c.orig	Sat Apr 25 20:01:14 1998
--- xv.c	Sat Apr 25 20:07:30 1998
***************
*** 1990,1999 ****
  #else /* it is VMS */
        sprintf(filename, "[]xvXXXXXX");
  #endif
!       mktemp(filename);
  
        clearerr(stdin);
-       fp = fopen(filename,"w");
        if (!fp) FatalError("openPic(): can't write temporary file");
      
        while ( (i=getchar()) != EOF) putc(i,fp);
--- 1990,1998 ----
  #else /* it is VMS */
        sprintf(filename, "[]xvXXXXXX");
  #endif
!       fp = fdopen(mkstemp(filename), "w");
  
        clearerr(stdin);
        if (!fp) FatalError("openPic(): can't write temporary file");
      
        while ( (i=getchar()) != EOF) putc(i,fp);
***************
*** 2755,2761 ****
    
  #ifndef VMS
    sprintf(uncompname, "%s/xvuXXXXXX", tmpdir);
!   mktemp(uncompname);
    sprintf(buf,"%s -c %s >%s", UNCOMPRESS, fname, uncompname);
  #else /* it IS VMS */
    strcpy(uncompname, "[]xvuXXXXXX");
--- 2754,2760 ----
    
  #ifndef VMS
    sprintf(uncompname, "%s/xvuXXXXXX", tmpdir);
!   close(mkstemp(uncompname));
    sprintf(buf,"%s -c %s >%s", UNCOMPRESS, fname, uncompname);
  #else /* it IS VMS */
    strcpy(uncompname, "[]xvuXXXXXX");
***************
*** 2930,2937 ****
    if (!cmd || (strlen(cmd) < (size_t) 2)) return 1;
  
    sprintf(tmpname,"%s/xvXXXXXX", tmpdir);
!   mktemp(tmpname);
!   if (tmpname[0] == '\0') {   /* mktemp() blew up */
      sprintf(str,"Unable to create temporary filename.");
      ErrPopUp(str, "\nHow unlikely!");
      return 1;
--- 2929,2936 ----
    if (!cmd || (strlen(cmd) < (size_t) 2)) return 1;
  
    sprintf(tmpname,"%s/xvXXXXXX", tmpdir);
!   close(mkstemp(tmpname));
!   if (tmpname[0] == '\0') {   /* mkstemp() blew up */
      sprintf(str,"Unable to create temporary filename.");
      ErrPopUp(str, "\nHow unlikely!");
      return 1;
***************
*** 3228,3236 ****
    hints.flags = 0;
    if ((i&XValue || i&YValue)) hints.flags = USPosition;
  
!   if (i&XValue && i&XNegative) x = vrWIDE - eWIDE - abs(x);
!   if (i&YValue && i&YNegative) y = vrHIGH - eHIGH - abs(y);
! 
    if (x+eWIDE > vrWIDE) x = vrWIDE - eWIDE;   /* keep on screen */
    if (y+eHIGH > vrHIGH) y = vrHIGH - eHIGH;
  
--- 3227,3243 ----
    hints.flags = 0;
    if ((i&XValue || i&YValue)) hints.flags = USPosition;
  
!   hints.win_gravity = NorthWestGravity;
!   if (i&XValue && i&XNegative) {
!     hints.win_gravity = NorthEastGravity;
!     x = vrWIDE - (eWIDE + 2 * bwidth) - abs(x);
!   }
!   if (i&YValue && i&YNegative) {
!     hints.win_gravity = (hints.win_gravity == NorthWestGravity) ?
! 	SouthWestGravity : SouthEastGravity;
!     y = vrHIGH - (eHIGH + 2 * bwidth) - abs(y);
!   }
!  
    if (x+eWIDE > vrWIDE) x = vrWIDE - eWIDE;   /* keep on screen */
    if (y+eHIGH > vrHIGH) y = vrHIGH - eHIGH;
  
***************
*** 3249,3255 ****
    hints.x = x;                  hints.y = y;
    hints.width = eWIDE;          hints.height = eHIGH;
    hints.max_width  = maxWIDE;   hints.max_height = maxHIGH;
!   hints.flags |= USSize | PMaxSize;
      
    xswa.bit_gravity = StaticGravity;
    xswa.background_pixel = bg;
--- 3256,3262 ----
    hints.x = x;                  hints.y = y;
    hints.width = eWIDE;          hints.height = eHIGH;
    hints.max_width  = maxWIDE;   hints.max_height = maxHIGH;
!   hints.flags |= USSize | PMaxSize | PWinGravity;
      
    xswa.bit_gravity = StaticGravity;
    xswa.background_pixel = bg;
***************
*** 3298,3307 ****
      }
    }
  
- 
-   XSetStandardProperties(theDisp,mainW,"","",None,NULL,0,&hints);
-   setWinIconNames(name);
- 
    xwmh.input = True;
    xwmh.flags = InputHint;
  
--- 3305,3310 ----
***************
*** 3326,3337 ****
        }
      }
    }
-   XSetWMHints(theDisp, mainW, &xwmh);
  
    classh.res_name = "xv";
    classh.res_class = "XVroot";
-   XSetClassHint(theDisp, mainW, &classh);
  
  
    if (nodecor) {   /* turn of image window decorations (in MWM) */ 
      Atom mwm_wm_hints;
--- 3329,3340 ----
        }
      }
    }
  
    classh.res_name = "xv";
    classh.res_class = "XVroot";
  
+   XmbSetWMProperties(theDisp, mainW, NULL, NULL, NULL, 0, &hints, &xwmh, &classh);
+   setWinIconNames(name);
  
    if (nodecor) {   /* turn of image window decorations (in MWM) */ 
      Atom mwm_wm_hints;
@


1.2
log
@mktemp->mkstemp
@
text
@@


1.2.24.1
log
@SECURITY:
Fix a format string vulnerability in the handling of image filenames.
http://www.vuxml.org/openbsd/4d960e7a-9537-11d9-9fda-080020fe8945.html

ok brad@@
@
text
@d1 146
a146 100
$OpenBSD$
--- xv.c.orig	Tue Mar 15 22:46:29 2005
+++ xv.c	Tue Mar 15 22:47:06 2005
@@@@ -1990,10 +1990,9 @@@@
 #else /* it is VMS */
       sprintf(filename, "[]xvXXXXXX");
 #endif
-      mktemp(filename);
+      fp = fdopen(mkstemp(filename), "w");
 
       clearerr(stdin);
-      fp = fopen(filename,"w");
       if (!fp) FatalError("openPic(): can't write temporary file");
     
       while ( (i=getchar()) != EOF) putc(i,fp);
@@@@ -2219,7 +2218,7 @@@@
   SetISTR(ISTR_INFO,formatStr);
 	
   SetInfoMode(INF_PART);
-  SetISTR(ISTR_FILENAME, 
+  SetISTR(ISTR_FILENAME, "%s",
 	  (filenum==DFLTPIC || filenum==GRABBED || frompipe)
 	  ? "<none>" : basefname);
 
@@@@ -2759,7 +2758,7 @@@@
   
 #ifndef VMS
   sprintf(uncompname, "%s/xvuXXXXXX", tmpdir);
-  mktemp(uncompname);
+  close(mkstemp(uncompname));
   sprintf(buf,"%s -c %s >%s", UNCOMPRESS, fname, uncompname);
 #else /* it IS VMS */
   strcpy(uncompname, "[]xvuXXXXXX");
@@@@ -2934,8 +2933,8 @@@@
   if (!cmd || (strlen(cmd) < (size_t) 2)) return 1;
 
   sprintf(tmpname,"%s/xvXXXXXX", tmpdir);
-  mktemp(tmpname);
-  if (tmpname[0] == '\0') {   /* mktemp() blew up */
+  close(mkstemp(tmpname));
+  if (tmpname[0] == '\0') {   /* mkstemp() blew up */
     sprintf(str,"Unable to create temporary filename.");
     ErrPopUp(str, "\nHow unlikely!");
     return 1;
@@@@ -3232,9 +3231,17 @@@@
   hints.flags = 0;
   if ((i&XValue || i&YValue)) hints.flags = USPosition;
 
-  if (i&XValue && i&XNegative) x = vrWIDE - eWIDE - abs(x);
-  if (i&YValue && i&YNegative) y = vrHIGH - eHIGH - abs(y);
-
+  hints.win_gravity = NorthWestGravity;
+  if (i&XValue && i&XNegative) {
+    hints.win_gravity = NorthEastGravity;
+    x = vrWIDE - (eWIDE + 2 * bwidth) - abs(x);
+  }
+  if (i&YValue && i&YNegative) {
+    hints.win_gravity = (hints.win_gravity == NorthWestGravity) ?
+	SouthWestGravity : SouthEastGravity;
+    y = vrHIGH - (eHIGH + 2 * bwidth) - abs(y);
+  }
+ 
   if (x+eWIDE > vrWIDE) x = vrWIDE - eWIDE;   /* keep on screen */
   if (y+eHIGH > vrHIGH) y = vrHIGH - eHIGH;
 
@@@@ -3253,7 +3260,7 @@@@
   hints.x = x;                  hints.y = y;
   hints.width = eWIDE;          hints.height = eHIGH;
   hints.max_width  = maxWIDE;   hints.max_height = maxHIGH;
-  hints.flags |= USSize | PMaxSize;
+  hints.flags |= USSize | PMaxSize | PWinGravity;
     
   xswa.bit_gravity = StaticGravity;
   xswa.background_pixel = bg;
@@@@ -3302,10 +3309,6 @@@@
     }
   }
 
-
-  XSetStandardProperties(theDisp,mainW,"","",None,NULL,0,&hints);
-  setWinIconNames(name);
-
   xwmh.input = True;
   xwmh.flags = InputHint;
 
@@@@ -3330,12 +3333,12 @@@@
       }
     }
   }
-  XSetWMHints(theDisp, mainW, &xwmh);
 
   classh.res_name = "xv";
   classh.res_class = "XVroot";
-  XSetClassHint(theDisp, mainW, &classh);
 
+  XmbSetWMProperties(theDisp, mainW, NULL, NULL, NULL, 0, &hints, &xwmh, &classh);
+  setWinIconNames(name);
 
   if (nodecor) {   /* turn of image window decorations (in MWM) */ 
     Atom mwm_wm_hints;
@


1.2.24.2
log
@MFC:

SECURITY:
Fixes for multiple vulnerabilities.  Switch to centralized jumbo patch.

ok brad@@
@
text
@d1 1
a1 1
$OpenBSD: patch-af,v 1.2.24.1 2005/03/15 22:23:45 robert Exp $
@


1.2.26.1
log
@SECURITY:
Fix a format string vulnerability in the handling of image filenames.
http://www.vuxml.org/openbsd/4d960e7a-9537-11d9-9fda-080020fe8945.html

ok brad@@
@
text
@d1 146
a146 100
$OpenBSD$
--- xv.c.orig	Tue Mar 15 22:46:29 2005
+++ xv.c	Tue Mar 15 22:47:06 2005
@@@@ -1990,10 +1990,9 @@@@
 #else /* it is VMS */
       sprintf(filename, "[]xvXXXXXX");
 #endif
-      mktemp(filename);
+      fp = fdopen(mkstemp(filename), "w");
 
       clearerr(stdin);
-      fp = fopen(filename,"w");
       if (!fp) FatalError("openPic(): can't write temporary file");
     
       while ( (i=getchar()) != EOF) putc(i,fp);
@@@@ -2219,7 +2218,7 @@@@
   SetISTR(ISTR_INFO,formatStr);
 	
   SetInfoMode(INF_PART);
-  SetISTR(ISTR_FILENAME, 
+  SetISTR(ISTR_FILENAME, "%s",
 	  (filenum==DFLTPIC || filenum==GRABBED || frompipe)
 	  ? "<none>" : basefname);
 
@@@@ -2759,7 +2758,7 @@@@
   
 #ifndef VMS
   sprintf(uncompname, "%s/xvuXXXXXX", tmpdir);
-  mktemp(uncompname);
+  close(mkstemp(uncompname));
   sprintf(buf,"%s -c %s >%s", UNCOMPRESS, fname, uncompname);
 #else /* it IS VMS */
   strcpy(uncompname, "[]xvuXXXXXX");
@@@@ -2934,8 +2933,8 @@@@
   if (!cmd || (strlen(cmd) < (size_t) 2)) return 1;
 
   sprintf(tmpname,"%s/xvXXXXXX", tmpdir);
-  mktemp(tmpname);
-  if (tmpname[0] == '\0') {   /* mktemp() blew up */
+  close(mkstemp(tmpname));
+  if (tmpname[0] == '\0') {   /* mkstemp() blew up */
     sprintf(str,"Unable to create temporary filename.");
     ErrPopUp(str, "\nHow unlikely!");
     return 1;
@@@@ -3232,9 +3231,17 @@@@
   hints.flags = 0;
   if ((i&XValue || i&YValue)) hints.flags = USPosition;
 
-  if (i&XValue && i&XNegative) x = vrWIDE - eWIDE - abs(x);
-  if (i&YValue && i&YNegative) y = vrHIGH - eHIGH - abs(y);
-
+  hints.win_gravity = NorthWestGravity;
+  if (i&XValue && i&XNegative) {
+    hints.win_gravity = NorthEastGravity;
+    x = vrWIDE - (eWIDE + 2 * bwidth) - abs(x);
+  }
+  if (i&YValue && i&YNegative) {
+    hints.win_gravity = (hints.win_gravity == NorthWestGravity) ?
+	SouthWestGravity : SouthEastGravity;
+    y = vrHIGH - (eHIGH + 2 * bwidth) - abs(y);
+  }
+ 
   if (x+eWIDE > vrWIDE) x = vrWIDE - eWIDE;   /* keep on screen */
   if (y+eHIGH > vrHIGH) y = vrHIGH - eHIGH;
 
@@@@ -3253,7 +3260,7 @@@@
   hints.x = x;                  hints.y = y;
   hints.width = eWIDE;          hints.height = eHIGH;
   hints.max_width  = maxWIDE;   hints.max_height = maxHIGH;
-  hints.flags |= USSize | PMaxSize;
+  hints.flags |= USSize | PMaxSize | PWinGravity;
     
   xswa.bit_gravity = StaticGravity;
   xswa.background_pixel = bg;
@@@@ -3302,10 +3309,6 @@@@
     }
   }
 
-
-  XSetStandardProperties(theDisp,mainW,"","",None,NULL,0,&hints);
-  setWinIconNames(name);
-
   xwmh.input = True;
   xwmh.flags = InputHint;
 
@@@@ -3330,12 +3333,12 @@@@
       }
     }
   }
-  XSetWMHints(theDisp, mainW, &xwmh);
 
   classh.res_name = "xv";
   classh.res_class = "XVroot";
-  XSetClassHint(theDisp, mainW, &classh);
 
+  XmbSetWMProperties(theDisp, mainW, NULL, NULL, NULL, 0, &hints, &xwmh, &classh);
+  setWinIconNames(name);
 
   if (nodecor) {   /* turn of image window decorations (in MWM) */ 
     Atom mwm_wm_hints;
@


1.2.26.2
log
@MFC:

SECURITY:
Fixes for multiple vulnerabilities. Switch to centralized jumbo patch.

ok brad@@
@
text
@d1 1
a1 1
$OpenBSD: patch-af,v 1.2.26.1 2005/03/15 22:18:44 robert Exp $
@


1.1
log
@Initial revision
@
text
@d1 146
a146 58
--- xv.c.orig	Sat Mar  8 16:29:05 1997
+++ xv.c	Sat Mar  8 16:38:48 1997
@@@@ -3197,9 +3197,17 @@@@
   hints.flags = 0;
   if ((i&XValue || i&YValue)) hints.flags = USPosition;
 
-  if (i&XValue && i&XNegative) x = vrWIDE - eWIDE - abs(x);
-  if (i&YValue && i&YNegative) y = vrHIGH - eHIGH - abs(y);
-
+  hints.win_gravity = NorthWestGravity;
+  if (i&XValue && i&XNegative) {
+    hints.win_gravity = NorthEastGravity;
+    x = vrWIDE - (eWIDE + 2 * bwidth) - abs(x);
+  }
+  if (i&YValue && i&YNegative) {
+    hints.win_gravity = (hints.win_gravity == NorthWestGravity) ?
+	SouthWestGravity : SouthEastGravity;
+    y = vrHIGH - (eHIGH + 2 * bwidth) - abs(y);
+  }
+ 
   if (x+eWIDE > vrWIDE) x = vrWIDE - eWIDE;   /* keep on screen */
   if (y+eHIGH > vrHIGH) y = vrHIGH - eHIGH;
 
@@@@ -3218,7 +3226,7 @@@@
   hints.x = x;                  hints.y = y;
   hints.width = eWIDE;          hints.height = eHIGH;
   hints.max_width  = maxWIDE;   hints.max_height = maxHIGH;
-  hints.flags |= USSize | PMaxSize;
+  hints.flags |= USSize | PMaxSize | PWinGravity;
     
   xswa.bit_gravity = StaticGravity;
   xswa.background_pixel = bg;
@@@@ -3267,10 +3275,6 @@@@
     }
   }
 
-
-  XSetStandardProperties(theDisp,mainW,"","",None,NULL,0,&hints);
-  setWinIconNames(name);
-
   xwmh.input = True;
   xwmh.flags = InputHint;
 
@@@@ -3295,12 +3299,12 @@@@
       }
     }
   }
-  XSetWMHints(theDisp, mainW, &xwmh);
 
   classh.res_name = "xv";
   classh.res_class = "XVroot";
-  XSetClassHint(theDisp, mainW, &classh);
 
+  XmbSetWMProperties(theDisp, mainW, NULL, NULL, NULL, 0, &hints, &xwmh, &classh);
+  setWinIconNames(name);
 
   if (nodecor) {   /* turn of image window decorations (in MWM) */ 
     Atom mwm_wm_hints;
@


1.1.1.1
log
@xv-3.10a plus current jpeg/tiff/png
@
text
@@
