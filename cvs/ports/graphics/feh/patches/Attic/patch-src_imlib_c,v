head	1.14;
access;
symbols
	OPENBSD_5_2:1.13.0.2
	OPENBSD_5_2_BASE:1.13
	OPENBSD_4_9:1.3.0.2
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.1.0.2
	OPENBSD_4_8_BASE:1.1;
locks; strict;
comment	@# @;


1.14
date	2012.09.18.12.51.17;	author dcoppa;	state dead;
branches;
next	1.13;

1.13
date	2012.03.29.12.29.10;	author dcoppa;	state Exp;
branches;
next	1.12;

1.12
date	2012.03.26.12.53.24;	author dcoppa;	state dead;
branches;
next	1.11;

1.11
date	2012.03.09.08.48.42;	author dcoppa;	state Exp;
branches;
next	1.10;

1.10
date	2011.09.26.18.01.27;	author dcoppa;	state dead;
branches;
next	1.9;

1.9
date	2011.09.15.13.27.09;	author dcoppa;	state Exp;
branches;
next	1.8;

1.8
date	2011.07.05.08.05.35;	author dcoppa;	state dead;
branches;
next	1.7;

1.7
date	2011.06.28.07.40.08;	author dcoppa;	state Exp;
branches;
next	1.6;

1.6
date	2011.05.20.10.57.57;	author dcoppa;	state dead;
branches;
next	1.5;

1.5
date	2011.05.04.11.43.31;	author dcoppa;	state Exp;
branches;
next	1.4;

1.4
date	2011.05.02.21.22.58;	author dcoppa;	state Exp;
branches;
next	1.3;

1.3
date	2010.10.15.12.52.23;	author dcoppa;	state Exp;
branches;
next	1.2;

1.2
date	2010.09.13.07.24.24;	author dcoppa;	state Exp;
branches;
next	1.1;

1.1
date	2010.07.11.14.46.13;	author dcoppa;	state Exp;
branches;
next	;


desc
@@


1.14
log
@Update to feh-2.6.1
@
text
@$OpenBSD: patch-src_imlib_c,v 1.13 2012/03/29 12:29:10 dcoppa Exp $

fix memory leak when encountering unloadable file
(upstream git commit 8c8c1d5d52096a24e751f07d94972253a0e5054c)

--- src/imlib.c.orig	Thu Mar 29 14:19:43 2012
+++ src/imlib.c	Thu Mar 29 14:20:19 2012
@@@@ -305,6 +305,7 @@@@ static char *feh_magick_load_image(char *filename)
 		if (!WIFEXITED(status) || (WEXITSTATUS(status) != 0)) {
 			close(fd);
 			unlink(sfn);
+			free(sfn);
 			sfn = NULL;
 
 			if (!opt.quiet) {
@


1.13
log
@feh_magick_load_image: fix memory leak when encountering unloadable file
(upstream git commit 8c8c1d5d52096a24e751f07d94972253a0e5054c)

winwidget_allocate: memset winwid to zero
(upstream git commit 82a976e0909e02ba8c25e4fd10d0e56a3e5c13ca)
@
text
@d1 1
a1 1
$OpenBSD$
@


1.12
log
@Update to feh-2.5
@
text
@d1 1
a1 1
$OpenBSD: patch-src_imlib_c,v 1.11 2012/03/09 08:48:42 dcoppa Exp $
d3 2
a4 2
fix memory leak in feh_edit_inplace_lossless
(upstream git commit d0721373fa0a9d189ea95ec736f661cc0df436cd)
d6 8
a13 4
--- src/imlib.c.orig	Fri Mar  9 09:36:54 2012
+++ src/imlib.c	Fri Mar  9 09:38:15 2012
@@@@ -1108,7 +1108,7 @@@@ void feh_edit_inplace_lossless(winwidget w, int op)
 				"-outfile", file_str, file_str, NULL);
d15 1
a15 18
 		im_weprintf(w, "lossless %s: Is 'jpegtran' installed? Failed to exec:", op_name);
-		return;
+		exit(1);
 	} else {
 		waitpid(pid, &status, 0);
 
@@@@ -1118,9 +1118,11 @@@@ void feh_edit_inplace_lossless(winwidget w, int op)
 					" Commandline was: "
 					"jpegtran -copy all %s %s -outfile %s %s",
 					op_name, status >> 8, op_op, op_value, file_str, file_str);
+			free(file_str);
 			return;
 		}
 	}
+	free(file_str);
 }
 
 void feh_draw_actions(winwidget w)
@


1.11
log
@Update to feh-2.4 and enable builtin EXIF support
@
text
@d1 1
a1 1
$OpenBSD$
@


1.10
log
@feh-1.16.2
@
text
@d1 1
a1 1
$OpenBSD: patch-src_imlib_c,v 1.9 2011/09/15 13:27:09 dcoppa Exp $
d3 2
a4 2
Fix a memory leak when using feh --reload on http URLs
(upstream git commit af2a44237a7b5cebbf0d03375ed742809da15a59)
d6 17
a22 13
--- src/imlib.c.orig	Sun Sep 11 12:51:04 2011
+++ src/imlib.c	Thu Sep 15 15:14:23 2011
@@@@ -151,13 +151,14 @@@@ int feh_load_image(Imlib_Image * im, feh_file * file)
 			/* Http, no reload, slideshow. Let's keep this image on hand... */
 			free(file->filename);
 			file->filename = estrdup(tmpname);
+
+			if (!opt.keep_http)
+				add_file_to_rm_filelist(tmpname);
 		} else {
 			/* Don't cache the image if we're doing reload + http (webcams etc) */
 			if (!opt.keep_http)
 				unlink(tmpname);
d24 5
a28 5
-		if (!opt.keep_http)
-			add_file_to_rm_filelist(tmpname);
 		free(tmpname);
 	} else {
 		*im = imlib_load_image_with_error_return(file->filename, &err);
@


1.9
log
@feh-1.16.1
@
text
@d1 1
a1 1
$OpenBSD$
@


1.8
log
@Bugfixing update to feh-1.14.2
@
text
@d1 11
a11 28
$OpenBSD: patch-src_imlib_c,v 1.7 2011/06/28 07:40:08 dcoppa Exp $
--- src/imlib.c.orig	Thu May 19 22:36:13 2011
+++ src/imlib.c	Tue Jun 28 09:30:29 2011
@@@@ -434,7 +434,7 @@@@ void feh_draw_errstr(winwidget w)
 void feh_draw_filename(winwidget w)
 {
 	static Imlib_Font fn = NULL;
-	int tw = 0, th = 0;
+	int tw = 0, th = 0, nw = 0;
 	Imlib_Image im = NULL;
 	static DATA8 atab[256];
 	char *s = NULL;
@@@@ -462,10 +462,22 @@@@ void feh_draw_filename(winwidget w)
 	memset(atab, 0, sizeof(atab));
 
 	/* Work out how high the font is */
-	gib_imlib_get_text_size(fn, FEH_FILE(w->file->data)->filename, NULL, &tw, &th, IMLIB_TEXT_TO_RIGHT);
+	gib_imlib_get_text_size(fn, FEH_FILE(w->file->data)->filename, NULL, &tw,
+			&th, IMLIB_TEXT_TO_RIGHT);
 
-	/* tw is no longer correct, if the filename is shorter than
-	 * the string "%d of %d" used below in fullscreen mode */
+	if (gib_list_length(filelist) > 1) {
+		len = snprintf(NULL, 0, "%d of %d",  gib_list_length(filelist),
+				gib_list_length(filelist)) + 1;
+		s = emalloc(len);
+		snprintf(s, len, "%d of %d", gib_list_num(filelist, current_file) +
+				1, gib_list_length(filelist));
d13 12
a24 34
+		gib_imlib_get_text_size(fn, s, NULL, &nw, NULL, IMLIB_TEXT_TO_RIGHT);
+
+		if (nw > tw)
+			tw = nw;
+	}
+
 	tw += 3;
 	th += 3;
 	im = imlib_create_image(tw, 2 * th);
@@@@ -473,20 +485,16 @@@@ void feh_draw_filename(winwidget w)
 		eprintf("Couldn't create image. Out of memory?");
 
 	gib_imlib_image_set_has_alpha(im, 1);
-	gib_imlib_apply_color_modifier_to_rectangle(im, 0, 0, tw, 2 * th, NULL, NULL, NULL, atab);
+	gib_imlib_apply_color_modifier_to_rectangle(im, 0, 0, tw, 2 * th, NULL,
+			NULL, NULL, atab);
 	gib_imlib_image_fill_rectangle(im, 0, 0, tw, 2 * th, 0, 0, 0, 0);
 
 	gib_imlib_text_draw(im, fn, NULL, 2, 2, FEH_FILE(w->file->data)->filename,
 			IMLIB_TEXT_TO_RIGHT, 0, 0, 0, 255);
 	gib_imlib_text_draw(im, fn, NULL, 1, 1, FEH_FILE(w->file->data)->filename,
 			IMLIB_TEXT_TO_RIGHT, 255, 255, 255, 255);
-	/* Print the position in the filelist, if we have >=2 files */
-	if (gib_list_length(filelist) > 1) {
-		/* sic! */
-		len = snprintf(NULL, 0, "%d of %d", gib_list_length(filelist), gib_list_length(filelist)) + 1;
-		s = emalloc(len);
-		snprintf(s, len, "%d of %d", gib_list_num(filelist, current_file) + 1, gib_list_length(filelist));
-		/* This should somehow be right-aligned */
+
+	if (s) {
 		gib_imlib_text_draw(im, fn, NULL, 2, th + 1, s, IMLIB_TEXT_TO_RIGHT, 0, 0, 0, 255);
 		gib_imlib_text_draw(im, fn, NULL, 1, th, s, IMLIB_TEXT_TO_RIGHT, 255, 255, 255, 255);
 		free(s);
@


1.7
log
@Latest round of fixes from upstream:

* fix --draw-filename "x of y" being cut off by short filenames
* respect --zoom 100 in --fullscreen mode
@
text
@d1 1
a1 1
$OpenBSD$
@


1.6
log
@Update to feh-1.14.1
@
text
@d1 63
a63 29
$OpenBSD: patch-src_imlib_c,v 1.5 2011/05/04 11:43:31 dcoppa Exp $

Fix use-after-free
(commit 1c420e26c23f302e54c28d6e473fe2f95e970a8e)

Fix rotate arg in error message
(commit ef3f1979c2d443823bfc761d98b30c232992494a)

--- src/imlib.c.orig	Sat Apr 23 22:02:31 2011
+++ src/imlib.c	Wed May  4 13:22:06 2011
@@@@ -291,8 +291,8 @@@@ char *feh_http_load_image(char *url)
 			return sfn;
 		} else {
 			weprintf("open url: fdopen failed:");
-			free(sfn);
 			unlink(sfn);
+			free(sfn);
 			close(fd);
 		}
 	} else {
@@@@ -857,7 +857,7 @@@@ void feh_edit_inplace_lossless_rotate(winwidget w, int
 		if (!WIFEXITED(status) || WEXITSTATUS(status) != 0) {
 			weprintf("lossless rotate: Got exitcode %d from jpegtran."
 					" Commandline was:\n"
-					"jpegtran -copy all -rotate %d -outfile %s %s\n",
+					"jpegtran -copy all -rotate %s -outfile %s %s\n",
 					status >> 8, rotate_str, file_str, file_str);
 			return;
 		}
@


1.5
log
@Three cherry-picked fixes from upstream git:

Zap a use-after-free.
Use NETWM for fullscreen windows only.
feh(1) manpage fix.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_imlib_c,v 1.4 2011/05/02 21:22:58 dcoppa Exp $
@


1.4
log
@Update to feh-1.13.
I take maintainership too, cause old maintainer is M.I.A.

OK sthen@@
@
text
@d1 4
a4 1
$OpenBSD: patch-src_imlib_c,v 1.3 2010/10/15 12:52:23 dcoppa Exp $
d9 12
a20 2
--- src/imlib.c.orig	Thu Oct  7 20:28:39 2010
+++ src/imlib.c	Fri Oct 15 14:47:36 2010
@


1.3
log
@Update to feh-1.10
@
text
@d1 5
a5 1
$OpenBSD: patch-src_imlib_c,v 1.2 2010/09/13 07:24:24 dcoppa Exp $
d8 9
a16 46
@@@@ -438,6 +438,7 @@@@ char *feh_http_load_image(char *url)
 		close(sockno);
 		fclose(fp);
 	} else {
+		int fd;
 		int pid;
 		int status;
 
@@@@ -446,18 +447,20 @@@@ char *feh_http_load_image(char *url)
 			free(tmpname);
 			return(NULL);
 		} else if (pid == 0) {
-			char *quiet = NULL;
-
-			if (!opt.verbose)
-				quiet = estrdup("-q");
-
-			execlp("wget", "wget", "--cache=off", "-O", tmpname, url, quiet, NULL);
-			eprintf("url: Is 'wget' installed? Failed to exec wget:");
+				if (!opt.verbose) {
+					if ((fd = open("/dev/null", O_WRONLY)) != -1) {
+					dup2(fd, fileno(stdout));
+					dup2(fd, fileno(stderr));
+				}
+				if (fd > 2) close(fd);
+			}
+			execlp("ftp", "ftp", "-o", tmpname, url, (char *)NULL);
+			eprintf("url: Is 'ftp' installed? Failed to exec ftp:");
 		} else {
 			waitpid(pid, &status, 0);
 
 			if (!WIFEXITED(status) || WEXITSTATUS(status) != 0) {
-				weprintf("url: wget failed to load URL %s\n", url);
+				weprintf("url: ftp failed to load URL %s\n", url);
 				unlink(tmpname);
 				free(tmpname);
 				return(NULL);
@@@@ -1038,7 +1041,7 @@@@ void feh_edit_inplace_lossless_rotate(winwidget w, int
 	} else if (pid == 0) {
 
 		execlp("jpegtran", "jpegtran", "-copy", "all", "-rotate",
-				rotate_str, "-outfile", file_str, file_str, NULL);
+				rotate_str, "-outfile", file_str, file_str, (char *)NULL);
 
 		eprintf("lossless rotate: Is 'jpegtran' installed? Failed to exec:");
 	} else {
@


1.2
log
@Update to feh-1.9

OK sthen@@, ajacoutot@@
@
text
@d1 4
a4 4
$OpenBSD: patch-src_imlib_c,v 1.1 2010/07/11 14:46:13 dcoppa Exp $
--- src/imlib.c.orig	Fri Sep 10 16:00:01 2010
+++ src/imlib.c	Fri Sep 10 16:03:36 2010
@@@@ -435,6 +435,7 @@@@ char *feh_http_load_image(char *url)
d12 1
a12 1
@@@@ -443,18 +444,20 @@@@ char *feh_http_load_image(char *url)
d41 1
a41 1
@@@@ -962,7 +965,7 @@@@ void feh_edit_inplace_lossless_rotate(winwidget w, int
@


1.1
log
@Update to feh-1.8.
Use ftp from base instead of wget for remote images support.

OK sthen@@
Maintainer timeout...
@
text
@d1 3
a3 3
$OpenBSD$
--- src/imlib.c.orig	Fri Jun 25 17:13:11 2010
+++ src/imlib.c	Wed Jul  7 12:12:42 2010
d22 3
a24 3
-			eprintf("url: exec failed: wget:");
+			if (!opt.verbose) {
+				if ((fd = open("/dev/null", O_WRONLY)) != -1) {
d31 1
a31 1
+			eprintf("url: exec failed: ftp:");
d48 1
a48 1
 		eprintf("lossless rotate: exec failed: jpegtran:");
@

