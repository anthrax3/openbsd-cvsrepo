head	1.4;
access;
symbols
	OPENBSD_5_7:1.3.0.16
	OPENBSD_5_7_BASE:1.3
	OPENBSD_5_6:1.3.0.14
	OPENBSD_5_6_BASE:1.3
	OPENBSD_5_5:1.3.0.12
	OPENBSD_5_5_BASE:1.3
	OPENBSD_5_4:1.3.0.10
	OPENBSD_5_4_BASE:1.3
	OPENBSD_5_3:1.3.0.8
	OPENBSD_5_3_BASE:1.3
	OPENBSD_5_2:1.3.0.6
	OPENBSD_5_2_BASE:1.3
	OPENBSD_5_1_BASE:1.3
	OPENBSD_5_1:1.3.0.4
	OPENBSD_5_0:1.3.0.2
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_2:1.1.0.4
	OPENBSD_4_2_BASE:1.1
	OPENBSD_4_1:1.1.0.2
	OPENBSD_4_1_BASE:1.1;
locks; strict;
comment	@# @;


1.4
date	2015.04.23.17.31.21;	author dcoppa;	state dead;
branches;
next	1.3;
commitid	aBfPQhBtAJW4WdWV;

1.3
date	2011.07.08.20.36.09;	author naddy;	state Exp;
branches;
next	1.2;

1.2
date	2007.09.22.22.08.16;	author merdely;	state dead;
branches;
next	1.1;

1.1
date	2006.11.20.09.21.09;	author bernd;	state Exp;
branches;
next	;


desc
@@


1.4
log
@
Bugfix update to imlib2-1.4.7

No API/ABI changes
@
text
@$OpenBSD: patch-src_modules_loaders_loader_png_c,v 1.3 2011/07/08 20:36:09 naddy Exp $

Fix build with png-1.5.

--- src/modules/loaders/loader_png.c.orig	Sun Aug 17 03:39:13 2008
+++ src/modules/loaders/loader_png.c	Mon Jul  4 16:07:25 2011
@@@@ -58,7 +58,7 @@@@ load(ImlibImage * im, ImlibProgressFunction progress,
              fclose(f);
              return 0;
           }
-        if (setjmp(png_ptr->jmpbuf))
+        if (setjmp(png_jmpbuf(png_ptr)))
           {
              png_destroy_read_struct(&png_ptr, &info_ptr, NULL);
              fclose(f);
@@@@ -238,7 +238,7 @@@@ save(ImlibImage * im, ImlibProgressFunction progress, 
    png_structp         png_ptr;
    png_infop           info_ptr;
    DATA32             *ptr;
-   int                 x, y, j;
+   int                 x, y, j, interlace;
    png_bytep           row_ptr, data = NULL;
    png_color_8         sig_bit;
    int                 pl = 0;
@@@@ -265,7 +265,7 @@@@ save(ImlibImage * im, ImlibProgressFunction progress, 
         png_destroy_write_struct(&png_ptr, (png_infopp) NULL);
         return 0;
      }
-   if (setjmp(png_ptr->jmpbuf))
+   if (setjmp(png_jmpbuf(png_ptr)))
      {
         fclose(f);
         png_destroy_write_struct(&png_ptr, (png_infopp) & info_ptr);
@@@@ -274,11 +274,11 @@@@ save(ImlibImage * im, ImlibProgressFunction progress, 
      }
 
    /* check whether we should use interlacing */
+   interlace = PNG_INTERLACE_NONE;
    if ((tag = __imlib_GetTag(im, "interlacing")) && tag->val)
      {
 #ifdef PNG_WRITE_INTERLACING_SUPPORTED
-          png_ptr->interlaced = PNG_INTERLACE_ADAM7;
-          num_passes = png_set_interlace_handling(png_ptr);
+	  interlace = PNG_INTERLACE_ADAM7;
 #endif
      }
 
@@@@ -286,7 +286,7 @@@@ save(ImlibImage * im, ImlibProgressFunction progress, 
    if (im->flags & F_HAS_ALPHA)
      {
         png_set_IHDR(png_ptr, info_ptr, im->w, im->h, 8,
-                     PNG_COLOR_TYPE_RGB_ALPHA, png_ptr->interlaced,
+                     PNG_COLOR_TYPE_RGB_ALPHA, interlace,
                      PNG_COMPRESSION_TYPE_BASE, PNG_FILTER_TYPE_BASE);
 #ifdef WORDS_BIGENDIAN
         png_set_swap_alpha(png_ptr);
@@@@ -297,7 +297,7 @@@@ save(ImlibImage * im, ImlibProgressFunction progress, 
    else
      {
         png_set_IHDR(png_ptr, info_ptr, im->w, im->h, 8, PNG_COLOR_TYPE_RGB,
-                     png_ptr->interlaced, PNG_COMPRESSION_TYPE_BASE,
+                     interlace, PNG_COMPRESSION_TYPE_BASE,
                      PNG_FILTER_TYPE_BASE);
         data = malloc(im->w * 3 * sizeof(char));
      }
@@@@ -343,6 +343,10 @@@@ save(ImlibImage * im, ImlibProgressFunction progress, 
    png_write_info(png_ptr, info_ptr);
    png_set_shift(png_ptr, &sig_bit);
    png_set_packing(png_ptr);
+
+#ifdef PNG_WRITE_INTERLACING_SUPPORTED
+     num_passes = png_set_interlace_handling(png_ptr);
+#endif
 
    for (pass = 0; pass < num_passes; pass++)
      {
@


1.3
log
@Fix build with png-1.5.
All fixes from/via NetBSD pkgsrc.  The people there did a lot of
heavy lifting.
@
text
@d1 1
a1 1
$OpenBSD$
@


1.2
log
@Update to Imlib2 1.4.0.  The new version integrates the security fixes and has
a few bug fixes.

From brad@@. ok kili@@
@
text
@d1 1
a1 1
$OpenBSD: patch-src_modules_loaders_loader_png_c,v 1.1 2006/11/20 09:21:09 bernd Exp $
d3 1
a3 2
Fix for CVE-2006-4806, CVE-2006-4807, CVE-2006-4808, CVE-2006-4809.
Should be fixed in >1.3.0.
d5 72
a76 16
--- src/modules/loaders/loader_png.c.orig	Tue Sep  5 02:37:07 2006
+++ src/modules/loaders/loader_png.c	Mon Nov  6 10:41:32 2006
@@@@ -85,6 +85,13 @@@@ load(ImlibImage * im, ImlibProgressFunct
                      &interlace_type, NULL, NULL);
         im->w = (int)w32;
         im->h = (int)h32;
+	if ((w32 < 1) || (h32 < 1) || (w32 > 8192) || (h32 > 8192))
+	  {
+             png_read_end(png_ptr, info_ptr);
+             png_destroy_read_struct(&png_ptr, &info_ptr, (png_infopp) NULL);
+             fclose(f);
+             return 0;
+	  }
         if (color_type == PNG_COLOR_TYPE_PALETTE)
 	  {
 	     png_set_expand(png_ptr);
@


1.1
log
@Update to imlib2-1.3.0. Initial diffs from 'bsdmaniak at daemon-tips dot org'
and brad@@.

This contains security fixes from the imlib2 cvs repository for CVE-2006-4806,
CVE-2006-4807, CVE-2006-4808 and CVE-2006-4809.

ok brad@@, steven@@
@
text
@d1 1
a1 1
$OpenBSD$
@

