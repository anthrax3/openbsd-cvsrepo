head	1.2;
access;
symbols
	OPENBSD_6_1:1.1.0.10
	OPENBSD_6_1_BASE:1.1
	OPENBSD_6_0:1.1.0.8
	OPENBSD_6_0_BASE:1.1
	OPENBSD_5_9:1.1.0.4
	OPENBSD_5_9_BASE:1.1
	OPENBSD_5_8:1.1.0.6
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.2;
locks; strict;
comment	@# @;


1.2
date	2017.05.02.15.48.41;	author espie;	state Exp;
branches;
next	1.1;
commitid	hosUyURMXXTrriJG;

1.1
date	2015.05.31.06.35.02;	author kirby;	state Exp;
branches
	1.1.2.1;
next	;
commitid	MXFj1FRlUvcT4bK1;

1.1.2.1
date	2015.06.01.07.51.22;	author jasper;	state Exp;
branches;
next	;
commitid	HLsBt1IdEJ66zClb;


desc
@@


1.2
log
@fixes for clang
@
text
@$OpenBSD: patch-src_dcraw_cc,v 1.1 2015/05/31 06:35:02 kirby Exp $

fix CVE-2015-3885
const correct.
fix evaluation order.

Index: src/dcraw.cc
--- src/dcraw.cc.orig
+++ src/dcraw.cc
@@@@ -916,7 +916,8 @@@@ struct jhead {
 
 int CLASS ljpeg_start (struct jhead *jh, int info_only)
 {
-  int c, tag, len;
+  int c, tag;
+  ushort len;
   uchar data[0x10000], *dp;
 
   if (!info_only) init_decoder();
@@@@ -2634,7 +2635,8 @@@@ void CLASS sony_decrypt (unsigned *data, int len, int 
       pad[p] = htonl(pad[p]);
   }
   while (len--)
-    *data++ ^= pad[p++ & 127] = pad[(p+1) & 127] ^ pad[(p+65) & 127];
+    *data++ ^= pad[p & 127] = pad[(p+1) & 127] ^ pad[(p+65) & 127];
+    p++;
 }
 
 void CLASS sony_load_raw()
@@@@ -8445,7 +8447,8 @@@@ int CLASS main (int argc, const char **argv)
   static int timestamp_only=0, thumbnail_only=0, identify_only=0;
   static int user_qual=-1, user_black=-1, user_sat=-1, user_flip=-1;
   static int use_fuji_rotate=1, write_to_stdout=0, quality, i, c;
-  static char opm, opt, *ofname, *cp, *bpfile=0;
+  static char opm, opt, *ofname, *cp2, *bpfile=0;
+  static const char *cp;
   static const char *sp, *dark_frame=0, *write_ext;
   static struct utimbuf ut;
   static FILE *ofp;
@@@@ -8781,7 +8784,7 @@@@ thumbnail:
       strcpy (ofname,_("standard output"));
     else {
       strcpy (ofname, ifname);
-      if ((cp = strrchr (ofname, '.'))) *cp = 0;
+      if ((cp2 = strrchr (ofname, '.'))) *cp2 = 0;
       if (multi_out)
 	sprintf (ofname+strlen(ofname), "_%0*d",
 		snprintf(0,0,"%d",is_raw-1), shot_select);
@


1.1
log
@fix CVE-2015-3885 for embedded dcraw.
reported by Sevan / Venture37 on ports@@, thanks
looks ok to kili@@
@
text
@d1 1
a1 1
$OpenBSD$
d4 2
d7 3
a9 2
--- src/dcraw.cc.orig	Tue May 26 13:45:37 2015
+++ src/dcraw.cc	Tue May 26 13:46:31 2015
d20 29
@


1.1.2.1
log
@Security fixes for CVE-2015-3885
@
text
@d1 1
a1 1
$OpenBSD: patch-src_dcraw_cc,v 1.1 2015/05/31 06:35:02 kirby Exp $
@

