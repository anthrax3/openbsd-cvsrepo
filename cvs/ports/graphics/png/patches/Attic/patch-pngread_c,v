head	1.2;
access;
symbols
	OPENBSD_4_5:1.2.0.2
	OPENBSD_3_6:1.1.0.6
	OPENBSD_3_6_BASE:1.1
	OPENBSD_3_4:1.1.0.4
	OPENBSD_3_5:1.1.0.2;
locks; strict;
comment	@# @;


1.2
date	2004.09.20.01.24.11;	author brad;	state dead;
branches
	1.2.2.1;
next	1.1;

1.1
date	2004.08.05.19.17.14;	author brad;	state Exp;
branches
	1.1.2.1
	1.1.4.1;
next	;

1.1.2.1
date	2004.08.05.19.32.37;	author brad;	state Exp;
branches;
next	;

1.1.4.1
date	2004.08.05.19.53.27;	author brad;	state Exp;
branches;
next	;

1.2.2.1
date	2009.06.12.01.59.58;	author william;	state Exp;
branches;
next	;


desc
@@


1.2
log
@upgrade to png 1.2.7
@
text
@$OpenBSD: patch-pngread_c,v 1.1 2004/08/05 19:17:14 brad Exp $
--- pngread.c.orig	Thu Oct  3 07:32:29 2002
+++ pngread.c	Thu Aug  5 14:29:45 2004
@@@@ -384,7 +384,7 @@@@ png_read_info(png_structp png_ptr, png_i
       png_uint_32 length;
 
       png_read_data(png_ptr, chunk_length, 4);
-      length = png_get_uint_32(chunk_length);
+      length = png_get_uint_31(png_ptr,chunk_length);
 
       png_reset_crc(png_ptr);
       png_crc_read(png_ptr, png_ptr->chunk_name, 4);
@@@@ -392,9 +392,6 @@@@ png_read_info(png_structp png_ptr, png_i
       png_debug2(0, "Reading %s chunk, length=%lu.\n", png_ptr->chunk_name,
          length);
 
-      if (length > PNG_MAX_UINT)
-         png_error(png_ptr, "Invalid chunk length.");
-
       /* This should be a binary subdivision search or a hash for
        * matching the chunk name rather than a linear search.
        */
@@@@ -673,11 +670,8 @@@@ png_read_row(png_structp png_ptr, png_by
             png_crc_finish(png_ptr, 0);
 
             png_read_data(png_ptr, chunk_length, 4);
-            png_ptr->idat_size = png_get_uint_32(chunk_length);
+            png_ptr->idat_size = png_get_uint_31(png_ptr,chunk_length);
 
-            if (png_ptr->idat_size > PNG_MAX_UINT)
-              png_error(png_ptr, "Invalid chunk length.");
-
             png_reset_crc(png_ptr);
             png_crc_read(png_ptr, png_ptr->chunk_name, 4);
             if (png_memcmp(png_ptr->chunk_name, png_IDAT, 4))
@@@@ -946,16 +940,13 @@@@ png_read_end(png_structp png_ptr, png_in
 #endif /* PNG_GLOBAL_ARRAYS */
 
       png_read_data(png_ptr, chunk_length, 4);
-      length = png_get_uint_32(chunk_length);
+      length = png_get_uint_31(png_ptr,chunk_length);
 
       png_reset_crc(png_ptr);
       png_crc_read(png_ptr, png_ptr->chunk_name, 4);
 
       png_debug1(0, "Reading %s chunk.\n", png_ptr->chunk_name);
 
-      if (length > PNG_MAX_UINT)
-         png_error(png_ptr, "Invalid chunk length.");
-
       if (!png_memcmp(png_ptr->chunk_name, png_IHDR, 4))
          png_handle_IHDR(png_ptr, info_ptr, length);
       else if (!png_memcmp(png_ptr->chunk_name, png_IEND, 4))
@@@@ -1298,6 +1289,9 @@@@ png_read_png(png_structp png_ptr, png_in
     * PNG file before the first IDAT (image data chunk).
     */
    png_read_info(png_ptr, info_ptr);
+
+   if (info_ptr->height > PNG_UINT_32_MAX/sizeof(png_bytep))
+      png_error(png_ptr,"Image is too high to process with png_read_png()");
 
    /* -------------- image transformations start here ------------------- */
 
@


1.2.2.1
log
@security update to png-1.3.33p0; patches from debian
resolves CVE-2008-5907 and CVE-2009-0040
@
text
@d1 63
a63 12
$OpenBSD$
--- pngread.c.orig	Fri Oct 31 09:42:01 2008
+++ pngread.c	Thu Jun  4 16:26:40 2009
@@@@ -1437,6 +1437,8 @@@@ png_read_png(png_structp png_ptr, png_infop info_ptr,
 #ifdef PNG_FREE_ME_SUPPORTED
       info_ptr->free_me |= PNG_FREE_ROWS;
 #endif
+      png_memset(info_ptr->row_pointers, 0, info_ptr->height
+         * png_sizeof(png_bytep));
       for (row = 0; row < (int)info_ptr->height; row++)
       {
          info_ptr->row_pointers[row] = (png_bytep)png_malloc(png_ptr,
@


1.1
log
@Add pieces of the libpng jumbo security patch not already in the port.

http://www.us-cert.gov/cas/techalerts/TA04-217A.html
@
text
@d1 1
a1 1
$OpenBSD$
@


1.1.4.1
log
@Add pieces of the libpng jumbo security patch not already in the port.

http://www.us-cert.gov/cas/techalerts/TA04-217A.html
@
text
@d1 1
a1 1
$OpenBSD: patch-pngread_c,v 1.1 2004/08/05 19:17:14 brad Exp $
@


1.1.2.1
log
@Add pieces of the libpng jumbo security patch not already in the port.

http://www.us-cert.gov/cas/techalerts/TA04-217A.html
@
text
@d1 1
a1 1
$OpenBSD: patch-pngread_c,v 1.1 2004/08/05 19:17:14 brad Exp $
@

