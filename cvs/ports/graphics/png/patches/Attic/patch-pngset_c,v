head	1.2;
access;
symbols
	OPENBSD_5_4:1.2.0.10
	OPENBSD_5_1:1.2.0.8
	OPENBSD_4_5:1.2.0.6
	OPENBSD_4_0:1.2.0.4
	OPENBSD_3_9:1.2.0.2
	OPENBSD_3_6:1.1.0.6
	OPENBSD_3_6_BASE:1.1
	OPENBSD_3_4:1.1.0.4
	OPENBSD_3_5:1.1.0.2;
locks; strict;
comment	@# @;


1.2
date	2004.09.20.01.24.11;	author brad;	state dead;
branches
	1.2.2.1
	1.2.4.1
	1.2.6.1
	1.2.8.1
	1.2.10.1;
next	1.1;

1.1
date	2004.08.05.19.17.14;	author brad;	state Exp;
branches
	1.1.2.1
	1.1.4.1;
next	;

1.1.2.1
date	2004.08.05.19.32.37;	author brad;	state Exp;
branches;
next	;

1.1.4.1
date	2004.08.05.19.53.27;	author brad;	state Exp;
branches;
next	;

1.2.2.1
date	2006.11.18.07.59.44;	author sturm;	state Exp;
branches;
next	;

1.2.4.1
date	2006.11.18.16.30.39;	author sturm;	state Exp;
branches;
next	;

1.2.6.1
date	2009.06.12.01.59.58;	author william;	state Exp;
branches;
next	;

1.2.8.1
date	2012.04.12.12.58.38;	author jasper;	state Exp;
branches;
next	;

1.2.10.1
date	2014.01.10.22.02.33;	author naddy;	state Exp;
branches;
next	;


desc
@@


1.2
log
@upgrade to png 1.2.7
@
text
@$OpenBSD: patch-pngset_c,v 1.1 2004/08/05 19:17:14 brad Exp $
--- pngset.c.orig	Thu Oct  3 07:32:30 2002
+++ pngset.c	Thu Aug  5 14:29:45 2004
@@@@ -253,6 +253,8 @@@@ png_set_IHDR(png_structp png_ptr, png_in
       png_error(png_ptr, "Image width or height is zero in IHDR");
    if (width > PNG_MAX_UINT || height > PNG_MAX_UINT)
       png_error(png_ptr, "Invalid image size in IHDR");
+   if (width > PNG_USER_WIDTH_MAX || height > PNG_USER_HEIGHT_MAX)
+      png_error(png_ptr, "image size exceeds user limits in IHDR");
 
    /* check other values */
    if (bit_depth != 1 && bit_depth != 2 && bit_depth != 4 &&
@


1.2.10.1
log
@Fix a null pointer dereference (CVE-2013-6954).
@
text
@d1 9
a9 14
$OpenBSD$

CVE-2013-6954

--- pngset.c.orig	Thu Apr 25 14:24:44 2013
+++ pngset.c	Fri Jan  3 14:21:08 2014
@@@@ -536,7 +536,7 @@@@ png_set_PLTE(png_structrp png_ptr, png_inforp info_ptr
 #        endif
       ))
    {
-      png_chunk_report(png_ptr, "Invalid palette", PNG_CHUNK_ERROR);
+      png_error(png_ptr, "Invalid palette");
       return;
    }
d11 2
@


1.2.8.1
log
@Security fix for libpng "png_set_text_2()" Memory Corruption Vulnerability,
CVE-2011-3048.

ok naddy@@
@
text
@d1 9
a9 52
$OpenBSD$

libpng "png_set_text_2()" Memory Corruption Vulnerability, CVE-2011-3048.
patch taken from libpng 1.5.10.

--- pngset.c.orig	Thu Apr 12 14:29:27 2012
+++ pngset.c	Thu Apr 12 14:30:52 2012
@@@@ -692,24 +692,28 @@@@ png_set_text_2(png_structp png_ptr, png_infop info_ptr
     */
    if (info_ptr->num_text + num_text > info_ptr->max_text)
    {
+      int old_max_text = info_ptr->max_text;
+      int old_num_text = info_ptr->num_text;
+
       if (info_ptr->text != NULL)
       {
          png_textp old_text;
-         int old_max;
 
-         old_max = info_ptr->max_text;
          info_ptr->max_text = info_ptr->num_text + num_text + 8;
          old_text = info_ptr->text;
+
          info_ptr->text = (png_textp)png_malloc_warn(png_ptr,
             (png_size_t)(info_ptr->max_text * png_sizeof(png_text)));
 
          if (info_ptr->text == NULL)
          {
-            png_free(png_ptr, old_text);
+            /* Restore to previous condition */
+            info_ptr->max_text = old_max_text;
+            info_ptr->text = old_text;
             return(1);
          }
 
-         png_memcpy(info_ptr->text, old_text, (png_size_t)(old_max *
+         png_memcpy(info_ptr->text, old_text, (png_size_t)(old_max_text *
              png_sizeof(png_text)));
          png_free(png_ptr, old_text);
       }
@@@@ -721,7 +725,12 @@@@ png_set_text_2(png_structp png_ptr, png_infop info_ptr
          info_ptr->text = (png_textp)png_malloc_warn(png_ptr,
              (png_size_t)(info_ptr->max_text * png_sizeof(png_text)));
          if (info_ptr->text == NULL)
+         {
+            /* Restore to previous condition */
+            info_ptr->num_text = old_num_text;
+            info_ptr->max_text = old_max_text;
             return(1);
+	 }
          info_ptr->free_me |= PNG_FREE_TEXT;
       }
d11 2
@


1.2.6.1
log
@security update to png-1.3.33p0; patches from debian
resolves CVE-2008-5907 and CVE-2009-0040
@
text
@d1 9
a9 26
$OpenBSD$
--- pngset.c.orig	Fri Oct 31 09:42:01 2008
+++ pngset.c	Thu Jun  4 16:26:40 2009
@@@@ -430,8 +430,12 @@@@ png_set_pCAL(png_structp png_ptr, png_infop info_ptr,
       return;
    }
 
-   info_ptr->pcal_params[nparams] = NULL;
+#ifdef PNG_FREE_ME_SUPPORTED
+   info_ptr->free_me |= PNG_FREE_PCAL;
+#endif
 
+   png_memset(info_ptr->pcal_params, 0, (nparams + 1) * png_sizeof(png_charp));
+
    for (i = 0; i < nparams; i++)
    {
       length = png_strlen(params[i]) + 1;
@@@@ -447,9 +451,6 @@@@ png_set_pCAL(png_structp png_ptr, png_infop info_ptr,
    }
 
    info_ptr->valid |= PNG_INFO_pCAL;
-#ifdef PNG_FREE_ME_SUPPORTED
-   info_ptr->free_me |= PNG_FREE_PCAL;
-#endif
 }
 #endif
d11 2
@


1.2.4.1
log
@security fix

Libpng versions 1.0.6 through 1.2.12 can crash while decoding
the sPLT chunk.  This is due to an incorrect calculation of
the buffer size for storing the palette entries.
This bug has been given the identifier CVE-2006-3334.

from libpng via bernd@@
@
text
@d1 12
a12 16
$OpenBSD$
--- pngset.c.orig	Sat Nov 18 09:05:46 2006
+++ pngset.c	Sat Nov 18 09:06:42 2006
@@@@ -976,10 +976,10 @@@@ png_set_sPLT(png_structp png_ptr,
         /* TODO: use png_malloc_warn */
         png_strcpy(to->name, from->name);
         to->entries = (png_sPLT_entryp)png_malloc(png_ptr,
-            from->nentries * png_sizeof(png_sPLT_t));
+            from->nentries * png_sizeof(png_sPLT_entry));
         /* TODO: use png_malloc_warn */
         png_memcpy(to->entries, from->entries,
-            from->nentries * png_sizeof(png_sPLT_t));
+            from->nentries * png_sizeof(png_sPLT_entry));
         to->nentries = from->nentries;
         to->depth = from->depth;
     }
@


1.2.2.1
log
@security fix

Libpng versions 1.0.6 through 1.2.12 can crash while decoding
the sPLT chunk.  This is due to an incorrect calculation of
the buffer size for storing the palette entries.
This bug has been given the identifier CVE-2006-3334.

from libpng via bernd@@
@
text
@d1 12
a12 16
$OpenBSD$
--- pngset.c.orig	Sat Nov 18 08:50:27 2006
+++ pngset.c	Sat Nov 18 08:52:07 2006
@@@@ -944,10 +944,10 @@@@ png_set_sPLT(png_structp png_ptr,
         /* TODO: use png_malloc_warn */
         png_strcpy(to->name, from->name);
         to->entries = (png_sPLT_entryp)png_malloc(png_ptr,
-            from->nentries * png_sizeof(png_sPLT_t));
+            from->nentries * png_sizeof(png_sPLT_entry));
         /* TODO: use png_malloc_warn */
         png_memcpy(to->entries, from->entries,
-            from->nentries * png_sizeof(png_sPLT_t));
+            from->nentries * png_sizeof(png_sPLT_entry));
         to->nentries = from->nentries;
         to->depth = from->depth;
     }
@


1.1
log
@Add pieces of the libpng jumbo security patch not already in the port.

http://www.us-cert.gov/cas/techalerts/TA04-217A.html
@
text
@d1 1
a1 1
$OpenBSD$
@


1.1.4.1
log
@Add pieces of the libpng jumbo security patch not already in the port.

http://www.us-cert.gov/cas/techalerts/TA04-217A.html
@
text
@d1 1
a1 1
$OpenBSD: patch-pngset_c,v 1.1 2004/08/05 19:17:14 brad Exp $
@


1.1.2.1
log
@Add pieces of the libpng jumbo security patch not already in the port.

http://www.us-cert.gov/cas/techalerts/TA04-217A.html
@
text
@d1 1
a1 1
$OpenBSD: patch-pngset_c,v 1.1 2004/08/05 19:17:14 brad Exp $
@

