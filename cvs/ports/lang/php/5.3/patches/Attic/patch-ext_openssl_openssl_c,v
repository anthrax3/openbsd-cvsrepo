head	1.5;
access;
symbols
	OPENBSD_5_7:1.4.0.4
	OPENBSD_5_7_BASE:1.4
	OPENBSD_5_6:1.4.0.2
	OPENBSD_5_6_BASE:1.4;
locks; strict;
comment	@# @;


1.5
date	2015.06.10.12.53.49;	author robert;	state dead;
branches;
next	1.4;
commitid	SoY9NzRxZwkmSXir;

1.4
date	2014.04.19.12.06.44;	author sthen;	state Exp;
branches;
next	1.3;

1.3
date	2014.01.11.15.01.56;	author sthen;	state dead;
branches;
next	1.2;

1.2
date	2013.08.23.10.06.45;	author sthen;	state Exp;
branches;
next	1.1;

1.1
date	2013.08.23.06.32.44;	author robert;	state Exp;
branches;
next	;


desc
@@


1.5
log
@bye-bye php-5.3; prodded by aja@@
@
text
@$OpenBSD: patch-ext_openssl_openssl_c,v 1.4 2014/04/19 12:06:44 sthen Exp $
--- ext/openssl/openssl.c.orig.port	Sat Apr 19 06:03:12 2014
+++ ext/openssl/openssl.c	Sat Apr 19 06:03:45 2014
@@@@ -881,11 +881,13 @@@@ static int php_openssl_load_rand_file(const char * fil
 
 	if (file == NULL) {
 		file = RAND_file_name(buffer, sizeof(buffer));
+#ifdef HAVE_SSL_RAND_EGD
 	} else if (RAND_egd(file) > 0) {
 		/* if the given filename is an EGD socket, don't
 		 * write anything back to it */
 		*egdsocket = 1;
 		return SUCCESS;
+#endif
 	}
 	if (file == NULL || !RAND_load_file(file, -1)) {
 		if (RAND_status() == 0) {
@


1.4
log
@handle RAND_egd removal
@
text
@d1 1
a1 1
$OpenBSD$
@


1.3
log
@update to php 5.3.28, fix CVE-2013-6420 memory corruption in openssl_x509_parse
(and roll in CVE patched locally). ok robert@@
@
text
@d1 4
a4 11
Security fix for CVE-2013-4073

http://git.php.net/?p=php-src.git;a=commit;h=2874696a5a8d46639d261571f915c493cd875897
http://git.php.net/?p=php-src.git;a=commit;h=b7f033bd5de844e7cf0f1f7c2b884d582d4aa847

$OpenBSD: patch-ext_openssl_openssl_c,v 1.2 2013/08/23 10:06:45 sthen Exp $
--- ext/openssl/openssl.c.orig.port	Wed Jul 10 19:43:08 2013
+++ ext/openssl/openssl.c	Thu Aug 22 22:37:08 2013
@@@@ -1326,6 +1326,74 @@@@ PHP_FUNCTION(openssl_x509_check_private_key)
 }
 /* }}} */
d6 12
a17 104
+/* Special handling of subjectAltName, see CVE-2013-4073
+ * Christian Heimes
+ */
+
+static int openssl_x509v3_subjectAltName(BIO *bio, X509_EXTENSION *extension)
+{
+	GENERAL_NAMES *names;
+	const X509V3_EXT_METHOD *method = NULL;
+	long i, length, num;
+	const unsigned char *p;
+
+	method = X509V3_EXT_get(extension);
+	if (method == NULL) {
+		return -1;
+	}
+
+	p = extension->value->data;
+	length = extension->value->length;
+	if (method->it) {
+		names = (GENERAL_NAMES*)(ASN1_item_d2i(NULL, &p, length,
+						       ASN1_ITEM_ptr(method->it)));
+	} else {
+		names = (GENERAL_NAMES*)(method->d2i(NULL, &p, length));
+	}
+	if (names == NULL) {
+		return -1;
+	}
+
+	num = sk_GENERAL_NAME_num(names);
+	for (i = 0; i < num; i++) {
+			GENERAL_NAME *name;
+			ASN1_STRING *as;
+			name = sk_GENERAL_NAME_value(names, i);
+			switch (name->type) {
+				case GEN_EMAIL:
+					BIO_puts(bio, "email:");
+					as = name->d.rfc822Name;
+					BIO_write(bio, ASN1_STRING_data(as),
+						  ASN1_STRING_length(as));
+					break;
+				case GEN_DNS:
+					BIO_puts(bio, "DNS:");
+					as = name->d.dNSName;
+					BIO_write(bio, ASN1_STRING_data(as),
+						  ASN1_STRING_length(as));
+					break;
+				case GEN_URI:
+					BIO_puts(bio, "URI:");
+					as = name->d.uniformResourceIdentifier;
+					BIO_write(bio, ASN1_STRING_data(as),
+						  ASN1_STRING_length(as));
+					break;
+				default:
+					/* use builtin print for GEN_OTHERNAME, GEN_X400,
+					 * GEN_EDIPARTY, GEN_DIRNAME, GEN_IPADD and GEN_RID
+					 */
+					GENERAL_NAME_print(bio, name);
+			}
+			/* trailing ', ' except for last element */
+			if (i < (num - 1)) {
+				BIO_puts(bio, ", ");
+			}
+	}
+	sk_GENERAL_NAME_pop_free(names, GENERAL_NAME_free);
+
+	return 0;
+}
+
 /* {{{ proto array openssl_x509_parse(mixed x509 [, bool shortnames=true])
    Returns an array of the fields/values of the CERT */
 PHP_FUNCTION(openssl_x509_parse)
@@@@ -1422,15 +1490,30 @@@@ PHP_FUNCTION(openssl_x509_parse)
 
 
 	for (i = 0; i < X509_get_ext_count(cert); i++) {
+		int nid;
 		extension = X509_get_ext(cert, i);
-		if (OBJ_obj2nid(X509_EXTENSION_get_object(extension)) != NID_undef) {
+		nid = OBJ_obj2nid(X509_EXTENSION_get_object(extension));
+		if (nid != NID_undef) {
 			extname = (char *)OBJ_nid2sn(OBJ_obj2nid(X509_EXTENSION_get_object(extension)));
 		} else {
 			OBJ_obj2txt(buf, sizeof(buf)-1, X509_EXTENSION_get_object(extension), 1);
 			extname = buf;
 		}
 		bio_out = BIO_new(BIO_s_mem());
-		if (X509V3_EXT_print(bio_out, extension, 0, 0)) {
+		if (nid == NID_subject_alt_name) {
+			if (openssl_x509v3_subjectAltName(bio_out, extension) == 0) {
+				BIO_get_mem_ptr(bio_out, &bio_buf);
+				add_assoc_stringl(subitem, extname, bio_buf->data, bio_buf->length, 1);
+			} else {
+				zval_dtor(return_value);
+				if (certresource == -1 && cert) {
+					X509_free(cert);
+				}
+				BIO_free(bio_out);
+				RETURN_FALSE;
+			}
+		}
+		else if (X509V3_EXT_print(bio_out, extension, 0, 0)) {
 			BIO_get_mem_ptr(bio_out, &bio_buf);
 			add_assoc_stringl(subitem, extname, bio_buf->data, bio_buf->length, 1);
 		} else {
@


1.2
log
@Update to new PHP releases (and backported patch for 5.3), fixing the
recent security fix which was buggy.  ok robert@@
@
text
@d6 1
a6 1
$OpenBSD: patch-ext_openssl_openssl_c,v 1.1 2013/08/23 06:32:44 robert Exp $
@


1.1
log
@add patch from php git to fix CVE-2013-4073
@
text
@d4 1
d6 1
a6 1
$OpenBSD$
d84 1
a84 1
@@@@ -1422,15 +1490,29 @@@@ PHP_FUNCTION(openssl_x509_parse)
d102 1
@

