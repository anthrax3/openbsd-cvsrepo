head	1.9;
access;
symbols
	OPENBSD_6_1:1.8.0.6
	OPENBSD_6_1_BASE:1.8
	OPENBSD_6_0:1.8.0.4
	OPENBSD_6_0_BASE:1.8
	OPENBSD_5_9:1.8.0.2
	OPENBSD_5_9_BASE:1.8
	OPENBSD_5_8:1.6.0.6
	OPENBSD_5_8_BASE:1.6
	OPENBSD_5_7:1.6.0.2
	OPENBSD_5_7_BASE:1.6
	OPENBSD_5_6:1.5.0.2
	OPENBSD_5_6_BASE:1.5
	OPENBSD_5_5:1.3.0.2
	OPENBSD_5_5_BASE:1.3
	OPENBSD_5_4:1.2.0.4
	OPENBSD_5_4_BASE:1.2
	OPENBSD_5_3:1.2.0.2
	OPENBSD_5_3_BASE:1.2
	OPENBSD_5_2:1.1.1.1.0.2
	OPENBSD_5_2_BASE:1.1.1.1
	jasper_20122305:1.1.1.1
	jasper:1.1.1;
locks; strict;
comment	@# @;


1.9
date	2017.06.27.12.04.08;	author abieber;	state Exp;
branches;
next	1.8;
commitid	6LwUI4yYazSpk8z5;

1.8
date	2016.01.29.20.12.04;	author abieber;	state Exp;
branches;
next	1.7;
commitid	qI9YnmqKmCmi0CqS;

1.7
date	2015.10.24.02.46.47;	author abieber;	state Exp;
branches;
next	1.6;
commitid	ed5E7Ght7haAuPfD;

1.6
date	2014.09.24.18.17.27;	author abieber;	state Exp;
branches;
next	1.5;
commitid	6cr0nykzWq5p7l9Z;

1.5
date	2014.05.12.01.34.55;	author abieber;	state Exp;
branches;
next	1.4;

1.4
date	2014.05.06.03.10.08;	author abieber;	state Exp;
branches;
next	1.3;

1.3
date	2013.12.04.20.20.52;	author abieber;	state Exp;
branches;
next	1.2;

1.2
date	2012.08.23.17.29.44;	author abieber;	state Exp;
branches;
next	1.1;

1.1
date	2012.05.23.15.11.43;	author jasper;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2012.05.23.15.11.43;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.9
log
@Update to v6.11.0

- regen patches (thanks danj@@)
- full changelog here: https://github.com/nodejs/node/blob/master/doc/changelogs/CHANGELOG_V6.md#6.11.0

OK danj@@
@
text
@$OpenBSD: patch-deps_npm_node_modules_node-gyp_lib_install_js,v 1.8 2016/01/29 20:12:04 abieber Exp $

Allow building of sub-packages (ie. node-sqlite3) with USE_SYSTRACE
set, also prevents downloading of the node distfile again.

Index: deps/npm/node_modules/node-gyp/lib/install.js
--- deps/npm/node_modules/node-gyp/lib/install.js.orig
+++ deps/npm/node_modules/node-gyp/lib/install.js
@@@@ -141,7 +141,7 @@@@ function install (gyp, argv, callback) {
       }
 
       // now download the node tarball
-      var tarPath = gyp.opts.tarball
+      var tarPath = gyp.opts['tarball'] || '${PREFIX}/share/node/${DISTNAME}${EXTRACT_SUFX}' // Fix for OpenBSD
       var badDownload = false
         , extractCount = 0
         , gunzip = zlib.createGunzip()
@


1.8
log
@Add in node-pledge module so users can require() it out of the box.
Build against openssl in ports.
Update to latest stable release of node.

OK giovanni@@
@
text
@d1 1
a1 1
$OpenBSD: patch-deps_npm_node_modules_node-gyp_lib_install_js,v 1.7 2015/10/24 02:46:47 abieber Exp $
d6 4
a9 3
--- deps/npm/node_modules/node-gyp/lib/install.js.orig	Wed Sep 16 07:23:58 2015
+++ deps/npm/node_modules/node-gyp/lib/install.js	Wed Sep 16 07:24:17 2015
@@@@ -178,7 +178,7 @@@@ function install (gyp, argv, callback) {
@


1.7
log
@Finally update node to the latest version, lots of changes:
 - Use internal OpenSSL (no LibreSSL :( )
 - Remove node.port.mk as there are no longer any modules in ports.
 - Remove various patches that are now upstream.
 - Fix some tests by telling test.py the fully qualified path to node
 - Add gcc as a RUN dep for building native node modules.
 - Clean up Makefile a bit.

OK juanfra@@
@
text
@d1 1
a1 1
$OpenBSD: patch-deps_npm_node_modules_node-gyp_lib_install_js,v 1.6 2014/09/24 18:17:27 abieber Exp $
d13 1
a13 1
+      var tarPath = gyp.opts['tarball'] || '${PREFIX}/lib/node/${DISTFILES}' // Fix for OpenBSD
@


1.6
log
@Update to 0.10.32 which removes the need for isolate.h diff.

goahead from landry@@ and jasper@@
@
text
@d1 1
a1 1
$OpenBSD: patch-deps_npm_node_modules_node-gyp_lib_install_js,v 1.5 2014/05/12 01:34:55 abieber Exp $
d6 3
a8 100
--- deps/npm/node_modules/node-gyp/lib/install.js.orig	Tue Sep 16 16:47:52 2014
+++ deps/npm/node_modules/node-gyp/lib/install.js	Thu Sep 18 09:53:33 2014
@@@@ -225,38 +225,19 @@@@ function install (gyp, argv, callback) {
         return
       }
 
-      var req = download(tarballUrl)
-      if (!req) return
-
-      // something went wrong downloading the tarball?
-      req.on('error', function (err) {
-        badDownload = true
-        cb(err)
-      })
-
-      req.on('close', function () {
-        if (extractCount === 0) {
-          cb(new Error('Connection closed while downloading tarball file'))
+      // OpenBSD fix
+      var filePath = '${PREFIX}/lib/node/${DISTFILES}';
+      fs.stat(filePath, function(err, stat) {
+        if (err) {
+          throw err;
+        } else {
+          fs.createReadStream(filePath)
+            .pipe(gunzip)
+            .pipe(extracter)
         }
       })
+      // OpenBSD fix
 
-      req.on('response', function (res) {
-        if (res.statusCode !== 200) {
-          badDownload = true
-          cb(new Error(res.statusCode + ' status code downloading tarball'))
-          return
-        }
-        // content checksum
-        getContentSha(res, function (_, checksum) {
-          var filename = path.basename(tarballUrl).trim()
-          contentShasums[filename] = checksum
-          log.verbose('content checksum', filename, checksum)
-        })
-
-        // start unzipping and untaring
-        req.pipe(gunzip).pipe(extracter)
-      })
-
       // invoked after the tarball has finished being extracted
       function afterTarball () {
         if (badDownload) return
@@@@ -306,39 +287,17 @@@@ function install (gyp, argv, callback) {
       }
 
       function downloadShasums(done) {
-        var shasumsFile = (checksumAlgo === 'sha256') ? 'SHASUMS256.txt' : 'SHASUMS.txt'
-        log.verbose('check download content checksum, need to download `' + shasumsFile + '`...')
-        var shasumsPath = path.resolve(devDir, shasumsFile)
-          , shasumsUrl = distUrl + '/v' + version + '/' + shasumsFile
-
-        log.verbose('checksum url', shasumsUrl)
-        var req = download(shasumsUrl)
-        if (!req) return
-        req.on('error', done)
-        req.on('response', function (res) {
-          if (res.statusCode !== 200) {
-            done(new Error(res.statusCode + ' status code downloading checksum'))
-            return
-          }
-
-          var chunks = []
-          res.on('data', function (chunk) {
-            chunks.push(chunk)
-          })
-          res.on('end', function () {
-            var lines = Buffer.concat(chunks).toString().trim().split('\n')
-            lines.forEach(function (line) {
-              var items = line.trim().split(/\s+/)
-              if (items.length !== 2) return
-
-              // 0035d18e2dcf9aad669b1c7c07319e17abfe3762  ./node-v0.11.4.tar.gz
-              var name = items[1].replace(/^\.\//, '')
-              expectShasums[name] = items[0]
-            })
-
-            log.verbose('checksum data', JSON.stringify(expectShasums))
-            done()
-          })
+        var shasum = crypto.createHash('sha1')
+        var filePath = '${PREFIX}/lib/node/${DISTFILES}'
+        var s = fs.ReadStream(filePath);
+        s.on('data', function(d) {
+          shasum.update(d);
+        })
+        s.on('end', function() {
+          var d = shasum.digest('hex');
+          expectShasums['${DISTFILES}'] = d
+          log.verbose('`SHASUMS.txt` data', JSON.stringify(expectShasums))
+          done()
         })
d11 6
@


1.5
log
@Get shasum from dist tarball vs downloaded shasum file. Fixes USE_SYSTRACE.

OK sthen@@
@
text
@d1 1
a1 1
$OpenBSD: patch-deps_npm_node_modules_node-gyp_lib_install_js,v 1.4 2014/05/06 03:10:08 abieber Exp $
d6 3
a8 3
--- deps/npm/node_modules/node-gyp/lib/install.js.orig	Thu May  1 18:47:47 2014
+++ deps/npm/node_modules/node-gyp/lib/install.js	Fri May  9 07:23:23 2014
@@@@ -222,38 +222,19 @@@@ function install (gyp, argv, callback) {
d14 10
d33 2
a34 2
+         }
+       })
a36 12
-      // something went wrong downloading the tarball?
-      req.on('error', function (err) {
-        badDownload = true
-        cb(err)
-      })
-
-      req.on('close', function () {
-        if (extractCount === 0) {
-          cb(new Error('Connection closed while downloading tarball file'))
-        }
-      })
-
d43 2
a44 2
-        // content sha1
-        getContentSha(res, function (_, sha1) {
d46 2
a47 2
-          contentShasums[filename] = sha1
-          log.verbose('content sha1', filename, sha1)
d57 1
a57 1
@@@@ -303,38 +284,18 @@@@ function install (gyp, argv, callback) {
d61 6
a66 11
-        log.verbose('check download content sha1, need to download `SHASUMS.txt`...')
-        var shasumsPath = path.resolve(devDir, 'SHASUMS.txt')
-          , shasumsUrl = distUrl + '/v' + version + '/SHASUMS.txt'
+        var shasum = crypto.createHash('sha1')
+        var filePath = '${PREFIX}/lib/node/${DISTFILES}';
+        var s = fs.ReadStream(filePath);
+        s.on('data', function(d) {
+          shasum.update(d);
+        })
 
-        log.verbose('`SHASUMS.txt` url', shasumsUrl)
d72 1
a72 1
-            done(new Error(res.statusCode + ' status code downloading SHASUMS.txt'))
d91 1
a91 1
-            log.verbose('`SHASUMS.txt` data', JSON.stringify(expectShasums))
d94 6
d102 1
a102 1
+          expectShasums['${DISTFILES}'] = d;
@


1.4
log
@Update node to 0.10.28
Changelog: https://raw.githubusercontent.com/joyent/node/v0.10.28/ChangeLog

OK jturner@@
@
text
@d1 1
a1 1
$OpenBSD: patch-deps_npm_node_modules_node-gyp_lib_install_js,v 1.3 2013/12/04 20:20:52 abieber Exp $
d7 2
a8 2
+++ deps/npm/node_modules/node-gyp/lib/install.js	Mon May  5 16:17:34 2014
@@@@ -222,37 +222,18 @@@@ function install (gyp, argv, callback) {
d14 13
a26 1
-
d55 1
a55 13
+      // OpenBSD fix
+      var filePath = '${PREFIX}/lib/node/${DISTFILES}';
+      fs.stat(filePath, function(err, stat) {
+        if (err) {
+          throw err;
+        } else {
+          fs.createReadStream(filePath)
+            .pipe(gunzip)
+            .pipe(extracter)
+         }
+       })
+      // OpenBSD fix
 
d58 51
@


1.3
log
@Update node to the lastest version.

OK jasper@@
@
text
@d1 1
a1 1
$OpenBSD: patch-deps_npm_node_modules_node-gyp_lib_install_js,v 1.2 2012/08/23 17:29:44 abieber Exp $
d6 3
a8 3
--- deps/npm/node_modules/node-gyp/lib/install.js.orig	Tue Nov 12 13:22:12 2013
+++ deps/npm/node_modules/node-gyp/lib/install.js	Sat Nov 23 15:02:03 2013
@@@@ -209,30 +209,18 @@@@ function install (gyp, argv, callback) {
d24 2
a25 11
+      // OpenBSD fix
+      var filePath = '${PREFIX}/lib/node/${DISTFILES}';
+      fs.stat(filePath, function(err, stat) {
+        if (err) {
+          throw err;
+        } else {
+          fs.createReadStream(filePath)
+            .pipe(gunzip)
+            .pipe(extracter)
         }
       })
d33 7
d43 11
@


1.2
log
@- update node to 0.8.7
- add @@mandir to plist
OK sthen@@, jasper@@
@
text
@d1 1
a1 1
$OpenBSD: patch-deps_npm_node_modules_node-gyp_lib_install_js,v 1.1.1.1 2012/05/23 15:11:43 jasper Exp $
d6 5
a10 5
--- deps/npm/node_modules/node-gyp/lib/install.js.orig	Tue Aug 21 18:58:33 2012
+++ deps/npm/node_modules/node-gyp/lib/install.js	Tue Aug 21 19:00:06 2012
@@@@ -212,31 +212,18 @@@@ function install (gyp, argv, callback) {
       extracter.on('error', cb)
       extracter.on('end', afterTarball)
a11 1
-      // download the tarball, gunzip and extract!
d34 1
a34 1
-      })
a44 1
+      });
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
$OpenBSD: patch-deps_npm_node_modules_node-gyp_lib_install_js,v 1.2 2012/05/10 18:29:52 sthen Exp $
d6 5
a10 5
--- deps/npm/node_modules/node-gyp/lib/install.js.orig	Thu May 10 07:09:14 2012
+++ deps/npm/node_modules/node-gyp/lib/install.js	Thu May 10 07:15:41 2012
@@@@ -166,10 +166,19 @@@@ function install (gyp, argv, callback) {
     extracter.on('error', cb)
     extracter.on('end', afterTarball)
d12 36
a47 17
-    // download the tarball, gunzip and extract!
-    var req = download(tarballUrl, downloadError)
-      .pipe(gunzip)
-      .pipe(extracter)
+	// OpenBSD fix
+	var filePath = '${PREFIX}/lib/node/${DISTFILES}';
+	fs.stat(filePath, function(err, stat) {
+		if (err) {
+			throw err;
+		} else {
+			// use packaged tarball
+			fs.createReadStream(filePath)
+			  .pipe(gunzip)
+			  .pipe(extracter)
+		}
+	});
+	// OpenBSD fix 
d49 2
a50 2
     // something went wrong downloading the tarball?
     function downloadError (err, res) {
@


1.1.1.1
log
@re-import node into lang, www was poorly chosen at the time of import

from aaron bieber (MAINTAINER), with cluestick hitting by espie@@ 
as discussed with and ok sthen@@

@
text
@@
