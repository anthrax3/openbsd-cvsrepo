head	1.3;
access;
symbols
	OPENBSD_6_1:1.3.0.2
	OPENBSD_6_1_BASE:1.3
	OPENBSD_6_0:1.2.0.12
	OPENBSD_6_0_BASE:1.2
	OPENBSD_5_9:1.2.0.8
	OPENBSD_5_9_BASE:1.2
	OPENBSD_5_8:1.2.0.10
	OPENBSD_5_8_BASE:1.2
	OPENBSD_5_7:1.2.0.6
	OPENBSD_5_7_BASE:1.2
	OPENBSD_5_6:1.2.0.4
	OPENBSD_5_6_BASE:1.2
	OPENBSD_5_5:1.2.0.2
	OPENBSD_5_5_BASE:1.2
	OPENBSD_5_4:1.1.0.2
	OPENBSD_5_4_BASE:1.1;
locks; strict;
comment	@# @;


1.3
date	2017.01.23.16.47.04;	author abieber;	state Exp;
branches;
next	1.2;
commitid	xBUY4sNTydDQXYd6;

1.2
date	2014.01.20.19.42.00;	author abieber;	state Exp;
branches;
next	1.1;

1.1
date	2013.06.17.23.51.28;	author abieber;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Bump node to latest. Tested on amd64 and i386.

- fix Makefile layout
- back to using internal openssl :(

Rough OK from awolk@@, OK fcambus@@
@
text
@$OpenBSD: patch-deps_npm_lib_build_js,v 1.2 2014/01/20 19:42:00 abieber Exp $
--- deps/npm/lib/build.js.orig	Thu Nov  3 08:07:29 2016
+++ deps/npm/lib/build.js	Thu Nov  3 08:11:47 2016
@@@@ -203,17 +203,23 @@@@ function linkBins (pkg, folder, parent, gtop, cb) {
         // bins should always be executable.
         // XXX skip chmod on windows?
         var src = path.resolve(folder, pkg.bin[b])
-        fs.chmod(src, npm.modes.exec, function (er) {
-          if (er && er.code === 'ENOENT' && npm.config.get('ignore-scripts')) {
-            return cb()
+        fs.lstat(folder, function (er,stat) {
+          if (!stat.isSymbolicLink) {
+            fs.chmod(src, npm.modes.exec, function (er) {
+              if (er && er.code === "ENOENT" && npm.config.get("ignore-scripts")) {
+                return cb()
+              }
+              if (er || !gtop) return cb(er)
+              var dest = path.resolve(binRoot, b)
+                , out = npm.config.get("parseable")
+                      ? dest + "::" + src + ":BINFILE"
+                      : dest + " -> " + src
+              console.log(out)
+              cb()
+            })
+          } else {
+           cb()
           }
-          if (er || !gtop) return cb(er)
-          var dest = path.resolve(binRoot, b)
-          var out = npm.config.get('parseable')
-                  ? dest + '::' + src + ':BINFILE'
-                  : dest + ' -> ' + src
-          output(out)
-          cb()
         })
       }
     )
@


1.2
log
@update node to 0.10.24 which has a few fixes for cve-2013-6639 and
cve-2013-6640.

OK jasper@@
@
text
@d1 37
a37 37
$OpenBSD: patch-deps_npm_lib_build_js,v 1.1 2013/06/17 23:51:28 abieber Exp $
--- deps/npm/lib/build.js.orig	Wed Dec 18 16:49:45 2013
+++ deps/npm/lib/build.js	Mon Dec 23 09:25:46 2013
@@@@ -175,17 +175,23 @@@@ function linkBins (pkg, folder, parent, gtop, cb) {
       // bins should always be executable.
       // XXX skip chmod on windows?
       var src = path.resolve(folder, pkg.bin[b])
-      fs.chmod(src, npm.modes.exec, function (er) {
-        if (er && er.code === "ENOENT" && npm.config.get("ignore-scripts")) {
-          return cb()
+      fs.lstat(folder, function (er,stat) {
+        if (!stat.isSymbolicLink) {
+          fs.chmod(src, npm.modes.exec, function (er) {
+            if (er && er.code === "ENOENT" && npm.config.get("ignore-scripts")) {
+              return cb()
+            }
+            if (er || !gtop) return cb(er)
+            var dest = path.resolve(binRoot, b)
+              , out = npm.config.get("parseable")
+                    ? dest + "::" + src + ":BINFILE"
+                    : dest + " -> " + src
+            console.log(out)
+            cb()
+          })
+        } else {
+          cb()
         }
-        if (er || !gtop) return cb(er)
-        var dest = path.resolve(binRoot, b)
-          , out = npm.config.get("parseable")
-                ? dest + "::" + src + ":BINFILE"
-                : dest + " -> " + src
-        console.log(out)
-        cb()
       })
     })
   }, cb)
@


1.1
log
@Fix to make npm not try and chmod symlinked modules. Sent upstream as well:
https://github.com/isaacs/npm/pull/3575

OK sthen@@
@
text
@d1 4
a4 5
$OpenBSD$
--- deps/npm/lib/build.js.orig	Mon Jun 17 13:04:25 2013
+++ deps/npm/lib/build.js	Mon Jun 17 13:06:31 2013
@@@@ -172,15 +172,21 @@@@ function linkBins (pkg, folder, parent, gtop, cb) {
       if (er) return cb(er)
d7 4
a10 9
-      fs.chmod(path.resolve(folder, pkg.bin[b]), npm.modes.exec, function (er) {
-        if (er || !gtop) return cb(er)
-        var dest = path.resolve(binRoot, b)
-          , src = path.resolve(folder, pkg.bin[b])
-          , out = npm.config.get("parseable")
-                ? dest + "::" + src + ":BINFILE"
-                : dest + " -> " + src
-        console.log(out)
-        cb()
d13 4
a16 1
+          fs.chmod(path.resolve(folder, pkg.bin[b]), npm.modes.exec, function (er) {
a18 1
+              , src = path.resolve(folder, pkg.bin[b])
d27 8
a34 1
+        }
@

