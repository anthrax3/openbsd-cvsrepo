head	1.4;
access;
symbols
	OPENBSD_5_1_BASE:1.3
	OPENBSD_5_1:1.3.0.18
	OPENBSD_5_0:1.3.0.16
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_9:1.3.0.14
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.3.0.12
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.3.0.10
	OPENBSD_4_7_BASE:1.3
	OPENBSD_4_6:1.3.0.8
	OPENBSD_4_6_BASE:1.3
	OPENBSD_4_5:1.3.0.6
	OPENBSD_4_5_BASE:1.3
	OPENBSD_4_4:1.3.0.4
	OPENBSD_4_4_BASE:1.3
	OPENBSD_4_3:1.3.0.2
	OPENBSD_4_3_BASE:1.3
	OPENBSD_4_2:1.2.0.6
	OPENBSD_4_2_BASE:1.2
	OPENBSD_4_1:1.2.0.4
	OPENBSD_4_1_BASE:1.2
	OPENBSD_4_0:1.2.0.2
	OPENBSD_4_0_BASE:1.2
	OPENBSD_3_9:1.1.0.2
	OPENBSD_3_9_BASE:1.1;
locks; strict;
comment	@# @;


1.4
date	2012.03.07.13.14.27;	author sthen;	state dead;
branches;
next	1.3;

1.3
date	2007.10.29.20.30.32;	author espie;	state Exp;
branches;
next	1.2;

1.2
date	2006.07.30.04.25.41;	author pedro;	state Exp;
branches;
next	1.1;

1.1
date	2006.01.18.11.17.03;	author pedro;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Remove local strlcpy/etc patches, we aren't generally patching these in
ports any more (they should be addressed upstream instead) and at least
some of them are wrong. This fixes a bug found by Piotr Sikora:
http://permalink.gmane.org/gmane.os.openbsd.ports/53993
@
text
@$OpenBSD: patch-src_lobject_c,v 1.3 2007/10/29 20:30:32 espie Exp $
--- src/lobject.c.orig	Fri Feb 10 18:43:52 2006
+++ src/lobject.c	Mon Oct 29 21:26:20 2007
@@@@ -142,7 +142,7 @@@@ const char *luaO_pushvfstring (lua_State *L, const cha
       }
       case 'p': {
         char buff[4*sizeof(void *) + 8]; /* should be enough space for a `%p' */
-        sprintf(buff, "%p", va_arg(argp, void *));
+        snprintf(buff, sizeof(buff), "%p", va_arg(argp, void *));
         pushstr(L, buff);
         break;
       }
@@@@ -180,35 +180,33 @@@@ const char *luaO_pushfstring (lua_State *L, const char
 
 
 void luaO_chunkid (char *out, const char *source, size_t bufflen) {
-  if (*source == '=') {
-    strncpy(out, source+1, bufflen);  /* remove first char */
-    out[bufflen-1] = '\0';  /* ensures null termination */
-  }
+  if (*source == '=')
+    strlcpy(out, source+1, bufflen);  /* remove first char */
   else {  /* out = "source", or "...source" */
     if (*source == '@@') {
-      size_t l;
+      size_t l, m;
       source++;  /* skip the `@@' */
-      bufflen -= sizeof(" '...' ");
       l = strlen(source);
-      strcpy(out, "");
-      if (l > bufflen) {
-        source += (l-bufflen);  /* get last part of file name */
-        strcat(out, "...");
+      m = bufflen - sizeof(" '...' ");
+      strlcpy(out, "", bufflen);
+      if (l > m) {
+        source += (l-m);  /* get last part of file name */
+	strlcat(out, "...", bufflen);
       }
-      strcat(out, source);
+      strlcat(out, source, bufflen);
     }
     else {  /* out = [string "string"] */
-      size_t len = strcspn(source, "\n\r");  /* stop at first newline */
-      bufflen -= sizeof(" [string \"...\"] ");
-      if (len > bufflen) len = bufflen;
-      strcpy(out, "[string \"");
+      size_t pos = strcspn(source, "\n\r");  /* stop at first newline */
+      size_t len = bufflen - sizeof(" [string \"...\"] ");
+      if (pos > len) pos = len;
+      strlcpy(out, "[string \"", bufflen);
       if (source[len] != '\0') {  /* must truncate? */
-        strncat(out, source, len);
-        strcat(out, "...");
+        strlcat(out, source, len);
+        strlcat(out, "...", bufflen);
       }
       else
-        strcat(out, source);
-      strcat(out, "\"]");
+        strlcat(out, source, bufflen);
+      strlcat(out, "\"]", bufflen);
     }
   }
 }
@


1.3
log
@obvious dependency fix.
also regen patches.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_lobject_c,v 1.2 2006/07/30 04:25:41 pedro Exp $
@


1.2
log
@Update to Lua 5.1, okay jolan@@
@
text
@d1 4
a4 4
$OpenBSD$
--- src/lobject.c.orig	Fri Feb 10 15:43:52 2006
+++ src/lobject.c	Fri May 19 11:09:38 2006
@@@@ -142,7 +142,7 @@@@ const char *luaO_pushvfstring (lua_State
d13 1
a13 1
@@@@ -180,35 +180,33 @@@@ const char *luaO_pushfstring (lua_State 
@


1.1
log
@Replace the very few uses of strcpy(), strcat() and sprintf() by their
safe counterparts, okay jolan@@
@
text
@d2 12
a13 3
--- src/lobject.c.orig	Thu Apr  3 10:35:34 2003
+++ src/lobject.c	Tue Jan 17 14:06:46 2006
@@@@ -161,35 +161,33 @@@@ const char *luaO_pushfstring (lua_State 
d16 1
a16 1
 void luaO_chunkid (char *out, const char *source, int bufflen) {
d25 2
a26 2
-      int l;
+      int l, m;
d28 1
a28 1
-      bufflen -= sizeof(" `...' ");
d31 1
a31 1
-      if (l>bufflen) {
d38 1
a38 1
+        strlcat(out, "...", bufflen);
d44 1
a44 1
-      int len = strcspn(source, "\n");  /* stop at first newline */
d48 2
a49 2
+      int pos = strcspn(source, "\n\r");  /* stop at first newline */
+      int len = bufflen - sizeof(" [string \"...\"] ");
@

