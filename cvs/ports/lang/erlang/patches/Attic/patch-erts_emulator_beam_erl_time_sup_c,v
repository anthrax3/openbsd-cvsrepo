head	1.4;
access;
symbols
	OPENBSD_5_2:1.3.0.2
	OPENBSD_5_2_BASE:1.3
	OPENBSD_5_0:1.1.0.2
	OPENBSD_5_0_BASE:1.1;
locks; strict;
comment	@# @;


1.4
date	2012.09.10.20.35.19;	author jasper;	state dead;
branches;
next	1.3;

1.3
date	2012.07.18.13.44.31;	author jasper;	state Exp;
branches;
next	1.2;

1.2
date	2011.12.23.13.40.13;	author jasper;	state dead;
branches;
next	1.1;

1.1
date	2011.07.05.20.07.30;	author landry;	state Exp;
branches;
next	;


desc
@@


1.4
log
@- update erlang to R15B02
@
text
@$OpenBSD: patch-erts_emulator_beam_erl_time_sup_c,v 1.3 2012/07/18 13:44:31 jasper Exp $

[PATCH] Fix use of "clever" mktime.

Commit 1eef765 introduced regression (conditional _always_ evaluates
to true) in which erlang:localtime_to_universaltime/2 stopped working
on systems configured with timezone without DST (i.e. UTC) on *BSD
platforms:

1> erlang:localtime_to_universaltime({{2012,1,1},{0,0,0}}, true).
** exception error: bad argument


[PATCH] Fix support for leap seconds-aware timezones.

erlang:universaltime_to_localtime is leap seconds-aware (since 2008),
however erlang:localtime_to_universaltime is not, which gives
surprising results on systems configured with leap seconds-aware
timezones:

1> erlang:universaltime_to_localtime({{2012,1,1},{0,0,0}}).
{{2012,1,1},{0,0,0}}
2> erlang:localtime_to_universaltime({{2012,1,1},{0,0,0}}).
{{2012,1,1},{0,0,24}}

and completely breaks calendar:local_time_to_universal_time_dst:

3> calendar:local_time_to_universal_time_dst({{2011,1,1},{0,0,0}}).
[]
--- erts/emulator/beam/erl_time_sup.c.orig	Sun Apr  1 18:14:36 2012
+++ erts/emulator/beam/erl_time_sup.c	Fri Jul 13 05:52:50 2012
@@@@ -757,7 +757,7 @@@@
 	       refuses to give us a DST time, we simulate the Linux/Solaris
 	       behaviour of giving the same data as if is_dst was not set. */
 	    t.tm_isdst = 0;
-	    if (erl_mktime(&the_clock, &t)) {
+	    if (erl_mktime(&the_clock, &t) < 0) {
 		/* Failed anyway, something else is bad - will be a badarg */
 		return 0;
 	    }
@@@@ -766,6 +766,9 @@@@
 	    return 0;
 	}
     }
+
+    the_clock = time2posix(the_clock);
+
 #ifdef HAVE_GMTIME_R
     tm = gmtime_r(&the_clock, &tmbuf);
 #else
@


1.3
log
@-  Fix use of "clever" mktime.
-  Fix support for leap seconds-aware timezones.

from piotr sikora
@
text
@d1 1
a1 1
$OpenBSD$
@


1.2
log
@- update to R14B04
- fix conflict with speech-dispatcher
- fix gen-versions target
- i386 ethread compat

update to R14B04 from dlg@@, rest by piotr sikora and me
tested with rabbitmq and ejabberd on amd64; sparc64 is still happy too

maintainer timed-out
@
text
@d1 1
a1 1
$OpenBSD: patch-erts_emulator_beam_erl_time_sup_c,v 1.1 2011/07/05 20:07:30 landry Exp $
d3 45
a47 25
Backport fix for correct handling of date/time conversions on systems
with timezone without DST (like UTC):
https://github.com/erlang/otp/commit/7e6fe78278c203c3756ce0d6bf23a6bd6cf7bb5d
--- erts/emulator/beam/erl_time_sup.c.orig
+++ erts/emulator/beam/erl_time_sup.c
@@@@ -650,6 +650,22 @@@@ local_to_univ(Sint *year, Sint *month, Sint *day,
     t.tm_sec = *second;
     t.tm_isdst = isdst;
     the_clock = mktime(&t);
+    if (the_clock == -1) {
+       if (isdst) {
+           /* If this is a timezone without DST and the OS (correctly)
+              refuses to give us a DST time, we simulate the Linux/Solaris
+              behaviour of giving the same data as if is_dst was not set. */
+           t.tm_isdst = 0;
+           the_clock = mktime(&t);
+           if (the_clock == -1) {
+               /* Failed anyway, something else is bad - will be a badarg */
+               return 0;
+           }
+       } else {
+           /* Something else is the matter, badarg. */
+           return 0;
+       }
+    }
d49 1
a49 1
     gmtime_r(&the_clock, (tm = &tmbuf));
a50 11
@@@@ -663,6 +679,10 @@@@ local_to_univ(Sint *year, Sint *month, Sint *day,
     *second = tm->tm_sec;
     return 1;
 }
+#if defined(HAVE_POSIX2TIME) && defined(HAVE_DECL_POSIX2TIME) && \
+    !HAVE_DECL_POSIX2TIME
+extern time_t posix2time(time_t);
+#endif

 int
 univ_to_local(Sint *year, Sint *month, Sint *day,
@


1.1
log
@Backport https://github.com/erlang/otp/commit/7e6fe78278c203c3756ce0d6bf23a6bd6cf7bb5d
From Piotr Sikora, Fixes a crasher in timezone handling with MochiWeb.
@
text
@d1 1
a1 1
$OpenBSD$
@

