head	1.5;
access;
symbols
	OPENBSD_6_1:1.3.0.2
	OPENBSD_6_1_BASE:1.3
	pascal_20160904:1.1.1.1
	pascal:1.1.1;
locks; strict;
comment	@# @;


1.5
date	2017.07.19.09.23.16;	author pascal;	state Exp;
branches;
next	1.4;
commitid	6OFtMLIxXVtJ6fHA;

1.4
date	2017.06.07.23.34.02;	author brynet;	state Exp;
branches;
next	1.3;
commitid	7XsuswH2A0fSAUjj;

1.3
date	2016.12.28.21.48.21;	author pascal;	state Exp;
branches;
next	1.2;
commitid	WGf0BYDvhPmgYakh;

1.2
date	2016.11.13.14.39.32;	author pascal;	state Exp;
branches;
next	1.1;
commitid	GyXaf9S72legReNp;

1.1
date	2016.09.04.16.20.17;	author pascal;	state Exp;
branches
	1.1.1.1;
next	;
commitid	kt4pzu6QIrUczPNq;

1.1.1.1
date	2016.09.04.16.20.17;	author pascal;	state Exp;
branches;
next	;
commitid	kt4pzu6QIrUczPNq;


desc
@@


1.5
log
@Update to GCC 6.4.0, regen bootstraps.
@
text
@Backport: https://gcc.gnu.org/git/?p=gcc.git;a=commitdiff;h=b44e9be23d38be8997ae64d7509ac22cb4c556d6

$OpenBSD: patch-gcc_config_i386_i386_c,v 1.4 2017/06/07 23:34:02 brynet Exp $
Index: gcc/config/i386/i386.c
--- gcc/config/i386/i386.c.orig
+++ gcc/config/i386/i386.c
@@@@ -2476,6 +2476,8 @@@@ struct ix86_frame
   HOST_WIDE_INT reg_save_offset;
   HOST_WIDE_INT sse_reg_save_offset;
 
+  HOST_WIDE_INT local_size;
+
   /* When save_regs_using_mov is set, emit prologue using
      move instead of push instructions.  */
   bool save_regs_using_mov;
@@@@ -8686,7 +8688,7 @@@@ function_arg_advance_32 (CUMULATIVE_ARGS *cum, machine
 			 HOST_WIDE_INT words)
 {
   int res = 0;
-  bool error_p = NULL;
+  bool error_p = false;
 
   if (TARGET_IAMCU)
     {
@@@@ -11396,6 +11398,7 @@@@ ix86_compute_frame_layout (struct ix86_frame *frame)
   HOST_WIDE_INT size = get_frame_size ();
   HOST_WIDE_INT to_allocate;
 
+  frame->local_size = size;
   frame->nregs = ix86_nsaved_regs ();
   frame->nsseregs = ix86_nsaved_sseregs ();
 
@@@@ -12838,6 +12841,9 @@@@ ix86_expand_prologue (void)
 	  RTX_FRAME_RELATED_P (insn) = 1;
 	}
     }
+
+  if (warn_stack_larger_than && frame.local_size > stack_larger_than_size)
+    warning (OPT_Wstack_larger_than_, "stack usage is %lld bytes", frame.local_size);
 
   int_registers_saved = (frame.nregs == 0);
   sse_registers_saved = (frame.nsseregs == 0);
@


1.4
log
@Backport, or rather forward port, a fix for the broken stack-protector on amd64.

This mirrors a change made to base gcc4.2 by martynas@@ in 2014.

https://marc.info/?l=openbsd-ports&m=149656580518245&w=2

Includes an independent fix from upstream for gcc6, currently unlinked
from builds

Also, stop installing libssp as it broken on OpenBSD as it tries to use gets()

pirofti@@ ok'd an earlier version, suggestions from sthen@@
"doesn't look dangerous" espie@@
"pretty astounding" deraadt@@
@
text
@d3 4
a6 3
$OpenBSD: patch-gcc_config_i386_i386_c,v 1.3 2016/12/28 21:48:21 pascal Exp $
--- gcc/config/i386/i386.c.orig	Wed Dec 14 10:44:07 2016
+++ gcc/config/i386/i386.c	Wed Jun  7 16:10:33 2017
d33 2
a34 1
@@@@ -12839,6 +12842,9 @@@@ ix86_expand_prologue (void)
d37 1
a37 1
 
d40 1
a40 1
+
a42 10
 
@@@@ -29372,7 +29378,7 @@@@ ix86_local_alignment (tree exp, machine_mode mode,
 		  != TYPE_MAIN_VARIANT (va_list_type_node)))
 	  && TYPE_SIZE (type)
 	  && TREE_CODE (TYPE_SIZE (type)) == INTEGER_CST
-	  && wi::geu_p (TYPE_SIZE (type), 16)
+	  && wi::geu_p (TYPE_SIZE (type), 128)
 	  && align < 128)
 	return 128;
     }
@


1.3
log
@Update to gcc 6.3.0; regen bootstraps.
@
text
@d1 5
a5 3
$OpenBSD: patch-gcc_config_i386_i386_c,v 1.2 2016/11/13 14:39:32 pascal Exp $
--- gcc/config/i386/i386.c.orig	Wed Dec 14 16:44:07 2016
+++ gcc/config/i386/i386.c	Fri Dec 23 18:25:11 2016
d32 1
a32 2
@@@@ -12838,6 +12841,9 @@@@ ix86_expand_prologue (void)
 	  RTX_FRAME_RELATED_P (insn) = 1;
d35 1
a35 1
+
d38 1
a38 1
 
d41 10
@


1.2
log
@Fix build after changes to our NULL definition.  Noticed by naddy@@.
@
text
@d1 4
a4 4
$OpenBSD: patch-gcc_config_i386_i386_c,v 1.1.1.1 2016/09/04 16:20:17 pascal Exp $
--- gcc/config/i386/i386.c.orig	Fri Jul 29 14:41:46 2016
+++ gcc/config/i386/i386.c	Sat Nov 12 20:19:34 2016
@@@@ -2474,6 +2474,8 @@@@ struct ix86_frame
d13 1
a13 1
@@@@ -8693,7 +8695,7 @@@@ function_arg_advance_32 (CUMULATIVE_ARGS *cum, machine
d22 1
a22 1
@@@@ -11378,6 +11380,7 @@@@ ix86_compute_frame_layout (struct ix86_frame *frame)
d30 1
a30 1
@@@@ -12820,6 +12823,9 @@@@ ix86_expand_prologue (void)
@


1.1
log
@Initial revision
@
text
@d1 3
a3 3
$OpenBSD: patch-gcc_config_i386_i386_c,v 1.3 2015/07/19 21:22:49 pascal Exp $
--- gcc/config/i386/i386.c.orig	Fri Jul 29 13:41:46 2016
+++ gcc/config/i386/i386.c	Wed Aug 31 13:08:17 2016
d13 9
@


1.1.1.1
log
@Import GCC 6.2.0.

ok espie@@
@
text
@@
