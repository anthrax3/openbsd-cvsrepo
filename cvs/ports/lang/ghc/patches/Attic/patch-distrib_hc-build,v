head	1.6;
access;
symbols
	OPENBSD_4_1:1.5.0.10
	OPENBSD_4_1_BASE:1.5
	OPENBSD_4_0:1.5.0.8
	OPENBSD_4_0_BASE:1.5
	OPENBSD_3_9:1.5.0.6
	OPENBSD_3_9_BASE:1.5
	OPENBSD_3_8:1.5.0.4
	OPENBSD_3_8_BASE:1.5
	OPENBSD_3_7:1.5.0.2
	OPENBSD_3_7_BASE:1.5
	OPENBSD_3_6:1.3.0.2
	OPENBSD_3_6_BASE:1.3
	OPENBSD_3_5:1.2.0.2
	OPENBSD_3_5_BASE:1.2
	OPENBSD_3_4:1.1.0.2
	OPENBSD_3_4_BASE:1.1;
locks; strict;
comment	@# @;


1.6
date	2007.07.21.17.14.57;	author kili;	state dead;
branches;
next	1.5;

1.5
date	2005.02.19.03.42.11;	author dons;	state Exp;
branches;
next	1.4;

1.4
date	2005.02.14.01.26.56;	author dons;	state Exp;
branches;
next	1.3;

1.3
date	2004.04.26.23.48.50;	author dons;	state Exp;
branches;
next	1.2;

1.2
date	2004.01.08.20.33.23;	author avsm;	state Exp;
branches;
next	1.1;

1.1
date	2003.09.01.20.32.14;	author espie;	state Exp;
branches;
next	;


desc
@@


1.6
log
@
Update to 6.6.1. With helpful hints from Don Stewart and espie@@.
Thanks to all the testers and to steven@@, who was so kind to
build the HC files for bootstrapping on amd64.
@
text
@$OpenBSD: patch-distrib_hc-build,v 1.5 2005/02/19 03:42:11 dons Exp $
SplitObjs just slows things down, and can overrun ulimits. It does
produce smaller binaries though...

Help ghc find libgmp.a

And GHC produces stack_smash_handler() core dumps on sparc 
unless propolice is turned off. This used to happen on x86, but
has been fixed. Someone want to fix this on sparc?

For some odd reason the existing regex doesn't want to remove all *.o
and *.a files from the libraries. Can't work out why.

Touch some things so that 'make fake' doesn't rebuild the compiler

Make stage=2 after everything else, so as to get a working ghci. Unknown
why ghci doesn't work just via .hc files.

--- distrib/hc-build.orig	Wed Sep  3 05:15:19 2003
+++ distrib/hc-build	Thu Feb 17 19:30:42 2005
@@@@ -29,20 +29,31 @@@@ fi
 case "$configopts" in
 *--enable-hc-boot-unregisterised*)
 cat >mk/build.mk <<END
-GhcWithInterpreter=NO
 GhcWithNativeCodeGen=NO
 SplitObjs=NO
-GhcLibWays=
+SRC_HC_OPTS+=-L\$(LOCALBASE)/lib
+SRC_CC_OPTS+=-L\$(LOCALBASE)/lib
+GhcUnregisterised=YES
 END
 ;;
 
 *)
 cat >mk/build.mk <<END
 # empty
+SplitObjs=NO
+SRC_HC_OPTS+=-L\$(LOCALBASE)/lib
+SRC_CC_OPTS+=-L\$(LOCALBASE)/lib
 END
 ;;
 esac
 
+if [ `uname -m` == "sparc" ] ; then
+	echo "SRC_HC_OPTS+=-optc-fno-stack-protector" >> mk/build.mk
+	echo "SRC_CC_OPTS+=-fno-stack-protector" >> mk/build.mk
+fi
+
+export CPPFLAGS="-I${LOCALBASE}/include" LDFLAGS="-L${LOCALBASE}/lib"
+
 echo "*** Building compiler..."
 ./configure --enable-hc-boot $configopts
 
@@@@ -77,7 +88,7 @@@@ PRIMOP_BITS="primop-data-decl.hs-incl \
 # Remove the old libraries.  Don't use make clean, because we don't
 # want to delete the .hs files generated from the .hsc files, because
 # we don't have hsc2hs built yet.
-find libraries hslibs | grep '\.\(o\|a\)$' | xargs rm -f
+find libraries hslibs | grep '\.[oa]$' | xargs rm -f
 
 # Do includes and RTS now
 $MAKE -C ghc/includes boot && $MAKE -C ghc/includes all
@@@@ -95,6 +106,10 @@@@ $MAKE -C hslibs  boot all
 # The reconfigure step updates a few files, which can lead to
 # unnecessary recompilations.  Touch a bunch of things here to avoid
 # having to recompile stuff that we've already built.
-(cd ghc/compiler; touch $PRIMOP_BITS parser/hschooks.o prelude/PrimOp.o main/Config.hs main/Config.o ghc-*)
+#(cd ghc/compiler/; touch $PRIMOP_BITS main/Config.hs stage1/parser/hschooks.o stage1/prelude/PrimOp.o stage1/main/Config.o stage1/ghc-* ghc-inplace)
 
 # At this point, the tree should be safe to do 'make install' in.
+
+# now, ghci doesn't work when build via .hc, so make stage=2, and build
+# it via .hs
+(cd ghc/compiler; touch prelude/primops.txt ; gmake boot stage=2 && gmake stage=2)
@


1.5
log
@Port ghc-6.2.2 to amd64.

ok pvalchev@@
@
text
@d1 1
a1 1
$OpenBSD: patch-distrib_hc-build,v 1.4 2005/02/14 01:26:56 dons Exp $
@


1.4
log
@Update ghc to 6.2.2.
Adds support for ghci. More stable foreign function interface.

Just i386 at the moment.

ok sturm@@ pvalchev@@
@
text
@d1 1
a1 1
$OpenBSD: patch-distrib_hc-build,v 1.3 2004/04/26 23:48:50 dons Exp $
d19 3
a21 3
--- distrib/hc-build.orig	Wed Sep  3 21:15:19 2003
+++ distrib/hc-build	Wed Feb  2 13:00:23 2005
@@@@ -29,20 +29,30 @@@@ fi
d31 1
d55 1
a55 1
@@@@ -77,7 +87,7 @@@@ PRIMOP_BITS="primop-data-decl.hs-incl \
d64 1
a64 1
@@@@ -95,6 +105,10 @@@@ $MAKE -C hslibs  boot all
@


1.3
log
@Update GHC to 6.2.1, and port to amd64

ok avsm@@ pvalchev@@
@
text
@d1 1
a1 1
$OpenBSD$
d16 6
a21 3
--- distrib/hc-build.orig	Wed Sep  3 05:15:19 2003
+++ distrib/hc-build	Sun Apr 18 21:33:49 2004
@@@@ -29,10 +29,10 @@@@
a33 1
@@@@ -39,10 +39,20 @@@@
d54 1
a54 1
@@@@ -77,7 +87,7 @@@@
d63 1
a63 1
@@@@ -95,6 +105,6 @@@@
d68 1
a68 1
+(cd ghc/compiler/; touch $PRIMOP_BITS main/Config.hs stage1/parser/hschooks.o stage1/prelude/PrimOp.o stage1/main/Config.o stage1/ghc-* ghc-inplace)
d71 4
@


1.2
log
@Add support for sparc ghc.
Hard work by Donald Stewart <dons at cse.unsw.edu.au>
@
text
@d1 5
a5 1
SplitObjs just slows things down, and can overrun ulimits
d11 2
a12 1
Help ghc find libgmp.a
d14 1
a14 1
And that old regex doesn't work/is a gnu grep thing?
d16 16
a31 5
And touch some files to avoid recompiling ghc/compiler on install

--- distrib/hc-build.orig	Fri Jul 25 04:23:30 2003
+++ distrib/hc-build	Tue Sep 23 02:35:34 2003
@@@@ -37,10 +37,20 @@@@
d52 1
a52 6
@@@@ -75,12 +85,11 @@@@
 # The reconfigure step updates a few files, which can lead to
 # unnecessary recompilations.  Touch a bunch of things here to avoid
 # having to recompile stuff that we've already built.
-(cd ghc/compiler; touch $PRIMOP_BITS parser/hschooks.o prelude/PrimOp.o main/Config.hs main/Config.o ghc-*)
 
d61 5
a65 5
@@@@ -96,6 +105,6 @@@@
 $MAKE -C hslibs  boot all
 
 # Avoid relinking the compiler during 'make install':
-(cd ghc/compiler; touch parser/hschooks.o ghc-*)
@


1.1
log
@Bootstrap using a more recent ghc, solves gc issues. From maintainer.
okay naddy.
@
text
@d2 5
d8 1
d10 1
d13 3
a15 3
--- distrib/hc-build.orig	Fri Jul 25 20:23:30 2003
+++ distrib/hc-build	Sun Aug 24 11:36:45 2003
@@@@ -37,10 +37,15 @@@@
d26 5
d36 1
a36 1
@@@@ -75,12 +80,11 @@@@
d50 1
a50 1
@@@@ -96,6 +100,6 @@@@
@

