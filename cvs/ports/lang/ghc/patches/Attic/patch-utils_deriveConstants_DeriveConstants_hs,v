head	1.2;
access;
symbols
	OPENBSD_5_8:1.1.0.6
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.2
	OPENBSD_5_7_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2015.09.19.07.42.57;	author kili;	state dead;
branches;
next	1.1;
commitid	wrrXExsbhXWvHmhw;

1.1
date	2014.11.22.20.23.23;	author kili;	state Exp;
branches;
next	;
commitid	f8HFLM9LK5anF9Xl;


desc
@@


1.2
log
@Update to ghc-7.10.2.

Updates to all hs-* ports related to meta/haskell-platform will
follow soon. Other hs-* ports will be fixed during the next days.
@
text
@$OpenBSD: patch-utils_deriveConstants_DeriveConstants_hs,v 1.1 2014/11/22 20:23:23 kili Exp $

Our nm(1) doesn't have -P and doesn't print sizes, so use objdump(1) instead
and adjust the "parser".

And just after few hours after fixing it this way, I noticed this one:

http://ghc.haskell.org/trac/ghc/changeset/2cc206505d248ac8c706aa85342a895857c9f091/ghc

So this patch can be removed for the next ghc release (8.0?).

--- utils/deriveConstants/DeriveConstants.hs.orig	Thu Jul 10 06:27:17 2014
+++ utils/deriveConstants/DeriveConstants.hs	Mon Nov  3 16:48:29 2014
@@@@ -638,7 +638,7 @@@@ getWanted verbose tmpdir gccProgram gccFlags nmProgram
              oFile = tmpdir </> "tmp.o"
          writeFile cFile cStuff
          execute verbose gccProgram (gccFlags ++ ["-c", cFile, "-o", oFile])
-         xs <- readProcess nmProgram ["-P", oFile] ""
+         xs <- readProcess "objdump" ["-t", oFile] ""
          let ls = lines xs
              ms = map parseNmLine ls
              m = Map.fromList $ catMaybes ms
@@@@ -715,9 +715,7 @@@@ getWanted verbose tmpdir gccProgram gccFlags nmProgram
           -- and returns ("MAX_Vanilla_REG", 11)
           parseNmLine line
               = case words line of
-                ('_' : n) : "C" : s : _ -> mkP n s
-                n : "C" : s : _ -> mkP n s
-                [n, "D", _, s] -> mkP n s
+		[s, _, "*COM*", _, n] -> mkP n s
                 _ -> Nothing
               where mkP r s = case (stripPrefix prefix r, readHex s) of
                         (Just name, [(size, "")]) -> Just (name, size)
@


1.1
log
@Update to ghc-7.8.3, but mark as broken until all other
hs ports are done.

Please note that it still doesn't use shared libraries, so
still no ghci (and a lot of hs-ports not buildable) on i386.
@
text
@d1 1
a1 1
$OpenBSD$
@

