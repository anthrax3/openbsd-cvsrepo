head	1.21;
access;
symbols
	OPENBSD_6_1:1.19.0.2
	OPENBSD_6_1_BASE:1.19
	OPENBSD_6_0:1.15.0.2
	OPENBSD_6_0_BASE:1.15
	OPENBSD_5_9:1.9.0.2
	OPENBSD_5_9_BASE:1.9
	OPENBSD_5_8:1.5.0.4
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.2.0.2
	OPENBSD_5_7_BASE:1.2
	jeremy_2015-Jan-08:1.1.1.1
	jeremy:1.1.1;
locks; strict;
comment	@# @;


1.21
date	2017.09.02.21.29.47;	author jeremy;	state Exp;
branches;
next	1.20;
commitid	nbZcnMDxD6pXrz3p;

1.20
date	2017.04.04.21.40.01;	author jeremy;	state Exp;
branches;
next	1.19;
commitid	FD60lL5nGCuBco6Q;

1.19
date	2016.11.19.04.55.26;	author jeremy;	state Exp;
branches
	1.19.2.1;
next	1.18;
commitid	LMDfZanBilCHYFfp;

1.18
date	2016.11.04.17.03.29;	author jeremy;	state Exp;
branches;
next	1.17;
commitid	6NEB0BJfBliJTo3p;

1.17
date	2016.09.01.14.23.58;	author jeremy;	state Exp;
branches;
next	1.16;
commitid	lxH8rPq0pLJAEECJ;

1.16
date	2016.08.19.19.09.34;	author jeremy;	state Exp;
branches;
next	1.15;
commitid	9VhI2kMdFGNKcRa8;

1.15
date	2016.07.15.15.53.05;	author jeremy;	state Exp;
branches;
next	1.14;
commitid	J7Wr9v5DZaPhA8g4;

1.14
date	2016.07.15.15.39.04;	author jeremy;	state Exp;
branches;
next	1.13;
commitid	fY3F87G0mPqpIT2h;

1.13
date	2016.06.29.16.14.43;	author espie;	state Exp;
branches;
next	1.12;
commitid	c1yQMbJbfo0CFBcL;

1.12
date	2016.04.30.14.18.12;	author jeremy;	state Exp;
branches;
next	1.11;
commitid	8LoO8IXmUVJWg1vG;

1.11
date	2016.03.30.16.47.34;	author visa;	state Exp;
branches;
next	1.10;
commitid	2FcdrAHQRh1KQhqd;

1.10
date	2016.02.29.20.46.54;	author jeremy;	state Exp;
branches;
next	1.9;
commitid	JkjyEbujZnqp0jTC;

1.9
date	2016.01.06.11.40.45;	author sebastia;	state Exp;
branches;
next	1.8;
commitid	7YCXsceVukfATHwK;

1.8
date	2015.12.18.17.40.07;	author jeremy;	state Exp;
branches;
next	1.7;
commitid	4dUY1Tq1cqjzgcqH;

1.7
date	2015.12.04.20.47.53;	author landry;	state Exp;
branches;
next	1.6;
commitid	gYqs83JS5RzGVA58;

1.6
date	2015.08.22.15.14.14;	author jeremy;	state Exp;
branches;
next	1.5;
commitid	uVb6fXkCH3PI6iVP;

1.5
date	2015.06.29.18.55.03;	author jeremy;	state Exp;
branches
	1.5.4.1;
next	1.4;
commitid	ZSu9FOSGfcImiO4D;

1.4
date	2015.04.15.22.00.04;	author jeremy;	state Exp;
branches;
next	1.3;
commitid	8NIeC1zokM7Id3Ip;

1.3
date	2015.03.16.19.39.05;	author jeremy;	state Exp;
branches;
next	1.2;
commitid	ulhQXS281CHzfrsq;

1.2
date	2015.02.17.17.18.22;	author jeremy;	state Exp;
branches
	1.2.2.1;
next	1.1;
commitid	RiT8cvXYtnMPpiW2;

1.1
date	2015.01.08.18.48.32;	author jeremy;	state Exp;
branches
	1.1.1.1;
next	;
commitid	opNkm6hTD3TreH0k;

1.1.1.1
date	2015.01.08.18.48.32;	author jeremy;	state Exp;
branches;
next	;
commitid	opNkm6hTD3TreH0k;

1.2.2.1
date	2015.04.21.10.32.42;	author jasper;	state Exp;
branches;
next	1.2.2.2;
commitid	lReEEhWci49O9H8q;

1.2.2.2
date	2015.06.30.07.51.31;	author jasper;	state Exp;
branches;
next	;
commitid	RxUuSElzM4b0qJqT;

1.5.4.1
date	2015.12.24.11.31.46;	author jasper;	state Exp;
branches;
next	;
commitid	MZfkCGZCy847Oy4o;

1.19.2.1
date	2017.09.07.17.32.16;	author jeremy;	state Exp;
branches;
next	;
commitid	WOLiaeVZCRxLaBqU;


desc
@@


1.21
log
@Apply security patches provided by ruby-core to fix security issues
in rubygems for versions still supported upstream (2.2, 2.3, and 2.4).

No CVE numbers, but this fixes the following vulnerabilities:

* Fix a DNS request hijacking vulnerability.
* Fix an ANSI escape sequence vulnerability.
* Fix a DOS vulernerability in the query command.
* Fix a vulnerability in the gem installer that allowed a malicious
  gem to overwrite arbitrary files.
@
text
@# $OpenBSD: Makefile,v 1.20 2017/04/04 21:40:01 jeremy Exp $

COMMENT-main =		object oriented script language with threads
COMMENT-gdbm =		gdbm interface for ruby
COMMENT-tk =		tk interface for ruby
COMMENT-ri_docs =	ri documentation files for ruby

VERSION =		2.2.7
RUBYLIBREV =		2.2
DISTNAME =		ruby-${VERSION}

SHARED_LIBS =		ruby22	1.3
PKGNAME-main =		ruby-${VERSION}
PKGNAME-gdbm =		ruby22-gdbm-${VERSION}
PKGNAME-tk =		ruby22-tk-${VERSION}
PKGNAME-ri_docs =	ruby22-ri_docs-${VERSION}

PKG_ARCH-ri_docs =	*
WANTLIB-ri_docs =	# empty

PATCHFILES =		6690/rubygems-2613-ruby22.patch:0

MASTER_SITES0 =		https://bugs.ruby-lang.org/attachments/download/

REVISION-main =		0

NEXTVER =		2.3
PKGSPEC-main =		ruby->=${RUBYLIBREV},<${NEXTVER}

CONFIGURE_ARGS =	--program-suffix=22 \
			--with-soname=ruby22 \
			--with-ruby-version=minor \
			--with-mantype=doc \
			--enable-pthread \
			--enable-ipv6 \
			--without-bundled-libffi \
			--disable-option-checking

CONFIGURE_ENV =		LIBruby22_VERSION=${LIBruby22_VERSION} \
			ac_cv_prog_DOXYGEN="" \
			ac_cv_prog_DOT="" \
			DLDFLAGS="-L${LOCALBASE}/lib"

MAKE_ENV =		DLDFLAGS="-I${LOCALBASE}/lib"

ALL_TARGET =		V=1 main
INSTALL_TARGET =	V=1 install-nodoc

WANTLIB-main =		c crypto ffi gmp m ncurses pthread readline ssl \
			util yaml z
LIB_DEPENDS-main =	devel/gmp \
			devel/libyaml \
			devel/libffi

PSEUDO_FLAVORS=		no_tk no_ri_docs bootstrap
# Do not build the RI docs on slow arches
.if ${MACHINE_ARCH:Malpha} || ${MACHINE_ARCH:Marm} || ${MACHINE_ARCH:Mhppa}
FLAVOR?=		no_ri_docs bootstrap
.else
FLAVOR?=
.endif

MULTI_PACKAGES =	-main -gdbm -tk -ri_docs
.include <bsd.port.arch.mk>

WANTLIB-gdbm =		c m gdbm gmp pthread ruby22
LIB_DEPENDS-gdbm =	databases/gdbm \
			devel/gmp \
			lang/ruby/${REV},-main>=${VERSION},<${NEXTVER}
RUN_DEPENDS-gdbm =

.if ${BUILD_PACKAGES:M-tk}
CONFIGURE_ARGS+=	--with-tcl-include=${LOCALBASE}/include/tcl8.5 \
			--with-tk-include=${LOCALBASE}/include/tk8.5 \
			--with-tcllib=tcl85 \
			--with-tklib=tk85 \
			--with-X11-dir=${X11BASE}
WANTLIB-tk =		X11 c gmp m pthread ruby22 tcl85 tk85
LIB_DEPENDS-tk =	tk->=8.5,<8.6:x11/tk/8.5 \
			devel/gmp \
			lang/ruby/${REV},-main>=${VERSION},<${NEXTVER}
RUN_DEPENDS-tk =
.endif

.if ${BUILD_PACKAGES:M-ri_docs}
ALL_TARGET +=		rdoc
INSTALL_TARGET +=	install-doc
.endif

SUBST_VARS +=		RUBYLIBREV

TEST_DEPENDS =		${FULLPKGNAME-main}:${BUILD_PKGPATH}

post-extract:
	rm -rf ${WRKSRC}/ext/fiddle/libffi-*

pre-install:
	find ${WRKSRC} -name '*.orig' -print0 | xargs -0r rm
	${INSTALL_DATA_DIR} ${PREFIX}/share/doc/ruby \
		${PREFIX}/lib/ruby/gems/${RUBYLIBREV}/extensions/${SUB} \
		${PREFIX}/lib/ruby/gems/${RUBYLIBREV}/extensions/${SUB}/${RUBYLIBREV}

post-install:
	${FIX_RBCONFIG}

do-test:
	-cd ${WRKSRC} && make test-sample
	-cd ${WRKSRC} && make btest-ruby
	cd ${WRKSRC} && make test-all TESTOPTS="-v -q -x test/ruby/test_io.rb \
		-x test/net/http/test_http.rb"

.include <bsd.port.mk>
@


1.20
log
@Update to ruby 2.2.7
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.19 2016/11/19 04:55:26 jeremy Exp $
d20 6
@


1.19
log
@Update to ruby 2.2.6

Bump minor due to new exported function.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.18 2016/11/04 17:03:29 jeremy Exp $
d8 1
a8 1
VERSION =		2.2.6
d12 1
a12 1
SHARED_LIBS =		ruby22	1.2
@


1.19.2.1
log
@Apply rubygems 2.6.13 security patches from upstream
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.19 2016/11/19 04:55:26 jeremy Exp $
a19 6

PATCHFILES =		6690/rubygems-2613-ruby22.patch:0

MASTER_SITES0 =		https://bugs.ruby-lang.org/attachments/download/

REVISION-main =		0
@


1.18
log
@Add a couple directories to the PLIST

These directories are needed to that installing a ruby gem ext port and
then remove the ruby package doesn't leave directories around. This is
only a partial fix, the ruby gem ext ports all need a similar fix.

Problem pointed out by and feedback from pirofti@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.17 2016/09/01 14:23:58 jeremy Exp $
d8 1
a8 1
VERSION =		2.2.5
d12 1
a12 1
SHARED_LIBS =		ruby22	1.1
a17 1
REVISION-main =		3
@


1.17
log
@Remove references to sparc and vax
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.16 2016/08/19 19:09:34 jeremy Exp $
d18 1
a18 1
REVISION-main =		2
d94 3
a96 1
	${INSTALL_DATA_DIR} ${PREFIX}/share/doc/ruby
@


1.16
log
@Add USE_WXNEEDED to ruby, to get devel/ruby-therubyracer working

Original diff from awolk@@, OK sthen@@

Change to use USE_WXNEEDED by me
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.15 2016/07/15 15:53:05 jeremy Exp $
d52 1
a52 1
.if ${MACHINE_ARCH:Malpha} || ${MACHINE_ARCH:Marm} || ${MACHINE_ARCH:Mhppa} || ${MACHINE_ARCH:Msparc} || ${MACHINE_ARCH:Mvax}
@


1.15
log
@Fix REVISION-main bumps
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.14 2016/07/15 15:39:04 jeremy Exp $
d18 1
a18 1
REVISION-main =		1
@


1.14
log
@Use shadow versions of password functions
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.13 2016/06/29 16:14:43 espie Exp $
d18 1
a18 1
REVISION-main =		0
a20 2

REVISION-main =		0
@


1.13
log
@add is-branch to all trivial ports that exist as multiple branches.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.12 2016/04/30 14:18:12 jeremy Exp $
d21 2
@


1.12
log
@Update to ruby 2.2.5
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.11 2016/03/30 16:47:34 visa Exp $
d18 1
@


1.11
log
@Re-enable on mips64.

OK jasper@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.10 2016/02/29 20:46:54 jeremy Exp $
d8 1
a8 1
VERSION =		2.2.4
@


1.10
log
@Make dpb not try to build -ri_docs subpackages on slow arches

The previous way was bogus.  Use bsd.port.arch.mk to remove
MULTI_PACKAGES instead of having the lack of no_* FLAVOR add them.

Change the no_x11 PSUEDO_FLAVOR to no_tk, since what it does is turn
off the -tk subpackage.

Remove post-install target from Makefile.inc, and use a manually
post-install in every version.  This is necessary due to
bsd.port.arch.mk usage.

Noticed by tobiasu@@
Guidance from espie@@
@
text
@d1 1
a1 3
# $OpenBSD: Makefile,v 1.9 2016/01/06 11:40:45 sebastia Exp $

BROKEN-mips64 =		miniruby spins on rbconfig.rb
@


1.9
log
@I don't get a OOM condition building on HPPA, manually as well as when
using DPB, so remove the BROKEN marker.

Let's see how it works out for landry bulk building

OK landry@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.8 2015/12/18 17:40:07 jeremy Exp $
d51 1
a51 1
PSEUDO_FLAVORS=		no_x11 no_ri_docs
d54 1
a54 1
FLAVOR?=		no_ri_docs
d59 2
a60 1
MULTI_PACKAGES =	-main -gdbm
d68 1
a68 2
.if !${FLAVOR:Mno_x11}
MULTI_PACKAGES+=	-tk
d81 1
a81 2
.if !${FLAVOR:Mno_ri_docs}
MULTI_PACKAGES +=	-ri_docs
d96 3
@


1.8
log
@Update to ruby 2.2.4, fixing CVE-2015-7551

Bump lib minor due to added function.  Drop a couple of patches
included upstream.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.7 2015/12/04 20:47:53 landry Exp $
a3 1
BROKEN-hppa =		OOM when building ext/ripper/ripper.c
@


1.7
log
@Mark BROKEN-hppa for reliable BROKEN-ness (gcc ICEs, undefined refs to
atomics, various horrors)
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.6 2015/08/22 15:14:14 jeremy Exp $
d11 1
a11 1
VERSION =		2.2.3
d15 1
a15 1
SHARED_LIBS =		ruby22	1.0
@


1.6
log
@Update to 2.2.3
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.5 2015/06/29 18:55:03 jeremy Exp $
d4 1
@


1.5
log
@Add fixes for CVE-2015-3900 and CVE-2015-4020

OK jasper@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.4 2015/04/15 22:00:04 jeremy Exp $
d10 1
a10 1
VERSION =		2.2.2
a19 1
REVISION-main =		0
@


1.5.4.1
log
@Security fix for CVE-2015-7551
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.5 2015/06/29 18:55:03 jeremy Exp $
d20 1
a20 1
REVISION-main =		1
@


1.4
log
@Update to ruby 2.2.2

Fixes overly permissive matching of hostnames, CVE-2015-1855.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.3 2015/03/16 19:39:05 jeremy Exp $
d20 1
@


1.3
log
@Update to ruby 2.2.1

Major lib bump due to structure changes.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.2 2015/02/17 17:18:22 jeremy Exp $
d10 1
a10 1
VERSION =		2.2.1
@


1.2
log
@Add --with-mantype=doc to CONFIGURE_ARGS, to install mdoc manuals
instead of man manuals.  Fixes man rake22, which was broken before.
Remove USE_GROFF as mandoc formats the manuals properly.

While here, fix the xargs usage in pre-install to handle cases
where fake is run after being cleaned.

Issue with rake22 man page reported by naddy@@
Detailed analysis and --with-mantype=doc change from schwarze@@
xargs fix from me
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.1.1.1 2015/01/08 18:48:32 jeremy Exp $
d10 1
a10 1
VERSION =		2.2.0
d14 1
a14 1
SHARED_LIBS =		ruby22	0.0
a18 2

REVISION-main =		0
@


1.2.2.1
log
@Backport fix for regression introduced by fix for CVE-2013-4073
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.2 2015/02/17 17:18:22 jeremy Exp $
d20 1
a20 1
REVISION-main =		1
@


1.2.2.2
log
@Security fixes for CVE-2015-3900 and CVE-2015-4020

with jeremy@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.2.2.1 2015/04/21 10:32:42 jasper Exp $
d20 1
a20 1
REVISION-main =		2
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.7 2014/05/12 00:20:41 jeremy Exp $
d20 2
d31 1
a46 2
USE_GROFF =		Yes

d97 1
a97 1
	find ${WRKSRC} -name '*.orig' -print0 | xargs -0 rm
@


1.1.1.1
log
@Import ruby 2.2.0

OK jasper@@
@
text
@@
