head	1.30;
access;
symbols
	OPENBSD_6_0:1.28.0.2
	OPENBSD_6_0_BASE:1.28
	OPENBSD_5_9:1.24.0.2
	OPENBSD_5_9_BASE:1.24
	OPENBSD_5_8:1.22.0.4
	OPENBSD_5_8_BASE:1.22
	OPENBSD_5_7:1.19.0.2
	OPENBSD_5_7_BASE:1.19
	OPENBSD_5_6:1.12.0.2
	OPENBSD_5_6_BASE:1.12
	OPENBSD_5_5:1.10.0.2
	OPENBSD_5_5_BASE:1.10
	OPENBSD_5_4:1.6.0.2
	OPENBSD_5_4_BASE:1.6
	jeremy_2013-Mar-19:1.1.1.1
	jeremy:1.1.1;
locks; strict;
comment	@# @;


1.30
date	2016.09.01.14.23.58;	author jeremy;	state Exp;
branches;
next	1.29;
commitid	lxH8rPq0pLJAEECJ;

1.29
date	2016.08.19.19.09.34;	author jeremy;	state Exp;
branches;
next	1.28;
commitid	9VhI2kMdFGNKcRa8;

1.28
date	2016.07.15.15.53.05;	author jeremy;	state Exp;
branches;
next	1.27;
commitid	J7Wr9v5DZaPhA8g4;

1.27
date	2016.07.15.15.39.03;	author jeremy;	state Exp;
branches;
next	1.26;
commitid	fY3F87G0mPqpIT2h;

1.26
date	2016.06.29.16.14.42;	author espie;	state Exp;
branches;
next	1.25;
commitid	c1yQMbJbfo0CFBcL;

1.25
date	2016.02.29.20.46.53;	author jeremy;	state Exp;
branches;
next	1.24;
commitid	JkjyEbujZnqp0jTC;

1.24
date	2015.12.18.17.38.11;	author jeremy;	state Exp;
branches;
next	1.23;
commitid	neRfyWu1P86oCGGs;

1.23
date	2015.08.22.15.13.05;	author jeremy;	state Exp;
branches;
next	1.22;
commitid	a93MWQBT0jWewzfD;

1.22
date	2015.06.29.18.55.03;	author jeremy;	state Exp;
branches
	1.22.4.1;
next	1.21;
commitid	ZSu9FOSGfcImiO4D;

1.21
date	2015.04.15.21.58.59;	author jeremy;	state Exp;
branches;
next	1.20;
commitid	DCayQZiU0vfX0oNg;

1.20
date	2015.03.16.19.37.14;	author jeremy;	state Exp;
branches;
next	1.19;
commitid	WzmRvqw3LO4iQ0sx;

1.19
date	2015.02.17.17.18.21;	author jeremy;	state Exp;
branches
	1.19.2.1;
next	1.18;
commitid	RiT8cvXYtnMPpiW2;

1.18
date	2014.11.14.17.39.57;	author jeremy;	state Exp;
branches;
next	1.17;
commitid	BneUwdmdh3XZvX41;

1.17
date	2014.11.07.15.18.56;	author dcoppa;	state Exp;
branches;
next	1.16;
commitid	DecmTKF6COjtxd8D;

1.16
date	2014.11.01.04.54.43;	author jeremy;	state Exp;
branches;
next	1.15;
commitid	GqjlPDa6iBfSZ2WU;

1.15
date	2014.10.15.02.06.35;	author jeremy;	state Exp;
branches;
next	1.14;
commitid	YbqGQnpgercW6GRD;

1.14
date	2014.09.22.15.14.48;	author jeremy;	state Exp;
branches;
next	1.13;
commitid	NTZot9wonaPn80qA;

1.13
date	2014.08.22.08.15.55;	author jasper;	state Exp;
branches;
next	1.12;
commitid	3UAZKDqA84s2PrES;

1.12
date	2014.05.12.00.19.57;	author jeremy;	state Exp;
branches
	1.12.2.1;
next	1.11;

1.11
date	2014.03.11.20.08.45;	author jeremy;	state Exp;
branches;
next	1.10;

1.10
date	2014.02.12.22.41.43;	author jeremy;	state Exp;
branches
	1.10.2.1;
next	1.9;

1.9
date	2013.11.25.14.16.23;	author sthen;	state Exp;
branches;
next	1.8;

1.8
date	2013.11.24.02.25.26;	author jeremy;	state Exp;
branches;
next	1.7;

1.7
date	2013.09.04.18.15.19;	author landry;	state Exp;
branches;
next	1.6;

1.6
date	2013.07.17.15.52.55;	author jeremy;	state Exp;
branches
	1.6.2.1;
next	1.5;

1.5
date	2013.07.03.20.09.54;	author landry;	state Exp;
branches;
next	1.4;

1.4
date	2013.05.17.20.11.43;	author jeremy;	state Exp;
branches;
next	1.3;

1.3
date	2013.04.22.19.18.16;	author landry;	state Exp;
branches;
next	1.2;

1.2
date	2013.03.20.07.27.30;	author jasper;	state Exp;
branches;
next	1.1;

1.1
date	2013.03.19.23.38.23;	author jeremy;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2013.03.19.23.38.23;	author jeremy;	state Exp;
branches;
next	;

1.6.2.1
date	2013.11.26.13.49.05;	author jasper;	state Exp;
branches;
next	;

1.10.2.1
date	2014.11.17.10.21.49;	author jasper;	state Exp;
branches;
next	;
commitid	pGV5LpHnyFLnV1OJ;

1.12.2.1
date	2014.11.17.10.15.29;	author jasper;	state Exp;
branches;
next	1.12.2.2;
commitid	ZLz9L4D7WtOtgDkN;

1.12.2.2
date	2015.04.16.18.48.53;	author jeremy;	state Exp;
branches;
next	;
commitid	SvtHb7S3fP5jbSUW;

1.19.2.1
date	2015.04.21.10.32.42;	author jasper;	state Exp;
branches;
next	1.19.2.2;
commitid	lReEEhWci49O9H8q;

1.19.2.2
date	2015.06.30.07.51.30;	author jasper;	state Exp;
branches;
next	;
commitid	RxUuSElzM4b0qJqT;

1.22.4.1
date	2015.12.24.10.53.23;	author jasper;	state Exp;
branches;
next	;
commitid	UB2DgCtbDMExc6eQ;


desc
@@


1.30
log
@Remove references to sparc and vax
@
text
@# $OpenBSD: Makefile,v 1.29 2016/08/19 19:09:34 jeremy Exp $

COMMENT-main =		object oriented script language with threads
COMMENT-gdbm =		gdbm interface for ruby
COMMENT-tk =		tk interface for ruby
COMMENT-ri_docs =	ri documentation files for ruby

VERSION =		2.0.0
PATCHLEVEL =		648
RUBYLIBREV =		2.0
DISTNAME =		ruby-${VERSION}-p${PATCHLEVEL}

SHARED_LIBS =		ruby20	1.1
PKGNAME-main =		ruby-${VERSION}.${PATCHLEVEL}
PKGNAME-gdbm =		ruby20-gdbm-${VERSION}.${PATCHLEVEL}
PKGNAME-tk =		ruby20-tk-${VERSION}.${PATCHLEVEL}
PKGNAME-ri_docs =	ruby20-ri_docs-${VERSION}.${PATCHLEVEL}

REVISION-main =		2
PKG_ARCH-ri_docs =	*
WANTLIB-ri_docs =	# empty

PKGSPEC-main =		ruby->=2.0,<2.1

BUILD_DEPENDS =		shells/bash

CONFIGURE_ARGS =	--program-suffix=20 \
			--with-soname=ruby20 \
			--with-ruby-version=minor \
			--with-mantype=doc \
			--enable-pthread \
			--enable-ipv6 \
			--disable-option-checking

CONFIGURE_ENV =		LIBruby20_VERSION=${LIBruby20_VERSION} \
			ac_cv_prog_DOXYGEN="" \
			ac_cv_prog_DOT=""

CONFIGURE_SCRIPT =	${LOCALBASE}/bin/bash ./configure

ALL_TARGET =		V=1 main
INSTALL_TARGET =	V=1 install-nodoc

WANTLIB-main =		c crypto ffi m ncurses ncursesw pthread readline ssl \
			termcap util yaml z
LIB_DEPENDS-main =	devel/libyaml \
			devel/libffi

PSEUDO_FLAVORS=		no_tk no_ri_docs bootstrap
# Do not build the RI docs on slow arches
.if ${MACHINE_ARCH:Marm} || ${MACHINE_ARCH:Malpha} || ${MACHINE_ARCH:Mhppa}
FLAVOR?=		no_ri_docs bootstrap
.else
FLAVOR?=
.endif

MULTI_PACKAGES =	-main -gdbm -tk -ri_docs
.include <bsd.port.arch.mk>

WANTLIB-gdbm =		c m gdbm pthread ruby20
LIB_DEPENDS-gdbm =	databases/gdbm \
			lang/ruby/${REV},-main>=${VERSION}.${PATCHLEVEL},<2.1
RUN_DEPENDS-gdbm =

.if ${BUILD_PACKAGES:M-tk}
CONFIGURE_ARGS+=	--with-tcl-include=${PREFIX}/include/tcl8.5 \
			--with-tk-include=${PREFIX}/include/tk8.5 \
			--with-tcllib=tcl85 \
			--with-tklib=tk85 \
			--with-X11-dir=${X11BASE}
WANTLIB-tk =		X11 c m pthread ruby20 tcl85 tk85
LIB_DEPENDS-tk =	tk->=8.5,<8.6:x11/tk/8.5 \
			lang/ruby/${REV},-main>=${VERSION}.${PATCHLEVEL},<2.1
RUN_DEPENDS-tk =
.endif

.if ${BUILD_PACKAGES:M-ri_docs}
ALL_TARGET +=		rdoc
INSTALL_TARGET +=	install-doc
.endif

SUBST_VARS +=		RUBYLIBREV

TEST_DEPENDS =		${FULLPKGNAME-main}:${BUILD_PKGPATH}

pre-install:
	find ${WRKSRC} -name '*.orig' -print0 | xargs -0r rm
	${INSTALL_DATA_DIR} ${PREFIX}/share/doc/ruby

post-install:
	${FIX_RBCONFIG}

do-test:
	-cd ${WRKSRC} && make test-sample
	-cd ${WRKSRC} && make btest-ruby
	cd ${WRKSRC} && make test-all TESTOPTS="-v -q -x test/ruby/test_io.rb -x test/net/http/test_http.rb"

.include <bsd.port.mk>
@


1.29
log
@Add USE_WXNEEDED to ruby, to get devel/ruby-therubyracer working

Original diff from awolk@@, OK sthen@@

Change to use USE_WXNEEDED by me
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.28 2016/07/15 15:53:05 jeremy Exp $
d51 1
a51 2
.if ${MACHINE_ARCH:Marm} || ${MACHINE_ARCH:Msparc} || ${MACHINE_ARCH:Mvax} || \
	${MACHINE_ARCH:Malpha} || ${MACHINE_ARCH:Mhppa}
@


1.28
log
@Fix REVISION-main bumps
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.27 2016/07/15 15:39:03 jeremy Exp $
d19 1
a19 1
REVISION-main =		1
@


1.27
log
@Use shadow versions of password functions
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.26 2016/06/29 16:14:42 espie Exp $
d19 1
a19 1
REVISION-main =		0
a21 2

REVISION-main =		0
@


1.26
log
@add is-branch to all trivial ports that exist as multiple branches.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.25 2016/02/29 20:46:53 jeremy Exp $
d22 2
@


1.25
log
@Make dpb not try to build -ri_docs subpackages on slow arches

The previous way was bogus.  Use bsd.port.arch.mk to remove
MULTI_PACKAGES instead of having the lack of no_* FLAVOR add them.

Change the no_x11 PSUEDO_FLAVOR to no_tk, since what it does is turn
off the -tk subpackage.

Remove post-install target from Makefile.inc, and use a manually
post-install in every version.  This is necessary due to
bsd.port.arch.mk usage.

Noticed by tobiasu@@
Guidance from espie@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.24 2015/12/18 17:38:11 jeremy Exp $
d19 1
@


1.24
log
@Update to ruby 2.0.0-p648, fixing CVE-2015-7551
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.23 2015/08/22 15:13:05 jeremy Exp $
d48 1
a48 1
PSEUDO_FLAVORS=		no_x11 no_ri_docs
d52 1
a52 1
FLAVOR?=		no_ri_docs
d57 2
a58 1
MULTI_PACKAGES =	-main -gdbm
d65 1
a65 2
.if !${FLAVOR:Mno_x11}
MULTI_PACKAGES+=	-tk
d77 1
a77 2
.if !${FLAVOR:Mno_ri_docs}
MULTI_PACKAGES +=	-ri_docs
d89 3
@


1.23
log
@Update to 2.0.0-p647
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.22 2015/06/29 18:55:03 jeremy Exp $
d9 1
a9 1
PATCHLEVEL =		647
@


1.22
log
@Add fixes for CVE-2015-3900 and CVE-2015-4020

OK jasper@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.21 2015/04/15 21:58:59 jeremy Exp $
d9 1
a9 1
PATCHLEVEL =		645
a18 1
REVISION-main =		0
@


1.22.4.1
log
@Security update to ruby-2.0.0-p648
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.22 2015/06/29 18:55:03 jeremy Exp $
d9 1
a9 1
PATCHLEVEL =		648
d19 1
@


1.21
log
@Update to ruby 2.0.0-p645

Fixes overly permissive matching of hostnames, CVE-2015-1855.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.20 2015/03/16 19:37:14 jeremy Exp $
d19 1
@


1.20
log
@Update to ruby 2.0.0-p643

Minor lib bump due to added functions.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.19 2015/02/17 17:18:21 jeremy Exp $
d9 1
a9 1
PATCHLEVEL =		643
@


1.19
log
@Add --with-mantype=doc to CONFIGURE_ARGS, to install mdoc manuals
instead of man manuals.  Fixes man rake22, which was broken before.
Remove USE_GROFF as mandoc formats the manuals properly.

While here, fix the xargs usage in pre-install to handle cases
where fake is run after being cleaned.

Issue with rake22 man page reported by naddy@@
Detailed analysis and --with-mantype=doc change from schwarze@@
xargs fix from me
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.18 2014/11/14 17:39:57 jeremy Exp $
d9 1
a9 1
PATCHLEVEL =		598
d13 1
a13 1
SHARED_LIBS =		ruby20	1.0
a17 2

REVISION-main =		1
@


1.19.2.1
log
@Backport fix for regression introduced by fix for CVE-2013-4073
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.19 2015/02/17 17:18:21 jeremy Exp $
d19 1
a19 1
REVISION-main =		2
@


1.19.2.2
log
@Security fixes for CVE-2015-3900 and CVE-2015-4020

with jeremy@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.19.2.1 2015/04/21 10:32:42 jasper Exp $
d19 1
a19 1
REVISION-main =		3
@


1.18
log
@Update to ruby 2.0.0-p598, fixing CVE-2014-8090

Remove patch accepted upstream.

OK jasper@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.17 2014/11/07 15:18:56 dcoppa Exp $
d19 1
a19 1
REVISION-main =		0
d31 1
a44 2
USE_GROFF =		Yes

d90 1
a90 1
	find ${WRKSRC} -name '*.orig' -print0 | xargs -0 rm
@


1.17
log
@
Use MAKE or make from ENV to override rbconfig's make.

Backported from 2.1: https://github.com/rubygems/rubygems/commit/f2bad74dda8d8e463a092905f29c943c962d5e68

ok landry@@, jeremy@@ (maintainer)
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.16 2014/11/01 04:54:43 jeremy Exp $
d9 1
a9 1
PATCHLEVEL =		594
@


1.16
log
@Update to ruby 2.0.0-p594

Bump lib major due to struct change.

Backport a fix to fix an error introduced when backporting a fix.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.15 2014/10/15 02:06:35 jeremy Exp $
d18 2
@


1.15
log
@Allow gem install to work for gems with C extensions.  As a bonus,
remove the need to use FAKE_AS_ROOT = always-wrap.

landry@@ phessler@@ naddy@@ in favor
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.14 2014/09/22 15:14:48 jeremy Exp $
d9 1
a9 1
PATCHLEVEL =		576
d13 1
a13 1
SHARED_LIBS =		ruby20	0.1
a17 1
REVISION-main =		0
@


1.14
log
@Update to ruby 2.0.0p576.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.13 2014/08/22 08:15:55 jasper Exp $
d18 1
a90 2

post-install:
@


1.13
log
@add alpha/hppa to list of arches for no_ri_docs instead of marking it
broken. sebastia@@ confirms ruby works good enough for puppet on these arches.
the underlying problem in miniruby still needs to be addressed though.

ok jeremy@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.12 2014/05/12 00:19:57 jeremy Exp $
d9 1
a9 1
PATCHLEVEL =		481
@


1.12
log
@Update to ruby 2.0.0-p481.

OK gsoares@@
@
text
@d1 1
a1 4
# $OpenBSD: Makefile,v 1.11 2014/03/11 20:08:45 jeremy Exp $

BROKEN-hppa =		miniruby abort trap when generating rdoc
BROKEN-alpha =		miniruby abort trap when generating rdoc
d51 2
a52 1
.if ${MACHINE_ARCH:Marm} || ${MACHINE_ARCH:Msparc} || ${MACHINE_ARCH:Mvax}
d63 1
a63 1
RUN_DEPENDS-gdbm =	
d75 1
a75 1
RUN_DEPENDS-tk =	
d89 1
a89 1
	find ${WRKSRC} -name '*.orig' -print0 | xargs -0 rm 
@


1.12.2.1
log
@security fix for CVE-2014-8090

committing on behalf of jeremy@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.12 2014/05/12 00:19:57 jeremy Exp $
a20 1
REVISION-main =		0
@


1.12.2.2
log
@Add patch to fix overly permissive matching of hostnames, CVE-2015-1855.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.12.2.1 2014/11/17 10:15:29 jasper Exp $
d21 1
a21 1
REVISION-main =		1
@


1.11
log
@Update to ruby 2.0.0-p451
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.10 2014/02/12 22:41:43 jeremy Exp $
d12 1
a12 1
PATCHLEVEL =		451
@


1.10
log
@Unbreak ruby 1.9+ on sparc64 by disabling the peephole optimizer, which
was the cause of the previous occassional segfaults.

Thanks to landry@@ for access to a sparc64 box

OK landry@@, sthen@@, naddy@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.9 2013/11/25 14:16:23 sthen Exp $
d12 1
a12 1
PATCHLEVEL =		353
d71 2
@


1.10.2.1
log
@security fix for CVE-2014-8090

committing on behalf of jeremy@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.10 2014/02/12 22:41:43 jeremy Exp $
a20 1
REVISION-main =		0
@


1.9
log
@kill VMEM_WARNING
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.8 2013/11/24 02:25:26 jeremy Exp $
a2 1
BROKEN-sparc64	=	segfaults during build
@


1.8
log
@Update to ruby 2.0.0p353, fixing heap overflow in floating point parser
(CVE-2013-4164).
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.7 2013/09/04 18:15:19 landry Exp $
a82 1
VMEM_WARNING =		Yes
@


1.7
log
@Mark as BROKEN-alpha: miniruby abort trap when generating rdoc
(it never actually built/packaged)
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.6 2013/07/17 15:52:55 jeremy Exp $
d13 1
a13 1
PATCHLEVEL =		247
@


1.6
log
@Update to ruby 2.0.0-p247, fixing CVE-2013-4073, with extra patches
backported to fix a regression and restore a function that would
have caused a major bump of libruby20.so. Bumping the minor of
libruby20.so due to added functions.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.5 2013/07/03 20:09:54 landry Exp $
d5 1
@


1.6.2.1
log
@backport security fix for CVE-2013-4164

ok sthen@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.6 2013/07/17 15:52:55 jeremy Exp $
a20 2

REVISION-main =		0
@


1.5
log
@Mark as BROKEN-hppa, reliably aborts trap when generating rdoc documentation
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.4 2013/05/17 20:11:43 jeremy Exp $
d12 1
a12 1
PATCHLEVEL =		195
d16 1
a16 1
SHARED_LIBS =		ruby20	0.0
@


1.4
log
@Update to ruby 2.0.0-p195, with a security fix for CVE-2013-2065
and other significant bugfixes for new features introduced in
ruby 2.0, plus some miscellaneous bugfixes.

This includes an update to the embedded rubygems, which changes
how native extension gems are built, so update the patch to
ensure --user-install continues to work as a regular user with
such gems.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.3 2013/04/22 19:18:16 landry Exp $
d4 1
@


1.3
log
@Mark as BROKEN-sparc64, segfaults during build

generating constant definitions
../.././ext/socket/mkconstants.rb: [BUG] Segmentation fault
*** Signal SIGABRT in ext/socket
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.2 2013/03/20 07:27:30 jasper Exp $
d11 1
a11 1
PATCHLEVEL =		0
@


1.2
log
@Fixup two REGRESS -> TEST.
@
text
@d1 3
a3 1
# $OpenBSD: Makefile,v 1.1.1.1 2013/03/19 23:38:23 jeremy Exp $
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.29 2012/10/24 22:49:05 jeremy Exp $
d84 1
a84 1
REGRESS_DEPENDS =	${FULLPKGNAME-main}:${BUILD_PKGPATH}
d92 1
a92 1
do-regress:
@


1.1.1.1
log
@Import ruby 2.0.0-p0.
@
text
@@
