head	1.1;
access;
symbols
	OPENBSD_5_8:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2015.12.24.11.21.09;	author jasper;	state dead;
branches
	1.1.2.1;
next	;
commitid	jqoi1yLUecUexpum;

1.1.2.1
date	2015.12.24.11.21.09;	author jasper;	state Exp;
branches;
next	;
commitid	jqoi1yLUecUexpum;


desc
@@


1.1
log
@file patch-ext_dl_handle_c was initially added on branch OPENBSD_5_8.
@
text
@@


1.1.2.1
log
@Security fix for CVE-2015-7551
@
text
@a0 29
$OpenBSD$

Backport fix for CVE-2009-5147 and CVE-2015-7551 from r23405.

--- ext/dl/handle.c.orig	Sun May  4 19:32:44 2014
+++ ext/dl/handle.c	Thu Dec 24 12:18:32 2015
@@@@ -5,6 +5,8 @@@@
 #include <ruby.h>
 #include "dl.h"
 
+#define SafeStringValuePtr(v) (rb_string_value(&v), rb_check_safe_obj(v), RSTRING_PTR(v))
+
 VALUE rb_cDLHandle;
 
 #ifdef _WIN32
@@@@ -132,11 +134,11 @@@@ rb_dlhandle_initialize(int argc, VALUE argv[], VALUE s
 	cflag = RTLD_LAZY | RTLD_GLOBAL;
 	break;
       case 1:
-	clib = NIL_P(lib) ? NULL : StringValuePtr(lib);
+	clib = NIL_P(lib) ? NULL : SafeStringValuePtr(lib);
 	cflag = RTLD_LAZY | RTLD_GLOBAL;
 	break;
       case 2:
-	clib = NIL_P(lib) ? NULL : StringValuePtr(lib);
+	clib = NIL_P(lib) ? NULL : SafeStringValuePtr(lib);
 	cflag = NUM2INT(flag);
 	break;
       default:
@

