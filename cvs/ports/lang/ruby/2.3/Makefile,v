head	1.16;
access;
symbols
	OPENBSD_6_0:1.9.0.2
	OPENBSD_6_0_BASE:1.9
	OPENBSD_5_9:1.2.0.2
	OPENBSD_5_9_BASE:1.2
	jeremy_2016-Jan-06:1.1.1.1
	jeremy:1.1.1;
locks; strict;
comment	@# @;


1.16
date	2017.02.21.16.45.36;	author jca;	state Exp;
branches;
next	1.15;
commitid	SoZ9vZkgitrVgQGM;

1.15
date	2016.12.21.07.22.20;	author phessler;	state Exp;
branches;
next	1.14;
commitid	EaNH3fNR0QzhgRON;

1.14
date	2016.11.23.15.59.32;	author jeremy;	state Exp;
branches;
next	1.13;
commitid	A8Bnnqab3ETj7lt7;

1.13
date	2016.11.19.04.56.00;	author jeremy;	state Exp;
branches;
next	1.12;
commitid	1Q8Tl2ujH8T09b3E;

1.12
date	2016.11.04.17.03.29;	author jeremy;	state Exp;
branches;
next	1.11;
commitid	6NEB0BJfBliJTo3p;

1.11
date	2016.09.01.10.53.27;	author jasper;	state Exp;
branches;
next	1.10;
commitid	LdsIxWmxagN2Kq33;

1.10
date	2016.08.19.19.09.34;	author jeremy;	state Exp;
branches;
next	1.9;
commitid	9VhI2kMdFGNKcRa8;

1.9
date	2016.07.15.15.53.05;	author jeremy;	state Exp;
branches;
next	1.8;
commitid	J7Wr9v5DZaPhA8g4;

1.8
date	2016.07.15.15.39.04;	author jeremy;	state Exp;
branches;
next	1.7;
commitid	fY3F87G0mPqpIT2h;

1.7
date	2016.06.29.16.14.43;	author espie;	state Exp;
branches;
next	1.6;
commitid	c1yQMbJbfo0CFBcL;

1.6
date	2016.04.30.14.19.00;	author jeremy;	state Exp;
branches;
next	1.5;
commitid	0n3u7sIp8LwvFVGa;

1.5
date	2016.03.30.16.47.34;	author visa;	state Exp;
branches;
next	1.4;
commitid	2FcdrAHQRh1KQhqd;

1.4
date	2016.03.05.10.42.13;	author landry;	state Exp;
branches;
next	1.3;
commitid	c18AGrb2BilWP5J8;

1.3
date	2016.02.29.20.46.54;	author jeremy;	state Exp;
branches;
next	1.2;
commitid	JkjyEbujZnqp0jTC;

1.2
date	2016.02.15.12.09.03;	author tobiasu;	state Exp;
branches;
next	1.1;
commitid	50f3N6DQuCDI62Cm;

1.1
date	2016.01.07.00.52.46;	author jeremy;	state Exp;
branches
	1.1.1.1;
next	;
commitid	Kgj8JZfwjLpedidi;

1.1.1.1
date	2016.01.07.00.52.46;	author jeremy;	state Exp;
branches;
next	;
commitid	Kgj8JZfwjLpedidi;


desc
@@


1.16
log
@Workaround for ram-constrained archs: build ext/ripper/ripper.c with -O1

ok phessler@@ jeremy@@ (maintainer)
@
text
@# $OpenBSD: Makefile,v 1.15 2016/12/21 07:22:20 phessler Exp $

COMMENT-main =		object oriented script language with threads
COMMENT-gdbm =		gdbm interface for ruby
COMMENT-tk =		tk interface for ruby
COMMENT-ri_docs =	ri documentation files for ruby

VERSION =		2.3.3
RUBYLIBREV =		2.3
DISTNAME =		ruby-${VERSION}

SHARED_LIBS =		ruby23	0.1
PKGNAME-main =		ruby-${VERSION}
PKGNAME-gdbm =		ruby23-gdbm-${VERSION}
PKGNAME-tk =		ruby23-tk-${VERSION}
PKGNAME-ri_docs =	ruby23-ri_docs-${VERSION}

PKG_ARCH-ri_docs =	*
WANTLIB-ri_docs =	# empty

NEXTVER =		2.4
PKGSPEC-main =		ruby->=${RUBYLIBREV},<${NEXTVER}

CONFIGURE_ARGS =	--program-suffix=23 \
			--with-soname=ruby23 \
			--with-ruby-version=minor \
			--with-mantype=doc \
			--enable-pthread \
			--enable-ipv6 \
			--without-bundled-libffi \
			--disable-option-checking

CONFIGURE_ENV =		LIBruby23_VERSION=${LIBruby23_VERSION} \
			ac_cv_prog_DOXYGEN="" \
			ac_cv_prog_DOT="" \
			DLDFLAGS="-L${LOCALBASE}/lib"

MAKE_ENV =		DLDFLAGS="-I${LOCALBASE}/lib"

ALL_TARGET =		V=1 main
INSTALL_TARGET =	V=1 install-nodoc

WANTLIB-main =		c crypto ffi gmp m ncurses pthread readline ssl \
			util yaml z
LIB_DEPENDS-main =	devel/gmp \
			devel/libyaml \
			devel/libffi

PSEUDO_FLAVORS=		no_tk no_ri_docs bootstrap
# Do not build the RI docs on slow arches
.if ${MACHINE_ARCH:Malpha} || ${MACHINE_ARCH:Marm} || ${MACHINE_ARCH:Mhppa}
FLAVOR?=		no_ri_docs bootstrap
.else
FLAVOR?=
.endif

MULTI_PACKAGES =	-main -gdbm -tk -ri_docs
.include <bsd.port.arch.mk>

WANTLIB-gdbm =		c m gdbm gmp pthread ruby23
LIB_DEPENDS-gdbm =	databases/gdbm \
			devel/gmp \
			lang/ruby/${REV},-main>=${VERSION},<${NEXTVER}
RUN_DEPENDS-gdbm =

.if ${BUILD_PACKAGES:M-tk}
CONFIGURE_ARGS+=	--with-tcl-include=${LOCALBASE}/include/tcl8.5 \
			--with-tk-include=${LOCALBASE}/include/tk8.5 \
			--with-tcllib=tcl85 \
			--with-tklib=tk85 \
			--with-X11-dir=${X11BASE}
WANTLIB-tk =		X11 c gmp m pthread ruby23 tcl85 tk85
LIB_DEPENDS-tk =	tk->=8.5,<8.6:x11/tk/8.5 \
			devel/gmp \
			lang/ruby/${REV},-main>=${VERSION},<${NEXTVER}
RUN_DEPENDS-tk =
.endif

.if ${BUILD_PACKAGES:M-ri_docs}
ALL_TARGET +=		rdoc
INSTALL_TARGET +=	install-doc
.endif

SUBST_VARS +=		RUBYLIBREV

TEST_DEPENDS =		${FULLPKGNAME-main}:${BUILD_PKGPATH}

post-extract:
	rm -rf ${WRKSRC}/ext/fiddle/libffi-* ${WRKSRC}/tool/downloader.rb

# cc(1) uses too much ram to build ext/ripper/ripper.c
# XXX remove arch if vmparam.h + login.conf give more than 1024M to pbuild
.if ${MACHINE_ARCH:Malpha} || ${MACHINE_ARCH:Marm} || ${MACHINE_ARCH:Mhppa}
CFLAGS_OVERRIDE =	-O1
.endif
pre-configure:
	sed -i 's/%%CFLAGS_OVERRIDE%%/${CFLAGS_OVERRIDE}/g' \
	    ${WRKSRC}/ext/ripper/depend

pre-install:
	find ${WRKSRC} -name '*.orig' -print0 | xargs -0r rm
	${INSTALL_DATA_DIR} ${PREFIX}/share/doc/ruby \
		${PREFIX}/lib/ruby/gems/${RUBYLIBREV}/extensions/${SUB} \
		${PREFIX}/lib/ruby/gems/${RUBYLIBREV}/extensions/${SUB}/${RUBYLIBREV}

post-install:
	${FIX_RBCONFIG}
	chmod 444 ${PREFIX}/lib/ruby/gems/${RUBYLIBREV}/{cache,specifications}/*.gem*

# 16021 tests, 2256593 assertions, 3 failures, 5 errors, 127 skips
do-test:
	-cd ${WRKSRC} && make test-sample
	-cd ${WRKSRC} && make btest-ruby
	cd ${WRKSRC} && make test-all TESTOPTS="-v -q"

.include <bsd.port.mk>
@


1.15
log
@arm: OOM when building ext/ripper/ripper.c
@
text
@d1 1
a1 5
# $OpenBSD: Makefile,v 1.14 2016/11/23 15:59:32 jeremy Exp $

BROKEN-arm =		OOM when building ext/ripper/ripper.c
BROKEN-hppa =		OOM when building ext/ripper/ripper.c
BROKEN-powerpc =		OOM when building ext/ripper/ripper.c
d90 9
@


1.14
log
@Update to ruby 2.3.3
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.13 2016/11/19 04:56:00 jeremy Exp $
d3 1
@


1.13
log
@Update to ruby 2.3.2

Bump minor due to new exported function.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.12 2016/11/04 17:03:29 jeremy Exp $
d11 1
a11 1
VERSION =		2.3.2
@


1.12
log
@Add a couple directories to the PLIST

These directories are needed to that installing a ruby gem ext port and
then remove the ruby package doesn't leave directories around. This is
only a partial fix, the ruby gem ext ports all need a similar fix.

Problem pointed out by and feedback from pirofti@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.11 2016/09/01 10:53:27 jasper Exp $
d11 1
a11 1
VERSION =		2.3.1
d15 1
a15 1
SHARED_LIBS =		ruby23	0.0
a20 1
REVISION-main =		3
@


1.11
log
@retire sparc
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.10 2016/08/19 19:09:34 jeremy Exp $
d21 1
a21 1
REVISION-main =		2
d97 3
a99 1
	${INSTALL_DATA_DIR} ${PREFIX}/share/doc/ruby
d103 1
a103 1
	chmod 444 ${PREFIX}/lib/ruby/gems/*/{cache,specifications}/*.gem*
@


1.10
log
@Add USE_WXNEEDED to ruby, to get devel/ruby-therubyracer working

Original diff from awolk@@, OK sthen@@

Change to use USE_WXNEEDED by me
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.9 2016/07/15 15:53:05 jeremy Exp $
a4 1
BROKEN-sparc=		exceeds MAXDSIZ
d55 1
a55 1
.if ${MACHINE_ARCH:Malpha} || ${MACHINE_ARCH:Marm} || ${MACHINE_ARCH:Mhppa} || ${MACHINE_ARCH:Msparc} || ${MACHINE_ARCH:Mvax}
@


1.9
log
@Fix REVISION-main bumps
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.8 2016/07/15 15:39:04 jeremy Exp $
d22 1
a22 1
REVISION-main =		1
@


1.8
log
@Use shadow versions of password functions
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.7 2016/06/29 16:14:43 espie Exp $
d22 1
a22 1
REVISION-main =		0
a24 2

REVISION-main =		0
@


1.7
log
@add is-branch to all trivial ports that exist as multiple branches.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.6 2016/04/30 14:19:00 jeremy Exp $
d25 2
@


1.6
log
@Update to ruby 2.3.1
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.5 2016/03/30 16:47:34 visa Exp $
d22 1
@


1.5
log
@Re-enable on mips64.

OK jasper@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.4 2016/03/05 10:42:13 landry Exp $
d12 1
a12 1
VERSION =		2.3.0
@


1.4
log
@BROKEN-powerpc = OOM when building ext/ripper/ripper.c (like hppa)
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.3 2016/02/29 20:46:54 jeremy Exp $
a4 1
BROKEN-mips64 =		miniruby spins on rbconfig.rb
@


1.3
log
@Make dpb not try to build -ri_docs subpackages on slow arches

The previous way was bogus.  Use bsd.port.arch.mk to remove
MULTI_PACKAGES instead of having the lack of no_* FLAVOR add them.

Change the no_x11 PSUEDO_FLAVOR to no_tk, since what it does is turn
off the -tk subpackage.

Remove post-install target from Makefile.inc, and use a manually
post-install in every version.  This is necessary due to
bsd.port.arch.mk usage.

Noticed by tobiasu@@
Guidance from espie@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.2 2016/02/15 12:09:03 tobiasu Exp $
d4 1
@


1.2
log
@mark broken on sparc, needs more memory to compile than we currently allow
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.1.1.1 2016/01/07 00:52:46 jeremy Exp $
d53 1
a53 1
PSEUDO_FLAVORS=		no_x11 no_ri_docs
d56 1
a56 1
FLAVOR?=		no_ri_docs
d61 2
a62 1
MULTI_PACKAGES =	-main -gdbm
d70 1
a70 2
.if !${FLAVOR:Mno_x11}
MULTI_PACKAGES+=	-tk
d83 1
a83 2
.if !${FLAVOR:Mno_ri_docs}
MULTI_PACKAGES +=	-ri_docs
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.6 2015/08/22 15:14:14 jeremy Exp $
d3 1
d5 1
a5 1
BROKEN-hppa =		OOM when building ext/ripper/ripper.c
@


1.1.1.1
log
@Import ruby 2.3.0

OK sthen@@

@
text
@@
