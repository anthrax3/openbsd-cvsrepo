head	1.6;
access;
symbols
	OPENBSD_6_2:1.6.0.2
	OPENBSD_6_2_BASE:1.6
	OPENBSD_6_1:1.3.0.2
	OPENBSD_6_1_BASE:1.3
	jeremy_2017-Jan-06:1.1.1.1
	jeremy:1.1.1;
locks; strict;
comment	@# @;


1.6
date	2017.09.16.22.42.37;	author jeremy;	state Exp;
branches;
next	1.5;
commitid	1m1Yq6HAbP9tRxHM;

1.5
date	2017.09.02.21.29.47;	author jeremy;	state Exp;
branches;
next	1.4;
commitid	nbZcnMDxD6pXrz3p;

1.4
date	2017.04.17.18.29.11;	author jeremy;	state Exp;
branches;
next	1.3;
commitid	NyrSUo7rQM0QmN6o;

1.3
date	2017.03.24.14.39.05;	author jeremy;	state Exp;
branches
	1.3.2.1;
next	1.2;
commitid	mMBMrbbCi7vDcOIv;

1.2
date	2017.02.21.17.04.45;	author jca;	state Exp;
branches;
next	1.1;
commitid	Ae9c4tk1BbNGgSI6;

1.1
date	2017.01.06.15.59.25;	author jeremy;	state Exp;
branches
	1.1.1.1;
next	;
commitid	Bh2OSv7oca1mG9jm;

1.1.1.1
date	2017.01.06.15.59.25;	author jeremy;	state Exp;
branches;
next	;
commitid	Bh2OSv7oca1mG9jm;

1.3.2.1
date	2017.09.07.17.32.16;	author jeremy;	state Exp;
branches;
next	1.3.2.2;
commitid	WOLiaeVZCRxLaBqU;

1.3.2.2
date	2017.09.20.02.13.04;	author jeremy;	state Exp;
branches;
next	;
commitid	H1qjWBnGKY52RRqn;


desc
@@


1.6
log
@Update to ruby 2.4.2.  Fixes CVE-2017-14033, CVE-2017-14064,
CVE-2017-0898, and CVE-2017-10784. Shared lib major bump due to
removed/modified functions.  Regen patches while here.
@
text
@# $OpenBSD: Makefile,v 1.5 2017/09/02 21:29:47 jeremy Exp $

COMMENT-main =		object oriented script language with threads
COMMENT-gdbm =		gdbm interface for ruby
COMMENT-ri_docs =	ri documentation files for ruby

VERSION =		2.4.2
RUBYLIBREV =		2.4
DISTNAME =		ruby-${VERSION}

SHARED_LIBS =		ruby24	2.0
PKGNAME-main =		ruby-${VERSION}
PKGNAME-gdbm =		ruby24-gdbm-${VERSION}
PKGNAME-ri_docs =	ruby24-ri_docs-${VERSION}

PKG_ARCH-ri_docs =	*
WANTLIB-ri_docs =	# empty

NEXTVER =		2.5
PKGSPEC-main =		ruby->=${RUBYLIBREV},<${NEXTVER}

CONFIGURE_ARGS =	--program-suffix=24 \
			--with-soname=ruby24 \
			--with-ruby-version=minor \
			--with-mantype=doc \
			--enable-pthread \
			--enable-ipv6 \
			--without-bundled-libffi \
			--disable-option-checking

CONFIGURE_ENV =		LIBruby24_VERSION=${LIBruby24_VERSION} \
			ac_cv_prog_DOXYGEN="" \
			ac_cv_prog_DOT="" \
			DLDFLAGS="-L${LOCALBASE}/lib"

MAKE_ENV =		DLDFLAGS="-I${LOCALBASE}/lib"

ALL_TARGET =		V=1 main
INSTALL_TARGET =	V=1 install-nodoc

WANTLIB-main =		c crypto ffi gmp m ncurses pthread readline ssl \
			util yaml z
LIB_DEPENDS-main =	devel/gmp \
			devel/libyaml \
			devel/libffi

PSEUDO_FLAVORS=		no_ri_docs bootstrap
# Do not build the RI docs on slow arches
.if ${MACHINE_ARCH:Malpha} || ${MACHINE_ARCH:Marm} || ${MACHINE_ARCH:Mhppa}
FLAVOR?=		no_ri_docs bootstrap
.else
FLAVOR?=
.endif

MULTI_PACKAGES =	-main -gdbm -ri_docs
.include <bsd.port.arch.mk>

WANTLIB-gdbm =		c m gdbm gmp pthread ruby24
LIB_DEPENDS-gdbm =	databases/gdbm \
			devel/gmp \
			lang/ruby/${REV},-main>=${VERSION},<${NEXTVER}
RUN_DEPENDS-gdbm =

.if ${BUILD_PACKAGES:M-ri_docs}
ALL_TARGET +=		rdoc
INSTALL_TARGET +=	install-doc
.endif

SUBST_VARS +=		RUBYLIBREV

TEST_DEPENDS =		${FULLPKGNAME-main}:${BUILD_PKGPATH}

post-extract:
	rm -rf ${WRKSRC}/ext/fiddle/libffi-* ${WRKSRC}/tool/downloader.rb

# cc(1) uses too much ram to build ext/ripper/ripper.c
# XXX remove arch if vmparam.h + login.conf give more than 1024M to pbuild
.if ${MACHINE_ARCH:Malpha} || ${MACHINE_ARCH:Marm} || ${MACHINE_ARCH:Mhppa}
CFLAGS_OVERRIDE =	-O1
.endif
pre-configure:
	sed -i 's/%%CFLAGS_OVERRIDE%%/${CFLAGS_OVERRIDE}/g' \
	    ${WRKSRC}/ext/ripper/depend

pre-install:
	find ${WRKSRC} -name '*.orig' -print0 | xargs -0r rm
	${INSTALL_DATA_DIR} ${PREFIX}/share/doc/ruby \
		${PREFIX}/lib/ruby/gems/${RUBYLIBREV}/extensions/${SUB} \
		${PREFIX}/lib/ruby/gems/${RUBYLIBREV}/extensions/${SUB}/${RUBYLIBREV}

post-install:
	${FIX_RBCONFIG}

# 16984 tests, 2242211 assertions, 1 failures, 5 errors, 107 skips
do-test:
	-cd ${WRKSRC} && make test-sample
	-cd ${WRKSRC} && make btest-ruby
	cd ${WRKSRC} && make test-all TESTOPTS="-v -q"

.include <bsd.port.mk>
@


1.5
log
@Apply security patches provided by ruby-core to fix security issues
in rubygems for versions still supported upstream (2.2, 2.3, and 2.4).

No CVE numbers, but this fixes the following vulnerabilities:

* Fix a DNS request hijacking vulnerability.
* Fix an ANSI escape sequence vulnerability.
* Fix a DOS vulernerability in the query command.
* Fix a vulnerability in the gem installer that allowed a malicious
  gem to overwrite arbitrary files.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.4 2017/04/17 18:29:11 jeremy Exp $
d7 1
a7 1
VERSION =		2.4.1
d11 1
a11 1
SHARED_LIBS =		ruby24	1.0
a17 7

PATCHFILES =		6692/rubygems-2612-ruby24.patch:0 \
			6693/rubygems-2613-ruby24.patch:0

MASTER_SITES0 =		https://bugs.ruby-lang.org/attachments/download/

REVISION-main =		1
@


1.4
log
@Fix heap overflow by renaming HEAP_ALIGN_LOG to HEAP_PAGE_ALIGN_LOG in configure.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.3 2017/03/24 14:39:05 jeremy Exp $
d19 6
a24 1
REVISION-main =		0
@


1.3
log
@Update to ruby 2.4.1

Shared lib major bump due to removal of ruby_vm_sysstack_error_copy
function.  Regen patches.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.2 2017/02/21 17:04:45 jca Exp $
d18 2
@


1.3.2.1
log
@Apply rubygems 2.6.13 security patches from upstream
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.3 2017/03/24 14:39:05 jeremy Exp $
a14 7

PATCHFILES =		6692/rubygems-2612-ruby24.patch:0 \
			6693/rubygems-2613-ruby24.patch:0

MASTER_SITES0 =		https://bugs.ruby-lang.org/attachments/download/

REVISION-main =		0
@


1.3.2.2
log
@Backport security fixes for CVE-2017-10784, CVE-2017-0898, and
CVE-2017-14064 to ruby 2.4.1.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.3.2.1 2017/09/07 17:32:16 jeremy Exp $
d21 1
a21 1
REVISION-main =		1
@


1.2
log
@Workaround for ram-constrained archs: build ext/ripper/ripper.c with -O1

Same as lang/ruby/2.3.  Preventively add arm, just in case it is near
the maximum limit.
Prodded by jeremy@@ (maintainer)
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.1.1.1 2017/01/06 15:59:25 jeremy Exp $
d7 1
a7 1
VERSION =		2.4.0
d11 1
a11 1
SHARED_LIBS =		ruby24	0.0
@


1.1
log
@Initial revision
@
text
@d1 1
a1 4
# $OpenBSD: Makefile,v 1.5 2016/03/30 16:47:34 visa Exp $

BROKEN-hppa =		OOM when building ext/ripper/ripper.c
BROKEN-powerpc =	OOM when building ext/ripper/ripper.c
d75 9
@


1.1.1.1
log
@Import ruby 2.4.0

OK jasper@@
@
text
@@
