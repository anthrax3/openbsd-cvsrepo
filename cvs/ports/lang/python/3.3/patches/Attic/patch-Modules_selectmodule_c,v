head	1.4;
access;
symbols
	OPENBSD_5_4:1.3.0.2
	OPENBSD_5_4_BASE:1.3
	fgsch_20130428:1.1.1.1
	fgsch:1.1.1;
locks; strict;
comment	@# @;


1.4
date	2013.10.27.18.32.55;	author fgsch;	state dead;
branches;
next	1.3;

1.3
date	2013.05.22.12.37.05;	author fgsch;	state Exp;
branches;
next	1.2;

1.2
date	2013.05.18.04.13.16;	author fgsch;	state Exp;
branches;
next	1.1;

1.1
date	2013.04.28.01.29.57;	author fgsch;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2013.04.28.01.29.57;	author fgsch;	state Exp;
branches;
next	;


desc
@@


1.4
log
@- Merge ctypes fragment into main now that libffi is fixed
- Remove uneeded diff after the time_t change
- Clean things a bit
- Bump revisions

tested by rpointel@@, sthen@@ and myself. ok by them and jasper@@
@
text
@$OpenBSD: patch-Modules_selectmodule_c,v 1.3 2013/05/22 12:37:05 fgsch Exp $
--- Modules/selectmodule.c.orig	Sat Apr  6 08:41:54 2013
+++ Modules/selectmodule.c	Mon May 13 04:45:07 2013
@@@@ -235,11 +235,13 @@@@ select_select(PyObject *self, PyObject *args)
 #endif
         tv.tv_sec = (long)sec;
 #else
+        time_t sec;
         /* 64-bit OS X has struct timeval.tv_usec as an int (and thus still 4
            bytes as required), but no longer defined by a long. */
         long tv_usec;
-        if (_PyTime_ObjectToTimeval(tout, &tv.tv_sec, &tv_usec) == -1)
+        if (_PyTime_ObjectToTimeval(tout, &sec, &tv_usec) == -1)
             return NULL;
+        tv.tv_sec = sec;
         tv.tv_usec = tv_usec;
 #endif
         if (tv.tv_sec < 0) {
@


1.3
log
@Update to 3.3.2.
ok ajacoutot@@ as part of a larger diff.
@
text
@d1 1
a1 1
$OpenBSD: patch-Modules_selectmodule_c,v 1.2 2013/05/18 04:13:16 fgsch Exp $
@


1.2
log
@- update what tests should be skipped
- add missing dependency on archivers/xz
- temporarily fix timeval's tv_sec handling
- bump

ajacoutot@@ jasper@@ sthen@@ ok as part of a larger diff.
@
text
@d1 1
a1 4
$OpenBSD: patch-Modules_selectmodule_c,v 1.1.1.1 2013/04/28 01:29:57 fgsch Exp $

See http://bugs.python.org/issue12181 for details.

a18 75
@@@@ -1571,6 +1573,23 @@@@ static PyTypeObject kqueue_queue_Type;
 #   error uintptr_t does not match int, long, or long long!
 #endif
 
+/*
+ * kevent is not standard and its members vary across BSDs.
+ */
+#if !defined(__OpenBSD__)
+#   define IDENT_TYPE	T_UINTPTRT
+#   define IDENT_CAST	Py_intptr_t
+#   define DATA_TYPE	T_INTPTRT
+#   define DATA_FMT_UNIT INTPTRT_FMT_UNIT
+#   define IDENT_AsType	PyLong_AsUintptr_t
+#else
+#   define IDENT_TYPE	T_UINT
+#   define IDENT_CAST	int
+#   define DATA_TYPE	T_INT
+#   define DATA_FMT_UNIT "i"
+#   define IDENT_AsType	PyLong_AsUnsignedLong
+#endif
+
 /* Unfortunately, we can't store python objects in udata, because
  * kevents in the kernel can be removed without warning, which would
  * forever lose the refcount on the object stored with it.
@@@@ -1578,11 +1597,11 @@@@ static PyTypeObject kqueue_queue_Type;
 
 #define KQ_OFF(x) offsetof(kqueue_event_Object, x)
 static struct PyMemberDef kqueue_event_members[] = {
-    {"ident",           T_UINTPTRT,     KQ_OFF(e.ident)},
+    {"ident",           IDENT_TYPE,     KQ_OFF(e.ident)},
     {"filter",          T_SHORT,        KQ_OFF(e.filter)},
     {"flags",           T_USHORT,       KQ_OFF(e.flags)},
     {"fflags",          T_UINT,         KQ_OFF(e.fflags)},
-    {"data",            T_INTPTRT,      KQ_OFF(e.data)},
+    {"data",            DATA_TYPE,      KQ_OFF(e.data)},
     {"udata",           T_UINTPTRT,     KQ_OFF(e.udata)},
     {NULL} /* Sentinel */
 };
@@@@ -1608,7 +1627,7 @@@@ kqueue_event_init(kqueue_event_Object *self, PyObject 
     PyObject *pfd;
     static char *kwlist[] = {"ident", "filter", "flags", "fflags",
                              "data", "udata", NULL};
-    static char *fmt = "O|hhi" INTPTRT_FMT_UNIT UINTPTRT_FMT_UNIT ":kevent";
+    static char *fmt = "O|hhi" DATA_FMT_UNIT UINTPTRT_FMT_UNIT ":kevent";
 
     EV_SET(&(self->e), 0, EVFILT_READ, EV_ADD, 0, 0, 0); /* defaults */
 
@@@@ -1618,8 +1637,12 @@@@ kqueue_event_init(kqueue_event_Object *self, PyObject 
         return -1;
     }
 
-    if (PyLong_Check(pfd)) {
-        self->e.ident = PyLong_AsUintptr_t(pfd);
+    if (PyLong_Check(pfd)
+#if IDENT_TYPE == T_UINT
+	&& PyLong_AsUnsignedLong(pfd) < UINT_MAX
+#endif
+    ) {
+        self->e.ident = IDENT_AsType(pfd);
     }
     else {
         self->e.ident = PyObject_AsFileDescriptor(pfd);
@@@@ -1647,10 +1670,10 @@@@ kqueue_event_richcompare(kqueue_event_Object *s, kqueu
             Py_TYPE(s)->tp_name, Py_TYPE(o)->tp_name);
         return NULL;
     }
-    if (((result = s->e.ident - o->e.ident) == 0) &&
+    if (((result = (IDENT_CAST)(s->e.ident - o->e.ident)) == 0) &&
         ((result = s->e.filter - o->e.filter) == 0) &&
         ((result = s->e.flags - o->e.flags) == 0) &&
-        ((result = s->e.fflags - o->e.fflags) == 0) &&
+        ((result = (int)(s->e.fflags - o->e.fflags)) == 0) &&
         ((result = s->e.data - o->e.data) == 0) &&
         ((result = s->e.udata - o->e.udata) == 0)
        ) {
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
$OpenBSD: patch-Modules_selectmodule_c,v 1.4 2013/04/13 22:31:42 fgsch Exp $
d6 17
a22 2
+++ Modules/selectmodule.c	Mon Apr 22 18:35:57 2013
@@@@ -1571,6 +1571,23 @@@@ static PyTypeObject kqueue_queue_Type;
d46 1
a46 1
@@@@ -1578,11 +1595,11 @@@@ static PyTypeObject kqueue_queue_Type;
d60 1
a60 1
@@@@ -1608,7 +1625,7 @@@@ kqueue_event_init(kqueue_event_Object *self, PyObject 
d69 1
a69 1
@@@@ -1618,8 +1635,12 @@@@ kqueue_event_init(kqueue_event_Object *self, PyObject 
d84 1
a84 1
@@@@ -1647,10 +1668,10 @@@@ kqueue_event_richcompare(kqueue_event_Object *s, kqueu
@


1.1.1.1
log
@Import python 3.3.1. Not hooked to the tree yet.
@
text
@@
