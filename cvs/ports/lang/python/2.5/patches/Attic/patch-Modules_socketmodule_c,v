head	1.3;
access;
symbols
	OPENBSD_5_3:1.2.0.24
	OPENBSD_5_3_BASE:1.2
	OPENBSD_5_2:1.2.0.22
	OPENBSD_5_2_BASE:1.2
	OPENBSD_5_1_BASE:1.2
	OPENBSD_5_1:1.2.0.20
	OPENBSD_5_0:1.2.0.18
	OPENBSD_5_0_BASE:1.2
	OPENBSD_4_9:1.2.0.16
	OPENBSD_4_9_BASE:1.2
	OPENBSD_4_8:1.2.0.14
	OPENBSD_4_8_BASE:1.2
	OPENBSD_4_7:1.2.0.12
	OPENBSD_4_7_BASE:1.2
	OPENBSD_4_6:1.2.0.10
	OPENBSD_4_6_BASE:1.2
	OPENBSD_4_5:1.2.0.8
	OPENBSD_4_5_BASE:1.2
	OPENBSD_4_4:1.2.0.6
	OPENBSD_4_4_BASE:1.2
	OPENBSD_4_3:1.2.0.4
	OPENBSD_4_3_BASE:1.2
	OPENBSD_4_2:1.2.0.2
	OPENBSD_4_2_BASE:1.2
	OPENBSD_4_1:1.1.0.2
	OPENBSD_4_1_BASE:1.1;
locks; strict;
comment	@# @;


1.3
date	2013.06.04.08.02.20;	author fgsch;	state dead;
branches;
next	1.2;

1.2
date	2007.04.24.23.32.47;	author djm;	state Exp;
branches;
next	1.1;

1.1
date	2006.11.01.20.59.18;	author alek;	state Exp;
branches;
next	;


desc
@@


1.3
log
@GC python 2.5.  Thanks to zhuk who made this possible.
@
text
@$OpenBSD: patch-Modules_socketmodule_c,v 1.2 2007/04/24 23:32:47 djm Exp $
--- Modules/socketmodule.c.orig	Sun Apr  1 04:56:11 2007
+++ Modules/socketmodule.c	Fri Apr 20 13:29:23 2007
@@@@ -73,9 +73,6 @@@@ Local naming conventions:
 #include "Python.h"
 #include "structmember.h"
 
-#undef MAX
-#define MAX(x, y) ((x) < (y) ? (y) : (x))
-
 /* Socket object documentation */
 PyDoc_STRVAR(sock_doc,
 "socket([family[, type[, proto]]]) -> socket object\n\
@@@@ -1921,12 +1918,18 @@@@ internal_connect(PySocketSockObject *s, struct sockadd
 		if (res < 0 && errno == EINPROGRESS && IS_SELECTABLE(s)) {
 			timeout = internal_select(s, 1);
 			if (timeout == 0) {
-				res = connect(s->sock_fd, addr, addrlen);
-				if (res < 0 && errno == EISCONN)
-					res = 0;
+			  /* Bug #1019808: in case of an EINPROGRESS, use
+			     getsockopt(SO_ERROR) to get the real error. */
+			  socklen_t res_size = sizeof res;
+			  (void)getsockopt(s->sock_fd, SOL_SOCKET, SO_ERROR,
+					   &res, &res_size);
+			  if (res == EISCONN)
+			      res = 0;
+			  errno = res;
 			}
-			else if (timeout == -1)
+			else if (timeout == -1) {
 				res = errno;		/* had error */
+			}
 			else
 				res = EWOULDBLOCK;	/* timed out */
 		}
@@@@ -3602,7 +3605,7 @@@@ socket_inet_aton(PyObject *self, PyObject *args)
 
 #if !defined(HAVE_INET_ATON) || defined(USE_INET_ATON_WEAKLINK)
 	/* Have to use inet_addr() instead */
-	unsigned long packed_addr;
+	int packed_addr;
 #endif
 	char *ip_addr;
 
@


1.2
log
@python-2.5.1
@
text
@d1 1
a1 1
$OpenBSD: patch-Modules_socketmodule_c,v 1.1 2006/11/01 20:59:18 alek Exp $
@


1.1
log
@Python 2.5
@
text
@d1 3
a3 3
$OpenBSD$
--- Modules/socketmodule.c.orig	Tue Aug 15 08:10:24 2006
+++ Modules/socketmodule.c	Mon Sep 18 06:31:10 2006
d14 1
a14 1
@@@@ -1927,12 +1924,18 @@@@ internal_connect(PySocketSockObject *s, 
d37 1
a37 1
@@@@ -3602,7 +3605,7 @@@@ socket_inet_aton(PyObject *self, PyObjec
@

