head	1.1;
access;
symbols
	OPENBSD_4_6:1.1.0.4
	OPENBSD_4_5:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2009.08.16.02.21.43;	author william;	state dead;
branches
	1.1.2.1
	1.1.4.1;
next	;

1.1.2.1
date	2009.08.16.02.21.43;	author william;	state Exp;
branches;
next	;

1.1.4.1
date	2009.11.06.01.38.18;	author william;	state Exp;
branches;
next	;


desc
@@


1.1
log
@file patch-subversion_libsvn_delta_text_delta_c was initially added on branch OPENBSD_4_5.
@
text
@@


1.1.4.1
log
@SECURITY FIX

Resolves CVE-2009-2411

ok stsp@@
@
text
@a0 48
Security fix

Resolves CVE-2009-2411


$OpenBSD$
--- subversion/libsvn_delta/text_delta.c.orig	Fri Jan  9 10:21:26 2009
+++ subversion/libsvn_delta/text_delta.c	Tue Nov  3 21:28:36 2009
@@@@ -543,7 +543,7 @@@@ svn_txdelta_target_push(svn_txdelta_window_handler_t h
 /* Functions for applying deltas.  */
 
 /* Ensure that BUF has enough space for VIEW_LEN bytes.  */
-static APR_INLINE void
+static APR_INLINE svn_error_t *
 size_buffer(char **buf, apr_size_t *buf_size,
             apr_size_t view_len, apr_pool_t *pool)
 {
@@@@ -552,8 +552,11 @@@@ size_buffer(char **buf, apr_size_t *buf_size,
       *buf_size *= 2;
       if (*buf_size < view_len)
         *buf_size = view_len;
+      SVN_ERR_ASSERT(APR_ALIGN_DEFAULT(*buf_size) >= *buf_size);
       *buf = apr_palloc(pool, *buf_size);
     }
+
+  return SVN_NO_ERROR;
 }
 
 
@@@@ -654,7 +657,7 @@@@ apply_window(svn_txdelta_window_t *window, void *baton
                          >= ab->sbuf_offset + ab->sbuf_len)));
 
   /* Make sure there's enough room in the target buffer.  */
-  size_buffer(&ab->tbuf, &ab->tbuf_size, window->tview_len, ab->pool);
+  SVN_ERR(size_buffer(&ab->tbuf, &ab->tbuf_size, window->tview_len, ab->pool));
 
   /* Prepare the source buffer for reading from the input stream.  */
   if (window->sview_offset != ab->sbuf_offset
@@@@ -663,7 +666,8 @@@@ apply_window(svn_txdelta_window_t *window, void *baton
       char *old_sbuf = ab->sbuf;
 
       /* Make sure there's enough room.  */
-      size_buffer(&ab->sbuf, &ab->sbuf_size, window->sview_len, ab->pool);
+      SVN_ERR(size_buffer(&ab->sbuf, &ab->sbuf_size, window->sview_len,
+              ab->pool));
 
       /* If the existing view overlaps with the new view, copy the
        * overlap to the beginning of the new buffer.  */
@


1.1.2.1
log
@SECURITY FIX

Resolves CVE-2009-2411

from Stefan Sperling

ok robert@@
@
text
@a0 50
Security fix for CVE-2009-2411:

heap overflows in svndiff stream parsing 


$OpenBSD$
--- subversion/libsvn_delta/text_delta.c.orig	Sat Aug 25 21:04:48 2007
+++ subversion/libsvn_delta/text_delta.c	Tue Aug 11 20:39:19 2009
@@@@ -498,7 +498,7 @@@@ svn_txdelta_target_push(svn_txdelta_window_handler_t h
 /* Functions for applying deltas.  */
 
 /* Ensure that BUF has enough space for VIEW_LEN bytes.  */
-static APR_INLINE void
+static APR_INLINE svn_error_t *
 size_buffer(char **buf, apr_size_t *buf_size,
             apr_size_t view_len, apr_pool_t *pool)
 {
@@@@ -507,8 +507,13 @@@@ size_buffer(char **buf, apr_size_t *buf_size,
       *buf_size *= 2;
       if (*buf_size < view_len)
         *buf_size = view_len;
+      if (APR_ALIGN_DEFAULT(*buf_size) < *buf_size)
+        return svn_error_create(SVN_ERR_SVNDIFF_INVALID_OPS, NULL,
+                                "Diff stream resulted in invalid buffer size.");
       *buf = apr_palloc(pool, *buf_size);
     }
+
+  return SVN_NO_ERROR;
 }
 
 
@@@@ -609,7 +614,7 @@@@ apply_window(svn_txdelta_window_t *window, void *baton
                  >= ab->sbuf_offset + ab->sbuf_len)));
 
   /* Make sure there's enough room in the target buffer.  */
-  size_buffer(&ab->tbuf, &ab->tbuf_size, window->tview_len, ab->pool);
+  SVN_ERR(size_buffer(&ab->tbuf, &ab->tbuf_size, window->tview_len, ab->pool));
 
   /* Prepare the source buffer for reading from the input stream.  */
   if (window->sview_offset != ab->sbuf_offset
@@@@ -618,7 +623,8 @@@@ apply_window(svn_txdelta_window_t *window, void *baton
       char *old_sbuf = ab->sbuf;
 
       /* Make sure there's enough room.  */
-      size_buffer(&ab->sbuf, &ab->sbuf_size, window->sview_len, ab->pool);
+      SVN_ERR(size_buffer(&ab->sbuf, &ab->sbuf_size, window->sview_len,
+              ab->pool));
 
       /* If the existing view overlaps with the new view, copy the
        * overlap to the beginning of the new buffer.  */
@

