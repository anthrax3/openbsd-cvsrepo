head	1.3;
access;
symbols
	OPENBSD_5_2:1.2.0.4
	OPENBSD_5_2_BASE:1.2
	OPENBSD_5_1_BASE:1.2
	OPENBSD_5_1:1.2.0.2
	OPENBSD_5_0:1.1.0.30
	OPENBSD_5_0_BASE:1.1
	OPENBSD_4_9:1.1.0.28
	OPENBSD_4_9_BASE:1.1
	OPENBSD_4_8:1.1.0.26
	OPENBSD_4_8_BASE:1.1
	OPENBSD_4_7:1.1.0.24
	OPENBSD_4_7_BASE:1.1
	OPENBSD_4_6:1.1.0.22
	OPENBSD_4_6_BASE:1.1
	OPENBSD_4_5:1.1.0.20
	OPENBSD_4_5_BASE:1.1
	OPENBSD_4_4:1.1.0.18
	OPENBSD_4_4_BASE:1.1
	OPENBSD_4_3:1.1.0.16
	OPENBSD_4_3_BASE:1.1
	OPENBSD_4_2:1.1.0.14
	OPENBSD_4_2_BASE:1.1
	OPENBSD_4_1:1.1.0.12
	OPENBSD_4_1_BASE:1.1
	OPENBSD_4_0:1.1.0.10
	OPENBSD_4_0_BASE:1.1
	OPENBSD_3_9:1.1.0.8
	OPENBSD_3_9_BASE:1.1
	OPENBSD_3_8:1.1.0.6
	OPENBSD_3_8_BASE:1.1
	OPENBSD_3_7:1.1.0.4
	OPENBSD_3_7_BASE:1.1
	OPENBSD_3_6:1.1.0.2
	OPENBSD_3_6_BASE:1.1;
locks; strict;
comment	@# @;


1.3
date	2012.12.14.13.24.55;	author gsoares;	state dead;
branches;
next	1.2;

1.2
date	2011.10.28.22.38.15;	author okan;	state Exp;
branches;
next	1.1;

1.1
date	2004.08.28.22.54.50;	author millert;	state Exp;
branches;
next	;


desc
@@


1.3
log
@zap unneeded patch since that now we support unix98 ptys family functions; OK millert@@ jasper@@

From: RD Thrush <rd at thrush.com>, thanks!
@
text
@$OpenBSD: patch-Tty_xs,v 1.2 2011/10/28 22:38:15 okan Exp $
--- Tty.xs.orig	Mon Oct 11 14:07:57 2010
+++ Tty.xs	Tue Oct 11 23:43:40 2011
@@@@ -233,6 +233,7 @@@@ make_safe_fd(int * fd)
   }
 }
 
+#if !defined(HAVE_OPENPTY)
 /*
  * After having acquired a master pty, try to find out the slave name,
  * initialize and open the slave.
@@@@ -395,6 +396,7 @@@@ open_slave(int *ptyfd, int *ttyfd, char *namebuf, int 
 
     return 1;
 }
+#endif
 
 /*
  * Allocates and opens a pty.  Returns 0 if no pty could be allocated, or
@@@@ -450,7 +452,7 @@@@ allocate_pty(int *ptyfd, int *ttyfd, char *namebuf, in
 	}
 #endif
 
-#if defined(HAVE_PTSNAME) || defined(HAVE_PTSNAME_R)
+#if defined(HAVE_PTSNAME) || defined(HAVE_PTSNAME_R) || defined(HAVE_OPENPTY)
 /* we don't need to try these if we don't have a way to get the pty names */
 
 #if defined(HAVE_POSIX_OPENPT)
@@@@ -479,29 +481,21 @@@@ allocate_pty(int *ptyfd, int *ttyfd, char *namebuf, in
 #endif /* defined(HAVE_GETPT) */
 
 #if defined(HAVE_OPENPTY)
-	/* openpty(3) exists in a variety of OS'es, but due to it's
-	 * broken interface (no maxlen to slavename) we'll only use it
-	 * to create the tty/pty pair and rely on ptsname to get the
-	 * name.  */
-	{
-	    mysig_t old_signal;
-	    int ret;
-
+	/* openpty(3) is documented to require 16 bytes for the
+	 * slave name.  We always allocate 64 so it is safe...
+	 */
 #if PTY_DEBUG
-	    if (print_debug)
-	      fprintf(stderr, "trying openpty()...\n");
+	if (print_debug)
+	  fprintf(stderr, "trying openpty()...\n");
 #endif
-	    old_signal = mysignal(SIGCHLD, SIG_DFL);
-	    ret = openpty(ptyfd, ttyfd, NULL, NULL, NULL);
-	    mysignal(SIGCHLD, old_signal);
-	    if (ret >= 0 && *ptyfd >= 0) {
-		if (open_slave(ptyfd, ttyfd, namebuf, namebuflen))
-		    break;
-	    }
-	    *ptyfd = -1;
-	    *ttyfd = -1;
-	    if (PL_dowarn)
-		warn("pty_allocate(nonfatal): openpty(): %.100s", strerror(errno));
+	if (openpty(ptyfd, ttyfd, namebuf, NULL, NULL) == 0) {
+	    make_safe_fd(ptyfd);
+	    make_safe_fd(ttyfd);
+	    return 1;
+	} else {
+	if (PL_dowarn)
+	    warn("pty_allocate: openpty(): %.100s", strerror(errno));
+	    return 0;
 	}
 #endif /* defined(HAVE_OPENPTY) */
 
@


1.2
log
@- update to 1.10
- no need for groff
- sync patches

ok gsoares@@
@
text
@d1 1
a1 1
$OpenBSD: patch-Tty_xs,v 1.1 2004/08/28 22:54:50 millert Exp $
@


1.1
log
@Use openpty() so this works again; ok pval@@
@
text
@d1 4
a4 4
$OpenBSD$
--- Tty.xs.orig	Wed Mar  6 06:47:32 2002
+++ Tty.xs	Sat Aug 28 13:02:55 2004
@@@@ -271,6 +271,7 @@@@ make_safe_fd(int * fd)
d12 1
a12 1
@@@@ -433,6 +434,7 @@@@ open_slave(int *ptyfd, int *ttyfd, char 
d20 1
a20 1
@@@@ -488,7 +490,7 @@@@ allocate_pty(int *ptyfd, int *ttyfd, cha
d28 2
a29 2
 #if defined(HAVE_GETPT)
@@@@ -505,29 +507,21 @@@@ allocate_pty(int *ptyfd, int *ttyfd, cha
@

