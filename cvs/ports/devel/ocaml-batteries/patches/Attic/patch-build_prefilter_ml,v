head	1.2;
access;
symbols
	OPENBSD_5_8:1.1.0.6
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.2
	OPENBSD_5_7_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2015.08.30.15.52.33;	author avsm;	state dead;
branches;
next	1.1;
commitid	ivcDi8qzkZ8BKHnH;

1.1
date	2014.08.27.07.54.22;	author chrisz;	state Exp;
branches;
next	;
commitid	8v3XtfCXenaTBSc1;


desc
@@


1.2
log
@update to ocaml-batteries-2.3.1

Removes OCaml 4.02.0+ patches which are now upstreamed

ok jca@@, tested by krw@@ daniel@@ jsg@@
@
text
@$OpenBSD: patch-build_prefilter_ml,v 1.1 2014/08/27 07:54:22 chrisz Exp $

from upstream: support comparison operator for prefilter on version
needed for backwards compatibility with ocaml < 4.2

--- build/prefilter.ml.orig	Fri Jan 17 20:28:42 2014
+++ build/prefilter.ml	Wed Aug 20 11:50:45 2014
@@@@ -3,23 +3,21 @@@@ let (major, minor) =
     "%d.%d." (fun j n -> (j, n))
 
 let filter_cookie_re =
-  Str.regexp "^##V\\([^#]+\\)##"
+  Str.regexp "^##V\\([<>]?=?\\)\\([^#]+\\)##"
 let version_re =
   Str.regexp "\\([0-9]+\\)\\(\\.\\([0-9]+\\)\\)?"
 
-let maybe f x = try Some (f x) with _ -> None
-
 let process_line line =
   if Str.string_match filter_cookie_re line 0 then begin
-    let ver_string = Str.matched_group 1 line in
+    let cmp = match Str.matched_group 1 line with
+    | "<" -> (<) | ">" -> (>) | "=" -> (=)
+    | "<=" -> (<=) | ">=" -> (>=) | _ -> (>=)
+    in
+    let ver_string = Str.matched_group 2 line in
     assert (Str.string_match version_re ver_string 0) ;
     let ver_maj = int_of_string (Str.matched_group 1 ver_string) in
-    let pass = match maybe (Str.matched_group 3) ver_string with
-    | None -> ver_maj <= major
-    | Some ver_min ->
-      let ver_min = int_of_string ver_min in
-      ver_maj <= major && ver_min <= minor
-    in
+    let ver_min = try int_of_string (Str.matched_group 3 ver_string) with _ -> 0 in
+    let pass = cmp (major*100+minor) (ver_maj*100+ver_min) in
     if pass then Str.replace_first filter_cookie_re "" line
     else ""
   end else line
@


1.1
log
@Update ocaml-batteries to 2.2.0.
Also include fixes from upstream to support OCaml 4.02

OK jca@@
@
text
@d1 1
a1 1
$OpenBSD$
@

