head	1.3;
access;
symbols;
locks; strict;
comment	@# @;


1.3
date	2015.01.28.09.20.07;	author ajacoutot;	state dead;
branches;
next	1.2;
commitid	qU8wbvTvYBQFYM9Q;

1.2
date	2014.12.17.19.23.32;	author jasper;	state Exp;
branches;
next	1.1;
commitid	oKrkSRWSG05yD2x4;

1.1
date	2014.08.14.06.42.16;	author jasper;	state Exp;
branches;
next	;
commitid	rnvQ0IlawGSwdKpm;


desc
@@


1.3
log
@Update to libgit2-glib-0.22.0.

ok jasper@@
@
text
@$OpenBSD: patch-libgit2-glib_ggit-blob-output-stream_c,v 1.2 2014/12/17 19:23:32 jasper Exp $

From 55c649fa4d95e72e530bba1d070242b10d860ad8 Mon Sep 17 00:00:00 2001
From: Jasper Lievisse Adriaanse <jasper@@humppa.nl>
Date: Wed, 30 Jul 2014 23:51:05 +0200
Subject: Rework synchronization for blob's state machine, effectively unbreaking on OpenBSD

--- libgit2-glib/ggit-blob-output-stream.c.orig	Wed Dec 17 20:21:15 2014
+++ libgit2-glib/ggit-blob-output-stream.c	Wed Dec 17 20:21:28 2014
@@@@ -28,6 +28,20 @@@@
 
 #define GGIT_BLOB_OUTPUT_STREAM_GET_PRIVATE(object)(G_TYPE_INSTANCE_GET_PRIVATE((object), GGIT_TYPE_BLOB_OUTPUT_STREAM, GgitBlobOutputStreamPrivate))
 
+/*
+ * BLOB_CHUNKING_STATE_IDLE: stream's thread is waiting for data
+ * BLOB_CHUNKING_STATE_SENDING: have data, outside thread is waiting for result
+ * BLOB_CHUNKING_STATE_CANCELLED: cancelled, stream's thread to exit and set error result
+ * BLOB_CHUNKING_STATE_CLOSED: closed by outside thread or error, exit and set result
+ */
+typedef enum
+{
+	BLOB_CHUNKING_STATE_IDLE,
+	BLOB_CHUNKING_STATE_SENDING,
+	BLOB_CHUNKING_STATE_CANCELLED,
+	BLOB_CHUNKING_STATE_CLOSED
+} BlobChunkingState;
+
 struct _GgitBlobOutputStreamPrivate
 {
 	GgitRepository *repository;
@@@@ -36,9 +50,6 @@@@ struct _GgitBlobOutputStreamPrivate
 	GMutex mutex;
 	GCond cond;
 
-	GMutex reply_mutex;
-	GCond reply_cond;
-
 	gssize written;
 
 	const gchar *writebuf;
@@@@ -47,8 +58,7 @@@@ struct _GgitBlobOutputStreamPrivate
 	gint ret;
 	GgitOId *oid;
 
-	guint closing : 1;
-	guint cancelled : 1;
+	BlobChunkingState state;
 };
 
 G_DEFINE_TYPE (GgitBlobOutputStream, ggit_blob_output_stream, G_TYPE_OUTPUT_STREAM)
@@@@ -68,17 +78,22 @@@@ ggit_blob_output_stream_close (GOutputStream  *object,
 
 	if (g_cancellable_set_error_if_cancelled (cancellable, error))
 	{
+		g_mutex_lock (&stream->priv->mutex);
+
+		if (stream->priv->state != BLOB_CHUNKING_STATE_CANCELLED)
+		{
+			stream->priv->state = BLOB_CHUNKING_STATE_CANCELLED;
+			g_cond_signal (&stream->priv->cond);
+		}
+
+		g_mutex_unlock (&stream->priv->mutex);
 		return FALSE;
 	}
 
 	g_mutex_lock (&stream->priv->mutex);
-	stream->priv->closing = TRUE;
-
+	stream->priv->state = BLOB_CHUNKING_STATE_CLOSED;
 	g_cond_signal (&stream->priv->cond);
-	g_mutex_lock (&stream->priv->reply_mutex);
 	g_mutex_unlock (&stream->priv->mutex);
-	g_cond_wait (&stream->priv->reply_cond, &stream->priv->reply_mutex);
-	g_mutex_unlock (&stream->priv->reply_mutex);
 
 	g_thread_join (stream->priv->thread);
 	return TRUE;
@@@@ -105,38 +120,54 @@@@ ggit_blob_output_stream_write (GOutputStream  *object,
                                GError        **error)
 {
 	GgitBlobOutputStream *stream = GGIT_BLOB_OUTPUT_STREAM (object);
+	gssize written;
 
-	if (stream->priv->closing)
+	g_mutex_lock (&stream->priv->mutex);
+
+	while (stream->priv->state == BLOB_CHUNKING_STATE_SENDING)
 	{
+		g_cond_wait (&stream->priv->cond, &stream->priv->mutex);
+	}
+
+	if (stream->priv->state == BLOB_CHUNKING_STATE_CLOSED)
+	{
+		g_mutex_unlock (&stream->priv->mutex);
 		return 0;
 	}
 
-	g_mutex_lock (&stream->priv->mutex);
-
 	if (g_cancellable_is_cancelled (cancellable))
 	{
-		stream->priv->cancelled = TRUE;
+		stream->priv->state = BLOB_CHUNKING_STATE_CANCELLED;
 	}
 
-	stream->priv->writebuf = buffer;
-	stream->priv->bufsize = count;
-	stream->priv->written = 0;
+	if (stream->priv->state == BLOB_CHUNKING_STATE_IDLE)
+	{
+		stream->priv->writebuf = buffer;
+		stream->priv->bufsize = count;
+		stream->priv->written = 0;
+		stream->priv->state = BLOB_CHUNKING_STATE_SENDING;
+	}
 
 	g_cond_signal (&stream->priv->cond);
 
-	g_mutex_lock (&stream->priv->reply_mutex);
-	g_mutex_unlock (&stream->priv->mutex);
+	while (stream->priv->state == BLOB_CHUNKING_STATE_SENDING)
+	{
+		g_cond_wait (&stream->priv->cond, &stream->priv->mutex);
+	}
 
-	g_cond_wait (&stream->priv->reply_cond, &stream->priv->reply_mutex);
-	g_mutex_unlock (&stream->priv->reply_mutex);
-
-	if (stream->priv->cancelled)
+	if (stream->priv->state == BLOB_CHUNKING_STATE_CANCELLED)
 	{
 		g_cancellable_set_error_if_cancelled (cancellable, error);
-		return -1;
+		written = -1;
 	}
+	else
+	{
+		written = stream->priv->written;
+	}
 
-	return stream->priv->written;
+	g_mutex_unlock (&stream->priv->mutex);
+
+	return written;
 }
 
 static void
@@@@ -151,9 +182,6 @@@@ ggit_blob_output_stream_finalize (GObject *object)
 	g_mutex_clear (&stream->priv->mutex);
 	g_cond_clear (&stream->priv->cond);
 
-	g_mutex_clear (&stream->priv->reply_mutex);
-	g_cond_clear (&stream->priv->reply_cond);
-
 	if (stream->priv->oid)
 	{
 		ggit_oid_free (stream->priv->oid);
@@@@ -233,18 +261,27 @@@@ blob_chunk_cb (char   *content,
 	GgitBlobOutputStream *stream = payload;
 	int written = 0;
 
-	g_cond_wait (&stream->priv->cond, &stream->priv->mutex);
+	g_mutex_lock (&stream->priv->mutex);
 
-	if (stream->priv->closing)
+	while (stream->priv->state == BLOB_CHUNKING_STATE_IDLE)
 	{
+		g_cond_wait (&stream->priv->cond, &stream->priv->mutex);
+	}
+
+	if (stream->priv->state == BLOB_CHUNKING_STATE_CLOSED)
+	{
+		g_mutex_unlock (&stream->priv->mutex);
 		return 0;
 	}
 
-	if (stream->priv->cancelled)
+	if (stream->priv->state == BLOB_CHUNKING_STATE_CANCELLED)
 	{
+		g_mutex_unlock (&stream->priv->mutex);
 		return -1;
 	}
 
+	/* state must be BLOB_CHUNKING_STATE_SENDING */
+
 	if (stream->priv->bufsize > maxlen)
 	{
 		stream->priv->written = maxlen;
@@@@ -260,9 +297,9 @@@@ blob_chunk_cb (char   *content,
 		written = stream->priv->written;
 	}
 
-	g_mutex_lock (&stream->priv->reply_mutex);
-	g_cond_signal (&stream->priv->reply_cond);
-	g_mutex_unlock (&stream->priv->reply_mutex);
+	stream->priv->state = BLOB_CHUNKING_STATE_IDLE;
+	g_cond_signal (&stream->priv->cond);
+	g_mutex_unlock (&stream->priv->mutex);
 
 	return written;
 }
@@@@ -280,23 +317,22 @@@@ chunk_blob_in_thread (gpointer data)
 	                                  blob_chunk_cb,
 	                                  data);
 
+	g_mutex_lock (&stream->priv->mutex);
 	stream->priv->ret = ret;
-	stream->priv->closing = TRUE;
 
 	if (ret == GIT_OK)
 	{
+		stream->priv->state = BLOB_CHUNKING_STATE_CLOSED;
 		stream->priv->oid = _ggit_oid_wrap (&oid);
 	}
 	else
 	{
-		stream->priv->cancelled = TRUE;
+		stream->priv->state = BLOB_CHUNKING_STATE_CANCELLED;
 	}
 
-	g_mutex_lock (&stream->priv->reply_mutex);
-	g_cond_signal (&stream->priv->reply_cond);
+	g_cond_signal (&stream->priv->cond);
 
 	g_mutex_unlock (&stream->priv->mutex);
-	g_mutex_unlock (&stream->priv->reply_mutex);
 
 	return NULL;
 }
@@@@ -309,10 +345,7 @@@@ ggit_blob_output_stream_init (GgitBlobOutputStream *se
 	g_mutex_init (&self->priv->mutex);
 	g_cond_init (&self->priv->cond);
 
-	g_mutex_init (&self->priv->reply_mutex);
-	g_cond_init (&self->priv->reply_cond);
-
-	g_mutex_lock (&self->priv->mutex);
+	self->priv->state = BLOB_CHUNKING_STATE_IDLE;
 
 	self->priv->thread = g_thread_new ("ggit-blob-output-stream",
 	                                   chunk_blob_in_thread,
@


1.2
log
@sync with what's been committed upstream
@
text
@d1 1
a1 1
$OpenBSD: patch-libgit2-glib_ggit-blob-output-stream_c,v 1.1 2014/08/14 06:42:16 jasper Exp $
@


1.1
log
@- update to libgit2-glib-0.0.20
- whack the OutputStream statemachine with mutexes and conditional variables (from guenther@@, thanks!)
@
text
@d1 1
a1 1
$OpenBSD$
d3 4
a6 1
https://bugzilla.gnome.org/show_bug.cgi?id=734010
d8 24
a31 3
--- libgit2-glib/ggit-blob-output-stream.c.orig	Sun Feb  9 21:35:38 2014
+++ libgit2-glib/ggit-blob-output-stream.c	Thu Jul 31 00:14:49 2014
@@@@ -36,9 +36,6 @@@@ struct _GgitBlobOutputStreamPrivate
d41 1
a41 1
@@@@ -47,8 +44,13 @@@@ struct _GgitBlobOutputStreamPrivate
d47 1
a47 7
+	/*
+	 * IDLE -> stream's thread is waiting for data
+	 * SENDING -> have data, outside thread is waiting for result
+	 * CANCELLED -> cancelled, stream's thread to exit and set error result
+	 * CLOSED -> closed by outside thread or error, exit and set result
+	 */
+	enum { IDLE, SENDING, CANCELLED, CLOSED } state;
d51 1
a51 1
@@@@ -68,17 +70,20 @@@@ ggit_blob_output_stream_close (GOutputStream  *object,
d56 2
a57 1
+		if (stream->priv->state != CANCELLED)
d59 1
a59 1
+			stream->priv->state = CANCELLED;
d62 1
d70 1
a70 1
+	stream->priv->state = CLOSED;
d79 1
a79 1
@@@@ -105,38 +110,54 @@@@ ggit_blob_output_stream_write (GOutputStream  *object,
d88 1
a88 1
+	while (stream->priv->state == SENDING)
d93 1
a93 1
+	if (stream->priv->state == CLOSED)
d104 1
a104 1
+		stream->priv->state = CANCELLED;
d110 1
a110 1
+	if (stream->priv->state == IDLE)
d115 1
a115 1
+		stream->priv->state = SENDING;
d122 1
a122 1
+	while (stream->priv->state == SENDING)
d131 1
a131 1
+	if (stream->priv->state == CANCELLED)
d149 1
a149 1
@@@@ -151,9 +172,6 @@@@ ggit_blob_output_stream_finalize (GObject *object)
d159 1
a159 1
@@@@ -233,18 +251,26 @@@@ blob_chunk_cb (char   *content,
a164 4
+	while (stream->priv->state == IDLE)
+	{
+		g_cond_wait (&stream->priv->cond, &stream->priv->mutex);
+	}
d167 1
a167 1
+	if (stream->priv->state == CLOSED)
d169 5
d179 1
a179 1
+	if (stream->priv->state == CANCELLED)
d185 1
a185 1
+	/* state must be SENDING */
d190 1
a190 1
@@@@ -260,9 +286,9 @@@@ blob_chunk_cb (char   *content,
d197 1
a197 1
+	stream->priv->state = IDLE;
d203 1
a203 1
@@@@ -280,23 +306,22 @@@@ chunk_blob_in_thread (gpointer data)
d213 1
a213 1
+		stream->priv->state = CLOSED;
d219 1
a219 1
+		stream->priv->state = CANCELLED;
d231 1
a231 1
@@@@ -309,10 +334,7 @@@@ ggit_blob_output_stream_init (GgitBlobOutputStream *se
d239 1
a239 1
+	self->priv->state = IDLE;
@

