head	1.2;
access;
symbols;
locks; strict;
comment	@# @;


1.2
date	2016.08.15.14.55.48;	author shadchin;	state Exp;
branches;
next	1.1;
commitid	ElmiKWxfTMHHqnwH;

1.1
date	2016.08.12.06.13.54;	author shadchin;	state Exp;
branches;
next	;
commitid	gVlHWXfE1rNHy1is;


desc
@@


1.2
log
@Fix previous patch, spotted by semarie@@

From Anton Lindqvist <anton dot lindqvist at gmail dot com>
@
text
@$OpenBSD: patch-read_c,v 1.1 2016/08/12 06:13:54 shadchin Exp $
--- read.c.orig	Sat Jul  4 11:29:02 2009
+++ read.c	Mon Aug 15 19:47:23 2016
@@@@ -526,9 +526,9 @@@@ extern char *readLine (vString *const vLine, FILE *con
 				vStringSetLength (vLine);
 				/* canonicalize new line */
 				eol = vStringValue (vLine) + vStringLength (vLine) - 1;
-				if (*eol == '\r')
+				if (vStringLength (vLine) > 0 && *eol == '\r')
 					*eol = '\n';
-				else if (*(eol - 1) == '\r'  &&  *eol == '\n')
+				else if (vStringLength (vLine) > 1 && *(eol - 1) == '\r'  &&  *eol == '\n')
 				{
 					*(eol - 1) = '\n';
 					*eol = '\0';
@


1.1
log
@Fix segfault while running ctags on a binary file.

From Anton Lindqvist <anton dot lindqvist at gmail dot com>
@
text
@d1 1
a1 1
$OpenBSD$
d3 2
a4 2
+++ read.c	Fri Aug 12 11:07:47 2016
@@@@ -526,13 +526,20 @@@@ extern char *readLine (vString *const vLine, FILE *con
a15 11
 					--vLine->length;
+				}
+				else if (vStringSize (vLine) > 1)
+				{
+					eol = vStringValue (vLine);
+					*eol = '\n';
+					*(eol + 1) = '\0';
+					vStringSetLength (vLine);
 				}
 			}
 		} while (reReadLine);
@

