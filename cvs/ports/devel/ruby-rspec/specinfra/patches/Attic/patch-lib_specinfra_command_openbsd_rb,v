head	1.8;
access;
symbols
	jasper_20141904:1.1.1.1 jasper:1.1.1;
locks; strict;
comment	@# @;


1.8
date	2014.10.17.17.28.02;	author jasper;	state dead;
branches;
next	1.7;
commitid	a20HYL7FZLCo2Dxj;

1.7
date	2014.09.17.06.19.48;	author jasper;	state Exp;
branches;
next	1.6;
commitid	FLeiMMEW5p3fajSG;

1.6
date	2014.09.16.21.58.26;	author jasper;	state Exp;
branches;
next	1.5;
commitid	JfOFJ7fWcAGR2Z6U;

1.5
date	2014.04.20.21.22.44;	author jasper;	state dead;
branches;
next	1.4;

1.4
date	2014.04.19.18.30.50;	author jasper;	state Exp;
branches;
next	1.3;

1.3
date	2014.04.19.18.25.12;	author jasper;	state Exp;
branches;
next	1.2;

1.2
date	2014.04.19.16.56.45;	author jasper;	state Exp;
branches;
next	1.1;

1.1
date	2014.04.19.16.41.29;	author jasper;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2014.04.19.16.41.29;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.8
log
@- update to specinfra-2.3.0
- switch to use rspec3

many thanks to upstream for promptly merging my patches to get specinfr2
working on OpenBSD (including the routing table matchers). if there's a
matcher that doesn't work on OpenBSD, please do let me know.
@
text
@$OpenBSD: patch-lib_specinfra_command_openbsd_rb,v 1.7 2014/09/17 06:19:48 jasper Exp $

From de5bb690d462211bb9210ab3ad671dba0929644e Mon Sep 17 00:00:00 2001
From: Jasper Lievisse Adriaanse <jasper@@humppa.nl>
Date: Wed, 17 Sep 2014 00:00:59 +0200
Subject: [PATCH] use rcctl(8) when dealing with services on OpenBSD

--- lib/specinfra/command/openbsd.rb.orig	Tue Sep 16 23:54:31 2014
+++ lib/specinfra/command/openbsd.rb	Tue Sep 16 23:54:38 2014
@@@@ -2,7 +2,7 @@@@ module SpecInfra
   module Command
     class OpenBSD < Base
       def check_enabled(service, level=3)
-        "egrep '(#{escape(service)}_flags=|^pkg_scripts=\"(.*)#{escape(service)}(.*)\")' /etc/rc.conf.local | grep -v \=NO"
+        "rcctl status #{escape(service)}"
       end
 
       def check_file_md5checksum(file, expected)
@@@@ -76,7 +76,7 @@@@ module SpecInfra
 #      end
 
       def check_running(service)
-        "/etc/rc.d/#{escape(service)} status"
+        "rcctl check #{escape(service)}"
       end
 
       def get_mode(file)
@


1.7
log
@committed upstream
@
text
@d1 1
a1 1
$OpenBSD: patch-lib_specinfra_command_openbsd_rb,v 1.6 2014/09/16 21:58:26 jasper Exp $
@


1.6
log
@use rcctl(8) instead of various grep constructs
@
text
@d1 1
a1 1
$OpenBSD$
d3 4
a6 1
use rcctl(8)
@


1.5
log
@update to specinfra-1.4.0
@
text
@d1 1
a1 1
$OpenBSD: patch-lib_specinfra_command_openbsd_rb,v 1.4 2014/04/19 18:30:50 jasper Exp $
d3 1
a3 1
https://github.com/serverspec/specinfra/pull/91
d5 20
a24 83
XXX: backend/exec.rb#get_routing_table needs to be adjusted to deal with
     multiple formats.

--- lib/specinfra/command/openbsd.rb.orig	Sat Apr 19 19:13:19 2014
+++ lib/specinfra/command/openbsd.rb	Sat Apr 19 20:23:38 2014
@@@@ -0,0 +1,77 @@@@
+module SpecInfra
+  module Command
+    class OpenBSD < Base
+      def check_enabled(service, level=3)
+        "egrep '(#{escape(service)}_flags=|^pkg_scripts=\"(.*)#{escape(service)}(.*)\")' /etc/rc.conf.local | grep -v \=NO"
+      end
+
+      def check_file_md5checksum(file, expected)
+        regexp = "^#{expected}"
+        "cksum -qa md5 #{escape(file)} | grep -w #{escape(regexp)}"
+      end
+
+      def check_file_sha256checksum(file, expected)
+        regexp = "^#{expected}"
+        "cksum -qa sha256 #{escape(file)} | grep -w #{escape(regexp)}"
+      end
+
+      def check_login_shell(user, path_to_shell)
+        "getent passwd #{escape(user)} | cut -f 7 -d ':' | grep #{escape(path_to_shell)}"
+      end
+
+      def check_home_directory(user, path_to_home)
+        "getent passwd #{escape(user)} | cut -f 6 -d ':' | grep #{escape(path_to_home)}"
+      end
+
+      def check_installed(package, version=nil)
+        if version
+          "pkg_info -a | cut -d ' ' -f 1 | grep  #{escape(package)}-#{escape(version)}"
+        else
+          "pkg_info -a | cut -d ' ' -f 1 | grep  #{escape(package)}"
+        end
+      end
+
+      def get_interface_speed_of(name)
+        "ifconfig #{name} | grep 'media\:' | perl -pe 's|.*media\:.*\\((.*?)\\)|\\1|'"
+      end
+
+      def check_ipv4_address(interface, ip_address)
+        "ifconfig #{interface} | grep -w inet | cut -d ' ' -f 2"
+      end
+
+      def check_listening(port)
+        "netstat -nat -f inet | egrep '((tcp|udp).*\.#{port}.*LISTEN$)'"
+      end
+
+      def check_mail_alias(recipient, target)
+        "egrep '^#{escape(recipient)}:.*#{escape(target)}' /etc/mail/aliases"
+      end
+
+      def check_mode(file, mode)
+        regexp = "^#{mode}$"
+        "stat -f%Lp #{escape(file)} | grep #{escape(regexp)}"
+      end
+
+      def check_mounted(path)
+        regexp = "on #{path} "
+        "mount | grep #{escape(regexp)}"
+      end
+
+#      def check_routing_table(destination)
+#        "route -n show -gateway | egrep '(^default|#{destination})' | head -1"
+#      end
+
+      def check_running(service)
+        "/etc/rc.d/#{escape(service)} status"
+      end
+
+      def get_mode(file)
+        "stat -f%Lp #{escape(file)}"
+      end
+
+      def install(package)
+        "pkg_add #{package}"
+      end
+    end
+  end
+end
@


1.4
log
@submitted upstream
@
text
@d1 1
a1 1
$OpenBSD: patch-lib_specinfra_command_openbsd_rb,v 1.3 2014/04/19 18:25:12 jasper Exp $
@


1.3
log
@add matchers for interface speed/address
@
text
@d1 3
a3 1
$OpenBSD: patch-lib_specinfra_command_openbsd_rb,v 1.2 2014/04/19 16:56:45 jasper Exp $
@


1.2
log
@add matchers for login shell, homedir and running services
@
text
@d1 8
a8 4
$OpenBSD: patch-lib_specinfra_command_openbsd_rb,v 1.1.1.1 2014/04/19 16:41:29 jasper Exp $
--- lib/specinfra/command/openbsd.rb.orig	Sat Apr 19 18:55:29 2014
+++ lib/specinfra/command/openbsd.rb	Sat Apr 19 18:55:44 2014
@@@@ -0,0 +1,61 @@@@
d42 8
d54 4
d67 4
@


1.1
log
@Initial revision
@
text
@d1 4
a4 4
$OpenBSD$
--- lib/specinfra/command/openbsd.rb.orig	Sat Apr 19 17:43:00 2014
+++ lib/specinfra/command/openbsd.rb	Sat Apr 19 18:19:15 2014
@@@@ -0,0 +1,49 @@@@
d22 8
d50 4
@


1.1.1.1
log
@import specinfra-1.2.1

Common layer for serverspec and configspec.

not all matchers are implemented on OpenBSD, but that can be improved intree.
ok rpe@@
@
text
@@
