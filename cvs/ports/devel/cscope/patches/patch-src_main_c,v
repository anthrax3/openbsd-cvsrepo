head	1.2;
access;
symbols
	OPENBSD_6_2:1.2.0.6
	OPENBSD_6_2_BASE:1.2
	OPENBSD_6_1:1.2.0.4
	OPENBSD_6_1_BASE:1.2
	OPENBSD_6_0:1.2.0.2
	OPENBSD_6_0_BASE:1.2
	OPENBSD_5_9:1.1.0.2
	OPENBSD_5_9_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2016.03.25.12.41.56;	author mestre;	state Exp;
branches;
next	1.1;
commitid	xBZLGA82fX2V7qCk;

1.1
date	2016.01.21.14.34.42;	author mestre;	state Exp;
branches;
next	;
commitid	sx9hJ9bdnYhGkixQ;


desc
@@


1.2
log
@The first #ifdef around pledge was totally wrong and this way this pledge was
never called. This problem was pointed out by jca@@ a big thank you!
As upstream doesn't seem to be active anymore both #ifdefs around the pledges
can go away.

OK tb@@
@
text
@$OpenBSD: patch-src_main_c,v 1.1 2016/01/21 14:34:42 mestre Exp $

# uses pledge()

--- src/main.c.orig	Thu Nov 20 21:12:54 2014
+++ src/main.c	Fri Mar 25 11:45:40 2016
@@@@ -56,6 +56,7 @@@@
 #ifdef HAVE_GETOPT_LONG 
 #include <getopt.h>
 #endif
+#include <errno.h>
 
 /* defaults for unset environment variables */
 #define	EDITOR	"vi"
@@@@ -481,6 +482,14 @@@@ cscope: reffile too long, cannot be > %d characters\n"
 
  lastarg:
 #endif
+
+	if (linemode == YES) {
+		if (pledge("stdio rpath wpath cpath proc exec", NULL) == -1) {
+			fprintf(stderr, "cscope: pledge: %s\n", strerror(errno));
+			myexit(1);
+		}
+	}
+
     /* read the environment */
     editor = mygetenv("EDITOR", EDITOR);
     editor = mygetenv("VIEWER", editor); /* use viewer if set */
@@@@ -573,6 +582,12 @@@@ cscope: Could not create private temp dir %s\n",
 	/* initialize the curses display package */
 	initscr();	/* initialize the screen */
 	entercurses();
+
+	if (pledge("stdio rpath wpath cpath tty proc exec", NULL) == -1) {
+		fprintf(stderr, "cscope: pledge: %s\n", strerror(errno));
+		myexit(1);
+	}
+
 #if TERMINFO
 	keypad(stdscr, TRUE);	/* enable the keypad */
 # ifdef HAVE_FIXKEYPAD
@


1.1
log
@pledge(2) cscope

If linemode == NO it needs:

rpath: read the program
wpath: create cscope.out files
cpath: needs to unlink temp files at exit
tty: at exit curses calls an ioctl to clean the window
proc/exec: needs to fork and exec external program, namely $EDITOR

If linemode == YES it's the same as above, except it doesn't need "tty"

ok benoit@@ and tb@@
@
text
@d1 1
a1 1
$OpenBSD$
d6 1
a6 1
+++ src/main.c	Tue Jan 19 10:27:48 2016
d15 1
a15 1
@@@@ -481,6 +482,16 @@@@ cscope: reffile too long, cannot be > %d characters\n"
a19 1
+#if defined(__OPENBSD__)
a25 1
+#endif
d30 1
a30 1
@@@@ -573,6 +584,14 @@@@ cscope: Could not create private temp dir %s\n",
a34 1
+#if defined(__OpenBSD__)
a38 1
+#endif
@

