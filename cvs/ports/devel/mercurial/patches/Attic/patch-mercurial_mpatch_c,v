head	1.1;
access;
symbols
	OPENBSD_5_9:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2016.06.27.16.39.28;	author jasper;	state dead;
branches
	1.1.2.1;
next	;
commitid	TTxpUw5imnimb97H;

1.1.2.1
date	2016.06.27.16.39.28;	author jasper;	state Exp;
branches;
next	;
commitid	TTxpUw5imnimb97H;


desc
@@


1.1
log
@file patch-mercurial_mpatch_c was initially added on branch OPENBSD_5_9.
@
text
@@


1.1.2.1
log
@security fixes for CVE-2016-3069, CVE-2016-3105, CVE-2016-3630, CVE-2016-3068

ok rpointel@@ (MAINTAINER)
@
text
@a0 30
$OpenBSD$

Security fix for CVE-2016-3630
https://selenic.com/repo/hg-stable/rev/b6ed2505d6cf
https://selenic.com/repo/hg-stable/rev/b9714d958e89

--- mercurial/mpatch.c.orig	Mon Jun 27 15:22:15 2016
+++ mercurial/mpatch.c	Mon Jun 27 15:23:33 2016
@@@@ -205,7 +205,7 @@@@ static struct flist *decode(const char *bin, Py_ssize_
 	int pos = 0;
 
 	/* assume worst case size, we won't have many of these lists */
-	l = lalloc(len / 12);
+	l = lalloc(len / 12 + 1);
 	if (!l)
 		return NULL;
 
@@@@ -215,10 +215,10 @@@@ static struct flist *decode(const char *bin, Py_ssize_
 		lt->start = getbe32(bin + pos);
 		lt->end = getbe32(bin + pos + 4);
 		lt->len = getbe32(bin + pos + 8);
-		if (lt->start > lt->end)
-			break; /* sanity check */
 		lt->data = bin + pos + 12;
 		pos += 12 + lt->len;
+		if (lt->start > lt->end || lt->len < 0)
+			break; /* sanity check */
 		lt++;
 	}
 
@

