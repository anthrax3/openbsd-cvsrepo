head	1.4;
access;
symbols
	OPENBSD_6_0:1.4.0.6
	OPENBSD_6_0_BASE:1.4
	OPENBSD_5_9:1.4.0.2
	OPENBSD_5_9_BASE:1.4
	OPENBSD_5_8:1.4.0.4
	OPENBSD_5_8_BASE:1.4
	OPENBSD_5_7:1.3.0.2
	OPENBSD_5_7_BASE:1.3
	OPENBSD_5_6:1.1.0.4
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.2
	OPENBSD_5_5_BASE:1.1;
locks; strict;
comment	@# @;


1.4
date	2015.06.05.20.36.46;	author stu;	state Exp;
branches;
next	1.3;
commitid	aTGl85LpG33spXOf;

1.3
date	2014.10.21.05.10.34;	author stu;	state Exp;
branches;
next	1.2;
commitid	PpVhmygxLqH8qnby;

1.2
date	2014.09.10.23.10.04;	author stu;	state Exp;
branches;
next	1.1;
commitid	cQrOzneWz6HsH3La;

1.1
date	2013.11.14.09.43.09;	author stu;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Update to 0.6pl2.

Install improvements.
Patches went upstream.
@
text
@$OpenBSD: patch-support_installation_actions_tcl,v 1.3 2014/10/21 05:10:34 stu Exp $

Retrieve module info from man pages.
Perform shebang adjustments.

--- support/installation/actions.tcl.orig	Thu Apr  9 00:08:33 2015
+++ support/installation/actions.tcl	Fri Apr 10 13:49:57 2015
@@@@ -108,15 +108,96 @@@@ proc _tci {module libdir} {
     return
 }
 
+proc _manfile {fn dfn} {
+    global modinfos
+    if {[file tail $dfn] ni {tk_getString.n}} {
+	set dfn [file join [file dirname $dfn] [string map {_ ::} [file tail $dfn]]]
+    }
+    set f [open $fn]
+    chan configure $f -buffersize 100000
+    set d [read -nonewline $f]
+    close $f
+    if {[regexp {\n\.SH NAME\n(.*?) \\- (.*?)\n} $d -> shname shtitle] && [regexp -line {^\.TH.*$} $d th]} {
+	lappend modinfos [list $shname [lindex $th 3] [lindex $th 5] $shtitle]
+    }
+    xcopyfile $fn $dfn
+}
 
-proc _manfile {f format ext docdir} { return }
-proc _man {module format ext docdir} { return }
+proc _man {module srcdir dstdir} {
+    foreach fn [glob -nocomplain -dir [file join $srcdir $module] *] {
+	if {[file extension $fn] eq ".n"} {
+	    _manfile $fn [file join $dstdir [file tail $fn]]
+	} else {
+	    xcopyfile $fn $dstdir
+	}
+    }
+}
 
-proc _exa {module exadir} {
-    global distribution
-    xcopy \
-	    [file join $distribution examples $module] \
-	    [file join $exadir $module] \
-	    1
+proc _tcm {module libdir} {
+    global distribution config pkgs
+    file mkdir $config(mp)
+    xcopyfile [file join $distribution modules $module $module.tcl] \
+	[file join $config(mp) $module-$pkgs($module).tm]
     return
+}
+
+proc _exafile {fn dfn} {
+    global config
+    set f [open $fn]
+    set d [read $f 2]
+    if {$d ne "#!"} {
+	close $f
+	xcopyfile $fn $dfn
+	return
+    }
+    chan configure $f -buffersize 100000
+    append d [read -nonewline $f]
+    close $f
+    set l [split $d \n]
+    if {
+	[string match {#!*/*} [lindex $l 0]] &&
+	[string match {#*\\} [lindex $l 1]] && 
+	[regexp {exec.+(tclsh|wish)} [lindex $l 2] -> whatsh]
+    } {
+	lset l 2 [format {exec %s "$0" ${1+"$@@"}} $config($whatsh)]
+    } elseif {[regexp {#!.*/env.+(tclsh|wish)} [lindex $l 0] -> whatsh]} {
+	lset l 0 [format "#! %s" $config($whatsh)]
+    } else {
+	xcopyfile $fn $dfn
+	return
+    }
+    log "Installing $fn to $dfn"
+    set f [open $dfn w]
+    puts $f [join $l \n]
+    close $f
+    file attributes $dfn -permissions 0o555
+}
+
+proc _exa {module srcdir dstdir} {
+    _exax $module $module $srcdir $dstdir
+}
+
+proc _exax {actual module srcdir dstdir} {
+    set dstdir [file join $dstdir $module]
+    if {![file exists $dstdir]} {
+	log "Making directory $dstdir"
+	file mkdir $dstdir
+	file attributes $dstdir -permissions 0o755
+    }
+    foreach fn [glob -nocomplain -dir [file join $srcdir $actual] *] {
+	if {[file isdirectory $fn]} {
+	    set m [file tail $fn] 
+	    _exax $m $m [file dirname $fn] $dstdir
+	    continue
+	}
+	set t [file tail $fn]
+	set e [file extension $fn]
+	if {$t eq "ChangeLog" || $e in {.orig .beforesubst}} { continue }
+	if {$t in {run.tcl}} { continue }
+	if {$e in {.tcl ""}} {
+	    _exafile $fn [file join $dstdir $t]
+	} else {
+	    xcopyfile $fn $dstdir
+	}
+    }
 }
@


1.3
log
@Install as many extensions as easily possible as Tcl Modules.
@
text
@d1 1
a1 1
$OpenBSD: patch-support_installation_actions_tcl,v 1.2 2014/09/10 23:10:04 stu Exp $
d6 3
a8 3
--- support/installation/actions.tcl.orig	Mon Aug 11 01:25:55 2014
+++ support/installation/actions.tcl	Tue Sep 16 17:25:20 2014
@@@@ -108,15 +108,106 @@@@ proc _tci {module libdir} {
a16 1
+    log "Installing $fn to $dfn"
d24 1
a24 4
+    set f [open $dfn w]
+    puts -nonewline $f $d
+    close $f
+    file attributes $dfn -permissions 0o444
d53 2
a54 1
+proc _exafile {fn dfn tclsh} {
d59 1
a59 1
+	xcopyfile $fn [file dirname $dfn]
a64 4
+    log "Installing $fn to $dfn"
+    set execreplace "exec $tclsh "; append execreplace {"$0" ${1+"$@@"}}
+    set envreplace "#! $tclsh"
+    set perms 0o444
a65 1
+    set l2 [string trim [lindex $l 2]]
d69 1
a69 2
+	([string match {exec*tclsh*} $l2] ||
+	 [string match {exec*wish*} $l2])
d71 6
a76 8
+	if {[string match {exec*wish*} $l2]} {
+	    set execreplace [string map {tclsh wish} $execreplace]
+	}
+	lset l 2 $execreplace
+	set perms 0o555
+    } elseif {[string match {#!*/env*tclsh*} [lindex $l 0]]} {
+	lset l 0 $envreplace
+	set perms 0o555
d78 1
d82 1
a82 1
+    file attributes $dfn -permissions $perms
d85 2
a86 2
+proc _exa {module srcdir dstdir tclsh} {
+    _exax $module $module $srcdir $dstdir $tclsh
d89 1
a89 1
+proc _exax {actual module srcdir dstdir tclsh} {
d99 1
a99 1
+	    _exax $m $m [file dirname $fn] $dstdir $tclsh
d107 1
a107 1
+	    _exafile $fn [file join $dstdir $t] $tclsh
@


1.2
log
@Make installer work with FAKE_AS_ROOT=no.
@
text
@d1 1
a1 1
$OpenBSD: patch-support_installation_actions_tcl,v 1.1 2013/11/14 09:43:09 stu Exp $
d6 3
a8 3
--- support/installation/actions.tcl.orig	Wed Oct 30 14:44:52 2013
+++ support/installation/actions.tcl	Fri Nov  8 15:05:31 2013
@@@@ -108,15 +108,98 @@@@ proc _tci {module libdir} {
d49 8
a56 1
-    return
@


1.1
log
@Update to 0.6.
Installation changes like with tcllib.
Mentry and wcb are now in tklib.
Too many patches for stupidities.

Thanks to Steve Havelka for distfile hosting.

ok landry@@
@
text
@d1 1
a1 1
$OpenBSD$
d28 1
a28 1
+    file attributes $dfn -owner root -group bin -permissions 0o444
d85 1
a85 1
+    file attributes $dfn -owner root -group bin -permissions $perms
d97 1
a97 1
+	file attributes $dstdir -owner root -group bin -permissions 0o755
@

