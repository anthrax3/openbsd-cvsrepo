head	1.6;
access;
symbols
	OPENBSD_6_0:1.6.0.6
	OPENBSD_6_0_BASE:1.6
	OPENBSD_5_9:1.6.0.2
	OPENBSD_5_9_BASE:1.6
	OPENBSD_5_8:1.6.0.4
	OPENBSD_5_8_BASE:1.6
	OPENBSD_5_7:1.5.0.2
	OPENBSD_5_7_BASE:1.5
	OPENBSD_5_6:1.3.0.4
	OPENBSD_5_6_BASE:1.3
	OPENBSD_5_5:1.3.0.2
	OPENBSD_5_5_BASE:1.3
	OPENBSD_5_4:1.2.0.12
	OPENBSD_5_4_BASE:1.2
	OPENBSD_5_3:1.2.0.10
	OPENBSD_5_3_BASE:1.2
	OPENBSD_5_2:1.2.0.8
	OPENBSD_5_2_BASE:1.2
	OPENBSD_5_1_BASE:1.2
	OPENBSD_5_1:1.2.0.6
	OPENBSD_5_0:1.2.0.4
	OPENBSD_5_0_BASE:1.2
	OPENBSD_4_9:1.2.0.2
	OPENBSD_4_9_BASE:1.2
	OPENBSD_4_8:1.1.1.1.0.6
	OPENBSD_4_8_BASE:1.1.1.1
	OPENBSD_4_7:1.1.1.1.0.4
	OPENBSD_4_7_BASE:1.1.1.1
	OPENBSD_4_6:1.1.1.1.0.2
	OPENBSD_4_6_BASE:1.1.1.1
	stuart_20090318:1.1.1.1
	sthen:1.1.1;
locks; strict;
comment	@# @;


1.6
date	2015.06.05.20.36.46;	author stu;	state Exp;
branches;
next	1.5;
commitid	aTGl85LpG33spXOf;

1.5
date	2014.10.21.05.10.34;	author stu;	state Exp;
branches;
next	1.4;
commitid	PpVhmygxLqH8qnby;

1.4
date	2014.09.10.23.10.04;	author stu;	state Exp;
branches;
next	1.3;
commitid	cQrOzneWz6HsH3La;

1.3
date	2013.11.14.09.43.09;	author stu;	state Exp;
branches;
next	1.2;

1.2
date	2011.01.05.16.37.10;	author stu;	state Exp;
branches;
next	1.1;

1.1
date	2009.03.18.09.10.27;	author sthen;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2009.03.18.09.10.27;	author sthen;	state Exp;
branches;
next	;


desc
@@


1.6
log
@Update to 0.6pl2.

Install improvements.
Patches went upstream.
@
text
@$OpenBSD: patch-installer_tcl,v 1.5 2014/10/21 05:10:34 stu Exp $

Install everything nicely.
Generate tcllib.n.

--- installer.tcl.orig	Wed Apr 22 06:49:59 2015
+++ installer.tcl	Thu Jun  4 01:43:54 2015
@@@@ -84,16 +84,24 @@@@ if {![package vsatisfies [package provide Tcl] 8.0]} {
 
 proc xcopyfile {src dest} {
     # dest can be dir or file
+    if {[file isdirectory $dest]} {
+	set dest [file join $dest [file tail $src]]
+    }
+    log "Installing $src to $dest"
     run file copy -force $src $dest
+    file attributes $dest -permissions 0o444
     return
 }
 
 proc xcopy {src dest recurse {pattern *}} {
+    log "Making directory $dest"
     run file mkdir $dest
 
+    file attributes $dest -permissions 0o755
     if {[string equal $pattern *] || !$recurse} {
 	foreach file [glob [file join $src $pattern]] {
 	    set base [file tail $file]
+	    if {$base eq "ChangeLog" || [file extension $base] in {.orig .beforesubst}} { continue }
 	    set sub  [file join $dest $base]
 
 	    if {0 == [string compare CVS $base]} {continue}
@@@@ -144,6 +152,7 @@@@ proc write_out {f text} {
     catch {file delete -force $f}
     puts -nonewline [set of [open $f w]] $text
     close $of
+    file attributes $f -permissions 0o444
 }
 
 
@@@@ -184,7 +193,6 @@@@ proc run {args} {
             return -code error "Install error:\n $msg" 
         }
     }
-    log* .
     return
 }
 
@@@@ -209,18 +217,23 @@@@ proc ainstall {} {
 	set aexe [file join $distribution apps $a]
 	set adst [file join $config(app,path) ${a}$ext]
 
-	log "\nGenerating $adst"
-	if {!$config(dry)} {
-	    file mkdir [file dirname  $adst]
-	    catch {file delete -force $adst}
-	    file copy -force $aexe    $adst
+	if {![file exists $config(app,path)]} {
+	    log "Making directory $config(app,path)"
+	    run file mkdir $config(app,path)
+	    file attributes $config(app,path) -permissions 0o755
 	}
+	_exafile $aexe $adst
+	if {[file exists $aexe.man]} {
+	    set fn [file tail $aexe].n
+	    _manfile [file join $distribution embedded man files apps $fn] [file join $config(doc,nroff,path) $fn]
+	}
     }
     return
 }
 
 proc doinstall {} {
     global config package_version distribution package_name modules excluded
+    global pkgs
 
     if {!$config(no-exclude)} {
 	foreach p $excluded {
@@@@ -230,26 +243,35 @@@@ proc doinstall {} {
 	}
     }
 
+    array set pkgs [exec [info nameofexecutable] [file join $distribution sak.tcl] provided]
+
     if {$config(doc,nroff)} {
 	set config(man.macros) [string trim [get_input \
 		[file join $distribution support installation man.macros]]]
     }
     if {$config(pkg)}       {
 	xinstall   pkg $config(pkg,path)
-	gen_main_index $config(pkg,path) $package_name $package_version
     }
-    if {$config(doc,nroff)} {
+    if 0 {
 	foreach dir [glob -directory $distribution/embedded/man/files/modules *] {
 	    xcopy $dir $config(doc,nroff,path) 1
 	}
 	xcopy $distribution/embedded/man/files/apps $config(doc,nroff,path) 1
     }
+    xinstall doc [file join $distribution embedded man files modules] $config(doc,nroff,path)
+    foreach module {mentry tablelist wcb} {
+	set srcdir [file join $distribution modules $module]
+	set dstdir [file join $config(csb) $module]
+	xcopy $srcdir $dstdir 0 *.txt
+	xcopy [file join $srcdir doc] $dstdir 0 *
+    }
     if {$config(doc,html)}  {
 	#xinstall doc html  html $config(doc,html,path)
 	xcopy $distribution/embedded/www $config(doc,html,path) 1
     }
-    if {$config(exa)}       {xinstall exa $config(exa,path)}
+    if {$config(exa)}       {xinstall exa [file join $distribution examples] $config(exa,path)}
     if {$config(app)}       {ainstall}
+    mkindex
     log ""
     return
 }
@@@@ -511,6 +533,10 @@@@ proc processargs {} {
 		set config(exa,path) [lindex $argv 1]
 		set argv             [lrange $argv 1 end]
 	    }
+	    -csb - -descr - -mp - -tclsh - -wish {
+		set config([string range [lindex $argv 0] 1 end]) [lindex $argv 1]
+		set argv [lrange $argv 1 end]
+	    }
 	    -help   -
 	    default {
 		puts stderr "usage: $argv0 ?-dry-run/-simulate? ?-no-wait? ?-no-gui? ?-html|-no-html? ?-nroff|-no-nroff? ?-examples|-no-examples? ?-pkgs|-no-pkgs? ?-pkg-path path? ?-apps|-no-apps? ?-app-path path? ?-nroff-path path? ?-html-path path? ?-example-path path?"
@@@@ -566,6 +592,40 @@@@ proc wait {} {
 	exit 0
     }
     return
+}
+
+proc mkindex {} {
+    global config package_name package_version modinfos
+    package require doctools
+
+    set modinfos [lsort -dictionary -index 0 $modinfos]
+
+    set title [expr {[string index $package_name 1] eq "k" ? "Tk" : "Tcl"}]
+    append title " Standard Library"
+
+    set mp ""
+    append mp {[comment {-*- tcl -*- doctools manpage}]}
+    append mp "\[manpage_begin $package_name n $package_version\]"
+    append mp "\[titledesc {$title}\]"
+    append mp "\[moddesc {$title}\]"
+
+    append mp {[description]} \n $config(descr)
+
+    append mp {[section MODULES] [list_begin options]}
+    foreach mi $modinfos {
+	set s "\[opt_def {[lindex $mi 0]} [string map {& ""} [lindex $mi 1]]\]"
+	append mp $s [string map {\\& "" [ [lb] ] [rb] \\fI "" \\fR ""} " [lindex $mi 2] - [lindex $mi 3]"]
+    }
+    append mp {[list_end]}
+
+    append mp {[manpage_end]}
+
+    set fn [file join $config(doc,nroff,path) $package_name.n]
+    log "Installing $package_name.n to $fn"
+    set f [open $fn w]
+    puts -nonewline $f [[::doctools::new mp -format nroff] format $mp]
+    close $f
+    file attributes $fn -permissions 0o444
 }
 
 # --------------------------------------------------------------
@


1.5
log
@Install as many extensions as easily possible as Tcl Modules.
@
text
@d1 1
a1 1
$OpenBSD: patch-installer_tcl,v 1.4 2014/09/10 23:10:04 stu Exp $
d6 2
a7 2
--- installer.tcl.orig	Mon Aug 11 01:25:55 2014
+++ installer.tcl	Tue Sep 16 17:20:00 2014
d63 1
a63 1
+	_exafile $aexe $adst $config(tclsh)
d111 1
a111 1
+    if {$config(exa)}       {xinstall exa [file join $distribution examples] $config(exa,path) $config(tclsh)}
d121 1
a121 1
+	    -csb - -descr - -mp - -tclsh {
d153 2
a154 2
+	set s "\[opt_def {[lindex $mi 0]} [string map {\& ""} [lindex $mi 1]]\]"
+	append mp $s [string map {\& "" [ [lb] ] [rb]} " [lindex $mi 2] - [lindex $mi 3]"]
@


1.4
log
@Make installer work with FAKE_AS_ROOT=no.
@
text
@d1 1
a1 1
$OpenBSD: patch-installer_tcl,v 1.3 2013/11/14 09:43:09 stu Exp $
d6 2
a7 2
--- installer.tcl.orig	Wed Oct 30 14:44:52 2013
+++ installer.tcl	Fri Nov  8 15:44:59 2013
d49 1
a49 1
@@@@ -209,12 +217,16 @@@@ proc ainstall {} {
d71 16
a86 1
@@@@ -236,20 +248,27 @@@@ proc doinstall {} {
d117 1
a117 1
@@@@ -511,6 +530,10 @@@@ proc processargs {} {
d121 1
a121 1
+	    -csb - -tclsh - -descr {
d128 1
a128 1
@@@@ -566,6 +589,40 @@@@ proc wait {} {
@


1.3
log
@Update to 0.6.
Installation changes like with tcllib.
Mentry and wcb are now in tklib.
Too many patches for stupidities.

Thanks to Steve Havelka for distfile hosting.

ok landry@@
@
text
@d1 1
a1 1
$OpenBSD: patch-installer_tcl,v 1.2 2011/01/05 16:37:10 stu Exp $
d17 1
a17 1
+    file attributes $dest -owner root -group bin -permissions 0o444
d25 1
a25 1
+    file attributes $dest -owner root -group bin -permissions 0o755
d37 1
a37 1
+    file attributes $f -owner root -group bin -permissions 0o444
d61 1
a61 1
+	    file attributes $config(app,path) -owner root -group bin -permissions 0o755
d150 1
a150 1
+    file attributes $fn -owner root -group bin -permissions 0o444
@


1.2
log
@Update to newer Tcl layout, Remove unecessary
top-level "tklib" dir, port Makefile improvements.

ok landry@@, sebastia@@
@
text
@d1 8
a8 10
$OpenBSD: patch-installer_tcl,v 1.1.1.1 2009/03/18 09:10:27 sthen Exp $
--- installer.tcl.orig	Wed Jan 21 23:00:46 2009
+++ installer.tcl	Tue Oct  5 01:23:46 2010
@@@@ -65,18 +65,25 @@@@ if {![package vsatisfies [package provide Tcl] 8.0]} {
     puts  $index "unset maindir"
     puts  $index ""
     close $index
+    file attributes [file join $outdir pkgIndex.tcl] -owner root -group bin -permissions 0444
     return
 }
a11 1
     run file copy -force $src $dest
d15 3
a17 1
+    file attributes $dest -owner root -group bin -permissions 0444
d22 1
a23 5
+    file attributes $dest -owner root -group bin -permissions 0755
     foreach file [glob [file join $src $pattern]] {
+	if {[file extension $file] eq ".orig"} { continue }
         set base [file tail $file]
 	set sub  [file join $dest $base]
d25 9
a33 1
@@@@ -100,6 +107,7 @@@@ proc write_out {f text} {
d37 1
a37 1
+    file attributes $f -owner root -group bin -permissions 0444
d41 7
a47 1
@@@@ -160,7 +168,6 @@@@ proc doinstall {} {
d49 24
d75 19
a93 1
-	gen_main_index $config(pkg,path) $tklib_name $tklib_version
d95 59
a153 2
     if {$config(doc,nroff)} {
 	set config(man.macros) [string trim [get_input [file join $distribution man.macros]]]
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
$OpenBSD$
d3 1
a3 1
+++ installer.tcl	Mon Feb  2 15:44:58 2009
d38 8
@


1.1.1.1
log
@import devel/tklib, from maintainer Stuart Cassoff

A collection of pure-Tcl utility modules and widgets for Tk that provide
a wide variety of functionality. The intent is to collect commonly used
functions into a single library, which users can rely on to be available
and stable.
@
text
@@
