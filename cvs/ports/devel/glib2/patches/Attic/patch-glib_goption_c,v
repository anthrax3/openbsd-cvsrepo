head	1.10;
access;
symbols
	OPENBSD_5_6:1.9.0.2
	OPENBSD_5_6_BASE:1.9
	OPENBSD_5_1_BASE:1.1
	OPENBSD_5_1:1.1.0.2;
locks; strict;
comment	@# @;


1.10
date	2014.09.23.06.15.21;	author ajacoutot;	state dead;
branches;
next	1.9;
commitid	DDK8vwZ87BuxBNLJ;

1.9
date	2014.04.20.21.18.53;	author ajacoutot;	state Exp;
branches;
next	1.8;

1.8
date	2012.07.15.08.10.41;	author ajacoutot;	state dead;
branches;
next	1.7;

1.7
date	2012.07.10.13.25.32;	author ajacoutot;	state Exp;
branches;
next	1.6;

1.6
date	2012.07.09.16.34.21;	author ajacoutot;	state Exp;
branches;
next	1.5;

1.5
date	2012.07.08.21.02.45;	author ajacoutot;	state Exp;
branches;
next	1.4;

1.4
date	2012.07.08.18.03.39;	author ajacoutot;	state Exp;
branches;
next	1.3;

1.3
date	2012.07.08.17.09.18;	author sthen;	state Exp;
branches;
next	1.2;

1.2
date	2012.03.12.07.21.06;	author ajacoutot;	state dead;
branches;
next	1.1;

1.1
date	2012.02.02.07.10.18;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.10
log
@Update to glib2-2.40.2.
@
text
@$OpenBSD: patch-glib_goption_c,v 1.9 2014/04/20 21:18:53 ajacoutot Exp $

From 58abc1fc198a8579667ea2164c33964b250a0435 Mon Sep 17 00:00:00 2001
From: Antoine Jacoutot <ajacoutot@@gnome.org>
Date: Wed, 16 Apr 2014 10:27:09 +0200
Subject: platform_get_argv0: drop unneeded headers for OpenBSD

--- glib/goption.c.orig	Sat Feb 22 16:29:07 2014
+++ glib/goption.c	Sun Apr 20 23:16:20 2014
@@@@ -185,9 +185,7 @@@@
 #include <errno.h>
 
 #if defined __OpenBSD__
-#include <sys/types.h>
 #include <unistd.h>
-#include <sys/param.h>
 #include <sys/sysctl.h>
 #endif
 
@@@@ -1763,13 +1761,16 @@@@ platform_get_argv0 (void)
   g_free (cmdline);
   return base_arg0;
 #elif defined __OpenBSD__
-  char **cmdline = NULL;
+  char **cmdline;
   char *base_arg0;
-  gsize len = PATH_MAX;
+  gsize len;
 
   int mib[] = { CTL_KERN, KERN_PROC_ARGS, getpid(), KERN_PROC_ARGV };
 
-  cmdline = (char **) realloc (cmdline, len);
+  if (sysctl (mib, G_N_ELEMENTS (mib), NULL, &len, NULL, 0) == -1)
+      return NULL;
+
+  cmdline = g_malloc0 (len);
 
   if (sysctl (mib, G_N_ELEMENTS (mib), cmdline, &len, NULL, 0) == -1)
     {
@


1.9
log
@Fix platform_get_argv0.
@
text
@d1 1
a1 1
$OpenBSD$
@


1.8
log
@Bugfix update to glib2-2.32.4.
@
text
@d1 1
a1 1
$OpenBSD: patch-glib_goption_c,v 1.7 2012/07/10 13:25:32 ajacoutot Exp $
d3 1
a3 1
From 4749878f9102d40d072bb5c838f2dd2e8d61d417 Mon Sep 17 00:00:00 2001
d5 2
a6 2
Date: Mon, 09 Jul 2012 16:17:01 +0000
Subject: goptions: use G_N_ELEMENTS instead of nitems
d8 4
a11 3
--- glib/goption.c.orig	Mon May 14 23:58:01 2012
+++ glib/goption.c	Mon Jul  9 17:46:09 2012
@@@@ -1680,7 +1680,7 @@@@ platform_get_argv0 (void)
d13 6
a18 1
   cmdline = (char **) realloc (cmdline, len);
d20 19
a38 2
-  if (sysctl (mib, nitems (mib), cmdline, &len, NULL, 0) == -1)
+  if (sysctl (mib, G_N_ELEMENTS (mib), cmdline, &len, NULL, 0) == -1)
a39 2
       g_free (cmdline);
       return NULL;
@


1.7
log
@Committed upstream.
@
text
@d1 1
a1 1
$OpenBSD: patch-glib_goption_c,v 1.6 2012/07/09 16:34:21 ajacoutot Exp $
@


1.6
log
@Use G_N_ELEMENTS instead of nitems.
@
text
@d1 1
a1 1
$OpenBSD: patch-glib_goption_c,v 1.5 2012/07/08 21:02:45 ajacoutot Exp $
d3 4
a6 1
https://bugzilla.gnome.org/show_bug.cgi?id=679590
@


1.5
log
@Committed upstream.
@
text
@d1 1
a1 1
$OpenBSD: patch-glib_goption_c,v 1.4 2012/07/08 18:03:39 ajacoutot Exp $
d3 1
a3 4
From f9a6a97470583417a26619b5da3d56097a15c6dd Mon Sep 17 00:00:00 2001
From: Antoine Jacoutot <ajacoutot@@gnome.org>
Date: Sun, 08 Jul 2012 17:23:18 +0000
Subject: OpenBSD: explicitely define nitems
d5 3
a7 3
--- glib/goption.c.orig	Sun Jul  8 08:40:22 2012
+++ glib/goption.c	Sun Jul  8 08:40:24 2012
@@@@ -1680,6 +1680,9 @@@@ platform_get_argv0 (void)
d11 2
a12 4
+#ifndef nitems
+#define nitems(_a)      (sizeof((_a)) / sizeof((_a)[0]))
+#endif
   if (sysctl (mib, nitems (mib), cmdline, &len, NULL, 0) == -1)
d15 1
@


1.4
log
@BZ links.
@
text
@d1 1
a1 1
$OpenBSD: patch-glib_goption_c,v 1.3 2012/07/08 17:09:18 sthen Exp $
d3 4
a6 1
https://bugzilla.gnome.org/show_bug.cgi?id=679590
@


1.3
log
@don't rely on param.h for nitems(), ok ajacoutot@@
@
text
@d1 4
a4 1
$OpenBSD$
@


1.2
log
@Minor update to glib 2.30.3.
@
text
@d1 4
a4 12
$OpenBSD: patch-glib_goption_c,v 1.1 2012/02/02 07:10:18 ajacoutot Exp $

From e43a98c00091f5e293d2d9d72df2c04081802abe Mon Sep 17 00:00:00 2001
From: Antoine Jacoutot <ajacoutot@@gnome.org>
Date: Mon, 30 Jan 2012 15:17:06 +0000
Subject: goption: implement platform_get_argv0() for OpenBSD

--- glib/goption.c.orig	Tue Aug 16 02:51:30 2011
+++ glib/goption.c	Mon Jan 30 15:58:16 2012
@@@@ -139,6 +139,13 @@@@
 #include <stdio.h>
 #include <errno.h>
d6 4
a9 5
+#if defined __OpenBSD__
+#include <sys/types.h>
+#include <unistd.h>
+#include <sys/param.h>
+#include <sys/sysctl.h>
d11 3
a13 42
+
 #include "goption.h"
 
 #include "gprintf.h"
@@@@ -1665,7 +1672,7 @@@@ free_pending_nulls (GOptionContext *context,
 static char *
 platform_get_argv0 (void)
 {
-#ifdef __linux
+#if defined __linux
   char *cmdline;
   char *base_arg0;
   gsize len;
@@@@ -1683,6 +1690,28 @@@@ platform_get_argv0 (void)
    * could be large.
    */
   base_arg0 = g_path_get_basename (cmdline);
+  g_free (cmdline);
+  return base_arg0;
+#elif defined __OpenBSD__
+  char **cmdline = NULL;
+  char *base_arg0;
+  gsize len = PATH_MAX;
+
+  int mib[] = { CTL_KERN, KERN_PROC_ARGS, getpid(), KERN_PROC_ARGV };
+
+  cmdline = (char **) realloc (cmdline, len);
+
+  if (sysctl (mib, nitems (mib), cmdline, &len, NULL, 0) == -1)
+    {
+      g_free (cmdline);
+      return NULL;
+    }
+
+  /* We could just return cmdline, but I think it's better
+   * to hold on to a smaller malloc block; the arguments
+   * could be large.
+   */
+  base_arg0 = g_path_get_basename (*cmdline);
   g_free (cmdline);
   return base_arg0;
 #endif
@


1.1
log
@Implement platform_get_argv0.
We are using autohell to put '-Wstrict-aliasing' into Makefile.am.

ok sthen@@
@
text
@d1 1
a1 1
$OpenBSD$
@

