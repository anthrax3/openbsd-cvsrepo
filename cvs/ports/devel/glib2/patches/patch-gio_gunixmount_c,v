head	1.14;
access;
symbols
	OPENBSD_6_2:1.14.0.4
	OPENBSD_6_2_BASE:1.14
	OPENBSD_6_1:1.14.0.2
	OPENBSD_6_1_BASE:1.14
	OPENBSD_6_0:1.13.0.4
	OPENBSD_6_0_BASE:1.13
	OPENBSD_5_9:1.13.0.2
	OPENBSD_5_9_BASE:1.13
	OPENBSD_5_8:1.12.0.6
	OPENBSD_5_8_BASE:1.12
	OPENBSD_5_7:1.12.0.2
	OPENBSD_5_7_BASE:1.12
	OPENBSD_5_6:1.11.0.2
	OPENBSD_5_6_BASE:1.11
	OPENBSD_5_5:1.9.0.2
	OPENBSD_5_5_BASE:1.9
	OPENBSD_5_4:1.7.0.2
	OPENBSD_5_4_BASE:1.7
	OPENBSD_5_3:1.6.0.2
	OPENBSD_5_3_BASE:1.6
	OPENBSD_5_2:1.5.0.4
	OPENBSD_5_2_BASE:1.5
	OPENBSD_5_1_BASE:1.5
	OPENBSD_5_1:1.5.0.2
	OPENBSD_5_0:1.4.0.2
	OPENBSD_5_0_BASE:1.4
	OPENBSD_4_9:1.2.0.2
	OPENBSD_4_9_BASE:1.2
	OPENBSD_4_8:1.1.0.2
	OPENBSD_4_8_BASE:1.1;
locks; strict;
comment	@# @;


1.14
date	2016.10.28.13.40.04;	author ajacoutot;	state Exp;
branches;
next	1.13;
commitid	OWtwB2HchbcPGaBL;

1.13
date	2015.09.24.10.23.42;	author ajacoutot;	state Exp;
branches;
next	1.12;
commitid	TJvyXNuKGn4RlcXO;

1.12
date	2014.10.01.08.39.25;	author ajacoutot;	state Exp;
branches;
next	1.11;
commitid	99NPoXJkUIRIpCSU;

1.11
date	2014.03.26.08.28.15;	author ajacoutot;	state Exp;
branches;
next	1.10;

1.10
date	2014.03.16.09.45.35;	author ajacoutot;	state Exp;
branches;
next	1.9;

1.9
date	2014.02.22.10.14.56;	author stsp;	state Exp;
branches;
next	1.8;

1.8
date	2013.12.09.19.49.20;	author ajacoutot;	state Exp;
branches;
next	1.7;

1.7
date	2013.03.27.17.49.34;	author ajacoutot;	state Exp;
branches;
next	1.6;

1.6
date	2012.09.21.13.16.49;	author ajacoutot;	state Exp;
branches;
next	1.5;

1.5
date	2011.08.22.15.26.40;	author ajacoutot;	state Exp;
branches;
next	1.4;

1.4
date	2011.06.28.09.40.13;	author ajacoutot;	state Exp;
branches;
next	1.3;

1.3
date	2011.03.07.19.17.14;	author ajacoutot;	state Exp;
branches;
next	1.2;

1.2
date	2010.09.30.07.17.19;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2010.04.29.16.38.41;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.14
log
@Update to glib2-2.50.1.
This starts the GNOME 3.22 update which will be finished next week at b2k16.
@
text
@$OpenBSD: patch-gio_gunixmount_c,v 1.13 2015/09/24 10:23:42 ajacoutot Exp $

https://bugzilla.gnome.org/show_bug.cgi?id=653555

--- gio/gunixmount.c.orig	Fri Jul  1 21:54:29 2016
+++ gio/gunixmount.c	Wed Oct 26 11:37:25 2016
@@@@ -27,6 +27,12 @@@@
 #include <sys/wait.h>
 #include <unistd.h>
 
+#ifdef __OpenBSD__
+#include <errno.h>
+#include <sys/param.h>
+#include <sys/mount.h>
+#endif
+
 #include <glib.h>
 #include "gsubprocess.h"
 #include "gioenums.h"
@@@@ -358,12 +364,20 @@@@ g_unix_mount_eject (GMount             *mount,
   GUnixMount *unix_mount = G_UNIX_MOUNT (mount);
   char *argv[] = {"eject", NULL, NULL};
 
+#ifndef __OpenBSD__ /* eject(1) requires a device on OpenBSD */
   if (unix_mount->mount_path != NULL)
     argv[1] = unix_mount->mount_path;
   else
+#endif
     argv[1] = unix_mount->device_path;
 
   eject_unmount_do (mount, cancellable, callback, user_data, argv);
+
+/* eject(1) on OpenBSD does not try to unmount first */
+#ifdef __OpenBSD__
+  if (unmount(unix_mount->mount_path, MNT_FORCE) < 0)
+    g_warning ("%s unmount failed: %s\n", unix_mount->mount_path, strerror(errno));
+#endif
 }
 
 static gboolean
@


1.13
log
@Update to glib2-2.46.0.
@
text
@d1 1
a1 1
$OpenBSD: patch-gio_gunixmount_c,v 1.12 2014/10/01 08:39:25 ajacoutot Exp $
d5 2
a6 2
--- gio/gunixmount.c.orig	Wed Aug 19 05:35:30 2015
+++ gio/gunixmount.c	Wed Sep 23 09:25:35 2015
d20 1
a20 1
@@@@ -357,12 +363,20 @@@@ g_unix_mount_eject (GMount             *mount,
@


1.12
log
@Update to glib2-2.42.0.

bulk testing and ok jasper@@
@
text
@d1 1
a1 1
$OpenBSD: patch-gio_gunixmount_c,v 1.11 2014/03/26 08:28:15 ajacoutot Exp $
d5 2
a6 2
--- gio/gunixmount.c.orig	Mon Sep 22 15:42:12 2014
+++ gio/gunixmount.c	Sat Sep 27 13:24:16 2014
d20 1
a20 1
@@@@ -358,12 +364,20 @@@@ g_unix_mount_eject (GMount             *mount,
@


1.11
log
@Update to glib2-2.40.0.
First step of the road to GNOME 3.12...

ok jasper@@
@
text
@d1 1
a1 1
$OpenBSD: patch-gio_gunixmount_c,v 1.10 2014/03/16 09:45:35 ajacoutot Exp $
d5 2
a6 2
--- gio/gunixmount.c.orig	Thu Mar 20 04:50:45 2014
+++ gio/gunixmount.c	Tue Mar 25 08:12:54 2014
d20 1
a20 1
@@@@ -355,12 +361,20 @@@@ g_unix_mount_eject (GMount             *mount,
@


1.10
log
@Sync comment with what was committed upstream; no pkg change.
@
text
@d1 1
a1 1
$OpenBSD: patch-gio_gunixmount_c,v 1.9 2014/02/22 10:14:56 stsp Exp $
d5 3
a7 8
From 64ec757d058dae045e275577da8f14f463cc7c44 Mon Sep 17 00:00:00 2001
From: Ryan Lortie <desrt@@desrt.ca>
Date: Sun, 02 Mar 2014 22:39:11 +0000
Subject: GUnixMount: port unmount to GSubprocess

--- gio/gunixmount.c.orig	Fri Oct 25 17:58:38 2013
+++ gio/gunixmount.c	Sat Feb 22 00:13:50 2014
@@@@ -29,6 +29,12 @@@@
d18 3
a20 55
 #include "gunixvolumemonitor.h"
 #include "gunixmount.h"
@@@@ -314,7 +320,15 @@@@ read:
         goto read;
    }
   else if (status == G_IO_STATUS_EOF)
-    g_string_append_len (data->error_string, buf, bytes_read);
+    {
+      g_string_append_len (data->error_string, buf, bytes_read);
+      if (data->error_channel_source)
+        {
+          g_source_unref (data->error_channel_source);
+          data->error_channel_source = NULL;
+        }
+      return G_SOURCE_REMOVE;
+    }
   else if (status == G_IO_STATUS_ERROR)
     {
       if (data->error_string->len > 0)
@@@@ -328,10 +342,10 @@@@ read:
           g_source_unref (data->error_channel_source);
           data->error_channel_source = NULL;
         }
-      return FALSE;
+      return G_SOURCE_REMOVE;
     }
 
-  return TRUE;
+  return G_SOURCE_CONTINUE;
 }
 
 static gboolean
@@@@ -340,7 +354,6 @@@@ eject_unmount_do_cb (gpointer user_data)
   GTask *task = user_data;
   UnmountEjectOp *data = g_task_get_task_data (task);
   GPid child_pid;
-  GSource *child_watch;
   GError *error = NULL;
 
   if (g_task_return_error_if_cancelled (task))
@@@@ -371,12 +384,8 @@@@ eject_unmount_do_cb (gpointer user_data)
   data->error_channel_source = g_io_create_watch (data->error_channel, G_IO_IN);
   g_task_attach_source (task, data->error_channel_source,
                         (GSourceFunc) eject_unmount_read_error);
+  g_child_watch_add (child_pid, (GChildWatchFunc) eject_unmount_cb, task);
 
-  child_watch = g_child_watch_source_new (child_pid);
-  g_task_attach_source (task, data->error_channel_source,
-                        (GSourceFunc) eject_unmount_cb);
-  g_source_unref (child_watch);
-
 handle_error:
   if (error != NULL)
     {
@@@@ -451,12 +460,20 @@@@ g_unix_mount_eject (GMount             *mount,
@


1.9
log
@Fix bug in glib's gio that could make XFCE's Thunar crash and make GNOME's
Nautilus hang when unmounting devices. Patch filed upstream (bz 724916).
ok ajacoutot
@
text
@d1 1
a1 1
$OpenBSD: patch-gio_gunixmount_c,v 1.8 2013/12/09 19:49:20 ajacoutot Exp $
d4 5
a8 1
https://bugzilla.gnome.org/show_bug.cgi?id=724916
@


1.8
log
@Slightly rework the eject(1) case.
@
text
@d1 1
a1 1
$OpenBSD: patch-gio_gunixmount_c,v 1.7 2013/03/27 17:49:34 ajacoutot Exp $
d4 1
d6 2
a7 2
--- gio/gunixmount.c.orig	Tue May  7 20:26:07 2013
+++ gio/gunixmount.c	Mon Dec  9 19:58:28 2013
d21 53
a73 1
@@@@ -451,12 +457,20 @@@@ g_unix_mount_eject (GMount             *mount,
@


1.7
log
@Major update to glib2-2.36.0.
*huge* thank to landry@@ for running a bulk with this diff and the few
others that are going to be committed and for informing me of the
breakage that needed some love.
@
text
@d1 1
a1 1
$OpenBSD: patch-gio_gunixmount_c,v 1.6 2012/09/21 13:16:49 ajacoutot Exp $
d5 2
a6 2
--- gio/gunixmount.c.orig	Wed Mar 13 14:39:09 2013
+++ gio/gunixmount.c	Tue Mar 26 11:02:30 2013
d20 1
a20 1
@@@@ -451,10 +457,21 @@@@ g_unix_mount_eject (GMount             *mount,
d24 1
a24 10
+/*
+ * eject(1) on OpenBSD does not try to unmount first and only works on
+ * devices, not mount points.
+ */
+#ifdef __OpenBSD__
+  if (unmount(unix_mount->mount_path, MNT_FORCE) < 0)
+    g_warning ("%s unmount failed: %s\n", unix_mount->mount_path, strerror(errno));
+
+  argv[1] = unix_mount->device_path;
+#else
d28 1
a29 1
+#endif
d32 6
d39 2
@


1.6
log
@It's this time of the year again... update glib2 to the latest
available development release (glib2-2.33.14). A new stable is supposed
to come out within the next 2 weeks and we want to be proactive and get
some things in tree before the big GNOME 3.6 update that we will work on
at p2k12.

big thank to jasper@@ for running this and the upcoming updates in a bulk
ok jasper@@
@
text
@d1 1
a1 1
$OpenBSD: patch-gio_gunixmount_c,v 1.5 2011/08/22 15:26:40 ajacoutot Exp $
d5 2
a6 2
--- gio/gunixmount.c.orig	Wed Sep  5 02:49:08 2012
+++ gio/gunixmount.c	Thu Sep 20 10:59:23 2012
d20 1
a20 1
@@@@ -462,10 +468,21 @@@@ g_unix_mount_eject (GMount             *mount,
@


1.5
log
@Remove uneeded part of patch.
@
text
@d1 1
a1 1
$OpenBSD: patch-gio_gunixmount_c,v 1.4 2011/06/28 09:40:13 ajacoutot Exp $
d5 2
a6 2
--- gio/gunixmount.c.orig	Sat Nov  6 16:38:54 2010
+++ gio/gunixmount.c	Mon Aug 22 11:43:50 2011
d20 1
a20 1
@@@@ -451,10 +457,21 @@@@ g_unix_mount_eject (GMount             *mount,
@


1.4
log
@Rework the mount/unmount functions.
Remove useless patches while here.
@
text
@d1 1
a1 1
$OpenBSD: patch-gio_gunixmount_c,v 1.3 2011/03/07 19:17:14 ajacoutot Exp $
a2 1
https://bugzilla.gnome.org/show_bug.cgi?id=653553
d6 1
a6 1
+++ gio/gunixmount.c	Tue Jun 28 10:18:02 2011
d20 1
a20 17
@@@@ -423,8 +429,14 @@@@ g_unix_mount_unmount (GMount             *mount,
                       gpointer             user_data)
 {
   GUnixMount *unix_mount = G_UNIX_MOUNT (mount);
-  char *argv[] = {"umount", NULL, NULL};
+  gchar *umount;
 
+  umount = g_find_program_in_path("umount");
+  if (!umount)
+    umount = "/sbin/umount";
+
+  char *argv[] = {umount, NULL, NULL};
+
   if (unix_mount->mount_path != NULL)
     argv[1] = unix_mount->mount_path;
   else
@@@@ -451,10 +463,21 @@@@ g_unix_mount_eject (GMount             *mount,
@


1.3
log
@Major update to glib2-2.28.2.

This (and the related 20 to 30 updates) has been tested twice in a bulk
by landry@@, thanks!
Runtime testing by myself under heavy GNOME usage...
@
text
@d1 1
a1 1
$OpenBSD: patch-gio_gunixmount_c,v 1.2 2010/09/30 07:17:19 ajacoutot Exp $
d3 2
a4 1
Removable device needs to be unmounted before it is ejected.
d6 3
a8 3
--- gio/gunixmount.c.orig	Sun Nov 14 20:34:22 2010
+++ gio/gunixmount.c	Mon Jan 31 10:14:44 2011
@@@@ -29,6 +29,11 @@@@
d13 1
d21 17
a37 1
@@@@ -451,10 +456,15 @@@@ g_unix_mount_eject (GMount             *mount,
d41 4
d46 4
a49 2
+  if (unmount(unix_mount->mount_path, MNT_FORCE) == 0)
+    argv[1] = unix_mount->device_path;
d55 1
a55 1
+#endif // __OpenBSD__
@


1.2
log
@*** HEADS UP!

Major update to glib2-2.26.0.
This starts a flood commit of several big updates (gtk+2 and GNOME 2.32).

Please note that there will be some WANTLIB/DEPENDS breakage probably,
this went into several bulks but it's impossible to catch everything.
Any gtk+2/glib2 related build failures, please talk to me or jasper@@

The ports tree is expected to be in a unconsistent state for a couple of
days to give us time to fix everything we didn't spot or any runtime
issue with the latest GNOME.
We do this now so that we have packages with all the latest major bumped
libraries at p2k10.

Thanks to landry@@ and his zomg!cluster for the bulks and reports.

ok jasper@@
@
text
@d1 1
a1 1
$OpenBSD: patch-gio_gunixmount_c,v 1.1 2010/04/29 16:38:41 ajacoutot Exp $
d5 2
a6 2
--- gio/gunixmount.c.orig	Mon Aug  9 15:34:46 2010
+++ gio/gunixmount.c	Mon Sep 27 14:42:36 2010
d19 1
a19 1
@@@@ -452,10 +457,15 @@@@ g_unix_mount_eject (GMount             *mount,
@


1.1
log
@When permissions are set up accordingly and kern.usermount is set to 1,
make it possible to umount and eject CDs using gio.
@
text
@d1 1
a1 1
$OpenBSD$
d5 2
a6 2
--- gio/gunixmount.c.orig	Sat Aug 29 04:52:23 2009
+++ gio/gunixmount.c	Thu Apr 29 14:13:50 2010
d19 1
a19 1
@@@@ -453,10 +458,15 @@@@ g_unix_mount_eject (GMount             *mount,
@

