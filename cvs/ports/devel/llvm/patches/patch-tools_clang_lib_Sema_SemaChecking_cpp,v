head	1.2;
access;
symbols;
locks; strict;
comment	@# @;


1.2
date	2017.08.10.10.29.01;	author sthen;	state Exp;
branches;
next	1.1;
commitid	fhvb7WxwEpVP91Wh;

1.1
date	2017.08.03.15.54.36;	author sthen;	state Exp;
branches;
next	;
commitid	LeZ0yeMEXAUcGG22;


desc
@@


1.2
log
@Pull across more parts from base, from Brad:

- Use int3 trap padding between functions instead of trapsleds with a leading jump
- Declare lgamma library builtins as never being const
- Enable the kprintf format attribute
@
text
@$OpenBSD: patch-tools_clang_lib_Sema_SemaChecking_cpp,v 1.1 2017/08/03 15:54:36 sthen Exp $

- Teach Clang about syslog format attribute
- Enable the kprintf format attribute

Index: tools/clang/lib/Sema/SemaChecking.cpp
--- tools/clang/lib/Sema/SemaChecking.cpp.orig
+++ tools/clang/lib/Sema/SemaChecking.cpp
@@@@ -4714,7 +4714,7 @@@@ checkFormatStringExpr(Sema &S, const Expr *E, ArrayRef
 Sema::FormatStringType Sema::GetFormatStringType(const FormatAttr *Format) {
   return llvm::StringSwitch<FormatStringType>(Format->getType()->getName())
       .Case("scanf", FST_Scanf)
-      .Cases("printf", "printf0", FST_Printf)
+      .Cases("printf", "printf0", "syslog", FST_Printf)
       .Cases("NSString", "CFString", FST_NSString)
       .Case("strftime", FST_Strftime)
       .Case("strfmon", FST_Strfmon)
@@@@ -4811,6 +4811,7 @@@@ bool Sema::CheckFormatArguments(ArrayRef<const Expr *>
     case FST_Kprintf:
     case FST_FreeBSDKPrintf:
     case FST_Printf:
+    case FST_Syslog:
       Diag(FormatLoc, diag::note_format_security_fixit)
         << FixItHint::CreateInsertion(FormatLoc, "\"%s\", ");
       break;
@@@@ -6351,8 +6352,9 @@@@ static void CheckFormatString(Sema &S, const FormatStr
   }
 
   if (Type == Sema::FST_Printf || Type == Sema::FST_NSString ||
-      Type == Sema::FST_FreeBSDKPrintf || Type == Sema::FST_OSLog ||
-      Type == Sema::FST_OSTrace) {
+      Type == Sema::FST_Kprintf || Type == Sema::FST_FreeBSDKPrintf ||
+      Type == Sema::FST_OSLog || Type == Sema::FST_OSTrace ||
+      Type == Sema::FST_Syslog) {
     CheckPrintfHandler H(
         S, FExpr, OrigFormatExpr, Type, firstDataArg, numDataArgs,
         (Type == Sema::FST_NSString || Type == Sema::FST_OSTrace), Str,
@@@@ -6362,7 +6364,7 @@@@ static void CheckFormatString(Sema &S, const FormatStr
     if (!analyze_format_string::ParsePrintfString(H, Str, Str + StrLen,
                                                   S.getLangOpts(),
                                                   S.Context.getTargetInfo(),
-                                            Type == Sema::FST_FreeBSDKPrintf))
+                Type == Sema::FST_Kprintf || Type == Sema::FST_FreeBSDKPrintf))
       H.DoneProcessing();
   } else if (Type == Sema::FST_Scanf) {
     CheckScanfHandler H(S, FExpr, OrigFormatExpr, Type, firstDataArg,
@


1.1
log
@Merge in fixes from clang in base for trapsleds, disabling
-Waddress-of-packed-member, syslog attribute, and disabling of builtins.
From Brad.
@
text
@d1 1
a1 1
$OpenBSD$
d3 2
a4 1
Teach Clang about syslog format attribute
d26 2
a27 1
@@@@ -6352,7 +6353,7 @@@@ static void CheckFormatString(Sema &S, const FormatStr
d30 1
a30 1
       Type == Sema::FST_FreeBSDKPrintf || Type == Sema::FST_OSLog ||
d32 3
a34 1
+      Type == Sema::FST_OSTrace || Type == Sema::FST_Syslog) {
d38 9
@

