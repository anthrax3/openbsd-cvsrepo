head	1.4;
access;
symbols
	OPENBSD_4_7:1.2.0.10
	OPENBSD_4_7_BASE:1.2
	OPENBSD_4_6:1.2.0.8
	OPENBSD_4_6_BASE:1.2
	OPENBSD_4_5:1.2.0.6
	OPENBSD_4_5_BASE:1.2
	OPENBSD_4_4:1.2.0.4
	OPENBSD_4_4_BASE:1.2
	OPENBSD_4_3:1.2.0.2
	OPENBSD_4_3_BASE:1.2
	OPENBSD_4_2:1.1.0.2
	OPENBSD_4_2_BASE:1.1;
locks; strict;
comment	@# @;


1.4
date	2010.05.28.20.21.48;	author dcoppa;	state dead;
branches;
next	1.3;

1.3
date	2010.04.15.20.30.47;	author dcoppa;	state Exp;
branches;
next	1.2;

1.2
date	2007.08.25.08.35.20;	author espie;	state Exp;
branches;
next	1.1;

1.1
date	2007.03.26.21.27.44;	author espie;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Update to cmake 2.8.1 (I also take maintainership).

"This is good, commit." espie@@
@
text
@$OpenBSD: patch-Source_cmFileCommand_cxx,v 1.3 2010/04/15 20:30:47 dcoppa Exp $
--- Source/cmFileCommand.cxx.orig	Mon Jan 21 19:59:52 2008
+++ Source/cmFileCommand.cxx	Sun Apr  4 18:54:42 2010
@@@@ -1279,14 +1279,49 @@@@ bool cmFileCommand::HandleInstallCommand(
           std::string libname = toFile;
           std::string soname = toFile;
           std::string soname_nopath = fromName;
+#if defined(__OpenBSD__)
+	  // need to tweak version for our shared libraries
+	  std::string myversion = lib_version;
+	  if (itype == cmTarget::SHARED_LIBRARY) {
+	  	// namely, transform version from 5.0.0 -> 5.0
+
+	    	int j = 0;
+
+	    	for (int i = 0; i < myversion.size(); i++) {
+			if (myversion[i] == '.') {
+				j++;
+			    	if (j == 2) {
+					myversion.erase(i);
+				    	break;
+			    	}
+		    	}
+	    	}
+		int n = fromName.length();
+		if (fromName.compare(0, 3, "lib") == 0 &&
+			fromName.compare(n-3, n, ".so") == 0) {
+			std::string base = fromName.substr(3, n-6);
+			// if the env says so, produce a tweaked version number instead
+			std::string v = "LIB" +base + "_VERSION";
+			char *tweaked = ::getenv(v.c_str());
+			if (tweaked)
+				myversion = tweaked;
+		}
+	  }
+          this->ComputeVersionedLibName(soname, myversion.c_str());
+          this->ComputeVersionedLibName(soname_nopath, myversion.c_str());
+          this->ComputeVersionedLibName(fromName, myversion.c_str());
+          this->ComputeVersionedLibName(toFile, myversion.c_str());
+#else
           this->ComputeVersionedLibName(soname, lib_soversion);
           this->ComputeVersionedLibName(soname_nopath, lib_soversion);
           this->ComputeVersionedLibName(fromName, lib_version);
           this->ComputeVersionedLibName(toFile, lib_version);
+#endif
 
           cmSystemTools::RemoveFile(soname.c_str());
           cmSystemTools::RemoveFile(libname.c_str());
 
+#if !defined(__OpenBSD__)
           if (!cmSystemTools::CreateSymlink(soname_nopath.c_str(), 
                                             libname.c_str()) )
             {
@@@@ -1296,6 +1331,7 @@@@ bool cmFileCommand::HandleInstallCommand(
             return false;
             }
           installer.ManifestAppend(libname);
+#endif
           if ( toFile != soname )
             {
             if ( !cmSystemTools::CreateSymlink(fromName.c_str(), 
@


1.3
log
@Avoid creating .so symlinks for shared libraries, as they break
OpenBSD porting standards.

OK landry@@, sthen@@
"if it works and other people like it, go ahead" espie@@
@
text
@d1 1
a1 1
$OpenBSD: patch-Source_cmFileCommand_cxx,v 1.2 2007/08/25 08:35:20 espie Exp $
@


1.2
log
@minor update cmake 2.4.7
@
text
@d1 4
a4 4
$OpenBSD: patch-Source_cmFileCommand_cxx,v 1.1 2007/03/26 21:27:44 espie Exp $
--- Source/cmFileCommand.cxx.orig	Mon Jul 16 23:12:30 2007
+++ Source/cmFileCommand.cxx	Mon Aug 13 02:50:05 2007
@@@@ -1279,10 +1279,44 @@@@ bool cmFileCommand::HandleInstallCommand(
d49 13
@


1.1
log
@fix shared library numbers for OpenBSD. Patch may still change, but it
appears to work fine w/ kde4.

cmake will still generate a libfoo.so (which is useful as a placeholder to
know the lib has been built, since other directories don't have access to
the version number), but it obeys OpenBSD conventions for the actual library
now.

ld does the right thing, namely it ignores the libfoo.so and links against
libfoo.so.5.0 properly.

Also take environment into account to allow the ports tree to override
version numbers.

Todo: logfile of built libraries.
@
text
@d1 4
a4 4
$OpenBSD$
--- Source/cmFileCommand.cxx.orig	Mon Mar 26 00:39:17 2007
+++ Source/cmFileCommand.cxx	Mon Mar 26 02:13:02 2007
@@@@ -1207,10 +1207,44 @@@@ bool cmFileCommand::HandleInstallCommand(
d36 4
a39 4
+          this->ComputeVersionedName(soname, myversion.c_str());
+          this->ComputeVersionedName(soname_nopath, myversion.c_str());
+          this->ComputeVersionedName(fromName, myversion.c_str());
+          this->ComputeVersionedName(toFile, myversion.c_str());
d41 4
a44 4
           this->ComputeVersionedName(soname, lib_soversion);
           this->ComputeVersionedName(soname_nopath, lib_soversion);
           this->ComputeVersionedName(fromName, lib_version);
           this->ComputeVersionedName(toFile, lib_version);
@

