head	1.4;
access;
symbols;
locks; strict;
comment	@# @;


1.4
date	2007.06.27.21.51.09;	author kurt;	state dead;
branches;
next	1.3;

1.3
date	2007.04.13.00.29.48;	author kurt;	state Exp;
branches;
next	1.2;

1.2
date	2007.01.23.14.14.37;	author kurt;	state dead;
branches;
next	1.1;

1.1
date	2006.10.03.13.36.28;	author kurt;	state Exp;
branches;
next	;


desc
@@


1.4
log
@- update port to be based of Sun's 1.5.0 Update 11 src which includes many
bug fixes since the initial release of the 1.5 jdk. I'm sure some of the
fixes are security related but I wasn't able to find a concise list. All
the bugs fixes listed here from update 11 and lower should be fixed by
this update: http://java.sun.com/j2se/1.5.0/ReleaseNotes.html#150_11
- NOTE: License change: used to be SCSL, now is JRL (Java Research
License). Still no packages with this license but at least we get the bug
fixes and security fixes now: https://tiger.dev.java.net/
- enable version scripts on libjvm which fixes a symbol conflict with
recent xulrunner which is used by eclipse's internal swt-browser.
@
text
@$OpenBSD: patch-j2se_src_solaris_native_java_lang_UNIXProcess_md_c,v 1.3 2007/04/13 00:29:48 kurt Exp $
--- j2se/src/solaris/native/java/lang/UNIXProcess_md.c.orig	Thu Apr 12 06:28:13 2007
+++ j2se/src/solaris/native/java/lang/UNIXProcess_md.c	Thu Apr 12 06:34:01 2007
@@@@ -304,14 +304,18 @@@@ Java_java_lang_UNIXProcess_waitForProcessExit(JNIEnv* 
 
 #if defined(__OpenBSD__)
 /*
- * On OpenBSD closefrom will close only the opened fds without
- * having to use heuristics and is safe to use when single
- * threaded.
+ * Directly call _thread_sys_closefrom() so the child process
+ * doesn't reset the parrent's file descriptors to be blocking.
+ * This function is only called from the child process which
+ * is single threaded and about to call execvp() so it is
+ * safe to bypass the threaded closefrom().
  */
+int _thread_sys_closefrom(int);
+
 static int
 closeDescriptors(void)
 {
-	return closefrom(3);
+	return _thread_sys_closefrom(3);
 }
 
 #else
@@@@ -559,6 +563,28 @@@@ Java_java_lang_UNIXProcess_forkAndExec(JNIEnv *env,
 
     if (resultPid == 0) {
 	/* Child process */
+
+#ifdef __OpenBSD__
+// XXXBSD: Work-around userland pthread implementation issue.
+// Closing file descriptors will reset them to be blocking.
+// This is problematic for the parent when it attemts to use
+// the blocking fd and deadlocks. Setting them to non-blocking
+// in the child prevents the close/dup2 from resetting them.
+    {
+	int flags;
+	flags = fcntl(STDIN_FILENO, F_GETFL, NULL);
+	if (flags != -1)
+	    fcntl(STDIN_FILENO, F_SETFL, flags | O_NONBLOCK);
+
+	flags = fcntl(STDOUT_FILENO, F_GETFL, NULL);
+	if (flags != -1)
+	    fcntl(STDOUT_FILENO, F_SETFL, flags | O_NONBLOCK);
+
+	flags = fcntl(STDERR_FILENO, F_GETFL, NULL);
+	if (flags != -1)
+	    fcntl(STDOUT_FILENO, F_SETFL, flags | O_NONBLOCK);
+    }
+#endif
 
 	/* Close the parent sides of the pipe.
 	   Give the child sides of the pipes the right fileno's.
@


1.3
log
@- work-around libpthread limitations in javaForkAndExec() by adjusting the
  child process to not set file descriptors back to blocking when closing
  them. This fixes the netbeans build failure since a libpthread fix is not
  evident.
- update the North America time zone file to account for the tz changes
  (from ian@@)
- use X11BASE
- SHARED_ONLY=Yes
@
text
@d1 1
a1 1
$OpenBSD$
@


1.2
log
@Update to patchset 4 which includes a security fix for CVE-2007-0243

Buffer overflow allows applets to gain privileges via a GIF image with a
block with a 0 width field, which triggers memory corruption and possible
execution of arbitrary code.

Also included in patchset 4 are corrections for building the jdk on amd64
systems with 4G+ memory and the inclusion of the mozilla headers needed to
build the plugin without an external dependency on the old mozilla suite.
@
text
@d1 4
a4 4
$OpenBSD: patch-j2se_src_solaris_native_java_lang_UNIXProcess_md_c,v 1.1 2006/10/03 13:36:28 kurt Exp $
--- j2se/src/solaris/native/java/lang/UNIXProcess_md.c.orig	Tue Sep 26 13:59:08 2006
+++ j2se/src/solaris/native/java/lang/UNIXProcess_md.c	Tue Sep 26 14:16:50 2006
@@@@ -302,7 +302,20 @@@@ Java_java_lang_UNIXProcess_waitForProces
d6 1
a6 3
 #if defined(_ALLBSD_SOURCE)
 
+#if defined(__OpenBSD__)
d8 10
a17 9
+ * On OpenBSD closefrom will close only the opened fds without
+ * having to use heuristics and is safe to use when single
+ * threaded.
+ */
+static int
+closeDescriptors(void)
+{
+	return closefrom(3);
+}
d19 5
a23 8
+#else
+/*
  * BSDNOTE: This function was returning 'int' originally.  But it assumed
  * that OS has some intelegent functionality to close opened-only fds
  * associated with current process.  Since we have to close them lineary
@@@@ -342,6 +355,7 @@@@ int closeDescriptors()
     }
     return (0);
d25 27
d54 2
a55 2
 #if defined(__FreeBSD__)
 
@


1.1
log
@- remove disabling J malloc option now that pthreads stacks are mmap'ed
this is no longer a concern upon forking.
- use closefrom(2) after forking instead of less efficient heursitics
approach.
@
text
@d1 1
a1 1
$OpenBSD$
@

