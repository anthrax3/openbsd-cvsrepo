head	1.1;
access;
symbols;
locks; strict;
comment	@# @;


1.1
date	2017.07.03.22.14.20;	author sthen;	state Exp;
branches;
next	;
commitid	3YCFei450KKbueMF;


desc
@@


1.1
log
@update to Kamailio 5.0.2, from maintainer Roman Kravchuk,
plus minor wantlib cleanup by me
@
text
@$OpenBSD$

Index: src/core/tcp_read.c
--- src/core/tcp_read.c.orig
+++ src/core/tcp_read.c
@@@@ -1497,6 +1497,14 @@@@ void release_tcpconn(struct tcp_connection* c, long st
 				ip_addr2a(&c->rcv.src_ip), c->rcv.src_port,
 				ip_addr2a(&c->rcv.dst_ip), c->rcv.dst_port);
 		LM_DBG("extra_data %p\n", c->extra_data);
+
+		/* experimental fix tls crash with libressl */
+		/* add cleanup SSL structure in child process, in parent process SSL structure is empty */
+		if ((c->type==PROTO_TLS || c->type==PROTO_WSS) && (c->extra_data) && c->fd != -1) {
+			tls_close(c, c->fd);
+			tls_tcpconn_clean(c);
+		}
+
 		/* release req & signal the parent */
 		c->reader_pid=0; /* reset it */
 		if (c->fd!=-1){
@
