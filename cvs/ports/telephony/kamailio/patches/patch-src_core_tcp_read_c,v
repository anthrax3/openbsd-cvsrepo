head	1.2;
access;
symbols
	OPENBSD_6_2:1.2.0.2
	OPENBSD_6_2_BASE:1.2;
locks; strict;
comment	@# @;


1.2
date	2017.09.21.09.34.32;	author sthen;	state Exp;
branches;
next	1.1;
commitid	4zHkBJG59PPIdO4g;

1.1
date	2017.07.03.22.14.20;	author sthen;	state Exp;
branches;
next	;
commitid	3YCFei450KKbueMF;


desc
@@


1.2
log
@update to kamailio-5.0.3 and fix loading modules linked with srdb1, srdb2,
trie, srutils on clang arches, from Roman Kravchuk (maintainer)
@
text
@$OpenBSD: patch-src_core_tcp_read_c,v 1.1 2017/07/03 22:14:20 sthen Exp $

Index: src/core/tcp_read.c
--- src/core/tcp_read.c.orig
+++ src/core/tcp_read.c
@@@@ -1503,6 +1503,14 @@@@ void release_tcpconn(struct tcp_connection* c, long st
 				ip_addr2a(&c->rcv.src_ip), c->rcv.src_port,
 				ip_addr2a(&c->rcv.dst_ip), c->rcv.dst_port);
 		LM_DBG("extra_data %p\n", c->extra_data);
+
+		/* experimental fix tls crash with libressl */
+		/* add cleanup SSL structure in child process, in parent process SSL structure is empty */
+		if ((c->type==PROTO_TLS || c->type==PROTO_WSS) && (c->extra_data) && c->fd != -1) {
+			tls_close(c, c->fd);
+			tls_tcpconn_clean(c);
+		}
+
 		/* release req & signal the parent */
 		c->reader_pid=0; /* reset it */
 		if (c->fd!=-1){
@


1.1
log
@update to Kamailio 5.0.2, from maintainer Roman Kravchuk,
plus minor wantlib cleanup by me
@
text
@d1 1
a1 1
$OpenBSD$
d6 1
a6 1
@@@@ -1497,6 +1497,14 @@@@ void release_tcpconn(struct tcp_connection* c, long st
@

