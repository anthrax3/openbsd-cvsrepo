head	1.25;
access;
symbols
	OPENBSD_6_2:1.25.0.2
	OPENBSD_6_2_BASE:1.25
	OPENBSD_6_1:1.24.0.4
	OPENBSD_6_1_BASE:1.24
	OPENBSD_6_0:1.24.0.2
	OPENBSD_6_0_BASE:1.24
	OPENBSD_5_9:1.23.0.2
	OPENBSD_5_9_BASE:1.23
	OPENBSD_5_8:1.23.0.4
	OPENBSD_5_8_BASE:1.23
	OPENBSD_5_7:1.21.0.2
	OPENBSD_5_7_BASE:1.21
	OPENBSD_5_6:1.19.0.2
	OPENBSD_5_6_BASE:1.19
	OPENBSD_5_5:1.16.0.2
	OPENBSD_5_5_BASE:1.16
	OPENBSD_5_4:1.15.0.4
	OPENBSD_5_4_BASE:1.15
	OPENBSD_5_3:1.15.0.2
	OPENBSD_5_3_BASE:1.15
	OPENBSD_5_2:1.14.0.2
	OPENBSD_5_2_BASE:1.14
	OPENBSD_5_1_BASE:1.10
	OPENBSD_5_1:1.10.0.2
	OPENBSD_5_0:1.9.0.2
	OPENBSD_5_0_BASE:1.9
	OPENBSD_4_9:1.7.0.2
	OPENBSD_4_9_BASE:1.7;
locks; strict;
comment	@ * @;


1.25
date	2017.08.01.12.18.35;	author ajacoutot;	state Exp;
branches;
next	1.24;
commitid	4uWkjhMU81azlf58;

1.24
date	2016.04.12.06.45.36;	author ajacoutot;	state Exp;
branches;
next	1.23;
commitid	rsJ3lGlheJVrgqFt;

1.23
date	2015.07.12.08.56.50;	author ajacoutot;	state Exp;
branches;
next	1.22;
commitid	qxvkxNyGaLgUJxXM;

1.22
date	2015.07.12.08.42.25;	author ajacoutot;	state Exp;
branches;
next	1.21;
commitid	xpTbY3dnAjolU9i1;

1.21
date	2014.12.06.11.12.44;	author ajacoutot;	state Exp;
branches;
next	1.20;
commitid	fsYqBLpENdvpsHVE;

1.20
date	2014.11.15.10.22.23;	author ajacoutot;	state Exp;
branches;
next	1.19;
commitid	20oo4Dj2S2v31rH3;

1.19
date	2014.07.19.17.07.02;	author ajacoutot;	state Exp;
branches;
next	1.18;
commitid	NlkJVs1hEvN3DYpa;

1.18
date	2014.04.28.13.37.32;	author ajacoutot;	state Exp;
branches;
next	1.17;

1.17
date	2014.03.09.21.46.34;	author ajacoutot;	state Exp;
branches;
next	1.16;

1.16
date	2013.12.12.14.48.31;	author ajacoutot;	state Exp;
branches;
next	1.15;

1.15
date	2013.02.04.14.46.24;	author ajacoutot;	state Exp;
branches;
next	1.14;

1.14
date	2012.05.28.15.18.18;	author ajacoutot;	state Exp;
branches;
next	1.13;

1.13
date	2012.05.26.06.43.38;	author ajacoutot;	state Exp;
branches;
next	1.12;

1.12
date	2012.05.26.06.26.04;	author ajacoutot;	state Exp;
branches;
next	1.11;

1.11
date	2012.02.16.22.12.08;	author ajacoutot;	state Exp;
branches;
next	1.10;

1.10
date	2012.02.02.07.11.19;	author ajacoutot;	state Exp;
branches;
next	1.9;

1.9
date	2011.04.06.16.50.26;	author ajacoutot;	state Exp;
branches;
next	1.8;

1.8
date	2011.03.24.15.17.28;	author ajacoutot;	state Exp;
branches;
next	1.7;

1.7
date	2011.01.11.12.13.59;	author ajacoutot;	state Exp;
branches;
next	1.6;

1.6
date	2010.12.27.14.50.23;	author ajacoutot;	state Exp;
branches;
next	1.5;

1.5
date	2010.12.24.10.40.06;	author ajacoutot;	state Exp;
branches;
next	1.4;

1.4
date	2010.11.30.08.09.09;	author ajacoutot;	state Exp;
branches;
next	1.3;

1.3
date	2010.10.29.12.54.44;	author ajacoutot;	state Exp;
branches;
next	1.2;

1.2
date	2010.10.28.15.12.50;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2010.10.27.15.42.06;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.25
log
@Stop playing games moving around base lp commands and man pages. Things
*should* be able to just work without that dance. If you want to use cups
lp commands just give the full path (/usr/local/{bin,sbin}/lpfoo).

This unbreaks displaying lp man pages that were still in the mandoc db but
not in the fs anymore as reported by espie@@
@
text
@#!/bin/sh
#
# $OpenBSD: cupsd.rc,v 1.24 2016/04/12 06:45:36 ajacoutot Exp $

daemon="${TRUEPREFIX}/sbin/cupsd"

. /etc/rc.d/rc.subr

pexp="${daemon} .*"

rc_pre() {
	# XXX remove for OPENBSD_6_3
	rm -f /usr/bin/lp{q,r,rm}.pre-cups /usr/sbin/lp{c,d}.pre-cups \
		/usr/share/man/man1/lp{q,r,rm}.1 /usr/share/man/man8/lp{c,d}.8

	# XXX cups-driverd(8) can crash when setting up a printer driver
	rm -f /var/cache/cups/*

	# rcexec is needed if openfiles limits are bumped and cupsd(8) runs in
	# debug mode to prevent MaxClients warnings in logs
	${rcexec} "${daemon} ${daemon_flags} -t" || return 1

	# no existing printcap means we're not running lpd(8) so link cups'
	# printcap so base lp commands can find and use cups printers
	[ -e /etc/printcap ] || ln -s ${SYSCONFDIR}/cups/printcap /etc/printcap
}

rc_post() {
	if [ -h /etc/printcap ]; then                           
		rm /etc/printcap                                
	fi
}

rc_cmd $1
@


1.24
log
@chmod -h 0644 /etc/printcap to please security(8).
prodded by schwarze@@

While here, drop the converters/libiconv MODULE.
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.23 2015/07/12 08:56:50 ajacoutot Exp $
d11 4
a14 4
_lpfiles="/usr/bin/lpq /usr/bin/lpr /usr/bin/lprm /usr/sbin/lpc \
	  /usr/sbin/lpd /usr/share/man/man1/lpq.1 /usr/share/man/man1/lpr.1 \
	  /usr/share/man/man1/lprm.1 /usr/share/man/man8/lpc.8 \
	  /usr/share/man/man8/lpd.8"
a15 5
rc_pre() {
	# rcexec is needed if openfiles limits are bumped and cupsd(8)
	# runs in debug mode to prevent MaxClients warnings in logs
	${rcexec} "${daemon} ${daemon_flags} -t" || return 1
	[ -e /dev/lpt0 ] && chown _cups /dev/lp[a,t][0-2]
d19 7
a25 27
	if [ -e /usr/sbin/lpd.pre-cups -a ! -f /usr/sbin/lpd -a -L /usr/sbin/lpc ]; then
		return
	elif [ ! -e /usr/sbin/lpd ]; then
		return
	else
		for i in ${_lpfiles}; do
			if [ -f $i -a ! -L $i ]; then
				mv -f $i $i.pre-cups
			fi
		done
	fi
	if [ -e /etc/printcap ]; then
		if [ ! -e /etc/printcap.pre-cups ]; then
			mv /etc/printcap /etc/printcap.pre-cups
			ln -s ${SYSCONFDIR}/cups/printcap /etc/printcap
			chmod -h 0644 /etc/printcap
		fi
	else
		ln -s ${SYSCONFDIR}/cups/printcap /etc/printcap
		chmod -h 0644 /etc/printcap
	fi
	for i in lpq lpr lprm; do
		rm -f /usr/bin/$i
		ln -s ${TRUEPREFIX}/bin/$i /usr/bin/$i
	done
	rm -f /usr/sbin/lpc
	ln -s ${TRUEPREFIX}/sbin/lpc /usr/sbin/lpc
d29 2
a30 21
	if [ ! -L /usr/sbin/lpc ]; then
		return
	else
		for i in lpq lpr lprm; do
			rm -f /usr/bin/$i
		done

		rm -f /usr/sbin/lpc

		if [ ! -e /usr/sbin/lpd.pre-cups ]; then
			return
		else
			if [ -L /etc/printcap ]; then
				rm /etc/printcap
			fi
			for i in ${_lpfiles} /etc/printcap; do
				if [ -e $i.pre-cups ]; then
					mv -f $i.pre-cups $i
				fi
			done
		fi
a31 2

	[ -e /dev/lpt0 ] && chown root /dev/lp[a,t][0-2]
@


1.23
log
@Put a space after ${daemon} since cupsd always appends some stuffs in the
process list.
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.22 2015/07/12 08:42:25 ajacoutot Exp $
d39 1
d43 1
@


1.22
log
@Relax pexp to cope with upcoming rc.subr(8) change.
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.21 2014/12/06 11:12:44 ajacoutot Exp $
d9 1
a9 1
pexp="${daemon}.*"
@


1.21
log
@This hack is unfortunately still needed.
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.20 2014/11/15 10:22:23 ajacoutot Exp $
d9 1
a9 1
pexp="${daemon}"
@


1.20
log
@Major update to cups-2.0.1.
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.19 2014/07/19 17:07:02 ajacoutot Exp $
d21 2
a22 2
	# XXX cups-driverd(8) can crash when foomatic DB sources are added/removed
	#rm -f /var/cache/cups/*
@


1.19
log
@Do not assume /etc/printcap is always present.
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.18 2014/04/28 13:37:32 ajacoutot Exp $
d22 1
a22 1
	rm -f /var/cache/cups/*
@


1.18
log
@Fix a nasty bug in rc_pre() that would start 2 intances of the cupsd daemon.
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.17 2014/03/09 21:46:34 ajacoutot Exp $
d35 6
a40 2
	if [ -e /etc/printcap -a ! -e /etc/printcap.pre-cups ]; then
		mv /etc/printcap /etc/printcap.pre-cups
d64 3
@


1.17
log
@rcexec is needed in rc_pre().
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.16 2013/12/12 14:48:31 ajacoutot Exp $
d19 1
a19 1
	${rcexec} ${daemon} -t || return 1
@


1.16
log
@Drop @@exec-update and instead remove the cache from the rc.d script.
No need to change ulpt(4) ownership, CUPS only supports libusb.
Small README tweak while here.
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.15 2013/02/04 14:46:24 ajacoutot Exp $
d17 3
a19 1
	${daemon} -t || return 1
@


1.15
log
@Fix man pages renaming.
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.14 2012/05/28 15:18:18 ajacoutot Exp $
a17 1
	[ -e /dev/ulpt0 ] && chown _cups /dev/ulpt[0-1]
d19 2
a66 1
	[ -e /dev/ulpt0 ] && chown root /dev/ulpt[0-1]
@


1.14
log
@/etc/cups -> SYSCONFDIR/cups

spotted by Mikolaj Kucharski
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.13 2012/05/26 06:43:38 ajacoutot Exp $
d12 3
a14 3
	  /usr/sbin/lpd /usr/share/man/cat1/lpq.0 /usr/share/man/cat1/lpr.0 \
	  /usr/share/man/cat1/lprm.0 /usr/share/man/cat8/lpc.0 \
	  /usr/share/man/cat8/lpd.0"
@


1.13
log
@Err stupid me. Revert previous otherwise we won't get printer updates in
the printcap. I'll have to think about something else...
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.12 2012/05/26 06:26:04 ajacoutot Exp $
d34 1
a34 1
		ln -s /etc/cups/printcap /etc/printcap
@


1.12
log
@Please security(8): cat the content of the CUPS printcap file into
/etc/printcap(5) instead of creating a link.
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.11 2012/02/16 22:12:08 ajacoutot Exp $
d34 1
a34 1
		cat /etc/cups/printcap > /etc/printcap
@


1.11
log
@Update to cups-1.5.2.
While here, create cups's printcap under /etc/cups/ because we are
running unpriviledged so we cannot touch /etc/printcap.
Tweak rc script accordingly.
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.10 2012/02/02 07:11:19 ajacoutot Exp $
d34 1
a34 1
		ln -s ${SYSCONFDIR}/cups/printcap /etc/printcap
@


1.10
log
@Remove bogus symlink which can make cups-driverd go into a loop.
Add a note about updating to a new major version (may require to revove
the cache).
Check the configuration file sanity in rc_pre().

ok sthen@@
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.9 2011/04/06 16:50:26 ajacoutot Exp $
d32 3
a34 2
	if [ -f /etc/printcap -a ! -f /etc/printcap.pre-cups ]; then
		cp -f /etc/printcap /etc/printcap.pre-cups
@


1.9
log
@cupsd rewrites its arguments, so add a pexp to the rc script.
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.8 2011/03/24 15:17:28 ajacoutot Exp $
d17 1
@


1.8
log
@Make sure we don't enter interactive mode in rc_post by using 'mv -f'.
Fix shutdown/reboot issues reported by Tomas Bodzar.
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.7 2011/01/11 12:13:59 ajacoutot Exp $
d8 2
@


1.7
log
@Update to cups-1.4.6, this version fixes landscape printing, sharing,
and fax issues.

Also merge a patch from upstream to disable multi-part support as
several browsers (notably webkit based ones) do not support it
correctly, this should fix the web interface with these browsers. See
http://www.cups.org/str.php?L3455 for details.
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.6 2010/12/27 14:50:23 ajacoutot Exp $
d55 1
a55 1
					mv $i.pre-cups $i
@


1.6
log
@Simplify after recent rc.subr change.
The framework is now stable and we will start documenting it (at last).
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.5 2010/12/24 10:40:06 ajacoutot Exp $
a8 2
pexp="${daemon} -C ${SYSCONFDIR}/cups/cupsd.conf"

d10 3
a12 3
         /usr/sbin/lpd /usr/share/man/cat1/lpq.0 /usr/share/man/cat1/lpr.0
	 /usr/share/man/cat1/lprm.0 /usr/share/man/cat8/lpc.0
	 /usr/share/man/cat8/lpd.0"
@


1.5
log
@Cope with recent rc.subr changes.
@
text
@d3 1
a3 3
# $OpenBSD: cupsd.rc,v 1.4 2010/11/30 08:09:09 ajacoutot Exp $

. /etc/rc.d/rc.subr
d7 1
a7 1
rc_conf
@


1.4
log
@Don't try and change ownership on files that don't exist.
@
text
@d3 1
a3 1
# $OpenBSD: cupsd.rc,v 1.3 2010/10/29 12:54:44 ajacoutot Exp $
d8 3
@


1.3
log
@Add RCS IDs to rc scripts.
@
text
@d3 1
a3 1
# $OpenBSD$
d16 2
a17 2
	chown _cups /dev/ulpt[0-1]
	chown _cups /dev/lp[a,t][0-2]
d62 2
a63 2
	chown root /dev/lp[a,t][0-2]
	chown root /dev/ulpt[0-1]
@


1.2
log
@Merge the cups-enable and cups-disable scripts into the rc script.
idea from and ok robert@@
@
text
@d2 2
@


1.1
log
@As agreed with espie@@, install a first rc script to serve as a test
example. A couple of things are still missing from the infrastructure
but the basics work. When everything has been taken care of, we'll start
mocing all ports to using the new rc system.
@
text
@d8 5
d16 21
a36 1
	echo y | ${TRUEPREFIX}/sbin/cups-enable >/dev/null
d40 20
a59 1
	echo y | ${TRUEPREFIX}/sbin/cups-disable >/dev/null
@

