head	1.2;
access;
symbols;
locks; strict;
comment	@# @;


1.2
date	2009.04.27.08.25.39;	author bernd;	state dead;
branches;
next	1.1;

1.1
date	2009.03.04.19.50.00;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Update to cups-1.3.10. With lots of help from ajacoutot@@.

There's an issue with the admin.cgi which will be fixed
in-tree.

ok ajacoutot@@, jasper@@
@
text
@$OpenBSD: patch-scheduler_subscriptions_c,v 1.1 2009/03/04 19:50:00 jasper Exp $

Security fix for CVE-2008-5183.
Patch adapted from Red Hat's solution.

--- scheduler/subscriptions.c.orig	Fri Sep 29 04:26:29 2006
+++ scheduler/subscriptions.c	Fri Feb 27 11:31:46 2009
@@@@ -349,8 +349,54 @@@@ cupsdAddSubscription(
   * Limit the number of subscriptions...
   */
 
-  if (cupsArrayCount(Subscriptions) >= MaxSubscriptions)
+  if (MaxSubscriptions > 0 && cupsArrayCount(Subscriptions) >= MaxSubscriptions)
+  {
+    cupsdLogMessage(CUPSD_LOG_DEBUG,
+                    "cupsdAddSubscription: Reached MaxSubscriptions %d",
+		    MaxSubscriptions);
     return (NULL);
+  }
+
+  if (MaxSubscriptionsPerJob > 0 && job)
+  {
+    int        count;			       /* Number of job subscriptions */
+
+    for (temp = (cupsd_subscription_t *)cupsArrayFirst(Subscriptions),
+	     count = 0;
+	 temp;
+	temp = (cupsd_subscription_t *)cupsArrayNext(Subscriptions))
+      if (temp->job == job)
+	count ++;
+
+    if (count >= MaxSubscriptionsPerJob)
+    {
+      cupsdLogMessage(CUPSD_LOG_DEBUG,
+		     "cupsdAddSubscription: Reached MaxSubscriptionsPerJob %d "
+		     "for job #%d", MaxSubscriptionsPerJob, job->id);
+      return (NULL);
+    }
+  }
+
+  if (MaxSubscriptionsPerPrinter > 0 && dest)
+  {
+    int        count;			       /* Number of printer subscriptions */
+
+    for (temp = (cupsd_subscription_t *)cupsArrayFirst(Subscriptions),
+	     count = 0;
+	 temp;
+	temp = (cupsd_subscription_t *)cupsArrayNext(Subscriptions))
+      if (temp->dest == dest)
+	count ++;
+
+    if (count >= MaxSubscriptionsPerPrinter)
+    {
+      cupsdLogMessage(CUPSD_LOG_DEBUG,
+		     "cupsdAddSubscription: Reached "
+		     "MaxSubscriptionsPerPrinter %d for %s",
+		     MaxSubscriptionsPerPrinter, dest->name);
+      return (NULL);
+    }
+  }
 
  /*
   * Allocate memory for this subscription...
@


1.1
log
@Security fix for CVE-2008-5183.
Patch adapted from Red Hat's solution.

ok ajacoutot@@ (MAINTAINER)
@
text
@d1 1
a1 1
$OpenBSD$
@

