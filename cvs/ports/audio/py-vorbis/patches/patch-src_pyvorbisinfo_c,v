head	1.1;
branch	1.1.1;
access;
symbols
	OPENBSD_6_0:1.1.1.1.0.22
	OPENBSD_6_0_BASE:1.1.1.1
	OPENBSD_5_9:1.1.1.1.0.18
	OPENBSD_5_9_BASE:1.1.1.1
	OPENBSD_5_8:1.1.1.1.0.20
	OPENBSD_5_8_BASE:1.1.1.1
	OPENBSD_5_7:1.1.1.1.0.16
	OPENBSD_5_7_BASE:1.1.1.1
	OPENBSD_5_6:1.1.1.1.0.14
	OPENBSD_5_6_BASE:1.1.1.1
	OPENBSD_5_5:1.1.1.1.0.12
	OPENBSD_5_5_BASE:1.1.1.1
	OPENBSD_5_4:1.1.1.1.0.10
	OPENBSD_5_4_BASE:1.1.1.1
	OPENBSD_5_3:1.1.1.1.0.8
	OPENBSD_5_3_BASE:1.1.1.1
	OPENBSD_5_2:1.1.1.1.0.6
	OPENBSD_5_2_BASE:1.1.1.1
	OPENBSD_5_1_BASE:1.1.1.1
	OPENBSD_5_1:1.1.1.1.0.4
	OPENBSD_5_0:1.1.1.1.0.2
	OPENBSD_5_0_BASE:1.1.1.1
	dcoppa_20110531:1.1.1.1
	dcoppa:1.1.1;
locks; strict;
comment	@# @;


1.1
date	2011.05.31.09.19.45;	author dcoppa;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2011.05.31.09.19.45;	author dcoppa;	state Exp;
branches;
next	;


desc
@@



1.1
log
@Initial revision
@
text
@$OpenBSD$

Fixes for python2.5 memory management
(from Debian's patchset for python-pyvorbis)

--- src/pyvorbisinfo.c.orig	Fri Dec 19 08:51:36 2003
+++ src/pyvorbisinfo.c	Fri May 27 10:36:34 2011
@@@@ -72,7 +72,7 @@@@ PyObject*
 py_info_new_from_vi(vorbis_info *vi)
 {
   py_vinfo *newobj;
-  newobj = (py_vinfo *) PyObject_NEW(py_vinfo, 
+  newobj = (py_vinfo *) PyObject_New(py_vinfo, 
                                      &py_vinfo_type);
   newobj->vi = *vi;
   return (PyObject *) newobj;
@@@@ -134,7 +134,7 @@@@ py_ov_info_clear(PyObject *self, PyObject *args)
 static void
 py_ov_info_dealloc(PyObject *self)
 {
-  PyMem_DEL(self);
+  PyObject_Del(self);
 }
 
 #define CMP_RET(x) \
@@@@ -225,17 +225,21 @@@@ static PyObject *
 py_vorbis_analysis_init(PyObject *self, PyObject *args)
 {
   int res;
+  py_dsp *ret;
+  py_vinfo *py_vi = (py_vinfo *) self;
 
-  py_vinfo *ovi_self = (py_vinfo *) self;
-  vorbis_dsp_state vd;
-
   if (!PyArg_ParseTuple(args, ""))
     return NULL;
 
-  if ((res = vorbis_analysis_init(&vd, &ovi_self->vi)))
-    return v_error_from_code(res, "vorbis_analysis_init");
+  ret = (py_dsp *) py_dsp_alloc((PyObject*) py_vi);
+  if (ret == NULL)
+    return NULL;
 
-  return py_dsp_from_dsp(&vd, self);
+  if ((res = vorbis_analysis_init(&ret->vd, &py_vi->vi))) {
+    py_dsp_dealloc((PyObject *) py_vi);
+    return v_error_from_code(res, "vorbis_analysis_init");
+  }
+  return (PyObject*) ret;
 }
 
 /*  
@@@@ -300,7 +304,7 @@@@ static int py_comment_assign(py_vcomment *, 
 static PyObject *py_comment_subscript(py_vcomment *, PyObject *);
 
 static PyMappingMethods py_vcomment_Mapping_Methods = {
-  (inquiry) py_comment_length,
+  (lenfunc) py_comment_length,
   (binaryfunc) py_comment_subscript,
   (objobjargproc) py_comment_assign
 };
@@@@ -360,7 +364,7 @@@@ py_comment_new_from_vc(vorbis_comment *vc, PyObject *p
 {
   py_vcomment *newobj;
 
-  newobj = (py_vcomment *) PyObject_NEW(py_vcomment, 
+  newobj = (py_vcomment *) PyObject_New(py_vcomment, 
                                         &py_vcomment_type);
   newobj->vc = vc;
   newobj->parent = parent;
@@@@ -373,7 +377,7 @@@@ static PyObject *
 py_comment_new_empty(void)
 {
   py_vcomment *newobj;
-  newobj = (py_vcomment *) PyObject_NEW(py_vcomment, 
+  newobj = (py_vcomment *) PyObject_New(py_vcomment, 
                                         &py_vcomment_type);
   if (!newobj)
     return NULL;
@@@@ -418,7 +422,7 @@@@ py_vorbis_comment_dealloc(PyObject *self)
     free(ovc_self->vc);
   }
 
-  PyMem_DEL(self);
+  PyObject_Del(self);
 }
 
 
@@@@ -644,7 +648,8 @@@@ py_comment_keys(PyObject *self, PyObject *args)
 static PyObject *
 py_comment_items(PyObject *self, PyObject *args)
 {
-  int curitem, curpos, j;
+  Py_ssize_t curitem, curpos;
+  int j;
   PyObject *key, *val, *curval, *tuple;
   PyObject *retlist;
   PyObject *dict;
@@@@ -682,7 +687,8 @@@@ py_comment_items(PyObject *self, PyObject *args)
 static PyObject *
 py_comment_values(PyObject *self, PyObject *args)
 {
-  int curitem, curpos, j;
+  Py_ssize_t curitem, curpos;
+  int j;
   PyObject *key, *val, *curval;
   PyObject *retlist;
   PyObject *dict;
@@@@ -942,7 +948,7 @@@@ py_comment_new(PyObject *self, PyObject *args)
   vcomment = create_comment_from_dict(dict);
   if (!vcomment)
     return NULL;
-  pvc = (py_vcomment *) PyObject_NEW(py_vcomment,
+  pvc = (py_vcomment *) PyObject_New(py_vcomment,
                                      &py_vcomment_type);
   if (!pvc) {
     vorbis_comment_clear(vcomment);
@@@@ -999,6 +1005,7 @@@@ py_comment_as_dict(PyObject *self, PyObject *args)
 #if PY_UNICODE
       item = PyUnicode_DecodeUTF8(val, vallen, NULL);
       if (!item) {
+        PyErr_Clear();
         /* To deal with non-UTF8 comments (against the standard) */
         item = PyString_FromStringAndSize(val, vallen); 
       } 
@


1.1.1.1
log
@Import py-vorbis, a set of Python bindings for the vorbis libraries.
With fixes from Debian's patchset for python-pyvorbis.

OK landry@@
@
text
@@
