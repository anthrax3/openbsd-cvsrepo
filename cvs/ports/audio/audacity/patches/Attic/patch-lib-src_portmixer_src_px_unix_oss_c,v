head	1.3;
access;
symbols
	OPENBSD_4_6:1.2.0.8
	OPENBSD_4_6_BASE:1.2
	OPENBSD_4_5:1.2.0.6
	OPENBSD_4_5_BASE:1.2
	OPENBSD_4_4:1.2.0.4
	OPENBSD_4_4_BASE:1.2
	OPENBSD_4_3:1.2.0.2
	OPENBSD_4_3_BASE:1.2;
locks; strict;
comment	@# @;


1.3
date	2009.10.28.18.40.13;	author jakemsr;	state dead;
branches;
next	1.2;

1.2
date	2007.12.08.11.08.38;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2007.11.23.10.07.41;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.3
log
@update to 1.3.9.  mostly bugfixes.
ok sthen@@
@
text
@$OpenBSD: patch-lib-src_portmixer_src_px_unix_oss_c,v 1.2 2007/12/08 11:08:38 ajacoutot Exp $
--- lib-src/portmixer/src/px_unix_oss.c.orig	Sat Nov 24 12:28:16 2007
+++ lib-src/portmixer/src/px_unix_oss.c	Sat Nov 24 12:31:44 2007
@@@@ -41,8 +41,12 @@@@
 #elif defined(__FreeBSD__)
 #include <sys/soundcard.h>
 #else
+#if defined(__OpenBSD__)
+#include <soundcard.h>
+#else
 #include <machine/soundcard.h> /* JH20010905 */
 #endif
+#endif
 
 #include <stdio.h>
 #include <stdlib.h>
@@@@ -52,9 +56,12 @@@@
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <sys/ioctl.h>
+#include <ctype.h>
 
 #include "portaudio.h"
+#ifdef PX_USE_PA_V18
 #include "pa_unix_oss.h"
+#endif
 
 #include "portmixer.h"
 #include "px_mixer.h"
@@@@ -97,7 +104,7 @@@@ static int open_mixer(PxDev *dev, int cmd)
    int i;
    int id = 0;
 
-   for (i = strlen(dev->name) - 1; i >= 0; i++) {
+   for (i = strlen(dev->name) - 1; i >= 0; i--) {
       if (!isdigit(dev->name[i])) {
          break;
       }
@@@@ -108,11 +115,9 @@@@ static int open_mixer(PxDev *dev, int cmd)
       return -1;
    }
 
-   strcpy(name, MIXER_NAME_BASE);
-   if (id == 0)
-      name[strlen(MIXER_NAME_BASE)] = 0;
-   else
-      name[strlen(MIXER_NAME_BASE)] = '0' + (id - 1);
+   strlcpy(name, MIXER_NAME_BASE, sizeof(name));
+   if (id != 0)
+      strlcat(name, &dev->name[i + 1], sizeof(name));
 
    do {
       dev->fd = open(name, O_RDWR);
@@@@ -160,7 +165,11 @@@@ int OpenMixer_Unix_OSS(px_mixer *Px, int index)
    info->playback.num = 0;   
    
    do {
+#ifdef PX_USE_PA_V18
       info->capture.name = PaOSS_GetStreamInputDevice(Px->pa_stream);
+#else
+      info->capture.name = (Pa_GetDeviceInfo(index))->name;
+#endif
 
       if (info->capture.name) {
          if (!open_mixer(&info->capture, SOUND_MIXER_READ_RECMASK)) {
@@@@ -168,7 +177,11 @@@@ int OpenMixer_Unix_OSS(px_mixer *Px, int index)
          }
       }
       
+#ifdef PX_USE_PA_V18
       info->playback.name = PaOSS_GetStreamOutputDevice(Px->pa_stream);
+#else
+      info->playback.name = (Pa_GetDeviceInfo(index))->name;
+#endif
       if (info->playback.name) {
          if (!open_mixer(&info->playback, SOUND_MIXER_READ_DEVMASK)) {
             break;
@


1.2
log
@- update to 1.3.4

ok jakemsr@@
@
text
@d1 1
a1 1
$OpenBSD$
@


1.1
log
@- make it use portaudio v19; i.e. full-duplex support!

committing on behalf of jakemsr@@ who did all the work
@
text
@d2 2
a3 2
--- lib-src/portmixer/src/px_unix_oss.c.orig	Thu May 17 21:55:50 2007
+++ lib-src/portmixer/src/px_unix_oss.c	Sun Oct 28 14:39:03 2007
d54 1
a54 1
@@@@ -161,14 +166,22 @@@@ int OpenMixer_Unix_OSS(px_mixer *Px, int index)
d59 1
a59 1
       info->capture.name = PaOSS_GetInputDevice(Px->pa_stream);
d63 1
d66 1
a66 1
             break;
d71 1
a71 1
       info->playback.name = PaOSS_GetOutputDevice(Px->pa_stream);
@

