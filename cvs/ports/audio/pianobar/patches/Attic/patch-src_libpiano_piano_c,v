head	1.11;
access;
symbols
	OPENBSD_5_4:1.10.0.2
	OPENBSD_5_4_BASE:1.10;
locks; strict;
comment	@# @;


1.11
date	2013.09.23.08.40.23;	author dcoppa;	state dead;
branches;
next	1.10;

1.10
date	2013.07.10.16.40.47;	author dcoppa;	state Exp;
branches;
next	1.9;

1.9
date	2012.06.12.14.45.06;	author dcoppa;	state dead;
branches;
next	1.8;

1.8
date	2012.06.08.11.01.20;	author dcoppa;	state Exp;
branches;
next	1.7;

1.7
date	2012.05.28.09.47.00;	author dcoppa;	state Exp;
branches;
next	1.6;

1.6
date	2012.01.20.13.04.16;	author dcoppa;	state dead;
branches;
next	1.5;

1.5
date	2012.01.16.13.27.09;	author dcoppa;	state Exp;
branches;
next	1.4;

1.4
date	2011.12.13.09.10.09;	author dcoppa;	state dead;
branches;
next	1.3;

1.3
date	2011.12.08.18.27.19;	author dcoppa;	state Exp;
branches;
next	1.2;

1.2
date	2011.09.22.14.28.13;	author dcoppa;	state dead;
branches;
next	1.1;

1.1
date	2011.09.22.09.22.41;	author dcoppa;	state Exp;
branches;
next	;


desc
@@


1.11
log
@Update to release 2013.09.15
@
text
@$OpenBSD: patch-src_libpiano_piano_c,v 1.10 2013/07/10 16:40:47 dcoppa Exp $

commit f6df7d7e510f2d8879ec54dce32fee2b691dc32d
Author: Lars-Dominik Braun <lars@@6xq.net>
Date:   Tue Jul 2 17:13:47 2013 +0200

piano: Check for libgcrypt errors

Fixes mysterious segfaults from issue #369 and #293.

--- src/libpiano/piano.c.orig	Sun May 19 12:58:18 2013
+++ src/libpiano/piano.c	Wed Jul 10 18:20:12 2013
@@@@ -40,7 +40,7 @@@@ THE SOFTWARE.
  *	@@param piano handle
  *	@@return nothing
  */
-void PianoInit (PianoHandle_t *ph, const char *partnerUser,
+PianoReturn_t PianoInit (PianoHandle_t *ph, const char *partnerUser,
 		const char *partnerPassword, const char *device, const char *inkey,
 		const char *outkey) {
 	memset (ph, 0, sizeof (*ph));
@@@@ -48,15 +48,25 @@@@ void PianoInit (PianoHandle_t *ph, const char *partner
 	ph->partner.password = strdup (partnerPassword);
 	ph->partner.device = strdup (device);
 
-	gcry_cipher_open (&ph->partner.in, GCRY_CIPHER_BLOWFISH,
-			GCRY_CIPHER_MODE_ECB, 0);
-	gcry_cipher_setkey (ph->partner.in, (const unsigned char *) inkey,
-			strlen (inkey));
+	if (gcry_cipher_open (&ph->partner.in, GCRY_CIPHER_BLOWFISH,
+			GCRY_CIPHER_MODE_ECB, 0) != GPG_ERR_NO_ERROR) {
+		return PIANO_RET_GCRY_ERR;
+	}
+	if (gcry_cipher_setkey (ph->partner.in, (const unsigned char *) inkey,
+			strlen (inkey)) != GPG_ERR_NO_ERROR) {
+		return PIANO_RET_GCRY_ERR;
+	}
 
-	gcry_cipher_open (&ph->partner.out, GCRY_CIPHER_BLOWFISH,
-			GCRY_CIPHER_MODE_ECB, 0);
-	gcry_cipher_setkey (ph->partner.out, (const unsigned char *) outkey,
-			strlen (outkey));
+	if (gcry_cipher_open (&ph->partner.out, GCRY_CIPHER_BLOWFISH,
+			GCRY_CIPHER_MODE_ECB, 0) != GPG_ERR_NO_ERROR) {
+		return PIANO_RET_GCRY_ERR;
+	}
+	if (gcry_cipher_setkey (ph->partner.out, (const unsigned char *) outkey,
+			strlen (outkey)) != GPG_ERR_NO_ERROR) {
+		return PIANO_RET_GCRY_ERR;
+	}
+
+	return PIANO_RET_OK;
 }
 
 /*	destroy artist linked list
@@@@ -256,6 +266,10 @@@@ const char *PianoErrorToStr (PianoReturn_t ret) {
 
 		case PIANO_RET_QUALITY_UNAVAILABLE:
 			return "Selected audio quality is not available.";
+			break;
+
+		case PIANO_RET_GCRY_ERR:
+			return "libgcrypt initialization failed.";
 			break;
 
 		/* pandora error messages */
@


1.10
log
@piano: Check for libgcrypt errors.
This fixes some rare segfaults (see issues #369 and #293).

From upstream git commit f6df7d7e510f2d8879ec54dce32fee2b691dc32d
@
text
@d1 1
a1 1
$OpenBSD$
@


1.9
log
@Update to snapshot 2012.06.10, chasing changes in pandora's api.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_libpiano_piano_c,v 1.8 2012/06/08 11:01:20 dcoppa Exp $
d3 3
a5 3
Fix ambiguous error message "Invalid Partner Login" on wrong
email address/password failure
(upstream git commit 81bf363ac69e0036562434ca0e7153c3e624c8c3)
d7 1
a7 3
More error messages
(upstream git commit 2d9b7bfd3395148419da27cd3c98de470a2d245b
 and commit b32348d88f700f4a3b5fb3a95f7ee40336952230)
d9 29
a37 5
--- src/libpiano/piano.c.orig	Sun May  6 16:33:54 2012
+++ src/libpiano/piano.c	Fri Jun  8 12:38:13 2012
@@@@ -250,6 +250,10 @@@@ const char *PianoErrorToStr (PianoReturn_t ret) {
 			return "Out of memory.";
 			break;
d39 12
a50 3
+		case PIANO_RET_INVALID_LOGIN:
+			return "Wrong email address or password.";
+			break;
d52 5
a56 4
 		/* pandora error messages */
 		case PIANO_RET_P_INTERNAL:
 			return "Internal error.";
@@@@ -281,6 +285,19 @@@@ const char *PianoErrorToStr (PianoReturn_t ret) {
d58 2
a59 2
 		case PIANO_RET_P_INVALID_PARTNER_LOGIN:
 			return "Invalid partner login.";
d62 2
a63 11
+		case PIANO_RET_P_LICENSING_RESTRICTIONS:
+			return "Pandora is not available in your country. "
+					"Set up a control proxy (see manpage).";
+			break;
+
+		case PIANO_RET_P_PARTNER_NOT_AUTHORIZED:
+			return "Invalid partner credentials.";
+			break;
+
+		case PIANO_RET_P_LISTENER_NOT_AUTHORIZED:
+			return "Listener not authorized.";
d66 1
a66 1
 		default:
@


1.8
log
@properly handle more error messages.
from upstream git.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_libpiano_piano_c,v 1.7 2012/05/28 09:47:00 dcoppa Exp $
@


1.7
log
@Add libgcrypt CFLAGS to %.o target
(upstream git commit db4c66b2956a4da2745f16131fe573962c3fcbfb)

Fix ambiguous error message "Invalid Partner Login" on wrong
email address/password failure
(upstream git commit 81bf363ac69e0036562434ca0e7153c3e624c8c3)

Move mutex initalization to main thread
(upstream git commit ed7b2597a439c27e60d0b4cec85e801c9099173c)
@
text
@d1 1
a1 1
$OpenBSD$
d7 4
d12 1
a12 1
+++ src/libpiano/piano.c	Mon May 28 10:51:30 2012
d24 20
@


1.6
log
@Update to the latest snapshot from upstream git to unbreak pianobar
after pandora.com's API changes.
@
text
@d1 10
a10 5
$OpenBSD: patch-src_libpiano_piano_c,v 1.5 2012/01/16 13:27:09 dcoppa Exp $
--- src/libpiano/piano.c.orig	Tue Jan 10 22:54:49 2012
+++ src/libpiano/piano.c	Mon Jan 16 14:24:02 2012
@@@@ -1230,6 +1230,10 @@@@ const char *PianoErrorToStr (PianoReturn_t ret) {
 			return "Last seed cannot be removed.";
d13 2
a14 2
+		case PIANO_RET_EXCESSIVE_ACTIVITY:
+			return "Excessive activity.";
d17 3
a19 3
 		default:
 			return "No error message available.";
 			break;
@


1.5
log
@Update to pianobar-2012.01.10
@
text
@d1 1
a1 1
$OpenBSD$
@


1.4
log
@Update to pianobar-2011.12.11
@
text
@d1 6
a6 13
$OpenBSD: patch-src_libpiano_piano_c,v 1.3 2011/12/08 18:27:19 dcoppa Exp $

Fix memset (upstream git commit 2da38556d614b9bc969f65b3683c2ce6eb99e6bc)

--- src/libpiano/piano.c.orig	Thu Dec  8 19:20:36 2011
+++ src/libpiano/piano.c	Thu Dec  8 19:21:32 2011
@@@@ -92,7 +92,7 @@@@ void PianoDestroyStation (PianoStation_t *station) {
 	free (station->name);
 	free (station->id);
 	free (station->seedId);
-	memset (station, 0, sizeof (station));
+	memset (station, 0, sizeof (*station));
 }
d8 7
a14 1
 /*	free complete station list
@


1.3
log
@Fix memset (upstream git commit 2da38556d614b9bc969f65b3683c2ce6eb99e6bc)
@
text
@d1 1
a1 1
$OpenBSD$
@


1.2
log
@Update to pianobar-2011.09.22
@
text
@d1 13
a13 6
$OpenBSD: patch-src_libpiano_piano_c,v 1.1 2011/09/22 09:22:41 dcoppa Exp $
--- src/libpiano/piano.c.orig	Thu Sep 22 10:58:36 2011
+++ src/libpiano/piano.c	Thu Sep 22 10:58:55 2011
@@@@ -39,7 +39,7 @@@@ THE SOFTWARE.
 #include "crypt.h"
 #include "config.h"
d15 1
a15 5
-#define PIANO_PROTOCOL_VERSION "31"
+#define PIANO_PROTOCOL_VERSION "32"
 #define PIANO_RPC_HOST "www.pandora.com"
 #define PIANO_RPC_PORT "80"
 #define PIANO_RPC_PATH "/radio/xmlrpc/v" PIANO_PROTOCOL_VERSION "?"
@


1.1
log
@Unbreak: pandora.com changed api (again)
@
text
@d1 1
a1 1
$OpenBSD$
@

