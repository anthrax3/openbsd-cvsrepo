head	1.20;
access;
symbols
	OPENBSD_5_8:1.19.0.4
	OPENBSD_5_8_BASE:1.19
	OPENBSD_5_4:1.14.0.2
	OPENBSD_5_4_BASE:1.14
	OPENBSD_5_2:1.11.0.2
	OPENBSD_5_2_BASE:1.11
	OPENBSD_4_9:1.1.0.2
	OPENBSD_4_9_BASE:1.1;
locks; strict;
comment	@# @;


1.20
date	2015.08.26.05.56.22;	author dcoppa;	state dead;
branches;
next	1.19;
commitid	y9wqGRrrECd7SlET;

1.19
date	2015.03.20.14.59.36;	author dcoppa;	state Exp;
branches;
next	1.18;
commitid	tzaKvkdfFo0uzMlR;

1.18
date	2014.05.20.14.51.46;	author dcoppa;	state dead;
branches;
next	1.17;

1.17
date	2014.03.27.10.13.14;	author dcoppa;	state Exp;
branches;
next	1.16;

1.16
date	2014.03.27.09.28.06;	author dcoppa;	state Exp;
branches;
next	1.15;

1.15
date	2013.09.23.08.40.24;	author dcoppa;	state dead;
branches;
next	1.14;

1.14
date	2013.07.10.16.40.48;	author dcoppa;	state Exp;
branches;
next	1.13;

1.13
date	2012.12.05.12.20.43;	author dcoppa;	state dead;
branches;
next	1.12;

1.12
date	2012.09.18.12.35.03;	author dcoppa;	state Exp;
branches;
next	1.11;

1.11
date	2012.07.06.08.32.13;	author dcoppa;	state Exp;
branches;
next	1.10;

1.10
date	2012.06.12.14.45.06;	author dcoppa;	state dead;
branches;
next	1.9;

1.9
date	2012.05.28.09.47.00;	author dcoppa;	state Exp;
branches;
next	1.8;

1.8
date	2012.04.20.08.22.34;	author dcoppa;	state dead;
branches;
next	1.7;

1.7
date	2012.04.11.08.41.58;	author dcoppa;	state Exp;
branches;
next	1.6;

1.6
date	2012.01.20.13.04.16;	author dcoppa;	state dead;
branches;
next	1.5;

1.5
date	2012.01.16.13.27.09;	author dcoppa;	state Exp;
branches;
next	1.4;

1.4
date	2011.09.22.14.28.13;	author dcoppa;	state dead;
branches;
next	1.3;

1.3
date	2011.09.22.09.22.41;	author dcoppa;	state Exp;
branches;
next	1.2;

1.2
date	2011.03.14.12.28.57;	author dcoppa;	state dead;
branches;
next	1.1;

1.1
date	2011.01.05.14.06.51;	author dcoppa;	state Exp;
branches;
next	;


desc
@@


1.20
log
@
Update to a newer snapshot (2015.08.04)
@
text
@$OpenBSD: patch-src_main_c,v 1.19 2015/03/20 14:59:36 dcoppa Exp $

commit 310900e4be52d11388792d776d9f6b89380bbecd
Author: Lars-Dominik Braun <lars@@6xq.net>
Date:   Sat Mar 7 16:20:26 2015 +0100

player: Ignore volume change before playback started

--- src/main.c.orig	Sun Sep 28 08:17:29 2014
+++ src/main.c	Fri Mar 20 09:45:26 2015
@@@@ -292,7 +292,7 @@@@ static void BarMainStartPlayback (BarApp_t *app, pthre
 
 		/* prevent race condition, mode must _not_ be DEAD if
 		 * thread has been started */
-		app->player.mode = PLAYER_STARTING;
+		app->player.mode = PLAYER_WAITING;
 		/* start player */
 		pthread_create (playerThread, NULL, BarPlayerThread,
 				&app->player);
@


1.19
log
@
Merge bugfixes from upstream:

Fix upcoming songs assertion failure
(git commit 1cd5c5ec77ea43088982a439b58499be87c62087)

player: Ignore volume change before playback started
(git commit 310900e4be52d11388792d776d9f6b89380bbecd)

player: Fix initial track volume
(git commit 0005ea3873202ddefaae6466a932c159c08fd1c3)
@
text
@d1 1
a1 1
$OpenBSD$
@


1.18
log
@
Update to 2014.04.22 snapshot.

It now uses ffmpeg instead of faad+libmad.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_main_c,v 1.17 2014/03/27 10:13:14 dcoppa Exp $
d3 1
a3 1
commit 90f6ffbdb7c7cc07cb02b69fcfb3a3844f0180b7
d5 1
a5 1
Date:   Fri Mar 14 11:47:26 2014 +0100
d7 1
a7 1
piano: Request track length
d9 3
a11 31
The returned length is used as first length estimate before enough
audio data arrives to show the real length and for the eventcmd
API.

commit ebfd7d45c6b8eb5b2a1ee6e97a3f21f5f5bf9b43
Author: Cody P Schafer <devel@@codyps.com>
Date:   Thu Mar 13 11:14:21 2014 -0700

fix warnings now noted due to format string checking

--- src/main.c.orig	Sun Sep 15 15:54:04 2013
+++ src/main.c	Thu Mar 27 10:30:08 2014
@@@@ -268,6 +268,7 @@@@ static void BarMainStartPlayback (BarApp_t *app, pthre
 		app->player.scale = BarPlayerCalcScale (app->player.gain + app->settings.volume);
 		app->player.audioFormat = app->playlist->audioFormat;
 		app->player.settings = &app->settings;
+		app->player.songDuration = app->playlist->length * 1000;
 		pthread_mutex_init (&app->player.pauseMutex, NULL);
 		pthread_cond_init (&app->player.pauseCond, NULL);
 
@@@@ -328,7 +329,7 @@@@ static void BarMainPrintTime (BarApp_t *app) {
 		sign = POSITIVE;
 		songRemaining = -songRemaining;
 	}
-	BarUiMsg (&app->settings, MSG_TIME, "%c%02i:%02i/%02i:%02i\r",
+	BarUiMsg (&app->settings, MSG_TIME, "%c%02i:%02i/%02li:%02li\r",
 			(sign == POSITIVE ? '+' : '-'),
 			songRemaining / 60, songRemaining % 60,
 			app->player.songDuration / BAR_PLAYER_MS_TO_S_FACTOR / 60,
@@@@ -388,8 +389,7 @@@@ static void BarMainLoop (BarApp_t *app) {
 		BarMainHandleUserInput (app);
d13 7
a19 7
 		/* show time */
-		if (app->player.mode >= PLAYER_SAMPLESIZE_INITIALIZED &&
-				app->player.mode < PLAYER_FINISHED_PLAYBACK) {
+		if (app->player.mode < PLAYER_FINISHED_PLAYBACK) {
 			BarMainPrintTime (app);
 		}
 	}
@


1.17
log
@
Bugfixes from upstream:

libpiano: Request track length
(upstream git commit 90f6ffbdb7c7cc07cb02b69fcfb3a3844f0180b7)

libwaitress: Increase the receive buffer
(upstream git commit 8e685c992516834e35bcccea1f61c39a9d847e2f)
@
text
@d1 1
a1 1
$OpenBSD: patch-src_main_c,v 1.16 2014/03/27 09:28:06 dcoppa Exp $
@


1.16
log
@
format string fixes from upstream
(git commit ebfd7d45c6b8eb5b2a1ee6e97a3f21f5f5bf9b43)
@
text
@d1 11
a11 1
$OpenBSD$
d20 10
a29 2
+++ src/main.c	Thu Mar 27 10:18:13 2014
@@@@ -328,7 +328,7 @@@@ static void BarMainPrintTime (BarApp_t *app) {
d38 10
@


1.15
log
@Update to release 2013.09.15
@
text
@d1 1
a1 1
$OpenBSD: patch-src_main_c,v 1.14 2013/07/10 16:40:48 dcoppa Exp $
d3 3
a5 3
commit f6df7d7e510f2d8879ec54dce32fee2b691dc32d
Author: Lars-Dominik Braun <lars@@6xq.net>
Date:   Tue Jul 2 17:13:47 2013 +0200
d7 1
a7 1
piano: Check for libgcrypt errors
d9 11
a19 21
Fixes mysterious segfaults from issue #369 and #293.

--- src/main.c.orig	Sun May 19 12:58:18 2013
+++ src/main.c	Wed Jul 10 18:20:12 2013
@@@@ -424,8 +424,14 @@@@ int main (int argc, char **argv) {
 	BarSettingsInit (&app.settings);
 	BarSettingsRead (&app.settings);
 
-	PianoInit (&app.ph, app.settings.partnerUser, app.settings.partnerPassword,
-			app.settings.device, app.settings.inkey, app.settings.outkey);
+	PianoReturn_t pret;
+	if ((pret = PianoInit (&app.ph, app.settings.partnerUser,
+			app.settings.partnerPassword, app.settings.device,
+			app.settings.inkey, app.settings.outkey)) != PIANO_RET_OK) {
+		BarUiMsg (&app.settings, MSG_ERR, "Initialization failed:"
+				" %s\n", PianoErrorToStr (pret));
+		return 0;
+	}
 
 	BarUiMsg (&app.settings, MSG_NONE,
 			"Welcome to " PACKAGE " (" VERSION ")! ");
@


1.14
log
@piano: Check for libgcrypt errors.
This fixes some rare segfaults (see issues #369 and #293).

From upstream git commit f6df7d7e510f2d8879ec54dce32fee2b691dc32d
@
text
@d1 1
a1 1
$OpenBSD$
@


1.13
log
@Update to pianobar-2012.12.01
@
text
@d1 1
a1 1
$OpenBSD: patch-src_main_c,v 1.12 2012/09/18 12:35:03 dcoppa Exp $
d3 3
a5 3
Fix history memory leak
With 'history = 0' playlist items are discarded, but not freed
(upstream git commit e3d8f497baaf02daeddb060cd986681d0ee208de)
d7 23
a29 10
--- src/main.c.orig	Tue Sep 18 14:22:12 2012
+++ src/main.c	Tue Sep 18 14:22:53 2012
@@@@ -301,6 +301,7 @@@@ static void BarMainLoop (BarApp_t *app) {
 			if (app->playlist != NULL) {
 				PianoSong_t *histsong = app->playlist;
 				app->playlist = app->playlist->next;
+				histsong->next = NULL;
 				BarUiHistoryPrepend (app, histsong);
 			}
 			if (app->playlist == NULL) {
@


1.12
log
@Update to pianobar-2012.09.07
@
text
@d1 1
a1 1
$OpenBSD: patch-src_main_c,v 1.11 2012/07/06 08:32:13 dcoppa Exp $
@


1.11
log
@
Properly initialize libgcrypt
(upstream git commit 96db841a16670b52fa462337c657c6dc6bd2844a)

Work around libgcrypt deprecation warnings. See:
http://lists.gnupg.org/pipermail/gcrypt-devel/2011-July/001830.html
@
text
@d1 1
a1 1
$OpenBSD$
d3 3
a5 2
Properly initialize libgcrypt
(upstream git commit 96db841a16670b52fa462337c657c6dc6bd2844a)
d7 10
a16 12
--- src/main.c.orig	Fri Jul  6 09:59:58 2012
+++ src/main.c	Fri Jul  6 10:00:50 2012
@@@@ -343,6 +343,9 @@@@ int main (int argc, char **argv) {
 
 	/* init some things */
 	ao_initialize ();
+	gcry_check_version (NULL);
+	gcry_control (GCRYCTL_DISABLE_SECMEM, 0);
+	gcry_control (GCRYCTL_INITIALIZATION_FINISHED, 0);
 	gnutls_global_init ();
 
 	BarSettingsInit (&app.settings);
@


1.10
log
@Update to snapshot 2012.06.10, chasing changes in pandora's api.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_main_c,v 1.9 2012/05/28 09:47:00 dcoppa Exp $
d3 2
a4 2
Move mutex initalization to main thread
(upstream git commit ed7b2597a439c27e60d0b4cec85e801c9099173c)
d6 3
a8 7
--- src/main.c.orig	Sun May  6 16:33:54 2012
+++ src/main.c	Mon May 28 10:51:30 2012
@@@@ -206,6 +206,7 @@@@ static void BarMainStartPlayback (BarApp_t *app, pthre
 		app->player.scale = BarPlayerCalcScale (app->player.gain + app->settings.volume);
 		app->player.audioFormat = app->playlist->audioFormat;
 		app->player.settings = &app->settings;
+		pthread_mutex_init (&app->player.pauseMutex, NULL);
d10 6
a15 7
 		/* throw event */
 		BarUiStartEventCmd (&app->settings, "songstart",
@@@@ -233,6 +234,7 @@@@ static void BarMainPlayerCleanup (BarApp_t *app, pthre
 	/* FIXME: pthread_join blocks everything if network connection
 	 * is hung up e.g. */
 	pthread_join (*playerThread, &threadRet);
+	pthread_mutex_destroy (&app->player.pauseMutex);
d17 1
a17 2
 	/* don't continue playback if thread reports error */
 	if (threadRet != (void *) PLAYER_RET_OK) {
@


1.9
log
@Add libgcrypt CFLAGS to %.o target
(upstream git commit db4c66b2956a4da2745f16131fe573962c3fcbfb)

Fix ambiguous error message "Invalid Partner Login" on wrong
email address/password failure
(upstream git commit 81bf363ac69e0036562434ca0e7153c3e624c8c3)

Move mutex initalization to main thread
(upstream git commit ed7b2597a439c27e60d0b4cec85e801c9099173c)
@
text
@d1 1
a1 1
$OpenBSD$
@


1.8
log
@Roll new distfile and gc local patches
@
text
@d1 1
a1 1
$OpenBSD: patch-src_main_c,v 1.7 2012/04/11 08:41:58 dcoppa Exp $
d3 2
a4 4
Warn if ctl is not a fifo.
Ordinary files are not supported and cause problems, so close the
fd and print a warning instead.
(upstream git commit ed6d013054f589f2999926b02f4ac6dc76c7fe91)
d6 18
a23 25
--- src/main.c.orig	Wed Apr 11 10:33:34 2012
+++ src/main.c	Wed Apr 11 10:32:20 2012
@@@@ -369,9 +369,19 @@@@ int main (int argc, char **argv) {
 	assert (sizeof (app.input.fds) / sizeof (*app.input.fds) >= 2);
 	app.input.fds[1] = open (app.settings.fifo, O_RDWR);
 	if (app.input.fds[1] != -1) {
-		FD_SET(app.input.fds[1], &app.input.set);
-		BarUiMsg (&app.settings, MSG_INFO, "Control fifo at %s opened\n",
-				app.settings.fifo);
+		struct stat s;
+
+		/* check for file type, must be fifo */
+		fstat (app.input.fds[1], &s);
+		if (!S_ISFIFO (s.st_mode)) {
+			BarUiMsg (&app.settings, MSG_ERR, "File at %s is not a fifo\n", app.settings.fifo);
+			close (app.input.fds[1]);
+			app.input.fds[1] = -1;
+		} else {
+			FD_SET(app.input.fds[1], &app.input.set);
+			BarUiMsg (&app.settings, MSG_INFO, "Control fifo at %s opened\n",
+					app.settings.fifo);
+		}
 	}
 	app.input.maxfd = app.input.fds[0] > app.input.fds[1] ? app.input.fds[0] :
 			app.input.fds[1];
@


1.7
log
@Warn if ctl is not a fifo.
Ordinary files are not supported and cause problems, so close the
fd and print a warning instead.
(upstream git commit ed6d013054f589f2999926b02f4ac6dc76c7fe91)
@
text
@d1 1
a1 1
$OpenBSD$
@


1.6
log
@Update to the latest snapshot from upstream git to unbreak pianobar
after pandora.com's API changes.
@
text
@d1 29
a29 11
$OpenBSD: patch-src_main_c,v 1.5 2012/01/16 13:27:09 dcoppa Exp $
--- src/main.c.orig	Tue Jan 10 22:54:49 2012
+++ src/main.c	Mon Jan 16 14:20:47 2012
@@@@ -103,7 +103,8 @@@@ static void BarMainGetLoginCredentials (BarSettings_t 
 		char passBuf[100];
 		BarUiMsg (settings, MSG_QUESTION, "Password: ");
 		BarReadlineStr (passBuf, sizeof (passBuf), input, BAR_RL_NOECHO);
-		write (STDIN_FILENO, "\n", 1);
+		/* write missing newline */
+		puts ("");
 		settings->password = strdup (passBuf);
d31 2
a32 9
 }
@@@@ -356,7 +357,6 @@@@ int main (int argc, char **argv) {
 
 	WaitressInit (&app.waith);
 	app.waith.url.host = strdup (PIANO_RPC_HOST);
-	app.waith.url.tls = true;
 	app.waith.tlsFingerprint = app.settings.tlsFingerprint;
 
 	/* init fds */
@


1.5
log
@Update to pianobar-2012.01.10
@
text
@d1 1
a1 1
$OpenBSD$
@


1.4
log
@Update to pianobar-2011.09.22
@
text
@d1 11
a11 11
$OpenBSD: patch-src_main_c,v 1.3 2011/09/22 09:22:41 dcoppa Exp $
--- src/main.c.orig	Thu Sep 22 10:57:52 2011
+++ src/main.c	Thu Sep 22 10:58:21 2011
@@@@ -92,7 +92,7 @@@@ static void BarMainGetLoginCredentials (BarSettings_t 
 		BarReadlineFds_t *input) {
 	if (settings->username == NULL) {
 		char nameBuf[100];
-		BarUiMsg (settings, MSG_QUESTION, "Username: ");
+		BarUiMsg (settings, MSG_QUESTION, "Email: ");
 		BarReadlineStr (nameBuf, sizeof (nameBuf), input, BAR_RL_DEFAULT);
 		settings->username = strdup (nameBuf);
d13 9
@


1.3
log
@Unbreak: pandora.com changed api (again)
@
text
@d1 1
a1 1
$OpenBSD$
@


1.2
log
@Update to pianobar-2011.01.24
@
text
@d1 12
a12 17
$OpenBSD: patch-src_main_c,v 1.1 2011/01/05 14:06:51 dcoppa Exp $

Fix high cpu usage if stdin is /dev/null (i.e. when started with "nohup")

--- src/main.c.orig	Sat Nov  6 13:38:14 2010
+++ src/main.c	Wed Jan  5 14:46:15 2011
@@@@ -317,6 +317,10 @@@@ int main (int argc, char **argv) {
 				curFd = ctlFd;
 			}
 			buf = fgetc (curFd);
+			if (buf == EOF) {
+			  /* select() is going wild if fdset contains EOFed fd's */
+			  FD_CLR (fileno (curFd), &readSet);
+			}
 
 			size_t i;
 			for (i = 0; i < BAR_KS_COUNT; i++) {
@


1.1
log
@Fix high cpu usage when started with nohup (backported from upstream git)
Fix audio playback on big-endian machines (from upstream git)
Sanitize CFLAGS
@
text
@d1 1
a1 1
$OpenBSD$
@

