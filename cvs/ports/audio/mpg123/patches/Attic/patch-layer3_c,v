head	1.5;
access;
symbols
	OPENBSD_4_4:1.4.0.10
	OPENBSD_4_4_BASE:1.4
	OPENBSD_4_3:1.4.0.8
	OPENBSD_4_3_BASE:1.4
	OPENBSD_4_2:1.4.0.6
	OPENBSD_4_2_BASE:1.4
	OPENBSD_4_1:1.4.0.4
	OPENBSD_4_1_BASE:1.4
	OPENBSD_4_0:1.4.0.2
	OPENBSD_4_0_BASE:1.4
	OPENBSD_3_9:1.3.0.6
	OPENBSD_3_9_BASE:1.3
	OPENBSD_3_8:1.3.0.4
	OPENBSD_3_8_BASE:1.3
	OPENBSD_3_7:1.3.0.2
	OPENBSD_3_7_BASE:1.3
	OPENBSD_3_6:1.2.0.4
	OPENBSD_3_6_BASE:1.2
	OPENBSD_3_5:1.2.0.2
	OPENBSD_3_5_BASE:1.2
	OPENBSD_3_4:1.1.0.2
	OPENBSD_3_4_BASE:1.1;
locks; strict;
comment	@# @;


1.5
date	2008.11.11.20.35.49;	author naddy;	state dead;
branches;
next	1.4;

1.4
date	2006.05.29.19.34.59;	author bernd;	state Exp;
branches;
next	1.3;

1.3
date	2004.09.15.20.38.07;	author brad;	state Exp;
branches
	1.3.4.1
	1.3.6.1;
next	1.2;

1.2
date	2004.03.07.19.54.10;	author pvalchev;	state Exp;
branches;
next	1.1;

1.1
date	2003.07.21.20.24.42;	author pvalchev;	state Exp;
branches;
next	;

1.3.4.1
date	2006.06.01.16.14.02;	author sturm;	state Exp;
branches;
next	;

1.3.6.1
date	2006.06.01.16.13.45;	author sturm;	state Exp;
branches;
next	;


desc
@@


1.5
log
@From scratch newly created port of mpg123 1.6.1 with sndio backend.
Help from ratchov@@, tested by many, ok sthen@@
@
text
@$OpenBSD: patch-layer3_c,v 1.4 2006/05/29 19:34:59 bernd Exp $
--- layer3.c.orig	Wed Apr 21 17:25:18 1999
+++ layer3.c	Mon May 29 10:55:42 2006
@@@@ -608,12 +608,21 @@@@ static int pretab2[22] = {0,0,0,0,0,0,0,
  * Dequantize samples (includes huffman decoding)
  */
 /* 24 is enough because tab13 has max. a 19 bit huffvector */
+#if defined(__LP64__)
+#define BITSHIFT ((sizeof(int)-1)*8)
+#define REFRESH_MASK \
+  while(num < BITSHIFT) { \
+    mask |= getbyte()<<(BITSHIFT-num); \
+    num += 8; \
+    part2remain -= 8; }
+#else
 #define BITSHIFT ((sizeof(long)-1)*8)
 #define REFRESH_MASK \
   while(num < BITSHIFT) { \
     mask |= getbyte()<<(BITSHIFT-num); \
     num += 8; \
     part2remain -= 8; }
+#endif
 
 static int III_dequantize_sample(real xr[SBLIMIT][SSLIMIT],int *scf,
    struct gr_info_s *gr_info,int sfreq,int part2bits)
@@@@ -625,7 +634,11 @@@@ static int III_dequantize_sample(real xr
   int *me;
 
   int num=getbitoffset();
+#if defined(__LP64__)
+  int mask = (int) getbits(num)<<(BITSHIFT+8-num);
+#else
   long mask = (long) getbits(num)<<(BITSHIFT+8-num);
+#endif
   part2remain -= num;
 
   {
@@@@ -709,7 +722,11 @@@@ static int III_dequantize_sample(real xr
         if(x == 15 && h->linbits) {
           max[lwin] = cb;
           REFRESH_MASK;
+#if defined(__LP64__)
+          x += ((unsigned int) mask) >> (BITSHIFT+8-h->linbits);
+#else
           x += ((unsigned long) mask) >> (BITSHIFT+8-h->linbits);
+#endif
           num -= h->linbits+1;
           mask <<= h->linbits;
           if(mask < 0)
@@@@ -733,7 +750,11 @@@@ static int III_dequantize_sample(real xr
         if(y == 15 && h->linbits) {
           max[lwin] = cb;
           REFRESH_MASK;
+#if defined(__LP64__)
+          y += ((unsigned int) mask) >> (BITSHIFT+8-h->linbits);
+#else
           y += ((unsigned long) mask) >> (BITSHIFT+8-h->linbits);
+#endif
           num -= h->linbits+1;
           mask <<= h->linbits;
           if(mask < 0)
@@@@ -883,7 +904,11 @@@@ static int III_dequantize_sample(real xr
         if (x == 15 && h->linbits) {
           max = cb;
 	  REFRESH_MASK;
+#if defined(__LP64__)
+          x += ((unsigned int) mask) >> (BITSHIFT+8-h->linbits);
+#else
           x += ((unsigned long) mask) >> (BITSHIFT+8-h->linbits);
+#endif
           num -= h->linbits+1;
           mask <<= h->linbits;
           if(mask < 0)
@@@@ -907,7 +932,11 @@@@ static int III_dequantize_sample(real xr
         if (y == 15 && h->linbits) {
           max = cb;
 	  REFRESH_MASK;
+#if defined(__LP64__)
+          y += ((unsigned int) mask) >> (BITSHIFT+8-h->linbits);
+#else
           y += ((unsigned long) mask) >> (BITSHIFT+8-h->linbits);
+#endif
           num -= h->linbits+1;
           mask <<= h->linbits;
           if(mask < 0)
@@@@ -1119,7 +1148,10 @@@@ maybe still wrong??? (copy 12 to 13?) */
       } 
       else { /* ((gr_info->block_type != 2)) */
         int sfb = gr_info->maxbandl;
-        int is_p,idx = bi->longIdx[sfb];
+        int is_p,idx;
+        if (sfb > 21)
+                return;
+        idx = bi->longIdx[sfb];
         for ( ; sfb<21; sfb++) {
           int sb = bi->longDiff[sfb];
           is_p = scalefac[sfb]; /* scale: 0-15 */
@


1.4
log
@Fix a buffer overflow when processing MPEG 2.0 layer 3 files. (CVE-2006-1655)

More information:

http://secunia.com/advisories/20240/

diff from NetBSD pkgsrc

ok naddy@@
@
text
@d1 1
a1 1
$OpenBSD: patch-layer3_c,v 1.3 2004/09/15 20:38:07 brad Exp $
@


1.3
log
@it's stupid to download a separate diff (l3.diff.gz) to fix mpg123 on alpha
and then modify most of it locally to work on other 64-bit archs so just
merge this tiny diff into patch-layer3_c
@
text
@d1 3
a3 3
$OpenBSD: patch-layer3_c,v 1.2 2004/03/07 19:54:10 pvalchev Exp $
--- layer3.c.orig	Wed Apr 21 11:25:18 1999
+++ layer3.c	Wed Sep 15 16:22:35 2004
d86 12
@


1.3.4.1
log
@MFC:
Fix a buffer overflow when processing MPEG 2.0 layer 3 files. (CVE-2006-1655)

More information:

http://secunia.com/advisories/20240/

diff from NetBSD pkgsrc
@
text
@d1 3
a3 3
$OpenBSD: patch-layer3_c,v 1.4 2006/05/29 19:34:59 bernd Exp $
--- layer3.c.orig	Wed Apr 21 17:25:18 1999
+++ layer3.c	Mon May 29 10:55:42 2006
a85 12
@@@@ -1119,7 +1148,10 @@@@ maybe still wrong??? (copy 12 to 13?) */
       } 
       else { /* ((gr_info->block_type != 2)) */
         int sfb = gr_info->maxbandl;
-        int is_p,idx = bi->longIdx[sfb];
+        int is_p,idx;
+        if (sfb > 21)
+                return;
+        idx = bi->longIdx[sfb];
         for ( ; sfb<21; sfb++) {
           int sb = bi->longDiff[sfb];
           is_p = scalefac[sfb]; /* scale: 0-15 */
@


1.3.6.1
log
@MFC:
Fix a buffer overflow when processing MPEG 2.0 layer 3 files. (CVE-2006-1655)

More information:

http://secunia.com/advisories/20240/

diff from NetBSD pkgsrc
@
text
@d1 3
a3 3
$OpenBSD: patch-layer3_c,v 1.4 2006/05/29 19:34:59 bernd Exp $
--- layer3.c.orig	Wed Apr 21 17:25:18 1999
+++ layer3.c	Mon May 29 10:55:42 2006
a85 12
@@@@ -1119,7 +1148,10 @@@@ maybe still wrong??? (copy 12 to 13?) */
       } 
       else { /* ((gr_info->block_type != 2)) */
         int sfb = gr_info->maxbandl;
-        int is_p,idx = bi->longIdx[sfb];
+        int is_p,idx;
+        if (sfb > 21)
+                return;
+        idx = bi->longIdx[sfb];
         for ( ; sfb<21; sfb++) {
           int sb = bi->longDiff[sfb];
           is_p = scalefac[sfb]; /* scale: 0-15 */
@


1.2
log
@fix amd64, tested by matthieu
@
text
@d1 4
a4 4
$OpenBSD: patch-layer3_c,v 1.1 2003/07/21 20:24:42 pvalchev Exp $
--- layer3.c.orig	2004-03-07 10:55:19.000000000 -0700
+++ layer3.c	2004-03-07 10:58:36.000000000 -0700
@@@@ -608,7 +608,7 @@@@ static int pretab2[22] = {0,0,0,0,0,0,0,
a7 1
-#ifdef __alpha
d9 8
a16 1
 #define BITSHIFT ((sizeof(int)-1)*8)
d19 8
a26 1
@@@@ -634,7 +634,7 @@@@ static int III_dequantize_sample(real xr
a29 1
-#ifdef __alpha
d31 2
a32 2
   int mask = (int) getbits(num)<<(BITSHIFT+8-num);
 #else
d34 5
a38 1
@@@@ -722,7 +722,7 @@@@ static int III_dequantize_sample(real xr
a41 1
-#ifdef __alpha
d43 2
a44 2
           x += ((unsigned int) mask) >> (BITSHIFT+8-h->linbits);
 #else
d46 5
a50 1
@@@@ -750,7 +750,7 @@@@ static int III_dequantize_sample(real xr
a53 1
-#ifdef __alpha
d55 2
a56 2
           y += ((unsigned int) mask) >> (BITSHIFT+8-h->linbits);
 #else
d58 5
a62 1
@@@@ -904,7 +904,7 @@@@ static int III_dequantize_sample(real xr
a65 1
-#ifdef __alpha
d67 2
a68 2
           x += ((unsigned int) mask) >> (BITSHIFT+8-h->linbits);
 #else
d70 5
a74 1
@@@@ -932,7 +932,7 @@@@ static int III_dequantize_sample(real xr
a77 1
-#ifdef __alpha
d79 2
a80 2
           y += ((unsigned int) mask) >> (BITSHIFT+8-h->linbits);
 #else
d82 4
@


1.1
log
@sparc64 is 64bit too, let it use code meant for alpha as well (int vs long)
fixes playing issues; found by jason@@
@
text
@d1 3
a3 3
$OpenBSD$
--- layer3.c.orig	Mon Jul 21 14:14:21 2003
+++ layer3.c	Mon Jul 21 14:20:27 2003
d9 1
a9 1
+#if defined(__alpha) || (defined(__OpenBSD__) && defined(__sparc64__))
d18 1
a18 1
+#if defined(__alpha) || (defined(__OpenBSD__) && defined(__sparc64__))
d27 1
a27 1
+#if defined(__alpha) || (defined(__OpenBSD__) && defined(__sparc64__))
d36 1
a36 1
+#if defined(__alpha) || (defined(__OpenBSD__) && defined(__sparc64__))
d45 1
a45 1
+#if defined(__alpha) || (defined(__OpenBSD__) && defined(__sparc64__))
d54 1
a54 1
+#if defined(__alpha) || (defined(__OpenBSD__) && defined(__sparc64__))
@

