head	1.7;
access;
symbols
	OPENBSD_6_1:1.7.0.20
	OPENBSD_6_1_BASE:1.7
	OPENBSD_6_0:1.7.0.18
	OPENBSD_6_0_BASE:1.7
	OPENBSD_5_9:1.7.0.14
	OPENBSD_5_9_BASE:1.7
	OPENBSD_5_8:1.7.0.16
	OPENBSD_5_8_BASE:1.7
	OPENBSD_5_7:1.7.0.12
	OPENBSD_5_7_BASE:1.7
	OPENBSD_5_6:1.7.0.10
	OPENBSD_5_6_BASE:1.7
	OPENBSD_5_5:1.7.0.8
	OPENBSD_5_5_BASE:1.7
	OPENBSD_5_4:1.7.0.6
	OPENBSD_5_4_BASE:1.7
	OPENBSD_5_3:1.7.0.4
	OPENBSD_5_3_BASE:1.7
	OPENBSD_5_2:1.7.0.2
	OPENBSD_5_2_BASE:1.7
	OPENBSD_5_1_BASE:1.6
	OPENBSD_5_1:1.6.0.14
	OPENBSD_5_0:1.6.0.12
	OPENBSD_5_0_BASE:1.6
	OPENBSD_4_9:1.6.0.10
	OPENBSD_4_9_BASE:1.6
	OPENBSD_4_8:1.6.0.8
	OPENBSD_4_8_BASE:1.6
	OPENBSD_4_7:1.6.0.6
	OPENBSD_4_7_BASE:1.6
	OPENBSD_4_6:1.6.0.4
	OPENBSD_4_6_BASE:1.6
	OPENBSD_4_5:1.6.0.2
	OPENBSD_4_5_BASE:1.6
	OPENBSD_4_4:1.5.0.6
	OPENBSD_4_4_BASE:1.5
	OPENBSD_4_3:1.5.0.4
	OPENBSD_4_3_BASE:1.5
	OPENBSD_4_2:1.5.0.2
	OPENBSD_4_2_BASE:1.5
	OPENBSD_4_1:1.4.0.6
	OPENBSD_4_1_BASE:1.4
	OPENBSD_4_0:1.4.0.4
	OPENBSD_4_0_BASE:1.4
	OPENBSD_3_9:1.4.0.2
	OPENBSD_3_9_BASE:1.4
	OPENBSD_3_8:1.3.0.8
	OPENBSD_3_8_BASE:1.3
	OPENBSD_3_7:1.3.0.6
	OPENBSD_3_7_BASE:1.3
	OPENBSD_3_6:1.3.0.4
	OPENBSD_3_6_BASE:1.3
	OPENBSD_3_5:1.3.0.2
	OPENBSD_3_5_BASE:1.3
	OPENBSD_3_4:1.2.0.6
	OPENBSD_3_4_BASE:1.2
	OPENBSD_3_3:1.2.0.4
	OPENBSD_3_3_BASE:1.2
	OPENBSD_3_2:1.2.0.2
	OPENBSD_3_2_BASE:1.2;
locks; strict;
comment	@# @;


1.7
date	2012.07.13.09.05.38;	author naddy;	state Exp;
branches;
next	1.6;

1.6
date	2008.10.30.14.46.59;	author naddy;	state Exp;
branches;
next	1.5;

1.5
date	2007.07.21.15.33.22;	author naddy;	state Exp;
branches;
next	1.4;

1.4
date	2005.09.10.16.42.01;	author naddy;	state Exp;
branches;
next	1.3;

1.3
date	2004.01.06.22.20.55;	author naddy;	state Exp;
branches;
next	1.2;

1.2
date	2002.09.02.23.25.02;	author naddy;	state Exp;
branches;
next	1.1;

1.1
date	2002.08.27.20.00.30;	author naddy;	state Exp;
branches;
next	;


desc
@@


1.7
log
@this has been revived upstream, update to 0.3.2
@
text
@$OpenBSD: patch-mpg321_c,v 1.6 2008/10/30 14:46:59 naddy Exp $
--- mpg321.c.orig	Sun Mar 25 14:27:49 2012
+++ mpg321.c	Sun Jul  8 14:15:18 2012
@@@@ -332,9 +332,15 @@@@ void mpg321_error(char *file)
 
 void usage(char *argv0)
 {
+    ao_info **devices;
+    int i, driver_count;
+
+    devices = ao_driver_info_list(&driver_count);
+
     mpg123_boilerplate();
     fprintf(stderr,
-        "\nUsage: %s [options] file(s) | URL(s) | -\n\n"
+        "\nUsage: %s [options] file(s) | URL(s) | -\n\n", argv0);
+    fprintf(stderr,
         "Options supported:\n"
         "   --verbose or -v          Increase verbosity\n"
         "   --quiet or -q            Quiet mode (no title or boilerplate)\n"
@@@@ -342,7 +348,13 @@@@ void usage(char *argv0)
         "   --skip N or -k N         Skip N frames into the file\n"
         "   --frames N or -n N       Play only the first N frames\n"
         "   -o dt                    Set output devicetype to dt\n" 
-        "                                [esd,alsa(09),arts,sun,oss]\n"
+        "                                (");
+    for (i = 0; i < driver_count; i++) {
+        fprintf(stderr, "%s%s", devices[i]->short_name,
+            (i + 1 < driver_count) ? ", " : "");
+    }
+    fprintf(stderr,
+        ")\n"
         "   --audiodevice N or -a N  Use N for audio-out\n"
         "   --stdout or -s           Use stdout for audio-out\n"
         "   --au N                   Use au file N for output\n"
@@@@ -376,7 +388,7 @@@@ void usage(char *argv0)
 	"n        Skip song.                                    \n"
 	"\n"
         "This version of mpg321 has been configured with " AUDIO_DEFAULT " as its default\n"
-        "libao output device.\n" , argv0);
+        "libao output device.\n");
 }
 
 /* retsigtype is defined by configure;
@@@@ -539,6 +551,8 @@@@ int main(int argc, char *argv[])
 
     status = MPG321_PLAYING;
     
+    ao_initialize();
+
     /* Get the command line options */
     parse_options(argc, argv, pl);
 
@@@@ -666,7 +680,6 @@@@ int main(int argc, char *argv[])
 
     }
     else {
-	    ao_initialize();
 	    check_default_play_device();
     }
     
@@@@ -764,6 +777,8 @@@@ int main(int argc, char *argv[])
         signal(SIGINT, SIG_DFL);
         
         playbuf.buf = NULL;
+        playbuf.frames = NULL;
+        playbuf.times = NULL;
         playbuf.fd = -1;
         playbuf.length = 0;
         playbuf.done = 0;
@


1.6
log
@* In the usage message, show the actually available libao devices.
* Allow -o sun to override the default libao device.
@
text
@d1 4
a4 4
$OpenBSD: patch-mpg321_c,v 1.5 2007/07/21 15:33:22 naddy Exp $
--- mpg321.c.orig	Sun Mar 24 06:49:20 2002
+++ mpg321.c	Thu Oct 30 14:48:54 2008
@@@@ -75,9 +75,15 @@@@ void mpg321_error(char *file)
d21 1
a21 1
@@@@ -85,7 +91,13 @@@@ void usage(char *argv0)
d23 1
a23 1
         "   --verbose or -v          Be more verbose in playing files\n"
d25 2
a26 2
-    "                                [esd,alsa(09),arts,sun,oss]\n"
+        "                            (");
d36 3
a38 3
@@@@ -101,7 +113,7 @@@@ void usage(char *argv0)
         "   --version or -V          Print version information\n"
         "\n"
d45 1
a45 19
@@@@ -188,7 +200,7 @@@@ static int show_id3(struct id3_tag const *tag)
             
             else
             {
-                printf(names[i]);
+                printf("%s", names[i]);
                 free(names[i]);
             }
         }
@@@@ -203,7 +215,7 @@@@ static int show_id3(struct id3_tag const *tag)
             if (!names[i])  {
                 fprintf (stderr, emptystring);
             }   else    {
-                fprintf (stderr, names[i]);
+                fprintf (stderr, "%s", names[i]);
                 free (names[i]);
             }
             if (i%2) fprintf (stderr, "\n");
@@@@ -239,6 +251,8 @@@@ int main(int argc, char *argv[])
d54 1
a54 3
@@@@ -257,8 +271,6 @@@@ int main(int argc, char *argv[])
     if (shuffle_play)
         shuffle_files(pl);
d56 5
a60 3
-    ao_initialize();
-
     check_default_play_device();
d62 1
a62 2
     if (!(options.opt & MPG321_REMOTE_PLAY))
@@@@ -285,6 +297,8 @@@@ int main(int argc, char *argv[])
a70 52
@@@@ -410,12 +424,14 @@@@ int main(int argc, char *argv[])
             
             if(fstat(fd, &stat) == -1)
             {
+                close(fd);
                 mpg321_error(currentfile);
                 continue;
             }
             
             if (!S_ISREG(stat.st_mode))
             {
+                close(fd);
                 continue;
             }
             
@@@@ -432,6 +448,7 @@@@ int main(int argc, char *argv[])
             if((playbuf.buf = mmap(0, playbuf.length, PROT_READ, MAP_SHARED, fd, 0))
                                 == MAP_FAILED)
             {
+                close(fd);
                 mpg321_error(currentfile);
                 continue;
             }
@@@@ -509,9 +526,6 @@@@ int main(int argc, char *argv[])
 
         mad_decoder_finish(&decoder);
 
-        if (quit_now)
-            break;
-
         if (playbuf.frames)
              free(playbuf.frames);
 
@@@@ -521,6 +535,7 @@@@ int main(int argc, char *argv[])
         if (playbuf.fd == -1)
         {
             munmap(playbuf.buf, playbuf.length);
+            close(fd);
         }
 
         else
@@@@ -535,10 +550,6 @@@@ int main(int argc, char *argv[])
         ao_close(playdevice);
 
     ao_shutdown();
-
-#if defined(RAW_SUPPORT) || defined(HTTP_SUPPORT) || defined(FTP_SUPPORT) 
-    if(fd) close(fd);
-#endif
 
     return(0);
 }
@


1.5
log
@initialize some variables so we won't call free() on random pointers
@
text
@d1 1
a1 1
$OpenBSD: patch-mpg321_c,v 1.4 2005/09/10 16:42:01 naddy Exp $
d3 43
a45 2
+++ mpg321.c	Sat Jul 21 16:36:41 2007
@@@@ -188,7 +188,7 @@@@ static int show_id3(struct id3_tag const *tag)
d54 1
a54 1
@@@@ -203,7 +203,7 @@@@ static int show_id3(struct id3_tag const *tag)
d63 19
a81 1
@@@@ -285,6 +285,8 @@@@ int main(int argc, char *argv[])
d90 1
a90 1
@@@@ -410,12 +412,14 @@@@ int main(int argc, char *argv[])
d105 1
a105 1
@@@@ -432,6 +436,7 @@@@ int main(int argc, char *argv[])
d113 1
a113 1
@@@@ -509,9 +514,6 @@@@ int main(int argc, char *argv[])
d123 1
a123 1
@@@@ -521,6 +523,7 @@@@ int main(int argc, char *argv[])
d131 1
a131 1
@@@@ -535,10 +538,6 @@@@ int main(int argc, char *argv[])
@


1.4
log
@SHOUTcast Distributed Network Audio Server just disconnects if there
is no user-agent identification.
From: Frank Ruell <stoerte@@dreamwarrior.net>
@
text
@d1 1
a1 1
$OpenBSD: patch-mpg321_c,v 1.3 2004/01/06 22:20:55 naddy Exp $
d3 2
a4 2
+++ mpg321.c	Mon Aug 15 17:25:32 2005
@@@@ -188,7 +188,7 @@@@ static int show_id3(struct id3_tag const
d13 1
a13 1
@@@@ -203,7 +203,7 @@@@ static int show_id3(struct id3_tag const
d22 10
a31 1
@@@@ -410,12 +410,14 @@@@ int main(int argc, char *argv[])
d46 1
a46 1
@@@@ -432,6 +434,7 @@@@ int main(int argc, char *argv[])
d54 1
a54 1
@@@@ -509,9 +512,6 @@@@ int main(int argc, char *argv[])
d64 1
a64 1
@@@@ -521,6 +521,7 @@@@ int main(int argc, char *argv[])
d72 1
a72 1
@@@@ -535,10 +536,6 @@@@ int main(int argc, char *argv[])
@


1.3
log
@don't leak file descriptor on error; from Debian
@
text
@d1 3
a3 3
$OpenBSD: patch-mpg321_c,v 1.2 2002/09/02 23:25:02 naddy Exp $
--- mpg321.c.orig	2002-03-24 06:49:20.000000000 +0100
+++ mpg321.c	2004-01-06 23:16:02.000000000 +0100
d63 2
a64 1
@@@@ -536,10 +537,6 @@@@ int main(int argc, char *argv[])
d67 1
a67 1
 
d71 1
a71 1
-
a73 1
 
@


1.2
log
@Fix format string bugs.
From: Moritz Jodeit <moritz@@jodeit.org>
@
text
@d1 3
a3 3
$OpenBSD: patch-mpg321_c,v 1.1 2002/08/27 20:00:30 naddy Exp $
--- mpg321.c.orig	Sun Mar 24 06:49:20 2002
+++ mpg321.c	Tue Sep  3 00:07:46 2002
d22 24
a45 1
@@@@ -509,9 +509,6 @@@@ int main(int argc, char *argv[])
d55 1
a55 1
@@@@ -521,6 +518,7 @@@@ int main(int argc, char *argv[])
d63 1
a63 2
@@@@ -535,10 +533,6 @@@@ int main(int argc, char *argv[])
         ao_close(playdevice);
d66 1
a66 1
-
d70 1
a70 1
 
d73 1
@


1.1
log
@Plug file descriptor leak.
Noticed by deraadt@@, fix from Joe Drew <drew@@debian.org>.
@
text
@d1 21
a21 3
$OpenBSD$
--- mpg321.c.orig	Tue Aug 27 21:31:05 2002
+++ mpg321.c	Tue Aug 27 21:31:45 2002
@

