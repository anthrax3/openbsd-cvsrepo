head	1.1;
access;
symbols
	OPENBSD_6_2:1.1.0.32
	OPENBSD_6_2_BASE:1.1
	OPENBSD_6_1:1.1.0.30
	OPENBSD_6_1_BASE:1.1
	OPENBSD_6_0:1.1.0.28
	OPENBSD_6_0_BASE:1.1
	OPENBSD_5_9:1.1.0.24
	OPENBSD_5_9_BASE:1.1
	OPENBSD_5_8:1.1.0.26
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.22
	OPENBSD_5_7_BASE:1.1
	OPENBSD_5_6:1.1.0.20
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.18
	OPENBSD_5_5_BASE:1.1
	OPENBSD_5_4:1.1.0.16
	OPENBSD_5_4_BASE:1.1
	OPENBSD_5_3:1.1.0.14
	OPENBSD_5_3_BASE:1.1
	OPENBSD_5_2:1.1.0.12
	OPENBSD_5_2_BASE:1.1
	OPENBSD_5_1_BASE:1.1
	OPENBSD_5_1:1.1.0.10
	OPENBSD_5_0:1.1.0.8
	OPENBSD_5_0_BASE:1.1
	OPENBSD_4_9:1.1.0.6
	OPENBSD_4_9_BASE:1.1
	OPENBSD_4_8:1.1.0.4
	OPENBSD_4_8_BASE:1.1
	OPENBSD_4_7:1.1.0.2
	OPENBSD_4_7_BASE:1.1;
locks; strict;
comment	@ * @;


1.1
date	2009.12.14.00.33.08;	author jakemsr;	state Exp;
branches;
next	;


desc
@@


1.1
log
@- sndio instead of audio(4)
- cleanup & modernize:
remove bouncing maintainer contact, remove nop patch, regen patches,
@@bin markers
@
text
@/*
 * Copyright (c) 2009 Jacob Meuser <jakemsr@@sdf.lonestar.org>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#include <sndio.h>

#include "cst_string.h"
#include "cst_audio.h"

cst_audiodev *
audio_open_sndio(int sps, int channels, cst_audiofmt fmt)
{
	struct sio_par par;
	struct sio_hdl *hdl;
	cst_audiodev *ad;

	hdl = sio_open(NULL, SIO_PLAY, 0);
	if (hdl == NULL) {
		cst_errmsg("sndio_audio: failed to open audio device\n");
		cst_error();
	}

	sio_initpar(&par);
	switch (fmt) {
	case CST_AUDIO_LINEAR16:
		par.bits = 16;
		par.sig = 1;
		break;
	case CST_AUDIO_LINEAR8:
		par.bits = 8;
		par.sig = 0;
		break;
	default:
		cst_errmsg("sndio_audio: invalid format\n");
		cst_error();
	}

	par.pchan = 1;
	par.rate = sps;

	if (!sio_setpar(hdl, &par)) {
		cst_errmsg("sndio_audio: failed to set audio params\n");
		cst_error();
	}
	if (!sio_getpar(hdl, &par)) {
		cst_errmsg("sndio_audio: failed to get audio params\n");
		cst_error();
	}

	ad = cst_alloc(cst_audiodev, 1);

	ad->sps = sps;
	ad->real_sps = par.rate;

	ad->channels = channels;
	ad->real_channels = par.pchan;

	ad->fmt = fmt;
	if (par.sig == 1 && par.bits == 16)
		ad->real_fmt = CST_AUDIO_LINEAR16;
	else if (par.sig == 0 && par.bits == 8)
		ad->real_fmt = CST_AUDIO_LINEAR8;
	else {
		cst_errmsg("sndio_audio: returned audio format unsupported\n");
		cst_free(ad);
		cst_error();
	}

	if (!sio_start(hdl)) {
		cst_errmsg("sndio_audio: start failed\n");
		cst_free(ad);
		cst_error();
	}

	ad->platform_data = hdl;

	return ad;
}

int
audio_close_sndio(cst_audiodev *ad)
{
	if (ad == NULL)
		return 0;

	sio_close(ad->platform_data);

	cst_free(ad);

	return 0;
}

int
audio_write_sndio(cst_audiodev *ad, void *samples, int num_bytes)
{
	return sio_write(ad->platform_data, samples, num_bytes);
}

int
audio_flush_sndio(cst_audiodev *ad)
{
	return 0;
}

int
audio_drain_sndio(cst_audiodev *ad)
{
	return 0;
}
@
