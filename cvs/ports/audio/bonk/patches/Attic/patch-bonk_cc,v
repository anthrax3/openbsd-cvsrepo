head	1.4;
access;
symbols
	OPENBSD_5_5:1.3.0.18
	OPENBSD_5_5_BASE:1.3
	OPENBSD_5_4:1.3.0.16
	OPENBSD_5_4_BASE:1.3
	OPENBSD_5_3:1.3.0.14
	OPENBSD_5_3_BASE:1.3
	OPENBSD_5_2:1.3.0.12
	OPENBSD_5_2_BASE:1.3
	OPENBSD_5_1_BASE:1.3
	OPENBSD_5_1:1.3.0.10
	OPENBSD_5_0:1.3.0.8
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_9:1.3.0.6
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.3.0.4
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.3.0.2
	OPENBSD_4_7_BASE:1.3;
locks; strict;
comment	@# @;


1.4
date	2014.07.06.17.29.44;	author naddy;	state dead;
branches;
next	1.3;
commitid	cADU0XI867928v9M;

1.3
date	2009.12.21.20.17.29;	author naddy;	state Exp;
branches;
next	1.2;

1.2
date	2002.06.23.11.02.55;	author naddy;	state dead;
branches;
next	1.1;

1.1
date	2002.06.14.00.13.59;	author espie;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Remove Bonk, an experimental audio codec that never saw wide adoption.
Last release 12 years ago, superseded by the likes of FLAC and WavPack.
@
text
@$OpenBSD: patch-bonk_cc,v 1.3 2009/12/21 20:17:29 naddy Exp $
--- bonk.cc.orig	Sun Jun 23 09:58:57 2002
+++ bonk.cc	Sat Dec 19 03:40:21 2009
@@@@ -56,14 +56,21 @@@@ using namespace std;
 #  define  AFMT_S16_NE AFMT_S16_BE
 #  endif
 #  endif
-#elif defined(__NetBSD__) || defined(__OpenBSD__)
+#elif defined(__NetBSD__)
 #  define dsp_device "/dev/sound"
 #  include <soundcard.h>
+#elif defined(__OpenBSD__)
+#  define USE_SNDIO
+#  include <sndio.h>
 #endif
 	      
 #include "utility.h"
 #include "wav.h"
 
+#ifdef USE_SNDIO
+static struct sio_hdl *hdl;
+#endif
+
 //Accuracy of fixed point calculations
 const int    lattice_shift  = 10,
              sample_shift   = 4,
@@@@ -540,6 +547,7 @@@@ struct decoder {
   }
 };
 
+#ifndef USE_SNDIO
 FILE *open_dsp(int rate,bool stereo) {
   int device = open(dsp_device,O_WRONLY);
   if (device < 0)
@@@@ -558,6 +566,7 @@@@ FILE *open_dsp(int rate,bool stereo) {
 
   return fdopen(device,"wb"); 
 }
+#endif
 
 bool has_parameter(int &argc,char **&argv,char *name,char *&value) {
   for(int i=1;i<argc-1;i++) {
@@@@ -597,10 +606,41 @@@@ void play_file(char *name) {
 
   deco.begin(f_in);
 
+#ifdef USE_SNDIO
+  struct sio_par par, askpar;
+
+  hdl = sio_open(NULL, SIO_PLAY, 0);
+  if (hdl == NULL)
+    throw error("Failed to open audio device");
+
+  sio_initpar (&par);
+  par.pchan = deco.channels;
+  par.rate = deco.rate;
+  par.bits = 16;
+  par.sig = 1;
+  par.le = SIO_LE_NATIVE;
+  par.appbufsz = par.rate / 4;
+
+  askpar = par;
+  if (!sio_setpar(hdl, &par) || !sio_getpar(hdl, &par))
+    throw error("Failed to set parameters");
+
+  if (par.le != askpar.le ||
+      par.bits != askpar.bits ||
+      par.sig != askpar.sig ||
+      par.pchan != askpar.pchan ||
+      ((par.rate * 1000 < askpar.rate * 995) ||
+       (par.rate * 1000 > askpar.rate * 1005)))
+    throw error("Parameters not supported");
+
+  if (!sio_start(hdl))
+    throw error("Failed to start audio device");
+#else
   if (deco.channels > 2)
     throw error("Don't know how to play more than 2 channels");
 
   FILE *f_out = open_dsp(deco.rate,deco.channels>1); 
+#endif
 
   while(deco.length_remaining) {
     vector<int> samples;
@@@@ -615,12 +655,20 @@@@ void play_file(char *name) {
       else                          
         little_samples[i] =  samples[i];
     }
+#ifdef USE_SNDIO
+    sio_write(hdl, &(little_samples[0]), 2 * little_samples.size());
+#else
     fwrite(&(little_samples[0]),2,little_samples.size(),f_out);
     fflush(f_out);
+#endif
   }
 
   fclose(f_in);
+#ifdef USE_SNDIO
+  sio_close(hdl);
+#else
   fclose(f_out);
+#endif
 }
 
 void do_play(int argc,char **argv) {
@@@@ -929,6 +977,9 @@@@ int main(int argc,char **argv) {
     }
     
   } catch(error e) {
+#ifdef USE_SNDIO
+    sio_close(hdl);
+#endif
     fprintf(stderr,"\nError: %s\n",e.message);
     return 1;
   }
@


1.3
log
@Use sndio instead of ossaudio.
From: Alexandr Shadchin <alexandr.shadchin@@gmail.com>
@
text
@d1 1
a1 1
$OpenBSD$
@


1.2
log
@Update to 0.6.  Now compiles with g++ 3.1 out of the box.
@
text
@d1 18
a18 6
$OpenBSD: patch-bonk_cc,v 1.1 2002/06/14 00:13:59 espie Exp $
--- bonk.cc.orig	Fri Jun 14 02:01:36 2002
+++ bonk.cc	Fri Jun 14 02:05:20 2002
@@@@ -38,6 +38,7 @@@@ const char *version = "0.5";
 #include <string>
 #include <algorithm>
d20 10
a29 2
+using namespace std;
 // Support from Linux and *BSD sound output
d31 85
a115 1
 #if defined(__linux__)
@


1.1
log
@Compile with gcc 3.1.
@
text
@d1 1
a1 1
$OpenBSD$
@

