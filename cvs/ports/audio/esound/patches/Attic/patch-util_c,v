head	1.7;
access;
symbols
	OPENBSD_5_6:1.6.0.24
	OPENBSD_5_6_BASE:1.6
	OPENBSD_5_5:1.6.0.22
	OPENBSD_5_5_BASE:1.6
	OPENBSD_5_4:1.6.0.20
	OPENBSD_5_4_BASE:1.6
	OPENBSD_5_3:1.6.0.18
	OPENBSD_5_3_BASE:1.6
	OPENBSD_5_2:1.6.0.16
	OPENBSD_5_2_BASE:1.6
	OPENBSD_5_1_BASE:1.6
	OPENBSD_5_1:1.6.0.14
	OPENBSD_5_0:1.6.0.12
	OPENBSD_5_0_BASE:1.6
	OPENBSD_4_9:1.6.0.10
	OPENBSD_4_9_BASE:1.6
	OPENBSD_4_8:1.6.0.8
	OPENBSD_4_8_BASE:1.6
	OPENBSD_4_7:1.6.0.6
	OPENBSD_4_7_BASE:1.6
	OPENBSD_4_6:1.6.0.4
	OPENBSD_4_6_BASE:1.6
	OPENBSD_4_5:1.6.0.2
	OPENBSD_4_5_BASE:1.6
	OPENBSD_4_4:1.5.0.2
	OPENBSD_4_4_BASE:1.5
	OPENBSD_4_3:1.4.0.4
	OPENBSD_4_3_BASE:1.4
	OPENBSD_4_2:1.4.0.2
	OPENBSD_4_2_BASE:1.4
	OPENBSD_4_1:1.2.0.12
	OPENBSD_4_1_BASE:1.2
	OPENBSD_4_0:1.2.0.10
	OPENBSD_4_0_BASE:1.2
	OPENBSD_3_9:1.2.0.8
	OPENBSD_3_9_BASE:1.2
	OPENBSD_3_8:1.2.0.6
	OPENBSD_3_8_BASE:1.2
	OPENBSD_3_7:1.2.0.4
	OPENBSD_3_7_BASE:1.2
	OPENBSD_3_6:1.2.0.2
	OPENBSD_3_6_BASE:1.2
	OPENBSD_3_5:1.1.0.8
	OPENBSD_3_5_BASE:1.1
	OPENBSD_3_4:1.1.0.6
	OPENBSD_3_4_BASE:1.1
	OPENBSD_3_3:1.1.0.4
	OPENBSD_3_3_BASE:1.1
	OPENBSD_3_2:1.1.0.2
	OPENBSD_3_2_BASE:1.1;
locks; strict;
comment	@# @;


1.7
date	2014.11.04.19.12.01;	author armani;	state dead;
branches;
next	1.6;
commitid	s8peMEaWH7EANIc0;

1.6
date	2008.12.20.08.58.32;	author jakemsr;	state Exp;
branches;
next	1.5;

1.5
date	2008.03.31.01.05.54;	author jakemsr;	state Exp;
branches;
next	1.4;

1.4
date	2007.08.11.17.29.36;	author martynas;	state Exp;
branches;
next	1.3;

1.3
date	2007.06.26.17.10.29;	author martynas;	state Exp;
branches;
next	1.2;

1.2
date	2004.06.26.04.38.33;	author brad;	state Exp;
branches;
next	1.1;

1.1
date	2002.07.26.19.57.23;	author brad;	state Exp;
branches;
next	;


desc
@@


1.7
log
@Remove EsounD / ESD, old and deprecated sound server

ok aja@@, ratchov@@, brad@@
@
text
@$OpenBSD: patch-util_c,v 1.6 2008/12/20 08:58:32 jakemsr Exp $
--- util.c.orig	Sun Dec 14 13:35:48 2008
+++ util.c	Sun Dec 14 13:39:45 2008
@@@@ -1,5 +1,8 @@@@
 #include "config.h"
 #include "esd.h"
+#include <limits.h>
+#include <pwd.h>
+#include <stdio.h>
 #include <sys/types.h>
 #include <sys/socket.h>
 #include <stdlib.h>
@@@@ -24,36 +27,31 @@@@ have_ipv6(void) {
 const char*
 esd_get_socket_dirname (void) 
 {
-	const char *audiodev = NULL;
-	static char *dirname = NULL;
+	static char *sockdir = NULL, sockdirbuf[PATH_MAX];
+	struct passwd *pw;
 
-        if (dirname == NULL) {
-            if ((audiodev = getenv("AUDIODEV"))) {
-                    char *newdev = strrchr(audiodev, '/');
-                    if (newdev != NULL) {
-                            audiodev = newdev++;
-                    }
-            } else
-                audiodev = "";
-            dirname = malloc(strlen(audiodev) +  40);
-            sprintf (dirname, "/tmp/.esd%s-%i", audiodev, getuid());
+	if (sockdir != NULL)
+		return sockdir;
+	pw = getpwuid(getuid());
+	if (pw == NULL || pw->pw_dir == NULL) {
+		fprintf(stderr, "esd: could not find home directory\n");
+		exit(1);
         }
-
-	return dirname;
+	snprintf(sockdirbuf, sizeof(sockdirbuf), "%s/.esd", pw->pw_dir);
+	endpwent();
+	sockdir = sockdirbuf;
+	return sockdir;
 }
 
 const char*
 esd_get_socket_name (void) 
 {
-	const char *dirname;
-	static char *name = NULL;
+	static char *sockname = NULL, socknamebuf[PATH_MAX];
 
-	if (name == NULL) {
-		dirname = esd_get_socket_dirname();
-		name = malloc(strlen(dirname) + sizeof("/socket"));
-		strcpy(name, dirname);
-		strcat(name, "/socket");
-	}
-
-	return name;
+	if (sockname != NULL)
+		return sockname;
+	snprintf(socknamebuf, sizeof(socknamebuf), "%s/socket",
+		esd_get_socket_dirname());
+	sockname = socknamebuf;
+	return sockname;
 }
@


1.6
log
@- update to 0.2.41
- replace audio(4) backend with sio_open(3) (libsndio) backend

update by ajacoutot, new backend from me
@
text
@d1 1
a1 1
$OpenBSD: patch-util_c,v 1.5 2008/03/31 01:05:54 jakemsr Exp $
@


1.5
log
@bring back esound-0.2.38.

fix the issues with audio(4) handling that caused this to get
reverted previously.

add an arts flavor.
@
text
@d1 3
a3 3
$OpenBSD: patch-util_c,v 1.3 2007/06/26 17:10:29 martynas Exp $
--- util.c.orig	Thu Apr 19 17:43:59 2007
+++ util.c	Sat Jun  2 23:38:31 2007
d13 1
a13 1
@@@@ -23,38 +26,31 @@@@ have_ipv6(void) {
d17 1
a17 1
-	const char *audiodev;
d22 10
a31 12
-	if (dirname == NULL) {
-		if (!(audiodev = getenv("AUDIODEV"))) {
-			audiodev = "";
-		} else {
-			char *newdev = strrchr(audiodev, '/');
-			if (newdev != NULL) {
-				audiodev = newdev++;
-			}
-		}
-		dirname = malloc(strlen(audiodev) + sizeof("/tmp/.esd"));
-		strcpy(dirname, "/tmp/.esd");
-		strcat(dirname, audiodev);
d38 1
a38 1
 	}
@


1.4
log
@revert to 0.2.34;  this is known to cause problems for devices with
48kHz sampling rate, originally reported by Gareth <garf at
loveandnature dot co dot za>
testing and patches from jakemsr@@, aanriot@@ and Tim van der Molen
<tbvdm.lists at xs4all dot nl>
ok naddy@@, jakemsr@@, simon@@, jasper@@
@
text
@d1 3
a3 3
$OpenBSD: patch-util_c,v 1.2 2004/06/26 04:38:33 brad Exp $
--- util.c.orig	Mon Mar  1 12:06:58 2004
+++ util.c	Thu Jun 24 20:15:35 2004
d13 1
a13 1
@@@@ -23,38 +26,31 @@@@ have_ipv6() {
d17 1
a17 1
-	char *audiodev;
d35 1
a35 1
+		return (sockdir);
d46 1
a46 1
+	return (sockdir);
d65 1
a65 1
+		return (sockname);
d69 1
a69 1
+	return (sockname);
@


1.3
log
@update to 0.2.38 plus some minor changes and cleanups
steven@@ says it does not break builk build
ok naddy@@, simon@@; "ok ok ok" jasper@@
@
text
@d2 2
a3 2
--- util.c.orig	Thu Apr 19 17:43:59 2007
+++ util.c	Sat Jun  2 23:38:31 2007
d13 1
a13 1
@@@@ -23,38 +26,31 @@@@ have_ipv6(void) {
d17 1
a17 1
-	const char *audiodev;
d35 1
a35 1
+		return sockdir;
d46 1
a46 1
+	return sockdir;
d65 1
a65 1
+		return sockname;
d69 1
a69 1
+	return sockname;
@


1.2
log
@upgrade to esound 0.2.34
--
Most of the work done by marcm@@
@
text
@d1 3
a3 3
$OpenBSD: patch-util_c,v 1.1 2002/07/26 19:57:23 brad Exp $
--- util.c.orig	Mon Mar  1 12:06:58 2004
+++ util.c	Thu Jun 24 20:15:35 2004
d13 1
a13 1
@@@@ -23,38 +26,31 @@@@ have_ipv6() {
d17 1
a17 1
-	char *audiodev;
d35 1
a35 1
+		return (sockdir);
d46 1
a46 1
+	return (sockdir);
d65 1
a65 1
+		return (sockname);
d69 1
a69 1
+	return (sockname);
@


1.1
log
@upgrade to esound 0.2.28
--
With some testing by: naddy@@
@
text
@d1 5
a5 4
$OpenBSD$
--- util.c.orig	Fri May 17 16:09:32 2002
+++ util.c	Fri Jul 19 18:44:08 2002
@@@@ -1,40 +1,38 @@@@
d10 2
d13 1
a13 2
 #include <strings.h>
 
d26 4
a29 2
-			audiodev = strrchr(audiodev, '/');
-			audiodev++;
d54 2
a55 1
-
d62 1
a62 2
+	static char *sockname = NULL, socknamebuf[PATH_MAX];
 
d67 1
a67 1
+	    esd_get_socket_dirname());
@

