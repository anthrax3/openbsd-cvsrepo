head	1.4;
access;
symbols
	OPENBSD_5_1_BASE:1.3
	OPENBSD_5_1:1.3.0.2;
locks; strict;
comment	@# @;


1.4
date	2012.03.21.17.44.41;	author edd;	state dead;
branches;
next	1.3;

1.3
date	2011.12.04.12.57.09;	author edd;	state Exp;
branches;
next	1.2;

1.2
date	2011.11.02.21.26.57;	author edd;	state dead;
branches;
next	1.1;

1.1
date	2011.09.06.21.33.40;	author edd;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Update to hgd-0.5.3. A bugfix release.
@
text
@$OpenBSD: patch-hgd-netd_c,v 1.3 2011/12/04 12:57:09 edd Exp $

Fix for bug #139 (Wrong PID file written away).

--- hgd-netd.c.orig	Sun Dec  4 12:42:41 2011
+++ hgd-netd.c	Sun Dec  4 12:43:29 2011
@@@@ -1622,16 +1622,14 @@@@ main(int argc, char **argv)
 		hgd_exit_nicely();
 	}
 
-	/* Do this before daemonising so we can see its output if it fails. */
-	if (hgd_write_pid_file() != HGD_OK) {
-		DPRINTF(HGD_D_ERROR, "Can't write PID away");
-		return (HGD_FAIL);
-	}
-
 	/* alright, everything looks good, lets be a daemon and background */
 	if (background)
 		hgd_daemonise();
 
+	if (hgd_write_pid_file() != HGD_OK) {
+		DPRINTF(HGD_D_ERROR, "Can't write PID away");
+		return (HGD_FAIL);
+	}
 
 	hgd_listen_loop();
 
@


1.3
log
@Fix for bug #139 (Wrong PID file written away).
@
text
@d1 1
a1 1
$OpenBSD$
@


1.2
log
@Update to hgd-0.5.0. Thanks to sthen for input.
@
text
@d1 1
a1 1
$OpenBSD: patch-hgd-netd_c,v 1.1 2011/09/06 21:33:40 edd Exp $
d3 1
a3 1
Fix for #77, seg fault when a client attempts to queue without being logged in.
d5 15
a19 5
--- hgd-netd.c.orig	Sun Jul 24 18:29:43 2011
+++ hgd-netd.c	Sat Aug 27 22:51:01 2011
@@@@ -303,6 +303,13 @@@@ hgd_cmd_queue(struct hgd_session *sess, char **args)
 	ssize_t			write_ret;
 	char			*filename, *tag_artist, *tag_title;
d21 3
a23 5
+	if (sess->user == NULL) {
+		hgd_sock_send_line(sess->sock_fd, sess->ssl,
+		    "err|user_not_identified");
+		ret = HGD_FAIL;
+		goto clean;
a24 3
+
 	if ((flood_limit >= 0) &&
 	    (hgd_num_tracks_user(sess->user->name) >= flood_limit)) {
d26 2
a27 14
@@@@ -320,13 +327,6 @@@@ hgd_cmd_queue(struct hgd_session *sess, char **args)
 	if ((bytes == 0) || ((long int) bytes > max_upload_size)) {
 		DPRINTF(HGD_D_WARN, "Incorrect file size");
 		hgd_sock_send_line(sess->sock_fd, sess->ssl, "err|size");
-		ret = HGD_FAIL;
-		goto clean;
-	}
-
-	if (sess->user == NULL) {
-		hgd_sock_send_line(sess->sock_fd, sess->ssl,
-		    "err|user_not_identified");
 		ret = HGD_FAIL;
 		goto clean;
 	}
@


1.1
log
@fix a possible segfault due to dereference of a NULL pointer
@
text
@d1 1
a1 1
$OpenBSD$
@

