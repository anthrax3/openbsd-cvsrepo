head	1.2;
access;
symbols
	OPENBSD_5_2:1.1.1.1.0.2
	OPENBSD_5_2_BASE:1.1.1.1
	naddy_20120710:1.1.1.1
	naddy:1.1.1;
locks; strict;
comment	@# @;


1.2
date	2012.08.04.15.41.44;	author naddy;	state dead;
branches;
next	1.1;

1.1
date	2012.07.10.12.12.37;	author naddy;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2012.07.10.12.12.37;	author naddy;	state Exp;
branches;
next	;


desc
@@


1.2
log
@maintenance update to 0.1.4
@
text
@$OpenBSD: patch-src_opusdec_c,v 1.1 2012/07/10 12:12:37 naddy Exp $
--- src/opusdec.c.orig	Wed Jun 13 00:01:52 2012
+++ src/opusdec.c	Mon Jul  9 23:18:44 2012
@@@@ -63,7 +63,10 @@@@
 #define I64FORMAT "lld"
 #endif
 
-#if defined HAVE_SYS_SOUNDCARD_H || defined HAVE_MACHINE_SOUNDCARD_H || HAVE_SOUNDCARD_H
+#if defined USE_SNDIO
+#include <sndio.h>
+
+#elif defined HAVE_SYS_SOUNDCARD_H || defined HAVE_MACHINE_SOUNDCARD_H || HAVE_SOUNDCARD_H
 #ifdef HAVE_SYS_SOUNDCARD_H
 # include <sys/soundcard.h>
 #elif HAVE_MACHINE_SOUNDCARD_H
@@@@ -105,6 +108,10 @@@@
                            ((buf[base+1]<<8)&0xff00)| \
                            (buf[base]&0xff))
 
+#ifdef USE_SNDIO
+struct sio_hdl *hdl;
+#endif
+
 typedef struct shapestate shapestate;
 struct shapestate {
   float * b_buf;
@@@@ -301,6 +308,32 @@@@ FILE *out_file_open(char *outFile, int rate, int *chan
         perror("Cannot open output");
         exit(1);
       }
+#elif defined USE_SNDIO
+      struct sio_par par;
+
+      hdl = sio_open(NULL, SIO_PLAY, 0);
+      if (!hdl)
+      {
+         fprintf(stderr, "Cannot open sndio device\n");
+         exit(1);
+      }
+
+      sio_initpar(&par);
+      par.sig = 1;
+      par.bits = 16;
+      par.rate = rate;
+      par.pchan = *channels;
+
+      if (!sio_setpar(hdl, &par) || !sio_getpar(hdl, &par) ||
+        par.sig != 1 || par.bits != 16 || par.rate != rate) {
+          fprintf(stderr, "could not set sndio parameters\n");
+          exit(1);
+      }
+      *channels = par.pchan;
+      if (!sio_start(hdl)) {
+          fprintf(stderr, "could not start sndio\n");
+          exit(1);
+      }
 #elif defined HAVE_SYS_AUDIOIO_H
       audio_info_t info;
       int audio_fd;
@@@@ -507,6 +540,12 @@@@ opus_int64 audio_write(float *pcm, int channels, int f
 #if defined WIN32 || defined _WIN32
        if(!file){
          ret=WIN_Play_Samples (out, sizeof(short) * channels * (out_len<maxout?out_len:maxout));
+         if(ret>0)ret/=sizeof(short)*channels;
+         else fprintf(stderr, "Error playing audio.\n");
+       }else
+#elif defined USE_SNDIO
+       if(!file){
+         ret=sio_write (hdl, out, sizeof(short) * channels * (out_len<maxout?out_len:maxout));
          if(ret>0)ret/=sizeof(short)*channels;
          else fprintf(stderr, "Error playing audio.\n");
        }else
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
$OpenBSD$
@


1.1.1.1
log
@Import opus-tools 0.1.2.

Opus-tools provides command-line utilities to encode, inspect, and
decode .opus files.

ok sthen@@
@
text
@@
