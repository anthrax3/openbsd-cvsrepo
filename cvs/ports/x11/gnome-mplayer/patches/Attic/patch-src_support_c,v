head	1.15;
access;
symbols
	OPENBSD_5_4:1.14.0.2
	OPENBSD_5_4_BASE:1.14
	OPENBSD_5_3:1.10.0.2
	OPENBSD_5_3_BASE:1.10
	OPENBSD_5_2:1.8.0.2
	OPENBSD_5_2_BASE:1.8
	OPENBSD_4_8:1.4.0.2
	OPENBSD_4_8_BASE:1.4
	OPENBSD_4_7:1.2.0.2
	OPENBSD_4_7_BASE:1.2
	OPENBSD_4_6:1.1.0.2
	OPENBSD_4_6_BASE:1.1;
locks; strict;
comment	@# @;


1.15
date	2013.10.07.10.22.38;	author dcoppa;	state dead;
branches;
next	1.14;

1.14
date	2013.07.12.09.20.04;	author dcoppa;	state Exp;
branches;
next	1.13;

1.13
date	2013.05.27.11.43.08;	author dcoppa;	state dead;
branches;
next	1.12;

1.12
date	2013.05.24.13.34.11;	author dcoppa;	state Exp;
branches;
next	1.11;

1.11
date	2013.05.24.08.31.38;	author dcoppa;	state dead;
branches;
next	1.10;

1.10
date	2012.12.05.14.31.43;	author dcoppa;	state Exp;
branches;
next	1.9;

1.9
date	2012.10.31.13.22.03;	author dcoppa;	state dead;
branches;
next	1.8;

1.8
date	2012.05.03.15.19.08;	author dcoppa;	state Exp;
branches;
next	1.7;

1.7
date	2011.07.04.13.32.55;	author dcoppa;	state dead;
branches;
next	1.6;

1.6
date	2011.05.04.05.35.54;	author dcoppa;	state Exp;
branches;
next	1.5;

1.5
date	2010.11.08.15.04.15;	author dcoppa;	state dead;
branches;
next	1.4;

1.4
date	2010.07.08.06.29.12;	author dcoppa;	state Exp;
branches;
next	1.3;

1.3
date	2010.03.29.12.16.08;	author dcoppa;	state dead;
branches;
next	1.2;

1.2
date	2009.10.31.12.26.25;	author edd;	state Exp;
branches;
next	1.1;

1.1
date	2009.04.14.09.38.39;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.15
log
@Update to gnome-mplayer-1.0.9alpha
@
text
@$OpenBSD: patch-src_support_c,v 1.14 2013/07/12 09:20:04 dcoppa Exp $

Escape the name when obtained from the URI
(upstream svn revisions r2444 and r2445)

--- src/support.c.orig	Mon Feb 18 15:58:47 2013
+++ src/support.c	Thu Jul 11 17:13:59 2013
@@@@ -1028,6 +1028,8 @@@@ MetaData *get_basic_metadata(gchar * uri)
     gchar *length = NULL;
     gchar *name = NULL;
     gchar *basename = NULL;
+    gchar *escaped_name = NULL;
+    gchar *escaped_basename = NULL;
     gchar *audio_codec = NULL;
     gchar *video_codec = NULL;
     gchar *demuxer = NULL;
@@@@ -1051,16 +1053,25 @@@@ MetaData *get_basic_metadata(gchar * uri)
 #ifdef GIO_ENABLED
         file = g_file_new_for_uri(uri);
         if (file != NULL) {
-            name = g_file_get_path(file);
-            basename = g_file_get_basename(file);
+            escaped_name = g_file_get_path(file);
+            escaped_basename = g_file_get_basename(file);
             g_object_unref(file);
         }
 #else
-        name = g_filename_from_uri(uri, NULL, NULL);
-        basename = g_filename_display_basename(name);
+        escaped_name = g_filename_from_uri(uri, NULL, NULL);
+        escaped_basename = g_filename_display_basename(name);
 #endif
     }
 
+    if (escaped_name == NULL) {
+        if (ret != NULL)
+            g_free(ret);
+        return NULL;
+    }
+
+    name = g_uri_unescape_string(escaped_name, NULL);
+    basename = g_uri_unescape_string(escaped_basename, NULL);
+
     if (name == NULL) {
         if (ret != NULL)
             g_free(ret);
@@@@ -1068,11 +1079,12 @@@@ MetaData *get_basic_metadata(gchar * uri)
     }
 
     if (title == NULL || strlen(title) == 0) {
-        localuri = g_strdup(uri);
+        localuri = g_uri_unescape_string(uri, NULL);
         p = g_strrstr(localuri, ".");
         if (p)
             p[0] = '\0';
         p = g_strrstr(localuri, "/");
+        p = g_strrstr(p - 1, "/");
         if (p) {
             artist = g_strdup(p + 1);
             p = strstr(artist, " - ");
@@@@ -1414,11 +1426,12 @@@@ MetaData *get_metadata(gchar * uri)
 
 
     if (title == NULL || strlen(title) == 0) {
-        localuri = g_strdup(uri);
+        localuri = g_uri_unescape_string(uri, NULL);
         p = g_strrstr(localuri, ".");
         if (p)
             p[0] = '\0';
         p = g_strrstr(localuri, "/");
+        p = g_strrstr(p - 1, "/");
         if (p) {
             artist = g_strdup(p + 1);
             p = strstr(artist, " - ");
@@@@ -1669,7 +1682,7 @@@@ gboolean add_item_to_playlist(const gchar * uri, gbool
 
     gm_log(verbose, G_LOG_LEVEL_INFO, "adding %s to playlist (cancel = %s)", uri,
            gm_bool_to_string(cancel_folder_load));
-    local_uri = g_strdup(uri);
+    local_uri = g_uri_unescape_string(uri, NULL);
 #ifdef LIBGDA_ENABLED
     data = get_db_metadata(db_connection, uri);
 #endif
@


1.14
log
@Escape the name when obtained from the URI
(upstream svn revisions r2444 and r2445)
@
text
@d1 1
a1 1
$OpenBSD$
@


1.13
log
@I've changed my mind: disable cover art support, it's fubar.

While here, simplify volume-related patches.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_support_c,v 1.12 2013/05/24 13:34:11 dcoppa Exp $
d3 2
a4 1
Unbreak cover art support
d7 19
a25 21
+++ src/support.c	Fri May 24 14:01:14 2013
@@@@ -2558,8 +2558,6 @@@@ gpointer get_cover_art(gpointer data)
     gchar *test_file = NULL;
     gchar *cache_file = NULL;
     gboolean found_cached = FALSE;
-    const gchar *artist = NULL;
-    const gchar *album = NULL;
     CURLcode result;
     FILE *art;
     gpointer pixbuf = NULL;
@@@@ -2581,9 +2579,6 @@@@ gpointer get_cover_art(gpointer data)
     gm_log_name_this_thread("gca");
     gm_log(verbose, G_LOG_LEVEL_DEBUG, "get_cover_art(%s)", metadata->uri);
 
-    artist = gmtk_media_player_get_attribute_string(GMTK_MEDIA_PLAYER(media), ATTRIBUTE_ARTIST);
-    album = gmtk_media_player_get_attribute_string(GMTK_MEDIA_PLAYER(media), ATTRIBUTE_ALBUM);
-
     if (metadata->uri != NULL) {
         md5 = g_compute_checksum_for_string(G_CHECKSUM_MD5, metadata->uri, -1);
         thumbnail = g_strdup_printf("%s/.thumbnails/normal/%s.png", g_get_home_dir(), md5);
@@@@ -2680,8 +2675,8 @@@@ gpointer get_cover_art(gpointer data)
d27 6
d35 13
a47 9
-    if (artist != NULL && album != NULL) {
-        path = g_strdup_printf("%s/gnome-mplayer/cover_art/%s/%s.jpeg", g_get_user_cache_dir(), artist, album);
+    if (metadata->artist != NULL && metadata->album != NULL) {
+        path = g_strdup_printf("%s/gnome-mplayer/cover_art/%s/%s.jpeg", g_get_user_cache_dir(), metadata->artist, metadata->album);
         if (g_file_test(path, G_FILE_TEST_EXISTS)) {
             if (cache_file != NULL) {
                 g_free(cache_file);
@@@@ -2693,22 +2688,22 @@@@ gpointer get_cover_art(gpointer data)
         g_free(path);
d50 34
a83 25
-    if (!found_cached && !disable_cover_art_fetch && artist != NULL) {
-        url = get_cover_art_url((gchar *) artist, NULL, (gchar *) album);
+    if (!found_cached && !disable_cover_art_fetch && metadata->artist != NULL) {
+        url = get_cover_art_url((gchar *) metadata->artist, NULL, (gchar *) metadata->album);
 
         gm_log(verbose, G_LOG_LEVEL_INFO, "getting cover art from %s", url);
 
         if (url != NULL) {
-            path = g_strdup_printf("%s/gnome-mplayer/cover_art/%s", g_get_user_cache_dir(), artist);
+            path = g_strdup_printf("%s/gnome-mplayer/cover_art/%s", g_get_user_cache_dir(), metadata->artist);
 
             if (!g_file_test(path, G_FILE_TEST_IS_DIR)) {
                 g_mkdir_with_parents(path, 0775);
             }
             g_free(path);
-            if (album == NULL) {
-                path = g_strdup_printf("%s/gnome-mplayer/cover_art/%s/Unknown.jpeg", g_get_user_cache_dir(), artist);
+            if (metadata->album == NULL) {
+                path = g_strdup_printf("%s/gnome-mplayer/cover_art/%s/Unknown.jpeg", g_get_user_cache_dir(), metadata->artist);
             } else {
-                path = g_strdup_printf("%s/gnome-mplayer/cover_art/%s/%s.jpeg", g_get_user_cache_dir(), artist, album);
+                path = g_strdup_printf("%s/gnome-mplayer/cover_art/%s/%s.jpeg", g_get_user_cache_dir(), metadata->artist, metadata->album);
             }
             gm_log(verbose, G_LOG_LEVEL_INFO, "storing cover art to %s", path);
 
@


1.12
log
@
Unbreak cover art support
@
text
@d1 1
a1 1
$OpenBSD$
@


1.11
log
@Update to gnome-mplayer-1.0.8
@
text
@d1 1
a1 1
$OpenBSD: patch-src_support_c,v 1.10 2012/12/05 14:31:43 dcoppa Exp $
d3 1
a3 3
Check for 'iTunes_Control' as well as 'iPod_Control', otherwise
gnome-mplayer won't detect some older iPod models
(upstream svn revision r2371)
d5 22
a26 10
--- src/support.c.orig	Wed Dec  5 15:58:22 2012
+++ src/support.c	Wed Dec  5 16:00:03 2012
@@@@ -2286,6 +2286,10 @@@@ gchar *find_gpod_mount_point()
             if (g_file_test(pathname, G_FILE_TEST_IS_DIR))
                 ret = g_strdup(mnt->mnt_dir);
             g_free(pathname);
+            pathname = g_strdup_printf("%s/iTunes_Control", mnt->mnt_dir);
+            if (g_file_test(pathname, G_FILE_TEST_IS_DIR))
+                ret = g_strdup(mnt->mnt_dir);
+            g_free(pathname);
d29 37
a65 1
     while (mnt);
@


1.10
log
@Check for 'iTunes_Control' as well as 'iPod_Control', otherwise
gnome-mplayer won't detect some older iPod models
(upstream svn revision r2371)

While here, sync WANTLIB.
@
text
@d1 1
a1 1
$OpenBSD$
@


1.9
log
@Update to gnome-mplayer-1.0.7.
Switch to gtk+3.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_support_c,v 1.8 2012/05/03 15:19:08 dcoppa Exp $
d3 3
a5 2
Fix format string: missing format argument
(upstream svn revision r2246)
d7 10
a16 47
Don't update cover art when URL call fails
(upstream svn revision r2241)

--- src/support.c.orig	Tue Feb 21 19:04:44 2012
+++ src/support.c	Thu May  3 15:06:04 2012
@@@@ -885,7 +885,7 @@@@ gint parse_vcd(gchar * filename)
 
         if (error_msg != NULL) {
             dialog = gtk_message_dialog_new(NULL, GTK_DIALOG_DESTROY_WITH_PARENT, GTK_MESSAGE_ERROR,
-                                            GTK_BUTTONS_CLOSE, error_msg);
+                                            GTK_BUTTONS_CLOSE, "%s", error_msg);
             gtk_window_set_title(GTK_WINDOW(dialog), _("GNOME MPlayer Error"));
             gtk_dialog_run(GTK_DIALOG(dialog));
             gtk_widget_destroy(dialog);
@@@@ -2414,6 +2414,7 @@@@ gpointer get_cover_art(gpointer data)
     gboolean local_artist = FALSE;
     gboolean local_album = FALSE;
     CURL *curl;
+    CURLcode result;
     FILE *art;
     gpointer pixbuf;
     MetaData *metadata = (MetaData *) data;
@@@@ -2555,19 +2556,24 @@@@ gpointer get_cover_art(gpointer data)
                         g_mkdir_with_parents(path, 0775);
                     }
 
+                    result = 0;
                     art = fopen(cache_file, "wb");
                     if (art) {
                         curl = curl_easy_init();
                         if (curl) {
                             curl_easy_setopt(curl, CURLOPT_URL, url);
                             curl_easy_setopt(curl, CURLOPT_WRITEDATA, art);
-                            curl_easy_perform(curl);
+                            result = curl_easy_perform(curl);
                             curl_easy_cleanup(curl);
                         }
                         fclose(art);
                     }
                     // printf("cover art url is %s\n",url);
                     g_free(url);
+                    if (result != 0) {
+                        g_free(cache_file);
+                        cache_file = NULL;
+                    }
                 }
             }
d18 2
@


1.8
log
@Several bugfixes from upstream svn (see patches for details)
@
text
@d1 1
a1 1
$OpenBSD$
@


1.7
log
@Update to gnome-mplayer-1.0.4
@
text
@d1 52
a52 10
$OpenBSD: patch-src_support_c,v 1.6 2011/05/04 05:35:54 dcoppa Exp $
--- src/support.c.orig	Tue May  3 20:38:12 2011
+++ src/support.c	Tue May  3 20:39:51 2011
@@@@ -1751,7 +1751,7 @@@@ gboolean add_item_to_playlist(const gchar * uri, gint 
         data = (MetaData *) g_new0(MetaData, 1);
         data->title = g_strdup_printf("CD Track %s", uri + strlen("cdda://"));
     } else if (device_name(local_uri)) {
-        if (g_ascii_strncasecmp(uri, "dvdnav://", strlen("dvdnav://") == 0)) {
+        if (g_ascii_strncasecmp(uri, "dvdnav://", strlen("dvdnav://")) == 0) {
             loop = 1;
a53 1
         retrieve = TRUE;
@


1.6
log
@Remove a unneeded patch chunk.

Fix a typo in a g_ascii_strncasecmp.
@
text
@d1 1
a1 1
$OpenBSD$
@


1.5
log
@Update to gnome-mplayer 1.0.0 and drop GConf dependency.

Suggestions about volume defaults by landry@@

OK landry@@
"go ahead" jasper@@
@
text
@d1 12
a12 17
$OpenBSD: patch-src_support_c,v 1.4 2010/07/08 06:29:12 dcoppa Exp $

fix from upstream:
correct problem with tracks loaded from an iPod as not being marked 
playable

--- src/support.c.orig	Wed Jul  7 17:07:17 2010
+++ src/support.c	Wed Jul  7 17:09:08 2010
@@@@ -2778,7 +2778,7 @@@@ gboolean gpod_load_tracks(gchar * mount_point)
                                gtk_tree_model_iter_n_children(GTK_TREE_MODEL(playliststore), NULL),
                                ADD_ORDER_COLUMN,
                                gtk_tree_model_iter_n_children(GTK_TREE_MODEL(playliststore), NULL),
-                               -1);
+                               PLAYABLE_COLUMN, TRUE, -1);
 
             g_free(duration);
             g_free(full_path);
@


1.4
log
@Apply some small bugfixes from upstream: see patches for descriptions.
@
text
@d1 1
a1 1
$OpenBSD$
@


1.3
log
@update to 0.9.9.2

OK landry@@, ajacoutot@@
@
text
@d1 1
a1 1
$OpenBSD: patch-src_support_c,v 1.2 2009/10/31 12:26:25 edd Exp $
d3 3
a5 1
fixes from upstream svn:
d7 8
a14 131
problem with playlist detection on glib < 2.22
fix mute flag

--- src/support.c.orig	Thu Sep 17 09:56:06 2009
+++ src/support.c	Fri Oct 16 03:29:51 2009
@@@@ -39,6 +39,7 @@@@ gint detect_playlist(gchar * uri)
     gchar *coltitle;
     gint count;
     gchar *path = NULL;
+    gchar *lower;
 #ifdef GIO_ENABLED
     GFile *file;
     GFileInputStream *input;
@@@@ -75,40 +76,37 @@@@ gint detect_playlist(gchar * uri)
                 memset(buffer, 0, sizeof(buffer));
                 g_input_stream_read((GInputStream *) input, buffer, sizeof(buffer), NULL, NULL);
                 output = g_strsplit(buffer, "\n", 0);
-                if (output[0] != NULL) {
-                    g_strchomp(output[0]);
-                    g_strchug(output[0]);
-                }
+		lower = g_ascii_strdown(buffer, -1);
                 // printf("buffer=%s\n",buffer);
-                if (strstr(g_strdown(buffer), "[playlist]") != 0) {
+		if (strstr(lower, "[playlist]") != 0) {
                     playlist = 1;
                 }
 
-                if (strstr(g_strdown(buffer), "[reference]") != 0) {
+		if (strstr(lower, "[reference]") != 0) {
                     playlist = 1;
                 }
 
-                if (strstr(g_strdown(buffer), "<asx") != 0) {
+		if (strstr(lower, "<asx") != 0) {
                     playlist = 1;
                 }
 
-                if (strstr(g_strdown(buffer), "<smil>") != 0) {
+		if (strstr(lower, "<smil>") != 0) {
                     playlist = 1;
                 }
 
-                if (strstr(g_strdown(buffer), "#extm3u") != 0) {
+		if (strstr(lower, "#extm3u") != 0) {
                     playlist = 1;
                 }
 
-                if (strstr(g_strdown(buffer), "http://") != 0) {
+		if (strstr(lower, "http://") != 0) {
                     playlist = 1;
                 }
 
-                if (strstr(g_strdown(buffer), "rtsp://") != 0) {
+		if (strstr(lower, "rtsp://") != 0) {
                     playlist = 1;
                 }
 
-                if (strstr(g_strdown(buffer), "pnm://") != 0) {
+		if (strstr(lower, "pnm://") != 0) {
                     playlist = 1;
                 }
 
@@@@ -129,6 +127,7 @@@@ gint detect_playlist(gchar * uri)
                     }
                     g_free(newuri);
                 }
+		g_free(lower);
                 g_strfreev(output);
 
                 g_input_stream_close((GInputStream *) input, NULL, NULL);
@@@@ -150,16 +149,12 @@@@ gint detect_playlist(gchar * uri)
                     memset(buffer, 0, sizeof(buffer));
                     size = fread(buffer, 1, sizeof(buffer) - 1, fp);
                     output = g_strsplit(buffer, "\n", 0);
-                    if (output[0] != NULL) {
-                        g_strchomp(output[0]);
-                        g_strchug(output[0]);
-                    }
                     //printf("buffer=%s\n",buffer);
-                    if (strstr(g_strdown(buffer), "[playlist]") != 0) {
+		    if (strstr(lower, "[playlist]") != 0) {
                         playlist = 1;
                     }
 
-                    if (strstr(g_strdown(buffer), "[reference]") != 0) {
+		    if (strstr(lower, "[reference]") != 0) {
                         playlist = 1;
                     }
 
@@@@ -167,19 +162,19 @@@@ gint detect_playlist(gchar * uri)
                         playlist = 1;
                     }
 
-                    if (strstr(g_strdown(buffer), "<asx") != 0) {
+		    if (strstr(lower, "<asx") != 0) {
                         playlist = 1;
                     }
 
-                    if (strstr(g_strdown(buffer), "http://") != 0) {
+		    if (strstr(lower, "http://") != 0) {
                         playlist = 1;
                     }
 
-                    if (strstr(g_strdown(buffer), "rtsp://") != 0) {
+		    if (strstr(lower, "rtsp://") != 0) {
                         playlist = 1;
                     }
 
-                    if (strstr(g_strdown(buffer), "pnm://") != 0) {
+		    if (strstr(lower, "pnm://") != 0) {
                         playlist = 1;
                     }
                     if (output[0] != NULL && g_file_test(output[0], G_FILE_TEST_EXISTS)) {
@@@@ -193,7 +188,7 @@@@ gint detect_playlist(gchar * uri)
                         }
                         g_free(file);
                     }
-
+		    g_free(lower);
                     g_strfreev(output);
                 }
                 fclose(fp);
@@@@ -1431,7 +1426,7 @@@@ MetaData *get_metadata(gchar * uri)
             if (strstr(lower, "=title") != NULL || strstr(lower, "=name") != NULL) {
                 localtitle = strstr(output[ac + 1], "=") + 1;
                 if (localtitle)
-                    title = g_strstrip(metadata_to_utf8(localtitle));
+                    title = metadata_to_utf8(localtitle);
                 else
                     title = NULL;
d16 2
a17 30
@@@@ -2253,9 +2248,13 @@@@ gdouble get_alsa_volume(gboolean show_details)
             if (playback == 1) {
                 vol = (gdouble) ((get_vol - pmin) * f_multi);
             } else {
-                idledata->mute = TRUE;
                 vol = 0;
             }
+			if (vol == 0) {
+				idledata->mute = TRUE;
+			} else {
+				idledata->mute = FALSE;
+			}
             if (verbose && show_details) {
                 printf("%s Playback is %i\n", mixer, playback);
                 printf("%s Range is %li to %li \n", mixer, pmin, pmax);
@@@@ -2292,9 +2291,13 @@@@ gdouble get_alsa_volume(gboolean show_details)
             if (playback == 1) {
                 vol = (gdouble) ((get_vol - pmin) * f_multi);
             } else {
-                idledata->mute = TRUE;
                 vol = 0;
             }
+			if (vol == 0) {
+				idledata->mute = TRUE;
+			} else {
+				idledata->mute = FALSE;
+			}
             if (verbose && show_details) {
                 printf("Master Playback is %i\n", playback);
                 printf("Master Range is %li to %li \n", pmin, pmax);
@


1.2
log
@update to gnome-mplayer-0.9.8

From MAINTAINER David Coppa with some reccommendations from landry@@ and
myself, namely:

 - comments in patches.
 - remove fullscreen bar animation by default.
 - fix an issue regarding the volume defaulting to zero.
 - message regarding gconfd-2

OK landry@@

Thanks
@
text
@d1 1
a1 1
$OpenBSD$
@


1.1
log
@- Change bitrate divisor from 1024 to 1000
Fix cache display problem when used as browser plugin

- Fix problem with default auto_hide value

adapted from upstream svn by David Coppa (maintainer)
@
text
@d2 165
a166 27
--- src/support.c.orig	Mon Apr 13 18:07:53 2009
+++ src/support.c	Mon Apr 13 18:12:50 2009
@@@@ -2061,6 +2061,24 @@@@ gint read_preference_int(gchar * key)
     return value;
 }
 
+gint read_preference_int_with_default(gchar * key, gint default_value)
+{
+    gint value = 0;
+#ifdef HAVE_GCONF
+    gchar *full_key = NULL;
+
+    full_key = g_strdup_printf("/apps/gnome-mplayer/preferences/%s", key);
+    value = gconf_client_get_int(gconf, full_key, NULL);
+    g_free(full_key);
+#else
+	if (g_key_file_has_key(config,"gnome-mplayer",key,NULL))
+		value = g_key_file_get_integer(config, "gnome-mplayer", key, NULL);
+	else
+		value = default_value;
+#endif
+    return value;
+}
+
 gfloat read_preference_float(gchar * key)
 {
     gfloat value = 0;
@

