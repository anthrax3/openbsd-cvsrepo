head	1.5;
access;
symbols;
locks; strict;
comment	@# @;


1.5
date	2015.02.21.05.14.58;	author ajacoutot;	state dead;
branches;
next	1.4;
commitid	TIT7ZXyCLA3n1Hn6;

1.4
date	2015.01.23.13.38.30;	author ajacoutot;	state Exp;
branches;
next	1.3;
commitid	MnnS757yUUIG9P0t;

1.3
date	2015.01.23.09.31.10;	author ajacoutot;	state Exp;
branches;
next	1.2;
commitid	rtHgoS5EPZppgWCq;

1.2
date	2014.10.15.14.32.06;	author ajacoutot;	state dead;
branches;
next	1.1;
commitid	xNB90a6Beot8LQrA;

1.1
date	2014.10.15.07.30.45;	author ajacoutot;	state Exp;
branches;
next	;
commitid	U263sZcAbuA26YIQ;


desc
@@


1.5
log
@Update to lumina-0.8.2.1424293520.
- fix a crash with Desktop plugins on OpenBSD
@
text
@$OpenBSD: patch-libLumina_LuminaOS-OpenBSD_cpp,v 1.4 2015/01/23 13:38:30 ajacoutot Exp $

https://github.com/pcbsd/lumina/commit/e265afb51a6dd36683c8d5d999300945f3083a9c

--- libLumina/LuminaOS-OpenBSD.cpp.orig	Wed Oct 15 16:01:00 2014
+++ libLumina/LuminaOS-OpenBSD.cpp	Fri Jan 23 10:19:45 2015
@@@@ -50,6 +50,10 @@@@ QStringList LOS::ExternalDevicePaths(){
 //Read screen brightness information
 int LOS::ScreenBrightness(){
   //Returns: Screen Brightness as a percentage (0-100, with -1 for errors)
+  //Make sure we are not running in a VM (does not work)
+  QStringList info = LUtils::getCmdOutput("sysctl -n hw.product");
+  if( !info.filter(QRegExp("VirtualBox|KVM")).isEmpty() ){ return -1; }
+  //Now perform the standard brightness checks
   if(screenbrightness==-1){
     if(QFile::exists(QDir::homePath()+"/.lumina/.currentxbrightness")){
       int val = LUtils::readFile(QDir::homePath()+"/.lumina/.currentxbrightness").join("").simplified().toInt();
@@@@ -144,12 +148,14 @@@@ void LOS::startMixerUtility(){
 
 //Check for user system permission (shutdown/restart)
 bool LOS::userHasShutdownAccess(){
-  return true; //not implemented yet
+  //User needs to be a part of the operator group to be able to run the shutdown command
+  QStringList groups = LUtils::getCmdOutput("id -Gn").join(" ").split(" ");
+  return groups.contains("operator");
 }
 
 //System Shutdown
 void LOS::systemShutdown(){ //start poweroff sequence
-  QProcess::startDetached("shutdown -hp now");
+  QProcess::startDetached("shutdown -p now");
 }
 
 //System Restart
@@@@ -159,8 +165,8 @@@@ void LOS::systemRestart(){ //start reboot sequence
 
 //Battery Availability
 bool LOS::hasBattery(){
-  int val = LUtils::getCmdOutput("apm -l").join("").toInt();
-  return (val >= 0 && val <= 100);
+  int val = LUtils::getCmdOutput("apm -b").join("").toInt();
+  return (val < 4);
 }
 
 //Battery Charge Level
@


1.4
log
@Pushed upstream.
@
text
@d1 1
a1 1
$OpenBSD: patch-libLumina_LuminaOS-OpenBSD_cpp,v 1.3 2015/01/23 09:31:10 ajacoutot Exp $
@


1.3
log
@Update to lumina-0.8.1.1421890927.
@
text
@d1 1
a1 1
$OpenBSD$
d3 1
a3 1
https://github.com/pcbsd/lumina/pull/39
@


1.2
log
@Update to lumina-0.7.0.1413376519.
@
text
@d1 1
a1 1
$OpenBSD: patch-libLumina_LuminaOS-OpenBSD_cpp,v 1.1 2014/10/15 07:30:45 ajacoutot Exp $
d3 1
a3 1
https://github.com/pcbsd/lumina/pull/20
d5 41
a45 11
--- libLumina/LuminaOS-OpenBSD.cpp.orig	Wed Oct 15 09:23:15 2014
+++ libLumina/LuminaOS-OpenBSD.cpp	Wed Oct 15 09:24:36 2014
@@@@ -65,7 +65,7 @@@@ void LOS::setScreenBrightness(int percent){
   if(percent<0){percent=0;}
   else if(percent>100){ percent=100; }
   //Run the command
-  QString cmd = "xbacklight -set %1";
+  QString cmd = "xbacklight -time 0 -steps 1 -set %1";
   cmd = cmd.arg( QString::number(percent) );
   int ret = LUtils::runCmd(cmd);
   //Save the result for later
@


1.1
log
@Update to lumina-0.6.3.1413320101.
@
text
@d1 1
a1 1
$OpenBSD$
@

