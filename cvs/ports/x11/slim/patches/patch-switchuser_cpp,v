head	1.5;
access;
symbols
	OPENBSD_6_0:1.5.0.14
	OPENBSD_6_0_BASE:1.5
	OPENBSD_5_9:1.5.0.10
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.5.0.12
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.5.0.8
	OPENBSD_5_7_BASE:1.5
	OPENBSD_5_6:1.5.0.6
	OPENBSD_5_6_BASE:1.5
	OPENBSD_5_5:1.5.0.4
	OPENBSD_5_5_BASE:1.5
	OPENBSD_5_4:1.5.0.2
	OPENBSD_5_4_BASE:1.5
	OPENBSD_5_3:1.4.0.2
	OPENBSD_5_3_BASE:1.4
	OPENBSD_5_2:1.3.0.8
	OPENBSD_5_2_BASE:1.3
	OPENBSD_5_1_BASE:1.3
	OPENBSD_5_1:1.3.0.6
	OPENBSD_5_0:1.3.0.4
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_9:1.3.0.2
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.2.0.2
	OPENBSD_4_8_BASE:1.2
	OPENBSD_4_7:1.1.0.6
	OPENBSD_4_7_BASE:1.1
	OPENBSD_4_6:1.1.0.4
	OPENBSD_4_5:1.1.0.2;
locks; strict;
comment	@# @;


1.5
date	2013.04.18.12.00.45;	author gonzalo;	state Exp;
branches;
next	1.4;

1.4
date	2012.09.02.09.23.00;	author landry;	state Exp;
branches;
next	1.3;

1.3
date	2010.08.24.11.37.50;	author landry;	state Exp;
branches;
next	1.2;

1.2
date	2010.07.10.10.46.52;	author armani;	state Exp;
branches;
next	1.1;

1.1
date	2009.09.04.20.24.25;	author landry;	state Exp;
branches
	1.1.2.1
	1.1.4.1;
next	;

1.1.2.1
date	2009.09.16.02.12.39;	author william;	state Exp;
branches;
next	;

1.1.4.1
date	2009.10.25.03.48.47;	author william;	state Exp;
branches;
next	;


desc
@@


1.5
log
@Update for Slim to 1.3.5:

 * Support UTF8 string.
 * And fix some bugs.

Ok landry@@ (maintainer)
@
text
@$OpenBSD: patch-switchuser_cpp,v 1.4 2012/09/02 09:23:00 landry Exp $
add missing setusercontext/setsid/setlogin calls.
--- switchuser.cpp.orig	Mon Dec 31 10:03:42 2012
+++ switchuser.cpp	Wed Apr 17 13:10:36 2013
@@@@ -10,6 +10,10 @@@@
 */
 
 #include <cstdio>
+#ifdef __OpenBSD__
+#include <sys/types.h>
+#include <login_cap.h>
+#endif
 #include "switchuser.h"
 #include "util.h"
 
@@@@ -36,6 +40,9 @@@@ void SwitchUser::Login(const char* cmd, const char* mc
 
 void SwitchUser::SetUserId() {
 	if( (Pw == 0) ||
+			(setusercontext(NULL, Pw, Pw->pw_uid, LOGIN_SETPRIORITY|LOGIN_SETRESOURCES) == -1) ||
+			(setsid() == -1) ||
+			(setlogin(Pw->pw_name) != 0) ||
 			(initgroups(Pw->pw_name, Pw->pw_gid) != 0) ||
 			(setgid(Pw->pw_gid) != 0) ||
 			(setuid(Pw->pw_uid) != 0) ) {
@


1.4
log
@Update to slim 1.3.4.

- switch to cmake.
- add missing setusercontext() call in switchuser.cpp, now the ulimits
  are properly applied when logging in.
- add support for bsd_auth(3) through auth_userokay(3). Now allows to
  login via login_ldap/login_yubikey/etc...
- add support for consolekit, no need to do ck-launch-session in
  .xinitrc anymore.
- make consolekit support at runtime optional, ie don't badly bail out
  if systemwide dbus daemon is not running. Being discussed with
upstream.
parts based on a diff from 'johnw', ok ajacoutot@@
@
text
@d1 1
a1 1
$OpenBSD: patch-switchuser_cpp,v 1.3 2010/08/24 11:37:50 landry Exp $
d3 2
a4 2
--- switchuser.cpp.orig	Tue Jun 26 10:20:14 2012
+++ switchuser.cpp	Sat Sep  1 20:51:44 2012
d19 7
a25 7
     if( (Pw == 0) ||
+            (setusercontext(NULL, Pw, Pw->pw_uid, LOGIN_SETPRIORITY|LOGIN_SETRESOURCES) == -1) ||
+            (setsid() == -1) ||
+            (setlogin(Pw->pw_name) != 0) ||
             (initgroups(Pw->pw_name, Pw->pw_gid) != 0) ||
             (setgid(Pw->pw_gid) != 0) ||
             (setuid(Pw->pw_uid) != 0) ) {
@


1.3
log
@Update to slim 1.3.2, fixes a security issue (removes . from
default_path, sometimes inherited by some window managers)
ref: http://secunia.com/advisories/41005
Removes patches merged upstream. Amend MESSAGE to teach users
who modified slim.conf how to fix it there.
Prompted by and ok jasper@@
@
text
@d1 16
a16 4
$OpenBSD: patch-switchuser_cpp,v 1.2 2010/07/10 10:46:52 armani Exp $
--- switchuser.cpp.orig	Thu Jul  8 07:04:10 2010
+++ switchuser.cpp	Mon Aug 23 21:36:45 2010
@@@@ -39,6 +39,8 @@@@ void SwitchUser::Login(const char* cmd, const char* mc
d20 1
@


1.2
log
@Add a fix from Freebsd :

 x11/slim, does not setlogin(). Some software use getlogin()
 to decide the user name, so when user is using slim as the
 login manager, those software would get wrong results, and
 some programs refuse to start

(Seen with opencvs some times ago, reminded by a discution
with zinovik and theo and setlogin hint from guenter)

ok maintainer & dcoppa@@
@
text
@d1 4
a4 13
$OpenBSD: patch-switchuser_cpp,v 1.1 2009/09/04 20:24:25 landry Exp $
--- switchuser.cpp.orig	Fri Sep 26 02:54:15 2008
+++ switchuser.cpp	Fri Jul  9 22:23:47 2010
@@@@ -10,7 +10,7 @@@@
 */
 
 #include "switchuser.h"
-
+#include "app.h"
 using namespace std;
 
 SwitchUser::SwitchUser(struct passwd *pw, Cfg *c, const string& display,
@@@@ -37,6 +37,8 @@@@ void SwitchUser::Login(const char* cmd, const char* mc
a12 13
@@@@ -53,10 +55,9 @@@@ void SwitchUser::Execute(const char* cmd) {
 }
 
 void SwitchUser::SetClientAuth(const char* mcookie) {
-    int r;
+    bool r;
     string home = string(Pw->pw_dir);
     string authfile = home + "/.Xauthority";
     remove(authfile.c_str());
-    string cmd = cfg->getOption("xauth_path") + " -q -f " + authfile + " add :0 . " + mcookie;
-    r = system(cmd.c_str());
+    r = Util::add_mcookie(mcookie, ":0", cfg->getOption("xauth_path"), authfile);
 }
@


1.1
log
@Add a bunch of patches to fix CVE-2009-1756, also reported in debian bz
#529306 & FreeBSD PR134801 :
The security issue is caused by slim generating the X authority file
by passing the X authority cookie via the command line to "xauth".
This can be exploited to disclose the X authority cookie by consulting
the process list and e.g. gain access the user's display.
While here, use slightly better random seeding for cookie generation.

Patches adapted from the ones provided to debian/FreeBSD by Eygene Ryabinkin <rea@@codelabs.ru>
@
text
@d1 3
a3 3
$OpenBSD$
--- switchuser.cpp.orig	Fri Sep  4 22:01:46 2009
+++ switchuser.cpp	Fri Sep  4 22:02:32 2009
d13 10
a22 1
@@@@ -53,10 +53,9 @@@@ void SwitchUser::Execute(const char* cmd) {
@


1.1.4.1
log
@MFC:

SECURITY FIX

Resolves CVE-2009-1756
@
text
@d1 1
a1 1
$OpenBSD: patch-switchuser_cpp,v 1.1 2009/09/04 20:24:25 landry Exp $
@


1.1.2.1
log
@MFC:

SECURITY FIX

Resolves CVE-2009-1756

ok jasper@@
@
text
@d1 1
a1 1
$OpenBSD: patch-switchuser_cpp,v 1.1 2009/09/04 20:24:25 landry Exp $
@

