head	1.1;
access;
symbols
	OPENBSD_3_1:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2003.01.07.00.12.40;	author brad;	state dead;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2003.01.07.00.12.40;	author brad;	state Exp;
branches;
next	;


desc
@@


1.1
log
@file patch-kdeprint_management_smbview_cpp was initially added on branch OPENBSD_3_1.
@
text
@@


1.1.2.1
log
@- add patches from auditing effort for KDE 2.2
- bump PKGNAME's

http://www.kde.org/info/security/advisory-20021220-1.txt
@
text
@a0 52
$OpenBSD$
--- kdeprint/management/smbview.cpp.orig	Mon Apr  2 15:01:00 2001
+++ kdeprint/management/smbview.cpp	Sun Jan  5 16:04:16 2003
@@@@ -19,6 +19,9 @@@@
 
 #include "smbview.h"
 
+#include <config.h>
+#include <stdlib.h>
+
 #include <kprocess.h>
 #include <qheader.h>
 #include <qapplication.h>
@@@@ -117,20 +120,36 @@@@ void SmbView::setOpen(QListViewItem *ite
 {
 	if (on && item->childCount() == 0)
 	{
+		QCString oldpw = getenv("PASSWD");
+		QCString olduser = getenv("USER");
+		QCString pw = m_password.local8Bit();
+		setenv("PASSWD", pw, 1);
+		QCString user = m_login.local8Bit();
+		setenv("USER", user, 1);
 		if (item->depth() == 0)
 		{ // opening group
 			m_current = item;
-			QString	cmd = QString("nmblookup -M %1 -S | grep '<20>' | awk '{print $1}' | xargs -iserv_name smbclient -L serv_name -W %2 %3").arg(item->text(0)).arg(item->text(0)).arg(smbPasswordString(m_login,m_password));
+			QString	cmd = QString("nmblookup -M %1 -S | grep '<20>' | awk '{print $1}' | xargs -iserv_name ").arg(KShellProcess::quote(item->text(0)));
+			cmd += QString("smbclient -L serv_name -N -W %1").arg(KShellProcess::quote(item->text(0)));
 			m_proc->setExecutable(cmd);
 			startProcess(ServerListing);
 		}
 		else if (item->depth() == 1)
 		{ // opening server
 			m_current = item;
-			QString	cmd = QString("smbclient -L %1 -W %2 %3").arg(item->text(0)).arg(item->parent()->text(0)).arg(smbPasswordString(m_login,m_password));
+			QString	cmd = QString("smbclient -L %1 ").arg(KShellProcess::quote(item->text(0)));
+			cmd += QString("-N -W %1").arg(KShellProcess::quote(item->parent()->text(0)));
 			m_proc->setExecutable(cmd);
 			startProcess(ShareListing);
 		}
+		if (oldpw.isNull())
+		   unsetenv("PASSWD");
+		else
+		   setenv("PASSWD", oldpw, 1);
+		if (olduser.isNull())
+		   unsetenv("USER");
+		else
+		   setenv("USER", olduser, 1);
 	}
 	QListView::setOpen(item,on);
 }
@

