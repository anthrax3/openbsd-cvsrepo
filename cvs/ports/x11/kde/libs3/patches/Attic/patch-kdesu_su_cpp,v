head	1.9;
access;
symbols
	OPENBSD_4_0:1.8.0.2
	OPENBSD_4_0_BASE:1.8
	OPENBSD_3_9:1.7.0.2
	OPENBSD_3_9_BASE:1.7
	OPENBSD_3_8:1.6.0.4
	OPENBSD_3_8_BASE:1.6
	OPENBSD_3_7:1.6.0.2
	OPENBSD_3_7_BASE:1.6
	OPENBSD_3_6:1.5.0.4
	OPENBSD_3_6_BASE:1.5
	OPENBSD_3_5:1.5.0.2
	OPENBSD_3_5_BASE:1.5
	OPENBSD_3_4:1.4.0.2
	OPENBSD_3_4_BASE:1.4
	OPENBSD_3_3:1.2.0.2
	OPENBSD_3_3_BASE:1.2
	OPENBSD_3_2:1.1.0.2
	OPENBSD_3_2_BASE:1.1;
locks; strict;
comment	@# @;


1.9
date	2006.10.12.23.12.19;	author espie;	state dead;
branches;
next	1.8;

1.8
date	2006.06.03.12.47.30;	author espie;	state Exp;
branches;
next	1.7;

1.7
date	2005.11.29.14.00.12;	author espie;	state Exp;
branches;
next	1.6;

1.6
date	2004.09.18.09.36.44;	author espie;	state Exp;
branches;
next	1.5;

1.5
date	2004.02.01.14.59.23;	author espie;	state Exp;
branches;
next	1.4;

1.4
date	2003.07.30.12.59.23;	author espie;	state Exp;
branches;
next	1.3;

1.3
date	2003.04.05.14.53.39;	author espie;	state Exp;
branches;
next	1.2;

1.2
date	2003.01.06.22.46.02;	author espie;	state Exp;
branches;
next	1.1;

1.1
date	2002.05.15.17.19.44;	author espie;	state Exp;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2003.01.06.23.29.24;	author espie;	state Exp;
branches;
next	;


desc
@@


1.9
log
@Update to 3.5.5
@
text
@$OpenBSD: patch-kdesu_su_cpp,v 1.8 2006/06/03 12:47:30 espie Exp $
--- kdesu/su.cpp.orig	Mon May 22 20:14:18 2006
+++ kdesu/su.cpp	Sun May 28 13:22:11 2006
@@@@ -41,19 +41,35 @@@@
 #ifndef __PATH_SU
 #define __PATH_SU "false"
 #endif
+#ifndef __PATH_SUDO
+#define __PATH_SUDO "false"
+#endif
 
+class SuProcess::SuProcessPrivate
+{
+public:
+    bool m_useSudo;
+};
 
 SuProcess::SuProcess(const QCString &user, const QCString &command)
 {
     m_User = user;
     m_Command = command;
+    d = new SuProcess::SuProcessPrivate();
+    d->m_useSudo = false;
 }
 
 
 SuProcess::~SuProcess()
 {
+    delete d;
 }
 
+void SuProcess::setUseSudo(bool use_sudo)
+{
+    d->m_useSudo = use_sudo;
+}
+
 int SuProcess::checkInstall(const char *password)
 {
     return exec(password, Install);
@@@@ -65,7 +81,7 @@@@ int SuProcess::checkNeedPassword()
 }
 
 /*
-* Execute a command with su(1).
+* Execute a command with su(1) or sudo
 */
 
 int SuProcess::exec(const char *password, int check)
@@@@ -80,12 +96,20 @@@@ int SuProcess::exec(const char *password
     args += "staff";
 #endif
 
+    if (d->m_useSudo)
+    {
+	args += "-S";
+	args += "-p";
+	args += "Password:";
+	args += "-u";
+    }
     if ((m_Scheduler != SchedNormal) || (m_Priority > 50))
         args += "root";
     else
         args += m_User;
     
-    args += "-c";
+    if (!d->m_useSudo)
+	args += "-c";
     args += QCString(__KDE_BINDIR) + "/kdesu_stub";
 #ifndef Q_OS_DARWIN
     args += "-";
@@@@ -100,7 +124,7 @@@@ int SuProcess::exec(const char *password
     }
 
     // kdDebug(900) << k_lineinfo << "Call StubProcess::exec()" << endl;
-    if (StubProcess::exec(command, args) < 0)
+    if (StubProcess::exec(d->m_useSudo ? __PATH_SUDO : __PATH_SU, args) < 0)
     {
         return check ? SuNotFound : -1;
     }
@@@@ -112,7 +136,8 @@@@ int SuProcess::exec(const char *password
     if (ret == error) 
     {
         if (!check)
-            kdError(900) << k_lineinfo << "Conversation with su failed\n";
+	    kdError(900) << k_lineinfo << "Conversation with " <<
+		(d->m_useSudo ? "sudo" : "su") << " failed\n";
         return ret;
     }
     if (check == NeedPassword)
@@@@ -218,6 +243,9 @@@@ int SuProcess::ConverseSU(const char *pa
                     kdDebug(900) << k_lineinfo << "Read line <" << more << ">" << endl;
                 }
     
+       	        if (d->m_useSudo && line != "Password:")
+ 		    break;
+ 
                 // Match "Password: " with the regex ^[^:]+:[\w]*$.
                 const uint len = line.length();
                 for (i=0,j=0,colon=0; i<len; i++) 
@@@@ -272,6 +300,9 @@@@ int SuProcess::ConverseSU(const char *pa
             }
             //////////////////////////////////////////////////////////////////////////
             case HandleStub:
+		if (d->m_useSudo && line == "Password:")
+		    return -1;
+ 
                 // Read till we get "kdesu_stub"
                 if (line == "kdesu_stub")
                 {
@


1.8
log
@minor update to 3.5.3, integrate libidn support (some more changes to come
to WANTLIB in packages dependent on KDE).
@
text
@d1 1
a1 1
$OpenBSD: patch-kdesu_su_cpp,v 1.7 2005/11/29 14:00:12 espie Exp $
@


1.7
log
@KDE 3.5.0, the beginning...

(samba/cups subpackages to fix library issues)
@
text
@d1 3
a3 3
$OpenBSD: patch-kdesu_su_cpp,v 1.6 2004/09/18 09:36:44 espie Exp $
--- kdesu/su.cpp.orig	Sat Sep 10 10:27:02 2005
+++ kdesu/su.cpp	Mon Nov 21 12:27:29 2005
d49 3
a51 3
@@@@ -75,12 +91,20 @@@@ int SuProcess::exec(const char *password
 
     QCStringList args;
d69 1
d71 1
a71 2
 
@@@@ -93,7 +117,7 @@@@ int SuProcess::exec(const char *password
d80 1
a80 1
@@@@ -105,7 +129,8 @@@@ int SuProcess::exec(const char *password
d90 1
a90 1
@@@@ -211,6 +236,9 @@@@ int SuProcess::ConverseSU(const char *pa
d100 1
a100 1
@@@@ -265,6 +293,9 @@@@ int SuProcess::ConverseSU(const char *pa
@


1.6
log
@update to kde 3.3.0.
@
text
@d1 3
a3 3
$OpenBSD: patch-kdesu_su_cpp,v 1.5 2004/02/01 14:59:23 espie Exp $
--- kdesu/su.cpp.orig	Sat May 22 22:55:16 2004
+++ kdesu/su.cpp	Mon Sep  6 02:36:32 2004
d44 3
a46 3
- * Execute a command with su(1).
+ * Execute a command with su(1) or sudo
  */
d49 1
a49 2
@@@@ -74,11 +90,19 @@@@ int SuProcess::exec(const char *password
 	setTerminal(true);
d52 1
d61 1
a61 1
 	args += "root";
d63 2
a64 1
 	args += m_User;
d71 1
a71 1
@@@@ -91,7 +115,7 @@@@ int SuProcess::exec(const char *password
d78 1
a78 1
 	return check ? SuNotFound : -1;
d80 1
a80 1
@@@@ -103,7 +127,8 @@@@ int SuProcess::exec(const char *password
d83 2
a84 2
 	if (!check)
-	    kdError(900) << k_lineinfo << "Conversation with su failed\n";
d87 2
a88 2
 	return ret;
     } 
d90 11
a100 2
@@@@ -201,6 +226,9 @@@@ int SuProcess::ConverseSU(const char *pa
 		kdDebug(900) << k_lineinfo << "Read line <" << more << ">" << endl;
d102 4
a105 13
             
+ 	    if (d->m_useSudo && line != "Password:")
+ 		break;
+ 
 	    // Match "Password: " with the regex ^[^:]+:[\w]*$.
 	    for (i=0,j=0,colon=0; i<line.length(); i++) 
 	    {
@@@@ -252,6 +280,9 @@@@ int SuProcess::ConverseSU(const char *pa
 	}
 
 	case HandleStub:
+ 	    if (d->m_useSudo && line == "Password:")
+ 		return -1;
d107 3
a109 3
 	    // Read till we get "kdesu_stub"
 	    if (line == "kdesu_stub")
 	    {
@


1.5
log
@basic import of kde 3.1.95, still missing a few parts.

TODO:
- compile the missing packages.
- redo konsole fixes for our ttys.
- figure out why kuickshow is broken.
- make sure we get all dependencies.
- repair kscd.
- find out why nsplugins does not like the native jdk.
- figure out how to get kvim to work.
- change filenames or adjust check-lib-depends to cope.
@
text
@d1 4
a4 4
$OpenBSD: patch-kdesu_su_cpp,v 1.4 2003/07/30 12:59:23 espie Exp $
--- kdesu/su.cpp.orig	2003-11-30 10:46:50.000000000 +0100
+++ kdesu/su.cpp	2004-01-19 13:31:20.000000000 +0100
@@@@ -41,17 +41,33 @@@@
d30 2
a31 2
+}
+
d35 2
a36 2
 }
 
d38 2
d68 1
d70 1
a70 2
     QCString command = __PATH_SU;
@@@@ -90,7 +114,7 @@@@ int SuProcess::exec(const char *password
d79 1
a79 1
@@@@ -102,7 +126,8 @@@@ int SuProcess::exec(const char *password
d89 1
a89 1
@@@@ -200,6 +225,9 @@@@ int SuProcess::ConverseSU(const char *pa
d99 1
a99 1
@@@@ -251,6 +279,9 @@@@ int SuProcess::ConverseSU(const char *pa
@


1.4
log
@Update to kde 3.1.3
@
text
@d1 3
a3 3
$OpenBSD: patch-kdesu_su_cpp,v 1.3 2003/04/05 14:53:39 espie Exp $
--- kdesu/su.cpp.orig	Sun Jul 13 21:27:55 2003
+++ kdesu/su.cpp	Tue Jul 15 19:25:14 2003
d68 1
a68 2
@@@@ -89,7 +113,7 @@@@ int SuProcess::exec(const char *password
           return check ? SuNotFound : -1;
d71 1
d77 2
a78 2
@@@@ -98,7 +122,8 @@@@ int SuProcess::exec(const char *password
     if (ret < 0) 
d86 8
a93 8
     if (check == 2)
@@@@ -181,6 +206,9 @@@@ int SuProcess::ConverseSU(const char *pa
 		return 0;
 	    }
 
+	    if (d->m_useSudo && line != "Password:")
+		break;
+
d97 1
a97 1
@@@@ -221,6 +249,9 @@@@ int SuProcess::ConverseSU(const char *pa
d100 4
a103 4
 	case 2:
+	    if (d->m_useSudo && line == "Password:")
+		return -1;
+
@


1.3
log
@Update most of kde to 3.1.1.
Needs rebuild to check against XFree 4.3.0.
@
text
@d1 3
a3 3
$OpenBSD: patch-kdesu_su_cpp,v 1.2 2003/01/06 22:46:02 espie Exp $
--- kdesu/su.cpp.orig	Sun Mar  2 20:00:58 2003
+++ kdesu/su.cpp	Sun Mar 30 16:24:08 2003
d47 1
a47 1
@@@@ -74,14 +90,22 @@@@ int SuProcess::exec(const char *password
d67 6
a72 1
-    if (StubProcess::exec(__PATH_SU, args) < 0)
d77 1
a77 1
@@@@ -90,7 +114,8 @@@@ int SuProcess::exec(const char *password
d87 1
a87 10
@@@@ -98,6 +123,8 @@@@ int SuProcess::exec(const char *password
 	if (ret == 1)
 	{
 	    kill(m_Pid, SIGTERM);
+	    close(m_Fd);
+	    m_Fd = -1;
 	    waitForChild();
 	}
 	return ret;
@@@@ -167,6 +194,9 @@@@ int SuProcess::ConverseSU(const char *pa
d97 1
a97 1
@@@@ -207,6 +237,9 @@@@ int SuProcess::ConverseSU(const char *pa
@


1.2
log
@Fix kdesu
@
text
@d1 3
a3 3
$OpenBSD: patch-kdesu_su_cpp,v 1.1 2002/05/15 17:19:44 espie Exp $
--- kdesu/su.cpp.orig	Mon Mar  4 01:59:16 2002
+++ kdesu/su.cpp	Mon Jan  6 23:40:41 2003
d91 1
a91 1
@@@@ -170,6 +197,9 @@@@ int SuProcess::ConverseSU(const char *pa
d101 1
a101 1
@@@@ -210,6 +240,9 @@@@ int SuProcess::ConverseSU(const char *pa
@


1.1
log
@Add support for sudo in kdesu.
The main problem is that sudo cannot be killed when it prompts password,
as it's run by root, so the correct way out is to close the write fd.
@
text
@d1 3
a3 3
$OpenBSD$
--- kdesu/su.cpp.orig	Sat May 11 11:13:25 2002
+++ kdesu/su.cpp	Wed May 15 12:02:01 2002
d47 1
a47 1
@@@@ -74,14 +90,20 @@@@ int SuProcess::exec(const char *password
d54 2
d72 1
a72 1
@@@@ -90,7 +112,8 @@@@ int SuProcess::exec(const char *password
d82 1
a82 1
@@@@ -98,6 +121,8 @@@@ int SuProcess::exec(const char *password
d91 20
@


1.1.2.1
log
@Reliability fix: let kdesu work with 3.2's su.
@
text
@d1 3
a3 3
$OpenBSD: patch-kdesu_su_cpp,v 1.2 2003/01/06 22:46:02 espie Exp $
--- kdesu/su.cpp.orig	Mon Mar  4 01:59:16 2002
+++ kdesu/su.cpp	Mon Jan  6 23:40:41 2003
d47 1
a47 1
@@@@ -74,14 +90,22 @@@@ int SuProcess::exec(const char *password
a53 2
+	args += "-p";
+	args += "Password:";
d70 1
a70 1
@@@@ -90,7 +114,8 @@@@ int SuProcess::exec(const char *password
d80 1
a80 1
@@@@ -98,6 +123,8 @@@@ int SuProcess::exec(const char *password
a88 20
@@@@ -170,6 +197,9 @@@@ int SuProcess::ConverseSU(const char *pa
 		return 0;
 	    }
 
+	    if (d->m_useSudo && line != "Password:")
+		break;
+
 	    // Match "Password: " with the regex ^[^:]+:[\w]*$.
 	    for (i=0,j=0,colon=0; i<line.length(); i++) 
 	    {
@@@@ -210,6 +240,9 @@@@ int SuProcess::ConverseSU(const char *pa
 	}
 
 	case 2:
+	    if (d->m_useSudo && line == "Password:")
+		return -1;
+
 	    // Read till we get "kdesu_stub"
 	    if (line == "kdesu_stub")
 	    {
@


