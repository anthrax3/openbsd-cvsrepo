head	1.2;
access;
symbols
	OPENBSD_4_1:1.1.0.2;
locks; strict;
comment	@# @;


1.2
date	2007.10.24.21.52.16;	author espie;	state dead;
branches;
next	1.1;

1.1
date	2007.10.04.19.00.17;	author jasper;	state Exp;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2007.10.05.12.40.02;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.2
log
@update to 3.5.8
@
text
@$OpenBSD: patch-kdm_backend_session_c,v 1.1 2007/10/04 19:00:17 jasper Exp $
--- kdm/backend/session.c.orig	Thu Jan 19 18:03:14 2006
+++ kdm/backend/session.c	Tue Sep 25 20:28:25 2007
@@@@ -121,8 +121,9 @@@@ conv_auto( int what, const char *prompt ATTR_UNUSED )
 static void
 DoAutoLogon( void )
 {
-	StrDup( &curuser, td->autoUser );
-	StrDup( &curpass, td->autoPass );
+	ReStr( &curuser, td->autoUser );
+	ReStr( &curpass, td->autoPass );
+	ReStr( &curtype, "classic" );
 	cursource = PWSRC_AUTOLOGIN;
 }
 
@@@@ -141,7 +142,9 @@@@ AutoLogon( Time_t tdiff )
 		td->hstent->npass = 0;
 		newdmrc = td->hstent->nargs;
 		td->hstent->nargs = 0;
+		ReStr( &curtype, "classic" );
 		cursource = (td->hstent->rLogin == 1) ? PWSRC_RELOGIN : PWSRC_MANUAL;
+		return 1;
 	} else if (*td->autoUser && !td->autoDelay && (tdiff > 0 || td->autoAgain))
 	{
 		unsigned int lmask;
@@@@ -153,11 +156,9 @@@@ AutoLogon( Time_t tdiff )
 		if (lmask & ShiftMask)
 			return 0;
 		DoAutoLogon();
-	} else {
-		cursource = PWSRC_MANUAL;
-		return 0;
+		return 1;
 	}
-	return 1;
+	return 0;
 }
 
 
@@@@ -369,6 +370,7 @@@@ CtrlGreeterWait( int wreply )
 			if (curtype) free( curtype );
 			curtype = GRecvStr();
 			Debug( " type %\"s\n", curtype );
+			cursource = PWSRC_MANUAL;
 			if (Verify( conv_interact, rootok )) {
 				Debug( " -> return success\n" );
 				GSendInt( V_OK );
@@@@ -378,7 +380,6 @@@@ CtrlGreeterWait( int wreply )
 		case G_AutoLogin:
 			Debug( "G_AutoLogin\n" );
 			DoAutoLogon();
-			StrDup( &curtype, "classic" );
 			if (Verify( conv_auto, FALSE )) {
 				Debug( " -> return success\n" );
 				GSendInt( V_OK );
@@@@ -565,7 +566,7 @@@@ ManageSession( struct display *d )
 	tdiff = td->autoAgain ? 
 	           1 : time( 0 ) - td->hstent->lastExit - td->openDelay;
 	if (AutoLogon( tdiff )) {
-		if (!StrDup( &curtype, "classic" ) || !Verify( conv_auto, FALSE ))
+		if (!Verify( conv_auto, FALSE ))
 			goto gcont;
 		if (greeter)
 			GSendInt( V_OK );
@


1.1
log
@SECURITY FIX for KDM, "which would allow a normal user to login
as another user or even root without properly supplying
login credentials."

http://www.kde.org/info/security/advisory-20070919-1.txt

Tested by ian@@ and Johan M:son Lindman
@
text
@d1 1
a1 1
$OpenBSD$
@


1.1.2.1
log
@MFC (original commit jasper@@):
SECURITY FIX for KDM, "which would allow a normal user to login
as another user or even root without properly supplying
login credentials."
http://www.kde.org/info/security/advisory-20070919-1.txt

ok sturm@@
@
text
@d3 2
a4 2
+++ kdm/backend/session.c	Fri Oct  5 10:53:54 2007
@@@@ -121,8 +121,9 @@@@ conv_auto( int what, const char *prompt 
@

