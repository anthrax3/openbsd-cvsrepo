head	1.14;
access;
symbols
	OPENBSD_6_2:1.14.0.2
	OPENBSD_6_2_BASE:1.14
	OPENBSD_6_1:1.5.0.2
	OPENBSD_6_1_BASE:1.5
	zhuk_20161225:1.1.1.1
	zhuk:1.1.1;
locks; strict;
comment	@# @;


1.14
date	2017.08.24.09.45.23;	author sthen;	state Exp;
branches;
next	1.13;
commitid	PnxiRKB45Z5BPng8;

1.13
date	2017.07.29.00.07.13;	author zhuk;	state Exp;
branches;
next	1.12;
commitid	PLavWrVVGir1L8eQ;

1.12
date	2017.07.27.17.25.40;	author sthen;	state Exp;
branches;
next	1.11;
commitid	lvxxf5E3K8cLmT2o;

1.11
date	2017.07.26.22.45.34;	author sthen;	state Exp;
branches;
next	1.10;
commitid	tD4MFrpYYDDL2UFT;

1.10
date	2017.07.23.21.33.14;	author zhuk;	state Exp;
branches;
next	1.9;
commitid	oCStYeucGBzBUa25;

1.9
date	2017.07.21.15.28.25;	author zhuk;	state Exp;
branches;
next	1.8;
commitid	7BuLAeEnoqn4hZar;

1.8
date	2017.07.19.22.30.12;	author zhuk;	state Exp;
branches;
next	1.7;
commitid	cT4jucPRqxgWtJA0;

1.7
date	2017.07.17.08.34.37;	author zhuk;	state Exp;
branches;
next	1.6;
commitid	3tUsNizeEEvC87c0;

1.6
date	2017.05.13.11.06.01;	author naddy;	state Exp;
branches;
next	1.5;
commitid	o74KnganFpmLArid;

1.5
date	2017.02.01.14.07.30;	author sthen;	state Exp;
branches;
next	1.4;
commitid	EtnkML0dn8HANqGH;

1.4
date	2017.01.27.16.13.08;	author zhuk;	state Exp;
branches;
next	1.3;
commitid	QZuellQgImf7lyCn;

1.3
date	2017.01.08.11.51.14;	author sthen;	state Exp;
branches;
next	1.2;
commitid	gNY9f9252c9SdSRb;

1.2
date	2016.12.28.01.41.23;	author zhuk;	state Exp;
branches;
next	1.1;
commitid	zznJcJZGYlX0U9PC;

1.1
date	2016.12.25.14.13.11;	author zhuk;	state Exp;
branches
	1.1.1.1;
next	;
commitid	QPfzuwiSTmth4MkN;

1.1.1.1
date	2016.12.25.14.13.11;	author zhuk;	state Exp;
branches;
next	;
commitid	QPfzuwiSTmth4MkN;


desc
@@


1.14
log
@bump; textproc/icu4c now uses multi-packages for -wwwdata
@
text
@# $OpenBSD: Makefile,v 1.13 2017/07/29 00:07:13 zhuk Exp $

DISTNAME =		qtbase-opensource-src-${DIST_VERSION}
QT5NAME =		Qt5 core

COMMENT-main =		C++ general-purpose toolkit
COMMENT-global =	global Qt5 documentation internals
COMMENT-mysql =		MySQL plugin for Qt5
COMMENT-psql =		PostgresSQL plugin for Qt5
COMMENT-sqlite2 =	SQLite 2.x plugin for Qt5
COMMENT-tds =		TDS plugin for Qt5

PKGNAME-mysql =		qt5-mysql-${VERSION}
PKGNAME-global = 	qt5-global-${VERSION}
PKGNAME-psql =		qt5-postgresql-${VERSION}
PKGNAME-sqlite2 =	qt5-sqlite2-${VERSION}
PKGNAME-tds =		qt5-tds-${VERSION}

REVISION =		3
REVISION-main =		4

PKG_ARCH-global =	*
PKG_ARCH-examples =	*

DPB_PROPERTIES =	parallel

SHARED_LIBS +=	Qt5Concurrent		2.1
SHARED_LIBS +=	Qt5Core			2.1
SHARED_LIBS +=	Qt5DBus			2.1
SHARED_LIBS +=	Qt5Gui			2.1
SHARED_LIBS +=	Qt5Network		2.1
SHARED_LIBS +=	Qt5OpenGL		2.1
SHARED_LIBS +=	Qt5PrintSupport		2.1
SHARED_LIBS +=	Qt5Sql			2.1
SHARED_LIBS +=	Qt5Test			2.1
SHARED_LIBS +=	Qt5Widgets		2.1
SHARED_LIBS +=	Qt5Xml			2.1
SHARED_LIBS +=	Qt5EglDeviceIntegration	1.1
SHARED_LIBS +=	Qt5XcbQpa		1.1
SHARED_LIBS +=	Qt5EglFSDeviceIntegration	0.0
SHARED_LIBS +=	Qt5EglFsKmsSupport	0.0

WANTLIB-main =  ${WANTLIB} ${COMPILER_LIBCXX}
WANTLIB-main += EGL GL ICE SM X11 X11-xcb
WANTLIB-main += Xext Xi atk-1.0 c cairo cairo-gobject cups
WANTLIB-main += dbus-1 drm execinfo fontconfig freetype gbm gdk-3 gdk_pixbuf-2.0
WANTLIB-main += gio-2.0 glib-2.0 gobject-2.0 gtk-3 gthread-2.0 harfbuzz
WANTLIB-main += icudata icui18n icuuc iodbc jpeg m pango-1.0 pangocairo-1.0
WANTLIB-main += pcre2-16 png pthread sqlite3 xcb xcb-glx xcb-icccm xcb-image
WANTLIB-main += xcb-keysyms xcb-randr xcb-render xcb-render-util xcb-shape
WANTLIB-main += xcb-shm xcb-sync xcb-xfixes xcb-xinerama xcb-xkb xkbcommon
WANTLIB-main += xkbcommon-x11 z

# SSL libs are dlopen()d
WANTLIB-main += ssl crypto

WANTLIB-global =

WANTLIB-mysql =		${COMPILER_LIBCXX} Qt5Core Qt5Sql
WANTLIB-mysql +=	m pthread mysqlclient_r

WANTLIB-psql =		${COMPILER_LIBCXX} Qt5Core Qt5Sql
WANTLIB-psql +=		m pthread pq

WANTLIB-sqlite2 =	${COMPILER_LIBCXX} Qt5Core Qt5Sql
WANTLIB-sqlite2 +=	m pthread sqlite

WANTLIB-tds =		${COMPILER_LIBCXX} Qt5Core Qt5Sql
WANTLIB-tds +=		m pthread sybdb

# there is no -sqlite3 because it's heavily used by Qt itself (.qch files)
MULTI_PACKAGES =	-main -examples -global -mysql -psql -sqlite2 -tds

# qmake module is used only for running tests and setting vars
MODQT_DEPS =		No
MODQMAKE_PROJECTS =	tests/tests.pro

# no leveldb dependency, requires -lmemenv; QtWebKit uses internal version
LIB_DEPENDS-main =	${LIB_DEPENDS} \
			databases/iodbc \
			databases/sqlite3 \
			devel/atk \
			devel/harfbuzz \
			devel/libexecinfo \
			devel/pango \
			devel/pcre2 \
			graphics/cairo \
			graphics/gdk-pixbuf2 \
			print/cups,-libs \
			textproc/icu4c \
			x11/gnome/at-spi2-core \
			x11/gtk+3 \
			x11/xkbcommon

# those come from gthread-2.0, not used by Qt itself
WANTLIB-main +=		intl
LIB_DEPENDS-main +=	devel/gettext

LIB_DEPENDS-global =

LIB_DEPENDS-mysql =	${BASE_PKGPATH},-main>=${VERSION:R},<${QT5_NEXT_VERSION} \
			${MODGCC4_CPPLIBDEP} \
			databases/mariadb

LIB_DEPENDS-psql =	${BASE_PKGPATH},-main>=${VERSION:R},<${QT5_NEXT_VERSION} \
			${MODGCC4_CPPLIBDEP} \
			databases/postgresql

LIB_DEPENDS-sqlite2 =	${BASE_PKGPATH},-main>=${VERSION:R},<${QT5_NEXT_VERSION} \
			${MODGCC4_CPPLIBDEP} \
			databases/sqlite

LIB_DEPENDS-tds =	${BASE_PKGPATH},-main>=${VERSION:R},<${QT5_NEXT_VERSION} \
			${MODGCC4_CPPLIBDEP} \
			databases/freetds

# Nothing in qtbase links to pulseaudio, but configure checks
# are recorded.
# The atspi is checked at configure time and used via D-Bus.
BUILD_DEPENDS =		audio/pulseaudio \
			geo/geoclue \
			x11/dbus \
			x11/gnome/at-spi2-core

RUN_DEPENDS-main =	${RUN_DEPENDS} \
			geo/geoclue \
			x11/dbus \
			x11/gnome/at-spi2-core
RUN_DEPENDS-global =
RUN_DEPENDS-examples =
RUN_DEPENDS-mysql =
RUN_DEPENDS-psql =
RUN_DEPENDS-sqlite2 =
RUN_DEPENDS-tds =

CONFIGURE_STYLE =	simple

FLAVORS =		debug
FLAVOR ?=

# readability macros
QT_BASEDIR =	${PREFIX}/lib/qt5
QT_INCDIR =	${PREFIX}/include/X11/qt5
QT_EXAMPLES =	${QT_BASEDIR}/examples
QT_DOC =	${PREFIX}/share/doc/qt5
QT_PLUGINSDIR =	${QT_BASEDIR}/plugins
QT_BINDIR =	${QT_BASEDIR}/bin
QT_PKGCFGDIR =	${QT_BASEDIR}/pkgconfig
QT_CMAKEDIR =	${QT_BASEDIR}/cmake

# generic args
CONFIGURE_ARGS =	-confirm-license \
			-opensource \
			-rpath \
			-shared \
			-verbose \
			-no-pch \
			-no-compile-examples

# Don't run tests inside main build.
# XXX It looks like affecting other Qt modules as well.
CONFIGURE_ARGS +=	-nomake tests

.if ${FLAVOR:Mdebug}
CONFIGURE_ARGS +=	-debug
.else
CONFIGURE_ARGS +=	-release
.endif

# paths
CONFIGURE_ARGS +=	-sysconfdir ${SYSCONFDIR} \
			-prefix ${QT_BASEDIR} \
			-plugindir ${QT_PLUGINSDIR} \
			-libdir ${QT_BASEDIR} \
			-headerdir ${QT_INCDIR} \
			-examplesdir ${QT_EXAMPLES} \
			-docdir ${QT_DOC} \
			-datadir ${QT_BASEDIR} \
			-bindir ${QT_BINDIR} \
			-R${X11BASE}/lib \
			-L${X11BASE}/lib

# switch to c++14 after getting GCC 5.0 enabled by default via COMPILER?
CONFIGURE_ARGS +=	-c++std c++11

# other options
CONFIGURE_ARGS +=	-no-journald \
			-no-mtdev \
			-opengl desktop \
			-system-harfbuzz \
			-system-proxies \
			-system-sqlite \
			-system-xcb

.if ${MACHINE_ARCH} == "amd64" || ${MACHINE_ARCH} == "i386"
# AVX:    Sandy Bridge/Haswell, but not all models. AMD Bulldozer/Jaguar.
# SSE4.2: Nehalem, Silvermont Atom, AMD Bulldozer/Jaguar.
# SSE4.1: Core 2 (Penryn), Nehalem, Silvermont Atom, AMD Bulldozer/Jaguar.
# SSSE3:  Core 2 Duo, Atom, AMD Bulldozer/Bobcat.
# SSE3:   missing on very early 64-bit AMD.
CONFIGURE_ARGS +=	-no-sse4.1 -no-sse4.2 -no-avx -no-avx2
CONFIGURE_ARGS +=	-no-ssse3 -no-sse3
.endif

.if ${MACHINE_ARCH} == "i386"
CONFIGURE_ARGS +=	-no-sse2
.endif

MODULES =		devel/qmake
MODQMAKE_ENV +=		${TEST_ENV}
CONFIGURE_ENV +=	${MODQMAKE_ENV}
MAKE_ENV +=		${MODQMAKE_ENV}

.include <bsd.port.arch.mk>

# See qtbase/tests/README for details
TEST_IS_INTERACTIVE =	X11
TEST_DEPENDS =		audio/sox
#			kde4-minimal-*|kdebase-*:meta/kde4,-minimal

post-extract:
	mkdir -p ${WRKDIST}/mkspecs/openbsd-clang
	cp ${FILESDIR}/clang-qmake.conf ${WRKDIST}/mkspecs/openbsd-clang/qmake.conf
	cp ${WRKDIST}/mkspecs/openbsd-g++/qplatformdefs.h ${WRKDIST}/mkspecs/openbsd-clang/

pre-configure:
	@@gccbasedir=`ecpp -print-search-dirs | awk '/^install:/{print $$2}'`; \
	perl ${PORTSDIR}/infrastructure/bin/pkg_subst \
	    -D OPENBSD_INCDIR_PREPEND="$${gccbasedir}include" \
	    ${WRKSRC}/mkspecs/openbsd-g++/qmake.conf \
	    ${WRKSRC}/mkspecs/openbsd-clang/qmake.conf

do-test:
	#
	# WARNING!
	# Many tests won't run if window manager has either
	# "focus follows pointer", or "click to activate" policy.
	#
	${MODQMAKE_configure}
	${MODQMAKE_build}
	${MODQMAKE_test}

post-install:
	# often-used includes directory
	! test -d ${PREFIX}/lib/qt5 || \
	    cd ${PREFIX}/lib/qt5 && ln -sf ../../include/X11/qt5 include

.include <bsd.port.mk>
@


1.13
log
@Rework the process of building Qt5 documentation:

Now all documentation is built using a separate port using
the --single-exec option of qdoc. This gaves significant speedup
as well as fixing quiet a few interlinking problems.

All -qch, -html and -docindex subpackages of Qt modules ports are
removed. The qt5-html and qt5-qch are now provided by x11/qt5/docs
instead of meta/qt5, thus REVISION set from the start.

This commit should fix problems with building Qt5 documentation
that people started seeing after switching to Clang. We also could
zap some interdependencies between Qt5 modules as well, but that's
a different story.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.12 2017/07/27 17:25:40 sthen Exp $
d20 1
@


1.12
log
@bump more subpackages
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.11 2017/07/26 22:45:34 sthen Exp $
a137 1
PSEUDO_FLAVORS =	no_examples
d208 1
@


1.11
log
@bump LIBCXX/LIBECXX/COMPILER_LIBCXX ports.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.10 2017/07/23 21:33:14 zhuk Exp $
d19 1
a19 1
REVISION-main =		3
@


1.10
log
@Do not ever try to use [[...]] C++ attributes unless we're in C++17 mode.

Fixes devel/kf5/ki18n at least.

Prodded by espie@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.9 2017/07/21 15:28:25 zhuk Exp $
d19 1
a19 1
REVISION-main =		2
@


1.9
log
@Fix OpenSSL (actually, LibreSSL) run-time detection code.

Original report from Brendan Doyle <doyle.brendan@@yandex.com>, thanks.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.8 2017/07/19 22:30:12 zhuk Exp $
d19 1
a19 1
REVISION-main =		1
@


1.8
log
@Return back QMAKE_INCDIR_PREPEND hack for clang until a better solution
is found.

Hardly prodded by espie@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.7 2017/07/17 08:34:37 zhuk Exp $
d19 1
a19 1
REVISION-main =		0
@


1.7
log
@Update from Qt 5.6.2 (LTS) to Qt 5.9.1 (LTS).

Tested with both GCC and CLang (less through).

This forces updating x11/py-qt5, which forces update of devel/py-sip,
which forces update of x11/py-qt4, but, thankfully, no breakage detected.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.6 2017/05/13 11:06:01 naddy Exp $
d18 2
@


1.6
log
@missing bump after addition of the clang files; ok espie@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.5 2017/02/01 14:07:30 sthen Exp $
a18 2
REVISION-main =		4

d24 23
a46 22
SHARED_LIBS +=	Qt5Concurrent		2.0
SHARED_LIBS +=	Qt5Core			2.0
SHARED_LIBS +=	Qt5DBus			2.0
SHARED_LIBS +=	Qt5Gui			2.0
SHARED_LIBS +=	Qt5Network		2.0
SHARED_LIBS +=	Qt5OpenGL		2.0
SHARED_LIBS +=	Qt5PrintSupport		2.0
SHARED_LIBS +=	Qt5Sql			2.0
SHARED_LIBS +=	Qt5Test			2.0
SHARED_LIBS +=	Qt5Widgets		2.0
SHARED_LIBS +=	Qt5Xml			2.0
SHARED_LIBS +=	Qt5EglDeviceIntegration	1.0
SHARED_LIBS +=	Qt5XcbQpa		1.0

WANTLIB-main =  ${WANTLIB}
WANTLIB-main += EGL GL ICE SM X11 X11-xcb Xcomposite Xcursor Xdamage
WANTLIB-main += Xext Xfixes Xi Xinerama Xrandr Xrender atk-1.0 c cairo
WANTLIB-main += cups dbus-1 execinfo fontconfig freetype gdk-x11-2.0
WANTLIB-main += gdk_pixbuf-2.0 gio-2.0 glib-2.0 gobject-2.0 gthread-2.0
WANTLIB-main += gtk-x11-2.0 harfbuzz icudata icui18n icuuc iodbc jpeg
WANTLIB-main += m pango-1.0 pangocairo-1.0 pangoft2-1.0 pcre16 png
WANTLIB-main += proxy pthread sqlite3 xcb xcb-glx xcb-icccm xcb-image
a49 1
WANTLIB-main += drm gbm
d56 2
a57 2
WANTLIB-mysql =		${MODGCC4_CPPWANTLIB} Qt5Core Qt5Sql
WANTLIB-mysql +=	crypto m pthread mysqlclient_r ssl z
d59 1
a59 1
WANTLIB-psql =		${MODGCC4_CPPWANTLIB} Qt5Core Qt5Sql
d62 1
a62 1
WANTLIB-sqlite2 =	${MODGCC4_CPPWANTLIB} Qt5Core Qt5Sql
d65 1
a65 1
WANTLIB-tds =		${MODGCC4_CPPWANTLIB} Qt5Core Qt5Sql
a70 2
MODULES =		devel/gettext

d83 1
a85 1
			net/libproxy \
d88 2
a89 1
			x11/gtk+2 \
d92 4
d114 3
a116 2
# nothing in qtbase links to pulseaudio, but configure checks
# are recorded
d119 2
a120 1
			x11/dbus
d124 2
a125 1
			x11/dbus
d181 3
d185 1
a185 3
CONFIGURE_ARGS +=	-c++11 \
			-no-alsa \
			-no-journald \
d207 1
d218 5
d227 2
a228 1
	    ${WRKSRC}/mkspecs/openbsd-g++/qmake.conf
d238 1
@


1.5
log
@Record the dependency on libssl/libcrypto in WANTLIB-main. This would
have been missed previously listed because Qt likes to dlopen() things
so check-lib-depends can't find it, which would stop qt5base getting
updated correctly by pkg_add -u when ssl/crypto libs are updated.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.4 2017/01/27 16:13:08 zhuk Exp $
d19 1
a19 1
REVISION-main =		3
@


1.4
log
@Fix after recent LibreSSL changes.

Nowadays we have fake SSL_CTRL_SET_CURVES macro, and SSL_CTX_set1_curves
defined as synonym to SSL_CTX_set1_groups. So use the latter instead
of the former.

The patch should be tweaked furthermore before proposing it upstream,
but for now we can at least build things again.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.3 2017/01/08 11:51:14 sthen Exp $
d19 1
a19 1
REVISION-main =		2
d52 3
@


1.3
log
@Backport Qt5 commit https://codereview.qt-project.org/#/c/140750/4//ALL,unified
to prevent unloading Qt plugins in various destructors. Fixes a segfault seen
closing otter-browser using WM kill; otter bug report pointing at the Qt bug
was tracked down by awolk@@.  OK zhuk@@
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.2 2016/12/28 01:41:23 zhuk Exp $
d19 1
a19 1
REVISION-main =		1
@


1.2
log
@Rework Qt5 documentation handling:

  * Move share/qt5/doc/* in qtbase from -main to a separate subpackage,
    -global, which (as a bonus) "owns" share/doc/qt5/ directory;

  * Move FOO.index files from -html to a separate subpackage, -docindex,
    and make 'em depend on qtbase,-global;

  * Make DEP,-docindex automatically added as BDEP for each DEP in
    LDEP and BDEP mentioned for -main;

  * Make it clear that building -qch without -html is impossible;

While there, fixed a few minor issues.

This make at least qtenginio,-html build correctly, which failed before
due to missing .index files during qdoc run. Initial report from kili@@.
@
text
@d1 1
a1 1
# $OpenBSD: Makefile,v 1.1.1.1 2016/12/25 14:13:11 zhuk Exp $
d19 1
a19 1
REVISION-main =		0
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
# $OpenBSD$
d7 1
d14 1
d19 3
d53 2
d68 1
a68 1
MULTI_PACKAGES =	-main -examples -mysql -psql -sqlite2 -tds
d92 2
d119 1
@


1.1.1.1
log
@Import Qt 5.6.2.

The port is now being split into pieces. Cleanup and conflict resolving
to follow.
@
text
@@
