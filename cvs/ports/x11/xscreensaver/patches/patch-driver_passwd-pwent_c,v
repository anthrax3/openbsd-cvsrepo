head	1.3;
access;
symbols
	OPENBSD_6_1:1.3.0.4
	OPENBSD_6_1_BASE:1.3
	OPENBSD_6_0:1.3.0.2
	OPENBSD_6_0_BASE:1.3;
locks; strict;
comment	@# @;


1.3
date	2016.05.12.11.36.48;	author sthen;	state Exp;
branches;
next	1.2;
commitid	4scoMPT7HfnwFy7M;

1.2
date	2008.12.28.15.45.31;	author ajacoutot;	state dead;
branches;
next	1.1;

1.1
date	2008.10.27.19.49.39;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.3
log
@use getpwnam_shadow to unbreak, from Gregor Best
@
text
@$OpenBSD$
--- driver/passwd-pwent.c.orig	Sat Dec 27 11:17:26 2008
+++ driver/passwd-pwent.c	Wed May 11 23:43:04 2016
@@@@ -133,7 +133,7 @@@@ user_name (void)
      still work.  Right?) */
   if (!u || !*u)
     {
-      struct passwd *p = getpwuid (getuid ());
+      struct passwd *p = getpwuid_shadow (getuid ());
       u = (p ? p->pw_name : 0);
     }
 
@@@@ -177,7 +177,7 @@@@ get_encrypted_passwd(const char *user)
 
   if (user && *user && !result)
     {					/* Check non-shadow passwords too. */
-      struct passwd *p = getpwnam(user);
+      struct passwd *p = getpwnam_shadow(user);
       if (p && passwd_known_p (p->pw_passwd))
 	result = strdup(p->pw_passwd);
     }
@


1.2
log
@- remove the unfinished bsd_auth support for now ; I got late on this and
I'd rather finish/modify it outside of the tree when I have more time.

ok jasper@@
@
text
@d1 10
a10 5
$OpenBSD: patch-driver_passwd-pwent_c,v 1.1 2008/10/27 19:49:39 ajacoutot Exp $
--- driver/passwd-pwent.c.orig	Thu Oct 23 16:10:09 2008
+++ driver/passwd-pwent.c	Thu Oct 23 16:13:00 2008
@@@@ -200,10 +200,10 @@@@ get_encrypted_passwd(const char *user)
 	*s = 0;
d13 1
a13 6
-#ifndef HAVE_PAM
+#if !defined(HAVE_PAM) && !defined(BSD_AUTH)
   /* We only issue this warning if not compiled with support for PAM.
      If we're using PAM, it's not unheard of that normal pwent passwords
-     would be unavailable. */
+     would be unavailable. This is also true if we use bsd_auth(3). */
d15 7
a21 2
   if (!result)
     fprintf (stderr, "%s: couldn't get password of \"%s\"\n",
@


1.1
log
@- implement  bsd_auth(3) authentication ; benefits:
* no need to run xscreensaver setuid root anymore
* you can use whatever passwd backend you configured in login.conf(5)
  (kerberos, ldap...) to unlock the screen and not just local passwd

Sent upstream.

feedback from millert@@
"get it in" jasper@@
@
text
@d1 1
a1 1
$OpenBSD$
@

