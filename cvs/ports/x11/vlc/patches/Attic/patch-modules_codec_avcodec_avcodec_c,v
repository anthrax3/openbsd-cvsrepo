head	1.8;
access;
symbols
	OPENBSD_5_7:1.6.0.4
	OPENBSD_5_7_BASE:1.6
	OPENBSD_5_6:1.6.0.2
	OPENBSD_5_6_BASE:1.6;
locks; strict;
comment	@# @;


1.8
date	2015.05.24.07.16.31;	author ajacoutot;	state dead;
branches;
next	1.7;
commitid	ppIzpTyUJwYSsnNW;

1.7
date	2015.04.30.06.32.21;	author ajacoutot;	state Exp;
branches;
next	1.6;
commitid	XOAdGwSQ6H9ZhKOk;

1.6
date	2014.05.05.08.34.08;	author brad;	state Exp;
branches;
next	1.5;

1.5
date	2014.04.28.17.35.35;	author brad;	state Exp;
branches;
next	1.4;

1.4
date	2014.04.12.20.41.26;	author brad;	state Exp;
branches;
next	1.3;

1.3
date	2013.04.11.17.58.42;	author brad;	state dead;
branches;
next	1.2;

1.2
date	2013.03.30.02.06.26;	author brad;	state Exp;
branches;
next	1.1;

1.1
date	2013.03.27.13.34.06;	author brad;	state Exp;
branches;
next	;


desc
@@


1.8
log
@Update to vlc-2.2.1.

from brad (maintainer)
@
text
@$OpenBSD: patch-modules_codec_avcodec_avcodec_c,v 1.7 2015/04/30 06:32:21 ajacoutot Exp $

Deal with newer FFmpeg API.

--- modules/codec/avcodec/avcodec.c.orig	Fri Feb 21 10:27:16 2014
+++ modules/codec/avcodec/avcodec.c	Wed Apr 29 00:46:46 2015
@@@@ -47,10 +47,6 @@@@
 #include "avcodec.h"
 #include "chroma.h"
 
-#if LIBAVCODEC_VERSION_INT < AV_VERSION_INT( 52, 25, 0 )
-#   error You must update libavcodec to a version >= 52.25.0
-#endif
-
 /*****************************************************************************
  * decoder_sys_t: decoder descriptor
  *****************************************************************************/
@@@@ -263,56 +259,12 @@@@ static int OpenDecoder( vlc_object_t *p_this )
     }
 
     /* *** get a p_context *** */
-#if LIBAVCODEC_VERSION_MAJOR >= 54
     p_context = avcodec_alloc_context3(p_codec);
-#else
-    p_context = avcodec_alloc_context();
-#endif
     if( !p_context )
         return VLC_ENOMEM;
     p_context->debug = var_InheritInteger( p_dec, "ffmpeg-debug" );
     p_context->opaque = (void *)p_this;
 
-    /* Set CPU capabilities */
-    unsigned i_cpu = vlc_CPU();
-    p_context->dsp_mask = 0;
-    if( !(i_cpu & CPU_CAPABILITY_MMX) )
-    {
-        p_context->dsp_mask |= AV_CPU_FLAG_MMX;
-    }
-    if( !(i_cpu & CPU_CAPABILITY_MMXEXT) )
-    {
-        p_context->dsp_mask |= AV_CPU_FLAG_MMX2;
-    }
-    if( !(i_cpu & CPU_CAPABILITY_3DNOW) )
-    {
-        p_context->dsp_mask |= AV_CPU_FLAG_3DNOW;
-    }
-    if( !(i_cpu & CPU_CAPABILITY_SSE) )
-    {
-        p_context->dsp_mask |= AV_CPU_FLAG_SSE;
-    }
-    if( !(i_cpu & CPU_CAPABILITY_SSE2) )
-    {
-        p_context->dsp_mask |= AV_CPU_FLAG_SSE2;
-    }
-#ifdef AV_CPU_FLAG_SSE3
-    if( !(i_cpu & CPU_CAPABILITY_SSE3) )
-        p_context->dsp_mask |= AV_CPU_FLAG_SSE3;
-#endif
-#ifdef AV_CPU_FLAG_SSSE3
-    if( !(i_cpu & CPU_CAPABILITY_SSSE3) )
-        p_context->dsp_mask |= AV_CPU_FLAG_SSSE3;
-#endif
-#ifdef AV_CPU_FLAG_SSE4
-    if( !(i_cpu & CPU_CAPABILITY_SSE4_1) )
-        p_context->dsp_mask |= AV_CPU_FLAG_SSE4;
-#endif
-#ifdef AV_CPU_FLAG_SSE42
-    if( !(i_cpu & CPU_CAPABILITY_SSE4_2) )
-        p_context->dsp_mask |= AV_CPU_FLAG_SSE42;
-#endif
-
     p_dec->b_need_packetized = true;
     switch( i_cat )
     {
@@@@ -357,9 +309,6 @@@@ static void CloseDecoder( vlc_object_t *p_this )
 
     switch( p_sys->i_cat )
     {
-    case AUDIO_ES:
-         EndAudioDec ( p_dec );
-        break;
     case VIDEO_ES:
          EndVideoDec ( p_dec );
         break;
@@@@ -395,9 +344,6 @@@@ void InitLibavcodec( vlc_object_t *p_object )
     /* *** init ffmpeg library (libavcodec) *** */
     if( !b_ffmpeginit )
     {
-#if LIBAVCODEC_VERSION_MAJOR < 54
-        avcodec_init();
-#endif
         avcodec_register_all();
         b_ffmpeginit = true;
 
@@@@ -454,11 +400,7 @@@@ int ffmpeg_OpenCodec( decoder_t *p_dec )
     }
     int ret;
     vlc_avcodec_lock();
-#if LIBAVCODEC_VERSION_MAJOR >= 54
     ret = avcodec_open2( p_sys->p_context, p_sys->p_codec, NULL /* options */ );
-#else
-    ret = avcodec_open( p_sys->p_context, p_sys->p_codec );
-#endif
     vlc_avcodec_unlock();
     if( ret < 0 )
         return VLC_EGENERIC;
@


1.7
log
@Garbage collect old code for older FFmpeg releases and some cleanup.

from brad (maintainer)
@
text
@d1 1
a1 1
$OpenBSD: patch-modules_codec_avcodec_avcodec_c,v 1.6 2014/05/05 08:34:08 brad Exp $
@


1.6
log
@Add a comment to the top of the patches.
@
text
@d1 1
a1 1
$OpenBSD: patch-modules_codec_avcodec_avcodec_c,v 1.5 2014/04/28 17:35:35 brad Exp $
d6 24
a29 2
+++ modules/codec/avcodec/avcodec.c	Thu Apr 24 21:19:30 2014
@@@@ -274,44 +274,11 @@@@ static int OpenDecoder( vlc_object_t *p_this )
d32 1
a32 1
     /* Set CPU capabilities */
d58 1
a58 5
+#if LIBAVUTIL_VERSION_INT >= AV_VERSION_INT( 51, 25, 0 )
+    av_set_cpu_flags_mask( INT_MAX & ~GetVlcDspMask() );
+#else
+    p_context->dsp_mask = GetVlcDspMask();
 #endif
d71 1
a71 1
 
d74 2
a75 1
@@@@ -357,9 +324,6 @@@@ static void CloseDecoder( vlc_object_t *p_this )
d85 22
@


1.5
log
@Update VLC's avcodec plugin to use the avcodec_decode_audio4() API for decoding
audio.

ok ajacoutot@@
@
text
@d1 4
a4 1
$OpenBSD: patch-modules_codec_avcodec_avcodec_c,v 1.4 2014/04/12 20:41:26 brad Exp $
@


1.4
log
@Pull some bits from 2.1 to deal with newer FFmpeg API.

ok sthen@@
@
text
@d1 4
a4 4
$OpenBSD$
--- modules/codec/avcodec/avcodec.c.orig	Thu Apr 10 01:51:51 2014
+++ modules/codec/avcodec/avcodec.c	Thu Apr 10 01:56:03 2014
@@@@ -274,43 +274,10 @@@@ static int OpenDecoder( vlc_object_t *p_this )
d33 5
a37 1
-#endif
d49 1
a49 5
+#if LIBAVUTIL_VERSION_INT >= AV_VERSION_INT( 51, 25, 0 )
+    av_set_cpu_flags_mask( INT_MAX & ~GetVlcDspMask() );
+#else
+    p_context->dsp_mask = GetVlcDspMask();
 #endif
d52 11
@


1.3
log
@Update to VLC 2.0.6.

ok sthen@@
@
text
@d1 48
a48 12
$OpenBSD: patch-modules_codec_avcodec_avcodec_c,v 1.2 2013/03/30 02:06:26 brad Exp $

Re-enable the multi-threaded mode for the avcodec backend.

--- modules/codec/avcodec/avcodec.c.orig	Tue Mar 19 19:45:29 2013
+++ modules/codec/avcodec/avcodec.c	Tue Mar 19 19:46:39 2013
@@@@ -132,7 +132,7 @@@@ vlc_module_begin ()
     add_bool( "ffmpeg-hw", false, HW_TEXT, HW_LONGTEXT, false )
 #endif
 #if defined(FF_THREAD_FRAME)
-    add_integer( "ffmpeg-threads", 1, THREADS_TEXT, THREADS_LONGTEXT, true );
+    add_integer( "ffmpeg-threads", 0, THREADS_TEXT, THREADS_LONGTEXT, true );
d51 1
a51 1
 
@


1.2
log
@Add a comment.
@
text
@d1 1
a1 1
$OpenBSD: patch-modules_codec_avcodec_avcodec_c,v 1.1 2013/03/27 13:34:06 brad Exp $
@


1.1
log
@Re-enable the multi-threaded mode for the avcodec backend.

ok sthen@@
@
text
@d1 4
a4 1
$OpenBSD$
@

