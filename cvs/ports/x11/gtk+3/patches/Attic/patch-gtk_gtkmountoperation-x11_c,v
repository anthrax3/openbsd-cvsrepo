head	1.13;
access;
symbols
	OPENBSD_5_1_BASE:1.5
	OPENBSD_5_1:1.5.0.2;
locks; strict;
comment	@# @;


1.13
date	2014.05.12.16.09.57;	author ajacoutot;	state dead;
branches;
next	1.12;

1.12
date	2014.04.25.15.15.11;	author ajacoutot;	state Exp;
branches;
next	1.11;

1.11
date	2012.07.16.06.36.01;	author ajacoutot;	state dead;
branches;
next	1.10;

1.10
date	2012.07.09.17.21.27;	author ajacoutot;	state Exp;
branches;
next	1.9;

1.9
date	2012.07.09.16.33.21;	author ajacoutot;	state Exp;
branches;
next	1.8;

1.8
date	2012.07.08.18.03.39;	author ajacoutot;	state Exp;
branches;
next	1.7;

1.7
date	2012.07.08.17.09.17;	author sthen;	state Exp;
branches;
next	1.6;

1.6
date	2012.03.23.13.21.27;	author ajacoutot;	state dead;
branches;
next	1.5;

1.5
date	2011.10.17.17.08.06;	author ajacoutot;	state Exp;
branches;
next	1.4;

1.4
date	2011.10.15.12.03.52;	author ajacoutot;	state Exp;
branches;
next	1.3;

1.3
date	2011.09.26.07.14.50;	author ajacoutot;	state dead;
branches;
next	1.2;

1.2
date	2011.09.21.14.05.58;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2011.09.20.21.12.09;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.13
log
@Update to gtk+3-3.12.2.
@
text
@$OpenBSD: patch-gtk_gtkmountoperation-x11_c,v 1.12 2014/04/25 15:15:11 ajacoutot Exp $

From 8935d2f123878c31af69b6c6034069ad540b13c7 Mon Sep 17 00:00:00 2001
From: Antoine Jacoutot <ajacoutot@@gnome.org>
Date: Fri, 25 Apr 2014 14:37:59 +0200
Subject: openbsd: properly set len for gtkmountoperation-x11

--- gtk/gtkmountoperation-x11.c.orig	Wed Apr 16 14:45:30 2014
+++ gtk/gtkmountoperation-x11.c	Wed Apr 16 16:35:38 2014
@@@@ -41,9 +41,6 @@@@
 #include <errno.h>
 
 #if defined(__OpenBSD__)
-#include <stdlib.h>
-#include <sys/param.h>
-#include <fcntl.h>
 #include <sys/sysctl.h>
 #endif
 
@@@@ -731,11 +728,11 @@@@ pid_get_parent (GPid pid)
   int mib[] = { CTL_KERN, KERN_PROC, KERN_PROC_PID, pid,
                 sizeof(struct kinfo_proc), 0 };
 
-  if (sysctl(mib, G_N_ELEMENTS (mib), NULL, &len, NULL, 0) == -1)
+  if (sysctl (mib, G_N_ELEMENTS (mib), NULL, &len, NULL, 0) == -1)
       return (-1);
   mib[5] = (len / sizeof(struct kinfo_proc));
 
-  if (sysctl(mib, G_N_ELEMENTS (mib), &kp, &len, NULL, 0) < 0)
+  if (sysctl (mib, G_N_ELEMENTS (mib), &kp, &len, NULL, 0) < 0)
       return -1;
 
   ppid = kp.p_ppid;
@@@@ -746,21 +743,23 @@@@ pid_get_parent (GPid pid)
 static gchar *
 pid_get_env (GPid pid, const gchar *key)
 {
-  size_t len = PATH_MAX;
-  char **strs = NULL;
-  char *ret;
+  size_t len;
+  char **strs;
+  char *ret = NULL;
   char *end;
   int key_len;
   int i;
 
   int mib[] = { CTL_KERN, KERN_PROC_ARGS, pid, KERN_PROC_ENV };
 
-  strs = (char **)realloc(strs, len);
+  if (sysctl (mib, G_N_ELEMENTS (mib), NULL, &len, NULL, 0) == -1)
+    return ret;
 
+  strs = g_malloc0 (len);
+
   key_len = strlen (key);
 
-  ret = NULL;
-  if (sysctl(mib, G_N_ELEMENTS (mib), strs, &len, NULL, 0) != -1)
+  if (sysctl (mib, G_N_ELEMENTS (mib), strs, &len, NULL, 0) != -1)
     {
       for (i = 0; strs[i] != NULL; i++)
 	{
@@@@ -783,18 +782,20 @@@@ pid_get_env (GPid pid, const gchar *key)
 static gchar *
 pid_get_command_line (GPid pid)
 {
-  size_t len = PATH_MAX;
-  char **strs = NULL;
-  char *ret = NULL;
-  char *end;
+  size_t len;
+  char **strs;
+  char *ret, *end;
 
   int mib[] = { CTL_KERN, KERN_PROC_ARGS, pid, KERN_PROC_ARGV };
 
-  strs = (char **)realloc(strs, len);
+  if (sysctl (mib, G_N_ELEMENTS (mib), NULL, &len, NULL, 0) == -1)
+    return NULL;
 
-  if (sysctl(mib, G_N_ELEMENTS (mib), strs, &len, NULL, 0) == -1) {
+  strs = g_malloc0 (len);
+
+  if (sysctl (mib, G_N_ELEMENTS (mib), strs, &len, NULL, 0) == -1) {
     g_free (strs);
-    return ret;
+    return NULL;
   }
 
   ret = g_strjoinv (" ", strs);
@


1.12
log
@Properly set len for gtkmountoperation-x11.
@
text
@d1 1
a1 1
$OpenBSD$
@


1.11
log
@Update to gtk+3-3.4.4.
@
text
@d1 1
a1 1
$OpenBSD: patch-gtk_gtkmountoperation-x11_c,v 1.10 2012/07/09 17:21:27 ajacoutot Exp $
d3 1
a3 1
From 974212ec825d8d50bdea8ab955b6f19b8ed1672f Mon Sep 17 00:00:00 2001
d5 2
a6 2
Date: Mon, 09 Jul 2012 16:20:34 +0000
Subject: OpenBSD: use G_N_ELEMENTS instead of nitems
d8 13
a20 3
--- gtk/gtkmountoperation-x11.c.orig	Sun Mar 18 21:44:21 2012
+++ gtk/gtkmountoperation-x11.c	Mon Jul  9 18:07:49 2012
@@@@ -731,11 +731,11 @@@@ pid_get_parent (GPid pid)
d24 2
a25 2
-  if (sysctl(mib, nitems(mib), NULL, &len, NULL, 0) == -1)
+  if (sysctl(mib, G_N_ELEMENTS (mib), NULL, &len, NULL, 0) == -1)
d29 2
a30 2
-  if (sysctl(mib, nitems(mib), &kp, &len, NULL, 0) < 0)
+  if (sysctl(mib, G_N_ELEMENTS (mib), &kp, &len, NULL, 0) < 0)
d34 22
a55 1
@@@@ -760,7 +760,7 @@@@ pid_get_env (GPid pid, const gchar *key)
d58 3
a60 3
   ret = NULL;
-  if (sysctl(mib, nitems(mib), strs, &len, NULL, 0) != -1)
+  if (sysctl(mib, G_N_ELEMENTS (mib), strs, &len, NULL, 0) != -1)
d64 22
a85 6
@@@@ -792,7 +792,7 @@@@ pid_get_command_line (GPid pid)
 
   strs = (char **)realloc(strs, len);
 
-  if (sysctl(mib, nitems(mib), strs, &len, NULL, 0) == -1) {
+  if (sysctl(mib, G_N_ELEMENTS (mib), strs, &len, NULL, 0) == -1) {
d87 2
a88 1
     return ret;
d90 2
@


1.10
log
@Committed upstream.
@
text
@d1 1
a1 1
$OpenBSD: patch-gtk_gtkmountoperation-x11_c,v 1.9 2012/07/09 16:33:21 ajacoutot Exp $
@


1.9
log
@Use G_N_ELEMENTS from GLib instead of nitems.
@
text
@d1 1
a1 1
$OpenBSD: patch-gtk_gtkmountoperation-x11_c,v 1.8 2012/07/08 18:03:39 ajacoutot Exp $
d3 4
a6 1
https://bugzilla.gnome.org/show_bug.cgi?id=679593
@


1.8
log
@BZ links.
@
text
@d1 1
a1 1
$OpenBSD: patch-gtk_gtkmountoperation-x11_c,v 1.7 2012/07/08 17:09:17 sthen Exp $
d5 3
a7 3
--- gtk/gtkmountoperation-x11.c.orig	Sun Jul  8 09:40:51 2012
+++ gtk/gtkmountoperation-x11.c	Sun Jul  8 09:42:51 2012
@@@@ -731,6 +731,9 @@@@ pid_get_parent (GPid pid)
d11 2
a12 4
+#ifndef nitems
+#define nitems(_a)      (sizeof((_a)) / sizeof((_a)[0]))
+#endif
   if (sysctl(mib, nitems(mib), NULL, &len, NULL, 0) == -1)
d15 24
@


1.7
log
@don't rely on param.h for nitems(), ok ajacoutot@@
@
text
@d1 4
a4 1
$OpenBSD$
@


1.6
log
@Update to gtk+3-3.3.18.
@
text
@d1 13
a13 133
$OpenBSD: patch-gtk_gtkmountoperation-x11_c,v 1.5 2011/10/17 17:08:06 ajacoutot Exp $

From d987a01d80126ee351727d1603a599c4edb66eca Mon Sep 17 00:00:00 2001
From: Antoine Jacoutot <ajacoutot@@openbsd.org>
Date: Sat, 15 Oct 2011 09:27:47 +0000
Subject: GMountOperation on OpenBSD: remove the need for kvm(3)

--- gtk/gtkmountoperation-x11.c.orig	Thu Sep 22 23:46:14 2011
+++ gtk/gtkmountoperation-x11.c	Fri Oct 14 15:52:24 2011
@@@@ -43,8 +43,8 @@@@
 #include <errno.h>
 
 #if defined(__OpenBSD__)
+#include <stdlib.h>
 #include <sys/param.h>
-#include <kvm.h>
 #include <fcntl.h>
 #include <sys/sysctl.h>
 #endif
@@@@ -726,46 +726,44 @@@@ pid_get_command_line (GPid pid)
 static GPid
 pid_get_parent (GPid pid)
 {
-  struct kinfo_proc *proc;
-  int count;
-  kvm_t *kvm;
-  GPid ppid = 0;
+  struct kinfo_proc kp;
+  size_t len;
+  GPid ppid;
 
-  kvm = kvm_openfiles (NULL, NULL, NULL, KVM_NO_FILES, NULL);
-  if (kvm == NULL)
-    return 0;
+  int mib[] = { CTL_KERN, KERN_PROC, KERN_PROC_PID, pid,
+                sizeof(struct kinfo_proc), 0 };
 
-  proc = kvm_getprocs (kvm, KERN_PROC_PID, pid, sizeof(struct kinfo_proc), &count);
-  if (count == 1)
-    ppid = proc->p_ppid;
+  if (sysctl(mib, nitems(mib), NULL, &len, NULL, 0) == -1)
+      return (-1);
+  mib[5] = (len / sizeof(struct kinfo_proc));
 
-  kvm_close (kvm);
+  if (sysctl(mib, nitems(mib), &kp, &len, NULL, 0) < 0)
+      return -1;
+
+  ppid = kp.p_ppid;
+
   return ppid;
 }
 
 static gchar *
 pid_get_env (GPid pid, const gchar *key)
 {
-  kvm_t *kvm;
-  struct kinfo_proc *proc;
-  char **strs;
+  size_t len = PATH_MAX;
+  char **strs = NULL;
   char *ret;
   char *end;
   int key_len;
-  int count;
   int i;
 
-  kvm = kvm_openfiles (NULL, NULL, NULL, KVM_NO_FILES, NULL);
-  if (kvm == NULL)
-    return NULL;
+  int mib[] = { CTL_KERN, KERN_PROC_ARGS, pid, KERN_PROC_ENV };
 
+  strs = (char **)realloc(strs, len);
+
   key_len = strlen (key);
 
   ret = NULL;
-  proc = kvm_getprocs (kvm, KERN_PROC_PID, pid, sizeof(struct kinfo_proc), &count);
-  if (proc != NULL)
+  if (sysctl(mib, nitems(mib), strs, &len, NULL, 0) != -1)
     {
-      strs = kvm_getenvv (kvm, proc, 0);
       for (i = 0; strs[i] != NULL; i++)
 	{
 	  if (g_str_has_prefix (strs[i], key) && (*(strs[i] + key_len) == '='))
@@@@ -780,35 +778,33 @@@@ pid_get_env (GPid pid, const gchar *key)
 	}
     }
 
-  kvm_close (kvm);
+  g_free (strs);
   return ret;
 }
 
 static gchar *
 pid_get_command_line (GPid pid)
 {
-  kvm_t *kvm;
-  struct kinfo_proc *proc;
-  int count;
-  char **strs;
-  char *ret;
+  size_t len = PATH_MAX;
+  char **strs = NULL;
+  char *ret = NULL;
   char *end;
 
-  kvm = kvm_openfiles (NULL, NULL, NULL, KVM_NO_FILES, NULL);
-  if (kvm == NULL)
-    return NULL;
+  int mib[] = { CTL_KERN, KERN_PROC_ARGS, pid, KERN_PROC_ARGV };
 
-  proc = kvm_getprocs (kvm, KERN_PROC_PID, pid, sizeof (struct kinfo_proc), &count);
-  if (proc == NULL)
-    return NULL;
+  strs = (char **)realloc(strs, len);
 
-  strs = kvm_getargv (kvm, proc, 0);
+  if (sysctl(mib, nitems(mib), strs, &len, NULL, 0) == -1) {
+    g_free (strs);
+    return ret;
+  }
+
   ret = g_strjoinv (" ", strs);
   /* skip invalid UTF-8 */
   if (!g_utf8_validate (ret, -1, (const gchar **) &end))
     *end = '\0';
 
-  kvm_close (kvm);
+  g_free (strs);
   return ret;
 }
 
@


1.5
log
@Sync, no pkg change.
@
text
@d1 1
a1 1
$OpenBSD: patch-gtk_gtkmountoperation-x11_c,v 1.4 2011/10/15 12:03:52 ajacoutot Exp $
@


1.4
log
@Update to gtk+3-3.2.1.

While here, move away from kvm(3) to use sysctl(3) instead and don't
link to libkvm anymore.
inputs and ok robert@@ jmatthew@@
@
text
@d1 1
a1 1
$OpenBSD$
d3 4
a6 1
https://bugzilla.gnome.org/show_bug.cgi?id=661835
@


1.3
log
@Update to stable gtk+3-3.2.0.
@
text
@d1 1
a1 1
$OpenBSD: patch-gtk_gtkmountoperation-x11_c,v 1.2 2011/09/21 14:05:58 ajacoutot Exp $
d3 1
a3 4
From 3d165c1a902fc0a5f32898e406a79e53ed4bcc97 Mon Sep 17 00:00:00 2001
From: Antoine Jacoutot <ajacoutot@@openbsd.org>
Date: Tue, 20 Sep 2011 09:57:49 +0000
Subject: gtkmountoperation-x11: unbreak compilation on OpenBSD.
d5 3
a7 3
--- gtk/gtkmountoperation-x11.c.orig	Tue Sep 20 11:10:25 2011
+++ gtk/gtkmountoperation-x11.c	Tue Sep 20 11:11:03 2011
@@@@ -43,6 +43,7 @@@@
d11 3
a13 2
+#include <sys/param.h>
 #include <kvm.h>
d16 115
@


1.2
log
@Sync patch.
@
text
@d1 1
a1 1
$OpenBSD: patch-gtk_gtkmountoperation-x11_c,v 1.1 2011/09/20 21:12:09 ajacoutot Exp $
@


1.1
log
@Update to gtk+3-3.1.92.

ok jasper@@ robert@@
@
text
@d1 7
a7 1
$OpenBSD$
@

