head	1.6;
access;
symbols
	OPENBSD_6_0:1.6.0.10
	OPENBSD_6_0_BASE:1.6
	OPENBSD_5_9:1.6.0.6
	OPENBSD_5_9_BASE:1.6
	OPENBSD_5_8:1.6.0.8
	OPENBSD_5_8_BASE:1.6
	OPENBSD_5_7:1.6.0.4
	OPENBSD_5_7_BASE:1.6
	OPENBSD_5_6:1.6.0.2
	OPENBSD_5_6_BASE:1.6
	OPENBSD_5_0:1.2.0.6
	OPENBSD_5_0_BASE:1.2
	OPENBSD_4_9:1.2.0.4
	OPENBSD_4_9_BASE:1.2
	OPENBSD_4_8:1.2.0.2
	OPENBSD_4_8_BASE:1.2
	OPENBSD_4_7:1.1.0.2
	OPENBSD_4_7_BASE:1.1;
locks; strict;
comment	@# @;


1.6
date	2014.03.29.08.56.24;	author ajacoutot;	state Exp;
branches;
next	1.5;

1.5
date	2011.12.28.08.57.18;	author ajacoutot;	state dead;
branches;
next	1.4;

1.4
date	2011.09.26.10.47.35;	author jasper;	state Exp;
branches;
next	1.3;

1.3
date	2011.09.12.07.28.53;	author jasper;	state Exp;
branches;
next	1.2;

1.2
date	2010.04.20.15.14.28;	author jasper;	state Exp;
branches;
next	1.1;

1.1
date	2009.11.15.14.10.02;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.6
log
@Fix some memory leaks and crashes (from upstream).
@
text
@$OpenBSD$

From e951cfaad73000b533304b52a5dbbce23c11efd9 Mon Sep 17 00:00:00 2001
From: Jasper St. Pierre <jstpierre@@mecheye.net>
Date: Mon, 18 Nov 2013 23:11:17 +0000
Subject: Revert "Memory leak fixes"

From fabf5ba19d1cead5c91c3669e48f090e7a60d16f Mon Sep 17 00:00:00 2001
From: Jasper St. Pierre <jstpierre@@mecheye.net>
Date: Mon, 18 Nov 2013 23:10:57 +0000
Subject: Memory leak fixes

--- libmenu/gmenu-tree.c.orig	Sat Mar 29 09:35:55 2014
+++ libmenu/gmenu-tree.c	Sat Mar 29 09:35:31 2014
@@@@ -1242,13 +1242,9 @@@@ gmenu_tree_directory_make_path (GMenuTreeDirectory *di
   append_directory_path (directory, path);
 
   if (entry != NULL)
-    {
-      const char *basename;
+    g_string_append (path,
+		     desktop_entry_get_basename (entry->desktop_entry));
 
-      basename = desktop_entry_get_basename (entry->desktop_entry);
-      g_string_append (path, basename);
-    }
-
   return g_string_free (path, FALSE);
 }
 
@@@@ -1277,7 +1273,7 @@@@ gmenu_tree_entry_get_desktop_file_path (GMenuTreeEntry
 const char *
 gmenu_tree_entry_get_desktop_file_id (GMenuTreeEntry *entry)
 {
-  g_return_val_if_fail (entry != NULL, FALSE);
+  g_return_val_if_fail (entry != NULL, NULL);
 
   return entry->desktop_file_id;
 }
@


1.5
log
@Our gnome-session already exports XDG_MENU_PREFIX in the environment, so
no need to play with get/setenv.
This will ease future updates.
@
text
@d1 1
a1 1
$OpenBSD: patch-libmenu_gmenu-tree_c,v 1.4 2011/09/26 10:47:35 jasper Exp $
d3 4
a6 1
Set default menu to gnome-applications.menu if XDG_MENU_PREFIX is not set.
d8 9
a16 3
--- libmenu/gmenu-tree.c.orig	Mon Aug 29 08:42:34 2011
+++ libmenu/gmenu-tree.c	Mon Sep 26 11:19:16 2011
@@@@ -23,6 +23,7 @@@@
d18 5
a22 9
 #include <string.h>
 #include <errno.h>
+#include <stdlib.h>
 
 #include "menu-layout.h"
 #include "menu-monitor.h"
@@@@ -411,16 +412,13 @@@@ gmenu_tree_canonicalize_path (GMenuTree *tree,
     {
       menu_file = tree->basename;
d24 2
a25 35
-      if (strcmp (tree->basename, "applications.menu") == 0 &&
-          g_getenv ("XDG_MENU_PREFIX"))
-        {
-          char *prefixed_basename;
-          prefixed_basename = g_strdup_printf ("%s%s",
-                                               g_getenv ("XDG_MENU_PREFIX"),
-                                               tree->basename);
-          canonicalize_basename (tree, prefixed_basename);
-          g_free (prefixed_basename);
-        }
+      setenv ("XDG_MENU_PREFIX", "gnome-", 0);
+      char *prefixed_basename;
+      prefixed_basename = g_strdup_printf ("%s%s",
+                                           g_getenv ("XDG_MENU_PREFIX"),
+                                           tree->basename);
+      canonicalize_basename (tree, prefixed_basename);
+      g_free (prefixed_basename);
 
       if (!tree->canonical)
         canonicalize_basename (tree, tree->basename);
@@@@ -1875,18 +1873,15 @@@@ load_parent_merge_file (GMenuTree      *tree,
   found = FALSE;
   menu_file = g_strconcat (menu_name, ".menu", NULL);
 
-  if (strcmp (menu_file, "applications.menu") == 0 &&
-      g_getenv ("XDG_MENU_PREFIX"))
-    {
-      char *prefixed_basename;
-      prefixed_basename = g_strdup_printf ("%s%s",
-                                           g_getenv ("XDG_MENU_PREFIX"),
-                                           menu_file);
-      found = load_parent_merge_file_from_basename (tree, loaded_menu_files,
-                                                    layout, prefixed_basename,
-                                                    canonical_basedir);
-      g_free (prefixed_basename);
d27 10
a36 9
+  setenv ("XDG_MENU_PREFIX", "gnome-", 0);
+  char *prefixed_basename;
+  prefixed_basename = g_strdup_printf ("%s%s",
+                                       g_getenv ("XDG_MENU_PREFIX"),
+                                       menu_file);
+  found = load_parent_merge_file_from_basename (tree, loaded_menu_files,
+                                                layout, prefixed_basename,
+                                                canonical_basedir);
+  g_free (prefixed_basename);
d38 2
a39 2
   if (!found)
     {
@


1.4
log
@- update to 3.2.0
* disable gmenu-simple-editor as it's not been ported to PyGi yet.
@
text
@d1 1
a1 1
$OpenBSD: patch-libmenu_gmenu-tree_c,v 1.3 2011/09/12 07:28:53 jasper Exp $
@


1.3
log
@Moar GNOME3 merge
@
text
@d1 1
a1 1
$OpenBSD: patch-libmenu_gmenu-tree_c,v 1.1 2011/05/17 14:03:48 ajacoutot Exp $
d5 2
a6 2
--- libmenu/gmenu-tree.c.orig	Tue Mar 30 01:54:53 2010
+++ libmenu/gmenu-tree.c	Tue Apr 20 17:06:31 2010
d15 1
a15 1
@@@@ -540,16 +541,13 @@@@ gmenu_tree_canonicalize_path (GMenuTree *tree)
d17 1
a17 1
       gmenu_tree_remove_menu_file_monitors (tree);
d39 1
a39 1
@@@@ -1923,18 +1921,15 @@@@ load_parent_merge_file (GMenuTree      *tree,
@


1.2
log
@- update gnome-menus to 2.30.0
@
text
@d1 1
a1 1
$OpenBSD: patch-libmenu_gmenu-tree_c,v 1.1 2009/11/15 14:10:02 ajacoutot Exp $
@


1.1
log
@If XDG_MENU_PREFIX is not set, set it. This allows the menu to work when
not using gnome-session and not knowing about XDG_MENU_PREFIX.
@
text
@d1 1
a1 1
$OpenBSD$
d5 2
a6 2
--- libmenu/gmenu-tree.c.orig	Thu Oct  1 13:08:33 2009
+++ libmenu/gmenu-tree.c	Sun Nov 15 12:55:42 2009
d39 1
a39 1
@@@@ -1949,18 +1947,15 @@@@ load_parent_merge_file (GMenuTree      *tree,
@

