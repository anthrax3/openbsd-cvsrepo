head	1.12;
access;
symbols
	OPENBSD_5_7:1.11.0.2
	OPENBSD_5_7_BASE:1.11
	OPENBSD_5_6:1.10.0.2
	OPENBSD_5_6_BASE:1.10
	OPENBSD_5_5:1.9.0.2
	OPENBSD_5_5_BASE:1.9
	OPENBSD_5_4:1.8.0.2
	OPENBSD_5_4_BASE:1.8
	OPENBSD_5_3:1.5.0.6
	OPENBSD_5_3_BASE:1.5
	OPENBSD_5_2:1.5.0.4
	OPENBSD_5_2_BASE:1.5
	OPENBSD_5_1_BASE:1.5
	OPENBSD_5_1:1.5.0.2;
locks; strict;
comment	@# @;


1.12
date	2015.03.28.18.04.06;	author ajacoutot;	state dead;
branches;
next	1.11;
commitid	5exa8fUjjKm8PFv6;

1.11
date	2014.10.17.12.54.17;	author ajacoutot;	state Exp;
branches;
next	1.10;
commitid	aKqDmjcK1vE8wRoV;

1.10
date	2014.03.27.15.12.29;	author ajacoutot;	state Exp;
branches;
next	1.9;

1.9
date	2013.08.06.19.06.13;	author ajacoutot;	state Exp;
branches;
next	1.8;

1.8
date	2013.04.10.14.30.43;	author ajacoutot;	state Exp;
branches;
next	1.7;

1.7
date	2013.04.10.14.13.53;	author ajacoutot;	state dead;
branches;
next	1.6;

1.6
date	2013.03.29.16.28.27;	author ajacoutot;	state Exp;
branches;
next	1.5;

1.5
date	2011.12.16.17.36.55;	author ajacoutot;	state Exp;
branches;
next	1.4;

1.4
date	2011.10.21.14.26.56;	author ajacoutot;	state Exp;
branches;
next	1.3;

1.3
date	2011.10.16.08.54.53;	author ajacoutot;	state Exp;
branches;
next	1.2;

1.2
date	2011.09.22.18.34.24;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2011.09.18.08.36.56;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.12
log
@Update to meta-tracker-1.4.0.
@
text
@$OpenBSD: patch-src_tracker-control_tracker-control-general_c,v 1.11 2014/10/17 12:54:17 ajacoutot Exp $

https://bugzilla.gnome.org/show_bug.cgi?id=697719

--- src/tracker-control/tracker-control-general.c.orig	Wed Sep  3 09:32:43 2014
+++ src/tracker-control/tracker-control-general.c	Fri Oct 17 14:43:18 2014
@@@@ -21,6 +21,15 @@@@
 
 #include <errno.h>
 
+#ifdef __OpenBSD__
+#include <sys/param.h>
+#include <sys/proc.h>
+#include <sys/sysctl.h>
+#include <fcntl.h>
+#include <limits.h>
+#include <kvm.h>
+#endif
+
 #include <glib.h>
 #include <glib/gi18n.h>
 
@@@@ -862,6 +871,7 @@@@ tracker_control_general_run (void)
 	if (kill_option != TERM_NONE ||
 	    terminate_option != TERM_NONE ||
 	    list_processes) {
+#ifndef __OpenBSD__
 		guint32 own_pid;
 		guint32 own_uid;
 		gchar *own_pid_str;
@@@@ -922,7 +932,30 @@@@ tracker_control_general_run (void)
 #endif
 			if (strv && strv[0]) {
 				gchar *basename;
+#else /* __OpenBSD__ */
+		gchar *basename, **strv;
+		int i, nproc;
+		struct kinfo_proc *plist, *kp;
+		char buf[_POSIX2_LINE_MAX];
+		kvm_t *kd;
+ 
+		if ((kd = kvm_openfiles (NULL, NULL, NULL, KVM_NO_FILES, buf)) == NULL) {
+			printf ("%s\n", buf);
+			return EXIT_FAILURE;
+		}
+ 
+		plist = kvm_getprocs (kd, KERN_PROC_ALL, 0, sizeof (*plist), &nproc);
+		if (plist == NULL)
+			return EXIT_FAILURE;
+ 
+		for (i = 0, kp = plist; i < nproc; i++, kp++) {
+			if ((kp->p_flag & P_SYSTEM) != 0)
+ 				continue;
 
+			if ((strv = kvm_getargv (kd, kp, 0)) == NULL)
+					continue;
+#endif
+
 				basename = g_path_get_basename (strv[0]);
 
 				if ((g_str_has_prefix (basename, "tracker") == TRUE ||
@@@@ -931,7 +964,11 @@@@ tracker_control_general_run (void)
 				    g_str_has_suffix (basename, "-status-icon") == FALSE) {
 					pid_t pid;
 
+#ifndef __OpenBSD__
 					pid = atoi (l->data);
+#else
+					pid = kp->p_pid;
+#endif
 					str = g_strdup_printf (_("Found process ID %d for '%s'"), pid, basename);
 					g_print ("%s\n", str);
 					g_free (str);
@@@@ -984,6 +1021,7 @@@@ tracker_control_general_run (void)
 				g_free (basename);
 			}
 
+#ifndef __OpenBSD__
 			g_strfreev (strv);
 			g_free (contents);
 			g_free (filename);
@@@@ -991,6 +1029,7 @@@@ tracker_control_general_run (void)
 
 		g_slist_foreach (pids, (GFunc) g_free, NULL);
 		g_slist_free (pids);
+#endif
 
 		/* If we just wanted to list processes, all done */
 		if (list_processes &&
@


1.11
log
@Update to meta-tracker-1.2.3.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_tracker-control_tracker-control-general_c,v 1.10 2014/03/27 15:12:29 ajacoutot Exp $
@


1.10
log
@Update to (meta-)tracker-1.0.0.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_tracker-control_tracker-control-general_c,v 1.9 2013/08/06 19:06:13 ajacoutot Exp $
d5 2
a6 2
--- src/tracker-control/tracker-control-general.c.orig	Thu Mar 20 13:22:33 2014
+++ src/tracker-control/tracker-control-general.c	Thu Mar 27 15:41:16 2014
d23 1
a23 1
@@@@ -855,6 +864,7 @@@@ tracker_control_general_run (void)
d31 1
a31 1
@@@@ -915,7 +925,30 @@@@ tracker_control_general_run (void)
d62 1
a62 1
@@@@ -924,7 +957,11 @@@@ tracker_control_general_run (void)
d74 1
a74 1
@@@@ -977,6 +1014,7 @@@@ tracker_control_general_run (void)
d82 1
a82 1
@@@@ -984,6 +1022,7 @@@@ tracker_control_general_run (void)
@


1.9
log
@Update to meta-tracker 0.16.2.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_tracker-control_tracker-control-general_c,v 1.8 2013/04/10 14:30:43 ajacoutot Exp $
d5 2
a6 2
--- src/tracker-control/tracker-control-general.c.orig	Wed Jul 31 23:40:48 2013
+++ src/tracker-control/tracker-control-general.c	Thu Aug  1 08:56:12 2013
d23 1
a23 1
@@@@ -653,6 +662,7 @@@@ tracker_control_general_run (void)
d31 1
a31 1
@@@@ -713,7 +723,30 @@@@ tracker_control_general_run (void)
d62 1
a62 1
@@@@ -722,7 +755,11 @@@@ tracker_control_general_run (void)
d74 1
a74 1
@@@@ -775,6 +812,7 @@@@ tracker_control_general_run (void)
d82 1
a82 1
@@@@ -782,6 +820,7 @@@@ tracker_control_general_run (void)
@


1.8
log
@cvs(1) missed those...???
@
text
@d1 1
a1 1
$OpenBSD$
d5 2
a6 2
--- src/tracker-control/tracker-control-general.c.orig	Sun Mar 17 12:35:11 2013
+++ src/tracker-control/tracker-control-general.c	Wed Apr 10 16:17:26 2013
d23 1
a23 1
@@@@ -645,6 +654,7 @@@@ tracker_control_general_run (void)
d31 2
a32 2
@@@@ -695,7 +705,30 @@@@ tracker_control_general_run (void)
 			strv = g_strsplit (contents, "^@@", 2);
d62 1
a62 1
@@@@ -704,7 +737,11 @@@@ tracker_control_general_run (void)
d74 1
a74 1
@@@@ -757,6 +794,7 @@@@ tracker_control_general_run (void)
d82 1
a82 1
@@@@ -764,6 +802,7 @@@@ tracker_control_general_run (void)
@


1.7
log
@Rework all kvm(3) patches to a state closer to being commitable upstream.
Fix a few implicit declarations.
Remove patch-src_libtracker-miner_tracker-password-provider_c which is not
needed anymore.
@
text
@d1 4
a4 1
$OpenBSD: patch-src_tracker-control_tracker-control-general_c,v 1.6 2013/03/29 16:28:27 ajacoutot Exp $
d6 2
a7 2
+++ src/tracker-control/tracker-control-general.c	Fri Mar 29 16:39:44 2013
@@@@ -21,6 +21,16 @@@@
d12 3
a14 1
+#include <stdio.h>
a17 3
+#include <sys/param.h>
+#include <sys/sysctl.h>
+#include <sys/proc.h>
d23 1
a23 17
@@@@ -117,6 +127,7 @@@@ tracker_control_general_options_enabled (void)
 	return GENERAL_OPTIONS_ENABLED ();
 }
 
+#ifndef __OpenBSD__
 static GSList *
 get_pids (void)
 {
@@@@ -153,6 +164,7 @@@@ get_pids (void)
 
 	return g_slist_reverse (pids);
 }
+#endif
 
 static void
 log_handler (const gchar    *domain,
@@@@ -645,66 +657,37 @@@@ tracker_control_general_run (void)
d27 9
a35 30
-		guint32 own_pid;
-		guint32 own_uid;
-		gchar *own_pid_str;
-
-		pids = get_pids ();
-		str = g_strdup_printf (g_dngettext (NULL,
-		                                    "Found %d PID…",
-		                                    "Found %d PIDs…",
-		                                    g_slist_length (pids)),
-		                       g_slist_length (pids));
-		g_print ("%s\n", str);
-		g_free (str);
-
-		/* Establish own uid/pid */
-		own_pid = (guint32) getpid ();
-		own_pid_str = g_strdup_printf ("%d", own_pid);
-		own_uid = get_uid_for_pid (own_pid_str, NULL);
-		g_free (own_pid_str);
-
-		for (l = pids; l; l = l->next) {
-			GError *error = NULL;
-			gchar *filename;
-			gchar *contents = NULL;
-			gchar **strv;
-			guint uid;
-
-			uid = get_uid_for_pid (l->data, &filename);
-
-			/* Stat the file and make sure current user == file owner */
-			if (uid != own_uid) {
d42 2
a43 2
+		if ((kd = kvm_openfiles(NULL, NULL, NULL, KVM_NO_FILES, buf)) == NULL) {
+			printf("%s\n", buf);
d47 1
a47 1
+		plist = kvm_getprocs(kd, KERN_PROC_ALL, 0, sizeof(*plist), &nproc);
d53 1
a53 2
 				continue;
-			}
d55 1
a55 11
-			/* Get contents to determine basename */
-			if (!g_file_get_contents (filename, &contents, NULL, &error)) {
-				str = g_strdup_printf (_("Could not open '%s'"), filename);
-				g_printerr ("%s, %s\n",
-				            str,
-				            error ? error->message : _("no error given"));
-				g_free (str);
-				g_clear_error (&error);
-				g_free (contents);
-				g_free (filename);
+				if ((strv = kvm_getargv(kd, kp, 0)) == NULL)
d57 3
a59 2
+ 
+				basename = g_path_get_basename(strv[0]);
a60 9
-				continue;
-			}
-
-			strv = g_strsplit (contents, "^@@", 2);
-			if (strv && strv[0]) {
-				gchar *basename;
-
-				basename = g_path_get_basename (strv[0]);
-
d62 1
a62 2
 				     g_str_has_prefix (basename, "lt-tracker") == TRUE) &&
 				    g_str_has_suffix (basename, "-control") == FALSE &&
d66 3
a68 1
-					pid = atoi (l->data);
d70 1
d74 1
a74 2
@@@@ -756,14 +739,6 @@@@ tracker_control_general_run (void)
 
d77 10
a86 8
-
-			g_strfreev (strv);
-			g_free (contents);
-			g_free (filename);
-		}
-
-		g_slist_foreach (pids, (GFunc) g_free, NULL);
-		g_slist_free (pids);
@


1.6
log
@Update to (meta-)tracker-0.16.0.
Merge -nautilus into -main.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_tracker-control_tracker-control-general_c,v 1.5 2011/12/16 17:36:55 ajacoutot Exp $
@


1.5
log
@Bugfix update to meta-tracker-0.12.9.
@
text
@d1 3
a3 3
$OpenBSD: patch-src_tracker-control_tracker-control-general_c,v 1.4 2011/10/21 14:26:56 ajacoutot Exp $
--- src/tracker-control/tracker-control-general.c.orig	Fri Dec 16 16:38:16 2011
+++ src/tracker-control/tracker-control-general.c	Fri Dec 16 18:02:12 2011
d37 1
a37 1
@@@@ -643,66 +655,37 @@@@ tracker_control_general_run (void)
d126 1
a126 1
@@@@ -754,14 +737,6 @@@@ tracker_control_general_run (void)
@


1.4
log
@Update to (meta-)tracker-0.12.6.
@
text
@d1 3
a3 3
$OpenBSD: patch-src_tracker-control_tracker-control-general_c,v 1.3 2011/10/16 08:54:53 ajacoutot Exp $
--- src/tracker-control/tracker-control-general.c.orig	Thu Oct 20 17:37:11 2011
+++ src/tracker-control/tracker-control-general.c	Fri Oct 21 15:27:49 2011
d37 1
a37 1
@@@@ -650,66 +662,37 @@@@ tracker_control_general_run (void)
d126 1
a126 1
@@@@ -761,14 +744,6 @@@@ tracker_control_general_run (void)
@


1.3
log
@Update to meta-tracker-0.12.5.
@
text
@d1 3
a3 3
$OpenBSD$
--- src/tracker-control/tracker-control-general.c.orig	Sun Oct 16 09:37:10 2011
+++ src/tracker-control/tracker-control-general.c	Sun Oct 16 09:44:23 2011
d43 2
a44 7
-		gchar *own_uid_str;
+		gchar *basename, **strv;
+		int i, nproc;
+		struct kinfo_proc *plist, *kp;
+		char buf[_POSIX2_LINE_MAX];
+		kvm_t *kd;
 
d53 1
a53 5
+		if ((kd = kvm_openfiles(NULL, NULL, NULL, KVM_NO_FILES, buf)) == NULL) {
+			printf("%s\n", buf);
+			return EXIT_FAILURE;
+		}
 
d56 4
a59 7
-		own_uid_str = g_strdup_printf ("%d", own_pid);
-		own_uid = get_uid_for_pid (own_uid_str, NULL);
-		g_free (own_uid_str);
+		plist = kvm_getprocs(kd, KERN_PROC_ALL, 0, sizeof(*plist), &nproc);
+		if (plist == NULL)
+			return EXIT_FAILURE;
 
d71 15
d91 1
a91 1
-			/* Get contents to determin basename */
d103 2
d108 1
a108 2
+				basename = g_path_get_basename(strv[0]);
 
@


1.2
log
@Update to tracker-0.12.2.
@
text
@d1 3
a3 3
$OpenBSD: patch-src_tracker-control_tracker-control-general_c,v 1.1 2011/09/18 08:36:56 ajacoutot Exp $
--- src/tracker-control/tracker-control-general.c.orig	Thu Sep 22 17:28:30 2011
+++ src/tracker-control/tracker-control-general.c	Thu Sep 22 18:46:10 2011
d37 1
a37 1
@@@@ -611,47 +623,37 @@@@ tracker_control_general_run (void)
d41 9
d58 13
a70 5
+	gchar *basename, **strv;
+	int i, nproc;
+	struct kinfo_proc *plist, *kp;
+	char buf[_POSIX2_LINE_MAX];
+	kvm_t *kd;
d73 1
d77 10
a86 4
+	if ((kd = kvm_openfiles(NULL, NULL, NULL, KVM_NO_FILES, buf)) == NULL) {
+		printf("%s\n", buf);
+		return EXIT_FAILURE;
+	}
d88 1
a88 1
-			filename = g_build_filename ("/proc", l->data, "cmdline", NULL);
d98 2
a99 3
+	plist = kvm_getprocs(kd, KERN_PROC_ALL, 0, sizeof(*plist), &nproc);
+	if (plist == NULL)
+		return EXIT_FAILURE;
d103 1
a103 3
+	for (i = 0, kp = plist; i < nproc; i++, kp++) {
+		if ((kp->p_flag & P_SYSTEM) != 0)
+			continue;
d108 1
a108 5
+		if ((strv = kvm_getargv(kd, kp, 0)) == NULL)
+			continue;
+ 
+		basename = g_path_get_basename(strv[0]);
 
d122 1
a122 1
@@@@ -703,14 +705,6 @@@@ tracker_control_general_run (void)
@


1.1
log
@Unbreak this port: major update to meta-tracker-0.12.1.
Introducing 3 subpackages:
-main (tracker itself)
-evolution (mail indexing)
-nautilus (tag editing from within nautilus)
@
text
@d1 3
a3 3
$OpenBSD$
--- src/tracker-control/tracker-control-general.c.orig	Tue Sep 13 11:20:17 2011
+++ src/tracker-control/tracker-control-general.c	Sat Sep 17 17:44:39 2011
d37 1
a37 1
@@@@ -610,47 +622,37 @@@@ tracker_control_general_run (void)
d105 1
a105 1
@@@@ -702,14 +704,6 @@@@ tracker_control_general_run (void)
@

