head	1.8;
access;
symbols
	OPENBSD_5_1_BASE:1.4
	OPENBSD_5_1:1.4.0.2
	OPENBSD_4_9:1.2.0.2
	OPENBSD_4_9_BASE:1.2;
locks; strict;
comment	@# @;


1.8
date	2012.07.05.17.46.12;	author ajacoutot;	state dead;
branches;
next	1.7;

1.7
date	2012.05.04.15.42.39;	author ajacoutot;	state Exp;
branches;
next	1.6;

1.6
date	2012.05.04.09.16.04;	author ajacoutot;	state Exp;
branches;
next	1.5;

1.5
date	2012.03.08.14.14.10;	author ajacoutot;	state dead;
branches;
next	1.4;

1.4
date	2012.02.02.07.12.23;	author ajacoutot;	state Exp;
branches;
next	1.3;

1.3
date	2011.04.27.11.09.50;	author ajacoutot;	state dead;
branches;
next	1.2;

1.2
date	2010.09.30.08.39.50;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2010.08.22.12.02.53;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.8
log
@Update to (meta-)tracker-0.14.2.
@
text
@$OpenBSD: patch-src_plugins_evolution_tracker-evolution-plugin_c,v 1.7 2012/05/04 15:42:39 ajacoutot Exp $

From 36ae98cd502d2ba8dc36ff281ef1b0258f61bd8c Mon Sep 17 00:00:00 2001
From: Antoine Jacoutot <ajacoutot@@gnome.org>
Date: Fri, 04 May 2012 09:10:48 +0000
Subject: evolution plugin: include missing header

--- src/plugins/evolution/tracker-evolution-plugin.c.orig	Fri May  4 10:57:05 2012
+++ src/plugins/evolution/tracker-evolution-plugin.c	Fri May  4 10:56:52 2012
@@@@ -70,6 +70,7 @@@@
 #endif
 
 /* Remaining includes which are in ALL versions: */
+#include <mail/e-mail-backend.h>
 #include <shell/e-shell.h>
 
 #include <e-util/e-config.h>
@


1.7
log
@Committed upstream.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_plugins_evolution_tracker-evolution-plugin_c,v 1.6 2012/05/04 09:16:04 ajacoutot Exp $
@


1.6
log
@Properly load the evolution plugin.
@
text
@d1 1
a1 1
$OpenBSD$
d3 4
a6 1
https://bugzilla.gnome.org/show_bug.cgi?id=675437
@


1.5
log
@Update to (meta)-tracker-0.14.0.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_plugins_evolution_tracker-evolution-plugin_c,v 1.4 2012/02/02 07:12:23 ajacoutot Exp $
d3 1
a3 4
From 396c1eaece1756a68441ebf49ba0de36949e9790 Mon Sep 17 00:00:00 2001
From: Philip Van Hoof <philip@@codeminded.be>
Date: Tue, 06 Dec 2011 14:53:09 +0000
Subject: plugins/evolution: Fixes for several crashes in the plugin
d5 3
a7 109
--- src/plugins/evolution/tracker-evolution-plugin.c.orig	Fri Dec 16 16:23:55 2011
+++ src/plugins/evolution/tracker-evolution-plugin.c	Tue Jan 31 09:54:53 2012
@@@@ -109,18 +109,6 @@@@
  * during registration of accounts and folders). I know this is cruel. I know. */
 
 typedef struct {
-	TrackerSparqlConnection *connection;
-	gchar *sparql;
-	gboolean commit;
-	gint prio;
-	GMutex *mutex;
-	GCond *cond;
-	gboolean has_happened;
-	gpointer pool;
-	gboolean dont_free;
-} PoolItem;
-
-typedef struct {
 	GThreadPool *pool;
 	GList *items;
 	GMutex *mutex;
@@@@ -293,7 +281,6 @@@@ thread_pool_exec (gpointer data,
                   gpointer user_data)
 {
 	ThreadPool *pool = user_data;
-	PoolItem *item;
 	gboolean dying;
 
 	g_mutex_lock (pool->mutex);
@@@@ -304,9 +291,7 @@@@ thread_pool_exec (gpointer data,
 	if (!dying)
 		pool->func (data, pool->cancel);
 
-	item = data;
-	if (!item->dont_free)
-		pool->freeup (data, pool->cancel);
+	pool->freeup (data, pool->cancel);
 }
 
 static ThreadPool*
@@@@ -908,6 +893,13 @@@@ introduce_walk_folders_in_folder (TrackerMinerEvolutio
 		sqlite3_stmt *stmt = NULL;
 		GPtrArray *uids = g_ptr_array_new_with_free_func (g_free);
 
+		/* might happen when folder is not loaded/opened yet */
+		if (!priv->cached_folders || !g_hash_table_lookup (priv->cached_folders, iter->full_name)) {
+			iter = iter->next;
+			g_ptr_array_unref (uids);
+			continue;
+		}
+
 		did_work = TRUE;
 
 		query = sqlite3_mprintf ("SELECT uid FROM %Q "
@@@@ -1215,8 +1207,13 @@@@ introduce_store_deal_with_deleted (TrackerMinerEvoluti
 			uid     = (const gchar *) sqlite3_column_text (stmt, 0);
 			mailbox = (const gchar *) sqlite3_column_text (stmt, 1);
 
-			folder = g_hash_table_lookup (priv->cached_folders, mailbox);
+			folder = priv->cached_folders ? g_hash_table_lookup (priv->cached_folders, mailbox) : NULL;
 
+			/* might happen when folder is not loaded/opened yet */
+			if (!folder) {
+				more = FALSE;
+				break;
+			}
 
 			/* This is not a path but a URI, don't use the OS's
 			 * directory separator here */
@@@@ -1411,7 +1408,7 @@@@ register_walk_folders_in_folder (TrackerMinerEvolution
 
 		priv->cached_folders = g_hash_table_new_full (g_str_hash, g_str_equal,
 		                                              (GDestroyNotify) g_free,
-		                                              (GDestroyNotify) NULL);
+		                                              (GDestroyNotify) g_object_unref);
 	}
 
 	/* Recursively walks all the folders in store */
@@@@ -1505,6 +1502,8 @@@@ unregister_on_get_folder (gchar       *uri,
 	g_free (info->account_uri);
 	g_object_unref (info->self);
 	g_free (info);
+
+	g_object_unref (folder);
 }
 
 static void
@@@@ -1753,7 +1752,9 @@@@ introduce_account_to (TrackerMinerEvolution *self,
 	mail_get_folderinfo (store, NULL, on_got_folderinfo_introduce, intro_info);
 #endif
 
+#ifndef EVOLUTION_SHELL_3_2
 	g_object_unref (store);
+#endif
 
 }
 
@@@@ -2085,7 +2086,9 @@@@ register_account (TrackerMinerEvolution *self,
 	mail_get_folderinfo (store, NULL, on_got_folderinfo_register, reg_info);
 #endif
 
+#ifndef EVOLUTION_SHELL_3_2
 	g_object_unref (store);
+#endif
 }
 
 #ifdef EVOLUTION_SHELL_3_2
@@@@ -2181,7 +2184,9 @@@@ unregister_account (TrackerMinerEvolution *self,
 	mail_get_folderinfo (store, NULL, on_got_folderinfo_unregister, reg_info);
d10 3
a12 4
+#ifndef EVOLUTION_SHELL_3_2
 	g_object_unref (store);
+#endif
 }
d14 1
a14 1
 static void
@


1.4
log
@Bring a patch from upstream to fix a hard crash with the -evolution
subpackage.
Sync the tracker_file_open_fd patches with upstream.

ok sthen@@
@
text
@d1 1
a1 1
$OpenBSD$
@


1.3
log
@Small update to meta-tracker-0.8.18.
@
text
@d1 11
a11 5
$OpenBSD: patch-src_plugins_evolution_tracker-evolution-plugin_c,v 1.2 2010/09/30 08:39:50 ajacoutot Exp $
--- src/plugins/evolution/tracker-evolution-plugin.c.orig	Thu Sep  2 14:51:00 2010
+++ src/plugins/evolution/tracker-evolution-plugin.c	Thu Sep 30 10:39:00 2010
@@@@ -41,7 +41,6 @@@@
 #include <sqlite3.h>
d13 22
a34 2
 #include <camel/camel.h>
-#include <camel/camel-db.h>
d36 89
a124 2
 #include <mail/mail-config.h>
 #include <mail/mail-session.h>
@


1.2
log
@Fix build and bump after evolution update.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_plugins_evolution_tracker-evolution-plugin_c,v 1.1 2010/08/22 12:02:53 ajacoutot Exp $
@


1.1
log
@Update to tracker-search-0.8.16.
@
text
@d1 4
a4 5
$OpenBSD$
--- src/plugins/evolution/tracker-evolution-plugin.c.orig	Sun Aug 22 13:43:04 2010
+++ src/plugins/evolution/tracker-evolution-plugin.c	Sun Aug 22 13:43:09 2010
@@@@ -40,7 +40,6 @@@@
 
d7 2
a8 2
-#include <camel/camel.h>
 #include <camel/camel-db.h>
d11 1
@

