head	1.4;
access;
symbols
	OPENBSD_4_6:1.3.0.2
	OPENBSD_4_6_BASE:1.3;
locks; strict;
comment	@# @;


1.4
date	2009.10.13.19.09.05;	author ajacoutot;	state dead;
branches;
next	1.3;

1.3
date	2009.04.14.22.04.31;	author ajacoutot;	state Exp;
branches;
next	1.2;

1.2
date	2009.04.14.17.16.54;	author ajacoutot;	state dead;
branches;
next	1.1;

1.1
date	2009.04.13.14.35.19;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Major update to gnome-control-center-2.28.0.
@
text
@$OpenBSD: patch-capplets_common_gtkrc-utils_c,v 1.3 2009/04/14 22:04:31 ajacoutot Exp $
--- capplets/common/gtkrc-utils.c.orig	Wed Sep 24 18:36:22 2008
+++ capplets/common/gtkrc-utils.c	Tue Apr 14 23:13:34 2009
@@@@ -24,6 +24,7 @@@@
 #endif
 
 #include <string.h>
+#include <unistd.h>
 #include <glib.h>
 #include <glib/gstdio.h>
 #include <fcntl.h>
@@@@ -156,6 +157,7 @@@@ gtkrc_get_details (gchar *filename, GSList **engines, 
 				}
 
 			}
+			close (file);
 		}
 	}
 
@


1.3
log
@- bring in patch from upstream SVN: close gtkrc files after use so we don't
run out of file descriptors
@
text
@d1 1
a1 1
$OpenBSD$
@


1.2
log
@- better workaround for now: disable thumbnailer completely.
Bug still beeing worked on.
@
text
@d1 1
a1 4
$OpenBSD: patch-capplets_common_gtkrc-utils_c,v 1.1 2009/04/13 14:35:19 ajacoutot Exp $

Default number of open file descriptors is too low on OpenBSD.

d3 3
a5 4
+++ capplets/common/gtkrc-utils.c	Mon Apr 13 16:13:01 2009
@@@@ -33,6 +33,28 @@@@
 #define ENGINE_SYMBOL ((gpointer) 2)
 #define COLOR_SCHEME_SYMBOL ((gpointer) 3)
d7 7
a13 26
+#ifdef __OpenBSD__
+#include <sys/types.h>
+#include <sys/time.h>
+#include <sys/resource.h>
+
+static int
+fdlim_set(int lim)
+{ 
+	struct rlimit rlfd;
+ 
+	if (lim <= 0 || lim > FD_SETSIZE)
+	    return (-1);
+	if (getrlimit(RLIMIT_NOFILE, &rlfd) < 0)
+	    return (-1);
+	if (rlfd.rlim_cur < lim)
+	    rlfd.rlim_cur = lim;
+	if (setrlimit(RLIMIT_NOFILE, &rlfd) < 0)
+	    return (-1);
+	return (0);
+}
+#endif // __OpenBSD__
+
 gchar *
 gtkrc_find_named (const gchar *name)
 {
@@@@ -104,6 +126,9 @@@@ gtkrc_get_details (gchar *filename, GSList **engines, 
d15 4
a18 1
 		read_files = g_slist_prepend (read_files, filename);
a19 16
+#ifdef __OpenBSD__
+		fdlim_set(256);
+#endif
 		file = g_open (filename, O_RDONLY);
 		if (file == -1)
 		{
@@@@ -198,6 +223,9 @@@@ gtkrc_get_color_scheme (const gchar *gtkrc_file)
 
 		read_files = g_slist_prepend (read_files, filename);
 
+#ifdef __OpenBSD__
+		fdlim_set(256);
+#endif
 		file = g_open (filename, O_RDONLY);
 		if (file == -1)
 		{
@


1.1
log
@- use setrlimit to increase number of fd in the appearance capplet; this
allows browsing for themes to install without the need to play with
(u)limit
@
text
@d1 1
a1 1
$OpenBSD$
@

