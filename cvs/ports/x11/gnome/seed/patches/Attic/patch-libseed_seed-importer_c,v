head	1.3;
access;
symbols
	OPENBSD_5_0:1.2.0.2
	OPENBSD_5_0_BASE:1.2
	jasper_20111305:1.1.1.1
	jasper:1.1.1;
locks; strict;
comment	@# @;


1.3
date	2011.09.21.20.27.31;	author jasper;	state dead;
branches;
next	1.2;

1.2
date	2011.05.16.09.40.44;	author jasper;	state Exp;
branches;
next	1.1;

1.1
date	2011.05.13.09.59.35;	author jasper;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2011.05.13.09.59.35;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.3
log
@- update seed to 3.1.1.1 (git master as of today)
* unbreaks after recent gobject-introspection update
@
text
@$OpenBSD: patch-libseed_seed-importer_c,v 1.2 2011/05/16 09:40:44 jasper Exp $

fix #650233 Fix importing scripts on *BSD
from upstream git: 18861a32f2a251c323c21e172ad39fd91fc80e3f

--- libseed/seed-importer.c.orig	Sat Apr  2 04:46:08 2011
+++ libseed/seed-importer.c	Fri May 13 11:27:20 2011
@@@@ -19,6 +19,8 @@@@
 
 #include <gio/gio.h>
 #include <string.h>
+#include <stdlib.h>
+#include <unistd.h>
 
 #include "seed-private.h"
 
@@@@ -656,8 +658,9 @@@@ seed_importer_handle_file (JSContextRef ctx,
   JSValueRef js_file_dirname;
   JSObjectRef global, c_global;
   JSStringRef file_contents, file_name;
-  gchar *contents, *walk, *file_path, *canonical, *absolute_path;
+  gchar *contents, *walk, *file_path, *canonical, *absolute_path, *normalp;
   gchar *normalized_path;
+  gsize path_max;
 
   file_path = g_build_filename (dir, file, NULL);
   canonical = seed_importer_canonicalize_path (file_path);
@@@@ -711,15 +714,24 @@@@ seed_importer_handle_file (JSContextRef ctx,
 					g_path_get_dirname (file_path), NULL);
     }
 
-  normalized_path = realpath (absolute_path, NULL);
+#ifdef PATH_MAX
+  path_max = PATH_MAX;
+#else
+  path_max = pathconf (absolute_path, _PC_PATH_MAX);
+  if (path_max <= 0)
+    path_max = 4096;
+#endif
+  normalized_path = (gchar *) g_malloc (path_max);
+  normalp = realpath (absolute_path, normalized_path);
 
-  js_file_dirname = seed_value_from_string (ctx, normalized_path, NULL);
+  js_file_dirname = seed_value_from_string (ctx, normalp, NULL);
 
   seed_object_set_property (nctx, global, "__script_path__", js_file_dirname);
 
   g_hash_table_insert (file_imports, canonical, global);
   g_free (file_path);
   g_free (absolute_path);
+  g_free (normalized_path);
 
   JSEvaluateScript (nctx, file_contents, NULL, file_name, 0, exception);
 
@


1.2
log
@tweak comments
@
text
@d1 1
a1 1
$OpenBSD: patch-libseed_seed-importer_c,v 1.1.1.1 2011/05/13 09:59:35 jasper Exp $
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
$OpenBSD$
d3 2
a4 2
Fix importing .js files
From FreeBSD's patch-libseed_seed-importer.c
@


1.1.1.1
log
@import seed 3.0.0

Seed is a library and interpreter, dynamically bridging (through
gobject-introspection) the WebKit JavaScriptCore engine with the GObject
type system. In a more concrete sense, Seed enables you to immediately
write applications around a significant portion of the GNOME platform,
and easily embed JavaScript as a scripting language in your GObject
library.

ok aja@@
@
text
@@
