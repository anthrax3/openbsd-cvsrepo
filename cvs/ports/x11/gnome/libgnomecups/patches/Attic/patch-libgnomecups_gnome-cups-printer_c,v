head	1.4;
access;
symbols
	OPENBSD_5_0:1.3.0.10
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_9:1.3.0.8
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.3.0.6
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.3.0.4
	OPENBSD_4_7_BASE:1.3
	OPENBSD_4_6:1.3.0.2
	OPENBSD_4_6_BASE:1.3
	OPENBSD_4_5:1.2.0.6
	OPENBSD_4_5_BASE:1.2
	OPENBSD_4_4:1.2.0.4
	OPENBSD_4_4_BASE:1.2
	OPENBSD_4_3:1.2.0.2
	OPENBSD_4_3_BASE:1.2
	OPENBSD_4_2:1.1.0.2
	OPENBSD_4_2_BASE:1.1;
locks; strict;
comment	@# @;


1.4
date	2011.09.12.13.46.53;	author ajacoutot;	state dead;
branches;
next	1.3;

1.3
date	2009.04.10.16.17.49;	author ajacoutot;	state Exp;
branches;
next	1.2;

1.2
date	2008.02.03.21.02.19;	author jasper;	state Exp;
branches;
next	1.1;

1.1
date	2007.07.11.23.00.47;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Remove libgnomecups; unused and deprecated.
@
text
@$OpenBSD: patch-libgnomecups_gnome-cups-printer_c,v 1.3 2009/04/10 16:17:49 ajacoutot Exp $

* Parse ~/.cups/lpoptions.
* Check whether the printer URI starts with http://, ipp://, or smb:// to
  test whether its local or not.
* Replace IPP_SET_PRINTER_ATTRIBUTES with CUPS_ADD_MODIFY_PRINTER.
* Fix PPD retrieval for printers picked up with cups browsing.

--- libgnomecups/gnome-cups-printer.c.orig	Tue Jan  2 01:18:51 2007
+++ libgnomecups/gnome-cups-printer.c	Wed Jan 30 14:59:24 2008
@@@@ -515,6 +515,10 @@@@ parse_lpoptions (cups_dest_t **dests)
 	num_dests = cups_get_dests (filename, num_dests, dests);
 	g_free (filename);
 
+	filename = g_build_filename (g_get_home_dir (), ".cups", "lpoptions", NULL);
+	num_dests = cups_get_dests (filename, num_dests, dests);
+	g_free (filename);
+
 	return num_dests;
 }
 
@@@@ -1030,8 +1034,11 @@@@ gnome_cups_printer_get_is_local (GnomeCupsPrinter *pri
 {
 	g_return_val_if_fail (GNOME_CUPS_IS_PRINTER (printer), FALSE);
 
-	return (printer->details->device_uri != NULL) && 
-		(strcmp (printer->details->device_uri, "") != 0);
+	return printer->details->device_uri != NULL && 
+		strncmp(printer->details->device_uri, "smb:", 4) != 0 &&
+		strncmp(printer->details->device_uri, "http:", 5) != 0 &&
+		strncmp(printer->details->device_uri, "https:", 5) != 0 &&
+		strncmp(printer->details->device_uri, "ipp:", 4)  != 0;
 }
 
 void
@@@@ -1152,7 +1159,7 @@@@ gnome_cups_printer_get_ppd (GnomeCupsPrinter *printer)
 		return NULL;
 	}
 
-	host = _gnome_cups_printer_get_host (printer);
+	host = _gnome_cups_printer_get_ppd_host (printer);
 	ppdpath = get_ppd_uri_path (printer);
 
 	gnome_cups_request_file (host, ppdpath, fd, &error);
@@@@ -1288,9 +1295,14 @@@@ gnome_cups_printer_get_description (GnomeCupsPrinter *
 	g_return_val_if_fail (printer->details->description, "");
 
 	return printer->details->description;
-	
 }
 
+
+/* Define the CUPS-Add-Modify-Printer,
+ * see http://www.cups.org/documentation.php/spec-ipp.html#CUPS_ADD_MODIFY_PRINTER
+ */
+#define CUPS_ADD_MODIFY_PRINTER 0x4003
+
 void
 gnome_cups_printer_set_description (GnomeCupsPrinter *printer,
 				    const char *description,
@@@@ -1306,7 +1318,11 @@@@ gnome_cups_printer_set_description (GnomeCupsPrinter *
 		return;
 	}
 
-	request = gnome_cups_request_new_for_printer (IPP_SET_PRINTER_ATTRIBUTES,
+	/*
+	 * As read in http://lists.samba.org/archive/samba-technical/2003-February/027044.html 
+	 * CUPS does not currently support IPP_SET_PRINTER_ATTRIBUTES, so a is used
+	 */
+	request = gnome_cups_request_new_for_printer (CUPS_ADD_MODIFY_PRINTER,
 						      printer);
 	ippAddString (request, IPP_TAG_PRINTER, IPP_TAG_TEXT,
 		      "printer-info", NULL, description);
@@@@ -1338,8 +1354,12 @@@@ gnome_cups_printer_set_location (GnomeCupsPrinter *pri
 		return;
 	}
 
+	/*
+	 * Same as above (IPP_SET_PRINTER_ATTRIBUTES replaced by
+	 * CUPS-Add-Modify-Printer )
+	 */
 	request = gnome_cups_request_new_for_printer (
-		IPP_SET_PRINTER_ATTRIBUTES, printer);
+		CUPS_ADD_MODIFY_PRINTER, printer);
 	ippAddString (request, IPP_TAG_PRINTER, IPP_TAG_TEXT,
 		"printer-location", NULL, location);
 	response = gnome_cups_request_execute (request, NULL, "/admin/", error);
@@@@ -2018,5 +2038,28 @@@@ _gnome_cups_printer_get_host (GnomeCupsPrinter *printe
 		}
 	}
 	
+	return host;
+}
+
+gchar *
+_gnome_cups_printer_get_ppd_host (GnomeCupsPrinter *printer)
+{
+	gchar *host = NULL;
+
+	if (printer->details->printer_uri) {
+		gchar *x, *y;
+
+		x = strstr (printer->details->printer_uri, "://");
+
+		if (x) {
+			x += 3;
+			y = strpbrk (x, ":/");
+			if (y)
+				host = g_strndup (x, y - x);
+			else 
+			host = g_strdup (x);
+		}
+	}
+       
 	return host;
 }
@


1.3
log
@- unbreak, this works fine now
- set GPL version, regen WANTLIB and PLIST
- add some comments in the patches (from FreeBSD)
@
text
@d1 1
a1 1
$OpenBSD: patch-libgnomecups_gnome-cups-printer_c,v 1.2 2008/02/03 21:02:19 jasper Exp $
@


1.2
log
@- 'update' libgnomecups to 0.2.3
- fix license marker
- update WANTLIB
- tweak LIB_DEPENDS

ok ajacoutot@@
@
text
@d1 8
a8 1
$OpenBSD: patch-libgnomecups_gnome-cups-printer_c,v 1.1 2007/07/11 23:00:47 jasper Exp $
@


1.1
log
@- fix WANTLIB
- roll in some patches from ubuntu via freebs:
	- parse ~/.cups/lpoptions
	- check whether the printer URI starts with http://,
  	  ipp://, or smb:// to test whether its local or not
	- do not warn on stderr in case of IPP_NOT_FOUND
	- replace IPP_SET_PRINTER_ATTRIBUTES with CUPS_ADD_MODIFY_PRINTER
	- fix a mem leak in gnome_cups_request_add_requested_attributes()
	- fix PPD retrieval for printers picked up with cups browsing

(still broken, but these patches won't hurt anyway)
@
text
@d1 15
a15 4
$OpenBSD$
--- libgnomecups/gnome-cups-printer.c.orig	Thu Jul 12 00:31:35 2007
+++ libgnomecups/gnome-cups-printer.c	Thu Jul 12 00:47:46 2007
@@@@ -976,8 +976,11 @@@@ gnome_cups_printer_get_is_local (GnomeCupsPrinter *pri
d29 1
a29 1
@@@@ -1098,7 +1101,7 @@@@ gnome_cups_printer_get_ppd (GnomeCupsPrinter *printer)
d38 1
a38 1
@@@@ -1234,7 +1237,11 @@@@ gnome_cups_printer_get_description (GnomeCupsPrinter *
d43 2
d50 1
a50 2
 }
 
d52 3
a54 1
@@@@ -1252,7 +1259,11 @@@@ gnome_cups_printer_set_description (GnomeCupsPrinter *
d67 1
a67 1
@@@@ -1284,8 +1295,12 @@@@ gnome_cups_printer_set_location (GnomeCupsPrinter *pri
d81 2
a82 1
@@@@ -1963,4 +1978,27 @@@@ _gnome_cups_printer_get_host (GnomeCupsPrinter *printe
d85 1
a85 1
 	return host;
d91 1
a91 1
+       gchar *host = NULL;
d93 2
a94 2
+       if (printer->details->printer_uri) {
+	       gchar *x, *y;
d96 1
a96 1
+	       x = strstr (printer->details->printer_uri, "://");
d98 9
a106 9
+	       if (x) {
+		       x += 3;
+		       y = strpbrk (x, ":/");
+		       if (y)
+			       host = g_strndup (x, y - x);
+		       else 
+			       host = g_strdup (x);
+	       }
+       }
d108 1
a108 1
+       return host;
@

