head	1.2;
access;
symbols
	OPENBSD_5_4:1.1.0.2
	OPENBSD_5_4_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2013.08.10.12.43.04;	author ajacoutot;	state dead;
branches;
next	1.1;

1.1
date	2013.04.12.07.26.44;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Merge the mozjs-17 branch from upstream to build with the updated
devel/spidermonkey.
@
text
@$OpenBSD: patch-gi_arg_c,v 1.1 2013/04/12 07:26:44 jasper Exp $

From f4a5b2c9af715668e3559ff0b66a311d7e9936b2 Mon Sep 17 00:00:00 2001
From: Giovanni Campagna <gcampagna@@src.gnome.org>
Date: Tue, 02 Apr 2013 16:04:13 +0000
Subject: Fix crash when marshalling a GType array containing non objects

It would cast a jsval of the wrong type to object and pass NULL
to gjs_gtype_get_actual_gtype()

Tests included.

https://bugzilla.gnome.org/show_bug.cgi?id=696933

--- gi/arg.c.orig	Mon Jan  7 18:45:57 2013
+++ gi/arg.c	Fri Apr 12 09:23:34 2013
@@@@ -627,20 +627,24 @@@@ gjs_gtypearray_to_array(JSContext   *context,
             return JS_FALSE;
         }
 
+        if (!JSVAL_IS_OBJECT(elem))
+            goto err;
+
         gtype = gjs_gtype_get_actual_gtype(context, JSVAL_TO_OBJECT(elem));
+        if (gtype == G_TYPE_INVALID)
+            goto err;
 
-        if (gtype == G_TYPE_INVALID) {
-            g_free(result);
-            gjs_throw(context, "Invalid element in GType array");
-            return JS_FALSE;
-        }
-
         result[i] = gtype;
     }
 
     *arr_p = result;
 
     return JS_TRUE;
+
+ err:
+    g_free(result);
+    gjs_throw(context, "Invalid element in GType array");
+    return JS_FALSE;
 }
 
 static JSBool
@


1.1
log
@fix a crasher (from upstream)
@
text
@d1 1
a1 1
$OpenBSD$
@

