head	1.6;
access;
symbols
	OPENBSD_5_0:1.5.0.2
	OPENBSD_5_0_BASE:1.5
	OPENBSD_4_9:1.2.0.6
	OPENBSD_4_9_BASE:1.2
	OPENBSD_4_8:1.2.0.4
	OPENBSD_4_8_BASE:1.2
	OPENBSD_4_7:1.2.0.2
	OPENBSD_4_7_BASE:1.2;
locks; strict;
comment	@# @;


1.6
date	2011.09.26.14.32.35;	author ajacoutot;	state dead;
branches;
next	1.5;

1.5
date	2011.06.07.12.53.56;	author ajacoutot;	state Exp;
branches;
next	1.4;

1.4
date	2011.05.23.22.41.04;	author ajacoutot;	state Exp;
branches;
next	1.3;

1.3
date	2011.04.05.14.43.25;	author ajacoutot;	state Exp;
branches;
next	1.2;

1.2
date	2009.10.11.13.32.27;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2009.08.07.08.40.07;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.6
log
@Update to gvfs-1.10.0.
@
text
@$OpenBSD: patch-daemon_gvfsbackenddav_c,v 1.5 2011/06/07 12:53:56 ajacoutot Exp $

From 6abbff2a11c28660a090e8b9398fb19332380094 Mon Sep 17 00:00:00 2001
From: Christian Kellner <gicmo@@gnome.org>
Date: Sun, 05 Jun 2011 11:23:05 +0000
Subject: dav: Use default unmount logic

--- daemon/gvfsbackenddav.c.orig	Mon May 23 16:38:56 2011
+++ daemon/gvfsbackenddav.c	Tue Jun  7 14:47:36 2011
@@@@ -2379,15 +2379,6 @@@@ do_set_display_name (GVfsBackend           *backend,
   soup_uri_free (source);
 }
 
-static gboolean
-try_unmount (GVfsBackend    *backend,
-             GVfsJobUnmount *job,
-             GMountUnmountFlags flags,
-             GMountSource *mount_source)
-{
-  _exit (0);
-}
-
 /* ************************************************************************* */
 /*  */
 static void
@@@@ -2414,5 +2405,4 @@@@ g_vfs_backend_dav_class_init (GVfsBackendDavClass *kla
   backend_class->make_directory    = do_make_directory;
   backend_class->delete            = do_delete;
   backend_class->set_display_name  = do_set_display_name;
-  backend_class->try_unmount       = try_unmount;
 }
@


1.5
log
@Better patch from upstream for webdav unmount.
@
text
@d1 1
a1 1
$OpenBSD: patch-daemon_gvfsbackenddav_c,v 1.4 2011/05/23 22:41:04 ajacoutot Exp $
@


1.4
log
@Bugfix update to gvfs-1.8.2.
@
text
@d1 1
a1 1
$OpenBSD$
d3 4
a6 2
https://bugzilla.gnome.org/show_bug.cgi?id=567664
(Properly implement unmount)
d9 2
a10 10
+++ daemon/gvfsbackenddav.c	Tue May 24 00:33:42 2011
@@@@ -56,6 +56,7 @@@@
 #include "gvfsjobqueryfsinfo.h"
 #include "gvfsjobqueryattributes.h"
 #include "gvfsjobenumerate.h"
+#include "gvfsjobunmount.h"
 #include "gvfsdaemonprotocol.h"
 
 #include "soup-input-stream.h"
@@@@ -2379,13 +2380,49 @@@@ do_set_display_name (GVfsBackend           *backend,
d14 1
a14 20
+static void
+unmount_cb (GVfsBackend  *backend,
+            GAsyncResult *res,
+            gpointer      user_data)
+{
+  GVfsJobUnmount *job = G_VFS_JOB_UNMOUNT (user_data);
+  gboolean should_unmount;
+
+  should_unmount = g_vfs_backend_unmount_with_operation_finish (backend,
+                                                                res);
+
+  if (should_unmount)
+    g_vfs_job_succeeded (G_VFS_JOB (job));
+  else
+    g_vfs_job_failed_literal (G_VFS_JOB (job),
+                              G_IO_ERROR, G_IO_ERROR_BUSY,
+                              _("Filesystem is busy"));
+}
+
 static gboolean
d19 1
a19 5
+try_unmount (GVfsBackend        *backend,
+             GVfsJobUnmount     *job,
+             GMountUnmountFlags  flags,
+             GMountSource       *mount_source)
 {
d21 10
a30 18
+
+  if (! g_vfs_backend_has_blocking_processes (backend) ||
+      flags & G_MOUNT_UNMOUNT_FORCE)
+    {
+      g_vfs_job_succeeded (G_VFS_JOB (job));
+    }
+  else if (g_mount_source_is_dummy (mount_source))
+    {
+      g_vfs_job_failed_literal (G_VFS_JOB (job),
+                                G_IO_ERROR, G_IO_ERROR_BUSY,
+                                _("Filesystem is busy"));
+    }
+  else
+    g_vfs_backend_unmount_with_operation (backend,
+                                          mount_source,
+                                          (GAsyncReadyCallback) unmount_cb,
+                                          job);
+  return TRUE;
a31 2
 
 /* ************************************************************************* */
@


1.3
log
@Update to gvfs-1.8.0.

tested in a bulk by landry, thanks!
@
text
@d1 1
a1 1
$OpenBSD: patch-daemon_gvfsbackenddav_c,v 1.2 2009/10/11 13:32:27 ajacoutot Exp $
d3 2
a4 2
Fix unmounting webdav share:
    http://bugzilla.gnome.org/show_bug.cgi?id=567664
d6 11
a16 3
--- daemon/gvfsbackenddav.c.orig	Mon Apr  4 16:49:12 2011
+++ daemon/gvfsbackenddav.c	Mon Apr  4 19:37:54 2011
@@@@ -2302,13 +2302,13 @@@@ do_set_display_name (GVfsBackend           *backend,
d20 20
a39 1
-static gboolean
d41 7
a47 5
+static void
+do_unmount (GVfsBackend    *backend,
              GVfsJobUnmount *job,
              GMountUnmountFlags flags,
              GMountSource *mount_source)
d50 18
a67 1
+  g_vfs_job_succeeded (G_VFS_JOB (job));
a70 7
@@@@ -2336,5 +2336,5 @@@@ g_vfs_backend_dav_class_init (GVfsBackendDavClass *kla
   backend_class->make_directory    = do_make_directory;
   backend_class->delete            = do_delete;
   backend_class->set_display_name  = do_set_display_name;
-  backend_class->try_unmount       = try_unmount;
+  backend_class->unmount           = do_unmount;
 }
@


1.2
log
@Major update to gvfs-1.4.0.
All main features successfully tested.

ok jasper@@
@
text
@d1 1
a1 1
$OpenBSD: patch-daemon_gvfsbackenddav_c,v 1.1 2009/08/07 08:40:07 ajacoutot Exp $
d6 3
a8 3
--- daemon/gvfsbackenddav.c.orig	Tue Jul 14 13:07:59 2009
+++ daemon/gvfsbackenddav.c	Sun Oct 11 11:37:38 2009
@@@@ -2304,13 +2304,13 @@@@ do_set_display_name (GVfsBackend           *backend,
d25 1
a25 1
@@@@ -2338,5 +2338,5 @@@@ g_vfs_backend_dav_class_init (GVfsBackendDavClass *kla
@


1.1
log
@Fix for unmounting webdav shares.
GNOME Bug #567664.
@
text
@d1 1
a1 1
$OpenBSD$
d6 3
a8 3
--- daemon/gvfsbackenddav.c.orig	Fri Aug  7 10:21:57 2009
+++ daemon/gvfsbackenddav.c	Fri Aug  7 10:23:13 2009
@@@@ -2124,11 +2124,11 @@@@ do_set_display_name (GVfsBackend           *backend,
d14 1
a14 1
+static void 
d16 3
a18 1
              GVfsJobUnmount *job)
d21 1
a21 1
+ g_vfs_job_succeeded (G_VFS_JOB (job));
d25 1
a25 1
@@@@ -2156,5 +2156,5 @@@@ g_vfs_backend_dav_class_init (GVfsBackendDavClass *kla
@

