head	1.7;
access;
symbols
	OPENBSD_5_7:1.6.0.4
	OPENBSD_5_7_BASE:1.6
	OPENBSD_5_6:1.6.0.2
	OPENBSD_5_6_BASE:1.6
	OPENBSD_5_5:1.4.0.2
	OPENBSD_5_5_BASE:1.4;
locks; strict;
comment	@# @;


1.7
date	2015.04.03.18.39.06;	author ajacoutot;	state dead;
branches;
next	1.6;
commitid	yAn0NWAFkDqbBMqK;

1.6
date	2014.04.15.13.15.19;	author ajacoutot;	state Exp;
branches;
next	1.5;

1.5
date	2014.03.27.19.19.17;	author ajacoutot;	state Exp;
branches;
next	1.4;

1.4
date	2013.10.26.09.08.08;	author ajacoutot;	state Exp;
branches;
next	1.3;

1.3
date	2012.10.10.12.34.35;	author ajacoutot;	state dead;
branches;
next	1.2;

1.2
date	2012.10.08.21.47.04;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2012.10.03.06.40.50;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.7
log
@Update to gdm-3.16.0.1.
@
text
@$OpenBSD: patch-daemon_gdm-simple-slave_c,v 1.6 2014/04/15 13:15:19 ajacoutot Exp $

XXX fix+push upstream

--- daemon/gdm-simple-slave.c.orig	Fri Mar 21 17:32:39 2014
+++ daemon/gdm-simple-slave.c	Thu Mar 27 18:24:19 2014
@@@@ -60,7 +60,7 @@@@
 #define MAX_CONNECT_ATTEMPTS  10
 #define DEFAULT_PING_INTERVAL 15
 
-#define INITIAL_SETUP_USERNAME "gnome-initial-setup"
+#define INITIAL_SETUP_USERNAME "_gnome-initial-setup"
 #define GNOME_SESSION_SESSIONS_PATH DATADIR "/gnome-session/sessions"
 
 struct GdmSimpleSlavePrivate
@


1.6
log
@Update to gdm-3.12.1.
@
text
@d1 1
a1 1
$OpenBSD: patch-daemon_gdm-simple-slave_c,v 1.5 2014/03/27 19:19:17 ajacoutot Exp $
@


1.5
log
@Update to gdm-3.12.0.
@
text
@d1 4
a4 1
$OpenBSD: patch-daemon_gdm-simple-slave_c,v 1.4 2013/10/26 09:08:08 ajacoutot Exp $
@


1.4
log
@Fix the gnome-initial-setup username; noticed by rpe@@
@
text
@d1 4
a4 4
$OpenBSD$
--- daemon/gdm-simple-slave.c.orig	Sat Oct 26 11:04:34 2013
+++ daemon/gdm-simple-slave.c	Sat Oct 26 11:04:40 2013
@@@@ -64,7 +64,7 @@@@
@


1.3
log
@Remove some uneeded | old patches.
Add a schemas override.
@
text
@d1 10
a10 27
$OpenBSD: patch-daemon_gdm-simple-slave_c,v 1.2 2012/10/08 21:47:04 ajacoutot Exp $

From 5479f2542c79873d3f36968bf081274ab9c241fd Mon Sep 17 00:00:00 2001
From: Matthias Clasen <mclasen@@redhat.com>
Date: Fri, 28 Sep 2012 23:56:51 +0000
Subject: Fix errors in the setup code for gnome-initial-setup

From 6eeb747f1b056e6c10ad4390001ae094575d9c94 Mon Sep 17 00:00:00 2001
From: Matthias Clasen <mclasen@@redhat.com>
Date: Sat, 29 Sep 2012 03:19:27 +0000
Subject: Don't try to delete a NULL user

From 71f07f3aa22e3f6382d525d1a0104a9a792090f9 Mon Sep 17 00:00:00 2001
From: Matthias Clasen <mclasen@@redhat.com>
Date: Sat, 29 Sep 2012 03:20:18 +0000
Subject: Install polkit rules to the right place

From c32fef1406287ed324b1223837e7e7a539b86866 Mon Sep 17 00:00:00 2001
From: Ray Strode <rstrode@@redhat.com>
Date: Mon, 01 Oct 2012 21:54:59 +0000
Subject: slave: don't delete initial-setup user until after initial-setup is finished

--- daemon/gdm-simple-slave.c.orig	Tue Sep 25 19:57:35 2012
+++ daemon/gdm-simple-slave.c	Tue Oct  9 01:01:10 2012
@@@@ -115,6 +115,8 @@@@ static void     gdm_simple_slave_open_reauthentication
                                                                 gpointer              user_data,
                                                                 GCancellable         *cancellable);
d12 1
a12 76
+static gboolean wants_initial_setup (GdmSimpleSlave *slave);
+static void destroy_initial_setup_user (GdmSimpleSlave *slave);
 G_DEFINE_TYPE (GdmSimpleSlave, gdm_simple_slave, GDM_TYPE_SLAVE)
 
 static void create_new_session (GdmSimpleSlave  *slave);
@@@@ -842,6 +844,9 @@@@ on_greeter_environment_session_stopped (GdmLaunchEnvir
         if (slave->priv->start_session_service_name == NULL) {
                 gdm_slave_stop (GDM_SLAVE (slave));
         } else {
+                if (wants_initial_setup (slave)) {
+                        destroy_initial_setup_user (slave);
+                }
                 start_session (slave);
         }
 
@@@@ -1118,7 +1123,7 @@@@ start_greeter (GdmSimpleSlave *slave)
         start_launch_environment (slave, GDM_USERNAME, NULL);
 }
 
-#define RULES_DIR LOCALSTATEDIR "/lib/polkit-1/localauthority/10-vendor.d/"
+#define RULES_DIR DATADIR "/polkit-1/rules.d/"
 #define RULES_FILE "20-gnome-initial-setup.rules"
 
 static const gboolean
@@@@ -1147,12 +1152,14 @@@@ create_initial_setup_user (GdmSimpleSlave *slave)
                         ret = FALSE;
                         goto out;
                 }
+
+                g_clear_error (&error);
         } else {
                 g_object_unref (user);
         }
 
         /* Now, make sure the PolicyKit policy is in place */
-        src_file = g_file_new_for_path (DATADIR "/gnome-initial-setup" RULES_FILE);
+        src_file = g_file_new_for_path (DATADIR "/gnome-initial-setup/" RULES_FILE);
         dest_file = g_file_new_for_path (RULES_DIR RULES_FILE);
 
         if (!g_file_copy (src_file,
@@@@ -1195,12 +1202,13 @@@@ destroy_initial_setup_user (GdmSimpleSlave *slave)
 
         error = NULL;
         user = act_user_manager_get_user (act, INITIAL_SETUP_USERNAME);
-        if (!act_user_manager_delete_user (act, user, TRUE, &error)) {
-                g_warning ("Failed to delete user '%s': %s", INITIAL_SETUP_USERNAME, error->message);
-                g_error_free (error);
+        if (user != NULL) {
+                if (!act_user_manager_delete_user (act, user, TRUE, &error)) {
+                        g_warning ("Failed to delete user '%s': %s", INITIAL_SETUP_USERNAME, error->message);
+                        g_error_free (error);
+                }
+                g_object_unref (user);
         }
-
-        g_object_unref (user);
 }
 
 static void
@@@@ -1208,7 +1216,6 @@@@ start_initial_setup (GdmSimpleSlave *slave)
 {
         create_initial_setup_user (slave);
         start_launch_environment (slave, INITIAL_SETUP_USERNAME, "gnome-initial-setup");
-        destroy_initial_setup_user (slave);
 }
 
 static gboolean
@@@@ -1222,7 +1229,7 @@@@ wants_autologin (GdmSimpleSlave *slave)
         return enabled && delay == 0;
 }
 
-#define INITIAL_SETUP_TRIGGER_FILE LOCALSTATEDIR "/lib/gdm/run-initial-setup"
+#define INITIAL_SETUP_TRIGGER_FILE LOCALSTATEDIR "/db/gdm/run-initial-setup"
 
 static gboolean
 wants_initial_setup (GdmSimpleSlave *slave)
@


1.2
log
@Several fixes toward a working configuration.
@
text
@d1 1
a1 1
$OpenBSD: patch-daemon_gdm-simple-slave_c,v 1.1 2012/10/03 06:40:50 ajacoutot Exp $
@


1.1
log
@Bring some patches from upstream to fix a couple of bugs.
Properly remove some subdirectory under _gdm homedir.
@
text
@d1 1
a1 1
$OpenBSD$
d24 1
a24 1
+++ daemon/gdm-simple-slave.c	Tue Oct  2 10:41:36 2012
d96 9
@

