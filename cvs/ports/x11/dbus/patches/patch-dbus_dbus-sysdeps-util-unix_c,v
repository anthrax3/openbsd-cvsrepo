head	1.15;
access;
symbols
	OPENBSD_6_0:1.15.0.4
	OPENBSD_6_0_BASE:1.15
	OPENBSD_5_9:1.15.0.2
	OPENBSD_5_9_BASE:1.15
	OPENBSD_5_8:1.14.0.6
	OPENBSD_5_8_BASE:1.14
	OPENBSD_5_7:1.14.0.2
	OPENBSD_5_7_BASE:1.14
	OPENBSD_5_6:1.13.0.2
	OPENBSD_5_6_BASE:1.13
	OPENBSD_5_5:1.10.0.2
	OPENBSD_5_5_BASE:1.10
	OPENBSD_5_4:1.8.0.2
	OPENBSD_5_4_BASE:1.8
	OPENBSD_5_3:1.7.0.2
	OPENBSD_5_3_BASE:1.7
	OPENBSD_5_2:1.3.0.2
	OPENBSD_5_2_BASE:1.3
	OPENBSD_5_1_BASE:1.2
	OPENBSD_5_1:1.2.0.2
	OPENBSD_5_0:1.1.0.2
	OPENBSD_5_0_BASE:1.1;
locks; strict;
comment	@# @;


1.15
date	2015.08.27.06.46.46;	author ajacoutot;	state Exp;
branches;
next	1.14;
commitid	GN27yyASOEVOa5We;

1.14
date	2014.11.11.14.25.56;	author ajacoutot;	state Exp;
branches;
next	1.13;
commitid	PfDaUDKXhbiS5LZw;

1.13
date	2014.04.16.12.35.51;	author ajacoutot;	state Exp;
branches;
next	1.12;

1.12
date	2014.04.16.08.18.16;	author ajacoutot;	state Exp;
branches;
next	1.11;

1.11
date	2014.04.14.18.43.24;	author ajacoutot;	state Exp;
branches;
next	1.10;

1.10
date	2014.01.24.10.43.16;	author ajacoutot;	state Exp;
branches;
next	1.9;

1.9
date	2013.10.09.11.10.49;	author ajacoutot;	state Exp;
branches;
next	1.8;

1.8
date	2013.05.07.07.00.01;	author ajacoutot;	state Exp;
branches;
next	1.7;

1.7
date	2013.01.08.09.30.27;	author ajacoutot;	state Exp;
branches;
next	1.6;

1.6
date	2012.12.18.21.38.12;	author sthen;	state Exp;
branches;
next	1.5;

1.5
date	2012.10.11.07.25.20;	author ajacoutot;	state Exp;
branches;
next	1.4;

1.4
date	2012.08.15.08.03.43;	author ajacoutot;	state Exp;
branches;
next	1.3;

1.3
date	2012.07.05.07.19.48;	author ajacoutot;	state Exp;
branches;
next	1.2;

1.2
date	2011.09.29.06.57.36;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2011.05.06.07.34.18;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.15
log
@Update to dbus-1.10.0.
@
text
@$OpenBSD: patch-dbus_dbus-sysdeps-util-unix_c,v 1.14 2014/11/11 14:25:56 ajacoutot Exp $

XXX push upstream

--- dbus/dbus-sysdeps-util-unix.c.orig	Fri Jan 30 13:46:24 2015
+++ dbus/dbus-sysdeps-util-unix.c	Wed Aug 26 10:50:04 2015
@@@@ -62,6 +62,10 @@@@
 #include <systemd/sd-daemon.h>
 #endif
 
+#ifdef __OpenBSD__
+#include <sys/sysctl.h>
+#endif
+
 #ifndef O_BINARY
 #define O_BINARY 0
 #endif
@@@@ -1213,7 +1217,13 @@@@ _dbus_command_for_pid (unsigned long  pid,
   /* This is all Linux-specific for now */
   DBusString path;
   DBusString cmdline;
+#ifndef __OpenBSD__
   int fd;
+#else
+  char **argv, **args;
+  int mib[4];
+  size_t len;
+#endif
   
   if (!_dbus_string_init (&path)) 
     {
@@@@ -1228,6 +1238,7 @@@@ _dbus_command_for_pid (unsigned long  pid,
       return FALSE;
     }
   
+#ifndef __OpenBSD__
   if (!_dbus_string_append_printf (&path, "/proc/%ld/cmdline", pid))
     goto oom;
   
@@@@ -1255,6 +1266,37 @@@@ _dbus_command_for_pid (unsigned long  pid,
   
   if (!_dbus_close (fd, error))
     goto fail;
+#else /* OpenBSD */
+  args = NULL;
+  mib[0] = CTL_KERN;
+  mib[1] = KERN_PROC_ARGS;
+  mib[2] = pid;
+  mib[3] = KERN_PROC_ARGV;
+
+  if (sysctl (mib, 4, NULL, &len, NULL, 0) == -1)
+    goto fail;
+
+  args = malloc (len);
+  if (args == NULL)
+    goto fail;
+
+  if (sysctl (mib, 4, args, &len, NULL, 0) == -1)
+    goto fail;
+
+  for (argv = args; *argv != NULL; argv++) {
+    if (argv != args)
+      {
+        if (!_dbus_string_append_printf (&cmdline, " "))
+          goto fail;
+      }
+    if (!_dbus_string_append_printf (&cmdline, "%s", *argv))
+      goto fail;
+  }
+
+  if (_dbus_string_get_length (&cmdline) > max_len)
+    _dbus_string_set_length (&cmdline, max_len);
+
+#endif
   
   string_squash_nonprintable (&cmdline);  
 
@@@@ -1263,12 +1305,18 @@@@ _dbus_command_for_pid (unsigned long  pid,
 
   _dbus_string_free (&cmdline);  
   _dbus_string_free (&path);
+#ifdef __OpenBSD__
+  free (args);
+#endif
   return TRUE;
 oom:
   _DBUS_SET_OOM (error);
 fail:
   _dbus_string_free (&cmdline);
   _dbus_string_free (&path);
+#ifdef __OpenBSD__
+  free (args);
+#endif
   return FALSE;
 }
 
@


1.14
log
@Update to dbus-1.8.10.
@
text
@d1 1
a1 1
$OpenBSD: patch-dbus_dbus-sysdeps-util-unix_c,v 1.13 2014/04/16 12:35:51 ajacoutot Exp $
d5 5
a9 5
--- dbus/dbus-sysdeps-util-unix.c.orig	Thu Nov  6 16:30:51 2014
+++ dbus/dbus-sysdeps-util-unix.c	Tue Nov 11 10:07:49 2014
@@@@ -60,6 +60,10 @@@@
 
 #include "sd-daemon.h"
d18 1
a18 1
@@@@ -1208,7 +1212,13 @@@@ _dbus_command_for_pid (unsigned long  pid,
d32 1
a32 1
@@@@ -1223,6 +1233,7 @@@@ _dbus_command_for_pid (unsigned long  pid,
d40 1
a40 1
@@@@ -1250,6 +1261,37 @@@@ _dbus_command_for_pid (unsigned long  pid,
d78 1
a78 1
@@@@ -1258,12 +1300,18 @@@@ _dbus_command_for_pid (unsigned long  pid,
@


1.13
log
@Respect max_len.
@
text
@d1 1
a1 1
$OpenBSD: patch-dbus_dbus-sysdeps-util-unix_c,v 1.12 2014/04/16 08:18:16 ajacoutot Exp $
d5 2
a6 2
--- dbus/dbus-sysdeps-util-unix.c.orig	Fri Jan 17 17:00:13 2014
+++ dbus/dbus-sysdeps-util-unix.c	Wed Apr 16 14:32:18 2014
d18 1
a18 1
@@@@ -1121,7 +1125,13 @@@@ _dbus_command_for_pid (unsigned long  pid,
d32 1
a32 1
@@@@ -1136,6 +1146,7 @@@@ _dbus_command_for_pid (unsigned long  pid,
d40 1
a40 1
@@@@ -1163,6 +1174,37 @@@@ _dbus_command_for_pid (unsigned long  pid,
d78 1
a78 1
@@@@ -1171,12 +1213,18 @@@@ _dbus_command_for_pid (unsigned long  pid,
@


1.12
log
@Simplify.
@
text
@d1 1
a1 1
$OpenBSD: patch-dbus_dbus-sysdeps-util-unix_c,v 1.11 2014/04/14 18:43:24 ajacoutot Exp $
d6 1
a6 1
+++ dbus/dbus-sysdeps-util-unix.c	Wed Apr 16 10:13:01 2014
d40 1
a40 1
@@@@ -1163,6 +1174,30 @@@@ _dbus_command_for_pid (unsigned long  pid,
d45 1
a45 1
+  len = sizeof (max_len);
d51 3
d70 4
d78 1
a78 1
@@@@ -1171,12 +1206,18 @@@@ _dbus_command_for_pid (unsigned long  pid,
@


1.11
log
@Rewrite _dbus_command_for_pid() to that we don't use libkvm.

glanced over by miod@@
@
text
@d1 1
a1 1
$OpenBSD: patch-dbus_dbus-sysdeps-util-unix_c,v 1.10 2014/01/24 10:43:16 ajacoutot Exp $
d6 1
a6 1
+++ dbus/dbus-sysdeps-util-unix.c	Mon Apr 14 19:05:17 2014
d40 1
a40 1
@@@@ -1163,6 +1174,34 @@@@ _dbus_command_for_pid (unsigned long  pid,
d45 1
a45 2
+  args = NULL;
+  len = max_len;
d51 1
a51 4
+  if (sysctl (mib, 4, NULL, &len, NULL, 0) == -1)
+    goto fail;
+
+  args = malloc (len + 1);
d71 1
a71 1
@@@@ -1171,12 +1210,18 @@@@ _dbus_command_for_pid (unsigned long  pid,
@


1.10
log
@Update to dbus-1.8.0.

bulk testing by landry@@
runtime testing by myself
@
text
@d1 1
a1 1
$OpenBSD: patch-dbus_dbus-sysdeps-util-unix_c,v 1.9 2013/10/09 11:10:49 ajacoutot Exp $
d6 2
a7 2
+++ dbus/dbus-sysdeps-util-unix.c	Wed Jan 22 12:00:04 2014
@@@@ -60,6 +60,13 @@@@
a11 2
+#include <sys/param.h>
+#include <sys/proc.h>
a12 1
+#include <kvm.h>
d18 1
a18 1
@@@@ -1121,7 +1128,14 @@@@ _dbus_command_for_pid (unsigned long  pid,
d25 3
a27 4
+  int nproc;
+  struct kinfo_proc *kp;
+  kvm_t *kd;
+  char **argv;
d32 1
a32 1
@@@@ -1136,6 +1150,7 @@@@ _dbus_command_for_pid (unsigned long  pid,
d40 1
a40 1
@@@@ -1163,6 +1178,24 @@@@ _dbus_command_for_pid (unsigned long  pid,
d44 7
a50 3
+#else
+  if ((kd = kvm_openfiles(NULL, NULL, NULL, KVM_NO_FILES, NULL)) == NULL)
+    goto fail;
d52 1
a52 1
+  if ((kp = kvm_getprocs(kd, KERN_PROC_PID, pid, sizeof(*kp), &nproc)) == NULL)
d55 2
a56 1
+  if ((kp->p_flag & P_SYSTEM) != 0)
d59 1
a59 1
+  if ((argv = kvm_getargv(kd, kp, 0)) == NULL)
d62 9
a70 4
+  if (!_dbus_string_append_printf (&cmdline, *argv))
+    goto fail;
+  else
+    kvm_close(kd);
d75 10
a84 1
@@@@ -1177,6 +1210,9 @@@@ oom:
d89 1
a89 1
+  kvm_close(kd);
@


1.9
log
@Update to dbus-1.6.16.
@
text
@d1 1
a1 1
$OpenBSD: patch-dbus_dbus-sysdeps-util-unix_c,v 1.8 2013/05/07 07:00:01 ajacoutot Exp $
d5 5
a9 5
--- dbus/dbus-sysdeps-util-unix.c.orig	Fri Sep 13 13:22:11 2013
+++ dbus/dbus-sysdeps-util-unix.c	Wed Oct  9 12:43:47 2013
@@@@ -55,6 +55,13 @@@@
 #include <sys/syslimits.h>
 #endif
d21 1
a21 1
@@@@ -1108,7 +1115,14 @@@@ _dbus_command_for_pid (unsigned long  pid,
d36 1
a36 1
@@@@ -1123,6 +1137,7 @@@@ _dbus_command_for_pid (unsigned long  pid,
d44 1
a44 1
@@@@ -1150,6 +1165,24 @@@@ _dbus_command_for_pid (unsigned long  pid,
d69 1
a69 1
@@@@ -1164,5 +1197,8 @@@@ oom:
d78 1
@


1.8
log
@Update to dbus-1.6.10.
@
text
@d1 1
a1 1
$OpenBSD: patch-dbus_dbus-sysdeps-util-unix_c,v 1.7 2013/01/08 09:30:27 ajacoutot Exp $
d5 2
a6 2
--- dbus/dbus-sysdeps-util-unix.c.orig	Fri Nov  9 17:01:44 2012
+++ dbus/dbus-sysdeps-util-unix.c	Tue May  7 08:47:04 2013
d44 1
a44 1
@@@@ -1149,6 +1164,24 @@@@ _dbus_command_for_pid (unsigned long  pid,
d69 1
a69 1
@@@@ -1163,5 +1196,8 @@@@ oom:
@


1.7
log
@Bring some fixes from upstream:
* sync configure.ac patch
* dbus-spawn: set SIGPIPE to SIG_IGN before activating services
* dbus-sysdeps-pthread.c: don't fail if !HAVE_MONOTONIC_CLOCK under -Werror=unused
* Remove redundant close() calls
* Don't leak temporary fds pointing to /dev/null
@
text
@d1 1
a1 1
$OpenBSD: patch-dbus_dbus-sysdeps-util-unix_c,v 1.6 2012/12/18 21:38:12 sthen Exp $
d5 2
a6 7
From 9a9b0e2736378d1a8961fb264d7314e921231e8e Mon Sep 17 00:00:00 2001
From: Michel HERMIER <hermier@@frugalware.org>
Date: Fri, 09 Nov 2012 15:44:43 +0000
Subject: Don't leak temporary fds pointing to /dev/null

--- dbus/dbus-sysdeps-util-unix.c.orig	Fri Sep 28 21:17:25 2012
+++ dbus/dbus-sysdeps-util-unix.c	Tue Jan  8 09:59:46 2013
d21 1
a21 9
@@@@ -123,6 +130,7 @@@@ _dbus_become_daemon (const DBusString *pidfile,
             dup2 (dev_null_fd, 2);
           else
             _dbus_verbose ("keeping stderr open due to DBUS_DEBUG_OUTPUT\n");
+          close (dev_null_fd);
         }
 
       if (!keep_umask)
@@@@ -1107,7 +1115,14 @@@@ _dbus_command_for_pid (unsigned long  pid,
d36 1
a36 1
@@@@ -1122,6 +1137,7 @@@@ _dbus_command_for_pid (unsigned long  pid,
d44 1
a44 1
@@@@ -1148,6 +1164,24 @@@@ _dbus_command_for_pid (unsigned long  pid,
d69 1
a69 1
@@@@ -1162,5 +1196,8 @@@@ oom:
@


1.6
log
@cope with sysctl.h changes
@
text
@d1 1
a1 1
$OpenBSD: patch-dbus_dbus-sysdeps-util-unix_c,v 1.5 2012/10/11 07:25:20 ajacoutot Exp $
d5 7
a11 2
--- dbus/dbus-sysdeps-util-unix.c.orig	Fri Sep 28 13:17:25 2012
+++ dbus/dbus-sysdeps-util-unix.c	Thu Dec  6 15:20:23 2012
d26 9
a34 1
@@@@ -1107,7 +1114,14 @@@@ _dbus_command_for_pid (unsigned long  pid,
d49 1
a49 2
@@@@ -1121,7 +1135,8 @@@@ _dbus_command_for_pid (unsigned long  pid,
       _dbus_string_free (&path);
d52 1
a52 2
-  
+
d57 1
a57 1
@@@@ -1148,6 +1163,24 @@@@ _dbus_command_for_pid (unsigned long  pid,
d82 1
a82 1
@@@@ -1162,5 +1195,8 @@@@ oom:
@


1.5
log
@Implement _dbus_command_for_pid which is really useful for debugging.
@
text
@d1 1
a1 1
$OpenBSD: patch-dbus_dbus-sysdeps-util-unix_c,v 1.4 2012/08/15 08:03:43 ajacoutot Exp $
d5 3
a7 3
--- dbus/dbus-sysdeps-util-unix.c.orig	Fri Sep 28 21:17:25 2012
+++ dbus/dbus-sysdeps-util-unix.c	Thu Oct 11 09:19:52 2012
@@@@ -55,6 +55,12 @@@@
d13 1
d21 1
a21 1
@@@@ -1107,7 +1113,14 @@@@ _dbus_command_for_pid (unsigned long  pid,
d36 1
a36 1
@@@@ -1121,7 +1134,8 @@@@ _dbus_command_for_pid (unsigned long  pid,
d46 1
a46 1
@@@@ -1148,6 +1162,24 @@@@ _dbus_command_for_pid (unsigned long  pid,
d71 1
a71 1
@@@@ -1162,5 +1194,8 @@@@ oom:
@


1.4
log
@Bugfix update to dbus-1.6.4.
@
text
@d1 1
a1 1
$OpenBSD: patch-dbus_dbus-sysdeps-util-unix_c,v 1.3 2012/07/05 07:19:48 ajacoutot Exp $
d3 1
a3 3
Don't try to use /proc; we don't provide a replacement because this
function is only called once for logging purpose, its return code is not
checked and as the code says: "This string <...> may not be trusted".
d5 16
a20 7
--- dbus/dbus-sysdeps-util-unix.c.orig	Thu Jun 28 16:49:23 2012
+++ dbus/dbus-sysdeps-util-unix.c	Wed Aug 15 09:51:07 2012
@@@@ -1104,6 +1104,7 @@@@ _dbus_command_for_pid (unsigned long  pid,
                        int            max_len,
                        DBusError     *error)
 {
+#ifndef __OpenBSD__
d24 48
a71 1
@@@@ -1163,4 +1164,7 @@@@ fail:
d74 3
a77 3
+#else // OpenBSD
+  return FALSE;
+#endif
@


1.3
log
@Update to dbus-1.6.2.
Committing now so that any fallout can be fixed during g2k12.
@
text
@d1 1
a1 1
$OpenBSD: patch-dbus_dbus-sysdeps-util-unix_c,v 1.2 2011/09/29 06:57:36 ajacoutot Exp $
d7 3
a9 3
--- dbus/dbus-sysdeps-util-unix.c.orig	Wed Jun  6 12:45:55 2012
+++ dbus/dbus-sysdeps-util-unix.c	Thu Jul  5 07:47:00 2012
@@@@ -1103,6 +1103,7 @@@@ _dbus_command_for_pid (unsigned long  pid,
d17 1
a17 1
@@@@ -1162,4 +1163,7 @@@@ fail:
@


1.2
log
@Bugfix update to dbus-1.4.16.
@
text
@d1 1
a1 1
$OpenBSD: patch-dbus_dbus-sysdeps-util-unix_c,v 1.1 2011/05/06 07:34:18 ajacoutot Exp $
d7 3
a9 3
--- dbus/dbus-sysdeps-util-unix.c.orig	Wed Sep 21 13:16:16 2011
+++ dbus/dbus-sysdeps-util-unix.c	Thu Sep 29 08:49:44 2011
@@@@ -1104,6 +1104,7 @@@@ _dbus_command_for_pid (unsigned long  pid,
d17 1
a17 1
@@@@ -1163,4 +1164,7 @@@@ fail:
@


1.1
log
@Don't try to open /proc.
@
text
@d1 1
a1 1
$OpenBSD$
d7 3
a9 3
--- dbus/dbus-sysdeps-util-unix.c.orig	Fri May  6 08:00:22 2011
+++ dbus/dbus-sysdeps-util-unix.c	Fri May  6 08:04:41 2011
@@@@ -1086,6 +1086,7 @@@@ _dbus_command_for_pid (unsigned long  pid,
d17 1
a17 1
@@@@ -1145,4 +1146,7 @@@@ fail:
@

