head	1.2;
access;
symbols
	OPENBSD_5_5:1.2.0.2;
locks; strict;
comment	@# @;


1.2
date	2014.01.24.10.43.16;	author ajacoutot;	state dead;
branches
	1.2.2.1;
next	1.1;

1.1
date	2013.12.08.10.42.34;	author ajacoutot;	state Exp;
branches;
next	;

1.2.2.1
date	2014.06.11.15.07.22;	author ajacoutot;	state Exp;
branches;
next	;
commitid	Up7yJhPDFzG8LiWa;


desc
@@


1.2
log
@Update to dbus-1.8.0.

bulk testing by landry@@
runtime testing by myself
@
text
@$OpenBSD: patch-bus_activation_c,v 1.1 2013/12/08 10:42:34 ajacoutot Exp $

From 03aeaccbffa97c9237b57ca067e3da7388862129 Mon Sep 17 00:00:00 2001
From: Radoslaw Pajak <r.pajak@@samsung.com>
Date: Fri, 08 Nov 2013 12:51:32 +0000
Subject: fixed memory freeing if error during listing services

--- bus/activation.c.orig	Wed Jun  5 18:40:34 2013
+++ bus/activation.c	Sun Dec  8 10:55:33 2013
@@@@ -2179,7 +2179,7 @@@@ bus_activation_list_services (BusActivation *activatio
 
  error:
   for (j = 0; j < i; j++)
-    dbus_free (retval[i]);
+    dbus_free (retval[j]);
   dbus_free (retval);
 
   return FALSE;
@


1.2.2.1
log
@SECURITY fix for:
CVE-2014-3477: deliver activation errors correctly, fixing Denial of Service
@
text
@d1 1
a1 1
$OpenBSD$
d3 4
a6 4
From 24c590703ca47eb71ddef453de43126b90954567 Mon Sep 17 00:00:00 2001
From: Alban Crequy <alban.crequy@@collabora.co.uk>
Date: Tue, 20 May 2014 13:37:37 +0000
Subject: CVE-2014-3477: deliver activation errors correctly, fixing Denial of Service
d8 3
a10 12
--- bus/activation.c.orig	Tue Nov 12 11:55:43 2013
+++ bus/activation.c	Wed Jun 11 17:05:11 2014
@@@@ -1162,14 +1162,11 @@@@ bus_activation_service_created (BusActivation  *activa
 dbus_bool_t
 bus_activation_send_pending_auto_activation_messages (BusActivation  *activation,
                                                       BusService     *service,
-                                                      BusTransaction *transaction,
-                                                      DBusError      *error)
+                                                      BusTransaction *transaction)
 {
   BusPendingActivation *pending_activation;
   DBusList *link;
d12 5
a16 47
-  _DBUS_ASSERT_ERROR_IS_CLEAR (error);
-
   /* Check if it's a pending activation */
   pending_activation = _dbus_hash_table_lookup_string (activation->pending_activations,
                                                        bus_service_get_name (service));
@@@@ -1186,15 +1183,32 @@@@ bus_activation_send_pending_auto_activation_messages (
       if (entry->auto_activation && (entry->connection == NULL || dbus_connection_get_is_connected (entry->connection)))
         {
           DBusConnection *addressed_recipient;
+          DBusError error;
 
+          dbus_error_init (&error);
+
           addressed_recipient = bus_service_get_primary_owners_connection (service);
 
           /* Resume dispatching where we left off in bus_dispatch() */
           if (!bus_dispatch_matches (transaction,
                                      entry->connection,
                                      addressed_recipient,
-                                     entry->activation_message, error))
-            goto error;
+                                     entry->activation_message, &error))
+            {
+              /* If permission is denied, we just want to return the error
+               * to the original method invoker; in particular, we don't
+               * want to make the RequestName call fail with that error
+               * (see fd.o #78979, CVE-2014-3477). */
+              if (!bus_transaction_send_error_reply (transaction, entry->connection,
+                                                     &error, entry->activation_message))
+                {
+                  bus_connection_send_oom_error (entry->connection,
+                                                 entry->activation_message);
+                }
+
+              link = next;
+              continue;
+            }
         }
 
       link = next;
@@@@ -1203,7 +1217,6 @@@@ bus_activation_send_pending_auto_activation_messages (
   if (!add_restore_pending_to_transaction (transaction, pending_activation))
     {
       _dbus_verbose ("Could not add cancel hook to transaction to revert removing pending activation\n");
-      BUS_SET_OOM (error);
       goto error;
     }
d18 1
@


1.1
log
@Fix a mem leak and undefined behaviour; from upstream.
@
text
@d1 1
a1 1
$OpenBSD$
@

