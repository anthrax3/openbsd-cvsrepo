head	1.4;
access;
symbols
	OPENBSD_5_0:1.3.0.2
	OPENBSD_5_0_BASE:1.3
	jasper_20111705:1.1.1.1
	jasper:1.1.1;
locks; strict;
comment	@# @;


1.4
date	2011.09.12.07.31.39;	author jasper;	state dead;
branches;
next	1.3;

1.3
date	2011.07.13.08.09.12;	author jasper;	state Exp;
branches;
next	1.2;

1.2
date	2011.05.18.15.25.34;	author jasper;	state Exp;
branches;
next	1.1;

1.1
date	2011.05.17.17.21.35;	author jasper;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2011.05.17.17.21.35;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Remove what I've merged.
@
text
@$OpenBSD: patch-src_nettool_c,v 1.3 2011/07/13 08:09:12 jasper Exp $

From da8ec778b8ea691e1043173a0e8ea5e226a429b0 Mon Sep 17 00:00:00 2001
From: Jasper Lievisse Adriaanse <jasper@@humppa.nl>
Date: Thu, 19 May 2011 18:45:05 +0200
Subject: [PATCH] portability fix for systems that configure an ipv6 address
  by default, but use the ipv4 address for actual traffic.

tweak decision logic for deciding if we should use the ipv4 or ipv6 tools.
it would default to ipv6 as most interfaces have an unused ipv6 address, while
actually using the ipv4 address. this fixes ping/traceroute functionality when
using hostnames instead of ip addresses.

--- src/nettool.c.orig	Thu Dec  2 10:26:14 2010
+++ src/nettool.c	Wed May 18 15:43:49 2011
@@@@ -24,6 +24,7 @@@@
 #include <string.h>
 #include <sys/types.h>
 #include <sys/socket.h>
+#include <netinet/in.h>
 #include <signal.h>
 #include <errno.h>
 #include <sys/wait.h>
@@@@ -137,21 +138,21 @@@@ netinfo_get_ip_version (Netinfo * netinfo)
 				   (GTK_BIN (netinfo->host)))));
 
 	if (strlen (ip) > 0) {
-		host = gethostbyname2 (ip, AF_INET6);
+		host = gethostbyname2 (ip, AF_INET);
 		if (host == NULL) {
-			host = gethostbyname2 (ip, AF_INET);
+			host = gethostbyname2 (ip, AF_INET6);
 			if (host == NULL)
 				return -1;
 			else {
 				g_free (ip);
-				return IPV4;
+				return IPV6;
 			}
 			
 			return -1;
 		}
 		else {
 			g_free (ip);
-			return IPV6;
+			return IPV4;
 		}
 
 	}
@@@@ -374,6 +375,10 @@@@ netinfo_io_text_buffer_dialog (GIOChannel * channel,
 						 	len, NULL);
 			}
 
+			g_free (text);
+
+			return TRUE;
+
 		} else if (status == G_IO_STATUS_AGAIN) {
 			char buf[1];
 
@@@@ -385,6 +390,8 @@@@ netinfo_io_text_buffer_dialog (GIOChannel * channel,
 				}
 				g_string_append_c (netinfo->command_output, buf[0]);
 			}
+			g_free (text);
+			return TRUE;
 		} else if (status == G_IO_STATUS_EOF) {
 			
 		} else if (status == G_IO_STATUS_ERROR) {
@@@@ -402,15 +409,15 @@@@ netinfo_io_text_buffer_dialog (GIOChannel * channel,
 
 			} else {
 				g_warning ("Error: %s\n", err->message);
-				g_free (text);
 				g_free (err);
 			}
 
+			g_free (text);
+			return TRUE;
+
 		}
 
 		g_free (text);
-
-		return TRUE;
 	}
 
 	/* The condition is not G_IO_HUP | G_IO_ERR | G_IO_NVAL, so
@


1.3
log
@sync comments, no package change
@
text
@d1 1
a1 1
$OpenBSD: patch-src_nettool_c,v 1.2 2011/05/18 15:25:34 jasper Exp $
@


1.2
log
@tweak decision logic for deciding if we should use the ipv4 or ipv6 tools.
it would default to ipv6 as most interfaces have an unused ipv6 address, while
actually using the ipv4 address. this fixes ping/traceroute functionality when
using hostnames instead of ip addresses.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_nettool_c,v 1.1.1.1 2011/05/17 17:21:35 jasper Exp $
d3 10
a12 8
On OpenBSD configured interfaces have default IPv6 address, this would
cause the code in netinfo_get_ip_version() to believe we should use the IPv6
version of various tools, like ping6 and traceroute6. While in reality many people
leave the interfaces as is (don't remove the IPv6 address) and use the interface
over IPv4. So the IPv6 tools wouldn't have a proper way out and fail, this was the
default behaviour...
Now the code defaults to checking if for AF_INET address family instead
of the other way around (which would thus always return IPv6).
@


1.1
log
@Initial revision
@
text
@d1 13
a13 3
$OpenBSD: patch-src_nettool_c,v 1.1.1.1 2010/04/10 16:51:07 ajacoutot Exp $
--- src/nettool.c.orig	Tue Sep 22 15:30:34 2009
+++ src/nettool.c	Tue Mar 30 15:38:15 2010
d22 26
@


1.1.1.1
log
@import gnome-nettool 3.0.0

GNOME Nettool is a set of front-ends to various networking command-line
tools, like ping, netstat, ifconfig, whois, traceroute, finger.

ok aja@@
@
text
@@
