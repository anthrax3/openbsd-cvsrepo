head	1.5;
access;
symbols
	OPENBSD_5_0:1.4.0.2
	OPENBSD_5_0_BASE:1.4
	jasper_20111705:1.1.1.1
	jasper:1.1.1;
locks; strict;
comment	@# @;


1.5
date	2011.09.12.07.31.39;	author jasper;	state dead;
branches;
next	1.4;

1.4
date	2011.06.16.11.01.36;	author ajacoutot;	state Exp;
branches;
next	1.3;

1.3
date	2011.06.15.17.01.07;	author ajacoutot;	state Exp;
branches;
next	1.2;

1.2
date	2011.05.18.13.29.11;	author jasper;	state Exp;
branches;
next	1.1;

1.1
date	2011.05.17.17.21.35;	author jasper;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2011.05.17.17.21.35;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.5
log
@Remove what I've merged.
@
text
@$OpenBSD: patch-src_info_c,v 1.4 2011/06/16 11:01:36 ajacoutot Exp $

https://bugzilla.gnome.org/show_bug.cgi?id=652713
https://bugzilla.gnome.org/show_bug.cgi?id=647896

--- src/info.c.orig	Thu Dec  2 10:26:14 2010
+++ src/info.c	Thu Jun 16 12:43:17 2011
@@@@ -20,6 +20,12 @@@@
 #include <gtk/gtk.h>
 #include <glib/gi18n.h>
 #include <glib/gprintf.h>
+#if defined (__FreeBSD__) || defined (__OpenBSD__)
+#include <sys/types.h>
+#include <string.h>
+#include <errno.h>
+#include <unistd.h>
+#endif
 
 #ifdef HAVE_CONFIG_H
 #  include <config.h>
@@@@ -37,6 +43,9 @@@@
 #include <sys/ioctl.h>
 #include <stdlib.h>
 #include <net/if.h>
+#if defined (__FreeBSD__) || defined (__OpenBSD__)
+#include <net/if_media.h>
+#endif
 
 #include <glibtop.h>
 #include <glibtop/netlist.h>
@@@@ -131,9 +140,39 @@@@ info_get_interface_from_dev_name (const gchar *dev_nam
 {
 	gint i;
 	gchar *path;
+	gchar *dev_type = NULL;
 	
+#if defined (__FreeBSD__) || defined (__OpenBSD__)
+	int s;
+	struct ifmediareq ifmr;
+
+	if ((s = socket (AF_INET, SOCK_DGRAM, 0)) > -1) {
+
+		(void) memset (&ifmr, 0, sizeof (ifmr));
+		(void) strncpy (ifmr.ifm_name, dev_name, sizeof (ifmr.ifm_name));
+
+		if (ioctl (s, SIOCGIFMEDIA, (caddr_t) &ifmr) > -1) {
+			switch (IFM_TYPE (ifmr.ifm_active)) {
+				case IFM_ETHER:
+					dev_type = "eth";
+					break;
+				case IFM_IEEE80211:
+					dev_type = "wlan";
+					break;
+				default:
+					dev_type = "other_type";
+					break;
+			}
+		}
+		close (s);
+	}
+#endif /* defined (__FreeBSD__) || defined (__OpenBSD__) */
+
+	if (!dev_type)
+		dev_type = (gchar *) dev_name;
+
 	for (i = 0; info_iface_desc[i].name; i++)
-		if (strstr (dev_name, info_iface_desc[i].prefix) == dev_name) {
+		if (strstr (dev_type, info_iface_desc[i].prefix) == dev_type) {
 			(*iface) = g_strdup_printf ("%s (%s)", _(info_iface_desc[i].name), dev_name);
 			if (info_iface_desc[i].pixbuf == NULL) {
 				path = g_build_filename (PIXMAPS_DIR, info_iface_desc[i].icon, NULL);
@@@@ -200,13 +239,13 @@@@ info_load_iface (Netinfo *info)
 	gtk_cell_layout_pack_start (GTK_CELL_LAYOUT (info->combo), renderer, TRUE);
 	gtk_cell_layout_set_attributes (GTK_CELL_LAYOUT (info->combo), renderer,
 					"pixbuf", 0, NULL);
-	g_object_unref (renderer);
+	/* g_object_unref (renderer); */
 
 	renderer = gtk_cell_renderer_text_new ();
 	gtk_cell_layout_pack_start (GTK_CELL_LAYOUT (info->combo), renderer, TRUE);
 	gtk_cell_layout_set_attributes (GTK_CELL_LAYOUT (info->combo), renderer,
 					"markup", 1, NULL);
-	g_object_unref (renderer);
+	/* g_object_unref (renderer); */
 
 	gtk_combo_box_set_active (GTK_COMBO_BOX (info->combo), 0);
 }
@


1.4
log
@Default to "other_type" in switch.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_info_c,v 1.3 2011/06/15 17:01:07 ajacoutot Exp $
@


1.3
log
@Zap bogus enum.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_info_c,v 1.2 2011/05/18 13:29:11 jasper Exp $
d3 2
a4 3
- Add OpenBSD/FreeBSD specific code
- g_object_unref() prevents interface name and pixmap from being displayed,
  and creates a storm of critial gtk warnings, upstream bz: #647896.
d7 2
a8 2
+++ src/info.c	Wed Jun 15 18:58:08 2011
@@@@ -20,6 +20,10 @@@@
d12 1
d17 1
d21 1
a21 1
@@@@ -37,6 +41,9 @@@@
d31 1
a31 1
@@@@ -131,9 +138,44 @@@@ info_get_interface_from_dev_name (const gchar *dev_nam
a34 1
-	
d36 1
a50 9
+				case IFM_FDDI:
+#ifdef IFM_TOKEN
+				case IFM_TOKEN:
+#endif
+#ifdef IFM_ATM
+				case IFM_ATM:
+#endif
+					dev_type = "other_type";
+					break;
d54 3
d72 1
a72 1
@@@@ -200,13 +242,13 @@@@ info_load_iface (Netinfo *info)
@


1.2
log
@prevent a tornado of warnings and let this work a lot better
@
text
@d1 1
a1 1
$OpenBSD: patch-src_info_c,v 1.1.1.1 2011/05/17 17:21:35 jasper Exp $
d8 1
a8 1
+++ src/info.c	Wed May 18 15:21:05 2011
d30 1
a30 9
@@@@ -61,6 +68,7 @@@@ static InfoInterfaceDescription info_iface_desc [] = {
 	{ N_("Ethernet Interface"),      INFO_INTERFACE_ETH,     "16_ethernet.xpm", "eth",        NULL },
 	{ N_("Wireless Interface"),      INFO_INTERFACE_WLAN,    "wavelan-16.png",  "wlan",       NULL },
 	{ N_("Modem Interface"),         INFO_INTERFACE_PPP,     "16_ppp.xpm",      "ppp",        NULL },
+	{ N_("Modem Interface"),         INFO_INTERFACE_PPP,     "16_ppp.xpm",      "tun",        NULL },
 	{ N_("Parallel Line Interface"), INFO_INTERFACE_PLIP,    "16_plip.xpm",     "plip",       NULL },
 	{ N_("Infrared Interface"),      INFO_INTERFACE_IRLAN,   "irda-16.png",     "irlan",      NULL },
 	{ N_("Loopback Interface"),      INFO_INTERFACE_LO,      "16_loopback.xpm", "lo",         NULL },
@@@@ -131,9 +139,44 @@@@ info_get_interface_from_dev_name (const gchar *dev_nam
d77 1
a77 1
@@@@ -200,13 +243,13 @@@@ info_load_iface (Netinfo *info)
@


1.1
log
@Initial revision
@
text
@d1 8
a8 3
$OpenBSD: patch-src_info_c,v 1.1.1.1 2010/04/10 16:51:07 ajacoutot Exp $
--- src/info.c.orig	Tue Sep 22 15:30:34 2009
+++ src/info.c	Tue Mar 30 15:42:12 2010
d85 16
@


1.1.1.1
log
@import gnome-nettool 3.0.0

GNOME Nettool is a set of front-ends to various networking command-line
tools, like ping, netstat, ifconfig, whois, traceroute, finger.

ok aja@@
@
text
@@
