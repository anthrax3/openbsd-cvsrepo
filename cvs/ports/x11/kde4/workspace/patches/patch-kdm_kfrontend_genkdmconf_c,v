head	1.3;
access;
symbols
	OPENBSD_6_2:1.3.0.16
	OPENBSD_6_2_BASE:1.3
	OPENBSD_6_1:1.3.0.14
	OPENBSD_6_1_BASE:1.3
	OPENBSD_6_0:1.3.0.12
	OPENBSD_6_0_BASE:1.3
	OPENBSD_5_9:1.3.0.8
	OPENBSD_5_9_BASE:1.3
	OPENBSD_5_8:1.3.0.10
	OPENBSD_5_8_BASE:1.3
	OPENBSD_5_7:1.3.0.6
	OPENBSD_5_7_BASE:1.3
	OPENBSD_5_6:1.3.0.4
	OPENBSD_5_6_BASE:1.3
	OPENBSD_5_5:1.3.0.2
	OPENBSD_5_5_BASE:1.3;
locks; strict;
comment	@# @;


1.3
date	2014.01.31.17.45.35;	author zhuk;	state Exp;
branches;
next	1.2;

1.2
date	2014.01.28.20.50.40;	author zhuk;	state Exp;
branches;
next	1.1;

1.1
date	2014.01.28.14.49.26;	author zhuk;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Do the chmod dance with /dev/drm0 in KDM, using default scripts in /etc/kdm.
Reminded in chat.

Also, update KDM patches description while there.
@
text
@$OpenBSD: patch-kdm_kfrontend_genkdmconf_c,v 1.2 2014/01/28 20:50:40 zhuk Exp $
1. Provide OpenBSD-specific hacks for session startup and reset.
2. Deconfict with kdebase-3.x.
--- kdm/kfrontend/genkdmconf.c.orig	Thu Jan  2 23:27:49 2014
+++ kdm/kfrontend/genkdmconf.c	Fri Jan 31 21:40:25 2014
@@@@ -685,6 +685,9 @@@@ static const char def_startup[] =
 "#\n"
 "#chown $USER /dev/console\n"
 "\n"
+"# Allow to use OpenBSD Direct Rendering Manager\n"
+"chown $USER /dev/drm0\n"
+"\n"
 "# XDM configurations typically have sessreg here. KDM has it built-in.\n"
 "\n"
 "# NOTE: The session is aborted if the last command returns non-zero.\n";
@@@@ -699,6 +702,15 @@@@ static const char def_reset[] =
 "#chown root /dev/console\n"
 "#chmod 622 /dev/console\n"
 "\n"
+"# Reset access to OpenBSD Direct Rendering Manager\n"
+"chown root /dev/drm0\n"
+"chmod 0600 /dev/drm0\n"
+"\n"
+"# This is an OpenBSD-specific hack until ConsoleKit gets fixed.\n"
+"# OpenBSD does not support multi-seat X sessions now anyway.\n"
+"#\n"
+"pkill -u 0 ${LOCALBASE}/sbin/console-kit-daemon\n"
+"\n"
 "# XDM configurations typically have sessreg here. KDM has it built-in.\n";
 
 static const char def_session1[] =
@@@@ -771,7 +783,7 @@@@ static const char def_session2[] =
 "    exec $HOME/.xsession\n"
 "    ;;\n"
 "  default)\n"
-"    exec " KDE_BINDIR "/startkde\n"
+"    exec " KDE_BINDIR "/startkde4\n"
 "    ;;\n"
 "  *)\n"
 "    eval exec \"$session\"\n"
@


1.2
log
@Polish KDM support:

  * Add rc script. Just add "kdm" to pkg_scripts in rc.conf.local now.

  * Add a dirty hack for console-kit-daemon until ConsoleKit gets fixed.
    We don't support multi-seat X now anyway.

Please note: while the rc script is based on gdm.rc, it has somewhat changed
logic. So if you're using KDM, please test it in rc.conf.local before we
get to 5.5 release, to make sure it doesn't break. It shouldn't, of course,
but, you know, IT happens.
@
text
@d1 3
a3 2
$OpenBSD: patch-kdm_kfrontend_genkdmconf_c,v 1.1 2014/01/28 14:49:26 zhuk Exp $
Deconfict with kdebase-3.x.
d5 12
a16 2
+++ kdm/kfrontend/genkdmconf.c	Wed Jan 29 00:17:45 2014
@@@@ -699,6 +699,11 @@@@ static const char def_reset[] =
d20 4
d32 1
a32 1
@@@@ -771,7 +776,7 @@@@ static const char def_session2[] =
@


1.1
log
@Fix problems with starting KDE session from startkde4, after discussion
on ports@@openbsd.org. Big hint received from Remco, thanks!

KDM still have some issues, mostly related to migration paths. To be fixed
soon.

Added/updated description for some patches while there.
@
text
@d1 1
a1 1
$OpenBSD$
d3 15
a17 3
--- kdm/kfrontend/genkdmconf.c.orig	Mon Jan 27 21:17:33 2014
+++ kdm/kfrontend/genkdmconf.c	Mon Jan 27 21:17:43 2014
@@@@ -771,7 +771,7 @@@@ static const char def_session2[] =
@

