head	1.3;
access;
symbols
	OPENBSD_4_3:1.2.0.4
	OPENBSD_4_3_BASE:1.2
	OPENBSD_4_2:1.2.0.2
	OPENBSD_4_2_BASE:1.2
	OPENBSD_4_1:1.1.1.1.0.8
	OPENBSD_4_1_BASE:1.1.1.1
	OPENBSD_4_0:1.1.1.1.0.6
	OPENBSD_4_0_BASE:1.1.1.1
	OPENBSD_3_9:1.1.1.1.0.4
	OPENBSD_3_9_BASE:1.1.1.1
	OPENBSD_3_8:1.1.1.1.0.2
	OPENBSD_3_8_BASE:1.1.1.1
	jolan_2005-may-11:1.1.1.1
	jolan:1.1.1;
locks; strict;
comment	@# @;


1.3
date	2008.04.17.13.14.28;	author landry;	state dead;
branches;
next	1.2;

1.2
date	2007.05.11.14.02.02;	author steven;	state Exp;
branches;
next	1.1;

1.1
date	2005.05.12.04.38.50;	author jolan;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2005.05.12.04.38.50;	author jolan;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Update to diskperf-plugin 2.2.0, not BROKEN anymore.
I took over upstream maintenance and integrated our patches.

ok ajacoutot@@
@
text
@$OpenBSD: patch-panel-plugin_devperf_c,v 1.2 2007/05/11 14:02:02 steven Exp $
--- panel-plugin/devperf.c.orig	Thu Jan 18 18:12:07 2007
+++ panel-plugin/devperf.c	Fri May 11 15:48:55 2007
@@@@ -305,6 +305,82 @@@@ int DevGetPerfData (const void *p_pvDevice, struct dev
 /* *INDENT-ON* */
 	/**************************	NetBSD End	***************/
 
+#elif defined(__OpenBSD__)
+/*
+ * OpenBSD support.
+ */
+
+#include <sys/param.h>
+#include <sys/sysctl.h>
+#include <sys/disk.h>
+
+int DevPerfInit ()
+{
+        return (0);
+}
+
+int DevCheckStatAvailability(char const **strptr)
+{
+        return (0);
+}
+
+int DevGetPerfData (const void *p_pvDevice, struct devperf_t *perf)
+{
+	int mib[3], diskn, x;
+	size_t len;
+	char *devname = (char *)p_pvDevice;
+	struct diskstats *ds;
+	struct timeval tv;
+
+	mib[0] = CTL_HW;
+	mib[1] = HW_DISKCOUNT;
+	len = sizeof(diskn);
+
+	if (sysctl(mib, 2, &diskn, &len, NULL, 0) < 0)
+		return (-1);
+
+	mib[0] = CTL_HW;
+	mib[1] = HW_DISKSTATS;
+	len = diskn * sizeof(struct diskstats);
+
+	ds = malloc(len);
+	if (ds == NULL)
+		return (-1);
+
+	if (sysctl(mib, 2, ds, &len, NULL, 0) < 0) {
+		free(ds);
+		return (-1);
+	}
+
+	for (x = 0; x < diskn; x++)
+		if (!strcmp(ds[x].ds_name, devname))
+			break;
+
+	if (x == diskn) {
+		free(ds);
+		return (-1);
+	}
+
+	if (gettimeofday(&tv, NULL)) {
+		free(ds);
+		return (-1);
+	}
+
+	perf->timestamp_ns = (uint64_t)1000ull * 1000ull * 1000ull * tv.tv_sec
+	    + 1000ull * tv.tv_usec; 
+        perf->rbusy_ns = ((uint64_t)1000ull * 1000ull * 1000ull *
+	    ds[x].ds_time.tv_sec + 1000ull * ds[x].ds_time.tv_usec) / 2ull;
+
+	perf->wbusy_ns = perf->rbusy_ns / 2ull;
+	perf->rbytes = ds[x].ds_rbytes;
+	perf->wbytes = ds[x].ds_wbytes;
+	perf->qlen = ds[x].ds_rxfer + ds[x].ds_wxfer;
+
+	free(ds);
+
+	return (0);
+}
+
 #else
 	/**************************************************************/
 	/********************	Unsupported platform	***************/
@


1.2
log
@update to 2.1.0
@
text
@d1 1
a1 1
$OpenBSD: patch-panel-plugin_devperf_c,v 1.1.1.1 2005/05/12 04:38:50 jolan Exp $
@


1.1
log
@Initial revision
@
text
@d1 4
a4 4
$OpenBSD: patch-panel-plugin_devperf_c,v 1.2 2004/02/17 21:37:15 jolan Exp $
--- panel-plugin/devperf.c.orig	Sun Nov 30 04:58:54 2003
+++ panel-plugin/devperf.c	Sat Feb 19 21:44:08 2005
@@@@ -317,6 +317,82 @@@@ int DevGetPerfData (const void *p_pvDevi
@


1.1.1.1
log
@xfce 4.2.1
@
text
@@
