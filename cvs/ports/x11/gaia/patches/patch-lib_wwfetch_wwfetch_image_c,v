head	1.1;
access;
symbols
	OPENBSD_6_1:1.1.0.34
	OPENBSD_6_1_BASE:1.1
	OPENBSD_6_0:1.1.0.32
	OPENBSD_6_0_BASE:1.1
	OPENBSD_5_9:1.1.0.28
	OPENBSD_5_9_BASE:1.1
	OPENBSD_5_8:1.1.0.30
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.26
	OPENBSD_5_7_BASE:1.1
	OPENBSD_5_6:1.1.0.24
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.22
	OPENBSD_5_5_BASE:1.1
	OPENBSD_5_4:1.1.0.20
	OPENBSD_5_4_BASE:1.1
	OPENBSD_5_3:1.1.0.18
	OPENBSD_5_3_BASE:1.1
	OPENBSD_5_2:1.1.0.16
	OPENBSD_5_2_BASE:1.1
	OPENBSD_5_1_BASE:1.1
	OPENBSD_5_1:1.1.0.14
	OPENBSD_5_0:1.1.0.12
	OPENBSD_5_0_BASE:1.1
	OPENBSD_4_9:1.1.0.10
	OPENBSD_4_9_BASE:1.1
	OPENBSD_4_8:1.1.0.8
	OPENBSD_4_8_BASE:1.1
	OPENBSD_4_7:1.1.0.6
	OPENBSD_4_7_BASE:1.1
	OPENBSD_4_6:1.1.0.4
	OPENBSD_4_6_BASE:1.1
	OPENBSD_4_5:1.1.0.2
	OPENBSD_4_5_BASE:1.1;
locks; strict;
comment	@# @;


1.1
date	2008.11.08.17.13.08;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.1
log
@- bring in a patch from Debian to fix a SIGABRT on startup
issue noticed by todd@@
@
text
@$OpenBSD$
--- lib/wwfetch/wwfetch_image.c.orig	Wed Nov 29 04:21:14 2006
+++ lib/wwfetch/wwfetch_image.c	Sat Nov  8 18:01:51 2008
@@@@ -27,6 +27,9 @@@@
  * @@param level level of image [0..]
  */
 wwfetch_error wwfetch_fetch_image(wwfetch *handle, int x, int y, int level) {
+	if (level > 14)
+		return WWFETCH_NOT_FOUND;
+
 	int res = 1 << (level);
 
 	double x1 = (double)(x)/(double)(res) * 360.0 - 180.0;
@@@@ -36,8 +39,16 @@@@ wwfetch_error wwfetch_fetch_image(wwfetch *handle, int
 
 	/* form full url */
 	char urlbuf[1024];
-	if (snprintf(urlbuf, sizeof(urlbuf), "http://wms.jpl.nasa.gov/wms.cgi?request=GetMap&layers=global_mosaic_base&srs=EPSG:4326&width=256&height=256&bbox=%f,%f,%f,%f&format=image/jpeg&version=1.1.0&styles=", x1, y1, x2, y2) >= sizeof(urlbuf))
+	if (snprintf(urlbuf, sizeof(urlbuf), "http://wms.jpl.nasa.gov/wms.cgi?request=GetMap&layers=global_mosaic&srs=EPSG:4326&width=512&height=512&bbox=%f,%f,%f,%f&format=image/jpeg&version=1.1.0&styles=", x1, y1, x2, y2) >= sizeof(urlbuf))
 		return WWFETCH_SMALL_BUFFER;
+
+	wwfetch_error result = wwfetch_fetch(handle, urlbuf);
+	if (result == WWFETCH_OK) {
+		if (handle->currentsize < 4 || handle->currentdata[0] != 0xff ||
+		    handle->currentdata[1] != 0xd8 || handle->currentdata[2] != 0xff ||
+		    handle->currentdata[3] != 0xe0)
+			return WWFETCH_FETCH_FAILED;
+	}
 
 	return wwfetch_fetch(handle, urlbuf);
 }
@
