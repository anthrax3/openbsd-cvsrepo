head	1.5;
access;
symbols
	OPENBSD_3_1:1.4.0.2
	OPENBSD_3_1_BASE:1.4
	OPENBSD_2_8:1.2.0.2;
locks; strict;
comment	@ * @;


1.5
date	2002.07.24.01.12.32;	author brad;	state dead;
branches;
next	1.4;

1.4
date	2002.02.01.03.06.53;	author itojun;	state Exp;
branches;
next	1.3;

1.3
date	2000.12.31.19.22.57;	author brad;	state dead;
branches;
next	1.2;

1.2
date	2000.11.15.21.47.12;	author brad;	state Exp;
branches
	1.2.2.1;
next	1.1;

1.1
date	2000.11.15.15.57.04;	author brad;	state Exp;
branches;
next	;

1.2.2.1
date	2000.11.20.15.16.05;	author espie;	state Exp;
branches;
next	;


desc
@@


1.5
log
@upgrade to tcsh 6.12.00
@
text
@$OpenBSD: patch-sh.dol.c,v 1.4 2002/02/01 03:06:53 itojun Exp $

--- sh.dol.c-	Fri Feb  1 11:58:13 2002
+++ sh.dol.c	Fri Feb  1 11:58:28 2002
@@@@ -585,10 +585,8 @@@@
 		c = DgetC(0);
 	    } while (Isdigit(c));
 	    unDredc(c);
-	    if (subscr < 0) {
-		dolerror(vp->v_name);
-		return;
-	    }
+	    if (subscr < 0)
+		stderror(ERR_RANGE);
 	    if (subscr == 0) {
 		if (bitset) {
 		    dolp = dolzero ? STR1 : STR0;
@


1.4
log
@avoid SEGV on out-of-range $foo.  ok by brad
@
text
@d1 1
a1 1
$OpenBSD$
@


1.3
log
@upgrade to tcsh 6.10.00
--
From: naddy@@
@
text
@d1 17
a17 44
--- sh.dol.c.orig	Sun Nov 12 15:22:50 2000
+++ sh.dol.c	Sun Nov 12 15:27:11 2000
@@@@ -1017,7 +1017,7 @@@@
 heredoc(term)
     Char   *term;
 {
-    register int c;
+    int c;
     Char   *Dv[2];
     Char    obuf[BUFSIZE], lbuf[BUFSIZE], mbuf[BUFSIZE];
     int     ocnt, lcnt, mcnt;
@@@@ -1025,7 +1025,9 @@@@
     Char  **vp;
     bool    quoted;
     char   *tmp;
+    struct timeval tv;
 
+again:
     tmp = short2str(shtemp);
 #ifndef O_CREAT
 # define O_CREAT 0
@@@@ -1036,9 +1038,19 @@@@
 #ifndef O_TEMPORARY
 # define O_TEMPORARY 0
 #endif
-    if (open(tmp, O_RDWR|O_CREAT|O_TEMPORARY) < 0) {
-	int     oerrno = errno;
-
+#ifndef O_EXCL
+# define O_EXCL 0
+#endif
+    if (open(tmp, O_RDWR|O_CREAT|O_EXCL|O_TEMPORARY) == -1) {
+	int oerrno = errno;
+	if (errno == EEXIST) {
+	    if (unlink(tmp) == -1) {
+		(void) gettimeofday(&tv, NULL);
+		shtemp = Strspl(STRtmpsh, putn((((int)tv.tv_sec) ^ 
+		    ((int)tv.tv_usec) ^ ((int)doldol)) & 0x00ffffff));
+	    }
+	    goto again;
+	}
 	(void) unlink(tmp);
 	errno = oerrno;
 	stderror(ERR_SYSTEM, tmp, strerror(errno));
@


1.2
log
@remove RCS id in the patch.
@
text
@@


1.2.2.1
log
@Security fix
@
text
@@


1.1
log
@fix for insecure tmp file creation with the '<<' operator,
reported on BugTraq by proton <proton@@ENERGYMECH.NET>.
@
text
@a2 9
@@@@ -36,7 +36,7 @@@@
  */
 #include "sh.h"
 
-RCSID("$Id: sh.dol.c,v 3.40 2000/06/10 21:36:06 kim Exp $")
+RCSID("$Id: sh.dol.c,v 3.42 2000/10/31 16:55:52 christos Exp $")
 
 /*
  * C shell
@

