head	1.7;
access;
symbols
	OPENBSD_6_1:1.6.0.2
	OPENBSD_6_1_BASE:1.6
	OPENBSD_6_0:1.5.0.6
	OPENBSD_6_0_BASE:1.5
	OPENBSD_5_9:1.5.0.2
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.5.0.4
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.4.0.2
	OPENBSD_5_7_BASE:1.4
	OPENBSD_5_6:1.3.0.4
	OPENBSD_5_6_BASE:1.3
	OPENBSD_5_5:1.3.0.2
	OPENBSD_5_5_BASE:1.3
	OPENBSD_5_4:1.2.0.2
	OPENBSD_5_4_BASE:1.2
	OPENBSD_5_3:1.1.0.8
	OPENBSD_5_3_BASE:1.1
	OPENBSD_5_2:1.1.0.6
	OPENBSD_5_2_BASE:1.1
	OPENBSD_5_1_BASE:1.1
	OPENBSD_5_1:1.1.0.4
	OPENBSD_5_0:1.1.0.2
	OPENBSD_5_0_BASE:1.1;
locks; strict;
comment	@# @;


1.7
date	2017.04.14.19.49.06;	author schwarze;	state Exp;
branches;
next	1.6;
commitid	0IGzV8717IceDNFq;

1.6
date	2016.10.17.18.32.34;	author schwarze;	state Exp;
branches;
next	1.5;
commitid	ntJKgwFPojbFEzWP;

1.5
date	2015.04.19.15.20.43;	author schwarze;	state Exp;
branches;
next	1.4;
commitid	50Y0EBe1U4u4zC0a;

1.4
date	2014.11.06.22.15.23;	author schwarze;	state Exp;
branches;
next	1.3;
commitid	D3bBI1MjSqXufVLW;

1.3
date	2013.11.11.06.41.02;	author schwarze;	state Exp;
branches;
next	1.2;

1.2
date	2013.03.30.23.10.05;	author schwarze;	state Exp;
branches;
next	1.1;

1.1
date	2011.03.19.16.48.53;	author schwarze;	state Exp;
branches;
next	;


desc
@@


1.7
log
@Pull in four patches that i recently pushed upstream to GNU troff.
Joint work with bentley@@, all committed upstream by Carsten Kunze.

https://savannah.gnu.org/bugs/?43554 - better \*[Lq] and \*[Rq]
https://savannah.gnu.org/bugs/?43553 - typographic quotes for .%T
https://savannah.gnu.org/bugs/?50771 - punctuation after .Lk
https://savannah.gnu.org/bugs/?50789 - .Lk with more than two args
@
text
@$OpenBSD: patch-tmac_doc_tmac,v 1.6 2016/10/17 18:32:34 schwarze Exp $
chunks 1,2,4-6,8-14: Simplify .Bl -tag without -width (merged upstream).
chunk 3: Trailing -width/-offset must not pick up old args (merged upstream).
chunk 7: Always format .Pa the same way, as requested by jmc@@ (local change).
chunk 15: Use typographic quotes for .%T (merged upstream).
chunk 16: Improve .Lk with more than two arguments (merged upstream).
--- tmac/doc.tmac.orig	Tue Nov  4 09:38:35 2014
+++ tmac/doc.tmac	Fri Apr 14 21:02:49 2017
@@@@ -2990,6 +2990,7 @@@@
 .  \}
 .  el \{ .ie "\$1"-tag" \{\
 .    ds doc-list-type-stack\n[doc-list-depth] tag-list
+.    nr doc-list-indent-stack\n[doc-list-depth] 6n
 .    nr doc-list-have-indent-stack\n[doc-list-depth] 1
 .  \}
 .  el \{ .ie "\$1"-item" \{\
@@@@ -3105,7 +3106,6 @@@@
 .\" NS   doc-list-offset-stackXXX
 .\" NS   doc-num-columns
 .\" NS   doc-tag-prefix-stackXXX
-.\" NS   doc-tag-width-stackXXX
 .\" NS
 .\" NS local variables:
 .\" NS   doc-box-dBla
@@@@ -3126,7 +3126,7 @@@@
 .
 .  \" avoid a warning message in case e.g. `-offset' has no parameter
 .  nr doc-reg-dBla (\n[doc-arg-ptr] + 1)
-.  if !d doc-arg\n[doc-reg-dBla] \
+.  if (\n[doc-arg-limit] < \n[doc-reg-dBla]) \
 .    ds doc-arg\n[doc-reg-dBla]
 .
 .  nr doc-reg-dBla 1
@@@@ -3148,8 +3148,6 @@@@
 .
 .  el \{ .ie "\*[doc-arg\n[doc-arg-ptr]]"-width" \{\
 .    nr doc-arg-ptr +1
-.    ds doc-tag-width-stack\n[doc-list-depth] TagwidtH
-.
 .    ds doc-str-dBla "\*[doc-arg\n[doc-arg-ptr]]
 .    substring doc-str-dBla 0 0
 .    ie .\*[doc-str-dBla] \{\
@@@@ -3394,7 +3392,6 @@@@
 .    nr doc-list-indent-stack\n[doc-reg-dsgv]-saved \n[doc-list-indent-stack\n[doc-reg-dsgv]]
 .    nr doc-compact-list-stack\n[doc-reg-dsgv]-saved \n[doc-compact-list-stack\n[doc-reg-dsgv]]
 .    ds doc-tag-prefix-stack\n[doc-reg-dsgv]-saved "\*[doc-tag-prefix-stack\n[doc-reg-dsgv]]
-.    ds doc-tag-width-stack\n[doc-reg-dsgv]-saved "\*[doc-tag-width-stack\n[doc-reg-dsgv]]
 .    nr doc-list-offset-stack\n[doc-reg-dsgv]-saved \n[doc-list-offset-stack\n[doc-reg-dsgv]]
 .    nr doc-enum-list-count-stack\n[doc-reg-dsgv]-saved \n[doc-enum-list-count-stack\n[doc-reg-dsgv]]
 .    nr doc-reg-dsgv +1
@@@@ -3538,7 +3535,6 @@@@
 .    nr doc-list-indent-stack\n[doc-reg-drgv] \n[doc-list-indent-stack\n[doc-reg-drgv]-saved]
 .    nr doc-compact-list-stack\n[doc-reg-drgv] \n[doc-compact-list-stack\n[doc-reg-drgv]-saved]
 .    ds doc-tag-prefix-stack\n[doc-reg-drgv] "\*[doc-tag-prefix-stack\n[doc-reg-drgv]-saved]
-.    ds doc-tag-width-stack\n[doc-reg-drgv] "\*[doc-tag-width-stack\n[doc-reg-drgv]-saved]
 .    nr doc-list-offset-stack\n[doc-reg-drgv] \n[doc-list-offset-stack\n[doc-reg-drgv]-saved]
 .    nr doc-enum-list-count-stack\n[doc-reg-drgv] \n[doc-enum-list-count-stack\n[doc-reg-drgv]-saved]
 .    nr doc-reg-drgv +1
@@@@ -3765,8 +3761,6 @@@@
 .
 .        if \n[doc-in-files-section] \{\
 .          ds doc-saved-Pa-font "\*[doc-Pa-font]
-.          if n \
-.            ds doc-Pa-font "\*[doc-No-font]
 .        \}
 .
 .        ie (\n[doc-type1] == 1) \
@@@@ -4030,13 +4024,6 @@@@
 .  ev
 .  box
 .
-.  if !"TagwidtH"\*[doc-tag-width-stack\n[doc-list-depth]]" \{\
-.    if !\n[doc-list-have-indent-stack\n[doc-list-depth]] \{\
-.      in -(\n[doc-list-indent-stack\n[doc-list-depth]]u + \n[doc-digit-width]u)
-.      nr doc-list-have-indent-stack\n[doc-list-depth] 1
-.    \}
-.    doc-get-tag-width
-.  \}
 .  doc-set-vertical-and-indent 1
 .  nr doc-reg-dtl (\n[doc-list-indent-stack\n[doc-list-depth]]u + \n[doc-digit-width]u)
 .  ti -\n[doc-reg-dtl]u
@@@@ -4064,29 +4051,6 @@@@
 ..
 .
 .
-.\" NS doc-get-tag-width macro
-.\" NS   resolve unknown tag width (`tag' list-type only)
-.\" NS
-.\" NS modifies:
-.\" NS   doc-list-indent-stackXXX
-.\" NS   doc-tag-width-stackXXX
-.\" NS
-.\" NS requires:
-.\" NS   doc-curr-arg
-.\" NS   doc-curr-type
-.
-.de doc-get-tag-width
-.  ie (\n[doc-curr-type] == 1) \{\
-.    ds doc-tag-width-stack\n[doc-list-depth] \*[doc-curr-arg]
-.    nr doc-list-indent-stack\n[doc-list-depth] \n[\*[doc-curr-arg]]
-.  \}
-.  el \{\
-.    ds doc-tag-width-stack\n[doc-list-depth] No
-.    nr doc-list-indent-stack\n[doc-list-depth] \n[No]
-.  \}
-..
-.
-.
 .\" NS doc-set-vertical-and-indent macro
 .\" NS   set up vertical spacing (if not compact) and indentation (with
 .\" NS   offset if argument is non-zero)
@@@@ -4139,19 +4103,6 @@@@
 .ds doc-tag-prefix-stack1
 .
 .
-.\" NS doc-tag-width-stackXXX global string
-.\" NS   stack of strings indicating how to set up current element of
-.\" NS   doc-list-indent-stackXXX -- if set to TagwidtH, user has set it
-.\" NS   directly; if it is a macro name, use the macro's width value;
-.\" NS   otherwise, `doc-get-tag-width' uses width value of `No'.
-.\" NS
-.\" NS limit:
-.\" NS   doc-list-depth
-.
-.ds doc-tag-width-stack0
-.ds doc-tag-width-stack1
-.
-.
 .\" NS doc-list-offset-stackXXX global register
 .\" NS   stack of list offsets
 .\" NS
@@@@ -4193,7 +4144,6 @@@@
 .\" NS   doc-list-offset-stackXXX
 .\" NS   doc-list-type-stackXXX
 .\" NS   doc-tag-prefix-stackXXX
-.\" NS   doc-tag-width-stackXXX
 .\" NS   doc-enum-list-count-stackXXX
 .\" NS
 .\" NS local variables:
@@@@ -4205,7 +4155,6 @@@@
 .  nr doc-list-indent-stack\n[doc-reg-dils] 0
 .  nr doc-list-offset-stack\n[doc-reg-dils] 0
 .  ds doc-tag-prefix-stack\n[doc-reg-dils]
-.  ds doc-tag-width-stack\n[doc-reg-dils] \*[doc-tag-width-stack\n[doc-list-depth]]
 .  ds doc-list-type-stack\n[doc-reg-dils]
 .  nr doc-compact-list-stack\n[doc-reg-dils] 0
 .  nr doc-enum-list-count-stack\n[doc-reg-dils] 0
@@@@ -4222,7 +4171,6 @@@@
 .\" NS   doc-list-offset-stackXXX
 .\" NS   doc-list-type-stackXXX
 .\" NS   doc-tag-prefix-stackXXX
-.\" NS   doc-tag-width-stackXXX
 .\" NS   doc-enum-list-count-stackXXX
 .
 .de doc-decrement-list-stack
@@@@ -4231,7 +4179,6 @@@@
 .  nr doc-list-indent-stack\n[doc-list-depth] 0
 .  nr doc-list-offset-stack\n[doc-list-depth] 0
 .  ds doc-tag-prefix-stack\n[doc-list-depth]
-.  ds doc-tag-width-stack\n[doc-list-depth]
 .  nr doc-compact-list-stack\n[doc-list-depth] 0
 .  nr doc-enum-list-count-stack\n[doc-list-depth] 0
 ..
@@@@ -5296,7 +5243,7 @@@@
 .    unformat doc-reference-title-name-for-book
 .    chop doc-reference-title-name-for-book
 .    ie ((\n[doc-journal-count] == 1) : (\n[doc-book-count] == 1)) \{\
-.      nop \)\*[q]\)\*[doc-reference-title-name-for-book]\)\*[q]\c
+.      nop \)\*[Lq]\)\*[doc-reference-title-name-for-book]\)\*[Rq]\c
 .      doc-finish-reference \n[doc-reference-title-count]
 .    \}
 .    el \{\
@@@@ -6498,36 +6445,53 @@@@
 .\" NS   link (for conversion to HTML)
 .\" NS
 .\" NS local variables:
+.\" NS   doc-delim-Lk
 .\" NS   doc-reg-Lk
-.\" NS   doc-str-Lk
+.\" NS   doc-target-Lk
+.\" NS   doc-text-Lk
 .
 .de Lk
-.  ds doc-str-Lk Sy \$@@
+.  \" The first argument is the target URI.
+.  ds doc-target-Lk \$1
+.  shift
 .
-.  ie (\n[.$] > 1) \{\
-.    doc-get-arg-type \$2
-.    ie (\n[doc-arg-type] < 3) \{\
-.      Em \)\$2:
-.      ds doc-str-Lk Sy "\$1"
-.      doc-get-width "\$1"
-.      shift 2
-.      if \n[.$] \
-.        as doc-str-Lk " \$@@
+.  \" Split the remaining arguments into link text and delimiters.
+.  ds doc-text-Lk
+.  ds doc-delim-Lk
+.  while \n[.$] \{\
+.    doc-get-width "\$1"
+.    doc-get-arg-type \$1
+.    ie (\n[doc-arg-type] > 2) \
+.      as doc-delim-Lk \$1
+.    el \{\
+.      if !'\*[doc-delim-Lk]'' \{\
+.        \" More text follows delimiter(s); go back to text mode.
+.        as doc-text-Lk \*[doc-delim-Lk]
+.        ds doc-delim-Lk
+.      \}
+.      ie '\*[doc-text-Lk]'' \
+.        ds doc-text-Lk \$1
+.      el \
+.        as doc-text-Lk " \$1
 .    \}
-.    el \
-.      doc-get-width "\$1"
+.    shift
 .  \}
-.  el \
-.    doc-get-width "\$1"
 .
+.  \" Print the link text, if any.
+.  if !'\*[doc-text-Lk]'' \
+.      Em \*[doc-text-Lk] Ns :
+.
+.  \" Print the link target.
 .  ie n \
 .    nr doc-reg-Lk 26
 .  el \
 .    nr doc-reg-Lk 38
+.  doc-get-width "\*[doc-target-Lk]"
 .  ie (\n[doc-width] >= \n[doc-reg-Lk]) \
-.    D1 \*[doc-str-Lk]
-.  el \
-.    \*[doc-str-Lk]
+.    D1 Sy \*[doc-target-Lk] Ns \*[doc-delim-Lk]\&
+.  el .ie \n[doc-width] \
+.    Sy \*[doc-target-Lk] Ns \*[doc-delim-Lk]\&
+.  el \*[doc-delim-Lk]\&
 ..
 .
 .
@


1.6
log
@Pull in a patch committed upstream:
Make the behaviour of .Bl -tag without -width comprehensible
and the same as in mandoc(1).
No opposition when shown on ports@@.
@
text
@d1 1
a1 1
$OpenBSD: patch-tmac_doc_tmac,v 1.5 2015/04/19 15:20:43 schwarze Exp $
d5 2
d8 1
a8 1
+++ tmac/doc.tmac	Sun Oct  9 20:36:30 2016
d164 81
@


1.5
log
@Apply a bugfix to .Bl that i sent upstream and that got merged there.
Helps groff-mandoc comparisons, for example in mutella(1).
No opposition when shown on ports@@.
@
text
@d1 4
a4 3
$OpenBSD: patch-tmac_doc_tmac,v 1.4 2014/11/06 22:15:23 schwarze Exp $
chunk 1: Trailing -width/-offset must not pick up old args (merged upstream).
chunk 2: Always format .Pa the same way, as requested by jmc@@ (local change).
d6 17
a22 1
+++ tmac/doc.tmac	Fri Apr 17 01:03:11 2015
d32 26
a57 1
@@@@ -3765,8 +3765,6 @@@@
d66 96
@


1.4
log
@update to groff-1.22.3

new features:
* glilypond(1) - new preprocessor for music typesetting
* gperl(1) - new preprocessor for embedding Perl code in roff documents
* gpinyin(1) - new preprocessor to pretty-print Pinyin syllables
* groff_mom(7) now has full eqn(7), pic(7), and tbl(7) support
* mdoc(7) now supports the %C macro (already available in mandoc)

* various bugfixes
* many of our patches have been integrated upstream
* changing the bullet is no longer needed, mandoc can now handle it

ok sthen@@ naddy@@
@
text
@d1 14
a14 4
$OpenBSD: patch-tmac_doc_tmac,v 1.3 2013/11/11 06:41:02 schwarze Exp $
Always format .Pa the same way, as requested by jmc@@ (local change).
--- tmac/doc.tmac.orig	Sun Oct 12 23:00:09 2014
+++ tmac/doc.tmac	Sun Oct 12 23:27:06 2014
@


1.3
log
@My implementation of .%C (city) in .Rs (citation block), accepted and
committed upstream.  It already works in mandoc(1), and it is used in
some OpenBSD base system manuals, and using it is generally encouraged,
so having it in our groff port as well really makes sense.
ok bentley@@ on August 1, 2013 (and i forgot to commit after unlock, sorry)
@
text
@d1 5
a5 24
$OpenBSD: patch-tmac_doc_tmac,v 1.2 2013/03/30 23:10:05 schwarze Exp $
chunks 1,2,4-8: Implement .%C (accepted and committed upstream).
chunk 3: Always format .Pa the same way, as requested by jmc@@ (local change).
--- tmac/doc.tmac.orig	Thu Feb  7 13:06:08 2013
+++ tmac/doc.tmac	Wed Jul 24 23:24:51 2013
@@@@ -3423,6 +3423,8 @@@@
 .
 .  nr doc-book-count-saved \n[doc-book-count]
 .  ds doc-book-name-saved "\*[doc-book-name]
+.  nr doc-city-count-saved \n[doc-city-count]
+.  ds doc-city-name-saved "\*[doc-city-name]
 .  nr doc-date-count-saved \n[doc-date-count]
 .  ds doc-date-saved "\*[doc-date]
 .  nr doc-publisher-count-saved \n[doc-publisher-count]
@@@@ -3565,6 +3567,8 @@@@
 .
 .  nr doc-book-count \n[doc-book-count-saved]
 .  ds doc-book-name "\*[doc-book-name-saved]
+.  nr doc-city-count \n[doc-city-count-saved]
+.  ds doc-city-name "\*[doc-city-name-saved]
 .  nr doc-date-count \n[doc-date-count-saved]
 .  ds doc-date "\*[doc-date-saved]
 .  nr doc-publisher-count \n[doc-publisher-count-saved]
@@@@ -3759,8 +3763,6 @@@@
a13 100
@@@@ -5190,6 +5192,8 @@@@
 .\" NS   doc-author-nameXXX
 .\" NS   doc-book-count
 .\" NS   doc-book-name
+.\" NS   doc-city-count
+.\" NS   doc-city-name
 .\" NS   doc-corporate-count
 .\" NS   doc-corporate-name
 .\" NS   doc-date
@@@@ -5228,6 +5232,7 @@@@
 .  nr doc-reference-title-count 0
 .  nr doc-url-count 0
 .  nr doc-volume-count 0
+.  nr doc-city-count 0
 .  nr doc-date-count 0
 .  nr doc-page-number-count 0
 .  nr doc-book-count 0
@@@@ -5243,6 +5248,7 @@@@
 .  ds doc-reference-title-name-for-book
 .  ds doc-url-name
 .  ds doc-volume-name
+.  ds doc-city-name
 .  ds doc-date
 .  ds doc-page-number-string
 .  ds doc-book-name
@@@@ -5357,6 +5363,13 @@@@
 .    doc-finish-reference \n[doc-corporate-count]
 .  \}
 .
+.  if \n[doc-city-count] \{\
+.    unformat doc-city-name
+.    chop doc-city-name
+.    nop \*[doc-city-name]\c
+.    doc-finish-reference \n[doc-city-count]
+.  \}
+.
 .  if \n[doc-date-count] \{\
 .    unformat doc-date
 .    chop doc-date
@@@@ -5525,6 +5538,60 @@@@
 .    nop \*[doc-Em-font]\c
 .    doc-print-recursive
 .  \}
+..
+.
+.
+.\" NS doc-city-count global register
+.\" NS   counter of city references
+.
+.nr doc-city-count 0
+.
+.
+.\" NS doc-city-name global box
+.\" NS   string of collected city references
+.
+.ds doc-city-name
+.
+.
+.\" NS %C user macro
+.\" NS   [reference] city
+.\" NS
+.\" NS modifies:
+.\" NS   doc-arg-ptr
+.\" NS   doc-curr-font
+.\" NS   doc-curr-size
+.\" NS   doc-city-count
+.\" NS   doc-macro-name
+.\" NS   doc-reference-count
+.\" NS
+.\" NS local variables:
+.\" NS   doc-env-%C
+.\" NS
+.\" NS width register `%C' set in doc-common
+.
+.de %C
+.  if (\n[doc-arg-limit] : (\n[.$] == 0)) \{\
+.    tm Usage: .%C city_name ... (#\n[.c])
+.    return
+.  \}
+.
+.  nr doc-city-count +1
+.  nr doc-reference-count +1
+.
+.  ds doc-macro-name %C
+.  doc-parse-args \$@@
+.
+.  nr doc-arg-ptr +1
+.  nr doc-curr-font \n[.f]
+.  nr doc-curr-size \n[.ps]
+.
+.  \" append to reference box
+.  boxa doc-city-name
+.  ev doc-env-%C
+.  evc 0
+.  in 0
+.  nf
+.  doc-do-references
 ..
 .
 .
@


1.2
log
@Maintenance update to groff-1.22.2.
* New features: gropdf(1), pdfmom(1)
* Lots of our patches were accepted upstream, lots of upstream bug fixes.
Tested by landry@@ and pascal@@, ok landry@@ and sthen@@.
@
text
@d1 24
a24 5
$OpenBSD: patch-tmac_doc_tmac,v 1.1 2011/03/19 16:48:53 schwarze Exp $
Always format .Pa the same way, as requested by jmc@@ (local change).
--- tmac/doc.tmac.orig	Sun Dec 30 08:40:29 2012
+++ tmac/doc.tmac	Tue Jan  1 17:37:17 2013
@@@@ -3759,8 +3759,6 @@@@
d33 100
@


1.1
log
@First major OpenBSD groff update since 2000.
Lots of new functionality, lots of bug fixes, and bringing in
significant maintenance efforts from upstream.
To name just one specific example, the number of arguments mdoc(7)
macros can take is no longer limited.
Two of the more tricky patches contributed by naddy@@, thanks!
Tested in bulk builds by landry@@.
Tested on sparc (GCC 2) by phessler@@ and on alpha (GCC 3) by naddy@@.
ok naddy@@, landry@@

Before using this to build ports, make sure you install
the src/usr.sbin/pkg_add/OpenBSD/PackingElement.pm patch
i'm going to commit right afterwards as well, or you will end up
with ports manuals containing ANSI escape sequences.
@
text
@d1 5
a5 5
$OpenBSD$
# Always format Pa the same way, as requested by jmc@@.
--- tmac/doc.tmac.orig	Fri Dec 31 00:33:09 2010
+++ tmac/doc.tmac	Sat Mar 12 13:09:47 2011
@@@@ -3747,8 +3747,6 @@@@
@

