head	1.3;
access;
symbols
	OPENBSD_3_6:1.2.0.10
	OPENBSD_3_6_BASE:1.2
	OPENBSD_3_5:1.2.0.8
	OPENBSD_3_5_BASE:1.2
	OPENBSD_3_4:1.2.0.6
	OPENBSD_3_4_BASE:1.2
	OPENBSD_3_3:1.2.0.4
	OPENBSD_3_3_BASE:1.2
	OPENBSD_3_2:1.2.0.2
	OPENBSD_3_2_BASE:1.2;
locks; strict;
comment	@# @;


1.3
date	2004.12.11.04.59.46;	author pvalchev;	state dead;
branches;
next	1.2;

1.2
date	2002.09.06.06.25.31;	author pvalchev;	state Exp;
branches;
next	1.1;

1.1
date	2002.07.10.14.24.47;	author ian;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Update to pilot-link-0.11.8, remove debug flavour
From new maintainer Antoine Jacoutot <ajacoutot@@lphp.org>
@
text
@$OpenBSD: patch-unixserial_c,v 1.2 2002/09/06 06:25:31 pvalchev Exp $

--- libsock/unixserial.c.orig	Wed Jun  6 14:00:17 2001
+++ libsock/unixserial.c	Thu Sep  5 23:47:21 2002
@@@@ -156,6 +156,13 @@@@ pi_serial_open(struct pi_socket *ps, str
 
 	int i;
 
+	/* Here we need a workaround for BSD USB device used with newer
+	   Handspring devices (namely Platinum, Prism, Edge and Treo) */
+
+#define maxretries 100
+	int retries;
+	int rc;
+
 #ifndef SGTTY
 	struct termios tcn;
 #else
@@@@ -167,9 +174,20 @@@@ pi_serial_open(struct pi_socket *ps, str
 	if (!tty)
 		tty = "<Null>";
 
+	for (retries = 0 ; retries <= maxretries ; retries++ ) {
+	  if ((rc = open(tty, O_RDWR | O_NONBLOCK)) == -1) {
+	    usleep(50000);
+	  } else {
+	    ps->mac->fd = rc;
+	    break;
+	  }
+	}
+
+/* Huh? already open(2) above
 	if ((ps->mac->fd = open(tty, O_RDWR | O_NONBLOCK)) == -1) {
+*/
+	if (rc == -1)
 		return -1;	/* errno already set */
-	}
 
 	if (!isatty(ps->mac->fd)) {
 		close(ps->mac->fd);
@


1.2
log
@do not open(3) the device twice (once in the loop is enough)
unbreaks after last patch, thanks to Andreas Gunnarsson <andreas@@crt.se>
@
text
@d1 1
a1 1
$OpenBSD: patch-unixserial_c,v 1.1 2002/07/10 14:24:47 ian Exp $
@


1.1
log
@Try open multiple times to catch dynamically-attached USB connection
on uvisor, for newer Handspring devices. Patch from Bernd Sieker
<bsieker@@freenet.de>, previously added to NetBSD port.
OK maintainer.
@
text
@d1 1
a1 1
$OpenBSD$
d3 3
a5 3
--- libsock/unixserial.c.orig	Mon Aug  6 11:39:00 2001
+++ libsock/unixserial.c	Mon Aug  6 11:42:01 2001
@@@@ -156,6 +156,13 @@@@
d19 1
a19 2
@@@@ -166,6 +173,15 @@@@
 		tty = getenv("PILOTPORT");
d22 1
a22 1
+
d31 2
a32 1
 
d34 2
d37 4
@

