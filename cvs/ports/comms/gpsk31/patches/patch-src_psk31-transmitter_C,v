head	1.2;
access;
symbols
	OPENBSD_6_0:1.2.0.26
	OPENBSD_6_0_BASE:1.2
	OPENBSD_5_9:1.2.0.22
	OPENBSD_5_9_BASE:1.2
	OPENBSD_5_8:1.2.0.24
	OPENBSD_5_8_BASE:1.2
	OPENBSD_5_7:1.2.0.20
	OPENBSD_5_7_BASE:1.2
	OPENBSD_5_6:1.2.0.18
	OPENBSD_5_6_BASE:1.2
	OPENBSD_5_5:1.2.0.16
	OPENBSD_5_5_BASE:1.2
	OPENBSD_5_4:1.2.0.14
	OPENBSD_5_4_BASE:1.2
	OPENBSD_5_3:1.2.0.12
	OPENBSD_5_3_BASE:1.2
	OPENBSD_5_2:1.2.0.10
	OPENBSD_5_2_BASE:1.2
	OPENBSD_5_1_BASE:1.2
	OPENBSD_5_1:1.2.0.8
	OPENBSD_5_0:1.2.0.6
	OPENBSD_5_0_BASE:1.2
	OPENBSD_4_9:1.2.0.4
	OPENBSD_4_9_BASE:1.2
	OPENBSD_4_8:1.2.0.2
	OPENBSD_4_8_BASE:1.2
	OPENBSD_4_7:1.1.1.1.0.12
	OPENBSD_4_7_BASE:1.1.1.1
	OPENBSD_4_6:1.1.1.1.0.10
	OPENBSD_4_6_BASE:1.1.1.1
	OPENBSD_4_5:1.1.1.1.0.8
	OPENBSD_4_5_BASE:1.1.1.1
	OPENBSD_4_4:1.1.1.1.0.6
	OPENBSD_4_4_BASE:1.1.1.1
	OPENBSD_4_3:1.1.1.1.0.4
	OPENBSD_4_3_BASE:1.1.1.1
	OPENBSD_4_2:1.1.1.1.0.2
	OPENBSD_4_2_BASE:1.1.1.1
	gpsk31_20070529:1.1.1.1
	gpsk31:1.1.1;
locks; strict;
comment	@# @;


1.2
date	2010.07.01.01.57.33;	author jakemsr;	state Exp;
branches;
next	1.1;

1.1
date	2007.05.30.05.27.44;	author jason;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2007.05.30.05.27.44;	author jason;	state Exp;
branches;
next	;


desc
@@


1.2
log
@convert to sndio(7), fixing some bugs along the way with
help from ratchov@@
@
text
@$OpenBSD: patch-src_psk31-transmitter_C,v 1.1.1.1 2007/05/30 05:27:44 jason Exp $
--- src/psk31-transmitter.C.orig	Fri Aug  5 09:03:20 2005
+++ src/psk31-transmitter.C	Wed Jun 30 17:33:04 2010
@@@@ -11,8 +11,7 @@@@
 #include <errno.h>
 #include <stdio.h>
 #include <stdlib.h>
-#include <sys/soundcard.h>
-#include <sys/ioctl.h>
+#include <poll.h>
 #include "psk31-coder.h"
 #include "psk31-transmitter.h"
 #include <assert.h>
@@@@ -22,6 +21,8 @@@@ extern int full_duplex; // from psk31-main.C
 extern int chans;       // from server-main.C
 extern int bits;
 
+extern long long realpos, playpos;       // from server-main.C
+
 /* Morse code encoding table */
 /* 0=space, 1=dot; from msb to lsb; lowest 1 = end of code */
 unsigned int psk31_transmitter::cwtab[58] = 
@@@@ -432,64 +433,22 @@@@ int psk31_transmitter::processor()
 {
    static int wcnt = 0;
 
-   int res, odelay;
+   int res;
+   long long odelay;
    static int write_pending;
    static int len, buflen;
    static int  odd = 0;
    static short val, obuf[BLOCKSIZE];
-   count_info cinfo;
-   audio_buf_info ospace;
+   struct pollfd pfd;
+   int events = 0, revents, n;
 
-   // Get free space in write buffer....
-   res=ioctl(audiofd, SNDCTL_DSP_GETOSPACE, &ospace);
-   if(res)
-   {
-      if(errno==EBUSY)
-      {
-         // simplex card in read mode
-         // assume that there is enough space!
-         // (i.e. avoid check...)
-         // set odelay (this is not the real value, this
-         // echo will be too fast, but thats better than
-         // nothing...
-         odelay = 0;
-      }
-      else
-      {
-         perror("ERROR: GETOSPACE failed");
-         return TX_ERROR;
-      }
-   }
-   else
-   {
-      // ToDo: adjustable buffer limit --- a small buffer increases the
-      // possibility of buffer underruns, but reduces the delay between
-      // typing and actual transmission
-      if(ospace.fragments<ospace.fragstotal-32)
-      {
-         usleep(5000);  // avoid 100% load!
-         return TX_BUSY;
-      }
-#if 1
-      // Emulation of GETODELAY via GETOSPACE value...
-      // odelay value obtained this way might be larger than the
-      // real ODELAY by up to one fragment size....
-      odelay = (ospace.fragstotal*ospace.fragsize-ospace.bytes);
-#endif
-   }
+   n = sio_pollfd(hdl, &pfd, events);
+   res = poll(&pfd, n, 0);
+   revents = sio_revents(hdl, &pfd);
 
-#if 0
-   // Using GETODELAY..... 
-   // does not work on all (esp. older) systems... -- requires OSS!
-   res=ioctl(audiofd, SNDCTL_DSP_GETODELAY, &odelay);
-   if(res)
-   {
-      perror("ERROR: GETODELAY failed");
-      return TX_ERROR;
-   }
-#endif
-   // odelay is set above
-   ioctl(audiofd, SNDCTL_DSP_GETOPTR, &cinfo);
+   odelay = 0;
+   if (playpos > realpos)
+      odelay = playpos - realpos;
 
    if(!write_pending)
    {
@@@@ -515,7 +474,7 @@@@ int psk31_transmitter::processor()
          }
          if(echo_char)
          {
-            add_echo_char(echo_char, cinfo.bytes+odelay+len*sizeof(short));
+            add_echo_char(echo_char, playpos+len*sizeof(short));
             echo_char=0;
          }
 
@@@@ -568,32 +527,20 @@@@ int psk31_transmitter::processor()
       }
    }
 
-   res=write(audiofd, &obuf, len*sizeof(short));
+   res=sio_write(hdl, &obuf, len*sizeof(short));
+   playpos += res;
 
    if(res>0)
       wcnt+=res;
 
    if(res!=(int)(len*sizeof(short)))
    {
-      if(res<0 && (errno==EINTR||errno==EAGAIN))
-      {
-         write_pending=1; return TX_BUSY;
-      }
-      if(res==0 || (res<0 && (errno==EBUSY)))
-      {
-         write_pending=1; return TX_BUSY;
-      }
-      if(res<0)
-      {
-         fprintf(stderr,"tx: write error... res=%d\n",res);
-         return TX_ERROR;
-      }
       fprintf(stderr,"tx: partial write (%d/%d)...\n",
               res,BLOCKSIZE*sizeof(short));
       return TX_ERROR;
    }
    write_pending=0;
-   res = get_echo_char( cinfo.bytes );
+   res = get_echo_char( realpos );
 
 #if 0
    if(res!=TX_BUSY)
@


1.1
log
@Initial revision
@
text
@d1 4
a4 4
$OpenBSD$
--- src/psk31-transmitter.C.orig	Tue May 29 22:56:14 2007
+++ src/psk31-transmitter.C	Tue May 29 22:56:29 2007
@@@@ -11,7 +11,7 @@@@
d9 2
a10 2
+#include <soundcard.h>
 #include <sys/ioctl.h>
d13 130
@


1.1.1.1
log
@add port for gpsk31: PSK31 sender/receiver using GTK.  Transmit
sounds right, but I can't easily test receive until I get home.
@
text
@@
