head	1.3;
access;
symbols
	OPENBSD_6_0:1.3.0.2
	OPENBSD_6_0_BASE:1.3
	OPENBSD_5_9:1.2.0.6
	OPENBSD_5_9_BASE:1.2
	OPENBSD_5_8:1.2.0.8
	OPENBSD_5_8_BASE:1.2
	OPENBSD_5_7:1.2.0.4
	OPENBSD_5_7_BASE:1.2
	OPENBSD_5_6:1.2.0.2
	OPENBSD_5_6_BASE:1.2
	OPENBSD_5_5:1.1.0.12
	OPENBSD_5_5_BASE:1.1
	OPENBSD_5_4:1.1.0.10
	OPENBSD_5_4_BASE:1.1
	OPENBSD_5_3:1.1.0.8
	OPENBSD_5_3_BASE:1.1
	OPENBSD_5_2:1.1.0.6
	OPENBSD_5_2_BASE:1.1
	OPENBSD_5_1_BASE:1.1
	OPENBSD_5_1:1.1.0.4
	OPENBSD_5_0:1.1.0.2
	OPENBSD_5_0_BASE:1.1;
locks; strict;
comment	@# @;


1.3
date	2016.06.28.14.06.59;	author kettenis;	state Exp;
branches;
next	1.2;
commitid	dfzmNVHtfKhA2DVt;

1.2
date	2014.03.30.18.15.43;	author landry;	state Exp;
branches;
next	1.1;

1.1
date	2011.07.08.09.41.46;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Make this build (and work) again on hppa and powerpc.

ok jca@@
@
text
@$OpenBSD: patch-src_unexelf_c,v 1.2 2014/03/30 18:15:43 landry Exp $
--- src/unexelf.c.orig	Tue Oct 15 16:21:44 2002
+++ src/unexelf.c	Mon Jun 27 23:19:45 2016
@@@@ -460,7 +460,7 @@@@ extern void fatal (char *, ...);
 #define MAP_FAILED ((void *) -1)
 #endif
 
-#if defined (__alpha__) && !defined (__NetBSD__) && !defined (__OpenBSD__)
+#if defined (__alpha__) && !defined (__NetBSD__)
 /* Declare COFF debugging symbol table.  This used to be in
    /usr/include/sym.h, but this file is no longer included in Red Hat
    5.0 and presumably in any other glibc 2.x based distribution.  */
@@@@ -549,10 +549,12 @@@@ typedef struct {
 # else
 #  define ElfBitsW(bits, type) Elf/**/bits/**/_/**/type
 # endif
-# ifdef _LP64
-#  define ELFSIZE 64
-# else
-#  define ELFSIZE 32
+# ifndef __OpenBSD__
+#  ifdef _LP64
+#   define ELFSIZE 64
+#  else
+#   define ELFSIZE 32
+#  endif
 # endif
   /* This macro expands `bits' before invoking ElfBitsW.  */
 # define ElfExpandBitsW(bits, type) ElfBitsW (bits, type)
@@@@ -753,10 +755,12 @@@@ unexec (new_name, old_name, data_start, bss_start, ent
   old_bss_index = find_section (".bss", old_section_names,
 				old_name, old_file_h, old_section_h, 0);
 
+#ifndef __powerpc__
   old_sbss_index = find_section (".sbss", old_section_names,
 				 old_name, old_file_h, old_section_h, 1);
   if (old_sbss_index != -1)
     if (OLD_SECTION_H (old_sbss_index).sh_type == SHT_PROGBITS)
+#endif
       old_sbss_index = -1;
 
   if (old_sbss_index == -1)
@@@@ -786,8 +790,16 @@@@ unexec (new_name, old_name, data_start, bss_start, ent
 #endif
   new_data2_addr = old_bss_addr;
   new_data2_size = new_bss_addr - old_bss_addr;
+#if defined (__hppa__) || defined (__powerpc__)
+  new_data2_offset  = OLD_SECTION_H (old_bss_index).sh_offset +
+    (new_data2_addr - OLD_SECTION_H (old_bss_index).sh_addr);
+  new_data2_offset =
+    round_up (new_data2_offset,
+	      OLD_SECTION_H (old_bss_index).sh_addralign);
+#else
   new_data2_offset  = OLD_SECTION_H (old_data_index).sh_offset +
     (new_data2_addr - OLD_SECTION_H (old_data_index).sh_addr);
+#endif
 
 #ifdef DEBUG
   fprintf (stderr, "old_bss_index %d\n", old_bss_index);
@@@@ -891,6 +903,9 @@@@ unexec (new_name, old_name, data_start, bss_start, ent
 
   /* Make sure that the size includes any padding before the old .bss
      section.  */
+#if defined (__hppa__) || defined (__powerpc__)
+  NEW_PROGRAM_H (n).p_offset = new_data2_offset;
+#endif
   NEW_PROGRAM_H (n).p_filesz = new_bss_addr - NEW_PROGRAM_H (n).p_vaddr;
   NEW_PROGRAM_H (n).p_memsz = NEW_PROGRAM_H (n).p_filesz;
 
@


1.2
log
@Fix build on alpha after sys/exec_ecoff.h removal 5 months ago.
Use the provided HDRR struct instead of #defining it to struct ecoff_symhdr
with hints from kettenis@@
@
text
@d1 3
a3 3
$OpenBSD: patch-src_unexelf_c,v 1.1 2011/07/08 09:41:46 jasper Exp $
--- src/unexelf.c.orig	Tue Oct 15 08:21:44 2002
+++ src/unexelf.c	Sun Mar 30 11:10:05 2014
d30 40
@


1.1
log
@- fix patch names
- add missing rcs ids
@
text
@d1 6
a6 4
$OpenBSD$
--- src/unexelf.c.orig	Tue Oct 15 16:21:44 2002
+++ src/unexelf.c	Fri Jul  8 11:37:20 2011
@@@@ -537,7 +537,12 @@@@ typedef struct {
d8 6
a13 13
 #ifdef __OpenBSD__
 # include <sys/exec_elf.h>
-#endif
+# ifdef __alpha__
+#  include <sys/exec_ecoff.h>
+#  define HDRR		struct ecoff_symhdr
+#  define pHDRR		HDRR *
+# endif /* __alpha__ */
+#endif /* __OpenBSD__ */
 
 #if __GNU_LIBRARY__ - 0 >= 6
 # include <link.h>	/* get ElfW etc */
@@@@ -549,10 +554,12 @@@@ typedef struct {
@

