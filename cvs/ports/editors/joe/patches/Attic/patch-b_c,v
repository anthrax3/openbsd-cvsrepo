head	1.3;
access;
symbols
	OPENBSD_4_1:1.2.0.8
	OPENBSD_4_1_BASE:1.2
	OPENBSD_4_0:1.2.0.6
	OPENBSD_4_0_BASE:1.2
	OPENBSD_3_9:1.2.0.4
	OPENBSD_3_9_BASE:1.2
	OPENBSD_3_8:1.2.0.2
	OPENBSD_3_8_BASE:1.2
	OPENBSD_3_7:1.1.0.12
	OPENBSD_3_7_BASE:1.1
	OPENBSD_3_6:1.1.0.10
	OPENBSD_3_6_BASE:1.1
	OPENBSD_3_5:1.1.0.8
	OPENBSD_3_5_BASE:1.1
	OPENBSD_3_4:1.1.0.6
	OPENBSD_3_4_BASE:1.1
	OPENBSD_3_3:1.1.0.4
	OPENBSD_3_3_BASE:1.1
	OPENBSD_3_2:1.1.0.2
	OPENBSD_3_2_BASE:1.1;
locks; strict;
comment	@# @;


1.3
date	2007.03.17.22.13.08;	author martynas;	state dead;
branches;
next	1.2;

1.2
date	2005.05.24.20.27.49;	author naddy;	state Exp;
branches;
next	1.1;

1.1
date	2002.04.24.11.05.06;	author form;	state Exp;
branches;
next	;


desc
@@


1.3
log
@- update to joe 3.5;
- cleanup from naddy@@;
ok naddy@@, simon@@, kili@@, jasper@@
@
text
@$OpenBSD: patch-b_c,v 1.2 2005/05/24 20:27:49 naddy Exp $
--- b.c.orig	Sat May 21 21:49:04 2005
+++ b.c	Sat May 21 21:52:29 2005
@@@@ -196,6 +196,7 @@@@ static B *bmkchn(H *chn, B *prop, long a
 	else
 		b->o = pdefault;
 	mset(b->marks, 0, sizeof(b->marks));
+	b->filehandle = -1;
 	b->rdonly = 0;
 	b->orphan = 0;
 	b->oldcur = NULL;
@@@@ -255,6 +256,8 @@@@ extern B *errbuf;
 void brm(B *b)
 {
 	if (b && !--b->count) {
+		if (b->filehandle != -1)
+			close (b->filehandle);
 		if (b->changed)
 			abrerr(b->name);
 		if (b->locked && !b->ignored_lock && plain_file(b))
@@@@ -2119,7 +2122,7 @@@@ B *bload(unsigned char *s)
 	B *b;
 	long skip, amnt;
 	unsigned char *n;
-	int nowrite = 0;
+	int nowrite = 0, fh = -1;
 	P *p;
 	int x;
 	long mod_time = 0;
@@@@ -2172,6 +2175,12 @@@@ B *bload(unsigned char *s)
 		setopt(b,n);
 		b->rdonly = b->o.readonly;
 		goto opnerr;
+	}
+
+	/* Lock the file &&& ob,petef */
+	if (fi && !nowrite) {
+		fh = dup(fileno(fi));
+		nowrite = (flock (fh, LOCK_EX | LOCK_NB));
 	}
 
 	/* Skip data if we need to */
@


1.2
log
@update to 3.3, several years worth of changes; from mpech@@
@
text
@d1 1
a1 1
$OpenBSD$
@


1.1
log
@Upgrade to 2.9.8.1
Set MAINTAINER.
@
text
@d2 3
a4 3
--- b.c.orig	Mon Dec 10 22:48:53 2001
+++ b.c	Tue Apr  9 19:18:31 2002
@@@@ -185,6 +185,7 @@@@ static B *bmkchn(H *chn, B *prop, long a
d8 1
a8 1
+	b->filehandle = -1; /* initialize filehande &&& ob */
d11 2
a12 2
 	b->oldcur = 0;
@@@@ -237,6 +238,10 @@@@ extern B *errbuf;
d16 1
a16 2
+		if (b->filehandle != -1) {
+			/* close filehandle, free lock &&& ob */
a17 1
+		}
d20 2
a21 2
 		if (b == errbuf)
@@@@ -1791,7 +1796,7 @@@@ B *bload(char *s)
d24 1
a24 1
 	char *n;
d27 6
a32 4
 
 	if (!s || !s[0]) {
 		error = -1;
@@@@ -1838,6 +1843,12 @@@@ B *bload(char *s)
d34 2
a35 2
 	}
 
d38 1
a38 1
+		fh = dup( fileno(fi) );
d40 2
a41 2
+	}
+
a42 11
 	if (skip && lseek(fileno(fi), skip, 0) < 0) {
 		int r;
@@@@ -1893,6 +1904,8 @@@@ B *bload(char *s)
 	vsrm(n);
 
 	b->er = error;
+	if (fh != -1)
+		b->filehandle = fh;
 	return b;
 }
 
@

