head	1.3;
access;
symbols
	OPENBSD_5_4:1.1.0.2
	OPENBSD_5_4_BASE:1.1;
locks; strict;
comment	@# @;


1.3
date	2013.11.20.03.43.05;	author bentley;	state dead;
branches;
next	1.2;

1.2
date	2013.10.28.08.53.52;	author bentley;	state Exp;
branches;
next	1.1;

1.1
date	2013.05.21.17.47.37;	author bentley;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Update to nvi-2.1.2.
@
text
@$OpenBSD: patch-vi_v_txt_c,v 1.2 2013/10/28 08:53:52 bentley Exp $

Fix incorrect wide buffer length.
From upstream;
https://github.com/lichray/nvi2/commit/849414e20b488de402157d415cdc8ba598b0e7f2

Fix out of bounds buffer access.
Original commit message in base nvi by millert@@:

When ^W (WERASE) is hit in insert mode it's possible that the line
buffer is accessed out of bounds. If 'max' == 0 and 'tp->cno' == 1
the 'tp->cno' value is first reduced by one and then 'tp->lb' is
accessed at 'tp->cno' - 1.  Also remove dead (and incorrect) code
in the TXT_ALTWERASE case.  From Arto Jonsson; OK martynas@@

--- vi/v_txt.c.orig	Sun Oct  7 08:15:31 2012
+++ vi/v_txt.c	Sat Oct 26 00:31:49 2013
@@@@ -295,7 +295,8 @@@@ v_txt(
 	tiqh = sp->tiq;
 	if (!TAILQ_EMPTY(tiqh)) {
 		tp = TAILQ_FIRST(tiqh);
-		if (TAILQ_NEXT(tp, q) != NULL || tp->lb_len < len + 32) {
+		if (TAILQ_NEXT(tp, q) != NULL ||
+		    tp->lb_len < (len + 32) * sizeof(CHAR_T)) {
 			text_lfree(tiqh);
 			goto newtp;
 		}
@@@@ -1106,12 +1107,12 @@@@ leftmargin:		tp->lb[tp->cno - 1] = ' ';
 		 */
 		if (LF_ISSET(TXT_TTYWERASE))
 			while (tp->cno > max) {
+				if (ISBLANK(tp->lb[tp->cno - 1]))
+					break;
 				--tp->cno;
 				++tp->owrite;
 				if (FL_ISSET(is_flags, IS_RUNNING))
 					tp->lb[tp->cno] = ' ';
-				if (ISBLANK(tp->lb[tp->cno - 1]))
-					break;
 			}
 		else {
 			if (LF_ISSET(TXT_ALTWERASE)) {
@@@@ -1119,19 +1120,17 @@@@ leftmargin:		tp->lb[tp->cno - 1] = ' ';
 				++tp->owrite;
 				if (FL_ISSET(is_flags, IS_RUNNING))
 					tp->lb[tp->cno] = ' ';
-				if (ISBLANK(tp->lb[tp->cno - 1]))
-					break;
 			}
 			if (tp->cno > max)
 				tmp = inword(tp->lb[tp->cno - 1]);
 			while (tp->cno > max) {
+				if (tmp != inword(tp->lb[tp->cno - 1])
+				    || ISBLANK(tp->lb[tp->cno - 1]))
+					break;
 				--tp->cno;
 				++tp->owrite;
 				if (FL_ISSET(is_flags, IS_RUNNING))
 					tp->lb[tp->cno] = ' ';
-				if (tmp != inword(tp->lb[tp->cno - 1])
-				    || ISBLANK(tp->lb[tp->cno - 1]))
-					break;
 			}
 		}
 
@


1.2
log
@Fix crash. Take maintainership.

ok naddy@@ (previous MAINTAINER)
@
text
@d1 1
a1 1
$OpenBSD: patch-vi_v_txt_c,v 1.1 2013/05/21 17:47:37 bentley Exp $
@


1.1
log
@Fix out of bounds buffer access.

From millert@@'s recent commit to base nvi.

ok naddy@@ (MAINTAINER)
@
text
@d1 5
a5 1
$OpenBSD$
d17 12
a28 2
+++ vi/v_txt.c	Sun May 19 17:37:48 2013
@@@@ -1106,12 +1106,12 @@@@ leftmargin:		tp->lb[tp->cno - 1] = ' ';
d43 1
a43 1
@@@@ -1119,19 +1119,17 @@@@ leftmargin:		tp->lb[tp->cno - 1] = ' ';
@

