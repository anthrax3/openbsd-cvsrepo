head	1.1;
access;
symbols
	OPENBSD_6_0:1.1.0.64
	OPENBSD_6_0_BASE:1.1
	OPENBSD_5_9:1.1.0.60
	OPENBSD_5_9_BASE:1.1
	OPENBSD_5_8:1.1.0.62
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.58
	OPENBSD_5_7_BASE:1.1
	OPENBSD_5_6:1.1.0.56
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.54
	OPENBSD_5_5_BASE:1.1
	OPENBSD_5_4:1.1.0.52
	OPENBSD_5_4_BASE:1.1
	OPENBSD_5_3:1.1.0.50
	OPENBSD_5_3_BASE:1.1
	OPENBSD_5_2:1.1.0.48
	OPENBSD_5_2_BASE:1.1
	OPENBSD_5_1_BASE:1.1
	OPENBSD_5_1:1.1.0.46
	OPENBSD_5_0:1.1.0.44
	OPENBSD_5_0_BASE:1.1
	OPENBSD_4_9:1.1.0.42
	OPENBSD_4_9_BASE:1.1
	OPENBSD_4_8:1.1.0.40
	OPENBSD_4_8_BASE:1.1
	OPENBSD_4_7:1.1.0.38
	OPENBSD_4_7_BASE:1.1
	OPENBSD_4_6:1.1.0.36
	OPENBSD_4_6_BASE:1.1
	OPENBSD_4_5:1.1.0.34
	OPENBSD_4_5_BASE:1.1
	OPENBSD_4_4:1.1.0.32
	OPENBSD_4_4_BASE:1.1
	OPENBSD_4_3:1.1.0.30
	OPENBSD_4_3_BASE:1.1
	OPENBSD_4_2:1.1.0.28
	OPENBSD_4_2_BASE:1.1
	OPENBSD_4_1:1.1.0.26
	OPENBSD_4_1_BASE:1.1
	OPENBSD_4_0:1.1.0.24
	OPENBSD_4_0_BASE:1.1
	OPENBSD_3_9:1.1.0.22
	OPENBSD_3_9_BASE:1.1
	OPENBSD_3_8:1.1.0.20
	OPENBSD_3_8_BASE:1.1
	OPENBSD_3_7:1.1.0.18
	OPENBSD_3_7_BASE:1.1
	OPENBSD_3_6:1.1.0.16
	OPENBSD_3_6_BASE:1.1
	OPENBSD_3_5:1.1.0.14
	OPENBSD_3_5_BASE:1.1
	OPENBSD_3_4:1.1.0.12
	OPENBSD_3_4_BASE:1.1
	OPENBSD_3_3:1.1.0.10
	OPENBSD_3_3_BASE:1.1
	OPENBSD_3_2:1.1.0.8
	OPENBSD_3_2_BASE:1.1
	OPENBSD_3_1:1.1.0.6
	OPENBSD_3_1_BASE:1.1
	OPENBSD_3_0:1.1.0.4
	OPENBSD_3_0_BASE:1.1
	OPENBSD_2_9_TRACKING_SWITCH:1.1
	OPENBSD_2_9:1.1.0.2
	OPENBSD_2_9_BASE:1.1;
locks; strict;
comment	@# @;


1.1
date	2001.04.07.21.45.09;	author naddy;	state Exp;
branches;
next	;


desc
@@


1.1
log
@- fix extract
- make a proper patch
- integrate COMMENT
- clean-up
@
text
@$OpenBSD$
--- aub.orig	Sat Apr  7 23:07:34 2001
+++ aub	Sat Apr  7 23:11:14 2001
@@@@ -1,4 +1,4 @@@@
-#/usr/local/bin/perl
+#!/usr/bin/perl
 #
 #
 #
@@@@ -35,9 +35,11 @@@@
 #				    in the standard place.
 
 $ECHO = "/bin/echo"; &find_pg("echo", 0) unless (-x $ECHO);
-$SUM = "/bin/sum";   &find_pg("sum", 0)  unless (-x $SUM);
+$SUM = "/usr/bin/sum";   &find_pg("sum", 0)  unless (-x $SUM);
 $CAT = "/bin/cat";   &find_pg("cat", 0)  unless (-x $CAT);
 $MV = "/bin/mv";     &find_pg("mv", 0)   unless (-x $MV);
+$HOSTNAME = "/bin/hostname"; $HOSTNAME = &find_pg("hostname", 0) unless
+  (-x $HOSTNAME);
 
 # CONSTANTS: 	most likely you want to leave these alone.  
 #
@@@@ -111,7 +113,7 @@@@ $aub_config 	    = join("/", $ENV{"HOME"
 $timeout_interval   = 60;
 $version	    = "2.0.5";
 $last_version	    = "1.1";
-$temp_decode_file   = "/usr/tmp/aub.decode$$";
+$temp_decode_file   = "/var/tmp/aub.decode$$";
 $nntpserver_file    = "/usr/local/lib/rn/nntpserver";
 $obsolete_init	    = join("/", $ENV{"HOME"}, ".aubinit");
 
@@@@ -149,6 +151,12 @@@@ $obsolete_init	    = join("/", $ENV{"HOM
 # v2.1 will be bug fixes for v2.0.)
 #
 
+# Modified the 7th of december 1994 by Laurent VALLEE
+# in purpose of compatibility with Perl 5 :
+#
+# load the socket library to connect the server in NNTP mode
+BEGIN { require "Socket.pm"; import Socket; }
+
 (&Getopts("cd:nCMm")) || (exit(1));
 
 &long_manual if ($opt_M);			# None of these subroutines
@@@@ -198,15 +206,21 @@@@ if ($spooldir) {
          "environment variable\nor specify an NNTP server or disk based " .
          "news access in your configuration file.") unless ($server);
 
-  if ($opt_d > 1) {
-    print "Searching library directories:";
-    foreach $libr (@@INC) {
-      print " $libr";
-    }
-    print " for sys/socket.ph...\n";
-  } 
+# Modified the 7th of december 1994 by Laurent VALLEE
+# in purpose of compatibility with Perl 5 :
+#
+# no need to load the socket library because it has already been done
+# at the beginning of the script. So comment the lines...
+
+#  if ($opt_d > 1) {
+#    print "Searching library directories:";
+#    foreach $libr (@@INC) {
+#      print " $libr";
+#    }
+#    print " for sys/socket.ph...\n";
+#  } 
 
-  &need_to_run_h2ph unless (eval("require <sys/socket.ph>"));
+#  &need_to_run_h2ph unless (eval("require <sys/socket.ph>"));
 
   print "Using NNTP-based news access; server is $server\n"
     if ($opt_d);
@@@@ -929,9 +943,16 @@@@ sub get_nntp_header {
   local($sock) = pop(@@_);
   local($line) = &getline($sock);
 
+  if ($line =~ m/INN/) {                        # This code by mwe@@dfw.net,
+    &putline($sock, "mode reader");             #  looks pretty good to me.
+    &getline($sock);                            #   -mfs, 2/95.
+  }
+
   return if (($line =~ m/^200\s/) || ($line =~ m/^201\s/));
+  &abort("Remote nntp service is too busy to talk to us now.")
+    if ($line =~ m/^400\s/);
   &abort("Remote nntp service doesn't look like nntp service to me.");
-} 
+}
 
 
 sub setup_socket_io {
@@@@ -1022,7 +1043,7 @@@@ sub connect_tcp {
   local($protocol) = "tcp";
   local($thishost, $problem, $junk);
 
-  $thishost = `hostname`; chop $thishost;
+  $thishost = `$HOSTNAME`; chop $thishost;
 
 # Figure out our address...
   ($name, $junk, $junk, $junk, $ouraddr) = gethostbyname($thishost);
@@@@ -1875,6 +1896,12 @@@@ EOF
 }
 
 
+# Modified the 7th of december 1994 by Laurent VALLEE
+# in purpose of compatibility with Perl 5 :
+#
+# in strings, "@@" must be preceded by a "\". So the mail adresses
+# must be modified.
+
 sub long_manual {
 #
 #
@@@@ -2463,8 +2490,8 @@@@ by the program.
 
 
 						Mark Stantz
-						stantz@@sierra.stanford.edu
-						stantz@@sgi.com
+						stantz\@@sierra.stanford.edu
+						stantz\@@sgi.com
 						8/92
 
 EOF
@@@@ -2482,7 +2509,12 @@@@ sub tribute {
 # This has some (not much) value as a debugging aid.
 #
 
-&abort("", &process_line(join('&',"82G5S=\"!A;F]T:","5R('!E<FP@@:","%C:V5R"),4))
+# Modified the 7th of december 1994 by Laurent VALLEE
+# in purpose of compatibility with Perl 5 :
+#
+# in strings, "@@" must be preceded by a "\". So modify the expression.
+
+&abort("", &process_line(join('&',"82G5S=\"!A;F]T:","5R('!E<FP\@@:","%C:V5R"),4))
   if (open(DECODE, ">&STDOUT"));
 }
 
@@@@ -2510,4 +2542,5 @@@@ sub debug_parser {
   print "spool $spooldir\nnntp $server\n";
   print "debug $opt_d xhdr $have_gotten_subj_line_before\n";
 }
+
 
@
