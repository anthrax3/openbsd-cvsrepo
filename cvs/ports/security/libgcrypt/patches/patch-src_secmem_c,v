head	1.4;
access;
symbols
	OPENBSD_6_2:1.4.0.2
	OPENBSD_6_2_BASE:1.4
	OPENBSD_6_1:1.3.0.2
	OPENBSD_6_1_BASE:1.3
	OPENBSD_6_0:1.2.0.2
	OPENBSD_6_0_BASE:1.2
	OPENBSD_5_9:1.1.0.6
	OPENBSD_5_9_BASE:1.1
	OPENBSD_5_8:1.1.0.8
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.4
	OPENBSD_5_7_BASE:1.1
	OPENBSD_5_6:1.1.0.2
	OPENBSD_5_6_BASE:1.1;
locks; strict;
comment	@# @;


1.4
date	2017.07.20.06.16.00;	author ajacoutot;	state Exp;
branches;
next	1.3;
commitid	HURKthLn9Sle1s9h;

1.3
date	2016.12.10.07.24.45;	author ajacoutot;	state Exp;
branches;
next	1.2;
commitid	5eCZ9RG2Pa3GXHN1;

1.2
date	2016.04.24.21.40.25;	author ajacoutot;	state Exp;
branches;
next	1.1;
commitid	IApX2gZ944X0wSYD;

1.1
date	2014.03.09.20.02.37;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Update to libgcrypt-1.8.0.
@
text
@$OpenBSD: patch-src_secmem_c,v 1.3 2016/12/10 07:24:45 ajacoutot Exp $

Our swap is encrypted by default
(synced with gnupg/patches/patch-util_secmem_c)

Index: src/secmem.c
--- src/secmem.c.orig
+++ src/secmem.c
@@@@ -36,6 +36,10 @@@@
 #include <sys/capability.h>
 #endif
 #endif
+#include <sys/param.h>
+#include <sys/sysctl.h>
+#include <sys/proc.h>
+#include <uvm/uvm_swap_encrypt.h>
 
 #include "g10lib.h"
 #include "secmem.h"
@@@@ -247,8 +251,24 @@@@ mb_get_new (pooldesc_t *pool, memblock_t *block, size_
 static void
 print_warn (void)
 {
-  if (!no_warning)
-    log_info (_("Warning: using insecure memory!\n"));
+	int    mib[3], swapencrypt = 0;
+	size_t len;
+
+	mib[0] = CTL_VM;
+	mib[1] = VM_SWAPENCRYPT;
+	mib[2] = SWPENC_ENABLE;
+
+	len = sizeof(swapencrypt);
+
+	if (sysctl(mib, 3, &swapencrypt, &len, NULL, 0) == -1)
+		log_info("WARNING: Can't receive vm.swapencrypt.enable sysctl value\n");
+
+	if (!no_warning && !swapencrypt)
+	{
+		log_info("WARNING: Using insecure memory!\n");
+		log_info("Please enable swap encryption via"
+			 " 'sysctl vm.swapencrypt.enable=1'.\n");
+	}
 }
 
 
@


1.3
log
@Update to libgcrypt-1.7.4.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_secmem_c,v 1.2 2016/04/24 21:40:25 ajacoutot Exp $
d3 2
a4 1
Patch copied from gnupg/patches/patch-util_secmem_c
d6 4
a9 3
--- src/secmem.c.orig	Fri Dec  9 15:25:37 2016
+++ src/secmem.c	Sat Dec 10 08:20:22 2016
@@@@ -36,6 +36,9 @@@@
d15 1
d20 1
a20 1
@@@@ -247,8 +250,24 @@@@ mb_get_new (pooldesc_t *pool, memblock_t *block, size_
@


1.2
log
@Update to libgcrypt-1.7.0.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_secmem_c,v 1.1 2014/03/09 20:02:37 jasper Exp $
d5 2
a6 2
--- src/secmem.c.orig	Wed Mar 23 12:59:34 2016
+++ src/secmem.c	Sat Apr 23 08:36:27 2016
d17 1
a17 1
@@@@ -231,8 +234,24 @@@@ mb_get_new (memblock_t *block, size_t size)
d43 1
a43 1
 /* Lock the memory pages into core and drop privileges.  */
@


1.1
log
@add patch from gnupg to silence the "using insecure memory" warning
when swap is encrypted.
@
text
@d1 1
a1 1
$OpenBSD$
d5 2
a6 2
--- src/secmem.c.orig	Wed Jan 29 10:48:38 2014
+++ src/secmem.c	Sat Feb 22 13:48:07 2014
a14 1
 #include "ath.h"
d16 2
a17 1
@@@@ -232,8 +235,24 @@@@ mb_get_new (memblock_t *block, size_t size)
@

