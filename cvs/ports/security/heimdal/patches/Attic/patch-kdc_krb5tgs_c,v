head	1.1;
access;
symbols
	OPENBSD_6_1:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2017.04.14.07.55.09;	author ajacoutot;	state dead;
branches
	1.1.2.1;
next	;
commitid	Mjwjo1BKfoGCCiq6;

1.1.2.1
date	2017.04.14.07.55.09;	author ajacoutot;	state Exp;
branches;
next	;
commitid	Mjwjo1BKfoGCCiq6;


desc
@@


1.1
log
@file patch-kdc_krb5tgs_c was initially added on branch OPENBSD_6_1.
@
text
@@


1.1.2.1
log
@Fix transit path validation CVE-2017-6594.
@
text
@a0 57
$OpenBSD$

From d7bf245e793a9f9ec565e07dae9372597c0ece69 Mon Sep 17 00:00:00 2001
From: Viktor Dukhovni <viktor@@twosigma.com>
Date: Wed, 10 Aug 2016 23:31:14 +0000
Subject: [PATCH] Fix transit path validation CVE-2017-6594

--- kdc/krb5tgs.c.orig	Tue Nov 29 02:35:27 2016
+++ kdc/krb5tgs.c	Fri Apr 14 09:43:11 2017
@@@@ -655,8 +655,12 @@@@ fix_transited_encoding(krb5_context context,
 		  "Decoding transited encoding");
 	return ret;
     }
+
+    /*
+     * If the realm of the presented tgt is neither the client nor the server
+     * realm, it is a transit realm and must be added to transited set.
+     */
     if(strcmp(client_realm, tgt_realm) && strcmp(server_realm, tgt_realm)) {
-	/* not us, so add the previous realm to transited set */
 	if (num_realms + 1 > UINT_MAX/sizeof(*realms)) {
 	    ret = ERANGE;
 	    goto free_realms;
@@@@ -737,6 +741,7 @@@@ tgs_make_reply(krb5_context context,
 	       const char *server_name,
 	       hdb_entry_ex *client,
 	       krb5_principal client_principal,
+               const char *tgt_realm,
 	       hdb_entry_ex *krbtgt,
 	       krb5_enctype krbtgt_etype,
 	       krb5_principals spp,
@@@@ -798,7 +803,7 @@@@ tgs_make_reply(krb5_context context,
 				 &tgt->transited, &et,
 				 krb5_principal_get_realm(context, client_principal),
 				 krb5_principal_get_realm(context, server->entry.principal),
-				 krb5_principal_get_realm(context, krbtgt->entry.principal));
+				 tgt_realm);
     if(ret)
 	goto out;
 
@@@@ -1519,6 +1524,8 @@@@ tgs_build_reply(krb5_context context,
     krb5_keyblock sessionkey;
     krb5_kvno kvno;
     krb5_data rspac;
+    const char *tgt_realm = /* Realm of TGT issuer */
+        krb5_principal_get_realm(context, krbtgt->entry.principal);
     const char *our_realm = /* Realm of this KDC */
         krb5_principal_get_comp_string(context, krbtgt->entry.principal, 1);
     char **capath = NULL;
@@@@ -2324,6 +2331,7 @@@@ server_lookup:
 			 spn,
 			 client,
 			 cp,
+                         tgt_realm,
 			 krbtgt_out,
 			 tkey_sign->key.keytype,
 			 spp,
@

