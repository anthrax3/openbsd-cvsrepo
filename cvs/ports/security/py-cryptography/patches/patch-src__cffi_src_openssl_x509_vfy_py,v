head	1.3;
access;
symbols
	OPENBSD_6_2:1.3.0.4
	OPENBSD_6_2_BASE:1.3
	OPENBSD_6_1:1.3.0.2
	OPENBSD_6_1_BASE:1.3;
locks; strict;
comment	@# @;


1.3
date	2017.01.04.21.58.42;	author sthen;	state Exp;
branches;
next	1.2;
commitid	tVpUAxtUxHrtPpgx;

1.2
date	2017.01.04.19.56.41;	author sthen;	state Exp;
branches;
next	1.1;
commitid	wnu774aQmyCVGZ3d;

1.1
date	2016.11.08.15.37.59;	author sthen;	state Exp;
branches;
next	;
commitid	AQySTXvQxE5pzFba;


desc
@@


1.3
log
@update to py-cryptography-1.7.1
@
text
@$OpenBSD: patch-src__cffi_src_openssl_x509_vfy_py,v 1.2 2017/01/04 19:56:41 sthen Exp $

Newer libressl has part but not all of the X509_VERIFY_PARAM_* API from
OpenSSL 1.0.2beta2+; hack to allow py-cryptography to build/run with this.

--- src/_cffi_src/openssl/x509_vfy.py.orig	Tue Dec 13 22:53:09 2016
+++ src/_cffi_src/openssl/x509_vfy.py	Wed Jan  4 21:43:46 2017
@@@@ -194,10 +194,12 @@@@ void X509_STORE_CTX_set0_crls(X509_STORE_CTX *,
 int X509_VERIFY_PARAM_set1_host(X509_VERIFY_PARAM *, const char *,
                                 size_t);
 void X509_VERIFY_PARAM_set_hostflags(X509_VERIFY_PARAM *, unsigned int);
-int X509_VERIFY_PARAM_set1_email(X509_VERIFY_PARAM *, const char *,
-                                 size_t);
-int X509_VERIFY_PARAM_set1_ip(X509_VERIFY_PARAM *, const unsigned char *,
-                              size_t);
+/* Fails with recent LibreSSL; ffi doesn't support ifdefs here */
+// int X509_VERIFY_PARAM_set1_email(X509_VERIFY_PARAM *, const char *,
+//                                  size_t);
+// int X509_VERIFY_PARAM_set1_ip(X509_VERIFY_PARAM *, const unsigned char *,
+//                               size_t);
+/****/
 int X509_VERIFY_PARAM_set1_ip_asc(X509_VERIFY_PARAM *, const char *);
 
 int sk_X509_OBJECT_num(Cryptography_STACK_OF_X509_OBJECT *);
@@@@ -221,9 +223,11 @@@@ static const long X509_V_ERR_SUITE_B_INVALID_CURVE = 0
 static const long X509_V_ERR_SUITE_B_INVALID_SIGNATURE_ALGORITHM = 0;
 static const long X509_V_ERR_SUITE_B_LOS_NOT_ALLOWED = 0;
 static const long X509_V_ERR_SUITE_B_CANNOT_SIGN_P_384_WITH_P_256 = 0;
+#if !defined(LIBRESSL_VERSION_NUMBER) || LIBRESSL_VERSION_NUMBER < 0x2050100fL
 static const long X509_V_ERR_HOSTNAME_MISMATCH = 0;
 static const long X509_V_ERR_EMAIL_MISMATCH = 0;
 static const long X509_V_ERR_IP_ADDRESS_MISMATCH = 0;
+#endif
 #endif
 
 /* OpenSSL 1.0.2beta2+ verification parameters */
@


1.2
log
@Another hack to unbreak py-cryptography (this time runtime rather than
build) following symbol list changes around the X509_VERIFY_PARAM_*
functions in libcrypto; based on a diff from phessler who found this the
hard way (and I think landry also ran into it with qgis).. OK phessler
@
text
@d1 1
a1 1
$OpenBSD: patch-src__cffi_src_openssl_x509_vfy_py,v 1.1 2016/11/08 15:37:59 sthen Exp $
d6 3
a8 3
--- src/_cffi_src/openssl/x509_vfy.py.orig	Sun Nov  6 03:05:05 2016
+++ src/_cffi_src/openssl/x509_vfy.py	Wed Jan  4 19:30:20 2017
@@@@ -187,10 +187,12 @@@@ void X509_STORE_CTX_set0_crls(X509_STORE_CTX *,
a22 1
 """
d24 2
a25 1
@@@@ -207,9 +209,11 @@@@ static const long X509_V_ERR_SUITE_B_INVALID_CURVE = 0
@


1.1
log
@Add a hack to allow building py-cryptography following the VERIFY_PARAMS
changes in libressl.
@
text
@d1 1
a1 1
$OpenBSD$
d3 2
a4 1
Hack to allow building with newer libressl following this commit:
d6 20
a25 17
Date: 2016/11/05 20:14:59
Author: beck
Branch: HEAD
Tag: (none) 
Log:
Part one of the alt chains changes, bring in newer modifications to
VERIFY_PARAMS - based on boringssl.
ok jsing@@ miod@@

Members: 
	vpm_int.h:1.1->1.2 
	x509_vfy.h:1.16->1.17 
	x509_vpm.c:1.11->1.12 

--- src/_cffi_src/openssl/x509_vfy.py.orig	Mon Sep 26 21:22:21 2016
+++ src/_cffi_src/openssl/x509_vfy.py	Tue Nov  8 15:31:14 2016
@@@@ -207,10 +207,12 @@@@ static const long X509_V_ERR_SUITE_B_INVALID_CURVE = 0
d33 1
a34 1
+#endif
a36 14
 #if CRYPTOGRAPHY_OPENSSL_102BETA2_OR_GREATER && \
@@@@ -226,10 +228,12 @@@@ static const long X509_V_FLAG_SUITEB_128_LOS = 0;
 
 int (*X509_VERIFY_PARAM_set1_host)(X509_VERIFY_PARAM *, const char *,
                                    size_t) = NULL;
+#if !defined(LIBRESSL_VERSION_NUMBER) || LIBRESSL_VERSION_NUMBER < 0x2050100fL
 int (*X509_VERIFY_PARAM_set1_email)(X509_VERIFY_PARAM *, const char *,
                                     size_t) = NULL;
 int (*X509_VERIFY_PARAM_set1_ip)(X509_VERIFY_PARAM *, const unsigned char *,
                                  size_t) = NULL;
+#endif
 int (*X509_VERIFY_PARAM_set1_ip_asc)(X509_VERIFY_PARAM *, const char *) = NULL;
 void (*X509_VERIFY_PARAM_set_hostflags)(X509_VERIFY_PARAM *,
                                         unsigned int) = NULL;
@

