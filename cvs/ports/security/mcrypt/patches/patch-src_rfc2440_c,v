head	1.2;
access;
symbols
	OPENBSD_6_1:1.2.0.10
	OPENBSD_6_1_BASE:1.2
	OPENBSD_6_0:1.2.0.8
	OPENBSD_6_0_BASE:1.2
	OPENBSD_5_9:1.2.0.4
	OPENBSD_5_9_BASE:1.2
	OPENBSD_5_8:1.2.0.6
	OPENBSD_5_8_BASE:1.2
	OPENBSD_5_7:1.2.0.2
	OPENBSD_5_7_BASE:1.2
	OPENBSD_5_6:1.1.0.6
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.4
	OPENBSD_5_5_BASE:1.1
	OPENBSD_5_4:1.1.0.2
	OPENBSD_5_4_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2014.11.30.05.41.35;	author brad;	state Exp;
branches;
next	1.1;
commitid	WiC4X2lTBuuiJrMc;

1.1
date	2013.05.18.20.00.43;	author benoit;	state Exp;
branches;
next	;


desc
@@


1.2
log
@Eliminate the use of the malloc.h header and/or replace
with stdlib.h.
@
text
@$OpenBSD: patch-src_rfc2440_c,v 1.1 2013/05/18 20:00:43 benoit Exp $

- Don't use malloc.h header on OpenBSD
- Fix segv : http://sourceforge.net/p/mcrypt/patches/13/

--- src/rfc2440.c.orig	Sun Nov 16 14:50:01 2008
+++ src/rfc2440.c	Thu Nov 20 02:24:36 2014
@@@@ -23,7 +23,6 @@@@
 #include <zlib.h>
 #endif
 #include <stdio.h>
-#include <malloc.h>
 
 #include "xmalloc.h"
 #include "keys.h"
@@@@ -497,7 +496,7 @@@@ plaintext_encode(const USTRING dat)
     time_t t;
 
     assert(dat->len > 0);
-    result = make_ustring( NULL,  2 * dat->len); /* xxx */
+    result = make_ustring( NULL,  dat->len + 12); /* xxx */
     newdat = (USTRING)dat;
     result->d[pos++] = (0x80 | 0x40 | PKT_PLAINTEXT);
 
@@@@ -810,7 +809,8 @@@@ encrypted_encode(const USTRING pt, const DEK *dek)
     _mcrypt_encrypt(dek->hd, rndpref, dek->blocklen + 2, NULL, 0);
     _mcrypt_sync(dek->hd, rndpref, dek->blocklen);
 
-    ct = make_ustring( rndpref,   2 * pt->len); /* xxx */
+    ct = make_ustring( NULL, dek->blocklen + 2 + pt->len + 12); /* xxx */
+    memcpy(ct->d, rndpref, dek->blocklen + 2);
     pos = dek->blocklen + 2;
     
     _mcrypt_encrypt(dek->hd, ct->d + pos, pt->len, pt->d, pt->len);
@


1.1
log
@Fix a segv problem.

Notice by herjorge1954 at nokiamail dot com, thanks !
@
text
@d1 1
a1 1
$OpenBSD$
d3 2
a4 1
- fix segv : http://sourceforge.net/p/mcrypt/patches/13/
d6 11
a16 3
--- src/rfc2440.c.orig	Sun Nov 16 20:50:01 2008
+++ src/rfc2440.c	Sat May 18 17:22:25 2013
@@@@ -497,7 +497,7 @@@@
d25 1
a25 1
@@@@ -810,7 +810,8 @@@@
@

