head	1.3;
access;
symbols
	OPENBSD_5_8:1.2.0.10
	OPENBSD_5_8_BASE:1.2
	OPENBSD_5_7:1.2.0.6
	OPENBSD_5_7_BASE:1.2
	OPENBSD_5_6:1.2.0.4
	OPENBSD_5_6_BASE:1.2
	OPENBSD_5_5:1.2.0.2
	OPENBSD_5_5_BASE:1.2
	OPENBSD_5_4:1.1.0.34
	OPENBSD_5_4_BASE:1.1
	OPENBSD_5_3:1.1.0.32
	OPENBSD_5_3_BASE:1.1
	OPENBSD_5_2:1.1.0.30
	OPENBSD_5_2_BASE:1.1
	OPENBSD_5_1_BASE:1.1
	OPENBSD_5_1:1.1.0.28
	OPENBSD_5_0:1.1.0.26
	OPENBSD_5_0_BASE:1.1
	OPENBSD_4_9:1.1.0.24
	OPENBSD_4_9_BASE:1.1
	OPENBSD_4_8:1.1.0.22
	OPENBSD_4_8_BASE:1.1
	OPENBSD_4_7:1.1.0.20
	OPENBSD_4_7_BASE:1.1
	OPENBSD_4_6:1.1.0.18
	OPENBSD_4_6_BASE:1.1
	OPENBSD_4_5:1.1.0.16
	OPENBSD_4_5_BASE:1.1
	OPENBSD_4_4:1.1.0.14
	OPENBSD_4_4_BASE:1.1
	OPENBSD_4_3:1.1.0.12
	OPENBSD_4_3_BASE:1.1
	OPENBSD_4_2:1.1.0.10
	OPENBSD_4_2_BASE:1.1
	OPENBSD_4_1:1.1.0.8
	OPENBSD_4_1_BASE:1.1
	OPENBSD_4_0:1.1.0.6
	OPENBSD_4_0_BASE:1.1
	OPENBSD_3_9:1.1.0.4
	OPENBSD_3_9_BASE:1.1
	OPENBSD_3_8:1.1.0.2
	OPENBSD_3_8_BASE:1.1;
locks; strict;
comment	@# @;


1.3
date	2015.08.25.11.16.28;	author jca;	state dead;
branches;
next	1.2;
commitid	ZYz3xUSOJVyi0xdm;

1.2
date	2013.11.30.20.47.49;	author jca;	state Exp;
branches;
next	1.1;

1.1
date	2005.04.07.20.23.44;	author sturm;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Remove security/cfs.  Unmaintained code, broken on 64 bits archs.

softraid CRYPTO, vnconfig and security/encfs provide much saner
alternatives.

ok tedu@@ steven@@ ajacoutot@@ sthen@@
@
text
@--- cpasswd.c.orig	Sat Dec 13 23:50:36 1997
+++ cpasswd.c	Sat Nov 30 21:44:13 2013
@@@@ -50,7 +50,8 @@@@ main(argc,argv)
 	int ciph=CFS_STD_DES;
 	int cfmt=1;
 	unsigned char ekey[128];
-	
+	int l;
+
 	while (--argc && (**++argv == '-')) {
 		for (flg= ++*argv; *flg; ++flg)
 			switch (*flg) {
@@@@ -68,13 +69,25 @@@@ main(argc,argv)
 			fprintf(stderr,"Can't stat current directory\n");
 			exit(1);
 		}
-		sprintf(dir,"%s/%s",buf,argv[0]);
-	} else
-		strcpy(dir,argv[0]);
-	sprintf(kname,"%s/..k",dir);
-	sprintf(nname,"%s/..n",dir);
-	sprintf(oname,"%s/..o",dir);
-	sprintf(lname,"%s/..data",dir);
+		l = snprintf(dir, sizeof(dir), "%s/%s", buf, argv[0]);
+		if (l < 0 || l >= sizeof(dir)) {
+			fprintf(stderr, "File name too long\n");
+			exit(1);
+		}
+	} else {
+		if (strlcpy(dir, argv[0], sizeof(dir)) >= sizeof(dir)) {
+			fprintf(stderr, "File name too long\n");
+			exit(1);
+		}
+	}
+	l = snprintf(lname, sizeof(lname), "%s/..data", dir);
+	if (l < 0 || l >= sizeof(lname)) {
+		fprintf(stderr, "File name too long\n");
+		exit(1);
+	}
+	(void)snprintf(kname, sizeof(kname), "%s/..k", dir);
+	(void)snprintf(nname, sizeof(nname), "%s/..n", dir);
+	(void)snprintf(oname, sizeof(oname), "%s/..o", dir);
 	if (chdir(lname) >= 0)
 		strcpy(dir,lname);
 	else if (chdir(dir)<0) {
@@@@ -82,8 +95,12 @@@@ main(argc,argv)
 		exit(1);
 	}
 
-	sprintf(cname,"%s/..c",dir);
-	sprintf(sname,"%s/..s",dir);
+	l = snprintf(cname, sizeof(cname), "%s/..c", dir);
+	if (l < 0 || l >= sizeof(cname)) {
+		fprintf(stderr, "File name too long\n");
+		exit(1);
+	}
+	(void)snprintf(sname, sizeof(sname), "%s/..s", dir);
 	if ((fp=fopen(cname,"r")) == NULL) {
 		fprintf(stderr,"Can only change passphrase on new format CFS directories\n");
 		exit(1);
@@@@ -113,7 +130,7 @@@@ main(argc,argv)
 		exit(1);
 	}
 	if (smsize != LARGESMSIZE)
-		sprintf(pw,"%s%d",pw,smsize);
+		(void)snprintf(pw, 256, "%s%d", pw, smsize);
 	if (new_pwcrunch(pw,&oldkey)!=0) {
 		fprintf(stderr,"Invalid key\n");
 		exit(1);
@@@@ -144,7 +161,7 @@@@ main(argc,argv)
 		exit(1);
 	}
 	if (smsize != LARGESMSIZE)
-		sprintf(pw,"%s%d",pw,smsize);
+		(void)snprintf(pw, 256, "%s%d", pw, smsize);
 	if (new_pwcrunch(pw,&newkey)!=0) {
 		fprintf(stderr,"Invalid key\n");
 		exit(1);
@@@@ -182,9 +199,12 @@@@ checkkey(path,ak)
 	char fn[1024];
 	char buf[9];
 	cfskey k;
+	int l;
 	
 	copykey(ak,&k);
-	sprintf(fn,"%s/...",path);
+	l = snprintf(fn, sizeof(fn), "%s/...", path);
+	if (l < 0 || l >= sizeof(fn))
+		return 0;
 	if ((fp=fopen(fn,"r"))==NULL)
 		return 0;
 	if (fread(buf,8,1,fp)!=1) {
@


1.2
log
@Regen patches and distinfo.
@
text
@@


1.1
log
@several patches from Debian
- cmkdir now uses /dev/srandom (actually changed to arandom by me)
- support for filenames w/ 8bit chars
- sprintf() replaced with snprintf()
- some bugfixes

from Andreas Voegele <voegelas at gmx.net>
@
text
@d2 2
a3 2
+++ cpasswd.c	Sun Mar 13 14:07:27 2005
@@@@ -50,7 +50,8 @@@@
d13 1
a13 1
@@@@ -68,13 +69,25 @@@@
d46 1
a46 1
@@@@ -82,8 +95,12 @@@@
d61 1
a61 1
@@@@ -113,7 +130,7 @@@@
d70 1
a70 1
@@@@ -144,7 +161,7 @@@@
d79 1
a79 1
@@@@ -182,9 +199,12 @@@@
@

