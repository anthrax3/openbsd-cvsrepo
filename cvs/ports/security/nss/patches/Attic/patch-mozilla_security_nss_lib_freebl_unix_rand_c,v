head	1.12;
access;
symbols
	OPENBSD_5_3:1.11.0.2
	OPENBSD_5_3_BASE:1.11
	OPENBSD_5_2:1.10.0.2
	OPENBSD_5_2_BASE:1.10
	OPENBSD_5_1_BASE:1.9
	OPENBSD_5_1:1.9.0.2
	OPENBSD_5_0:1.8.0.4
	OPENBSD_5_0_BASE:1.8
	OPENBSD_4_9:1.8.0.2
	OPENBSD_4_9_BASE:1.8
	OPENBSD_4_8:1.7.0.2
	OPENBSD_4_8_BASE:1.7
	OPENBSD_4_7:1.6.0.2
	OPENBSD_4_7_BASE:1.6
	OPENBSD_4_6:1.5.0.2
	OPENBSD_4_6_BASE:1.5
	OPENBSD_4_5:1.4.0.4
	OPENBSD_4_5_BASE:1.4
	OPENBSD_4_4:1.4.0.2
	OPENBSD_4_4_BASE:1.4
	OPENBSD_4_3:1.3.0.2
	OPENBSD_4_3_BASE:1.3
	OPENBSD_4_2:1.2.0.2
	OPENBSD_4_2_BASE:1.2
	OPENBSD_4_1:1.1.0.2;
locks; strict;
comment	@# @;


1.12
date	2013.03.18.20.38.13;	author landry;	state dead;
branches;
next	1.11;

1.11
date	2012.11.12.20.43.09;	author landry;	state Exp;
branches;
next	1.10;

1.10
date	2012.03.08.12.13.01;	author ajacoutot;	state Exp;
branches;
next	1.9;

1.9
date	2011.11.18.12.32.37;	author nigel;	state Exp;
branches;
next	1.8;

1.8
date	2010.10.22.19.14.56;	author landry;	state Exp;
branches;
next	1.7;

1.7
date	2010.04.03.09.21.00;	author landry;	state Exp;
branches;
next	1.6;

1.6
date	2009.08.04.14.00.21;	author martynas;	state Exp;
branches;
next	1.5;

1.5
date	2009.03.23.07.50.47;	author jakemsr;	state Exp;
branches;
next	1.4;

1.4
date	2008.07.25.00.47.00;	author martynas;	state Exp;
branches;
next	1.3;

1.3
date	2008.02.12.23.26.31;	author martynas;	state Exp;
branches;
next	1.2;

1.2
date	2007.08.01.21.16.10;	author kurt;	state Exp;
branches;
next	1.1;

1.1
date	2007.06.22.13.37.58;	author kurt;	state Exp;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2007.07.04.14.38.24;	author sturm;	state Exp;
branches;
next	;


desc
@@


1.12
log
@Update to nss 3.14.2.

Remove a useless patch, unix_rand.c uses /dev/urandom on OpenBSD since
bug #174993 was fixed more that 5 years ago in nss 3.5.
Enforce dependency on sqlite 3.7.15.2.
Went in a handful of bulk builds.
@
text
@$OpenBSD: patch-mozilla_security_nss_lib_freebl_unix_rand_c,v 1.11 2012/11/12 20:43:09 landry Exp $
--- mozilla/security/nss/lib/freebl/unix_rand.c.orig	Wed Apr 25 16:49:43 2012
+++ mozilla/security/nss/lib/freebl/unix_rand.c	Thu Nov  8 21:18:24 2012
@@@@ -820,7 +820,6 @@@@ safe_pclose(FILE *fp)
 /* Fork netstat to collect its output by default. Do not unset this unless
  * another source of entropy is available
  */
-#define DO_NETSTAT 1
 
 void RNG_SystemInfoForRNG(void)
 {
@


1.11
log
@Update to nss 3.14.

- use ${SUBST_CMD} instead of old-style perl -pi -e commands
- update nss-config from debian's nss-config.in, since apparently it
comes from there.. needed to fix detection by mozillas, otherwise the
current script returns 3.14 for --version while configure scripts
expect 3.14.0... grab version via awk on nss.h at runtime.

Tested on amd64/i386/powerpc and in an amd64 bulk build. Needed by
firefox 18.

ok sthen@@ ajacoutot@@ jasper@@
@
text
@d1 1
a1 1
$OpenBSD: patch-mozilla_security_nss_lib_freebl_unix_rand_c,v 1.10 2012/03/08 12:13:01 ajacoutot Exp $
@


1.10
log
@Garbage collect the /dev/arandom patches.

from Brad
ok landry@@ sthen@@
@
text
@d1 4
a4 4
$OpenBSD: patch-mozilla_security_nss_lib_freebl_unix_rand_c,v 1.9 2011/11/18 12:32:37 nigel Exp $
--- mozilla/security/nss/lib/freebl/unix_rand.c.orig	Thu Aug 25 00:57:44 2011
+++ mozilla/security/nss/lib/freebl/unix_rand.c	Wed Nov  9 15:20:15 2011
@@@@ -852,7 +852,6 @@@@ safe_pclose(FILE *fp)
@


1.9
log
@Update to 3.13.1 with ckbi 1.88 changes include

SSL 2.0 is disabled by default.

A defense against the SSL 3.0 and TLS 1.0 CBC chosen plaintext attack
demonstrated by Rizzo and Duong (CVE-2011-3389) is enabled by default.

SHA-224 is supported.

additional blacklist CA's.  Malaysia-based DigiCert Sdn. Bhd

Ok sthen@@
@
text
@d1 1
a1 1
$OpenBSD: patch-mozilla_security_nss_lib_freebl_unix_rand_c,v 1.8 2010/10/22 19:14:56 landry Exp $
a11 18
@@@@ -924,7 +923,7 @@@@ void RNG_SystemInfoForRNG(void)
     GiveSystemInfo();
 
     /* grab some data from system's PRNG before any other files. */
-    bytes = RNG_FileUpdate("/dev/urandom", SYSTEM_RNG_SEED_COUNT);
+    bytes = RNG_FileUpdate(RAND_DEV, SYSTEM_RNG_SEED_COUNT);
 
     /* If the user points us to a random file, pass it through the rng */
     randfile = getenv("NSRANDFILE");
@@@@ -1169,7 +1168,7 @@@@ size_t RNG_SystemRNG(void *dest, size_t maxLen)
     size_t fileBytes = 0;
     unsigned char *buffer = dest;
 
-    file = fopen("/dev/urandom", "r");
+    file = fopen(RAND_DEV, "r");
     if (file == NULL) {
 	return rng_systemFromNoise(dest, maxLen);
     }
@


1.8
log
@Update to nss 3.12.8, required by upcoming moz* updates. Bump major and
switch to newer lib_depends while here.
@
text
@d1 4
a4 4
$OpenBSD: patch-mozilla_security_nss_lib_freebl_unix_rand_c,v 1.7 2010/04/03 09:21:00 landry Exp $
--- mozilla/security/nss/lib/freebl/unix_rand.c.orig	Fri Apr 30 02:20:02 2010
+++ mozilla/security/nss/lib/freebl/unix_rand.c	Wed Oct 20 13:07:03 2010
@@@@ -849,7 +849,6 @@@@ safe_pclose(FILE *fp)
d12 1
a12 1
@@@@ -916,7 +915,7 @@@@ void RNG_SystemInfoForRNG(void)
d21 1
a21 1
@@@@ -1161,7 +1160,7 @@@@ size_t RNG_SystemRNG(void *dest, size_t maxLen)
@


1.7
log
@Update to nss 3.12.6, tested by jasper@@ in a bulk, thanks!
ok naddy@@
@
text
@d1 3
a3 3
$OpenBSD: patch-mozilla_security_nss_lib_freebl_unix_rand_c,v 1.6 2009/08/04 14:00:21 martynas Exp $
--- mozilla/security/nss/lib/freebl/unix_rand.c.orig	Wed Jun 10 02:42:17 2009
+++ mozilla/security/nss/lib/freebl/unix_rand.c	Tue Mar 30 23:35:30 2010
d21 1
a21 1
@@@@ -1159,7 +1158,7 @@@@ size_t RNG_SystemRNG(void *dest, size_t maxLen)
@


1.6
log
@update to nss-3.12.3.  security.  please note, this will be needed
in stable for further mozilla-firefox security updates.
bulk build done by sthen@@.  thanks!
@
text
@d1 4
a4 4
$OpenBSD: patch-mozilla_security_nss_lib_freebl_unix_rand_c,v 1.5 2009/03/23 07:50:47 jakemsr Exp $
--- mozilla/security/nss/lib/freebl/unix_rand.c.orig	Sun Mar 29 06:45:33 2009
+++ mozilla/security/nss/lib/freebl/unix_rand.c	Sun Jun 21 16:57:18 2009
@@@@ -890,7 +890,6 @@@@ safe_pclose(FILE *fp)
d12 1
a12 1
@@@@ -957,7 +956,7 @@@@ void RNG_SystemInfoForRNG(void)
d21 1
a21 1
@@@@ -1259,7 +1258,7 @@@@ size_t RNG_SystemRNG(void *dest, size_t maxLen)
@


1.5
log
@use /dev/arandom instead of /dev/urandom.  /dev/urandom is too slow.

ok martynas@@
@
text
@d1 4
a4 4
$OpenBSD: patch-mozilla_security_nss_lib_freebl_unix_rand_c,v 1.4 2008/07/25 00:47:00 martynas Exp $
--- mozilla/security/nss/lib/freebl/unix_rand.c.orig	Mon Dec  3 13:07:01 2007
+++ mozilla/security/nss/lib/freebl/unix_rand.c	Sun Mar 22 00:41:15 2009
@@@@ -888,7 +888,6 @@@@ safe_pclose(FILE *fp)
d12 1
a12 1
@@@@ -955,7 +954,7 @@@@ void RNG_SystemInfoForRNG(void)
d21 1
a21 1
@@@@ -1132,7 +1131,7 @@@@ size_t RNG_SystemRNG(void *dest, size_t maxLen)
d28 2
a29 2
 	PORT_SetError(PR_NOT_IMPLEMENTED_ERROR);
 	return fileBytes;
@


1.4
log
@update to nss-3.12.  also needed by firefox 3.0
tested by many, both w/ mozilla 1.8 branch projects, and mozilla 1.9
"nspr and nss should go in" naddy@@
ok kurt@@
@
text
@d1 3
a3 3
$OpenBSD: patch-mozilla_security_nss_lib_freebl_unix_rand_c,v 1.3 2008/02/12 23:26:31 martynas Exp $
--- mozilla/security/nss/lib/freebl/unix_rand.c.orig	Mon Dec  3 23:07:01 2007
+++ mozilla/security/nss/lib/freebl/unix_rand.c	Mon Apr  7 01:23:45 2008
d12 18
@


1.3
log
@update to 3.11.9.  bump SO_VERSION major.  pass BUILD_OPT so that
correct OBJDIR is detected.  ok kurt@@
@
text
@d1 4
a4 14
$OpenBSD: patch-mozilla_security_nss_lib_freebl_unix_rand_c,v 1.2 2007/08/01 21:16:10 kurt Exp $
--- mozilla/security/nss/lib/freebl/unix_rand.c.orig	Thu Jul 26 02:18:55 2007
+++ mozilla/security/nss/lib/freebl/unix_rand.c	Wed Feb 13 01:23:57 2008
@@@@ -866,7 +866,8 @@@@ safe_pclose(FILE *fp)
     /* if the child hasn't exited, kill it -- we're done with its output */
     while ((rv = waitpid(pid, &status, WNOHANG)) == -1 && errno == EINTR)
 	;
-    if (rv == 0 && kill(pid, SIGKILL) == 0) {
+    if (rv == 0) {
+	kill(pid, SIGKILL);
 	while ((rv = waitpid(pid, &status, 0)) == -1 && errno == EINTR)
 	    ;
     }
@@@@ -887,7 +888,6 @@@@ safe_pclose(FILE *fp)
@


1.2
log
@- update to 3.11.7
- major bump due to function removal
- use NSPR_INCLUDE_DIR/NSPR_LIB_DIR
- remove patches no longer needed
okay martynas@@
@
text
@d1 4
a4 4
$OpenBSD: patch-mozilla_security_nss_lib_freebl_unix_rand_c,v 1.1 2007/06/22 13:37:58 kurt Exp $
--- mozilla/security/nss/lib/freebl/unix_rand.c.orig	Wed Feb 14 20:48:36 2007
+++ mozilla/security/nss/lib/freebl/unix_rand.c	Wed Jul 25 12:51:08 2007
@@@@ -859,7 +859,8 @@@@ safe_pclose(FILE *fp)
d14 1
a14 1
@@@@ -880,7 +881,6 @@@@ safe_pclose(FILE *fp)
@


1.1
log
@Fix a deadlock seen in thunderbird w/engimail caused by safe_pclose()
returning without waiting for the child process to complete which causes
a deadlock between nspr's WaitPidDaemonThread() and PR_WaitProcess().
Reported upstream w/more details:
https://bugzilla.mozilla.org/show_bug.cgi?id=385465
okay martynas@@
@
text
@d1 20
a20 6
$OpenBSD$
--- mozilla/security/nss/lib/freebl/unix_rand.c.orig	Thu Jun 21 14:25:55 2007
+++ mozilla/security/nss/lib/freebl/unix_rand.c	Thu Jun 21 14:41:25 2007
@@@@ -843,21 +843,19 @@@@ safe_popen(char *cmd)
 static int
 safe_pclose(FILE *fp)
a21 26
-    pid_t pid;
-    int count, status;
+    pid_t pid, ret;
+    int status;
 
     if ((pid = safe_popen_pid) == 0)
 	return -1;
     safe_popen_pid = 0;
 
-    /* if the child hasn't exited, kill it -- we're done with its output */
-    count = 0;
-    while (waitpid(pid, &status, WNOHANG) == 0) {
-    	if (kill(pid, SIGKILL) < 0 && errno == ESRCH)
-	    break;
-	if (++count == 1000)
-	    break;
-    }
+    /* kill the child in case it hasn't exited -- we're done with its output */
+    kill(pid, SIGKILL);
+
+    do {
+	ret = waitpid(pid, &status, 0);
+    } while (ret == (pid_t) -1 && errno == EINTR);
 
     /* Reset SIGCHLD signal hander before returning */
     sigaction(SIGCHLD, &oldact, NULL);
@


1.1.2.1
log
@MFC:
update to nss 3.11.5
----
Fix a deadlock seen in thunderbird w/engimail caused by safe_pclose()
returning without waiting for the child process to complete which causes
a deadlock between nspr's WaitPidDaemonThread() and PR_WaitProcess().
Reported upstream w/more details:
https://bugzilla.mozilla.org/show_bug.cgi?id=385465
@
text
@d1 1
a1 1
$OpenBSD: patch-mozilla_security_nss_lib_freebl_unix_rand_c,v 1.1 2007/06/22 13:37:58 kurt Exp $
@

