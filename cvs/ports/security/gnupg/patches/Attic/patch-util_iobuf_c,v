head	1.1;
access;
symbols
	OPENBSD_5_3:1.1.0.4
	OPENBSD_5_4:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2013.11.17.16.04.04;	author jca;	state dead;
branches
	1.1.2.1
	1.1.4.1;
next	;

1.1.2.1
date	2013.11.17.16.04.04;	author jca;	state Exp;
branches;
next	;

1.1.4.1
date	2013.11.17.17.09.11;	author jca;	state Exp;
branches;
next	;


desc
@@


1.1
log
@file patch-util_iobuf_c was initially added on branch OPENBSD_5_4.
@
text
@@


1.1.4.1
log
@MFC

Backport security fixes for CVE-2013-4402 (infinite recursion parsing
compressed packets) from gnupg-1.4.15.  Tests by merderly@@ and jasper@@,
ok jasper@@
@
text
@a0 47
$OpenBSD$

Fix from 1.4.15 for CVE-2013-4402.

 commit f10b184e48015f30849d7611bd9654ed23b91211
 Author: Werner Koch <wk@@gnupg.org>
 Date:   Fri Oct 4 08:20:49 2013 +0200

     gpg: Limit the nesting level of I/O filters.

     * until/iobuf.c (MAX_NESTING_FILTER): New.
     (iobuf_push_filter2): Limit the nesting level.
     --

     This is a more general fix for the nested compression packet bug.  In
     particular this helps g10/import.c:read_block to stop pushing
     compression filters onto an iobuf stream.

     Signed-off-by: Werner Koch <wk@@gnupg.org>

--- util/iobuf.c.orig	Thu Dec 20 18:22:28 2012
+++ util/iobuf.c	Sat Nov 16 23:28:55 2013
@@@@ -55,6 +55,11 @@@@
 
 #undef FILE_FILTER_USES_STDIO
 
+/* To avoid a potential DoS with compression packets we better limit
+   the number of filters in a chain.  */
+#define MAX_NESTING_FILTER 64
+
+
 #ifdef HAVE_DOSISH_SYSTEM
 #define USE_SETMODE 1
 #endif
@@@@ -1403,6 +1408,12 @@@@ iobuf_push_filter2( IOBUF a,
 
     if( a->use == 2 && (rc=iobuf_flush(a)) )
 	return rc;
+
+    if (a->subno >= MAX_NESTING_FILTER) {
+        log_error ("i/o filter too deeply nested - corrupted data?\n");
+        return G10ERR_UNEXPECTED;
+    }
+
     /* make a copy of the current stream, so that
      * A is the new stream and B the original one.
      * The contents of the buffers are transferred to the
@


1.1.2.1
log
@MFC

Backport security fixes for CVE-2013-4402 (infinite recursion parsing
compressed packets) and CVE-2013-4242 (Yarom/Falkner flush+reload
side-channel attack on RSA secret keys) from gnupg-1.4.15.
Requested by jasper@@
@
text
@a0 47
$OpenBSD$

Fix from 1.4.15 for CVE-2013-4402.

 commit f10b184e48015f30849d7611bd9654ed23b91211
 Author: Werner Koch <wk@@gnupg.org>
 Date:   Fri Oct 4 08:20:49 2013 +0200

     gpg: Limit the nesting level of I/O filters.

     * until/iobuf.c (MAX_NESTING_FILTER): New.
     (iobuf_push_filter2): Limit the nesting level.
     --

     This is a more general fix for the nested compression packet bug.  In
     particular this helps g10/import.c:read_block to stop pushing
     compression filters onto an iobuf stream.

     Signed-off-by: Werner Koch <wk@@gnupg.org>

--- util/iobuf.c.orig	Thu Dec 20 18:22:28 2012
+++ util/iobuf.c	Sat Nov 16 23:28:55 2013
@@@@ -55,6 +55,11 @@@@
 
 #undef FILE_FILTER_USES_STDIO
 
+/* To avoid a potential DoS with compression packets we better limit
+   the number of filters in a chain.  */
+#define MAX_NESTING_FILTER 64
+
+
 #ifdef HAVE_DOSISH_SYSTEM
 #define USE_SETMODE 1
 #endif
@@@@ -1403,6 +1408,12 @@@@ iobuf_push_filter2( IOBUF a,
 
     if( a->use == 2 && (rc=iobuf_flush(a)) )
 	return rc;
+
+    if (a->subno >= MAX_NESTING_FILTER) {
+        log_error ("i/o filter too deeply nested - corrupted data?\n");
+        return G10ERR_UNEXPECTED;
+    }
+
     /* make a copy of the current stream, so that
      * A is the new stream and B the original one.
      * The contents of the buffers are transferred to the
@

