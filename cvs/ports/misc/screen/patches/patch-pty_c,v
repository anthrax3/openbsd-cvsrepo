head	1.3;
access;
symbols
	OPENBSD_6_0:1.3.0.52
	OPENBSD_6_0_BASE:1.3
	OPENBSD_5_9:1.3.0.48
	OPENBSD_5_9_BASE:1.3
	OPENBSD_5_8:1.3.0.50
	OPENBSD_5_8_BASE:1.3
	OPENBSD_5_7:1.3.0.46
	OPENBSD_5_7_BASE:1.3
	OPENBSD_5_6:1.3.0.44
	OPENBSD_5_6_BASE:1.3
	OPENBSD_5_5:1.3.0.42
	OPENBSD_5_5_BASE:1.3
	OPENBSD_5_4:1.3.0.40
	OPENBSD_5_4_BASE:1.3
	OPENBSD_5_3:1.3.0.38
	OPENBSD_5_3_BASE:1.3
	OPENBSD_5_2:1.3.0.36
	OPENBSD_5_2_BASE:1.3
	OPENBSD_5_1_BASE:1.3
	OPENBSD_5_1:1.3.0.34
	OPENBSD_5_0:1.3.0.32
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_9:1.3.0.30
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.3.0.28
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.3.0.26
	OPENBSD_4_7_BASE:1.3
	OPENBSD_4_6:1.3.0.24
	OPENBSD_4_6_BASE:1.3
	OPENBSD_4_5:1.3.0.22
	OPENBSD_4_5_BASE:1.3
	OPENBSD_4_4:1.3.0.20
	OPENBSD_4_4_BASE:1.3
	OPENBSD_4_3:1.3.0.18
	OPENBSD_4_3_BASE:1.3
	OPENBSD_4_2:1.3.0.16
	OPENBSD_4_2_BASE:1.3
	OPENBSD_4_1:1.3.0.14
	OPENBSD_4_1_BASE:1.3
	OPENBSD_4_0:1.3.0.12
	OPENBSD_4_0_BASE:1.3
	OPENBSD_3_9:1.3.0.10
	OPENBSD_3_9_BASE:1.3
	OPENBSD_3_8:1.3.0.8
	OPENBSD_3_8_BASE:1.3
	OPENBSD_3_7:1.3.0.6
	OPENBSD_3_7_BASE:1.3
	OPENBSD_3_6:1.3.0.4
	OPENBSD_3_6_BASE:1.3
	OPENBSD_3_5:1.3.0.2
	OPENBSD_3_5_BASE:1.3;
locks; strict;
comment	@# @;


1.3
date	2004.01.05.02.00.54;	author brad;	state Exp;
branches;
next	1.2;

1.2
date	2003.10.14.23.05.28;	author jolan;	state Exp;
branches;
next	1.1;

1.1
date	2003.09.26.23.50.55;	author brad;	state Exp;
branches;
next	;


desc
@@


1.3
log
@we no longer need this custom code to deal with ptys
@
text
@$OpenBSD: patch-pty_c,v 1.2 2003/10/14 23:05:28 jolan Exp $
--- pty.c.orig	2003-09-08 10:26:18.000000000 -0400
+++ pty.c	2004-01-04 21:00:15.000000000 -0500
@@@@ -25,6 +25,7 @@@@
 #include <sys/stat.h>
 #include <fcntl.h>
 #include <signal.h>
+#include <util.h>
 
 #include "config.h"
 #include "screen.h"
@


1.2
log
@- add license comment above PERMIT_* lines
- add includes so openpty is not implicitly declared
- use (void*) NULL in execl to make sure it 64-bit where it needs to be

OK brad (maintainer)
@
text
@d1 4
a4 4
$OpenBSD: patch-pty_c,v 1.1 2003/09/26 23:50:55 brad Exp $
--- pty.c.orig	2003-09-08 09:26:18.000000000 -0500
+++ pty.c	2003-10-14 14:31:29.000000000 -0500
@@@@ -25,10 +25,29 @@@@
a7 1
+#include <termios.h>
a11 72
 
+#if HAVE_DIRENT_H
+# include <dirent.h>
+# define NAMLEN(dirent) strlen((dirent)->d_name)
+#else
+# define dirent direct
+# define NAMLEN(dirent) (dirent)->d_namlen
+# if SYSNDIR
+#  include <sys/ndir.h>
+# endif
+# if SYSDIR
+#  include <sys/dir.h>
+# endif
+# if NDIR
+#  include <ndir.h>
+# endif
+#endif
+
 #ifndef sun
 # include <sys/ioctl.h>
 #endif
@@@@ -337,25 +356,25 @@@@ int
 OpenPTY(ttyn)
 char **ttyn;
 {
-  register char *p, *q, *l, *d;
-  register int f;
+  DIR *devdir;
+  struct dirent *candidate;
+  int f;
 
-  debug("OpenPTY: Using BSD style ptys.\n");
-  strcpy(PtyName, PtyProto);
-  strcpy(TtyName, TtyProto);
-  for (p = PtyName; *p != 'X'; p++)
-    ;
-  for (q = TtyName; *q != 'X'; q++)
-    ;
-  for (l = PTYRANGE0; (*p = *l) != '\0'; l++)
+  debug("OpenPTY: Using BSD style ptys, dynamic range.\n");
+
+  devdir = opendir("/dev");
+  if (!devdir)
+    return -1;
+  while (candidate = readdir(devdir))
     {
-      for (d = PTYRANGE1; (p[1] = *d) != '\0'; d++)
+      if (NAMLEN(candidate) == 5 && strncmp(candidate->d_name, "pty", 3) == 0)
 	{
+	  sprintf(PtyName, "/dev/%s", candidate->d_name);
 	  debug1("OpenPTY tries '%s'\n", PtyName);
 	  if ((f = open(PtyName, O_RDWR | O_NOCTTY)) == -1)
 	    continue;
-	  q[0] = *l;
-	  q[1] = *d;
+	  strcpy(TtyName, PtyName);
+	  TtyName[5] = 't';
 	  if (eff_uid && access(TtyName, R_OK | W_OK))
 	    {
 	      close(f);
@@@@ -378,9 +397,11 @@@@ char **ttyn;
 #endif
 	  initmaster(f);
 	  *ttyn = TtyName;
+	  closedir(devdir);
 	  return f;
 	}
     }
+  closedir(devdir);
   return -1;
 }
 #endif
@


1.1
log
@upgrade to screen 4.0.0
--
From: Han Boetes <han at mijncomputer dot nl>
@
text
@d1 10
a10 4
$OpenBSD$
--- pty.c.orig	2003-09-08 10:26:18.000000000 -0400
+++ pty.c	2003-09-13 04:18:35.000000000 -0400
@@@@ -29,6 +29,23 @@@@
d34 1
a34 1
@@@@ -337,25 +354,25 @@@@ int
d73 1
a73 1
@@@@ -378,9 +395,11 @@@@ char **ttyn;
@

