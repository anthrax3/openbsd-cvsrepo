head	1.5;
access;
symbols
	OPENBSD_3_4:1.4.0.2
	OPENBSD_3_4_BASE:1.4
	OPENBSD_3_3:1.3.0.6
	OPENBSD_3_3_BASE:1.3
	OPENBSD_3_2:1.3.0.4
	OPENBSD_3_2_BASE:1.3
	OPENBSD_3_1:1.3.0.2
	OPENBSD_3_1_BASE:1.3
	OPENBSD_3_0:1.2.0.2
	OPENBSD_3_0_BASE:1.2
	OPENBSD_2_9_TRACKING_SWITCH:1.2
	OPENBSD_2_9:1.1.0.6
	OPENBSD_2_9_BASE:1.1
	OPENBSD_2_8:1.1.0.4
	OPENBSD_2_8_BASE:1.1
	OPENBSD_2_7:1.1.0.2;
locks; strict;
comment	@ * @;


1.5
date	2003.09.26.23.50.55;	author brad;	state dead;
branches;
next	1.4;

1.4
date	2003.05.05.04.40.31;	author brad;	state Exp;
branches;
next	1.3;

1.3
date	2002.02.17.07.13.40;	author brad;	state Exp;
branches;
next	1.2;

1.2
date	2001.07.28.04.00.36;	author brad;	state Exp;
branches;
next	1.1;

1.1
date	2000.09.01.19.37.53;	author brad;	state Exp;
branches
	1.1.2.1
	1.1.6.1;
next	;

1.1.2.1
date	2000.09.16.20.13.42;	author marc;	state Exp;
branches;
next	;

1.1.6.1
date	2001.09.06.04.31.59;	author brad;	state Exp;
branches;
next	;


desc
@@


1.5
log
@upgrade to screen 4.0.0
--
From: Han Boetes <han at mijncomputer dot nl>
@
text
@--- pty.c.orig	Fri Feb 14 08:44:20 2003
+++ pty.c	Thu Apr 24 09:24:57 2003
@@@@ -32,6 +32,23 @@@@ RCS_ID("$Id: pty.c,v 1.6 1994/05/31 12:3
 #include "config.h"
 #include "screen.h"
 
+#if HAVE_DIRENT_H
+# include <dirent.h>
+# define NAMLEN(dirent) strlen((dirent)->d_name)
+#else
+# define dirent direct
+# define NAMLEN(dirent) (dirent)->d_namlen
+# if SYSNDIR
+#  include <sys/ndir.h>
+# endif
+# if SYSDIR
+#  include <sys/dir.h>
+# endif
+# if NDIR
+#  include <ndir.h>
+# endif
+#endif
+
 #ifndef sun
 # include <sys/ioctl.h>
 #endif
@@@@ -340,25 +357,25 @@@@ int
 OpenPTY(ttyn)
 char **ttyn;
 {
-  register char *p, *q, *l, *d;
-  register int f;
+  DIR *devdir;
+  struct dirent *candidate;
+  int f;
 
-  debug("OpenPTY: Using BSD style ptys.\n");
-  strcpy(PtyName, PtyProto);
-  strcpy(TtyName, TtyProto);
-  for (p = PtyName; *p != 'X'; p++)
-    ;
-  for (q = TtyName; *q != 'X'; q++)
-    ;
-  for (l = PTYRANGE0; (*p = *l) != '\0'; l++)
+  debug("OpenPTY: Using BSD style ptys, dynamic range.\n");
+
+  devdir = opendir("/dev");
+  if (!devdir)
+    return -1;
+  while (candidate = readdir(devdir))
     {
-      for (d = PTYRANGE1; (p[1] = *d) != '\0'; d++)
+      if (NAMLEN(candidate) == 5 && strncmp(candidate->d_name, "pty", 3) == 0)
 	{
+	  sprintf(PtyName, "/dev/%s", candidate->d_name);
 	  debug1("OpenPTY tries '%s'\n", PtyName);
 	  if ((f = open(PtyName, O_RDWR | O_NOCTTY)) == -1)
 	    continue;
-	  q[0] = *l;
-	  q[1] = *d;
+	  strcpy(TtyName, PtyName);
+	  TtyName[5] = 't';
 	  if (eff_uid && access(TtyName, R_OK | W_OK))
 	    {
 	      close(f);
@@@@ -381,9 +398,11 @@@@ char **ttyn;
 #endif
 	  initmaster(f);
 	  *ttyn = TtyName;
+	  closedir(devdir);
 	  return f;
 	}
     }
+  closedir(devdir);
   return -1;
 }
 #endif
@


1.4
log
@upgrade to screen 3.9.15
--
From: Han Boetes <han at mijncomputer dot nl>
@
text
@@


1.3
log
@upgrade to screen 3.9.11
@
text
@d1 2
a2 2
--- pty.c.orig	Mon Feb 11 07:44:18 2002
+++ pty.c	Thu Feb 14 19:11:58 2002
d27 1
a27 1
@@@@ -323,25 +340,25 @@@@ int
d66 1
a66 1
@@@@ -364,9 +381,11 @@@@ char **ttyn;
@


1.2
log
@upgrade to screen 3.9.9
- DESTDIR, "CFLAGS & LDFLAGS" patches integrated
@
text
@d1 3
a3 3
--- pty.c.orig	Sat Apr 28 09:26:43 2001
+++ pty.c	Fri Jul 27 23:11:16 2001
@@@@ -32,6 +32,23 @@@@
d27 1
a27 1
@@@@ -316,25 +333,25 @@@@
d66 1
a66 1
@@@@ -357,9 +374,11 @@@@
@


1.1
log
@upgrade to screen 3.9.8;
--
fixes a format string bug, possible root compromise

Pointed out by: markus@@, deraadt@@ and Gregor Longariva
<longariva@@informatik.uni-erlangen.de>
@
text
@d1 2
a2 2
--- pty.c.orig	Fri Aug 27 06:00:12 1999
+++ pty.c	Tue Nov  9 22:49:52 1999
d27 1
a27 1
@@@@ -315,25 +332,25 @@@@
d66 1
a66 1
@@@@ -356,9 +373,11 @@@@
@


1.1.6.1
log
@MFC: upgrade to screen 3.9.10 -- security fix.
@
text
@d1 2
a2 2
--- pty.c.orig	Sat Apr 28 09:26:43 2001
+++ pty.c	Fri Jul 27 23:11:16 2001
d27 1
a27 1
@@@@ -316,25 +333,25 @@@@
d66 1
a66 1
@@@@ -357,9 +374,11 @@@@
@


1.1.2.1
log
@
Bring -current version of screen into 2.7 branch to resolve security
issue reported on bugtraq and elsewhere.  Patches and testing courtesy
of <rguyom@@321.net>.   Thanks.
@
text
@@

