head	1.4;
access;
symbols
	OPENBSD_5_3:1.1.0.2
	OPENBSD_5_3_BASE:1.1;
locks; strict;
comment	@# @;


1.4
date	2013.04.12.10.39.04;	author ajacoutot;	state dead;
branches;
next	1.3;

1.3
date	2013.03.03.12.53.21;	author ajacoutot;	state Exp;
branches;
next	1.2;

1.2
date	2013.03.02.13.54.52;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2012.10.01.10.34.54;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Update to bacula-5.2.13.

ok sthen@@
@
text
@$OpenBSD: patch-examples_autochangers_chio-changer-openbsd,v 1.3 2013/03/03 12:53:21 ajacoutot Exp $

http://bugs.bacula.org/view.php?id=1937
http://bugs.bacula.org/view.php?id=1984

--- examples/autochangers/chio-changer-openbsd.orig	Thu Sep 13 10:51:19 2012
+++ examples/autochangers/chio-changer-openbsd	Sun Mar  3 13:51:01 2013
@@@@ -23,11 +23,11 @@@@
 #      the chio exit code or a 0. If the script exits with a non-zero
 #      exit code, Bacula will assume the request failed.
 
-CHIO=/bin/chio
-
 # time (in seconds) for the unit to settle after (un)loading a tape
 SLEEP=1
 
+CHIO=/bin/chio
+
 usage() {
 	echo "usage: ${0##*/} ctl-device command [slot archive-device drive-index]"
 }
@@@@ -85,7 +85,6 @@@@ case ${cmd} in 
 		[ ${rtn} -eq 0 ] && sleep ${SLEEP}
 		exit ${rtn}
 		;;
-
 	load)
 		${CHIO} -f ${ctl} move slot $((${slot} - 1)) drive ${drive}
 		rtn=$?
@@@@ -95,20 +94,35 @@@@ case ${cmd} in 
 	list)
 		${CHIO} -f ${ctl} status -v slot | \
 			sed -ne 's/^slot *\([0-9]*:\).*FULL.*voltag.*<\(.*\):.*/\1\2/p' | \
-			awk -F: '{print $1 + 1 ":" $2 }'
+			awk -F: '{ print $1 + 1 ":" $2 }'
 		exit $?
 		;;
-
 	listall)
-		echo "The listall command is not implemented on OpenBSD."
-		exit 1
-		;;
+		# XXX only one drive is queried
+		_list=$(${0} ${1} list)
+		_loaded_s=$(${0} ${1} loaded ${slot} ${device} ${drive})
+		_loaded_t=$(${CHIO} -f ${ctl} status -v | grep "drive ${drive}" | awk '{ print $NF }' | sed -e 's,<,,' -e 's,:.*,,')
 
+		[ -n "${_list}" -a -n "${_loaded_s}" -a -n "${_loaded_t}" ] || exit 1
+
+		(for i in ${_list}; do
+			echo "S:${i}" | sed 's/\(.*\):/\1:F:/'
+		done
+		echo S:${_loaded_s}:E
+		if [ "${_loaded_s}" -ne 0 ]; then
+			echo D:${drive}:F:${_loaded_s}:${_loaded_t}
+		else
+			echo D:${drive}:E
+		fi) | sort
+		;;
 	loaded)
-		local _slot=`${CHIO} -f ${ctl} status -v | egrep '^slot.*<ACCESS> voltag: <:[0-9]>$' | awk '{ print $2 }' | awk -F: '{ print $1 + 1 }'`
-		[ -z "${_slot}" ] && _slot=0
-		echo ${_slot}
-		exit $?
+		# XXX output the first empty slot if the drive is loaded
+		_slot=$(${CHIO} -f ${ctl} status -v | egrep '^slot.*<ACCESS> voltag: <:[0-9]>$' | awk '{ print $2 }' | awk -F: '{ print $1 + 1 }')
+		rtn=$?
+		_loaded=$(${CHIO} -f ${ctl} status -v | egrep "^drive ${drive}: <ACCESS,FULL> voltag: <.*:[0-9]>")
+		[ -z "${_slot}" -o -z "${_loaded}" ] && _slot=0
+		echo ${_slot} | awk '{ print $1 }'
+		exit ${rtn}
 		;;
 	slots)
 		${CHIO} -f ${ctl} params | awk "/slots/{print \$2}"
@


1.3
log
@Redo the autochanger patch to not include CVS tag which breaks 'make patch'

reported by krw@@
@
text
@d1 1
a1 1
$OpenBSD: patch-examples_autochangers_chio-changer-openbsd,v 1.2 2013/03/02 13:54:52 ajacoutot Exp $
@


1.2
log
@Implement "listall" for the autochanger chio(1) script; has been committed
upstream already.

ok sthen@@ merdely@@ (maintainer)
@
text
@d1 1
a1 1
$OpenBSD: patch-examples_autochangers_chio-changer-openbsd,v 1.1 2012/10/01 10:34:54 ajacoutot Exp $
d7 2
a8 16
+++ examples/autochangers/chio-changer-openbsd	Thu Feb 14 13:52:54 2013
@@@@ -1,12 +1,10 @@@@
 #!/bin/sh
 #
-# $OpenBSD: chio-changer-openbsd,v 1.1 2012/07/04 12:02:56 ajacoutot Exp $
-#
 # Bacula interface to chio(1) autoloader for OpenBSD
 #
 # Adapted from NetBSD pkgsrc and examples/autochangers in bacula source)
 # by Antoine Jacoutot <ajacoutot@@openbsd.org> for OpenBSD.
-# Tested on an LTO-4 device with 8 slots.
+# Tested on an LTO-4 device with 1 drive and 8 slots.
 # The user Bacula is running as needs rw access to the ch(4) and st(4)
 # devices.
 #
@@@@ -23,11 +21,11 @@@@
d22 1
a22 1
@@@@ -85,7 +83,6 @@@@ case ${cmd} in 
d30 1
a30 1
@@@@ -95,20 +92,35 @@@@ case ${cmd} in 
@


1.1
log
@Fix the autochanger script to work when a device has several empty slots.
@
text
@d1 1
a1 1
$OpenBSD$
d4 1
d6 39
a44 3
--- examples/autochangers/chio-changer-openbsd.orig	Tue Sep 11 11:26:24 2012
+++ examples/autochangers/chio-changer-openbsd	Mon Oct  1 12:28:46 2012
@@@@ -95,7 +95,7 @@@@ case ${cmd} in 
d52 9
d62 12
a73 3
@@@@ -105,10 +105,13 @@@@ case ${cmd} in 
 		;;
 
d80 1
a80 1
+		_slot=`${CHIO} -f ${ctl} status -v | egrep '^slot.*<ACCESS> voltag: <:[0-9]>$' | awk '{ print $2 }' | awk -F: '{ print $1 + 1 }'`
d82 1
a82 1
+		_loaded=`${CHIO} -f ${ctl} status -v | egrep "^drive ${drive}: <ACCESS,FULL> voltag: <.*:[0-9]>"`
@

