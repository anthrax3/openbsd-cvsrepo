head	1.4;
access;
symbols
	OPENBSD_2_5:1.2.0.4
	OPENBSD_2_5_BASE:1.2
	OPENBSD_2_4:1.2.0.2
	OPENBSD_2_4_BASE:1.2
	ian_1998-Sep-29:1.1.1.1
	ian:1.1.1;
locks; strict;
comment	@# @;


1.4
date	99.05.31.14.38.48;	author ian;	state dead;
branches;
next	1.3;

1.3
date	99.05.30.20.44.39;	author ian;	state Exp;
branches;
next	1.2;

1.2
date	98.10.02.19.00.29;	author ian;	state Exp;
branches;
next	1.1;

1.1
date	98.09.29.23.59.18;	author ian;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	98.09.29.23.59.18;	author ian;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Remove old patches. As theo put it, patches is not a dropping ground.
@
text
@--- zap.c.orig	Sat Dec 20 11:08:09 1997
+++ zap.c	Sun May 30 16:19:56 1999
@@@@ -2,36 +2,81 @@@@
 
 #include <stdio.h>
 #include <signal.h>
+
 char	*progname;	/* program name for error message */
-char	*ps = "ps -ag";	/* system dependent */
+char	*ps = "ps -ax";	/* system dependent */
+int		progpid;
+
+FILE *efopen(char *file, char *mode);
 
-main(argc, argv)
-	int argc;
-	char *argv[];
+main(int argc, char **argv)
 {
 	FILE *fin, *popen();
-	char buf[BUFSIZ];
-	int pid;
+	char buf[BUFSIZ];	/* a line to read */
+	int errors = 0;		/* for getopt */
+	int c = 0;			/* from getopt */
+	extern int optind;	/* from getopt */
+	extern char* optarg;/* from getopt */
+	int pid;			/* target PID */
+	int interact = 1;	/* ? ask : just do it */
+	int debug = 0;		/* print debugging? (unused) */
+	int signum = SIGTERM;	/* how shall I tell thee? */
 
 	progname = argv[0];
+	progpid  = getpid();
+
+	while ((c = getopt(argc, argv, "ds:y")) != EOF) {
+		switch (c) {
+		case 's':
+			signum = atoi(optarg);	/* TODO name lookup like kill(1) */
+			break;
+		case 'd':
+			++debug;
+			break;
+		case 'y':
+			interact = 0;
+			break;
+		case '?':
+		default:
+			errors++;
+			break;
+		}
+	}
+	if (errors || (argc-optind<1)) {
+		(void) fprintf(stderr, "usage: %s [-s signum] processname ...\n", progname);
+		exit(2);
+	}
+
 	if ((fin = popen(ps, "r")) == NULL) {
 		fprintf(stderr, "%s: can't run %s\n", progname, ps);
 		exit(1);
 	}
 	fgets(buf, sizeof buf, fin);	/* get header line */
 	fprintf(stderr, "%s", buf);
-	while (fgets(buf, sizeof buf, fin) != NULL)
-		if (argc == 1 || strindex(buf, argv[1]) >= 0) {
-			buf[strlen(buf)-1] = '\0'; /* suppress \n */
-			fprintf(stderr, "%s? ", buf);
-			if (ttyin() == 'y') {
-				sscanf(buf, "%d", &pid);
-				kill(pid, SIGKILL);
+
+	/* Read a line from ps, process it. */
+	while (fgets(buf, sizeof buf, fin) != NULL) {
+		buf[strlen(buf)-1] = '\0'; /* suppress \n */
+		if (strstr(buf, argv[optind]) != NULL && 
+				(pid = atoi(buf)) != progpid) {
+
+			fprintf(stderr, "%s", buf);
+
+			if (interact) {
+				fprintf(stderr, "? ");
+				if (ttyin() == 'y') {
+					if (kill(pid, signum)<0)
+						perror(buf);
+				}
+			} else {
+				fprintf(stderr, "\n");
+				if (kill(pid, signum)<0)
+					perror(buf);
 			}
 		}
+	}
 	exit(0);
 }
 
 #include "ttyin2.c"
-#include "strindex.c"
 #include "efopen.c"
@


1.3
log
@Add -y option, and -s signum. Default to SIGTERM, document this.
@
text
@@


1.2
log
@Buglet: zap included itself in list of processes offered for killing.
@
text
@d2 2
a3 2
+++ zap.c	Fri Oct  2 14:50:18 1998
@@@@ -2,18 +2,22 @@@@
d21 11
a31 2
 	char buf[BUFSIZ];
 	int pid;
d36 22
d61 1
a61 1
@@@@ -21,12 +25,14 @@@@
d64 1
a64 1
 	while (fgets(buf, sizeof buf, fin) != NULL)
d66 4
a69 6
+		if (argc == 1 || 
+			(strindex(buf, argv[1]) >= 0 && atoi(buf) != progpid)) {
 			buf[strlen(buf)-1] = '\0'; /* suppress \n */
 			fprintf(stderr, "%s? ", buf);
 			if (ttyin() == 'y') {
 				sscanf(buf, "%d", &pid);
d71 18
a88 1
+				if (kill(pid, SIGKILL)<0)
d92 1
d94 5
@


1.1
log
@Initial revision
@
text
@d2 2
a3 2
+++ zap.c	Tue Sep 29 19:42:56 1998
@@@@ -2,12 +2,13 @@@@
d11 1
d22 16
a37 1
@@@@ -26,7 +27,8 @@@@
@


1.1.1.1
log
@zap (process killer) port
@
text
@@
