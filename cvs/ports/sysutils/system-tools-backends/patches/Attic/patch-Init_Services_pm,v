head	1.6;
access;
symbols
	OPENBSD_4_9:1.4.0.2
	OPENBSD_4_9_BASE:1.4;
locks; strict;
comment	@# @;


1.6
date	2011.07.12.07.35.54;	author ajacoutot;	state dead;
branches;
next	1.5;

1.5
date	2011.07.08.02.14.59;	author ajacoutot;	state Exp;
branches;
next	1.4;

1.4
date	2011.01.17.23.06.21;	author ajacoutot;	state Exp;
branches;
next	1.3;

1.3
date	2011.01.17.15.00.23;	author ajacoutot;	state Exp;
branches;
next	1.2;

1.2
date	2011.01.17.00.36.28;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2010.10.29.15.05.28;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.6
log
@Remove (gnome)-system-tools. Most of it is broken on OpenBSD and there
is no point in fixing it since most features have been superseded by
accountsservice and gnome-cc (GNOME3).

ok jasper@@
@
text
@$OpenBSD: patch-Init_Services_pm,v 1.5 2011/07/08 02:14:59 ajacoutot Exp $
--- Init/Services.pm.orig	Sat Mar 13 10:37:16 2010
+++ Init/Services.pm	Tue Jan 18 00:05:10 2011
@@@@ -54,6 +54,7 @@@@ sub get_runlevels
      "gentoo"           => "gentoo",
      "archlinux"        => "freebsd-5",
      "freebsd-5"        => "freebsd-5",
+     "openbsd-4"        => "openbsd-4",
      "solaris-2.11"     => "freebsd-5",
     );
 
@@@@ -62,6 +63,7 @@@@ sub get_runlevels
      "redhat-6.2"      => [ "0", "1", "2", "3", "4", "5", "6" ],
      "gentoo"          => &get_gentoo_runlevels (),
      "freebsd-5"       => [ "default" ],
+     "openbsd-4"       => [ "default" ],
     );
 
   $distro = $dist_map{$Utils::Backend::tool{"platform"}};
@@@@ -1086,6 +1088,14 @@@@ sub get_rcng_status_by_service
   {
     return &Utils::File::exists ("/var/run/daemons/$service");
   }
+  elsif ($Utils::Backend::tool{"platform"} eq "openbsd-4")
+  {
+    if (!&Utils::File::run ("/etc/rc.d/$service", "check"))
+    {
+      $active = 1;
+    }
+    return $active;
+  }
   else
   {
     $fd = &Utils::File::run_pipe_read ("/etc/rc.d/$service rcvar");
@@@@ -1210,6 +1220,40 @@@@ sub set_rcng_service_status
   }
 }
 
+sub set_openbsd_service_status
+{
+  my ($script, $active) = @@_;
+  my $rcconf = '/etc/rc.conf.local';
+  my ($daemons);
+
+  $daemons = &Utils::Parse::get_sh ($rcconf, "pkg_scripts");
+  $daemons =~ s/[\"\"]//g;
+
+  # escape these chars
+  $script =~ s/([\\\.\^\$\*\+\?\{\}\[\]\(\)\|])/\\\1/g;
+  $notscript = "-" . $script;
+
+  if (($daemons =~ m/$notscript/) && $active)
+  {
+    # It was disabled, enable it
+    $daemons =~ s/$notscript/$script/g;
+  }
+  elsif (($daemons =~ m/$script/) && !$active)
+  {
+    # It was enabled, disable it
+    $daemons =~ s/$script/$notscript/g;
+  }
+  elsif (($daemons !~ m/$script/) && $active)
+  {
+    $daemons .= " ".$script;
+  }
+
+  $daemons = "\"" . $daemons . "\"";
+  &Utils::Replace::set_sh ($rcconf, "pkg_scripts", $daemons, 1);
+  # XXX $script should be $service
+  &run_rcng_script ($script, ($active) ? "start" : "stop");
+}
+
 sub set_archlinux_service_status
 {
   my ($script, $active) = @@_;
@@@@ -1253,6 +1297,10 @@@@ sub set_rcng_service
   {
     $func = \&set_archlinux_service_status;
   }
+  elsif ($Utils::Backend::tool{"platform"} eq "openbsd-4")
+  {
+    $func = \&set_openbsd_service_status;
+  }
   else
   {
     $func = \&set_rcng_service_status;
@@@@ -1543,7 +1591,7 @@@@ sub get_init_type
   {
     return "bsd";
   }
-  elsif (($gst_dist =~ /freebsd/) || ($gst_dist =~ /archlinux/))
+  elsif (($gst_dist =~ /freebsd/) || ($gst_dist =~ /archlinux/) || ($gst_dist =~ /openbsd/))
   {
     return "rcng";
   }
@


1.5
log
@rc_scripts -> pkg_scripts
@
text
@d1 1
a1 1
$OpenBSD: patch-Init_Services_pm,v 1.4 2011/01/17 23:06:21 ajacoutot Exp $
@


1.4
log
@Disable services with dash, not underscore.
@
text
@d1 1
a1 1
$OpenBSD: patch-Init_Services_pm,v 1.3 2011/01/17 15:00:23 ajacoutot Exp $
d45 1
a45 1
+  $daemons = &Utils::Parse::get_sh ($rcconf, "rc_scripts");
d68 1
a68 1
+  &Utils::Replace::set_sh ($rcconf, "rc_scripts", $daemons, 1);
@


1.3
log
@Finish services handling. Still a bit rought but works fine.

ok jasper@@
@
text
@d1 1
a1 1
$OpenBSD: patch-Init_Services_pm,v 1.2 2011/01/17 00:36:28 ajacoutot Exp $
d3 1
a3 1
+++ Init/Services.pm	Mon Jan 17 15:56:51 2011
d50 1
a50 1
+  $notscript = "_" . $script;
@


1.2
log
@Add initial support for rc.d services.
@
text
@d1 1
a1 1
$OpenBSD: patch-Init_Services_pm,v 1.1 2010/10/29 15:05:28 ajacoutot Exp $
d3 1
a3 1
+++ Init/Services.pm	Mon Jan 17 01:33:21 2011
d35 1
a35 1
@@@@ -1210,6 +1220,13 @@@@ sub set_rcng_service_status
d42 2
d45 26
a70 1
+  &run_rcng_script ($service, ($active) ? "start" : "stop");
d76 1
a76 1
@@@@ -1253,6 +1270,10 @@@@ sub set_rcng_service
d87 1
a87 1
@@@@ -1543,7 +1564,7 @@@@ sub get_init_type
d92 1
a92 1
+  elsif (($gst_dist =~ /freebsd/) || ($gst_dist =~ /openbsd/) || ($gst_dist =~ /archlinux/))
@


1.1
log
@Start work to implement services. Not working yet.
@
text
@d1 1
a1 1
$OpenBSD$
d3 1
a3 1
+++ Init/Services.pm	Fri Oct 29 17:02:47 2010
d20 1
a20 1
@@@@ -1086,6 +1088,10 @@@@ sub get_rcng_status_by_service
d24 1
a24 1
+  elsif ($Utils::Backend::tool{"platform"} eq "openbsd")
d26 5
a30 1
+    return &Utils::File::exists ("/etc/rc.d/$service");
d35 1
a35 1
@@@@ -1210,6 +1216,39 @@@@ sub set_rcng_service_status
a41 2
+  my $rcconf = '/etc/rc.conf.local';
+  my ($daemons);
a42 24
+  $daemons = &Utils::Parse::get_sh ($rcconf, "rc_scripts");
+  $daemons =~ s/[\(\)]//g;
+
+  # escape these chars
+  $script =~ s/([\\\.\^\$\*\+\?\{\}\[\]\(\)\|])/\\\1/g;
+  $notscript = "\!" . $script;
+
+  if (($daemons =~ m/$notscript/) && $active)
+  {
+    # It was disabled, enable it
+    $daemons =~ s/$notscript/$script/g;
+  }
+  elsif (($daemons =~ m/$script/) && !$active)
+  {
+    # It was enabled, disable it
+    $daemons =~ s/$script/$notscript/g;
+  }
+  elsif (($daemons !~ m/$script/) && $active)
+  {
+    $daemons .= " ".$script;
+  }
+
+  $daemons = "(" . $daemons . ")";
+  &Utils::Replace::set_sh ($rcconf, "rc_scripts", $daemons, 1);
d49 1
a49 1
@@@@ -1253,6 +1292,10 @@@@ sub set_rcng_service
d53 1
a53 1
+  elsif ($Utils::Backend::tool{"platform"} eq "openbsd")
d60 1
a60 1
@@@@ -1543,7 +1586,7 @@@@ sub get_init_type
@

