head	1.2;
access;
symbols
	OPENBSD_4_9:1.1.0.2
	OPENBSD_4_9_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2011.05.02.21.19.14;	author sthen;	state dead;
branches;
next	1.1;

1.1
date	2010.10.19.01.07.14;	author sthen;	state Exp;
branches;
next	;


desc
@@


1.2
log
@- update symon to 2.83
- take maintainer, agreed with present maintainer(+upstream) Willem Dijkstra
@
text
@$OpenBSD: patch-platform_OpenBSD_sm_io_c,v 1.1 2010/10/19 01:07:14 sthen Exp $

Handle hw.disknames with "devname:" and "devname:uid" formats;
allow either device name or uid to match the device.

--- platform/OpenBSD/sm_io.c.orig	Sun Jun 28 19:40:29 2009
+++ platform/OpenBSD/sm_io.c	Mon Oct 18 17:22:14 2010
@@@@ -51,6 +51,7 @@@@
 static char *io_dkstr = NULL;
 static struct diskstats *io_dkstats = NULL;
 static char **io_dknames = NULL;
+static char **io_dkuids = NULL;
 static int io_dks = 0;
 static int io_maxdks = 0;
 static size_t io_maxstr = 0;
@@@@ -98,6 +99,7 @@@@ gets_io()
 
         io_dkstats = xrealloc(io_dkstats, io_maxdks * sizeof(struct diskstats));
         io_dknames = xrealloc(io_dknames, io_maxdks * sizeof(char *));
+        io_dkuids = xrealloc(io_dkuids, io_maxdks * sizeof(char *));
         io_dkstr = xrealloc(io_dkstr, io_maxstr + 1);
     }
 
@@@@ -128,7 +130,13 @@@@ gets_io()
             *p = '\0';
             io_dks++; p++;
             io_dknames[io_dks] = p;
+            io_dkuids[io_dks] = NULL;
         }
+        if ((*p == ':') && (*p+1 != '\0')) {
+            *p = '\0';
+            p++;
+            io_dkuids[io_dks] = p;
+	}
         p++;
     }
 }
@@@@ -146,8 +154,10 @@@@ get_io(char *symon_buf, int maxlen, struct stream *st)
 
     /* look for disk */
     for (i = 0; i <= io_dks; i++) {
-        if (strncmp(io_dknames[i], st->arg,
+        if ((strncmp(io_dknames[i], st->arg,
                     (io_dkstr + io_maxstr - io_dknames[i])) == 0)
+        	    || (io_dkuids[i] && (strncmp(io_dkuids[i], st->arg,
+                    (io_dkstr + io_maxstr - io_dkuids[i])) == 0)))
 #ifdef HAS_IO2
             return snpack(symon_buf, maxlen, st->arg, MT_IO2,
                           io_dkstats[i].ds_rxfer,
@


1.1
log
@- adapt io monitor to handle the new hw.disknames format (devname: or
devname:uid), problem reported by Anton Maksimenkov with a different diff.

- new-style lib_depends/wantlib

- let ports-standard DEBUG=xxx work as expected and produce binaries
with symbols

sm_io.c diff looks good to henning@@
@
text
@d1 1
a1 1
$OpenBSD$
@

