head	1.6;
access;
symbols
	OPENBSD_6_0:1.6.0.2
	OPENBSD_6_0_BASE:1.6
	OPENBSD_5_9:1.5.0.2
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.5.0.4
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.3.0.24
	OPENBSD_5_7_BASE:1.3
	OPENBSD_5_6:1.3.0.22
	OPENBSD_5_6_BASE:1.3
	OPENBSD_5_5:1.3.0.20
	OPENBSD_5_5_BASE:1.3
	OPENBSD_5_4:1.3.0.18
	OPENBSD_5_4_BASE:1.3
	OPENBSD_5_3:1.3.0.16
	OPENBSD_5_3_BASE:1.3
	OPENBSD_5_2:1.3.0.14
	OPENBSD_5_2_BASE:1.3
	OPENBSD_5_1_BASE:1.3
	OPENBSD_5_1:1.3.0.12
	OPENBSD_5_0:1.3.0.10
	OPENBSD_5_0_BASE:1.3
	OPENBSD_4_9:1.3.0.8
	OPENBSD_4_9_BASE:1.3
	OPENBSD_4_8:1.3.0.6
	OPENBSD_4_8_BASE:1.3
	OPENBSD_4_7:1.3.0.4
	OPENBSD_4_7_BASE:1.3
	OPENBSD_4_6:1.3.0.2
	OPENBSD_4_6_BASE:1.3
	OPENBSD_4_5:1.2.0.12
	OPENBSD_4_5_BASE:1.2
	OPENBSD_4_4:1.2.0.10
	OPENBSD_4_4_BASE:1.2
	OPENBSD_4_3:1.2.0.8
	OPENBSD_4_3_BASE:1.2
	OPENBSD_4_2:1.2.0.6
	OPENBSD_4_2_BASE:1.2
	OPENBSD_4_1:1.2.0.4
	OPENBSD_4_1_BASE:1.2
	OPENBSD_4_0:1.2.0.2
	OPENBSD_4_0_BASE:1.2
	OPENBSD_3_9:1.1.0.16
	OPENBSD_3_9_BASE:1.1
	OPENBSD_3_8:1.1.0.14
	OPENBSD_3_8_BASE:1.1
	OPENBSD_3_7:1.1.0.12
	OPENBSD_3_7_BASE:1.1
	OPENBSD_3_6:1.1.0.10
	OPENBSD_3_6_BASE:1.1
	OPENBSD_3_5:1.1.0.8
	OPENBSD_3_5_BASE:1.1
	OPENBSD_3_4:1.1.0.6
	OPENBSD_3_4_BASE:1.1
	OPENBSD_3_3:1.1.0.4
	OPENBSD_3_3_BASE:1.1
	OPENBSD_3_2:1.1.0.2
	OPENBSD_3_2_BASE:1.1;
locks; strict;
comment	@# @;


1.6
date	2016.04.21.08.56.07;	author semarie;	state Exp;
branches;
next	1.5;
commitid	asaRboTkcMDXVvLa;

1.5
date	2015.05.22.13.45.30;	author schwarze;	state Exp;
branches;
next	1.4;
commitid	NTcyNFAUhZE4N0xN;

1.4
date	2015.05.11.11.47.27;	author sthen;	state Exp;
branches;
next	1.3;
commitid	9XtLn01OovGKwwZ1;

1.3
date	2009.05.10.14.54.22;	author jasper;	state Exp;
branches;
next	1.2;

1.2
date	2006.07.14.05.17.18;	author steven;	state Exp;
branches;
next	1.1;

1.1
date	2002.06.29.14.25.53;	author naddy;	state Exp;
branches;
next	;


desc
@@


1.6
log
@pledge sysutils/pstree

initial patch from steve latif

ok sthen@@
@
text
@$OpenBSD: patch-pstree_c,v 1.5 2015/05/22 13:45:30 schwarze Exp $
--- pstree.c.orig	Wed May 13 14:24:47 2015
+++ pstree.c	Thu Apr 21 08:23:00 2016
@@@@ -77,7 +77,7 @@@@ extern getargs(struct ProcInfo *, int, char *, int);
  * (Net|Open|Free)BSD & Darwin merged by Ralf Meyer <ralf AT thp.Uni-Duisburg.DE>
  */
 #  define HAS_PGID
-#  define PSCMD 	"ps -axwwo user,pid,ppid,pgid,command"
+#  define PSCMD 	"ps -kaxwwo user,pid,ppid,pgid,command"
 #  define PSFORMAT 	"%s %ld %ld %ld %[^\n]"
 #  define PSVARS	P[i].name, &P[i].pid, &P[i].ppid, &P[i].pgid, P[i].cmd
 #  define PSVARSN	5
@@@@ -872,7 +872,12 @@@@ int main(int argc, char **argv) {
 #ifdef ZOMBIES_HAVE_PID_0
   FixZombies();
 #endif
-  
+
+  if (pledge("stdio getpw proc tty", NULL) == -1) {
+    fprintf(stderr, "%s: pledge\n", Progname);
+    exit(1);
+  }
+
   if (NProc == 0) {
     fprintf(stderr, "%s: No processes read.\n", Progname);
     exit(1);
@


1.5
log
@Update to pstree-2.39 (includes our manual and one of our patches).
Update patch from Jan Stary <hans at stare dot cz>, OK sthen@@.
@
text
@d1 3
a3 3
$OpenBSD$
--- pstree.c.orig	Thu May 21 11:23:56 2015
+++ pstree.c	Thu May 21 11:24:29 2015
d13 14
@


1.4
log
@Don't use uninitialized structs when ioctl() fails, e.g. if run with stdout
redirected. Problem reported by Jan Stary.
@
text
@d1 4
a4 7
$OpenBSD: patch-pstree_c,v 1.3 2009/05/10 14:54:22 jasper Exp $

If ioctl fails, the structs are uninitialized, so don't use them.

--- pstree.c.orig	Fri Apr 12 10:47:03 2013
+++ pstree.c	Mon May 11 12:44:12 2015
@@@@ -71,7 +71,7 @@@@ extern getargs(struct ProcInfo *, int, char *, int);
a12 17
@@@@ -872,12 +872,12 @@@@ int main(int argc, char **argv) {
     Columns = atoi((char*)termdef(fileno(stdout),'c'));
 #elif defined(TIOCGWINSZ)
     struct winsize winsize;
-    ioctl(fileno(stdout), TIOCGWINSZ, &winsize);
-    Columns = winsize.ws_col;
+    if (ioctl(fileno(stdout), TIOCGWINSZ, &winsize) != -1)
+        Columns = winsize.ws_col;
 #elif defined(TIOCGSIZE)
     struct ttysize ttysize;
-    ioctl(fileno(stdout), TIOCGSIZE, &ttysize);
-    Columns = ttysize.ts_cols;
+    if (ioctl(fileno(stdout), TIOCGSIZE, &ttysize) != -1)
+        Columns = ttysize.ts_cols;
 #else
     char *env = getenv("COLUMNS");
     Columns = env ? atoi(env) : 80;
@


1.3
log
@- update pstree to 2.32

mostly from Rodolfo Gouveia
@
text
@d1 6
a6 3
$OpenBSD$
--- pstree.c.orig	Sun May 10 16:49:43 2009
+++ pstree.c	Sun May 10 16:51:27 2009
d16 17
@


1.2
log
@update to pstree 2.27.
Sam Smith gives up maintainership.

"looks sensible" sturm@@
@
text
@d1 4
a4 4
$OpenBSD: patch-pstree_c,v 1.1 2002/06/29 14:25:53 naddy Exp $
--- pstree.c.orig	Fri Apr  8 22:08:47 2005
+++ pstree.c	Wed Jul 12 08:51:24 2006
@@@@ -71,7 +71,7 @@@@ extern getargs(struct ProcInfo *, int, c
a12 9
@@@@ -515,7 +515,7 @@@@ int GetProcesses(void) {
 int GetRootPid(void) {
   int me;
   for (me = 0; me < NProc; me++) {
-    if (P[me].pid == -1) return P[me].pid;
+    if (P[me].pid == 1) return P[me].pid;
   }
   /* PID == 1 not found, so we'll take process with PPID == 0
    * Fix for TRU64 TruCluster with uniq PIDs
@


1.1
log
@Show kernel processes as well.
From maintainer Sebastian Stark <seb@@todesplanet.de>.
@
text
@d1 6
a6 6
$OpenBSD$
--- pstree.c.orig	Sat Jun 29 16:18:57 2002
+++ pstree.c	Sat Jun 29 16:19:12 2002
@@@@ -180,7 +180,7 @@@@ extern getargs(struct ProcInfo *, int, c
 #elif defined(__NetBSD__) || defined(__OpenBSD__)
 /* NetBSD contributed by Gary D. Duzan <gary@@wheel.tiac.net> */
d12 10
a21 1
 #else			/* HP-UX, A/UX etc. */
@

