head	1.4;
access;
symbols
	OPENBSD_6_1:1.4.0.10
	OPENBSD_6_1_BASE:1.4
	OPENBSD_6_0:1.4.0.8
	OPENBSD_6_0_BASE:1.4
	OPENBSD_5_9:1.4.0.4
	OPENBSD_5_9_BASE:1.4
	OPENBSD_5_8:1.4.0.6
	OPENBSD_5_8_BASE:1.4
	OPENBSD_5_7:1.4.0.2
	OPENBSD_5_7_BASE:1.4;
locks; strict;
comment	@# @;


1.4
date	2014.12.29.18.56.55;	author jasper;	state Exp;
branches;
next	1.3;
commitid	AJbvWYJDXnlZ1FLH;

1.3
date	2014.12.07.13.31.08;	author jasper;	state Exp;
branches;
next	1.2;
commitid	HAHYcPO76n8IWsFi;

1.2
date	2014.12.02.19.26.18;	author jasper;	state Exp;
branches;
next	1.1;
commitid	G4mY30IwA30O1ZNe;

1.1
date	2014.11.12.07.42.47;	author jasper;	state Exp;
branches;
next	;
commitid	xy6BdfhiV2hBlhui;


desc
@@


1.4
log
@sync with what's been merged upstream
@
text
@$OpenBSD: patch-lib_puppet_provider_user_openbsd_rb,v 1.3 2014/12/07 13:31:08 jasper Exp $

- From 986281e1d2e45ca2f6a2a902c508c9d66e66da50 Mon Sep 17 00:00:00 2001
  From: Jasper Lievisse Adriaanse <jasper@@humppa.nl>
  Date: Sun, 2 Nov 2014 16:44:42 +0100
  Subject: [PATCH] (PUP-3605) Add new OpenBSD user provider

- From fc4cb831e7203b6568e090ebb671bf5bbb9cb910 Mon Sep 17 00:00:00 2001
  From: Jasper Lievisse Adriaanse <jasper@@humppa.nl>
  Date: Tue, 2 Dec 2014 20:38:11 +0100
  Subject: [PATCH] (PUP-3723) Add new loginclass parameter to user type

--- lib/puppet/provider/user/openbsd.rb.orig	Mon Dec 29 19:55:22 2014
+++ lib/puppet/provider/user/openbsd.rb	Mon Dec 29 19:55:49 2014
@@@@ -0,0 +1,76 @@@@
+require 'date'
+require 'time'
+require 'puppet/error'
+
+Puppet::Type.type(:user).provide :openbsd, :parent => :useradd do
+  desc "User management via `useradd` and its ilk for OpenBSD. Note that you
+    will need to install Ruby's shadow password library (package known as
+    `ruby-shadow`) if you wish to manage user passwords."
+
+  commands :add      => "useradd",
+           :delete   => "userdel",
+           :modify   => "usermod",
+           :password => "passwd"
+
+  defaultfor :operatingsystem => :openbsd
+
+  options :home, :flag => "-d", :method => :dir
+  options :comment, :method => :gecos
+  options :groups, :flag => "-G"
+  options :password, :method => :sp_pwdp
+  options :loginclass, :flag => '-L', :method => :sp_loginclass
+  options :expiry, :method => :sp_expire,
+    :munge => proc { |value|
+      if value == :absent
+        ''
+      else
+        # OpenBSD uses a format like "january 1 1970"
+        Time.parse(value).strftime('%B %d %Y')
+      end
+    },
+    :unmunge => proc { |value|
+      if value == -1
+        :absent
+      else
+        # Expiry is days after 1970-01-01
+        (Date.new(1970,1,1) + value).strftime('%Y-%m-%d')
+      end
+    }
+
+  [:expiry, :password, :loginclass].each do |shadow_property|
+    define_method(shadow_property) do
+      if Puppet.features.libshadow?
+        if ent = Shadow::Passwd.getspnam(@@resource.name)
+          method = self.class.option(shadow_property, :method)
+          # ruby-shadow may not be new enough (< 2.4.1) and therefore lack the
+          # sp_loginclass field.
+          begin
+            return unmunge(shadow_property, ent.send(method))
+          rescue => detail
+            Puppet.warning "ruby-shadow doesn't support #{method}"
+          end
+        end
+      end
+      :absent
+    end
+  end
+
+  has_features :manages_homedir, :manages_expiry, :system_users
+  has_features :manages_shell
+  if Puppet.features.libshadow?
+    has_features :manages_passwords, :manages_loginclass
+  end
+
+  def loginclass=(value)
+    set("loginclass", value)
+  end
+
+  def modifycmd(param, value)
+    cmd = super
+    if param == :groups
+      idx = cmd.index('-G')
+      cmd[idx] = '-S'
+    end
+    cmd
+  end
+end
@


1.3
log
@sync comments with what has been merged and submitted upstream
@
text
@d1 1
a1 1
$OpenBSD: patch-lib_puppet_provider_user_openbsd_rb,v 1.2 2014/12/02 19:26:18 jasper Exp $
d8 4
a11 2
- add new 'loginclass' attribute to the 'user' type
  https://github.com/puppetlabs/puppet/pull/3384
d13 3
a15 3
--- lib/puppet/provider/user/openbsd.rb.orig	Tue Dec  2 20:19:15 2014
+++ lib/puppet/provider/user/openbsd.rb	Tue Dec  2 20:20:56 2014
@@@@ -0,0 +1,70 @@@@
d60 7
a66 1
+          return unmunge(shadow_property, ent.send(method))
@


1.2
log
@turn :manages_loginclass into a proper feature
@
text
@d1 10
a10 1
$OpenBSD: patch-lib_puppet_provider_user_openbsd_rb,v 1.1 2014/11/12 07:42:47 jasper Exp $
@


1.1
log
@- add a new provider for user/group management on openbsd, so we don't have
  to add exceptions for openbsd all over the generic provider.
- unbreak account expiration while here

additional testing by sebastia@@
@
text
@d1 4
a4 4
$OpenBSD$
--- lib/puppet/provider/user/openbsd.rb.orig	Mon Nov 10 21:38:00 2014
+++ lib/puppet/provider/user/openbsd.rb	Mon Nov 10 21:38:15 2014
@@@@ -0,0 +1,68 @@@@
a56 1
+  has_features :manages_passwords if Puppet.features.libshadow?
d58 3
@

