head	1.6;
access;
symbols
	OPENBSD_5_9:1.5.0.4
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.5.0.6
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.5.0.2
	OPENBSD_5_7_BASE:1.5
	OPENBSD_5_6:1.4.0.2
	OPENBSD_5_6_BASE:1.4
	OPENBSD_5_5:1.3.0.4
	OPENBSD_5_5_BASE:1.3
	OPENBSD_5_4:1.3.0.2
	OPENBSD_5_4_BASE:1.3
	OPENBSD_5_3:1.2.0.2
	OPENBSD_5_3_BASE:1.2
	OPENBSD_5_2:1.1.0.2
	OPENBSD_5_2_BASE:1.1;
locks; strict;
comment	@# @;


1.6
date	2016.03.01.18.44.17;	author mmcc;	state dead;
branches;
next	1.5;
commitid	mYfMIFHdh1ArE7Rt;

1.5
date	2014.09.17.14.39.20;	author espie;	state Exp;
branches;
next	1.4;
commitid	LSgg3nccxDngZzAW;

1.4
date	2014.07.04.12.20.32;	author sthen;	state Exp;
branches;
next	1.3;
commitid	Ucva53pxPSevfPF3;

1.3
date	2013.03.23.13.44.54;	author sthen;	state Exp;
branches;
next	1.2;

1.2
date	2012.12.18.21.38.12;	author sthen;	state Exp;
branches;
next	1.1;

1.1
date	2012.07.10.07.53.21;	author sthen;	state Exp;
branches;
next	;


desc
@@


1.6
log
@remove sysutils/toprump

ok lum@@, ajacoutot@@
@
text
@$OpenBSD: patch-machine_c,v 1.5 2014/09/17 14:39:20 espie Exp $
--- machine.c.orig	Fri May  4 07:24:08 2012
+++ machine.c	Wed Sep 17 08:38:07 2014
@@@@ -35,14 +35,16 @@@@
 
 #include <sys/types.h>
 #include <sys/param.h>
+#include <sys/sched.h>
+#include <sys/mount.h>
+#include <sys/proc.h>
+#include <sys/swap.h>
+#include <sys/sysctl.h>
+
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
 #include <unistd.h>
-#include <sys/sysctl.h>
-#include <sys/dkstat.h>
-#include <sys/mount.h>
-#include <sys/swap.h>
 #include <err.h>
 #include <errno.h>
 
@@@@ -215,10 +217,10 @@@@ void
 get_system_info(struct system_info *si)
 {
 	static int sysload_mib[] = {CTL_VM, VM_LOADAVG};
-	static int vmtotal_mib[] = {CTL_VM, VM_METER};
+	static int uvmexp_mib[] = {CTL_VM, VM_UVMEXP};
 	static int bcstats_mib[] = {CTL_VFS, VFS_GENERIC, VFS_BCACHESTAT};
 	struct loadavg sysload;
-	struct vmtotal vmtotal;
+	struct uvmexp uvmexp;
 	struct bcachestats bcstats;
 	double *infoloadp;
 	size_t size;
@@@@ -261,10 +263,10 @@@@ get_system_info(struct system_info *si)
 
 
 	/* get total -- systemwide main memory usage structure */
-	size = sizeof(vmtotal);
-	if (sysctl(vmtotal_mib, 2, &vmtotal, &size, NULL, 0) < 0) {
+	size = sizeof(uvmexp);
+	if (sysctl(uvmexp_mib, 2, &uvmexp, &size, NULL, 0) < 0) {
 		warn("sysctl failed");
-		bzero(&vmtotal, sizeof(vmtotal));
+		bzero(&uvmexp, sizeof(uvmexp));
 	}
 	size = sizeof(bcstats);
 	if (sysctl(bcstats_mib, 3, &bcstats, &size, NULL, 0) < 0) {
@@@@ -273,10 +275,10 @@@@ get_system_info(struct system_info *si)
 	}
 	/* convert memory stats to Kbytes */
 	memory_stats[0] = -1;
-	memory_stats[1] = pagetok(vmtotal.t_arm);
-	memory_stats[2] = pagetok(vmtotal.t_rm);
+	memory_stats[1] = pagetok(uvmexp.active);
+	memory_stats[2] = pagetok(uvmexp.npages - uvmexp.free);
 	memory_stats[3] = -1;
-	memory_stats[4] = pagetok(vmtotal.t_free);
+	memory_stats[4] = pagetok(uvmexp.free);
 	memory_stats[5] = -1;
 	memory_stats[6] = pagetok(bcstats.numbufpages);
 	memory_stats[7] = -1;
@@@@ -506,15 +508,9 @@@@ format_next_process(caddr_t handle, char *(*get_userid
 			pmondata.memsize = pagetok(PROCSIZE(pp)) / 1024.0;
 		}
 
-		if (pp->p_wchan) {
-			if (pp->p_wmesg)
-				p_wait = pp->p_wmesg;
-			else {
-				snprintf(waddr, sizeof(waddr), "%llx",
-				    (unsigned long long)(pp->p_wchan & ~KERNBASE));
-				p_wait = waddr;
-			}
-		} else
+		if (pp->p_wmesg[0])
+			p_wait = pp->p_wmesg;
+		else
 			p_wait = "-";
 
 		/* format this entry */
@


1.5
log
@dkstats.h
@
text
@d1 1
a1 1
$OpenBSD: patch-machine_c,v 1.4 2014/07/04 12:20:32 sthen Exp $
@


1.4
log
@sync with src/usr.bin/top/machine.c 1.77 ("Use VM_UVMEXP instead of VM_METER
for memory usages and directly include <sys/vmmeter.h> where it is needed
instead of relying on it being included by <uvm/uvm_extern.h>.")  ok lum@@
@
text
@d1 3
a3 3
$OpenBSD: patch-machine_c,v 1.3 2013/03/23 13:44:54 sthen Exp $
--- machine.c.orig	Fri Jul  4 12:36:19 2014
+++ machine.c	Fri Jul  4 12:36:22 2014
d8 1
a8 1
+#include <sys/dkstat.h>
@


1.3
log
@don't test wchan before printing wmesg, this can now only be done as root.
adapted from a base top(1) diff from tedu, ok lum@@
@
text
@d1 3
a3 3
$OpenBSD: patch-machine_c,v 1.2 2012/12/18 21:38:12 sthen Exp $
--- machine.c.orig	Fri May  4 14:24:08 2012
+++ machine.c	Sat Mar 23 10:55:29 2013
d25 41
@


1.2
log
@cope with sysctl.h changes
@
text
@d1 3
a3 3
$OpenBSD: patch-machine_c,v 1.1 2012/07/10 07:53:21 sthen Exp $
--- machine.c.orig	Fri May  4 07:24:08 2012
+++ machine.c	Thu Dec  6 15:26:14 2012
d25 9
a33 4
@@@@ -511,7 +513,7 @@@@ format_next_process(caddr_t handle, char *(*get_userid
 				p_wait = pp->p_wmesg;
 			else {
 				snprintf(waddr, sizeof(waddr), "%llx",
d35 9
a43 4
+				    (unsigned long long)pp->p_wchan);
 				p_wait = waddr;
 			}
 		} else
@


1.1
log
@sync with base to remove KERNBASE; ok lum@@
@
text
@d1 25
a25 4
$OpenBSD$
--- machine.c.orig	Tue Jul 10 08:21:51 2012
+++ machine.c	Tue Jul 10 08:22:32 2012
@@@@ -511,7 +511,7 @@@@ format_next_process(caddr_t handle, char *(*get_userid
@

