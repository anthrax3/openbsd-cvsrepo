head	1.10;
access;
symbols
	OPENBSD_4_4:1.9.0.12
	OPENBSD_4_4_BASE:1.9
	OPENBSD_4_3:1.9.0.10
	OPENBSD_4_3_BASE:1.9
	OPENBSD_4_2:1.9.0.8
	OPENBSD_4_2_BASE:1.9
	OPENBSD_4_1:1.9.0.6
	OPENBSD_4_1_BASE:1.9
	OPENBSD_4_0:1.9.0.4
	OPENBSD_4_0_BASE:1.9
	OPENBSD_3_9:1.9.0.2
	OPENBSD_3_9_BASE:1.9
	OPENBSD_3_8:1.7.0.10
	OPENBSD_3_8_BASE:1.7
	OPENBSD_3_7:1.7.0.8
	OPENBSD_3_7_BASE:1.7
	OPENBSD_3_6:1.7.0.6
	OPENBSD_3_6_BASE:1.7
	OPENBSD_3_5:1.7.0.4
	OPENBSD_3_5_BASE:1.7
	OPENBSD_3_4:1.7.0.2
	OPENBSD_3_4_BASE:1.7
	OPENBSD_3_3:1.3.0.6
	OPENBSD_3_3_BASE:1.3
	OPENBSD_3_2:1.3.0.4
	OPENBSD_3_2_BASE:1.3
	OPENBSD_3_1:1.3.0.2
	OPENBSD_3_1_BASE:1.3
	OPENBSD_3_0:1.1.1.1.0.2
	OPENBSD_3_0_BASE:1.1.1.1
	naddy_20010927:1.1.1.1
	naddy:1.1.1;
locks; strict;
comment	@# @;


1.10
date	2008.08.20.15.04.19;	author naddy;	state dead;
branches;
next	1.9;

1.9
date	2005.12.27.21.58.44;	author naddy;	state Exp;
branches;
next	1.8;

1.8
date	2005.11.22.18.36.00;	author naddy;	state Exp;
branches;
next	1.7;

1.7
date	2003.07.23.19.12.18;	author naddy;	state Exp;
branches;
next	1.6;

1.6
date	2003.05.17.19.39.31;	author naddy;	state Exp;
branches;
next	1.5;

1.5
date	2003.05.13.20.40.04;	author naddy;	state Exp;
branches;
next	1.4;

1.4
date	2003.05.12.21.54.32;	author naddy;	state Exp;
branches;
next	1.3;

1.3
date	2002.02.12.16.22.05;	author naddy;	state Exp;
branches;
next	1.2;

1.2
date	2002.01.22.23.19.50;	author naddy;	state Exp;
branches;
next	1.1;

1.1
date	2001.09.27.17.30.11;	author naddy;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2001.09.27.17.30.11;	author naddy;	state Exp;
branches;
next	;


desc
@@


1.10
log
@superseded by sysmerge(8)
@
text
@$OpenBSD: patch-mergemaster_sh,v 1.9 2005/12/27 21:58:44 naddy Exp $
--- mergemaster.sh.orig	Sun May 11 00:06:02 2003
+++ mergemaster.sh	Tue Dec 27 22:44:22 2005
@@@@ -10,7 +10,7 @@@@
 
 # $FreeBSD: mergemaster.sh,v 1.46 2003/05/03 06:35:19 dougb Exp $
 
-PATH=/bin:/usr/bin:/usr/sbin
+PATH=/bin:/usr/bin:/usr/sbin:@@LOCALBASE@@/bin
 
 display_usage () {
   VERSION_NUMBER=`grep "[$]FreeBSD:" $0 | cut -d ' ' -f 4`
@@@@ -224,10 +224,10 @@@@ press_to_continue () {
 #
 TEMPROOT='/var/tmp/temproot'
 
-# Read /etc/mergemaster.rc first so the one in $HOME can override
+# Read @@SYSCONFDIR@@/mergemaster.rc first so the one in $HOME can override
 #
-if [ -r /etc/mergemaster.rc ]; then
-  . /etc/mergemaster.rc
+if [ -r @@SYSCONFDIR@@/mergemaster.rc ]; then
+  . @@SYSCONFDIR@@/mergemaster.rc
 fi
 
 # Read .mergemasterrc before command line so CLI can override
@@@@ -404,7 +404,7 @@@@ fi
 
 # Define what CVS $Id tag to look for to aid portability.
 #
-CVS_ID_TAG=FreeBSD
+CVS_ID_TAG=OpenBSD
 
 delete_temproot () {
   rm -rf "${TEMPROOT}" 2>/dev/null
@@@@ -506,10 +506,7 @@@@ case "${RERUN}" in
       make DESTDIR=${DESTDIR} distrib-dirs
         ;;
       esac
-      make DESTDIR=${TEMPROOT} distrib-dirs &&
-      make MAKEOBJDIRPREFIX=${TEMPROOT}/usr/obj obj &&
-      make MAKEOBJDIRPREFIX=${TEMPROOT}/usr/obj DESTDIR=${TEMPROOT} \
-          distribution;} ||
+      make DESTDIR=${TEMPROOT} -DNOMAKEDEV distribution-etc-root-var;} ||
     { echo '';
      echo "  *** FATAL ERROR: Cannot 'cd' to ${SOURCEDIR} and install files to";
       echo "      the temproot environment";
@@@@ -555,11 +552,6 @@@@ case "${RERUN}" in
      ;;
   esac
 
-  # Avoid trying to update MAKEDEV if /dev is on a devfs
-  if /sbin/sysctl vfs.devfs.generation > /dev/null 2>&1 ; then
-    rm -f ${TEMPROOT}/dev/MAKEDEV ${TEMPROOT}/dev/MAKEDEV.local
-  fi
-
   ;; # End of the "RERUN" test
 esac
 
@@@@ -567,11 +559,8 @@@@ esac
 # or spwd.db.  Instead, we want to compare the text versions, and run *_mkdb.
 # Prompt the user to do so below, as needed.
 #
-rm -f ${TEMPROOT}/etc/*.db ${TEMPROOT}/etc/passwd
+rm -f ${TEMPROOT}/etc/*.db ${TEMPROOT}/etc/mail/*.db ${TEMPROOT}/etc/passwd
 
-# We only need to compare things like freebsd.cf once
-find ${TEMPROOT}/usr/obj -type f -delete 2>/dev/null
-
 # Get ready to start comparing files
 
 # Check umask if not specified on the command line,
@@@@ -605,50 +594,6 @@@@ fi
 
 CONFIRMED_UMASK=${NEW_UMASK:-0022}
 
-#
-# Warn users who still have old rc files
-#
-for file in atm devfs diskless1 diskless2 isdn network network6 pccard \
-  serial syscons sysctl alpha amd64 i386 ia64 sparc64; do
-  if [ -f "${DESTDIR}/etc/rc.${file}" ]; then
-    OLD_RC_PRESENT=1
-    break
-  fi
-done
-
-case "${OLD_RC_PRESENT}" in
-1)
-  echo ''
-  echo " *** There are elements of the old rc system in ${DESTDIR}/etc/."
-  echo ''
-  echo '     While these scripts will not hurt anything, they are not'
-  echo '     functional on an up to date system, and can be removed.'
-  echo ''
-
-  case "${AUTO_RUN}" in
-  '')
-    echo -n 'Move these files to /var/tmp/mergemaster/old_rc? [yes] '
-    read MOVE_OLD_RC
-
-    case "${MOVE_OLD_RC}" in
-    [nN]*) ;;
-    *)
-      mkdir -p /var/tmp/mergemaster/old_rc
-        for file in atm devfs diskless1 diskless2 isdn network network6 pccard \
-          serial syscons sysctl alpha amd64 i386 ia64 sparc64; do
-          if [ -f "${DESTDIR}/etc/rc.${file}" ]; then
-            mv ${DESTDIR}/etc/rc.${file} /var/tmp/mergemaster/old_rc/
-          fi
-        done
-      echo '  The files have been moved'
-      press_to_continue
-      ;;
-    esac
-    ;;
-  *) ;;
-  esac
-esac
-
 # Use the umask/mode information to install the files
 # Create directories as needed
 #
@@@@ -666,12 +611,8 @@@@ do_install_and_rm () {
   rm -f "${2}"
 }
 
-# 4095 = "obase=10;ibase=8;07777" | bc
 find_mode () {
-  local OCTAL
-  OCTAL=$(( ~$(echo "obase=10; ibase=8; ${CONFIRMED_UMASK}" | bc) & 4095 &
-    $(echo "obase=10; ibase=8; $(stat -f "%OMp%OLp" ${1})" | bc) )) 
-  printf "%04o\n" ${OCTAL}
+  perl -e 'printf "%04o\n", (((stat("$ARGV[0]"))[2] & 07777) &~ oct("$ARGV[1]"))' "${1}" "${CONFIRMED_UMASK}"
 }
 
 mm_install () {
@@@@ -698,65 +639,17 @@@@ mm_install () {
       NEED_NEWALIASES=yes
       ;;
     /etc/login.conf)
-      NEED_CAP_MKDB=yes
+      if [ -f /etc/login.conf.db ]; then
+        NEED_CAP_MKDB=yes
+      fi
       ;;
     /etc/master.passwd)
       do_install_and_rm 600 "${1}" "${DESTDIR}${INSTALL_DIR}"
       NEED_PWD_MKDB=yes
       DONT_INSTALL=yes
       ;;
-    /.cshrc | /.profile)
-    case "${AUTO_INSTALL}" in
-    '')
-      case "${LINK_EXPLAINED}" in
-      '')
-        echo "   *** Historically BSD derived systems have had a"
-        echo "       hard link from /.cshrc and /.profile to"
-        echo "       their namesakes in /root.  Please indicate"
-        echo "       your preference below for bringing your"
-        echo "       installed files up to date."
-        echo ''
-        LINK_EXPLAINED=yes
-        ;;
-      esac
-
-      echo "   Use 'd' to delete the temporary ${COMPFILE}"
-      echo "   Use 'l' to delete the existing ${DESTDIR}${COMPFILE#.} and create the link"
-      echo ''
-      echo "   Default is to leave the temporary file to deal with by hand"
-      echo ''
-      echo -n "  How should I handle ${COMPFILE}? [Leave it to install later] "
-      read HANDLE_LINK
-      ;;
-    *)  # Part of AUTO_INSTALL
-      HANDLE_LINK=l
-      ;;
     esac
 
-      case "${HANDLE_LINK}" in
-      [dD]*)
-        rm "${COMPFILE}"
-        echo ''
-        echo "   *** Deleting ${COMPFILE}"
-        ;;
-      [lL]*)
-        echo ''
-        rm -f "${DESTDIR}${COMPFILE#.}"
-        if ln "${DESTDIR}/root/${COMPFILE##*/}" "${DESTDIR}${COMPFILE#.}"; then
-          echo "   *** Link from ${DESTDIR}${COMPFILE#.} to ${DESTDIR}/root/${COMPFILE##*/} installed successfully"
-          rm "${COMPFILE}"
-        else
-          echo "   *** Error linking ${DESTDIR}${COMPFILE#.} to ${DESTDIR}/root/${COMPFILE##*/}, ${COMPFILE} will remain to install by hand"
-        fi
-        ;;
-      *)
-        echo "   *** ${COMPFILE} will remain for your consideration"
-        ;;
-      esac
-      DONT_INSTALL=yes
-      ;;
-    esac
-
     case "${DONT_INSTALL}" in
     '')
       do_install_and_rm "${FILE_MODE}" "${1}" "${DESTDIR}${INSTALL_DIR}"
@@@@ -1015,47 +908,27 @@@@ fi
 case "${COMP_CONFS}" in
 '') ;;
 *)
-  . ${DESTDIR}/etc/defaults/rc.conf
+  . ${DESTDIR}/rc.conf
 
   (echo ''
-  echo "*** Comparing conf files: ${rc_conf_files}"
+  echo "*** Comparing conf files: ${local_rcconf}"
 
-  for CONF_FILE in ${rc_conf_files}; do
+  for CONF_FILE in ${local_rcconf}; do
     if [ -r "${DESTDIR}${CONF_FILE}" ]; then
       echo ''
       echo "*** From ${DESTDIR}${CONF_FILE}"
-      echo "*** From ${DESTDIR}/etc/defaults/rc.conf"
+      echo "*** From ${DESTDIR}/etc/rc.conf"
 
       for RC_CONF_VAR in `grep -i ^[a-z] ${DESTDIR}${CONF_FILE} |
         cut -d '=' -f 1`; do
         echo ''
         grep -w ^${RC_CONF_VAR} ${DESTDIR}${CONF_FILE}
-        grep -w ^${RC_CONF_VAR} ${DESTDIR}/etc/defaults/rc.conf ||
+        grep -w ^${RC_CONF_VAR} ${DESTDIR}/etc/rc.conf ||
           echo ' * No default variable with this name'
       done
     fi
   done) | ${PAGER}
   echo ''
-  ;;
-esac
-
-case "${PRE_WORLD}" in
-'') ;;
-*)
-  MAKE_CONF="${SOURCEDIR%etc}share/examples/etc/make.conf"
-
-  (echo ''
-  echo '*** Comparing make variables'
-  echo ''
-  echo "*** From ${DESTDIR}/etc/make.conf"
-  echo "*** From ${MAKE_CONF}"
-
-  for MAKE_VAR in `grep -i ^[a-z] ${DESTDIR}/etc/make.conf | cut -d '=' -f 1`; do
-    echo ''
-    grep -w ^${MAKE_VAR} ${DESTDIR}/etc/make.conf
-    grep -w ^#${MAKE_VAR} ${MAKE_CONF} ||
-      echo ' * No example variable with this name'
-  done) | ${PAGER}
   ;;
 esac
 
@


1.9
log
@use system sdiff, drop GNU diff dependency
@
text
@d1 1
a1 1
$OpenBSD: patch-mergemaster_sh,v 1.8 2005/11/22 18:36:00 naddy Exp $
@


1.8
log
@/.profile and /.cshrc have stopped being hard links, don't special case
@
text
@d1 1
a1 1
$OpenBSD: patch-mergemaster_sh,v 1.7 2003/07/23 19:12:18 naddy Exp $
d3 1
a3 1
+++ mergemaster.sh	Tue Nov 22 16:20:13 2005
a12 9
@@@@ -59,7 +59,7 @@@@ merge_loop () {
   while [ "${MERGE_AGAIN}" = "yes" ]; do
     # Prime file.merged so we don't blat the owner/group id's
     cp -p "${COMPFILE}" "${COMPFILE}.merged"
-    sdiff -o "${COMPFILE}.merged" --text --suppress-common-lines \
+    gsdiff -o "${COMPFILE}.merged" --text --suppress-common-lines \
       --width=${SCREEN_WIDTH:-80} "${DESTDIR}${COMPFILE#.}" "${COMPFILE}"
     INSTALL_MERGED=V
     while [ "${INSTALL_MERGED}" = "v" -o "${INSTALL_MERGED}" = "V" ]; do
@


1.7
log
@sdiff is gone, but we still need it
@
text
@d1 1
a1 1
$OpenBSD: patch-mergemaster_sh,v 1.6 2003/05/17 19:39:31 naddy Exp $
d3 1
a3 1
+++ mergemaster.sh	Wed Jul 23 02:40:22 2003
d69 1
a69 1
@@@@ -567,10 +559,7 @@@@ esac
d74 2
a75 1
-
d78 1
a78 2
+rm -f ${TEMPROOT}/etc/*.db ${TEMPROOT}/etc/mail/*.db ${TEMPROOT}/etc/passwd
 
d81 1
d147 1
a147 1
@@@@ -698,7 +639,9 @@@@ mm_install () {
d158 59
a216 1
@@@@ -1015,47 +958,27 @@@@ fi
@


1.6
log
@install files with proper permissions (was 000 before); from grange@@
@
text
@d1 35
a35 3
$OpenBSD: patch-mergemaster_sh,v 1.5 2003/05/13 20:40:04 naddy Exp $
--- mergemaster.sh.orig	Sat May 10 16:06:02 2003
+++ mergemaster.sh	Sat May 17 13:22:34 2003
@


1.5
log
@Oops.  Fix a fatal typo and ignore aliases.db.
@
text
@d1 1
a1 1
$OpenBSD: patch-mergemaster_sh,v 1.4 2003/05/12 21:54:32 naddy Exp $
d3 1
a3 1
+++ mergemaster.sh	Tue May 13 11:58:38 2003
d100 1
a100 1
@@@@ -666,12 +611,9 @@@@ do_install_and_rm () {
d110 1
a110 2
+  perl -e 'printf "%04o\n", (((stat("$ARGV[0]"))[2] & 07777) &~ \
+    oct("$ARGV[1]"))' "${1}" "${CONFIRMED_UMASK}"
d114 1
a114 1
@@@@ -698,7 +640,9 @@@@ mm_install () {
d125 1
a125 1
@@@@ -1015,47 +959,27 @@@@ fi
@


1.4
log
@Catch up with 14 months worth of changes in the FreeBSD version.
@
text
@d1 1
a1 1
$OpenBSD: patch-mergemaster_sh,v 1.3 2002/02/12 16:22:05 naddy Exp $
d3 1
a3 1
+++ mergemaster.sh	Sat May 10 18:30:36 2003
d37 3
a39 1
@@@@ -569,9 +561,6 @@@@ esac
d41 2
a42 2
 rm -f ${TEMPROOT}/etc/*.db ${TEMPROOT}/etc/passwd
 
d45 2
a46 1
-
a48 1
 # Check umask if not specified on the command line,
d111 1
a111 1
+    oct("$ARGV[1]"))' "${1}" "${CONFIRMED_UMASK}"`
@


1.3
log
@Update to 1.26: Upstream integration of CVSID fix, minor cosmetics.
@
text
@d1 4
a4 4
$OpenBSD: patch-mergemaster_sh,v 1.2 2002/01/22 23:19:50 naddy Exp $
--- mergemaster.sh.orig	Tue Feb 12 14:28:36 2002
+++ mergemaster.sh	Tue Feb 12 14:45:12 2002
@@@@ -354,7 +354,7 @@@@ SOURCEDIR=${SOURCEDIR:-/usr/src/etc}
d11 3
a13 3
 case "${RERUN}" in
 '')
@@@@ -450,10 +450,7 @@@@ case "${RERUN}" in
d15 11
a25 11
       ;;
     esac
-    make DESTDIR=${TEMPROOT} distrib-dirs &&
-    make MAKEOBJDIRPREFIX=${TEMPROOT}/usr/obj obj &&
-    make MAKEOBJDIRPREFIX=${TEMPROOT}/usr/obj DESTDIR=${TEMPROOT} \
-        -DNO_MAKEDEV_RUN distribution;} ||
+    make DESTDIR=${TEMPROOT} -DNOMAKEDEV distribution-etc-root-var;} ||
   { echo '';
     echo "  *** FATAL ERROR: Cannot 'cd' to ${SOURCEDIR} and install files to";
     echo "      the temproot environment";
@@@@ -491,11 +488,6 @@@@ case "${RERUN}" in
d31 1
a31 1
-    rm ${TEMPROOT}/dev/MAKEDEV ${TEMPROOT}/dev/MAKEDEV.local
d37 3
a39 5
@@@@ -506,6 +498,7 @@@@ esac
 [ -f "${TEMPROOT}/etc/spwd.db" ] && rm "${TEMPROOT}/etc/spwd.db"
 [ -f "${TEMPROOT}/etc/passwd" ]  && rm "${TEMPROOT}/etc/passwd"
 [ -f "${TEMPROOT}/etc/pwd.db" ]  && rm "${TEMPROOT}/etc/pwd.db"
+[ -f "${TEMPROOT}/etc/mail/aliases.db" ] && rm "${TEMPROOT}/etc/mail/aliases.db"
d41 3
d45 131
@


1.2
log
@* fix a long-standing bug where files without RCS Ids wouldn't be compared;
  pointed out by brad@@
* mention in man page that -r can be used with etcXX.tgz; from ian@@
@
text
@d1 4
a4 4
$OpenBSD: patch-mergemaster_sh,v 1.1.1.1 2001/09/27 17:30:11 naddy Exp $
--- mergemaster.sh.orig	Thu Sep 27 16:20:58 2001
+++ mergemaster.sh	Tue Jan 22 23:59:13 2002
@@@@ -351,7 +351,7 @@@@ SOURCEDIR=${SOURCEDIR:-/usr/src/etc}
d13 1
a13 1
@@@@ -447,10 +447,7 @@@@ case "${RERUN}" in
d25 1
a25 1
@@@@ -488,11 +485,6 @@@@ case "${RERUN}" in
d37 1
a37 1
@@@@ -503,6 +495,7 @@@@ esac
a44 11
@@@@ -730,8 +723,8 @@@@ for COMPFILE in `find . -type f -size +0
     # If the files have the same $Id, delete the one in temproot so the
     # user will have less to wade through if files are left to merge by hand.
     #
-    CVSID1=`grep "[$]${CVS_ID_TAG}:" ${DESTDIR}${COMPFILE#.} 2>/dev/null`
-    CVSID2=`grep "[$]${CVS_ID_TAG}:" ${COMPFILE} 2>/dev/null`
+    CVSID1=`grep "[$]${CVS_ID_TAG}:" ${DESTDIR}${COMPFILE#.} 2>/dev/null` &&
+    CVSID2=`grep "[$]${CVS_ID_TAG}:" ${COMPFILE} 2>/dev/null` || CVSID1=no
 
     case "${CVSID2}" in
     "${CVSID1}")
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
$OpenBSD$
d3 1
a3 1
+++ mergemaster.sh	Thu Sep 27 19:18:53 2001
d45 11
@


1.1.1.1
log
@Import mergemaster 1.25.

The mergemaster script is designed to aid you during a system upgrade
in updating the various configuration and other files associated
with OpenBSD.
@
text
@@
