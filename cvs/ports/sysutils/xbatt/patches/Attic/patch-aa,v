head	1.3;
access;
symbols
	OPENBSD_4_2:1.2.0.30
	OPENBSD_4_2_BASE:1.2
	OPENBSD_4_1:1.2.0.28
	OPENBSD_4_1_BASE:1.2
	OPENBSD_4_0:1.2.0.26
	OPENBSD_4_0_BASE:1.2
	OPENBSD_3_9:1.2.0.24
	OPENBSD_3_9_BASE:1.2
	OPENBSD_3_8:1.2.0.22
	OPENBSD_3_8_BASE:1.2
	OPENBSD_3_7:1.2.0.20
	OPENBSD_3_7_BASE:1.2
	OPENBSD_3_6:1.2.0.18
	OPENBSD_3_6_BASE:1.2
	OPENBSD_3_5:1.2.0.16
	OPENBSD_3_5_BASE:1.2
	OPENBSD_3_4:1.2.0.14
	OPENBSD_3_4_BASE:1.2
	OPENBSD_3_3:1.2.0.12
	OPENBSD_3_3_BASE:1.2
	OPENBSD_3_2:1.2.0.10
	OPENBSD_3_2_BASE:1.2
	OPENBSD_3_1:1.2.0.8
	OPENBSD_3_1_BASE:1.2
	OPENBSD_3_0:1.2.0.6
	OPENBSD_3_0_BASE:1.2
	OPENBSD_2_9_TRACKING_SWITCH:1.2
	OPENBSD_2_9:1.2.0.4
	OPENBSD_2_9_BASE:1.2
	OPENBSD_2_8:1.2.0.2
	OPENBSD_2_8_BASE:1.2
	OPENBSD_2_7:1.1.1.1.0.8
	OPENBSD_2_7_BASE:1.1.1.1
	OPENBSD_2_6:1.1.1.1.0.6
	OPENBSD_2_6_BASE:1.1.1.1
	OPENBSD_2_5:1.1.1.1.0.4
	OPENBSD_2_5_BASE:1.1.1.1
	OPENBSD_2_4:1.1.1.1.0.2
	OPENBSD_2_4_BASE:1.1.1.1
	NIKLAS_980722:1.1.1.1
	NIKLAS:1.1.1;
locks; strict;
comment	@# @;


1.3
date	2007.10.26.23.54.56;	author ajacoutot;	state dead;
branches;
next	1.2;

1.2
date	2000.06.21.03.11.18;	author kevlo;	state Exp;
branches;
next	1.1;

1.1
date	98.07.21.14.36.02;	author niklas;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	98.07.21.14.36.02;	author niklas;	state Exp;
branches
	1.1.1.1.8.1;
next	;

1.1.1.1.8.1
date	2000.09.15.05.18.31;	author marc;	state Exp;
branches;
next	;


desc
@@


1.3
log
@- use our naming scheme for patches
@
text
@--- xbatt.c.orig	Wed Jun 21 18:58:25 2000
+++ xbatt.c	Wed Jun 21 19:02:20 2000
@@@@ -65,6 +65,11 @@@@
 # define APMDEV22	"/dev/apm"
 #endif
 
+#ifdef __OpenBSD__
+# include <machine/apmvar.h>
+# define APMDEV                "/dev/apm"
+#endif /* __OpenBSD__ */
+
 #include "pixmaps/battery.xpm"
 #include "pixmaps/unknown.xpm"
 #include "bitmaps/full.xbm"
@@@@ -195,6 +200,12 @@@@
     }
 #endif
 
+#ifdef __OpenBSD__
+     /* initialize APM Interface */
+     if ((apmfd = open(APMDEV, O_RDONLY)) == -1)
+	err(1, "cannot open apm device");
+#endif /* __OpenBSD__ */
+
     /* start X-Window session */
     XtSetLanguageProc( NULL, NULL, NULL );
     toplevel = XtOpenApplication(&appContext, "XBatt",
@@@@ -371,6 +382,50 @@@@
 						/* chrging or not.	*/
     }
 #endif	/* FreeBSD */
+
+#ifdef __OpenBSD__
+    struct apm_power_info info;
+
+    if (ioctl(apmfd, APM_IOC_GETPOWER, &info) == -1)
+      err(1, "ioctl APM_IOC_GETPOWER failed");
+
+    /* get current status */
+    if (info.battery_life == APM_BATT_LIFE_UNKNOWN) {
+       switch (info.battery_state) {
+         case APM_BATT_HIGH:
+           ret.remain = 100;
+           break;
+         case APM_BATT_LOW:
+           ret.remain = 40;
+           break;
+         case APM_BATT_CRITICAL:
+           ret.remain = 10;
+           break;
+         default:        /* expected to be APM_STAT_UNKNOWN */
+           ret.remain = APM_STAT_UNKNOWN;
+       }
+    } else if (info.battery_life > 100) {
+       /* some APM BIOSes return values slightly > 100 */
+       ret.remain = 100;
+    } else {
+       ret.remain = info.battery_life;
+    }
+
+    /* get AC-line status */
+    if (info.ac_state == APM_AC_ON) {
+       ret.acline = APM_STAT_LINE_ON;
+    } else {
+       ret.acline = APM_STAT_LINE_OFF;
+    }
+
+    /* get charging status */
+    if (info.battery_state == APM_BATT_CHARGING) {
+       ret.charge = APM_STAT_BATT_CHARGING;
+    } else {
+       ret.charge = APM_STAT_BATT_HIGH;        /* I only want to know, */
+                                               /* chrging or not.      */
+    }
+#endif /* __OpenBSD__ */
 
 #ifdef	__linux__
     char	buffer[64];
@


1.2
log
@- Upgrade to version 1.2.1
- Clean up the Makefile
- Add @@comment to PLIST
@
text
@@


1.1
log
@Initial revision
@
text
@d1 3
a3 3
--- xbatt.c.orig	Tue Jan 21 15:21:27 1997
+++ xbatt.c	Tue Jul 21 15:24:07 1998
@@@@ -64,6 +64,11 @@@@
d9 1
a9 1
+# define APMDEV		"/dev/apm"
d15 1
a15 1
@@@@ -193,6 +198,12 @@@@
d20 2
a21 2
+    /* initialize APM Interface */
+    if ((apmfd = open(APMDEV, O_RDONLY)) == -1)
d28 1
a28 1
@@@@ -369,6 +380,50 @@@@
d41 13
a53 13
+	switch (info.battery_state) {
+	  case APM_BATT_HIGH:
+	    ret.remain = 100;
+	    break;
+	  case APM_BATT_LOW:
+	    ret.remain = 40;
+	    break;
+	  case APM_BATT_CRITICAL:
+	    ret.remain = 10;
+	    break;
+	  default:        /* expected to be APM_STAT_UNKNOWN */
+	    ret.remain = APM_STAT_UNKNOWN;
+	}
d55 2
a56 2
+	/* some APM BIOSes return values slightly > 100 */
+	ret.remain = 100;
d58 1
a58 1
+	ret.remain = info.battery_life;
d63 1
a63 1
+	ret.acline = APM_STAT_LINE_ON;
d65 1
a65 1
+	ret.acline = APM_STAT_LINE_OFF;
d70 1
a70 1
+	ret.charge = APM_STAT_BATT_CHARGING;
d72 2
a73 2
+	ret.charge = APM_STAT_BATT_HIGH;	/* I only want to know,	*/
+						/* chrging or not.	*/
@


1.1.1.1
log
@xbatt port adapted from FreeBSD, shows APM battery state as an X11 icon
@
text
@@


1.1.1.1.8.1
log
@bring sysutils as of cut-over date into 2.7 branch
@
text
@d1 3
a3 3
--- xbatt.c.orig	Wed Jun 21 18:58:25 2000
+++ xbatt.c	Wed Jun 21 19:02:20 2000
@@@@ -65,6 +65,11 @@@@
d9 1
a9 1
+# define APMDEV                "/dev/apm"
d15 1
a15 1
@@@@ -195,6 +200,12 @@@@
d20 2
a21 2
+     /* initialize APM Interface */
+     if ((apmfd = open(APMDEV, O_RDONLY)) == -1)
d28 1
a28 1
@@@@ -371,6 +382,50 @@@@
d41 13
a53 13
+       switch (info.battery_state) {
+         case APM_BATT_HIGH:
+           ret.remain = 100;
+           break;
+         case APM_BATT_LOW:
+           ret.remain = 40;
+           break;
+         case APM_BATT_CRITICAL:
+           ret.remain = 10;
+           break;
+         default:        /* expected to be APM_STAT_UNKNOWN */
+           ret.remain = APM_STAT_UNKNOWN;
+       }
d55 2
a56 2
+       /* some APM BIOSes return values slightly > 100 */
+       ret.remain = 100;
d58 1
a58 1
+       ret.remain = info.battery_life;
d63 1
a63 1
+       ret.acline = APM_STAT_LINE_ON;
d65 1
a65 1
+       ret.acline = APM_STAT_LINE_OFF;
d70 1
a70 1
+       ret.charge = APM_STAT_BATT_CHARGING;
d72 2
a73 2
+       ret.charge = APM_STAT_BATT_HIGH;        /* I only want to know, */
+                                               /* chrging or not.      */
@

