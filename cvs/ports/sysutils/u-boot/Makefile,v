head	1.19;
access;
symbols
	OPENBSD_6_1:1.19.0.2
	OPENBSD_6_1_BASE:1.19
	OPENBSD_6_0:1.3.0.2
	OPENBSD_6_0_BASE:1.3
	jsg_20160529:1.1.1.1
	jsg:1.1.1;
locks; strict;
comment	@# @;


1.19
date	2017.03.14.13.40.31;	author jsg;	state Exp;
branches;
next	1.18;
commitid	esZfOpiULURq8eNg;

1.18
date	2017.03.05.16.28.14;	author jsg;	state Exp;
branches;
next	1.17;
commitid	6CvfHKL8tpWkf5aU;

1.17
date	2017.03.03.23.46.25;	author jsg;	state Exp;
branches;
next	1.16;
commitid	XJhIYQupSfskBisk;

1.16
date	2017.03.03.03.27.28;	author jsg;	state Exp;
branches;
next	1.15;
commitid	OSmUpkAWFQxuSM5l;

1.15
date	2017.02.18.12.10.50;	author jca;	state Exp;
branches;
next	1.14;
commitid	cNSI5v9kd819pUQd;

1.14
date	2017.02.10.00.02.45;	author jsg;	state Exp;
branches;
next	1.13;
commitid	CFXa42gcEh253T47;

1.13
date	2017.01.10.02.35.52;	author jsg;	state Exp;
branches;
next	1.12;
commitid	xJKBB2nDTUANekIM;

1.12
date	2017.01.08.14.49.18;	author jsg;	state Exp;
branches;
next	1.11;
commitid	AXAVeFrWfSGJ9DPF;

1.11
date	2016.12.11.14.08.38;	author patrick;	state Exp;
branches;
next	1.10;
commitid	zYBS7QFtr0N3LcvF;

1.10
date	2016.11.20.01.47.00;	author jsg;	state Exp;
branches;
next	1.9;
commitid	G0Ahrz7iXYG44YAS;

1.9
date	2016.11.01.04.13.52;	author jsg;	state Exp;
branches;
next	1.8;
commitid	mWAWEl7Wk8THJwFW;

1.8
date	2016.10.30.04.16.34;	author jsg;	state Exp;
branches;
next	1.7;
commitid	BrsGlimLpCrs7QbF;

1.7
date	2016.09.14.05.52.25;	author jsg;	state Exp;
branches;
next	1.6;
commitid	IxhhMkFIAZWITaCs;

1.6
date	2016.08.06.08.07.51;	author jsg;	state Exp;
branches;
next	1.5;
commitid	Tav8CNJfHpo3msHO;

1.5
date	2016.08.06.06.40.05;	author landry;	state Exp;
branches;
next	1.4;
commitid	KiqqSq4JYJLTMSHL;

1.4
date	2016.07.30.14.22.19;	author jsg;	state Exp;
branches;
next	1.3;
commitid	dk5OltKDeWXMfhC4;

1.3
date	2016.07.12.12.35.44;	author jsg;	state Exp;
branches;
next	1.2;
commitid	eIlHYyCivBqIyTDE;

1.2
date	2016.06.18.03.04.44;	author jsg;	state Exp;
branches;
next	1.1;
commitid	dbQLxAcI1nQ8ksjA;

1.1
date	2016.05.29.01.35.33;	author jsg;	state Exp;
branches
	1.1.1.1;
next	;
commitid	bmQeGNtjT62xSFTz;

1.1.1.1
date	2016.05.29.01.35.33;	author jsg;	state Exp;
branches;
next	;
commitid	bmQeGNtjT62xSFTz;


desc
@@


1.19
log
@update to u-boot 2017.03
@
text
@#	$OpenBSD: Makefile,v 1.18 2017/03/05 16:28:14 jsg Exp $

BROKEN-sparc64=	Error: the specified option is not accepted in ISB at operand 1 -- isb sy

FLAVORS=	aarch64 arm
FLAVOR?=	arm

COMMENT=	U-Boot firmware
VERSION=	2017.03
DISTNAME=	u-boot-${VERSION}
PKGNAME=	u-boot-${FLAVOR}-${VERSION:S/-//}
FULLPKGNAME=	${PKGNAME}
CATEGORIES=	sysutils
HOMEPAGE=	http://www.denx.de/wiki/U-Boot
MAINTAINER=	Jonathan Gray <jsg@@openbsd.org>

# GPLv2
PERMIT_PACKAGE_CDROM=	Yes

MASTER_SITES=	ftp://ftp.denx.de/pub/u-boot/
EXTRACT_SUFX=	.tar.bz2
PKG_ARCH=	*

BUILD_DEPENDS=	devel/dtc \
		devel/swig
MAKE_ENV=	KBUILD_VERBOSE=1

MODULES=	lang/python
MODPY_RUNDEP=	No
MODPY_ADJ_FILES=tools/binman/binman

.if "${FLAVOR}" == "aarch64"
BUILD_DEPENDS+=	devel/arm-none-eabi/gcc-linaro,aarch64
MAKE_ENV+=	CROSS_COMPILE="aarch64-none-elf-"
.elif "${FLAVOR}" == "arm"
BUILD_DEPENDS+=	devel/arm-none-eabi/gcc-linaro
MAKE_ENV+=	CROSS_COMPILE="arm-none-eabi-"
.endif

USE_GMAKE=	Yes
NO_TEST=	Yes

.if "${FLAVOR}" == "aarch64"
BOARDS=\
	dragonboard410c \
	pine64_plus \
	rpi_3
.elif "${FLAVOR}" == "arm"
OMAP=\
	omap3_beagle \
	omap4_panda \
	am335x_boneblack \
	am57xx_evm
SUNXI=\
	A10-OLinuXino-Lime \
	A10s-OLinuXino-M \
	A20-OLinuXino-Lime \
	A20-OLinuXino-Lime2 \
	A20-OLinuXino_MICRO \
	Bananapi \
	Bananapro \
	CHIP \
	Cubieboard \
	Cubieboard2 \
	Cubieboard4 \
	Cubietruck \
	Lamobo_R1 \
	Linksprite_pcDuino \
	Linksprite_pcDuino3 \
	Linksprite_pcDuino3_Nano \
	nanopi_neo \
	Orangepi \
	Orangepi_mini \
	orangepi_2 \
	orangepi_lite \
	orangepi_one \
	orangepi_pc \
	orangepi_pc_plus \
	orangepi_plus \
	orangepi_plus2e \
	orangepi_zero \
	Sinovoip_BPI_M2_plus
IMX=\
	cm_fx6 \
	mx6cuboxi \
	mx6qsabrelite \
	nitrogen6q \
	novena \
	riotboard \
	udoo \
	usbarmory \
	wandboard
BOARDS=\
	${OMAP} \
	${SUNXI} \
	${IMX} \
	rpi_2 \
	rpi_3_32b \
	vexpress_ca15_tc2 \
	vexpress_ca9x4
.endif

FILES=\
	MLO \
	SPL \
	u-boot \
	u-boot.img \
	u-boot.bin \
	u-boot-sunxi-with-spl.bin \
	u-boot.imx \
	u-boot-spl.kwb

pre-build:
	${SUBST_CMD} ${WRKBUILD}/tools/Makefile

do-build:
.for BOARD in ${BOARDS}
	cd ${WRKSRC} && \
	    mkdir -p build/${BOARD} && \
	    ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} \
	        O="build/${BOARD}" \
	        -f ${MAKE_FILE} "${BOARD}"_defconfig && \
	    ${SETENV} ${MAKE_ENV} ${MAKE_PROGRAM} ${MAKE_FLAGS} \
	        O="build/${BOARD}" \
	        -f ${MAKE_FILE} ${ALL_TARGET}
.endfor

do-install:
	${INSTALL_DATA_DIR} ${PREFIX}/share/u-boot
.for BOARD in ${BOARDS}
	${INSTALL_DATA_DIR} ${PREFIX}/share/u-boot/${BOARD}
	-cd ${WRKSRC}/build/${BOARD} && \
	    cp ${FILES} ${PREFIX}/share/u-boot/${BOARD}/
.endfor

.include <bsd.port.mk>
@


1.18
log
@Strip the hyphen in the distname version from the package name.
espie and naddy directed me to packages-specs(7), an rc suffix
is allowed only if there is no hyphen.

This commit doesn't include bumping EPOCH, but that may be needed.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.17 2017/03/03 23:46:25 jsg Exp $
d9 1
a9 2
VERSION=	2017.03-rc3
REVISION=	0
@


1.17
log
@Fix build when swig is installed.

Patch out 'python' in a Makefile for ${MODPY_BIN} and add swig to
BUILD_DEPENDS so any related problems will be caught in future.

Problem reported by naddy and espie.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.16 2017/03/03 03:27:28 jsg Exp $
d12 1
a12 1
PKGNAME=	u-boot-${FLAVOR}-${VERSION}
@


1.16
log
@update u-boot to 2017.03-rc3

Fixes data aborts reported by Daniel Bolgheroni when reading a dtb off
mmc on two different allwinner systems (Banana Pi and Orange Pi One)
with 2017.01.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.15 2017/02/18 12:10:50 jca Exp $
d10 1
d25 2
a26 1
BUILD_DEPENDS=	devel/dtc
d113 3
@


1.15
log
@BROKEN on sparc64
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.14 2017/02/10 00:02:45 jsg Exp $
d9 1
a9 2
VERSION=	2017.01
REVISION=	0
d80 1
@


1.14
log
@Set MODPY_RUNDEP=No to avoid a RUN_DEPENDS on python.
@
text
@d1 3
a3 1
#	$OpenBSD: Makefile,v 1.13 2017/01/10 02:35:52 jsg Exp $
@


1.13
log
@Update to U-Boot 2017.01 and add/build a Sinovoip BPI-M2+ target
from kettenis along with a patch to remove use of a gnu sed
extension in a build command.

Tested on CuBox-i4Pro, BeagleBone Black and PandaBoard ES.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.12 2017/01/08 14:49:18 jsg Exp $
d8 1
d27 1
@


1.12
log
@Build some additional targets.
All of the Xunlong Orange Pi configs (Allwinner A20 and H3)
FriendlyARM NanoPi NEO (Allwinner H3)
Inverse Path USB Armory (Freescale/NXP i.MX53)

Discussed with kettenis.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.11 2016/12/11 14:08:38 patrick Exp $
d7 1
a7 1
VERSION=	2016.11
a10 1
REVISION=	1
d25 3
d76 2
a77 1
	orangepi_plus2e
@


1.11
log
@Split sysutils/u-boot into two FLAVORs so that we can use the same
port to compile 32- and 64-bit ARM u-boots.

ok and with help from jsg@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.10 2016/11/20 01:47:00 jsg Exp $
d11 1
a11 1
REVISION=	0
d43 1
a43 1
BOARDS=\
d47 2
a48 1
	am57xx_evm \
d65 11
d83 6
a88 1
	wandboard \
@


1.10
log
@update to u-boot 2016.11 and enable new Cubieboard4 target

Tested on cubox, panda and bbb.
@
text
@d1 4
a4 1
#	$OpenBSD: Makefile,v 1.9 2016/11/01 04:13:52 jsg Exp $
d7 5
a11 1
DISTNAME=	u-boot-2016.11
d23 11
a33 3
BUILD_DEPENDS=	devel/arm-none-eabi/gcc-linaro \
		devel/dtc
MAKE_ENV+=	CROSS_COMPILE="arm-none-eabi-" KBUILD_VERBOSE=1
d37 6
d76 1
@


1.9
log
@disable the clearfog target until kwbimage is fixed

There is a use after free in kwbimage, found by building u-boot with the
use after free detection enabled in malloc.  When building the clearfog target:

  MKIMAGE u-boot-spl.kwb
Segmentation fault (core dumped)

kwbimage_generate -> image_version_file (alloc and free image_cfg global)
kwbimage_generate -> image_headersz_v1 -> image_count_options (image_cfg used)

It isn't clear to me if image_version_file should be inlined or another
approach taken, but as it stands it is clearly wrong.

The result of image_version_file is also never checked for -1 which multiple
paths in the function return.

I reported this on the u-boot list a week or so ago but no one has responded
so far.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.8 2016/10/30 04:16:34 jsg Exp $
d4 1
a4 2
DISTNAME=	u-boot-2016.09
REVISION=	1
d37 1
@


1.8
log
@fix the build of u-boot on big endian hosts

u-boot contains a static crc table with endian calls which requires the
endian calls to be macros.

lib/crc32.c:87: error: braced-group within expression allowed only inside a function

Define the glibc names in u-boot compiler.h as at least some parts of
the non-cross build assumes those names are present (ie crc32.c).

ok jca@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.7 2016/09/14 05:52:25 jsg Exp $
d5 1
a5 1
REVISION=	0
a50 1
	clearfog \
@


1.7
log
@update to U-Boot 2016.09

Remove patches to set board ids on novena and cubox/hummingboard we no
longer require.  Also remove some OpenBSD build fix patches that were
accepted upstream and the cm-fx6/utilite distro_bootcmd patch which
no longer cleanly applies.

Tested on CuBox-i4Pro, BeagleBone Black and PandaBoard ES.
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.6 2016/08/06 08:07:51 jsg Exp $
d5 1
@


1.6
log
@use endian.h macros and attempt to build on powerpc again
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.5 2016/08/06 06:40:05 landry Exp $
d4 1
a4 2
DISTNAME=	u-boot-2016.07
REVISION=	1
@


1.5
log
@Mark BROKEN on powerpc: Error: FDT_ERR_BADMAGIC
@
text
@d1 1
a1 3
#	$OpenBSD: Makefile,v 1.4 2016/07/30 14:22:19 jsg Exp $

BROKEN-powerpc=	Error: FDT_ERR_BADMAGIC
d5 1
a5 1
REVISION=	0
@


1.4
log
@build some additional board configurations
@
text
@d1 3
a3 1
#	$OpenBSD: Makefile,v 1.3 2016/07/12 12:35:44 jsg Exp $
@


1.3
log
@Update to U-Boot 2016.07 which will be used in the armv7 release.

This includes the patch to not allocate memory from holes with the efi
loader and adds support for network access from efi payloads as well.

ok sthen@@ naddy@@
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.2 2016/06/18 03:04:44 jsg Exp $
d5 1
d29 1
d35 1
d45 1
d48 1
@


1.2
log
@Patch u-boot targets to use "distro_bootcmd" so a u-boot script does not
have to be provided to load EFI payloads.  omap4/cubox-i/sunxi and many
others already default to this.  Only compile tested due to lack of hardware.

utilite
http://pkgs.fedoraproject.org/cgit/rpms/uboot-tools.git/plain/0005-port-utilite-to-distro-generic-boot-commands.patch
omap3 beagle
https://github.com/openSUSE/u-boot/commit/8ea945ff9d5f57f626167d41b1c59d9518fb60b2.patch
omap5/beagleboard x15
https://anonscm.debian.org/git/collab-maint/u-boot.git/plain/debian/patches/am57xx/omap5_distro_bootcmd?h=experimental-2016.07
@
text
@d1 1
a1 1
#	$OpenBSD: Makefile,v 1.1.1.1 2016/05/29 01:35:33 jsg Exp $
d4 1
a4 2
DISTNAME=	u-boot-2016.05
REVISION=	0
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
#	$OpenBSD$
d5 1
@


1.1.1.1
log
@Import U-Boot 2016.05

U-Boot is a firmware for embedded boards based on PowerPC, ARM, MIPS and
several other processors, which can be installed in a boot ROM and used to
initialize and test the hardware or to download and run application code.

As ARM systems often do not come with firmware it must be supplied on
an SD card or MMC device to have a bootable system.

This port provides U-Boot for various boards using ARM processors.

armv7 requires the support for EFI payloads added in this release to run
the bootloader.  A proposed patch to prevent the EFI interface from
allocating pages from unpopulated memory by Alexander Graf is included
which will hopefully be part of future releases:
http://marc.info/?l=u-boot&m=146434472023891&w=2

Feedback from jca@@ and sthen@@.  ok sthen@@ on an earlier version without
the EFI patch.
@
text
@@
