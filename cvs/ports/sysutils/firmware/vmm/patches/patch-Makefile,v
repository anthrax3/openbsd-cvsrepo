head	1.1;
access;
symbols
	OPENBSD_6_2:1.1.0.2
	OPENBSD_6_2_BASE:1.1;
locks; strict;
comment	@# @;


1.1
date	2017.07.16.14.11.21;	author robert;	state Exp;
branches;
next	;
commitid	sIp4cHOCeMeDyXWL;


desc
@@


1.1
log
@For gcc stack alignment is specified with -mpreferred-stack-boundary,
clang has the option -mstack-alignment for that purpose, so check what
the compiler supports and use that flag.
This does not fix the build of seabios with clang but moves us forward
a bit to the next error.
@
text
@$OpenBSD$

Index: Makefile
--- Makefile.orig
+++ Makefile
@@@@ -55,10 +55,18 @@@@ EXTRAVERSION=
 
 CPPFLAGS = -P -MD -MT $@@
 
+# For gcc stack alignment is specified with -mpreferred-stack-boundary,
+# clang has the option -mstack-alignment for that purpose.
+ifneq ($(call cc-option,$(CC),-mpreferred-stack-boundary=4,),)
+	cc_stack_align_opt := -mpreferred-stack-boundary
+else ifneq ($(call cc-option,$(CC),-mstack-alignment=4,),)
+	cc_stack_align_opt := -mstack-alignment
+endif
+
 COMMONCFLAGS := -I$(OUT) -Isrc -Os -MD -g \
     -Wall -Wno-strict-aliasing -Wold-style-definition \
     $(call cc-option,$(CC),-Wtype-limits,) \
-    -m32 -march=i386 -mregparm=3 -mpreferred-stack-boundary=2 \
+    -m32 -march=i386 -mregparm=3 $(cc_stack_align_opt)=2 \
     -minline-all-stringops -fomit-frame-pointer \
     -freg-struct-return -ffreestanding -fno-delete-null-pointer-checks \
     -ffunction-sections -fdata-sections -fno-common -fno-merge-constants
@
