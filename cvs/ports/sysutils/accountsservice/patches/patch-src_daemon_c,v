head	1.32;
access;
symbols
	OPENBSD_6_2:1.32.0.6
	OPENBSD_6_2_BASE:1.32
	OPENBSD_6_1:1.32.0.4
	OPENBSD_6_1_BASE:1.32
	OPENBSD_6_0:1.32.0.2
	OPENBSD_6_0_BASE:1.32
	OPENBSD_5_9:1.31.0.4
	OPENBSD_5_9_BASE:1.31
	OPENBSD_5_8:1.31.0.6
	OPENBSD_5_8_BASE:1.31
	OPENBSD_5_7:1.31.0.2
	OPENBSD_5_7_BASE:1.31
	OPENBSD_5_6:1.30.0.2
	OPENBSD_5_6_BASE:1.30
	OPENBSD_5_5:1.27.0.2
	OPENBSD_5_5_BASE:1.27
	OPENBSD_5_4:1.23.0.2
	OPENBSD_5_4_BASE:1.23
	OPENBSD_5_3:1.22.0.2
	OPENBSD_5_3_BASE:1.22
	OPENBSD_5_2:1.18.0.2
	OPENBSD_5_2_BASE:1.18
	OPENBSD_5_1_BASE:1.12
	OPENBSD_5_1:1.12.0.2
	OPENBSD_5_0:1.6.0.2
	OPENBSD_5_0_BASE:1.6
	ajacoutot_20110522:1.1.1.1
	ajacoutot:1.1.1;
locks; strict;
comment	@# @;


1.32
date	2016.06.10.15.17.36;	author ajacoutot;	state Exp;
branches;
next	1.31;
commitid	9PNHVz7MZQ1gAwzi;

1.31
date	2014.10.17.06.36.22;	author ajacoutot;	state Exp;
branches;
next	1.30;
commitid	LeMnTjYw6UVgUi8O;

1.30
date	2014.03.20.18.47.23;	author ajacoutot;	state Exp;
branches;
next	1.29;

1.29
date	2014.03.20.17.55.43;	author ajacoutot;	state Exp;
branches;
next	1.28;

1.28
date	2014.03.16.10.03.22;	author ajacoutot;	state Exp;
branches;
next	1.27;

1.27
date	2014.02.04.08.53.34;	author ajacoutot;	state Exp;
branches;
next	1.26;

1.26
date	2014.01.30.10.01.33;	author ajacoutot;	state Exp;
branches;
next	1.25;

1.25
date	2013.10.16.08.44.37;	author ajacoutot;	state Exp;
branches;
next	1.24;

1.24
date	2013.08.06.19.08.51;	author ajacoutot;	state Exp;
branches;
next	1.23;

1.23
date	2013.04.19.17.05.32;	author ajacoutot;	state Exp;
branches;
next	1.22;

1.22
date	2012.11.16.08.50.19;	author ajacoutot;	state Exp;
branches;
next	1.21;

1.21
date	2012.10.10.10.10.57;	author ajacoutot;	state Exp;
branches;
next	1.20;

1.20
date	2012.09.20.11.30.31;	author ajacoutot;	state Exp;
branches;
next	1.19;

1.19
date	2012.09.11.14.42.37;	author ajacoutot;	state Exp;
branches;
next	1.18;

1.18
date	2012.07.08.16.35.19;	author ajacoutot;	state Exp;
branches;
next	1.17;

1.17
date	2012.07.05.07.18.59;	author ajacoutot;	state Exp;
branches;
next	1.16;

1.16
date	2012.05.11.18.19.10;	author ajacoutot;	state Exp;
branches;
next	1.15;

1.15
date	2012.05.11.15.32.46;	author ajacoutot;	state Exp;
branches;
next	1.14;

1.14
date	2012.04.23.13.37.55;	author ajacoutot;	state Exp;
branches;
next	1.13;

1.13
date	2012.03.28.09.05.54;	author ajacoutot;	state Exp;
branches;
next	1.12;

1.12
date	2012.01.12.13.59.29;	author ajacoutot;	state Exp;
branches;
next	1.11;

1.11
date	2011.12.02.20.07.26;	author ajacoutot;	state Exp;
branches;
next	1.10;

1.10
date	2011.12.02.17.55.00;	author ajacoutot;	state Exp;
branches;
next	1.9;

1.9
date	2011.10.29.11.00.39;	author ajacoutot;	state Exp;
branches;
next	1.8;

1.8
date	2011.09.08.13.56.53;	author ajacoutot;	state Exp;
branches;
next	1.7;

1.7
date	2011.09.08.13.15.52;	author ajacoutot;	state Exp;
branches;
next	1.6;

1.6
date	2011.07.03.20.16.35;	author ajacoutot;	state Exp;
branches;
next	1.5;

1.5
date	2011.06.17.14.27.55;	author ajacoutot;	state Exp;
branches;
next	1.4;

1.4
date	2011.05.29.08.27.05;	author ajacoutot;	state Exp;
branches;
next	1.3;

1.3
date	2011.05.23.08.22.43;	author ajacoutot;	state Exp;
branches;
next	1.2;

1.2
date	2011.05.22.12.21.41;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2011.05.22.10.57.32;	author ajacoutot;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2011.05.22.10.57.32;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.32
log
@Update to accountsservice-0.6.42.
@
text
@$OpenBSD: patch-src_daemon_c,v 1.31 2014/10/17 06:36:22 ajacoutot Exp $
--- src/daemon.c.orig	Wed Feb 25 14:51:44 2015
+++ src/daemon.c	Fri Jun 10 16:43:03 2016
@@@@ -33,6 +33,10 @@@@
 #include <errno.h>
 #include <sys/types.h>
 
+#ifdef __OpenBSD__
+#include <grp.h> /* getgrnam */
+#endif
+
 #include <glib.h>
 #include <glib/gi18n.h>
 #include <glib-object.h>
@@@@ -46,7 +50,11 @@@@
 #include "util.h"
 
 #define PATH_PASSWD "/etc/passwd"
+#if defined (HAVE_SHADOW_H)
 #define PATH_SHADOW "/etc/shadow"
+#elif defined (__OpenBSD__)
+#define PATH_SHADOW "/etc/master.passwd"
+#endif
 #define PATH_GROUP "/etc/group"
 #define PATH_GDM_CUSTOM "/etc/gdm/custom.conf"
 
@@@@ -877,7 +885,11 @@@@ daemon_create_user_authorized_cb (Daemon              
         CreateUserData *cd = data;
         User *user;
         GError *error;
+#ifndef __OpenBSD__
         const gchar *argv[9];
+#else
+        const gchar *argv[11];
+#endif
 
         if (getpwnam (cd->user_name) != NULL) {
                 throw_error (context, ERROR_USER_EXISTS, "A user with name '%s' already exists", cd->user_name);
@@@@ -894,9 +906,17 @@@@ daemon_create_user_authorized_cb (Daemon              
         if (cd->account_type == ACCOUNT_TYPE_ADMINISTRATOR) {
                 argv[4] = "-G";
                 argv[5] = ADMIN_GROUP;
+#ifdef __OpenBSD__
+                argv[6] = "-L";
+                argv[7] = "staff";
+                argv[8] = "--";
+                argv[9] = cd->user_name;
+                argv[10] = NULL;
+#else
                 argv[6] = "--";
                 argv[7] = cd->user_name;
                 argv[8] = NULL;
+#endif
         }
         else if (cd->account_type == ACCOUNT_TYPE_STANDARD) {
                 argv[4] = "--";
@@@@ -1083,6 +1103,34 @@@@ daemon_delete_user_authorized_cb (Daemon              
                 return;
         }
 
+/*
+ * Under OpenBSD there is no /etc/login.defs (for USERGROUPS_ENAB), so
+ * we need to explicitely remove the user's group if it contains no more
+ * members and matches the username.
+ */
+#ifdef __OpenBSD__
+        struct group *grp;
+        GError *grperror;
+        const gchar *grpargv[3];
+
+        grp = getgrnam (pwent->pw_name);
+
+        if ((grp != NULL) && (*grp->gr_name == *pwent->pw_name) && (*grp->gr_mem == NULL)) {
+                sys_log (context, "delete group '%d'", pwent->pw_gid);
+
+                grpargv[0] = "/usr/sbin/groupdel";
+                grpargv[1] = pwent->pw_name;
+                grpargv[2] = NULL;
+
+                grperror = NULL;
+                if (!spawn_with_login_uid (context, grpargv, &grperror)) {
+                    throw_error (context, ERROR_FAILED, "running '%s' failed: %s", grpargv[0], grperror->message);
+                    g_error_free (grperror);
+                    return;
+                }
+        }
+#endif
+
         sys_log (context, "delete user '%s' (%d)", pwent->pw_name, ud->uid);
 
         if (daemon->priv->autologin != NULL) {
@@@@ -1108,11 +1156,18 @@@@ daemon_delete_user_authorized_cb (Daemon              
 
         argv[0] = "/usr/sbin/userdel";
         if (ud->remove_files) {
+#ifdef __OpenBSD__
+                argv[1] = "-r";
+                argv[2] = "--";
+                argv[3] = pwent->pw_name;
+                argv[4] = NULL;
+#else
                 argv[1] = "-f";
                 argv[2] = "-r";
                 argv[3] = "--";
                 argv[4] = pwent->pw_name;
                 argv[5] = NULL;
+#endif
         }
         else {
                 argv[1] = "-f";
@


1.31
log
@Update to accountsservice-0.6.39.
@
text
@d1 3
a3 3
$OpenBSD: patch-src_daemon_c,v 1.30 2014/03/20 18:47:23 ajacoutot Exp $
--- src/daemon.c.orig	Thu Oct 16 19:46:52 2014
+++ src/daemon.c	Fri Oct 17 08:33:27 2014
d27 1
a27 1
@@@@ -881,7 +889,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d39 1
a39 1
@@@@ -898,9 +910,17 @@@@ daemon_create_user_authorized_cb (Daemon              
d57 1
a57 1
@@@@ -1087,6 +1107,34 @@@@ daemon_delete_user_authorized_cb (Daemon              
d92 1
a92 1
@@@@ -1112,11 +1160,18 @@@@ daemon_delete_user_authorized_cb (Daemon              
@


1.30
log
@Better fix for our lack of utmpx; from upstream.
@
text
@d1 3
a3 3
$OpenBSD: patch-src_daemon_c,v 1.29 2014/03/20 17:55:43 ajacoutot Exp $
--- src/daemon.c.orig	Thu Mar 20 02:08:10 2014
+++ src/daemon.c	Thu Mar 20 19:41:18 2014
d27 1
a27 1
@@@@ -882,7 +890,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d39 1
a39 1
@@@@ -899,9 +911,17 @@@@ daemon_create_user_authorized_cb (Daemon              
d57 1
a57 1
@@@@ -1088,6 +1108,34 @@@@ daemon_delete_user_authorized_cb (Daemon              
d92 1
a92 1
@@@@ -1113,11 +1161,18 @@@@ daemon_delete_user_authorized_cb (Daemon              
@


1.29
log
@Update to accountsservice-0.6.36.
@
text
@d1 1
a1 4
$OpenBSD: patch-src_daemon_c,v 1.28 2014/03/16 10:03:22 ajacoutot Exp $

HAVE_UTMPX_H: https://bugs.freedesktop.org/show_bug.cgi?id=76410

d3 1
a3 1
+++ src/daemon.c	Thu Mar 20 18:43:53 2014
d27 1
a27 11
@@@@ -313,7 +321,9 @@@@ reload_users (Daemon *daemon)
                 g_hash_table_add (local, name);
 
         /* Now add/update users from other sources, possibly non-local */
+#ifdef HAVE_UTMPX_H
         load_entries (daemon, users, wtmp_helper_entry_generator);
+#endif
         load_entries (daemon, users, entry_generator_cachedir);
 
         /* Mark which users are local, which are not */
@@@@ -882,7 +892,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d39 1
a39 1
@@@@ -899,9 +913,17 @@@@ daemon_create_user_authorized_cb (Daemon              
d57 1
a57 1
@@@@ -1088,6 +1110,34 @@@@ daemon_delete_user_authorized_cb (Daemon              
d92 1
a92 1
@@@@ -1113,11 +1163,18 @@@@ daemon_delete_user_authorized_cb (Daemon              
@


1.28
log
@Sync comment with what has been committed upstream; no pkg change.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.27 2014/02/04 08:53:34 ajacoutot Exp $
d3 1
a3 4
From cdee3f55a5821cc76ad270b8c709a7bb1e3ae1b2 Mon Sep 17 00:00:00 2001
From: Ryan Lortie <desrt@@desrt.ca>
Date: Thu, 13 Mar 2014 22:51:18 +0000
Subject: daemon: emulate fgetpwent() if we don't have it
d5 5
a9 10
From 980692e6b9cfe4a34e22f566e0981a8c549e4348 Mon Sep 17 00:00:00 2001
From: Matthias Clasen <mclasen@@redhat.com>
Date: Fri, 01 Nov 2013 21:09:25 +0000
Subject: Avoid deleting the root user

--- src/daemon.c.orig	Tue Oct 15 22:25:19 2013
+++ src/daemon.c	Tue Feb  4 09:49:15 2014
@@@@ -36,6 +36,10 @@@@
 #include <utmpx.h>
 #endif
d18 1
a18 1
@@@@ -48,7 +52,11 @@@@
d29 7
a35 17
 #ifdef HAVE_UTMPX_H
@@@@ -307,6 +315,7 @@@@ entry_generator_fgetpwent (GHashTable *users,
                            gpointer   *state)
 {
         struct passwd *pwent;
+#ifdef HAVE_FGETPWENT
         FILE *fp;
 
         /* First iteration */
@@@@ -328,6 +337,11 @@@@ entry_generator_fgetpwent (GHashTable *users,
         /* Last iteration */
         fclose (fp);
         *state = NULL;
+#else
+        while ((pwent = getpwent ()) != NULL)
+                return pwent;
+        endpwent();
d37 1
a37 2
         return NULL;
 }
d39 2
a40 1
@@@@ -1051,7 +1065,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d52 1
a52 1
@@@@ -1068,9 +1086,17 @@@@ daemon_create_user_authorized_cb (Daemon              
d70 1
a70 10
@@@@ -1232,7 +1258,7 @@@@ daemon_uncache_user (AccountsAccounts      *accounts,
 }
 
 typedef struct {
-        gint64 uid;
+        uid_t uid;
         gboolean remove_files;
 } DeleteUserData;
 
@@@@ -1257,6 +1283,34 @@@@ daemon_delete_user_authorized_cb (Daemon              
d105 1
a105 1
@@@@ -1282,11 +1336,18 @@@@ daemon_delete_user_authorized_cb (Daemon              
d123 1
a123 17
                 argv[1] = "--";
@@@@ -1314,13 +1375,13 @@@@ daemon_delete_user (AccountsAccounts      *accounts,
         Daemon *daemon = (Daemon*)accounts;
         DeleteUserData *data;
 
-        if (uid == 0) {
+        if ((uid_t)uid == 0) {
                 throw_error (context, ERROR_FAILED, "Refuse to delete root user");
                 return TRUE;
         }
 
         data = g_new0 (DeleteUserData, 1);
-        data->uid = uid;
+        data->uid = (uid_t)uid;
         data->remove_files = remove_files;
 
         daemon_local_check_auth (daemon,
@


1.27
log
@Properly monitor for users changes (password, addition, removal...).
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.26 2014/01/30 10:01:33 ajacoutot Exp $
d3 4
a6 7
OpenBSD does not have any function to parse a specified passwd(5) file.

Revert the following commit:
This reverts commit dfa1a6239b01c823ce0fec781c6c9541c988f56e.
The commit is wrong, since we're only interested in local users.
http://bugs.freedesktop.org/show_bug.cgi?id=41747
(XXX we need a way to only get local users)
@


1.26
log
@Merge several fixes from upstream (memleak) and the new heuristic stuffs
for users; this allows to get rid of the statis daemon user list.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.25 2013/10/16 08:44:37 ajacoutot Exp $
d16 2
a17 2
--- src/daemon.c.orig	Thu Jan 30 10:09:06 2014
+++ src/daemon.c	Thu Jan 30 10:09:20 2014
d29 13
a41 1
@@@@ -307,8 +311,11 @@@@ entry_generator_fgetpwent (GHashTable *users,
a46 1
+#endif
a47 1
+#ifdef HAVE_FGETPWENT
d49 1
a49 13
         if (*state == NULL) {
                 *state = fp = fopen (PATH_PASSWD, "r");
@@@@ -321,13 +328,18 @@@@ entry_generator_fgetpwent (GHashTable *users,
         /* Every iteration */
         fp = *state;
         pwent = fgetpwent (fp);
+#else
+        pwent = getpwent ();
+#endif
         if (pwent != NULL) {
                 return pwent;
         }
 
a50 1
+#ifdef HAVE_FGETPWENT
d53 4
d61 1
a61 1
@@@@ -1051,7 +1063,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d73 1
a73 1
@@@@ -1068,9 +1084,17 @@@@ daemon_create_user_authorized_cb (Daemon              
d91 1
a91 1
@@@@ -1232,7 +1256,7 @@@@ daemon_uncache_user (AccountsAccounts      *accounts,
d100 1
a100 1
@@@@ -1257,6 +1281,34 @@@@ daemon_delete_user_authorized_cb (Daemon              
d135 1
a135 1
@@@@ -1282,11 +1334,18 @@@@ daemon_delete_user_authorized_cb (Daemon              
d154 1
a154 1
@@@@ -1314,13 +1373,13 @@@@ daemon_delete_user (AccountsAccounts      *accounts,
@


1.25
log
@Update to accountsservice-0.6.35.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.24 2013/08/06 19:08:51 ajacoutot Exp $
d11 7
a17 2
--- src/daemon.c.orig	Tue Oct 15 22:25:19 2013
+++ src/daemon.c	Wed Oct 16 10:34:25 2013
d90 9
d153 16
@


1.24
log
@Update to accountsservice-0.6.34.
@
text
@d1 1
a1 4
$OpenBSD: patch-src_daemon_c,v 1.23 2013/04/19 17:05:32 ajacoutot Exp $

In default_excludes[], add any ports and system users that has a login
shell.
d11 3
a13 3
--- src/daemon.c.orig	Tue Jun 11 17:50:37 2013
+++ src/daemon.c	Thu Jul 25 17:31:52 2013
@@@@ -35,6 +35,10 @@@@
d24 1
a24 21
@@@@ -82,6 +86,19 @@@@ static const char *default_excludes[] = {
         "at",
         "gdm",
         "gnome-initial-setup",
+        "_couchdb",
+        "_ejabberd",
+        "_jabberd",
+        "_mediatomb",
+        "_mon",
+        "_openfire",
+        "_postgresql",
+        "_rancid",
+        "_riak",
+        "_rocrail",
+        "_sabnzbd",
+        "_sogo",
+        "_varnish",
         NULL
 };
 
@@@@ -406,8 +423,11 @@@@ entry_generator_fgetpwent (GHashTable *users,
d36 1
a36 1
@@@@ -420,13 +440,18 @@@@ entry_generator_fgetpwent (GHashTable *users,
d55 1
a55 1
@@@@ -1173,7 +1198,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d67 1
a67 1
@@@@ -1190,9 +1219,17 @@@@ daemon_create_user_authorized_cb (Daemon              
d85 1
a85 1
@@@@ -1379,6 +1416,34 @@@@ daemon_delete_user_authorized_cb (Daemon              
d120 1
a120 1
@@@@ -1404,11 +1469,18 @@@@ daemon_delete_user_authorized_cb (Daemon              
@


1.23
log
@Update to accountsservice-0.6.31.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.22 2012/11/16 08:50:19 ajacoutot Exp $
d14 2
a15 2
--- src/daemon.c.orig	Tue Mar 12 23:42:05 2013
+++ src/daemon.c	Fri Apr 19 18:44:15 2013
d27 1
a27 3
@@@@ -77,6 +81,18 @@@@ static const char *default_excludes[] = {
         "games",
         "man",
d29 2
d41 1
d47 1
a47 1
@@@@ -396,8 +412,11 @@@@ entry_generator_fgetpwent (GHashTable *users,
d59 1
a59 1
@@@@ -410,13 +429,18 @@@@ entry_generator_fgetpwent (GHashTable *users,
d78 1
a78 1
@@@@ -1125,7 +1149,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d90 1
a90 1
@@@@ -1142,9 +1170,17 @@@@ daemon_create_user_authorized_cb (Daemon              
d108 1
a108 1
@@@@ -1345,6 +1381,34 @@@@ daemon_delete_user_authorized_cb (Daemon              
d142 2
a143 2
         filename = g_build_filename (USERDIR, pwent->pw_name, NULL);
@@@@ -1357,11 +1421,18 @@@@ daemon_delete_user_authorized_cb (Daemon              
@


1.22
log
@Bugfix update to accountsservice-0.6.26.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.21 2012/10/10 10:10:57 ajacoutot Exp $
d14 2
a15 2
--- src/daemon.c.orig	Mon Nov 12 22:10:33 2012
+++ src/daemon.c	Fri Nov 16 09:37:40 2012
d46 1
a46 1
@@@@ -371,8 +387,11 @@@@ entry_generator_fgetpwent (GHashTable *users,
d58 1
a58 1
@@@@ -385,13 +404,18 @@@@ entry_generator_fgetpwent (GHashTable *users,
d77 1
a77 1
@@@@ -1100,7 +1124,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d89 1
a89 1
@@@@ -1117,9 +1145,17 @@@@ daemon_create_user_authorized_cb (Daemon              
d92 1
a92 1
                 argv[5] = "wheel";
d107 1
a107 1
@@@@ -1320,6 +1356,34 @@@@ daemon_delete_user_authorized_cb (Daemon              
d142 1
a142 1
@@@@ -1332,11 +1396,18 @@@@ daemon_delete_user_authorized_cb (Daemon              
@


1.21
log
@Never delete uid 0.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.20 2012/09/20 11:30:31 ajacoutot Exp $
d14 2
a15 12
From 3d15e1ebb5ee844979d0aae5937a812bb056af5b Mon Sep 17 00:00:00 2001
From: Matthias Clasen <mclasen@@redhat.com>
Date: Sat, 29 Sep 2012 00:03:56 +0000
Subject: Refuse to delete uid 0

From e82517ae69d976d649580535d732df5c43237e24 Mon Sep 17 00:00:00 2001
From: Matthias Clasen <mclasen@@redhat.com>
Date: Sat, 29 Sep 2012 00:10:17 +0000
Subject: Fix the previous commit

--- src/daemon.c.orig	Wed Oct 10 13:58:31 2012
+++ src/daemon.c	Wed Oct 10 13:58:54 2012
d46 1
a46 1
@@@@ -291,8 +307,11 @@@@ entry_generator_fgetpwent (GHashTable *users,
d58 1
a58 1
@@@@ -305,13 +324,18 @@@@ entry_generator_fgetpwent (GHashTable *users,
d77 1
a77 1
@@@@ -1020,7 +1044,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d89 1
a89 1
@@@@ -1037,9 +1065,17 @@@@ daemon_create_user_authorized_cb (Daemon              
d107 1
a107 1
@@@@ -1240,6 +1276,34 @@@@ daemon_delete_user_authorized_cb (Daemon              
d142 1
a142 1
@@@@ -1252,11 +1316,18 @@@@ daemon_delete_user_authorized_cb (Daemon              
a160 12
@@@@ -1283,6 +1354,11 @@@@ daemon_delete_user (AccountsAccounts      *accounts,
 {
         Daemon *daemon = (Daemon*)accounts;
         DeleteUserData *data;
+
+        if (uid == 0) {
+                throw_error (context, ERROR_FAILED, "Refuse to delete root user");
+                return TRUE;
+        }
 
         data = g_new0 (DeleteUserData, 1);
         data->uid = uid;
@


1.20
log
@Add _riak to the user ignore list.
Cleaner way of settingup the class.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.19 2012/09/11 14:42:37 ajacoutot Exp $
d14 12
a25 2
--- src/daemon.c.orig	Thu Aug 16 21:03:51 2012
+++ src/daemon.c	Thu Sep 20 13:17:37 2012
d171 12
@


1.19
log
@Update to accountsservice-0.6.24.
@
text
@d1 1
a1 1
$OpenBSD$
d15 1
a15 1
+++ src/daemon.c	Tue Sep 11 15:11:35 2012
d27 1
a27 1
@@@@ -77,6 +81,17 @@@@ static const char *default_excludes[] = {
d39 1
d46 1
a46 1
@@@@ -291,8 +306,11 @@@@ entry_generator_fgetpwent (GHashTable *users,
d58 1
a58 1
@@@@ -305,13 +323,18 @@@@ entry_generator_fgetpwent (GHashTable *users,
d77 1
a77 1
@@@@ -1020,7 +1043,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d84 1
a84 1
+        const gchar *argv[13];
d89 1
a89 1
@@@@ -1037,14 +1064,31 @@@@ daemon_create_user_authorized_cb (Daemon              
d94 5
a98 7
+                argv[6] = "-g";
+                argv[7] = "=uid";
+                argv[8] = "-L";
+                argv[9] = "staff";
+                argv[10] = "--";
+                argv[11] = cd->user_name;
+                argv[12] = NULL;
a105 6
+#ifdef __OpenBSD__
+                argv[4] = "-g";
+                argv[5] = "=uid";
+                argv[6] = cd->user_name;
+                argv[7] = NULL;
+#else
d107 1
a107 7
                 argv[5] = cd->user_name;
                 argv[6] = NULL;
+#endif
         }
         else {
                 throw_error (context, ERROR_FAILED, "Don't know how to add user of type %d", cd->account_type);
@@@@ -1240,6 +1284,34 @@@@ daemon_delete_user_authorized_cb (Daemon              
d142 1
a142 1
@@@@ -1252,11 +1324,18 @@@@ daemon_delete_user_authorized_cb (Daemon              
@


1.18
log
@Exclude ports/system users that have a login shell since we only want to
deal with human users
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.17 2012/07/05 07:18:59 ajacoutot Exp $
d6 2
d14 2
a15 2
--- src/daemon.c.orig	Thu Jun 28 17:24:55 2012
+++ src/daemon.c	Sun Jul  8 18:33:40 2012
d45 4
a48 4
@@@@ -300,22 +315,32 @@@@ reload_passwd (Daemon *daemon)
         GSList *old_users;
         GSList *new_users;
         GSList *list;
a51 4
         User *user = NULL;
 
         old_users = NULL;
         new_users = NULL;
d54 7
a60 6
         errno = 0;
         fp = fopen (PATH_PASSWD, "r");
         if (fp == NULL) {
                 g_warning ("Unable to open %s: %s", PATH_PASSWD, g_strerror (errno));
                 goto out;
         }
d62 1
a62 1
+        setpwent();
d64 2
a65 13
         g_hash_table_foreach (daemon->priv->users, listify_hash_values_hfunc, &old_users);
         g_slist_foreach (old_users, (GFunc) g_object_ref, NULL);
 
+#ifdef HAVE_FGETPWENT
         while ((pwent = fgetpwent (fp)) != NULL) {
+#else
+        while ((pwent = getpwent ()) != NULL) {
+#endif
                 /* Skip system users... */
                 if (daemon_local_user_is_excluded (daemon, pwent->pw_name, pwent->pw_shell)) {
                         g_debug ("skipping user: %s", pwent->pw_name);
@@@@ -365,10 +390,12 @@@@ reload_passwd (Daemon *daemon)
                 }
d68 1
a69 3
  out:
         /* Cleanup */
 
d71 1
d73 2
d76 1
a76 3
         g_slist_foreach (new_users, (GFunc) g_object_thaw_notify, NULL);
         g_slist_foreach (new_users, (GFunc) g_object_unref, NULL);
@@@@ -922,7 +949,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d83 1
a83 1
+	const gchar *argv[13];
d88 1
a88 1
@@@@ -939,14 +970,31 @@@@ daemon_create_user_authorized_cb (Daemon              
d120 1
a120 1
@@@@ -1018,15 +1066,49 @@@@ daemon_delete_user_authorized_cb (Daemon              
d132 1
a132 1
+        const gchar *grpargv[2];
d141 1
d153 3
@


1.17
log
@SECURITY update to accountsservice-0.6.22.
@
text
@d1 4
a4 1
$OpenBSD: patch-src_daemon_c,v 1.16 2012/05/11 18:19:10 ajacoutot Exp $
d13 1
a13 1
+++ src/daemon.c	Thu Jul  5 08:58:57 2012
d25 19
a43 1
@@@@ -300,22 +304,32 @@@@ reload_passwd (Daemon *daemon)
d76 1
a76 1
@@@@ -365,10 +379,12 @@@@ reload_passwd (Daemon *daemon)
d89 1
a89 1
@@@@ -922,7 +938,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d101 1
a101 1
@@@@ -939,14 +959,31 @@@@ daemon_create_user_authorized_cb (Daemon              
d133 1
a133 1
@@@@ -1018,15 +1055,49 @@@@ daemon_delete_user_authorized_cb (Daemon              
@


1.16
log
@Fix removal of user/group.
@
text
@d1 11
a11 4
$OpenBSD: patch-src_daemon_c,v 1.15 2012/05/11 15:32:46 ajacoutot Exp $
--- src/daemon.c.orig	Fri May  4 15:52:03 2012
+++ src/daemon.c	Fri May 11 20:16:23 2012
@@@@ -36,6 +36,10 @@@@
d22 47
a68 10
@@@@ -52,7 +56,7 @@@@
 #define PATH_FALSE "/bin/false"
 #define PATH_GDM_CUSTOM "/etc/gdm/custom.conf"
 
-#define USERDIR LOCALSTATEDIR "/lib/AccountsService/users"
+#define USERDIR LOCALSTATEDIR "/db/AccountsService/users"
 
 static const char *default_excludes[] = {
         "bin",
@@@@ -909,7 +913,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d75 1
a75 1
+	gchar *argv[13];
d80 1
a80 1
@@@@ -926,14 +934,31 @@@@ daemon_create_user_authorized_cb (Daemon              
d112 1
a112 1
@@@@ -1005,15 +1030,49 @@@@ daemon_delete_user_authorized_cb (Daemon              
d124 1
a124 1
+        gchar *grpargv[2];
@


1.15
log
@Bugfix update to accountsservice-0.6.20.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.14 2012/04/23 13:37:55 ajacoutot Exp $
d3 13
a15 2
+++ src/daemon.c	Fri May 11 16:16:02 2012
@@@@ -52,7 +52,7 @@@@
d24 1
a24 1
@@@@ -909,7 +909,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d36 1
a36 1
@@@@ -926,14 +930,31 @@@@ daemon_create_user_authorized_cb (Daemon              
d68 1
a68 2
@@@@ -1004,6 +1025,28 @@@@ daemon_delete_user_authorized_cb (Daemon              
 
d71 1
a71 1
+
d75 1
a75 1
+ * members.
d78 1
d82 4
a85 1
+        sys_log (context, "delete group '%d'", pwent->pw_gid);
d87 2
a88 2
+        grpargv[0] = "/usr/sbin/groupdel";
+        grpargv[1] = pwent->pw_name;
d90 6
a95 5
+        grperror = NULL;
+        if (!spawn_with_login_uid (context, grpargv, &grperror)) {
+                throw_error (context, ERROR_FAILED, "running '%s' failed: %s", grpargv[0], grperror->message);
+                g_error_free (grperror);
+                return;
d98 1
a98 1
 
d101 17
@


1.14
log
@Update to accountsservice-0.6.18.
@
text
@d1 3
a3 3
$OpenBSD: patch-src_daemon_c,v 1.13 2012/03/28 09:05:54 ajacoutot Exp $
--- src/daemon.c.orig	Tue Apr 10 03:01:29 2012
+++ src/daemon.c	Mon Apr 23 15:31:12 2012
d13 1
a13 1
@@@@ -908,7 +908,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d25 1
a25 1
@@@@ -925,14 +929,31 @@@@ daemon_create_user_authorized_cb (Daemon              
d57 1
a57 1
@@@@ -1003,6 +1024,28 @@@@ daemon_delete_user_authorized_cb (Daemon              
@


1.13
log
@Update to accountsservice-0.6.17.
@
text
@d1 3
a3 3
$OpenBSD: patch-src_daemon_c,v 1.12 2012/01/12 13:59:29 ajacoutot Exp $
--- src/daemon.c.orig	Tue Mar 27 17:47:56 2012
+++ src/daemon.c	Wed Mar 28 10:51:34 2012
d13 1
a13 1
@@@@ -904,7 +904,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d25 1
a25 1
@@@@ -921,14 +925,31 @@@@ daemon_create_user_authorized_cb (Daemon              
d57 1
a57 1
@@@@ -999,6 +1020,28 @@@@ daemon_delete_user_authorized_cb (Daemon              
@


1.12
log
@OpenBSD does not require -lcrypt, DES encryption is part of the standard
libc.
@
text
@d1 6
a6 14
$OpenBSD: patch-src_daemon_c,v 1.11 2011/12/02 20:07:26 ajacoutot Exp $
--- src/daemon.c.orig	Mon Oct 17 21:30:22 2011
+++ src/daemon.c	Thu Jan 12 14:44:19 2012
@@@@ -54,11 +54,15 @@@@
 #define PATH_LOGIN_DEFS "/etc/login.defs"
 #define PATH_GDM_CUSTOM "${SYSCONFDIR}/gdm/custom.conf"
 
+#if defined(__FreeBSD__) || defined(__OpenBSD__)
+#define FALLBACK_MINIMAL_UID 1000
+#endif
+
 #ifndef FALLBACK_MINIMAL_UID
 #define FALLBACK_MINIMAL_UID 500
 #endif
d13 1
a13 1
@@@@ -1023,7 +1027,11 @@@@ daemon_create_user_authorized_cb (Daemon              
d18 1
a18 1
         gchar *argv[9];
d20 1
a20 1
+        gchar *argv[13];
d25 1
a25 1
@@@@ -1040,14 +1048,31 @@@@ daemon_create_user_authorized_cb (Daemon              
d57 1
a57 1
@@@@ -1117,6 +1142,28 @@@@ daemon_delete_user_authorized_cb (Daemon              
@


1.11
log
@Properly handle ACCOUNT_TYPE_STANDARD and ACCOUNT_TYPE_ADMINISTRATOR.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.10 2011/12/02 17:55:00 ajacoutot Exp $
d3 1
a3 1
+++ src/daemon.c	Fri Dec  2 21:00:47 2011
@


1.10
log
@Fix users creation.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.9 2011/10/29 11:00:39 ajacoutot Exp $
d3 2
a4 4
+++ src/daemon.c	Fri Dec  2 18:54:10 2011
@@@@ -52,13 +52,17 @@@@
 #define PATH_PASSWD "/etc/passwd"
 #define PATH_SHADOW "/etc/shadow"
d6 1
a6 2
-#define PATH_GDM_CUSTOM "/etc/gdm/custom.conf"
+#define PATH_GDM_CUSTOM "${SYSCONFDIR}/gdm/custom.conf"
d21 1
a21 1
@@@@ -1023,7 +1027,12 @@@@ daemon_create_user_authorized_cb (Daemon              
d28 1
a28 2
+        gchar *argv[12];
+        gchar *gargv[3];
d33 1
a33 24
@@@@ -1031,6 +1040,22 @@@@ daemon_create_user_authorized_cb (Daemon              
                 return;
         }
 
+#ifdef __OpenBSD__
+        GError *gerror;
+        sys_log (context, "create group '%s'", cd->user_name);
+
+        gargv[0] = "/usr/sbin/groupadd";
+        gargv[1] = cd->user_name;
+        gargv[2] = NULL;
+
+        gerror = NULL;
+        if (!spawn_with_login_uid (context, gargv, &gerror)) {
+                throw_error (context, ERROR_FAILED, "running '%s' failed: %s", gargv[0], gerror->message);
+                g_error_free (gerror);
+                return;
+        }
+#endif
+
         sys_log (context, "create user '%s'", cd->user_name);
 
         argv[0] = "/usr/sbin/useradd";
@@@@ -1040,14 +1065,30 @@@@ daemon_create_user_authorized_cb (Daemon              
d39 1
a39 1
+                argv[7] = cd->user_name;
d42 3
a44 2
+                argv[10] = cd->user_name;
+                argv[11] = NULL;
d54 1
a54 1
+                argv[5] = cd->user_name;
d65 1
a65 1
@@@@ -1117,6 +1158,23 @@@@ daemon_delete_user_authorized_cb (Daemon              
d70 5
d76 2
a77 2
+        GError *gerror;
+        gchar *gargv[2];
d81 2
a82 2
+        gargv[0] = "/usr/sbin/groupdel";
+        gargv[1] = pwent->pw_name;
d84 4
a87 4
+        gerror = NULL;
+        if (!spawn_with_login_uid (context, gargv, &gerror)) {
+                throw_error (context, ERROR_FAILED, "running '%s' failed: %s", argv[0], gerror->message);
+                g_error_free (gerror);
@


1.9
log
@Bugfix update to accountsservice-0.6.15.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.8 2011/09/08 13:56:53 ajacoutot Exp $
d3 1
a3 1
+++ src/daemon.c	Sat Oct 29 12:52:11 2011
d60 1
a60 2
@@@@ -1039,15 +1064,34 @@@@ daemon_create_user_authorized_cb (Daemon              
         argv[3] = cd->real_name;
d63 1
a64 1
+                argv[5] = "wheel,users";
a71 1
                 argv[5] = "wheel";
d79 4
a82 6
+                argv[4] = "-G";
+                argv[5] = "users";
+                argv[6] = "-g";
+                argv[7] = cd->user_name;
+                argv[8] = cd->user_name;
+                argv[9] = NULL;
d91 1
a91 1
@@@@ -1117,6 +1161,23 @@@@ daemon_delete_user_authorized_cb (Daemon              
@


1.8
log
@For now, revert upstream commit:
'daemon: get login frequency from wtmp instead of ConsoleKit'
It makes use of utmpx so we'll have to port it over.
@
text
@d1 4
a4 4
$OpenBSD: patch-src_daemon_c,v 1.7 2011/09/08 13:15:52 ajacoutot Exp $
--- src/daemon.c.orig	Thu Sep  8 15:52:39 2011
+++ src/daemon.c	Thu Sep  8 15:52:39 2011
@@@@ -49,13 +49,17 @@@@
d24 1
a24 74
@@@@ -490,22 +494,32 @@@@ reload_passwd (Daemon *daemon)
         GSList *old_users;
         GSList *new_users;
         GSList *list;
+#if !defined(__FreeBSD__) && !defined(__OpenBSD__)
         FILE *fp;
+#endif
         User *user = NULL;
 
         old_users = NULL;
         new_users = NULL;
 
+#if defined(__FreeBSD__) || defined(__OpenBSD__)
+       setpwent();
+#else
         errno = 0;
         fp = fopen (PATH_PASSWD, "r");
         if (fp == NULL) {
                 g_warning ("Unable to open %s: %s", PATH_PASSWD, g_strerror (errno));
                 goto out;
         }
+#endif
         g_hash_table_foreach (daemon->priv->users, listify_hash_values_hfunc, &old_users);
         g_slist_foreach (old_users, (GFunc) g_object_ref, NULL);
 
+#if defined(__FreeBSD__) || defined(__OpenBSD__)
+        for (pwent = getpwent (); pwent != NULL; pwent = getpwent ()) {
+#else
         for (pwent = fgetpwent (fp); pwent != NULL; pwent = fgetpwent (fp)) {
+#endif
                 /* Skip users below MINIMAL_UID... */
                 if (daemon_local_user_is_excluded (daemon, pwent->pw_name, pwent->pw_uid)) {
                         g_debug ("skipping user: %s", pwent->pw_name);
@@@@ -555,10 +569,14 @@@@ reload_passwd (Daemon *daemon)
                 }
         }
 
+#if defined(__FreeBSD__) || defined(__OpenBSD__)
+        endpwent ();
+#else
  out:
         /* Cleanup */
 
         fclose (fp);
+#endif
 
         g_slist_foreach (new_users, (GFunc) g_object_thaw_notify, NULL);
         g_slist_foreach (new_users, (GFunc) g_object_unref, NULL);
@@@@ -718,9 +736,16 @@@@ on_gdm_monitor_changed (GFileMonitor      *monitor,
         queue_reload_autologin (daemon);
 }
 
+#if defined(__FreeBSD__) || defined(__OpenBSD__)
 static uid_t
 get_minimal_uid (void)
 {
+	return FALLBACK_MINIMAL_UID;
+}
+#else
+static uid_t
+get_minimal_uid (void)
+{
         GError *error;
         char *contents;
         gboolean contents_loaded;
@@@@ -770,6 +795,7 @@@@ out:
         g_free (contents);
         return uid;
 }
+#endif
 
 static void
 daemon_init (Daemon *daemon)
@@@@ -1183,7 +1209,12 @@@@ daemon_create_user_authorized_cb (Daemon              
d37 1
a37 1
@@@@ -1191,6 +1222,22 @@@@ daemon_create_user_authorized_cb (Daemon              
d60 1
a60 1
@@@@ -1199,15 +1246,34 @@@@ daemon_create_user_authorized_cb (Daemon              
d95 1
a95 1
@@@@ -1277,6 +1343,23 @@@@ daemon_delete_user_authorized_cb (Daemon              
@


1.7
log
@Update to accountsservice-0.6.14. Still needs some major work.
@
text
@d1 4
a4 14
$OpenBSD: patch-src_user_c,v 1.7 2011/07/04 05:16:47 ajacoutot Exp $
--- src/daemon.c.orig	Tue Aug 16 14:53:31 2011
+++ src/daemon.c	Thu Sep  8 15:09:16 2011
@@@@ -32,7 +32,9 @@@@
 #include <errno.h>
 #include <unistd.h>
 #include <sys/types.h>
+#ifndef __OpenBSD__
 #include <utmpx.h>
+#endif
 
 #include <glib.h>
 #include <glib/gi18n.h>
@@@@ -50,13 +52,17 @@@@
d24 1
a24 19
@@@@ -238,6 +244,9 @@@@ daemon_local_user_is_excluded (Daemon *daemon, const g
 static void
 reload_wtmp_history (Daemon *daemon)
 {
+#ifdef __OpenBSD__
+        return;
+#else
         struct utmpx *wtmp_entry;
         GHashTable *login_frequency_hash;
         GHashTableIter iter;
@@@@ -298,6 +307,7 @@@@ reload_wtmp_history (Daemon *daemon)
 
         g_hash_table_foreach (login_frequency_hash, (GHFunc) g_free, NULL);
         g_hash_table_unref (login_frequency_hash);
+#endif
 }
 
 static void
@@@@ -326,22 +336,32 @@@@ reload_passwd (Daemon *daemon)
d57 1
a57 1
@@@@ -391,10 +411,14 @@@@ reload_passwd (Daemon *daemon)
d72 1
a72 1
@@@@ -554,9 +578,16 @@@@ on_gdm_monitor_changed (GFileMonitor      *monitor,
d89 1
a89 1
@@@@ -606,6 +637,7 @@@@ out:
d97 1
a97 1
@@@@ -1002,7 +1034,12 @@@@ daemon_create_user_authorized_cb (Daemon              
d110 1
a110 1
@@@@ -1010,6 +1047,22 @@@@ daemon_create_user_authorized_cb (Daemon              
d133 1
a133 1
@@@@ -1018,15 +1071,34 @@@@ daemon_create_user_authorized_cb (Daemon              
d168 1
a168 1
@@@@ -1096,6 +1168,23 @@@@ daemon_delete_user_authorized_cb (Daemon              
@


1.6
log
@Tweak.
@
text
@d1 15
a15 4
$OpenBSD: patch-src_daemon_c,v 1.5 2011/06/17 14:27:55 ajacoutot Exp $
--- src/daemon.c.orig	Thu May 19 05:39:12 2011
+++ src/daemon.c	Fri Jun 17 16:25:09 2011
@@@@ -50,11 +50,14 @@@@
d18 2
d24 1
d34 19
a52 1
@@@@ -488,22 +491,32 @@@@ reload_passwd (Daemon *daemon)
d85 1
a85 1
@@@@ -553,10 +566,14 @@@@ reload_passwd (Daemon *daemon)
d100 2
a101 2
@@@@ -676,9 +693,16 @@@@ on_passwd_monitor_changed (GFileMonitor      *monitor,
         reload_users (daemon);
d117 1
a117 1
@@@@ -728,6 +752,7 @@@@ out:
d125 1
a125 1
@@@@ -1119,7 +1144,12 @@@@ daemon_create_user_authorized_cb (Daemon              
d130 1
a130 1
         gchar *argv[8];
d138 1
a138 1
@@@@ -1127,6 +1157,23 @@@@ daemon_create_user_authorized_cb (Daemon              
a157 1
+
d161 1
a161 1
@@@@ -1135,13 +1182,32 @@@@ daemon_create_user_authorized_cb (Daemon              
d175 3
a177 2
                 argv[6] = cd->user_name;
                 argv[7] = NULL;
d189 3
a191 2
                 argv[4] = cd->user_name;
                 argv[5] = NULL;
d196 2
a197 1
@@@@ -1212,6 +1278,23 @@@@ daemon_delete_user_authorized_cb (Daemon              
d200 1
a200 1
 
d217 1
a217 1
+
a219 19
         argv[0] = "/usr/sbin/userdel";
@@@@ -1381,7 +1464,7 @@@@ load_autologin (Daemon      *daemon,
         GError *local_error;
         gchar *string;
 
-        filename = "/etc/gdm/custom.conf";
+        filename = "${SYSCONFDIR}/X11/gdm/custom.conf";
 
         keyfile = g_key_file_new ();
         if (!g_key_file_load_from_file (keyfile,
@@@@ -1431,7 +1514,7 @@@@ save_autologin (Daemon      *daemon,
         gchar *data;
         gboolean result;
 
-        filename = "/etc/gdm/custom.conf";
+        filename = "${SYSCONFDIR}/X11/gdm/custom.conf";
 
         keyfile = g_key_file_new ();
         if (!g_key_file_load_from_file (keyfile,
@


1.5
log
@Fix path to gdm/custom.conf.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.4 2011/05/29 08:27:05 ajacoutot Exp $
a92 9
@@@@ -1042,7 +1067,7 @@@@ finish_list_cached_users (gpointer user_data)
         while (g_hash_table_iter_next (&iter, (gpointer *)&name, (gpointer *)&user)) {
                 uid = user_local_get_uid (user);
                 if (!daemon_local_user_is_excluded (data->daemon, name, uid)) {
-                        g_debug ("user %s %ld not excluded\n", name, uid);
+                        g_debug ("user %s %ld not excluded\n", name, (long int)uid);
                         g_ptr_array_add (object_paths, g_strdup (user_local_get_object_path (user)));
                 }
         }
@


1.4
log
@Fix several users management related functions.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.3 2011/05/23 08:22:43 ajacoutot Exp $
d3 1
a3 1
+++ src/daemon.c	Fri May 27 20:13:38 2011
d172 1
a172 2
@@@@ -1211,6 +1277,23 @@@@ daemon_delete_user_authorized_cb (Daemon              
 
d175 1
a175 1
+
d192 16
d209 2
a210 1
         sys_log (context, "delete user '%s' (%d)", pwent->pw_name, ud->uid);
d212 2
@


1.3
log
@Don't try to open /proc, use kvm(3) instead.
reviewed by robert@@
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.2 2011/05/22 12:21:41 ajacoutot Exp $
d3 1
a3 1
+++ src/daemon.c	Mon May 23 09:15:22 2011
@


1.2
log
@Fix adding/deleting users with upcoming gnome-control-center 3.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_daemon_c,v 1.1.1.1 2011/05/22 10:57:32 ajacoutot Exp $
d3 1
a3 1
+++ src/daemon.c	Sun May 22 14:19:04 2011
d20 9
a28 1
@@@@ -494,16 +497,24 @@@@ reload_passwd (Daemon *daemon)
d53 3
a55 3
@@@@ -556,7 +567,11 @@@@ reload_passwd (Daemon *daemon)
  out:
         /* Cleanup */
d60 3
d68 1
a68 1
@@@@ -676,9 +691,16 @@@@ on_passwd_monitor_changed (GFileMonitor      *monitor,
d85 1
a85 1
@@@@ -728,6 +750,7 @@@@ out:
d93 1
a93 1
@@@@ -1042,7 +1065,7 @@@@ finish_list_cached_users (gpointer user_data)
d102 1
a102 1
@@@@ -1119,7 +1142,12 @@@@ daemon_create_user_authorized_cb (Daemon              
d115 1
a115 1
@@@@ -1127,6 +1155,23 @@@@ daemon_create_user_authorized_cb (Daemon              
d139 1
a139 1
@@@@ -1135,13 +1180,32 @@@@ daemon_create_user_authorized_cb (Daemon              
d172 1
a172 1
@@@@ -1211,6 +1275,23 @@@@ daemon_delete_user_authorized_cb (Daemon              
@


1.1
log
@Initial revision
@
text
@d1 1
a1 1
$OpenBSD$
d3 1
a3 1
+++ src/daemon.c	Sun May 22 12:36:56 2011
d91 91
a181 12
@@@@ -1381,7 +1404,7 @@@@ load_autologin (Daemon      *daemon,
         GError *local_error;
         gchar *string;
 
-        filename = "/etc/gdm/custom.conf";
+        filename = "${SYSCONFDIR}/gdm/custom.conf";
 
         keyfile = g_key_file_new ();
         if (!g_key_file_load_from_file (keyfile,
@@@@ -1431,7 +1454,7 @@@@ save_autologin (Daemon      *daemon,
         gchar *data;
         gboolean result;
d183 1
a183 2
-        filename = "/etc/gdm/custom.conf";
+        filename = "${SYSCONFDIR}/gdm/custom.conf";
a184 2
         keyfile = g_key_file_new ();
         if (!g_key_file_load_from_file (keyfile,
@


1.1.1.1
log
@Import accountsservice-0.6.12.

The AccountsService project provides:
    * A set of D-Bus interfaces for querying and manipulating user
      account information.
    * An implementation of these interfaces based on the usermod(8),
      useradd(8) and userdel(8) commands

ok jasper@@ ("though I'm surprised they didn't name it 'accountskit'")
@
text
@@
