head	1.15;
access;
symbols
	OPENBSD_6_2:1.15.0.14
	OPENBSD_6_2_BASE:1.15
	OPENBSD_6_1:1.15.0.12
	OPENBSD_6_1_BASE:1.15
	OPENBSD_6_0:1.15.0.10
	OPENBSD_6_0_BASE:1.15
	OPENBSD_5_9:1.15.0.6
	OPENBSD_5_9_BASE:1.15
	OPENBSD_5_8:1.15.0.8
	OPENBSD_5_8_BASE:1.15
	OPENBSD_5_7:1.15.0.4
	OPENBSD_5_7_BASE:1.15
	OPENBSD_5_6:1.15.0.2
	OPENBSD_5_6_BASE:1.15
	OPENBSD_5_5:1.14.0.2
	OPENBSD_5_5_BASE:1.14
	OPENBSD_5_4:1.12.0.2
	OPENBSD_5_4_BASE:1.12
	OPENBSD_5_3:1.11.0.2
	OPENBSD_5_3_BASE:1.11
	OPENBSD_5_2:1.8.0.2
	OPENBSD_5_2_BASE:1.8
	OPENBSD_5_1_BASE:1.6
	OPENBSD_5_1:1.6.0.2
	OPENBSD_5_0:1.3.0.2
	OPENBSD_5_0_BASE:1.3
	ajacoutot_20110522:1.1.1.1
	ajacoutot:1.1.1;
locks; strict;
comment	@# @;


1.15
date	2014.05.09.12.59.50;	author ajacoutot;	state Exp;
branches;
next	1.14;

1.14
date	2014.01.30.10.01.33;	author ajacoutot;	state Exp;
branches;
next	1.13;

1.13
date	2013.12.11.16.11.19;	author ajacoutot;	state Exp;
branches;
next	1.12;

1.12
date	2013.05.30.18.07.43;	author ajacoutot;	state Exp;
branches;
next	1.11;

1.11
date	2012.12.18.21.38.12;	author sthen;	state Exp;
branches;
next	1.10;

1.10
date	2012.09.27.05.53.43;	author ajacoutot;	state Exp;
branches;
next	1.9;

1.9
date	2012.09.11.14.42.37;	author ajacoutot;	state Exp;
branches;
next	1.8;

1.8
date	2012.07.05.07.18.59;	author ajacoutot;	state Exp;
branches;
next	1.7;

1.7
date	2012.03.28.09.05.54;	author ajacoutot;	state Exp;
branches;
next	1.6;

1.6
date	2012.01.08.19.42.02;	author naddy;	state Exp;
branches;
next	1.5;

1.5
date	2011.10.29.11.00.39;	author ajacoutot;	state Exp;
branches;
next	1.4;

1.4
date	2011.09.08.13.15.52;	author ajacoutot;	state Exp;
branches;
next	1.3;

1.3
date	2011.05.29.08.27.05;	author ajacoutot;	state Exp;
branches;
next	1.2;

1.2
date	2011.05.23.08.22.43;	author ajacoutot;	state Exp;
branches;
next	1.1;

1.1
date	2011.05.22.10.57.32;	author ajacoutot;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2011.05.22.10.57.32;	author ajacoutot;	state Exp;
branches;
next	;


desc
@@


1.15
log
@No need for libkvm.
@
text
@$OpenBSD: patch-src_util_c,v 1.14 2014/01/30 10:01:33 ajacoutot Exp $

XXX push upstream: we don't use /proc on OpenBSD

--- src/util.c.orig	Tue Oct 15 22:25:19 2013
+++ src/util.c	Fri May  9 14:54:31 2014
@@@@ -32,11 +32,17 @@@@
 
 #include <polkit/polkit.h>
 
+#ifdef __OpenBSD__
+#include <errno.h>
+#include <sys/sysctl.h>
+#endif
+
 #include "util.h"
 
 static gchar *
 get_cmdline_of_pid (GPid pid)
 {
+#ifndef __OpenBSD__
   gchar *ret = NULL;
   gchar *filename;
   gchar *contents;
@@@@ -70,7 +76,29 @@@@ get_cmdline_of_pid (GPid pid)
  out:
   g_free (filename);
   g_free (contents);
+#else /* OpenBSD */
+  gchar *ret = NULL;
+  gchar **strs = NULL;
+  gsize len;
+  gint mib[] = { CTL_KERN, KERN_PROC_ARGS, pid, KERN_PROC_ARGV };
+ 
+  if (sysctl (mib, G_N_ELEMENTS (mib), NULL, &len, NULL, 0) == -1)
+    goto out;
 
+  strs = g_malloc0 (len);
+
+  if (sysctl (mib, G_N_ELEMENTS (mib), strs, &len, NULL, 0) == -1) {
+    g_warning ("failed to get command line args: %d", errno);
+    goto out;
+  }
+
+  ret = g_strjoinv (" ", strs);
+  g_strstrip (ret);
+
+out:
+  g_free (strs);
+#endif
+
   return ret;
 }
 
@@@@ -230,12 +258,14 @@@@ compat_check_exit_status (int      estatus,
 static void
 setup_loginuid (gpointer data)
 {
+#ifndef __OpenBSD__
         const char *id = data;
         int fd;
 
         fd = open ("/proc/self/loginuid", O_WRONLY);
         write (fd, id, strlen (id));
         close (fd);
+#endif
 }
 
 gboolean
@


1.14
log
@Merge several fixes from upstream (memleak) and the new heuristic stuffs
for users; this allows to get rid of the statis daemon user list.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_util_c,v 1.13 2013/12/11 16:11:19 ajacoutot Exp $
d5 3
a7 3
--- src/util.c.orig	Sat May 11 21:54:43 2013
+++ src/util.c	Thu May 30 20:00:16 2013
@@@@ -32,11 +32,20 @@@@
d12 1
a12 3
+#include <sys/param.h>
+#include <sys/types.h>
+#include <sys/proc.h>
a13 1
+#include <kvm.h>
d25 1
a25 1
@@@@ -70,7 +79,31 @@@@ get_cmdline_of_pid (GPid pid)
a29 1
+  kvm_t *kd;
d31 6
a36 3
+  int nproc;
+  struct kinfo_proc *kp;
+  char **pargv;
d38 1
a38 8
+  if ((kd = kvm_openfiles(NULL, NULL, NULL, KVM_NO_FILES, NULL)) == NULL)
+    goto out;
+
+  if ((kp = kvm_getprocs(kd, KERN_PROC_PID, pid, sizeof(*kp), &nproc)) == NULL)
+    goto out;
+
+  if ((kp->p_flag & P_SYSTEM) != 0) 
+    goto out;
d40 2
a41 1
+  if ((pargv = kvm_getargv(kd, kp, 0)) == NULL)
d43 1
d45 2
a46 1
+  ret = g_path_get_basename(pargv[0]);
d49 1
a49 1
+  kvm_close(kd);
d55 1
a55 1
@@@@ -230,12 +263,14 @@@@ compat_check_exit_status (int      estatus,
@


1.13
log
@Typo.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_util_c,v 1.12 2013/05/30 18:07:43 ajacoutot Exp $
d3 1
a3 1
We don't use /proc on OpenBSD.
@


1.12
log
@Update to accountsservice-0.6.32.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_util_c,v 1.11 2012/12/18 21:38:12 sthen Exp $
d64 1
a64 1
+#ifndef __OpenBSD
@


1.11
log
@cope with sysctl.h changes
@
text
@d1 1
a1 1
$OpenBSD: patch-src_util_c,v 1.10 2012/09/27 05:53:43 ajacoutot Exp $
d5 2
a6 2
--- src/util.c.orig	Mon Sep 10 12:15:59 2012
+++ src/util.c	Fri Dec  7 06:15:20 2012
d60 1
a60 1
@@@@ -204,12 +237,14 @@@@ get_caller_loginuid (GDBusMethodInvocation *context, g
@


1.10
log
@Update to accountsservice-0.6.25.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_util_c,v 1.9 2012/09/11 14:42:37 ajacoutot Exp $
d5 3
a7 3
--- src/util.c.orig	Mon Sep 10 20:15:59 2012
+++ src/util.c	Thu Sep 27 07:47:35 2012
@@@@ -32,11 +32,19 @@@@
d14 1
d28 1
a28 1
@@@@ -70,7 +78,31 @@@@ get_cmdline_of_pid (GPid pid)
d60 1
a60 1
@@@@ -204,12 +236,14 @@@@ get_caller_loginuid (GDBusMethodInvocation *context, g
@


1.9
log
@Update to accountsservice-0.6.24.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_util_c,v 1.8 2012/07/05 07:18:59 ajacoutot Exp $
d5 3
a7 3
--- src/util.c.orig	Thu Jun 28 17:28:15 2012
+++ src/util.c	Thu Jul  5 09:01:58 2012
@@@@ -32,11 +32,20 @@@@
a15 1
+kvm_t *kd;
d24 1
a24 1
   gchar *ret;
d27 1
a27 1
@@@@ -70,7 +79,30 @@@@ get_cmdline_of_pid (GPid pid)
d32 1
@


1.8
log
@SECURITY update to accountsservice-0.6.22.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_util_c,v 1.7 2012/03/28 09:05:54 ajacoutot Exp $
d33 1
a33 1
+  gchar *ret;
@


1.7
log
@Update to accountsservice-0.6.17.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_util_c,v 1.6 2012/01/08 19:42:02 naddy Exp $
d5 3
a7 3
--- src/util.c.orig	Mon Mar 26 22:39:21 2012
+++ src/util.c	Wed Mar 28 10:52:44 2012
@@@@ -32,6 +32,14 @@@@
d21 2
a22 2
 
@@@@ -40,11 +48,13 @@@@ _polkit_subject_get_cmdline (PolkitSubject *subject, g
d24 1
a24 1
   PolkitSubject *process;
a25 2
+  GError *error;
+#ifndef __OpenBSD__
d28 3
a30 27
   gsize contents_len;
-  GError *error;
   guint n;
+#endif
 
   g_return_val_if_fail (subject != NULL, NULL);
 
@@@@ -52,8 +62,10 @@@@ _polkit_subject_get_cmdline (PolkitSubject *subject, g
 
   ret = NULL;
   process = NULL;
+#ifndef __OpenBSD__
   filename = NULL;
   contents = NULL;
+#endif
 
   if (POLKIT_IS_UNIX_PROCESS (subject))
    {
@@@@ -82,6 +94,7 @@@@ _polkit_subject_get_cmdline (PolkitSubject *subject, g
   *pid = polkit_unix_process_get_pid (POLKIT_UNIX_PROCESS (process));
   *uid = polkit_unix_process_get_uid (POLKIT_UNIX_PROCESS (process));
 
+#ifndef __OpenBSD__
   filename = g_strdup_printf ("/proc/%d/cmdline", *pid);
 
   if (!g_file_get_contents (filename,
@@@@ -110,6 +123,28 @@@@ _polkit_subject_get_cmdline (PolkitSubject *subject, g
d32 2
a33 3
   if (process != NULL)
     g_object_unref (process);
+#else
d37 1
a37 1
+
d39 1
a39 1
+    return ret;
d41 1
a41 1
+  if ((kp = kvm_getprocs(kd, KERN_PROC_PID, *pid, sizeof(*kp), &nproc)) == NULL)
d55 1
d59 1
a59 27
@@@@ -164,14 +199,17 @@@@ get_caller_loginuid (GDBusMethodInvocation *context, g
         gchar *cmdline;
         gint pid;
         gint uid;
+#ifndef __OpenBSD__
         gchar *path;
         gchar *buf;
+#endif
 
         subject = polkit_system_bus_name_new (g_dbus_method_invocation_get_sender (context));
         cmdline = _polkit_subject_get_cmdline (subject, &pid, &uid);
         g_free (cmdline);
         g_object_unref (subject);
 
+#ifndef __OpenBSD__
         path = g_strdup_printf ("/proc/%d/loginuid", pid);
         if (g_file_get_contents (path, &buf, NULL, NULL)) {
                 strncpy (loginuid, buf, size);
@@@@ -182,17 +220,22 @@@@ get_caller_loginuid (GDBusMethodInvocation *context, g
         }
 
         g_free (path);
+#else
+        g_snprintf (loginuid, size, "%d", uid);
+#endif
 }
 
@


1.6
log
@catch up with KERN_PROC2 -> KERN_PROC change
@
text
@d1 1
a1 1
$OpenBSD: patch-src_util_c,v 1.5 2011/10/29 11:00:39 ajacoutot Exp $
d5 3
a7 3
--- src/util.c.orig	Mon Oct 17 21:30:22 2011
+++ src/util.c	Sat Oct 29 12:43:45 2011
@@@@ -35,6 +35,14 @@@@
d22 1
a22 1
@@@@ -43,11 +51,13 @@@@ _polkit_subject_get_cmdline (PolkitSubject *subject, g
d37 1
a37 1
@@@@ -55,8 +65,10 @@@@ _polkit_subject_get_cmdline (PolkitSubject *subject, g
d48 1
a48 1
@@@@ -85,6 +97,7 @@@@ _polkit_subject_get_cmdline (PolkitSubject *subject, g
d56 1
a56 1
@@@@ -113,6 +126,28 @@@@ _polkit_subject_get_cmdline (PolkitSubject *subject, g
d85 1
a85 1
@@@@ -167,14 +202,17 @@@@ get_caller_loginuid (DBusGMethodInvocation *context, g
d94 1
a94 1
         subject = polkit_system_bus_name_new (dbus_g_method_get_sender (context));
d103 1
a103 1
@@@@ -185,17 +223,22 @@@@ get_caller_loginuid (DBusGMethodInvocation *context, g
@


1.5
log
@Bugfix update to accountsservice-0.6.15.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_util_c,v 1.4 2011/09/08 13:15:52 ajacoutot Exp $
d68 1
a68 1
+  if ((kp = kvm_getproc2(kd, KERN_PROC_PID, *pid, sizeof(*kp), &nproc)) == NULL)
d74 1
a74 1
+  if ((pargv = kvm_getargv2(kd, kp, 0)) == NULL)
@


1.4
log
@Update to accountsservice-0.6.14. Still needs some major work.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_util_c,v 1.3 2011/05/29 08:27:05 ajacoutot Exp $
d5 2
a6 11
--- src/util.c.orig	Tue Aug 16 14:53:31 2011
+++ src/util.c	Thu Sep  8 14:14:07 2011
@@@@ -25,7 +25,7 @@@@
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <fcntl.h>
-#include <wait.h>
+#include <sys/wait.h>
 #include <grp.h>
 
 #include <syslog.h>
@


1.3
log
@Fix several users management related functions.
@
text
@d1 1
a1 1
$OpenBSD: patch-src_util_c,v 1.2 2011/05/23 08:22:43 ajacoutot Exp $
d5 2
a6 2
--- src/util.c.orig	Thu May 19 05:38:50 2011
+++ src/util.c	Sun May 29 09:42:39 2011
d59 1
a59 1
   *uid = polkit_unix_process_get_owner (POLKIT_UNIX_PROCESS (process), NULL);
@


1.2
log
@Don't try to open /proc, use kvm(3) instead.
reviewed by robert@@
@
text
@d1 1
a1 1
$OpenBSD: patch-src_util_c,v 1.1.1.1 2011/05/22 10:57:32 ajacoutot Exp $
d6 1
a6 1
+++ src/util.c	Mon May 23 10:16:36 2011
@


1.1
log
@Initial revision
@
text
@d1 6
a6 3
$OpenBSD$
--- src/util.c.orig	Sun May 22 12:26:39 2011
+++ src/util.c	Sun May 22 12:26:45 2011
d16 119
@


1.1.1.1
log
@Import accountsservice-0.6.12.

The AccountsService project provides:
    * A set of D-Bus interfaces for querying and manipulating user
      account information.
    * An implementation of these interfaces based on the usermod(8),
      useradd(8) and userdel(8) commands

ok jasper@@ ("though I'm surprised they didn't name it 'accountskit'")
@
text
@@
