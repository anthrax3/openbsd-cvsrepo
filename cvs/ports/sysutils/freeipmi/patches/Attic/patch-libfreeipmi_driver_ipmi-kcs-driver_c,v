head	1.2;
access;
symbols
	OPENBSD_5_9:1.1.0.2
	OPENBSD_5_9_BASE:1.1;
locks; strict;
comment	@# @;


1.2
date	2016.03.15.22.22.05;	author sthen;	state dead;
branches;
next	1.1;
commitid	QHflZOadJWRXd0Y6;

1.1
date	2015.08.11.21.12.45;	author sthen;	state Exp;
branches;
next	;
commitid	isJQq8Fh5d4gqZGJ;


desc
@@


1.2
log
@Remove wilfried@@'s _iopl patches from freeipmi, in-band support is now
available via /dev/ipmi0 (if enabled in the kernel) which is less dangerous
than securelevel=-1 and direct io writes.
@
text
@$OpenBSD: patch-libfreeipmi_driver_ipmi-kcs-driver_c,v 1.1 2015/08/11 21:12:45 sthen Exp $
--- libfreeipmi/driver/ipmi-kcs-driver.c.orig	Fri Jan  3 16:45:22 2014
+++ libfreeipmi/driver/ipmi-kcs-driver.c	Thu Jul 30 15:04:29 2015
@@@@ -150,6 +150,7 @@@@
 # include <machine/sysarch.h>
 #elif defined(__NetBSD__) || defined(__OpenBSD__)
 # include <machine/pio.h>               /* inb/outb */
+# include <sys/types.h>
 # include <machine/sysarch.h>   /* sysarch call */
 #elif defined(HAVE_SYS_IO_H)
 /* Linux, _AXP_ */
@@@@ -488,7 +489,22 @@@@ ipmi_kcs_ctx_io_init (ipmi_kcs_ctx_t ctx)
   if (ctx->io_init)
     goto out;
 
-#ifdef __FreeBSD__
+#ifdef __OpenBSD__
+# if defined(__amd64__)
+  if (amd64_iopl (3) < 0)
+# elif defined(__i386__)
+  if (i386_iopl (3) < 0)
+# else
+  if (0)
+# endif
+    {
+      if (errno == EPERM || errno == EACCES)
+        ctx->errnum = IPMI_KCS_ERR_PERMISSION;
+      else
+        KCS_ERRNO_TO_KCS_ERRNUM (ctx, errno);
+      return (-1);
+    }
+#elif __FreeBSD__
 #ifdef USE_IOPERM
   /* i386_set_ioperm has known problems on FBSD 5.x (bus errors). */
   if (i386_set_ioperm (ctx->driver_address, 0x02, 0x01))
@


1.1
log
@update to freeipmi-1.4.9
@
text
@d1 1
a1 1
$OpenBSD$
@

