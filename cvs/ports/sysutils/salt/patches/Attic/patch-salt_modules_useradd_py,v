head	1.7;
access;
symbols
	OPENBSD_5_7:1.6.0.2
	OPENBSD_5_7_BASE:1.6;
locks; strict;
comment	@# @;


1.7
date	2015.05.07.09.15.55;	author ajacoutot;	state dead;
branches;
next	1.6;
commitid	SwUliQR8dTPaJwzy;

1.6
date	2015.01.16.13.19.48;	author ajacoutot;	state Exp;
branches;
next	1.5;
commitid	l1qaoWaTD8eUURBn;

1.5
date	2015.01.07.09.57.40;	author ajacoutot;	state Exp;
branches;
next	1.4;
commitid	ljrBzwpr23CjpR5G;

1.4
date	2014.09.02.17.18.55;	author ajacoutot;	state Exp;
branches;
next	1.3;
commitid	rpydUm4DHSmllnK2;

1.3
date	2014.08.29.15.58.32;	author ajacoutot;	state Exp;
branches;
next	1.2;
commitid	2Wc3yaPV7lP3QBi6;

1.2
date	2014.08.26.21.41.43;	author ajacoutot;	state Exp;
branches;
next	1.1;
commitid	QXwXV4VXjtDAyWGh;

1.1
date	2014.08.26.16.28.43;	author ajacoutot;	state Exp;
branches;
next	;
commitid	I6MZBioa1ty0RSJk;


desc
@@


1.7
log
@Update to salt-2015.5.0.
@
text
@$OpenBSD: patch-salt_modules_useradd_py,v 1.6 2015/01/16 13:19:48 ajacoutot Exp $

https://github.com/saltstack/salt/commit/9feb62718a19420054313898b78d36263fb6db7f
https://github.com/saltstack/salt/commit/e7df337b5549309867e672ea3362f63b584d5c98

--- salt/modules/useradd.py.orig	Wed Jan 14 19:38:21 2015
+++ salt/modules/useradd.py	Fri Jan 16 14:12:43 2015
@@@@ -29,7 +29,7 @@@@ __virtualname__ = 'user'
 
 def __virtual__():
     '''
-    Set the user module if the kernel is Linux or OpenBSD
+    Set the user module if the kernel is Linux, OpenBSD or NetBSD
     and remove some of the functionality on OS X
     '''
 
@@@@ -78,7 +78,8 @@@@ def add(name,
         roomnumber='',
         workphone='',
         homephone='',
-        createhome=True):
+        createhome=True,
+        loginclass=None):
     '''
     Add a user to the minion
 
@@@@ -96,24 +97,43 @@@@ def add(name,
     if gid not in (None, ''):
         cmd.extend(['-g', str(gid)])
     elif groups is not None and name in groups:
-        try:
-            for line in salt.utils.fopen('/etc/login.defs'):
-                if 'USERGROUPS_ENAB' not in line[:15]:
-                    continue
+        if __grains__['kernel'] != 'OpenBSD':
+            try:
+                for line in salt.utils.fopen('/etc/login.defs'):
+                    if 'USERGROUPS_ENAB' not in line[:15]:
+                        continue
 
-                if 'yes' in line:
-                    cmd.extend([
-                        '-g', str(__salt__['file.group_to_gid'](name))
-                    ])
+                    if 'yes' in line:
+                        cmd.extend([
+                            '-g', str(__salt__['file.group_to_gid'](name))
+                        ])
 
-                # We found what we wanted, let's break out of the loop
-                break
-        except OSError:
-            log.debug('Error reading /etc/login.defs', exc_info=True)
+                    # We found what we wanted, let's break out of the loop
+                    break
+            except OSError:
+                log.debug('Error reading /etc/login.defs', exc_info=True)
+        else:
+            try:
+                for line in salt.utils.fopen('/etc/usermgmt.conf'):
+                    if 'group' not in line[:5]:
+                        continue
 
+                    for val in line.split(" "):
+                        cmd.extend([
+                            '-g', str(val[1])
+                        ])
+
+                    # We found what we wanted, let's break out of the loop
+                    break
+            except OSError:
+                # /etc/usermgmt.conf not present: defaults will be used
+                pass
+
     if createhome:
         cmd.append('-m')
-    elif createhome is False:
+    elif (createhome is False
+          and __grains__['kernel'] != 'NetBSD'
+          and __grains__['kernel'] != 'OpenBSD'):
         cmd.append('-M')
 
     if home is not None:
@@@@ -122,9 +142,15 @@@@ def add(name,
     if not unique:
         cmd.append('-o')
 
-    if system and __grains__['kernel'] != 'NetBSD':
+    if (system
+        and __grains__['kernel'] != 'NetBSD'
+        and __grains__['kernel'] != 'OpenBSD'):
         cmd.append('-r')
 
+    if __grains__['kernel'] == 'OpenBSD':
+        if loginclass is not None:
+            cmd.extend(['-L', loginclass])
+
     cmd.append(name)
 
     ret = __salt__['cmd.run_all'](cmd, python_shell=False)
@@@@ -168,7 +194,7 @@@@ def delete(name, remove=False, force=False):
     if remove:
         cmd.append('-r')
 
-    if force:
+    if force and __grains__['kernel'] != 'OpenBSD':
         cmd.append('-f')
 
     cmd.append(name)
@@@@ -295,7 +321,7 @@@@ def chhome(name, home, persist=False):
     if home == pre_info['home']:
         return True
     cmd = ['usermod', '-d', home]
-    if persist:
+    if persist and __grains__['kernel'] != 'OpenBSD':
         cmd.append('-m')
     cmd.append(name)
     __salt__['cmd.run'](cmd, python_shell=False)
@@@@ -322,9 +348,15 @@@@ def chgroups(name, groups, append=False):
     if ugrps == set(groups):
         return True
     cmd = ['usermod']
-    if append:
-        cmd.append('-a')
-    cmd.extend(['-G', ','.join(groups), name])
+    if __grains__['kernel'] != 'OpenBSD':
+        if append:
+            cmd.append('-a')
+        cmd.extend(['-G', ','.join(groups), name])
+    else:
+        if append:
+            cmd.extend(['-G', ','.join(groups), name])
+        else:
+            cmd.extend(['-S', ','.join(groups), name])
     cmdret = __salt__['cmd.run_all'](cmd, python_shell=False)
     ret = not cmdret['retcode']
     # try to fallback on gpasswd to add user to localgroups
@@@@ -443,6 +475,29 @@@@ def chhomephone(name, homephone):
     return False
 
 
+def chloginclass(name, loginclass):
+    '''
+    Change the default login class of the user
+
+    CLI Example:
+
+    .. code-block:: bash
+
+        salt '*' user.chloginclass foo staff
+    '''
+    if __grains__['kernel'] != 'OpenBSD':
+        return False
+    pre_info = get_loginclass(name)
+    if loginclass == pre_info['loginclass']:
+        return True
+    cmd = 'usermod -L {0} {1}'.format(loginclass, name)
+    __salt__['cmd.run'](cmd)
+    post_info = get_loginclass(name)
+    if post_info['loginclass'] != pre_info['loginclass']:
+        return post_info['loginclass'] == loginclass
+    return False
+
+
 def info(name):
     '''
     Return user information
@@@@ -459,6 +514,29 @@@@ def info(name):
         return {}
     else:
         return _format_info(data)
+
+
+def get_loginclass(name):
+    '''
+    Get the login class of the user
+
+    CLI Example:
+
+    .. code-block:: bash
+
+        salt '*' user.get_loginclass foo
+    '''
+    if __grains__['kernel'] != 'OpenBSD':
+        return False
+    info = __salt__['cmd.run_stdout']('userinfo {0}'.format(name),
+        output_loglevel='debug')
+    for line in info.splitlines():
+        if line.startswith("class"):
+            loginclass = line.split()
+    if len(loginclass) == 2:
+        return {'loginclass': loginclass[1]}
+    else:
+        return {'loginclass': '""'}
 
 
 def _format_info(data):
@


1.6
log
@Update to salt-2014.7.1.
@
text
@d1 1
a1 1
$OpenBSD: patch-salt_modules_useradd_py,v 1.5 2015/01/07 09:57:40 ajacoutot Exp $
@


1.5
log
@Update to salt-2014.7.0.
@
text
@d1 1
a1 1
$OpenBSD: patch-salt_modules_useradd_py,v 1.4 2014/09/02 17:18:55 ajacoutot Exp $
d6 2
a7 2
--- salt/modules/useradd.py.orig	Mon Nov  3 20:38:21 2014
+++ salt/modules/useradd.py	Wed Jan  7 10:37:53 2015
d100 1
a100 1
     ret = __salt__['cmd.run_all'](' '.join(cmd))
d113 1
a113 1
     cmd = 'usermod -d {0} '.format(home)
d116 4
a119 4
         cmd += ' -m '
     cmd += name
     __salt__['cmd.run'](cmd)
@@@@ -322,9 +348,17 @@@@ def chgroups(name, groups, append=False):
d122 1
a122 1
     cmd = 'usermod '
d124 2
a125 2
-        cmd += '-a '
-    cmd += '-G "{0}" {1}'.format(','.join(groups), name)
d128 2
a129 1
+            cmd += '-a '
d132 1
a132 1
+            cmd += '-G '
d134 2
a135 5
+            cmd += '-S '
+    if __grains__['kernel'] != 'OpenBSD':
+        cmd += '-G '
+    cmd += '"{0}" {1}'.format(','.join(groups), name)
     cmdret = __salt__['cmd.run_all'](cmd)
d138 1
a138 1
@@@@ -443,6 +477,29 @@@@ def chhomephone(name, homephone):
d168 1
a168 1
@@@@ -459,6 +516,29 @@@@ def info(name):
@


1.4
log
@All patches have been committed upstream.
@
text
@d1 1
a1 1
$OpenBSD: patch-salt_modules_useradd_py,v 1.3 2014/08/29 15:58:32 ajacoutot Exp $
d6 2
a7 2
--- salt/modules/useradd.py.orig	Fri Aug  1 20:38:41 2014
+++ salt/modules/useradd.py	Fri Aug 29 17:36:11 2014
d137 4
a140 4
     return not __salt__['cmd.retcode'](cmd)
 
 
@@@@ -432,6 +466,29 @@@@ def chhomephone(name, homephone):
d170 1
a170 1
@@@@ -448,6 +505,29 @@@@ def info(name):
@


1.3
log
@Implement login class support.
@
text
@d1 1
a1 1
$OpenBSD: patch-salt_modules_useradd_py,v 1.2 2014/08/26 21:41:43 ajacoutot Exp $
d4 1
a4 1
https://github.com/saltstack/salt/pull/15385
@


1.2
log
@All patches have been pushed upstream.
@
text
@d1 1
a1 1
$OpenBSD: patch-salt_modules_useradd_py,v 1.1 2014/08/26 16:28:43 ajacoutot Exp $
d4 1
d7 1
a7 1
+++ salt/modules/useradd.py	Tue Aug 26 17:18:01 2014
d17 11
a27 1
@@@@ -96,24 +96,43 @@@@ def add(name,
d84 1
a84 1
@@@@ -122,7 +141,9 @@@@ def add(name,
d94 4
d99 3
a101 1
@@@@ -168,7 +189,7 @@@@ def delete(name, remove=False, force=False):
d110 1
a110 1
@@@@ -295,7 +316,7 @@@@ def chhome(name, home, persist=False):
d119 1
a119 1
@@@@ -322,9 +343,17 @@@@ def chgroups(name, groups, append=False):
d140 60
@


1.1
log
@Fix the useradd module to work with OpenBSD.
@
text
@d1 1
a1 1
$OpenBSD$
d3 1
a3 1
https://github.com/saltstack/salt/pull/15284
@

