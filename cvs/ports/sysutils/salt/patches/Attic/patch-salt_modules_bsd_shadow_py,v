head	1.6;
access;
symbols
	OPENBSD_5_7:1.5.0.2
	OPENBSD_5_7_BASE:1.5;
locks; strict;
comment	@# @;


1.6
date	2015.05.07.09.15.55;	author ajacoutot;	state dead;
branches;
next	1.5;
commitid	SwUliQR8dTPaJwzy;

1.5
date	2015.01.16.13.19.48;	author ajacoutot;	state Exp;
branches;
next	1.4;
commitid	l1qaoWaTD8eUURBn;

1.4
date	2014.09.02.17.18.55;	author ajacoutot;	state Exp;
branches;
next	1.3;
commitid	rpydUm4DHSmllnK2;

1.3
date	2014.09.01.10.04.00;	author ajacoutot;	state Exp;
branches;
next	1.2;
commitid	BtH9zLfcwCul28CO;

1.2
date	2014.08.28.06.32.56;	author ajacoutot;	state Exp;
branches;
next	1.1;
commitid	qyv034GSMCAziAWR;

1.1
date	2014.08.27.10.26.59;	author ajacoutot;	state Exp;
branches;
next	;
commitid	NnWFttYEMByBmHsl;


desc
@@


1.6
log
@Update to salt-2015.5.0.
@
text
@$OpenBSD: patch-salt_modules_bsd_shadow_py,v 1.5 2015/01/16 13:19:48 ajacoutot Exp $

https://github.com/saltstack/salt/commit/2e4318132e53451658777924b66e0e38b7c7b0ac
https://github.com/saltstack/salt/commit/af6f374db57fbbee8fceeadea7c50dcde833a40a

--- salt/modules/bsd_shadow.py.orig	Wed Jan 14 19:38:21 2015
+++ salt/modules/bsd_shadow.py	Fri Jan 16 13:47:50 2015
@@@@ -55,20 +55,74 @@@@ def info(name):
             'name': '',
             'passwd': ''}
 
-    # Get password aging info on FreeBSD
-    # TODO: Implement this for NetBSD, OpenBSD
+    cmd = ""
     if __salt__['cmd.has_exec']('pw'):
-        cmd = 'pw user show {0} | cut -f6,7 -d:'.format(_cmd_quote(name))
+        cmd = 'pw user show {0}'.format(_cmd_quote(name))
+    elif __grains__['kernel'] in ('NetBSD', 'OpenBSD'):
+        cmd = 'grep "^{0}:" /etc/master.passwd'.format(_cmd_quote(name))
+
+    if cmd:
+        cmd += '| cut -f6,7 -d:'
         try:
             change, expire = __salt__['cmd.run_all'](cmd, python_shell=True)['stdout'].split(':')
         except ValueError:
             pass
         else:
-            ret['change'] = change
-            ret['expire'] = expire
+            ret['change'] = int(change)
+            ret['expire'] = int(expire)
 
     return ret
 
+
+def set_change(name, change):
+    '''
+    Sets the time at which the password expires (in seconds since the EPOCH).
+    See man usermod on NetBSD and OpenBSD or man pw on FreeBSD.
+    "0" means the password never expires.
+
+    CLI Example:
+
+    .. code-block:: bash
+
+        salt '*' shadow.set_change username 1419980400
+    '''
+    pre_info = info(name)
+    if change == pre_info['change']:
+        return True
+    if __grains__['kernel'] == 'FreeBSD':
+        cmd = 'pw user mod {0} -f {1}'.format(name, change)
+    else:
+        cmd = 'usermod -f {0} {1}'.format(change, name)
+    __salt__['cmd.run'](cmd)
+    post_info = info(name)
+    if post_info['change'] != pre_info['change']:
+        return post_info['change'] == change
+
+
+def set_expire(name, expire):
+    '''
+    Sets the time at which the account expires (in seconds since the EPOCH).
+    See man usermod on NetBSD and OpenBSD or man pw on FreeBSD.
+    "0" means the account never expires.
+
+    CLI Example:
+
+    .. code-block:: bash
+
+        salt '*' shadow.set_expire username 1419980400
+    '''
+    pre_info = info(name)
+    if expire == pre_info['expire']:
+        return True
+    if __grains__['kernel'] == 'FreeBSD':
+        cmd = 'pw user mod {0} -e {1}'.format(name, expire)
+    else:
+        cmd = 'usermod -e {0} {1}'.format(expire, name)
+    __salt__['cmd.run'](cmd)
+    post_info = info(name)
+    if post_info['expire'] != pre_info['expire']:
+        return post_info['expire'] == expire
+ 
 
 def set_password(name, password):
     '''
@


1.5
log
@Update to salt-2014.7.1.
@
text
@d1 1
a1 1
$OpenBSD: patch-salt_modules_bsd_shadow_py,v 1.4 2014/09/02 17:18:55 ajacoutot Exp $
@


1.4
log
@All patches have been committed upstream.
@
text
@d1 1
a1 1
$OpenBSD: patch-salt_modules_bsd_shadow_py,v 1.3 2014/09/01 10:04:00 ajacoutot Exp $
d6 3
a8 3
--- salt/modules/bsd_shadow.py.orig	Tue Jun 17 21:18:30 2014
+++ salt/modules/bsd_shadow.py	Mon Sep  1 11:51:09 2014
@@@@ -50,19 +50,73 @@@@ def info(name):
d16 2
a17 2
-        cmd = 'pw user show {0} | cut -f6,7 -d:'.format(name)
+        cmd = 'pw user show {0}'.format(name)
d19 1
a19 1
+        cmd = 'grep "^{0}:" /etc/master.passwd'.format(name)
d24 1
a24 1
             change, expire = __salt__['cmd.run_all'](cmd)['stdout'].split(':')
d34 1
a34 1
+
d84 1
a84 1
 
d87 1
@


1.3
log
@Add support for account and password expiration.
@
text
@d1 1
a1 1
$OpenBSD: patch-salt_modules_bsd_shadow_py,v 1.2 2014/08/28 06:32:56 ajacoutot Exp $
d4 1
a4 1
https://github.com/saltstack/salt/pull/15412
@


1.2
log
@Everything has been merged uptream.
@
text
@d1 1
a1 1
$OpenBSD: patch-salt_modules_bsd_shadow_py,v 1.1 2014/08/27 10:26:59 ajacoutot Exp $
d4 1
d7 2
a8 2
+++ salt/modules/bsd_shadow.py	Wed Aug 27 09:41:10 2014
@@@@ -50,10 +50,14 @@@@ def info(name):
d26 61
@


1.1
log
@Fix and implement OpenBSD support in the following modules:
bsd_shadow, disk, groupadd
@
text
@d1 1
a1 1
$OpenBSD$
d3 1
a3 1
https://github.com/saltstack/salt/pull/15306
@

