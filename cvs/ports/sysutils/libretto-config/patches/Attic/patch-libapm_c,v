head	1.3;
access;
symbols
	OPENBSD_5_9:1.2.0.48
	OPENBSD_5_9_BASE:1.2
	OPENBSD_5_8:1.2.0.50
	OPENBSD_5_8_BASE:1.2
	OPENBSD_5_7:1.2.0.46
	OPENBSD_5_7_BASE:1.2
	OPENBSD_5_6:1.2.0.44
	OPENBSD_5_6_BASE:1.2
	OPENBSD_5_5:1.2.0.42
	OPENBSD_5_5_BASE:1.2
	OPENBSD_5_4:1.2.0.40
	OPENBSD_5_4_BASE:1.2
	OPENBSD_5_3:1.2.0.38
	OPENBSD_5_3_BASE:1.2
	OPENBSD_5_2:1.2.0.36
	OPENBSD_5_2_BASE:1.2
	OPENBSD_5_1_BASE:1.2
	OPENBSD_5_1:1.2.0.34
	OPENBSD_5_0:1.2.0.32
	OPENBSD_5_0_BASE:1.2
	OPENBSD_4_9:1.2.0.30
	OPENBSD_4_9_BASE:1.2
	OPENBSD_4_8:1.2.0.28
	OPENBSD_4_8_BASE:1.2
	OPENBSD_4_7:1.2.0.26
	OPENBSD_4_7_BASE:1.2
	OPENBSD_4_6:1.2.0.24
	OPENBSD_4_6_BASE:1.2
	OPENBSD_4_5:1.2.0.22
	OPENBSD_4_5_BASE:1.2
	OPENBSD_4_4:1.2.0.20
	OPENBSD_4_4_BASE:1.2
	OPENBSD_4_3:1.2.0.18
	OPENBSD_4_3_BASE:1.2
	OPENBSD_4_2:1.2.0.16
	OPENBSD_4_2_BASE:1.2
	OPENBSD_4_1:1.2.0.14
	OPENBSD_4_1_BASE:1.2
	OPENBSD_4_0:1.2.0.12
	OPENBSD_4_0_BASE:1.2
	OPENBSD_3_9:1.2.0.10
	OPENBSD_3_9_BASE:1.2
	OPENBSD_3_8:1.2.0.8
	OPENBSD_3_8_BASE:1.2
	OPENBSD_3_7:1.2.0.6
	OPENBSD_3_7_BASE:1.2
	OPENBSD_3_6:1.2.0.4
	OPENBSD_3_6_BASE:1.2
	OPENBSD_3_5:1.2.0.2
	OPENBSD_3_5_BASE:1.2;
locks; strict;
comment	@# @;


1.3
date	2016.03.18.14.33.51;	author sebastia;	state dead;
branches;
next	1.2;
commitid	Y4SQOeItzEVDNJ9D;

1.2
date	2004.02.18.17.10.12;	author espie;	state Exp;
branches;
next	1.1;

1.1
date	2004.02.01.01.35.52;	author millert;	state Exp;
branches;
next	;


desc
@@


1.3
log
@Remove old not useful anymore port
@
text
@$OpenBSD: patch-libapm_c,v 1.2 2004/02/18 17:10:12 espie Exp $
--- libapm.c.orig	1998-06-19 02:28:23.000000000 +0200
+++ libapm.c	2004-02-18 18:03:01.000000000 +0100
@@@@ -17,6 +17,9 @@@@
 #include <fcntl.h>
 #include <unistd.h>
 #include <sys/mman.h>
+#if defined(__OpenBSD__) || defined(__NetBSD__)
+#include <machine/sysarch.h>
+#endif
 #include "libapm.h"
 
 #ifndef CMOS_ACCESS
@@@@ -63,20 +66,20 @@@@ int main(int argc, char *argv[])
     int r;
     char c;
 
-    struct option longopts[] = {
-      { "Help",        0, 0, 'h' },
-      { "Version",     0, 0, 'v' },
-      { "PowerUp",     1, 0, 'P' },
-      { "StandbyTime", 1, 0, 'T' },
-      { "AutoOff",     1, 0, 'a' },
-      { "PanelSwitch", 1, 0, 'S' },
-      { "AlarmOn",     1, 0, 'A' },
-      { "LcdPower",    1, 0, 'L' },
+    static struct option longopts[] = {
+      { "Help",        no_argument, NULL, 'h' },
+      { "Version",     no_argument, NULL, 'v' },
+      { "PowerUp",     required_argument, NULL, 'P' },
+      { "StandbyTime", required_argument, NULL, 'T' },
+      { "AutoOff",     required_argument, NULL, 'a' },
+      { "PanelSwitch", required_argument, NULL, 'S' },
+      { "AlarmOn",     required_argument, NULL, 'A' },
+      { "LcdPower",    required_argument, NULL, 'L' },
 #ifndef CMOS_ACCESS
-      { "Volume",      1, 0, 'V' },
-      { "Off",         1, 0, 'O' },
+      { "Volume",      required_argument, NULL, 'V' },
+      { "Off",         required_argument, NULL, 'O' },
 #endif /* CMOS_ACCESS */
-      {0, 0, 0, 0}
+      {NULL, 0, NULL, 0}
     };
 
     if( 0 != geteuid() ){
@@@@ -101,9 +104,6 @@@@ int main(int argc, char *argv[])
     while ((c = getopt_long(argc,argv,
                             "hvP:T:a:S:A:L:V:O:", longopts, NULL)) != -1) {
       switch (c) {
-        case 'h':
-          usage();
-          break;
         case 'v':
           printf("version : %s\n", version);
           exit(0);
@@@@ -186,10 +186,9 @@@@ int main(int argc, char *argv[])
           else usage();
           break;
 #endif /* CMOS_ACCESS */
-        case '?':
+        default:
           usage();
           break;
-        default:
       }
     }
 #ifdef DEBUG
@@@@ -215,29 +214,27 @@@@ int main(int argc, char *argv[])
 void usage(void)
 {
 #ifdef CMOS_ACCESS
-    printf("
-usage: libapm [-v --Version]
-              [-h --Help]
-              [-P --PowerUp {boot,hibernation}]
-              [-T --StandbyTime {0,5,10,15,30,45,60,unlimit}]
-              [-a --AutoOff {disable,10,20,30,40,50,60}]
-              [-S --PanelSwitch {disable,enable}]
-              [-A --AlarmOn {disable,<time>}]
-              [-L --LcdPower {0,1,2,3}]
-          \n");
-#else
-    printf("
-usage: libapm [-v --Version]
-              [-h --Help]
-              [-P --PowerUp {boot,hibernation}]
-              [-T --StandbyTime {0,5,10,15,30,45,60,unlimit}]
-              [-a --AutoOff {disable,10,20,30,40,50,60}]
-              [-S --PanelSwitch {disable,enable}]
-              [-A --AlarmOn {disable,<time>}]
-              [-L --LcdPower {0,1,2,3}]
-              [-V --Volume {0,1,2,3}]
-              [-O --Off {suspend|hibernation}  Use Only >= Libretto100]
-          \n");
+    printf("\
+usage: libretto-config [-v --Version]\n\
+                       [-h --Help]\n\
+                       [-P --PowerUp {boot,hibernation}]\n\
+                       [-T --StandbyTime {0,5,10,15,30,45,60,unlimit}]\n\
+                       [-a --AutoOff {disable,10,20,30,40,50,60}]\n\
+                       [-S --PanelSwitch {disable,enable}]\n\
+                       [-A --AlarmOn {disable,<time>}]\n\
+                       [-L --LcdPower {0,1,2,3}]\n");
+#else /* not CMOS_ACCESS */
+    printf("\
+usage: libretto-config [-v --Version]\n\
+                       [-h --Help]\n\
+                       [-P --PowerUp {boot,hibernation}]\n\
+                       [-T --StandbyTime {0,5,10,15,30,45,60,unlimit}]\n\
+                       [-a --AutoOff {disable,10,20,30,40,50,60}]\n\
+                       [-S --PanelSwitch {disable,enable}]\n\
+                       [-A --AlarmOn {disable,<time>}]\n\
+                       [-L --LcdPower {0,1,2,3}]\n\
+                       [-V --Volume {0,1,2,3}]\n\
+                       [-O --Off {suspend|hibernation}  Use Only >= Libretto100]\n");
 #endif /* CMOS_ACCESS */
     exit(1);
 }
@@@@ -246,7 +243,26 @@@@ usage: libapm [-v --Version]
 void init(void)
 {
   /* SMI port */
+#ifdef __linux__
   ioperm(0xb2, 1, 1);
+#elif defined(__OpenBSD__) || defined(__NetBSD__)
+  u_long iomap[32];
+
+  if (i386_get_ioperm(iomap)) {
+    perror("Cannot get ioperm table");
+    exit(1);
+  }
+  /* Allow access to SMI port (0x0b2) */
+  iomap[0x0b2 / 32] &= ~(1 << (0x0b2 % 32));
+  if (i386_set_ioperm(iomap)) {
+    perror("Cannot set ioperm table");
+    exit(1);
+  }
+#elif defined(__FreeBSD__)
+  open("/dev/io", O_RDWR, 0);
+#else
+# error cannot determine I/O port access method
+#endif
 }
 #endif /* CMOS_ACCESS */
 
@@@@ -754,30 +770,30 @@@@ void print_status(void)
 #endif /* CMOS_ACCESS */
 
 #ifndef CMOS_ACCESS
-    printf("
-Power Management for Libretto V%-8s
-+-----------------------------------------------------------+
-|   0) Power-up Mode      : %-32s|
-|   1) Standby Time       : %-32s|
-|   2) System Auto Off    : %-32s|
-|   3) Panel Power On/Off : %-32s|
-|   4) Alarm Power On     : %-32s|
-|   5) LCD Power          : %-32s|
-|   6) Volume             : %-32s|
-|   7) Off (Suspend/Hiber): %-32s|
-+-----------------------------------------------------------+\n\n",
+    printf("\n"
+"Power Management for Libretto V%-8s\n"
+"+-----------------------------------------------------------+\n"
+"|   0) Power-up Mode      : %-32s|\n"
+"|   1) Standby Time       : %-32s|\n"
+"|   2) System Auto Off    : %-32s|\n"
+"|   3) Panel Power On/Off : %-32s|\n"
+"|   4) Alarm Power On     : %-32s|\n"
+"|   5) LCD Power          : %-32s|\n"
+"|   6) Volume             : %-32s|\n"
+"|   7) Off (Suspend/Hiber): %-32s|\n"
+"+-----------------------------------------------------------+\n\n",
     version, s[0], s[1], s[2], s[3], s[4], s[5], s[6], s[7]);
 #else
-    printf("
-Power Management for Libretto V%-8s
-+-----------------------------------------------------------+
-|   0) Power-up Mode      : %-32s|
-|   1) Standby Time       : %-32s|
-|   2) System Auto Off    : %-32s|
-|   3) Panel Power On/Off : %-32s|
-|   4) Alarm Power On     : %-32s|
-|   5) LCD Power          : %-32s|
-+-----------------------------------------------------------+\n\n",
+    printf("\n"
+"Power Management for Libretto V%-8s\n"
+"+-----------------------------------------------------------+\n"
+"|   0) Power-up Mode      : %-32s|\n"
+"|   1) Standby Time       : %-32s|\n"
+"|   2) System Auto Off    : %-32s|\n"
+"|   3) Panel Power On/Off : %-32s|\n"
+"|   4) Alarm Power On     : %-32s|\n"
+"|   5) LCD Power          : %-32s|\n"
+"+-----------------------------------------------------------+\n\n",
     version, s[0], s[1], s[2], s[3], s[4], s[5]);
 #endif /* CMOS_ACCESS */
 }
@


1.2
log
@fix multiline string.
@
text
@d1 1
a1 1
$OpenBSD: patch-libapm_c,v 1.1 2004/02/01 01:35:52 millert Exp $
@


1.1
log
@We now have getopt_long so no need for a workaround.  Also fix multiline
strings to make gcc 3.x happy.
@
text
@d1 3
a3 3
$OpenBSD$
--- libapm.c.orig	Thu Jun 18 18:28:23 1998
+++ libapm.c	Sat Jan 31 18:31:53 2004
d147 53
@

