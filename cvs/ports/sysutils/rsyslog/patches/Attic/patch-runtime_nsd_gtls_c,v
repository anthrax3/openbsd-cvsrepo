head	1.3;
access;
symbols
	OPENBSD_5_9:1.1.0.16
	OPENBSD_5_9_BASE:1.1
	OPENBSD_5_8:1.1.0.18
	OPENBSD_5_8_BASE:1.1
	OPENBSD_5_7:1.1.0.14
	OPENBSD_5_7_BASE:1.1
	OPENBSD_5_6:1.1.0.12
	OPENBSD_5_6_BASE:1.1
	OPENBSD_5_5:1.1.0.10
	OPENBSD_5_5_BASE:1.1
	OPENBSD_5_4:1.1.0.8
	OPENBSD_5_4_BASE:1.1
	OPENBSD_5_3:1.1.0.6
	OPENBSD_5_3_BASE:1.1
	OPENBSD_5_2:1.1.0.4
	OPENBSD_5_2_BASE:1.1
	OPENBSD_5_1_BASE:1.1
	OPENBSD_5_1:1.1.0.2;
locks; strict;
comment	@# @;


1.3
date	2016.03.15.23.25.51;	author sthen;	state dead;
branches;
next	1.2;
commitid	hdjdqDkkTvrSnQLq;

1.2
date	2016.03.06.12.18.31;	author ajacoutot;	state Exp;
branches;
next	1.1;
commitid	fTCry8tQ0Sr40qyn;

1.1
date	2011.09.14.21.25.39;	author naddy;	state Exp;
branches;
next	;


desc
@@


1.3
log
@update to rsyslog-8.16.0, add sample config from chris@@

not heavily tested, but positive feedback from chris with pgsql logging,
and the version we had was ancient.
@
text
@$OpenBSD: patch-runtime_nsd_gtls_c,v 1.2 2016/03/06 12:18:31 ajacoutot Exp $

GnuTLS >= 2.12 does not depend on libgcrypt initialization any longer
and may in fact not use libgcrypt at all.

Fix build with GnuTLS 3.4.

--- runtime/nsd_gtls.c.orig	Sat Mar  5 19:44:38 2016
+++ runtime/nsd_gtls.c	Sat Mar  5 19:45:38 2016
@@@@ -29,7 +29,9 @@@@
 #include <string.h>
 #include <gnutls/gnutls.h>
 #include <gnutls/x509.h>
+#if GNUTLS_VERSION_NUMBER <= 0x020b00
 #include <gcrypt.h>
+#endif
 #include <errno.h>
 #include <sys/stat.h>
 #include <unistd.h>
@@@@ -53,7 +55,9 @@@@
 #define CRLFILE "crl.pem"
 
 
+#if GNUTLS_VERSION_NUMBER <= 0x020b00
 GCRY_THREAD_OPTION_PTHREAD_IMPL;
+#endif
 MODULE_TYPE_LIB
 
 /* static data */
@@@@ -225,13 +229,13 @@@@ static int
 gtlsClientCertCallback(gnutls_session session,
               __attribute__((unused)) const gnutls_datum* req_ca_rdn, int __attribute__((unused)) nreqs,
               __attribute__((unused)) const gnutls_pk_algorithm* sign_algos, int __attribute__((unused)) sign_algos_length,
-              gnutls_retr_st *st)
+              gnutls_retr2_st *st)
 {
 	nsd_gtls_t *pThis;
 
 	pThis = (nsd_gtls_t*) gnutls_session_get_ptr(session);
 
-	st->type = GNUTLS_CRT_X509;
+	st->cert_type = GNUTLS_CRT_X509;
 	st->ncerts = 1;
 	st->cert.x509 = &pThis->ourCert;
 	st->key.x509 = pThis->ourKey;
@@@@ -559,8 +563,10 @@@@ gtlsGlblInit(void)
 	uchar *cafile;
 	DEFiRet;
 
+#if GNUTLS_VERSION_NUMBER <= 0x020b00
 	/* gcry_control must be called first, so that the thread system is correctly set up */
 	gcry_control (GCRYCTL_SET_THREAD_CBS, &gcry_threads_pthread);
+#endif
 	CHKgnutls(gnutls_global_init());
 	
 	/* X509 stuff */
@@@@ -1610,7 +1616,7 @@@@ Connect(nsd_t *pNsd, int family, uchar *port, uchar *h
 	gnutls_session_set_ptr(pThis->sess, (void*)pThis);
 	iRet = gtlsLoadOurCertKey(pThis); /* first load .pem files */
 	if(iRet == RS_RET_OK) {
-		gnutls_certificate_client_set_retrieve_function(xcred, gtlsClientCertCallback);
+		gnutls_certificate_set_retrieve_function(xcred, gtlsClientCertCallback);
 	} else if(iRet != RS_RET_CERTLESS) {
 		FINALIZE; /* we have an error case! */
 	}
@


1.2
log
@Fix build with GnuTLS >= 3.4
On a side note, this port could use an update...
@
text
@d1 1
a1 1
$OpenBSD: patch-runtime_nsd_gtls_c,v 1.1 2011/09/14 21:25:39 naddy Exp $
@


1.1
log
@* Remove a hidden build dependency and unsatisfied run dependency
  on libgcrypt.  GnuTLS >= 2.12 does not depend on libgcrypt any longer.

* Don't add filename defines to CPPFLAGS; there are quoting problems
  and gcc4 ends up warning, gcc3 aborts.  Move the setting to
  Makefile.in.

* The database subpackages shouldn't depend on the exact REVISION
  of the main package.
@
text
@d1 1
a1 1
$OpenBSD$
d6 4
a9 2
--- runtime/nsd_gtls.c.orig	Wed Sep 14 03:05:03 2011
+++ runtime/nsd_gtls.c	Wed Sep 14 03:06:21 2011
d30 16
d57 9
@

