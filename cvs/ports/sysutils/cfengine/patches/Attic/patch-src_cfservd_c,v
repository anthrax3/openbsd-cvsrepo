head	1.5;
access;
symbols
	OPENBSD_4_2:1.4.0.8
	OPENBSD_4_2_BASE:1.4
	OPENBSD_4_1:1.4.0.6
	OPENBSD_4_1_BASE:1.4
	OPENBSD_4_0:1.4.0.4
	OPENBSD_4_0_BASE:1.4
	OPENBSD_3_9:1.4.0.2
	OPENBSD_3_9_BASE:1.4
	OPENBSD_3_8:1.3.0.2
	OPENBSD_3_8_BASE:1.3
	OPENBSD_3_7:1.2.0.2
	OPENBSD_3_7_BASE:1.2
	OPENBSD_3_6:1.1.0.2
	OPENBSD_3_6_BASE:1.1;
locks; strict;
comment	@# @;


1.5
date	2007.10.12.20.12.19;	author sturm;	state dead;
branches;
next	1.4;

1.4
date	2005.10.27.21.47.28;	author sturm;	state Exp;
branches;
next	1.3;

1.3
date	2005.07.21.15.16.46;	author aanriot;	state Exp;
branches;
next	1.2;

1.2
date	2004.10.01.21.22.15;	author sturm;	state Exp;
branches;
next	1.1;

1.1
date	2004.06.17.11.21.43;	author sturm;	state Exp;
branches;
next	;


desc
@@


1.5
log
@update to cfengine 2.2.1
simplify port drastically by removing str* patches, these might be
revived one day as an external patch

no objections from maintainer
@
text
@$OpenBSD: patch-src_cfservd_c,v 1.4 2005/10/27 21:47:28 sturm Exp $
--- src/cfservd.c.orig	Thu Sep 22 15:57:18 2005
+++ src/cfservd.c	Fri Oct 21 16:35:55 2005
@@@@ -171,10 +171,10 @@@@ void CheckOptsAndInit(int argc,char **ar
   int c;
 
 SetContext("server");
-sprintf(VPREFIX, "cfservd");
+(void)snprintf(VPREFIX, 40, "cfservd");
 CfOpenLog();
-strcpy(VINPUTFILE,CFD_INPUT);
-strcpy(CFLOCK,"cfservd");
+(void)strlcpy(VINPUTFILE,CFD_INPUT,CF_BUFSIZE);
+(void)strlcpy(CFLOCK,"cfservd",sizeof(CFLOCK));
 OUTPUT[0] = '\0';
 
 /*
@@@@ -272,15 +272,15 @@@@ if ((CFSTARTTIME = time((time_t *)NULL))
 
  /* XXX Initialize workdir for non privileged users */
 
- strcpy(CFWORKDIR,WORKDIR);
+ (void)strlcpy(CFWORKDIR,WORKDIR,sizeof(CFWORKDIR));
 
  if (getuid() > 0)
     {
     char *homedir;
     if ((homedir = getenv("HOME")) != NULL)
        {
-       strcpy(CFWORKDIR,homedir);
-       strcat(CFWORKDIR,"/.cfagent");
+       (void)strlcpy(CFWORKDIR,homedir,sizeof(CFWORKDIR));
+       (void)strlcat(CFWORKDIR,"/.cfagent",sizeof(CFWORKDIR));
        }
     }
 
@@@@ -293,7 +293,7 @@@@ strncpy(VLOCKDIR,CFWORKDIR,CF_BUFSIZE-1)
 VIFELAPSED = CF_EXEC_IFELAPSED;
 VEXPIREAFTER = CF_EXEC_EXPIREAFTER;
  
-strcpy(VDOMAIN,"undefined.domain");
+(void)strlcpy(VDOMAIN,"undefined.domain",sizeof(VDOMAIN));
 
 VCANONICALFILE = strdup(CanonifyName(VINPUTFILE));
 VREPOSITORY = strdup("\0");
@@@@ -1057,7 +1057,7 @@@@ if (CFDSTARTTIME < newstat.st_mtime)
    DeleteItemList(VIMPORT);
    DeleteAuthList(VADMIT);
    DeleteAuthList(VDENY);
-   strcpy(VDOMAIN,"undefined.domain");
+   (void)strlcpy(VDOMAIN,"undefined.domain",sizeof(VDOMAIN));
 
    VADMIT = VADMITTOP = NULL;
    VDENY  = VDENYTOP  = NULL;
@@@@ -1437,7 +1437,7 @@@@ switch (GetCommand(recvbuffer))
        
        if ((tloc = time((time_t *)NULL)) == -1)
           {
-          sprintf(conn->output,"Couldn't read system clock\n");
+          (void)snprintf(conn->output,CF_BUFSIZE*2,"Couldn't read system clock\n");
           CfLog(cfinform,conn->output,"time");
           SendTransaction(conn->sd_reply,"BAD: clocks out of synch",0,CF_DONE);
           return true;
@@@@ -1502,7 +1502,7 @@@@ switch (GetCommand(recvbuffer))
        
    }
  
- sprintf (sendbuffer,"BAD: Request denied\n");
+ (void)snprintf (sendbuffer,sizeof(sendbuffer),"BAD: Request denied\n");
  SendTransaction(conn->sd_reply,sendbuffer,0,CF_DONE);
  CfLog(cfinform,"Closing connection\n",""); 
  return false;
@@@@ -1610,7 +1610,7 @@@@ if ((CFSTARTTIME = time((time_t *)NULL))
 if (GetMacroValue(CONTEXTID,"cfrunCommand") == NULL)
    {
    Verbose("cfservd exec request: no cfrunCommand defined\n");
-   sprintf(sendbuffer,"Exec request: no cfrunCommand defined\n");
+   (void)snprintf(sendbuffer,CF_BUFSIZE,"Exec request: no cfrunCommand defined\n");
    SendTransaction(conn->sd_reply,sendbuffer,0,CF_DONE);
    return;
    }
@@@@ -1651,8 +1651,8 @@@@ else
    {
    if ((args != NULL) & (strlen(args) > 0))
       {
-      strcat(ebuff," ");
-      strcat(ebuff,args);
+      (void)strlcat(ebuff," ",sizeof(ebuff));
+      (void)strlcat(ebuff,args,sizeof(ebuff));
 
       snprintf(sendbuffer,CF_BUFSIZE,"cfservd Executing %s\n",ebuff);
       SendTransaction(conn->sd_reply,sendbuffer,0,CF_DONE);
@@@@ -2568,7 +2568,7 @@@@ if (S_ISLNK(statbuf.st_mode))
        
    if (readlink(filename,linkbuf,CF_BUFSIZE-1) == -1)
       {
-      sprintf(sendbuffer,"BAD: unable to read link\n");
+      (void)snprintf(sendbuffer,CF_BUFSIZE,"BAD: unable to read link\n");
       CfLog(cferror,sendbuffer,"readlink");
       SendTransaction(conn->sd_reply,sendbuffer,0,CF_DONE);
       return -1;
@@@@ -2671,12 +2671,12 @@@@ SendTransaction(conn->sd_reply,sendbuffe
 
 if (cfst.cf_readlink != NULL)
    {
-   strcpy(sendbuffer,"OK:");
-   strcat(sendbuffer,cfst.cf_readlink);
+   (void)strlcpy(sendbuffer,"OK:",CF_BUFSIZE);
+   (void)strlcat(sendbuffer,cfst.cf_readlink,CF_BUFSIZE);
    }
 else
    {
-   sprintf(sendbuffer,"OK:");
+   (void)snprintf(sendbuffer,CF_BUFSIZE,"OK:");
    }
 
 SendTransaction(conn->sd_reply,sendbuffer,0,CF_DONE);
@@@@ -2878,13 +2878,13 @@@@ memset(sendbuffer,0,CF_BUFSIZE);
 
 if (ChecksumChanged(filename,digest,cfverbose,true,'m'))
    {
-   sprintf(sendbuffer,"%s",CFD_TRUE);
+   (void)snprintf(sendbuffer,CF_BUFSIZE,"%s",CFD_TRUE);
    Debug("Checksums didn't match\n");
    SendTransaction(conn->sd_reply,sendbuffer,0,CF_DONE);
    }
 else
    {
-   sprintf(sendbuffer,"%s",CFD_FALSE);
+   (void)snprintf(sendbuffer,CF_BUFSIZE,"%s",CFD_FALSE);
    Debug("Checksums matched ok\n");
    SendTransaction(conn->sd_reply,sendbuffer,0,CF_DONE);
    }
@@@@ -2902,7 +2902,7 @@@@ Debug("CfOpenDirectory(%s)\n",dirname);
   
 if (*dirname != '/')
    {
-   sprintf(sendbuffer,"BAD: request to access a non-absolute filename\n");
+   (void)snprintf(sendbuffer,CF_BUFSIZE,"BAD: request to access a non-absolute filename\n");
    SendTransaction(conn->sd_reply,sendbuffer,0,CF_DONE);
    return -1;
    }
@@@@ -2934,7 +2934,7 @@@@ for (dirp = readdir(dirh); dirp != NULL;
    offset += strlen(dirp->d_name) + 1;     /* + zero byte separator */
    }
  
-strcpy(sendbuffer+offset,CFD_TERMINATOR);
+(void)strlcpy(sendbuffer+offset,CFD_TERMINATOR,CF_BUFSIZE - offset);
 SendTransaction(conn->sd_reply,sendbuffer,offset+2+strlen(CFD_TERMINATOR),CF_DONE);
 Debug("END CfOpenDirectory(%s)\n",dirname);
 closedir(dirh);
@@@@ -2949,7 +2949,7 @@@@ void Terminate(int sd)
 
 memset(buffer,0,CF_BUFSIZE);
 
-strcpy(buffer,CFD_TERMINATOR);
+(void)strlcpy(buffer,CFD_TERMINATOR,sizeof(buffer));
 
 if (SendTransaction(sd,buffer,strlen(buffer)+1,CF_DONE) == -1)
    {
@@@@ -3168,7 +3168,7 @@@@ Debug("Checking to see if we have seen t
   
 if ((errno = db_create(&dbp,NULL,0)) != 0)
    {
-   sprintf(OUTPUT,"Couldn't open average database %s\n",keydb);
+   (void)snprintf(OUTPUT,sizeof(OUTPUT),"Couldn't open average database %s\n",keydb);
    CfLog(cferror,OUTPUT,"db_open");
    return false;
    }
@@@@ -3179,7 +3179,7 @@@@ if ((errno = dbp->open(dbp,keydb,NULL,DB
 if ((errno = dbp->open(dbp,NULL,keydb,NULL,DB_BTREE,DB_CREATE,0644)) != 0)    
 #endif
    {
-   sprintf(OUTPUT,"Couldn't open average database %s\n",keydb);
+   (void)snprintf(OUTPUT,sizeof(OUTPUT),"Couldn't open average database %s\n",keydb);
    CfLog(cferror,OUTPUT,"db_open");
    return false;
    }
@@@@ -3252,7 +3252,7 @@@@ if ((DHCPLIST != NULL) && IsFuzzyItemIn(
    
    if ((errno = db_create(&dbp,NULL,0)) != 0)
       {
-      sprintf(OUTPUT,"Couldn't open average database %s\n",keydb);
+      (void)snprintf(OUTPUT,sizeof(OUTPUT),"Couldn't open average database %s\n",keydb);
       CfLog(cferror,OUTPUT,"db_open");
       return;
       }
@@@@ -3263,7 +3263,7 @@@@ if ((DHCPLIST != NULL) && IsFuzzyItemIn(
    if ((errno = dbp->open(dbp,NULL,keydb,NULL,DB_BTREE,DB_CREATE,0644)) != 0)
 #endif
       {
-      sprintf(OUTPUT,"Couldn't open average database %s\n",keydb);
+      (void)snprintf(OUTPUT,sizeof(OUTPUT),"Couldn't open average database %s\n",keydb);
       CfLog(cferror,OUTPUT,"db_open");
       return;
       }
@


1.4
log
@update to 2.1.16, removing sbin/vicf which seems to have a security
problem but is not used anywhere and will probably be removed from
cfengine

from maintainer William Yodlowsky <bsd at openbsd.rutgers.edu>
@
text
@d1 1
a1 1
$OpenBSD: patch-src_cfservd_c,v 1.3 2005/07/21 15:16:46 aanriot Exp $
@


1.3
log
@update to 2.1.15, from William Yodlowsky (maintainer).

inputs and ok naddy@@
@
text
@d1 3
a3 3
$OpenBSD: patch-src_cfservd_c,v 1.2 2004/10/01 21:22:15 sturm Exp $
--- src/cfservd.c.orig	Wed May 25 09:58:03 2005
+++ src/cfservd.c	Fri Jul 15 12:24:01 2005
d46 1
a46 1
@@@@ -1047,7 +1047,7 @@@@ if (CFDSTARTTIME < newstat.st_mtime)
d55 1
a55 1
@@@@ -1427,7 +1427,7 @@@@ switch (GetCommand(recvbuffer))
d64 1
a64 1
@@@@ -1492,7 +1492,7 @@@@ switch (GetCommand(recvbuffer))
d73 1
a73 1
@@@@ -1600,7 +1600,7 @@@@ if ((CFSTARTTIME = time((time_t *)NULL))
d82 1
a82 1
@@@@ -1641,8 +1641,8 @@@@ else
d93 1
a93 1
@@@@ -2551,7 +2551,7 @@@@ if (S_ISLNK(statbuf.st_mode))
d102 1
a102 1
@@@@ -2654,12 +2654,12 @@@@ SendTransaction(conn->sd_reply,sendbuffe
d118 1
a118 1
@@@@ -2861,13 +2861,13 @@@@ memset(sendbuffer,0,CF_BUFSIZE);
d134 1
a134 1
@@@@ -2885,7 +2885,7 @@@@ Debug("CfOpenDirectory(%s)\n",dirname);
d143 1
a143 1
@@@@ -2917,7 +2917,7 @@@@ for (dirp = readdir(dirh); dirp != NULL;
d152 1
a152 1
@@@@ -2932,7 +2932,7 @@@@ void Terminate(int sd)
d161 1
a161 1
@@@@ -3151,7 +3151,7 @@@@ Debug("Checking to see if we have seen t
d170 1
a170 1
@@@@ -3162,7 +3162,7 @@@@ if ((errno = dbp->open(dbp,keydb,NULL,DB
d179 1
a179 1
@@@@ -3235,7 +3235,7 @@@@ if ((DHCPLIST != NULL) && IsFuzzyItemIn(
d188 1
a188 1
@@@@ -3246,7 +3246,7 @@@@ if ((DHCPLIST != NULL) && IsFuzzyItemIn(
@


1.2
log
@unbreak and update to 2.1.10

from maintainer William Yodlowsky <bsd at openbsd.rutgers.edu>
@
text
@d1 4
a4 4
$OpenBSD$
--- src/cfservd.c.orig	Fri Aug 13 11:08:25 2004
+++ src/cfservd.c	Fri Oct  1 23:14:47 2004
@@@@ -172,10 +172,10 @@@@ void CheckOptsAndInit(int argc,char **ar
d18 20
a37 1
@@@@ -277,7 +277,7 @@@@ strncpy(VLOCKDIR,WORKDIR,CF_BUFSIZE-1);
d46 2
a47 2
@@@@ -1024,7 +1024,7 @@@@ if (CFDSTARTTIME < newstat.st_mtime)
    DeleteItemList(TRUSTKEYLIST);
d55 1
a55 1
@@@@ -1401,7 +1401,7 @@@@ switch (GetCommand(recvbuffer))
d64 1
a64 1
@@@@ -1466,7 +1466,7 @@@@ switch (GetCommand(recvbuffer))
d73 1
a73 1
@@@@ -1574,7 +1574,7 @@@@ if ((CFSTARTTIME = time((time_t *)NULL))
d82 1
a82 1
@@@@ -1615,8 +1615,8 @@@@ else
d93 1
a93 1
@@@@ -2483,7 +2483,7 @@@@ if (S_ISLNK(statbuf.st_mode))
d102 1
a102 1
@@@@ -2586,12 +2586,12 @@@@ SendTransaction(conn->sd_reply,sendbuffe
d118 1
a118 1
@@@@ -2793,13 +2793,13 @@@@ memset(sendbuffer,0,CF_BUFSIZE);
d134 1
a134 1
@@@@ -2817,7 +2817,7 @@@@ Debug("CfOpenDirectory(%s)\n",dirname);
d143 1
a143 1
@@@@ -2849,7 +2849,7 @@@@ for (dirp = readdir(dirh); dirp != NULL;
d152 1
a152 1
@@@@ -2864,7 +2864,7 @@@@ void Terminate(int sd)
d161 1
a161 1
@@@@ -3083,7 +3083,7 @@@@ Debug("Checking to see if we have seen t
d170 1
a170 1
@@@@ -3094,7 +3094,7 @@@@ if ((errno = dbp->open(dbp,keydb,NULL,DB
d179 1
a179 1
@@@@ -3167,7 +3167,7 @@@@ if ((DHCPLIST != NULL) && IsFuzzyItemIn(
d188 1
a188 1
@@@@ -3178,7 +3178,7 @@@@ if ((DHCPLIST != NULL) && IsFuzzyItemIn(
@


1.1
log
@revive cfengine port

this is version 2.1.6, from and maintained by
William Yodlowsky <bsd at openbsd.rutgers.edu>
@
text
@d2 3
a4 3
--- src/cfservd.c.orig	2004-04-17 10:11:16.000000000 -0400
+++ src/cfservd.c	2004-06-12 23:42:42.000000000 -0400
@@@@ -164,10 +164,10 @@@@ void CheckOptsAndInit(int argc,char **ar
d18 1
a18 1
@@@@ -269,7 +269,7 @@@@ strncpy(VLOCKDIR,WORKDIR,CF_BUFSIZE-1);
d27 1
a27 1
@@@@ -981,7 +981,7 @@@@ if (CFDSTARTTIME < newstat.st_mtime)
d36 1
a36 1
@@@@ -1355,7 +1355,7 @@@@ switch (GetCommand(recvbuffer))
d45 1
a45 1
@@@@ -1420,7 +1420,7 @@@@ switch (GetCommand(recvbuffer))
d54 1
a54 1
@@@@ -1528,7 +1528,7 @@@@ if ((CFSTARTTIME = time((time_t *)NULL))
d63 1
a63 1
@@@@ -1569,8 +1569,8 @@@@ else
d74 1
a74 1
@@@@ -2377,7 +2377,7 @@@@ if (S_ISLNK(statbuf.st_mode))
d83 1
a83 1
@@@@ -2480,12 +2480,12 @@@@ SendTransaction(conn->sd_reply,sendbuffe
d99 1
a99 1
@@@@ -2687,13 +2687,13 @@@@ memset(sendbuffer,0,CF_BUFSIZE);
d115 1
a115 1
@@@@ -2711,7 +2711,7 @@@@ Debug("CfOpenDirectory(%s)\n",dirname);
d124 1
a124 1
@@@@ -2743,7 +2743,7 @@@@ for (dirp = readdir(dirh); dirp != NULL;
d133 1
a133 1
@@@@ -2758,7 +2758,7 @@@@ void Terminate(int sd)
d142 1
a142 1
@@@@ -2977,7 +2977,7 @@@@ Debug("Checking to see if we have seen t
d151 1
a151 1
@@@@ -2988,7 +2988,7 @@@@ if ((errno = dbp->open(dbp,keydb,NULL,DB
d160 1
a160 1
@@@@ -3061,7 +3061,7 @@@@ if ((DHCPLIST != NULL) && IsFuzzyItemIn(
d169 1
a169 1
@@@@ -3072,7 +3072,7 @@@@ if ((DHCPLIST != NULL) && IsFuzzyItemIn(
@

