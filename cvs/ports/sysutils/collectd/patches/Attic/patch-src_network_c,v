head	1.1;
access;
symbols
	OPENBSD_6_1:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2017.06.12.17.20.45;	author danj;	state dead;
branches
	1.1.2.1;
next	;
commitid	oasVFJ76aWantPF4;

1.1.2.1
date	2017.06.12.17.20.45;	author danj;	state Exp;
branches;
next	;
commitid	oasVFJ76aWantPF4;


desc
@@


1.1
log
@file patch-src_network_c was initially added on branch OPENBSD_6_1.
@
text
@@


1.1.2.1
log
@Backport patch for CVE-2017-7401
@
text
@a0 40
$OpenBSD$

Backport f6be4f9b49b949b379326c3d7002476e6ce4f211, fixes CVE-2017-7401

--- src/network.c.orig	Wed Nov 30 03:52:01 2016
+++ src/network.c	Sat Jun 10 19:37:21 2017
@@@@ -1003,14 +1003,6 @@@@ static int parse_part_sign_sha256(sockent_t *se, /* {{
   buffer_len = *ret_buffer_len;
   buffer_offset = 0;
 
-  if (se->data.server.userdb == NULL) {
-    c_complain(
-        LOG_NOTICE, &complain_no_users,
-        "network plugin: Received signed network packet but can't verify it "
-        "because no user DB has been configured. Will accept it.");
-    return (0);
-  }
-
   /* Check if the buffer has enough data for this structure. */
   if (buffer_len <= PART_SIGNATURE_SHA256_SIZE)
     return (-ENOMEM);
@@@@ -1025,6 +1017,18 @@@@ static int parse_part_sign_sha256(sockent_t *se, /* {{
       (pss_head_length > buffer_len)) {
     ERROR("network plugin: HMAC-SHA-256 with invalid length received.");
     return (-1);
+  }
+
+  if (se->data.server.userdb == NULL) {
+    c_complain(
+        LOG_NOTICE, &complain_no_users,
+        "network plugin: Received signed network packet but can't verify it "
+        "because no user DB has been configured. Will accept it.");
+
+    *ret_buffer = buffer + pss_head_length;
+    *ret_buffer_len -= pss_head_length;
+
+    return (0);
   }
 
   /* Copy the hash. */
@

