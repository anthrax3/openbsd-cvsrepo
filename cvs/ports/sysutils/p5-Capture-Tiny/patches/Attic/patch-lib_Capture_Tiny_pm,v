head	1.1;
access;
symbols
	OPENBSD_5_4:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2014.02.07.14.40.45;	author jasper;	state dead;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2014.02.07.14.40.45;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.1
log
@file patch-lib_Capture_Tiny_pm was initially added on branch OPENBSD_5_4.
@
text
@@


1.1.2.1
log
@Security fix for CVE-2014-1875, insecure use of /tmp
@
text
@a0 30
$OpenBSD$

Security fix for CVE-2014-1875, insecure use of /tmp

--- lib/Capture/Tiny.pm.orig	Fri May 20 05:34:28 2011
+++ lib/Capture/Tiny.pm	Thu Feb  6 12:21:14 2014
@@@@ -47,11 +47,18 @@@@ our $TIMEOUT = 30;
 # This is annoying, but seems to be the best that can be done
 # as a simple, portable IPC technique
 #--------------------------------------------------------------------------#
-my @@cmd = ($^X, '-e', '$SIG{HUP}=sub{exit}; '
-  . 'if( my $fn=shift ){ open my $fh, qq{>$fn}; print {$fh} $$; close $fh;} '
-  . 'my $buf; while (sysread(STDIN, $buf, 2048)) { '
-  . 'syswrite(STDOUT, $buf); syswrite(STDERR, $buf)}'
-);
+my @@cmd = ($^X, '-C0', '-e', <<'HERE');
+use Fcntl;
+$SIG{HUP}=sub{exit};
+if ( my $fn=shift ) {
+    sysopen(my $fh, qq{$fn}, O_WRONLY|O_CREAT|O_EXCL) or die $!;
+    print {$fh} $$;
+    close $fh;
+}
+my $buf; while (sysread(STDIN, $buf, 2048)) {
+    syswrite(STDOUT, $buf); syswrite(STDERR, $buf);
+}
+HERE
 
 #--------------------------------------------------------------------------#
 # filehandle manipulation
@

