head	1.3;
access;
symbols
	OPENBSD_6_0:1.2.0.2
	OPENBSD_6_0_BASE:1.2;
locks; strict;
comment	@# @;


1.3
date	2016.08.10.14.09.39;	author jasper;	state dead;
branches;
next	1.2;
commitid	tryzhWYDllSWeD1v;

1.2
date	2016.04.29.09.33.10;	author jasper;	state Exp;
branches;
next	1.1;
commitid	f13Jnxf93vZpliWI;

1.1
date	2016.04.28.13.32.22;	author jasper;	state Exp;
branches;
next	;
commitid	zjeAfUP81HePiKYy;


desc
@@


1.3
log
@update to tmux-mem-cpu-load-3.4.0
@
text
@$OpenBSD: patch-openbsd_memory_cc,v 1.2 2016/04/29 09:33:10 jasper Exp $

Simplify memory calculations by using uvmexp.pageshift

--- openbsd/memory.cc.orig	Mon Mar  7 02:33:34 2016
+++ openbsd/memory.cc	Fri Apr 29 11:31:48 2016
@@@@ -39,13 +39,6 @@@@
 #include "memory.h"
 #include "conversions.h"
 
-static int pageshift;
-
-#ifndef LOG1024
-#define LOG1024	10
-#endif
-#define pagesh(size) ((size) << pageshift)
-
 void mem_status( MemoryStatus & status )
 {
   // These values are in bytes
@@@@ -63,16 +56,6 @@@@ void mem_status( MemoryStatus & status )
     error( "memory: error getting page size" );
   }
 
-  // calculate how far we must shift the variables
-  pageshift = 0;
-  while( page_size > 1 )
-  {
-    pageshift++;
-    page_size >>= 1;
-  }
-
-  pageshift -= LOG1024;
-
   // get vm memory stats
   static int uvmexp_mib[] = { CTL_VM, VM_UVMEXP };
   struct uvmexp uvmexp;
@@@@ -92,16 +75,15 @@@@ void mem_status( MemoryStatus & status )
   }
 
   // calculations based on libgtop
-  used_mem = (uint64_t) pagesh (uvmexp.npages - uvmexp.free) << LOG1024;
+  used_mem = ( (uint64_t) uvmexp.npages - uvmexp.free ) << uvmexp.pageshift;
+  free_mem = ( (uint64_t) uvmexp.free ) << uvmexp.pageshift;
 
-  free_mem = (uint64_t) pagesh( uvmexp.free ) << LOG1024;
-
   // from nagios-memory plugin
-  used_mem -= pagesh( bcstats.numbufpages );
-  free_mem += pagesh( bcstats.numbufpages );
+  used_mem -= ( (uint64_t) bcstats.numbufpages ) << uvmexp.pageshift;
+  free_mem += ( (uint64_t) bcstats.numbufpages ) << uvmexp.pageshift;
 
   // calculate total memory
-  total_mem = (uint64_t) pagesh( uvmexp.npages ) << LOG1024;
+  total_mem = ( (uint64_t) uvmexp.npages ) << uvmexp.pageshift;
 
   status.used_mem = convert_unit(static_cast< float >( used_mem ), MEGABYTES );
   status.total_mem = convert_unit(static_cast< float >( total_mem ), MEGABYTES );
@


1.2
log
@update to tmux-mem-cpu-load-3.3.0
@
text
@d1 1
a1 1
$OpenBSD: patch-openbsd_memory_cc,v 1.1 2016/04/28 13:32:22 jasper Exp $
@


1.1
log
@Simplify memory calculations by using uvmexp.pageshift
@
text
@d1 1
a1 1
$OpenBSD$
d5 4
a8 4
--- openbsd/memory.cc.orig	Thu Apr 28 15:07:56 2016
+++ openbsd/memory.cc	Thu Apr 28 15:25:30 2016
@@@@ -40,13 +40,6 @@@@
 #include "luts.h"
d18 1
a18 1
 std::string mem_string( bool use_colors = false )
d20 2
a21 2
   std::ostringstream oss;
@@@@ -66,16 +59,6 @@@@ std::string mem_string( bool use_colors = false )
d38 1
a38 1
@@@@ -95,16 +78,15 @@@@ std::string mem_string( bool use_colors = false )
d43 2
a44 2
+  used_mem = ((uint64_t) uvmexp.npages - uvmexp.free) << uvmexp.pageshift;
+  free_mem = ((uint64_t) uvmexp.free) << uvmexp.pageshift;
d51 2
a52 2
+  used_mem -= ((uint64_t) bcstats.numbufpages) << uvmexp.pageshift;
+  free_mem += ((uint64_t) bcstats.numbufpages) << uvmexp.pageshift;
d56 1
a56 1
+  total_mem = ((uint64_t) uvmexp.npages) << uvmexp.pageshift;
d58 2
a59 2
   if( use_colors )
   {
@

