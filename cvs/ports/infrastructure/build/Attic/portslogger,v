head	1.16;
access;
symbols
	OPENBSD_4_8:1.15.0.4
	OPENBSD_4_8_BASE:1.15
	OPENBSD_4_7:1.15.0.2
	OPENBSD_4_7_BASE:1.15
	OPENBSD_4_6:1.14.0.8
	OPENBSD_4_6_BASE:1.14
	OPENBSD_4_5:1.14.0.6
	OPENBSD_4_5_BASE:1.14
	OPENBSD_4_4:1.14.0.4
	OPENBSD_4_4_BASE:1.14
	OPENBSD_4_3:1.14.0.2
	OPENBSD_4_3_BASE:1.14
	OPENBSD_4_2:1.13.0.12
	OPENBSD_4_2_BASE:1.13
	OPENBSD_4_1:1.13.0.10
	OPENBSD_4_1_BASE:1.13
	OPENBSD_4_0:1.13.0.8
	OPENBSD_4_0_BASE:1.13
	OPENBSD_3_9:1.13.0.6
	OPENBSD_3_9_BASE:1.13
	OPENBSD_3_8:1.13.0.4
	OPENBSD_3_8_BASE:1.13
	OPENBSD_3_7:1.13.0.2
	OPENBSD_3_7_BASE:1.13
	OPENBSD_3_6:1.11.0.2
	OPENBSD_3_6_BASE:1.11
	OPENBSD_3_5:1.10.0.8
	OPENBSD_3_5_BASE:1.10
	OPENBSD_3_4:1.10.0.6
	OPENBSD_3_4_BASE:1.10
	OPENBSD_3_3:1.10.0.4
	OPENBSD_3_3_BASE:1.10
	OPENBSD_3_2:1.10.0.2
	OPENBSD_3_2_BASE:1.10
	OPENBSD_3_1:1.8.0.2
	OPENBSD_3_1_BASE:1.8
	OPENBSD_3_0:1.6.0.2
	OPENBSD_3_0_BASE:1.6
	OPENBSD_2_9_TRACKING_SWITCH:1.5
	OPENBSD_2_9:1.1.0.2
	OPENBSD_2_9_BASE:1.1;
locks; strict;
comment	@# @;


1.16
date	2010.08.30.19.02.33;	author steven;	state dead;
branches;
next	1.15;

1.15
date	2009.11.08.09.24.11;	author espie;	state Exp;
branches;
next	1.14;

1.14
date	2007.08.25.07.56.04;	author espie;	state Exp;
branches;
next	1.13;

1.13
date	2005.01.08.00.05.16;	author espie;	state Exp;
branches;
next	1.12;

1.12
date	2004.11.10.10.15.42;	author espie;	state Exp;
branches;
next	1.11;

1.11
date	2004.08.06.11.31.22;	author espie;	state Exp;
branches;
next	1.10;

1.10
date	2002.05.18.18.37.47;	author espie;	state Exp;
branches;
next	1.9;

1.9
date	2002.04.24.21.35.33;	author espie;	state Exp;
branches;
next	1.8;

1.8
date	2001.11.11.12.57.25;	author espie;	state Exp;
branches;
next	1.7;

1.7
date	2001.11.11.12.38.57;	author espie;	state Exp;
branches;
next	1.6;

1.6
date	2001.10.05.07.26.50;	author espie;	state Exp;
branches;
next	1.5;

1.5
date	2001.07.26.14.53.53;	author espie;	state Exp;
branches;
next	1.4;

1.4
date	2001.07.19.12.29.09;	author espie;	state Exp;
branches;
next	1.3;

1.3
date	2001.06.07.14.46.23;	author espie;	state Exp;
branches;
next	1.2;

1.2
date	2001.05.05.21.23.56;	author espie;	state Exp;
branches;
next	1.1;

1.1
date	2001.03.13.22.00.15;	author espie;	state Exp;
branches;
next	;


desc
@@


1.16
log
@move portslogger to bin/
ok naddy@@

if you have build scripts that use portslogger, adapt the path
@
text
@#!/usr/bin/perl

# $OpenBSD: portslogger,v 1.15 2009/11/08 09:24:11 espie Exp $
# Copyright (c) 2001 Marc Espie.  All rights reserved.
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Neither the name of OpenBSD nor the names of its contributors
#    may be used to endorse or promote products derived from this software
#    without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY ITS AUTHOR AND THE OpenBSD project ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.

# This critter recognizes context switch changes in the ports tree
# and logs its output accordingly, as a kind of `super-tee'

{
package Logger;
@@ISA=qw(IO::File);

use File::Path;
use IO::File;
use File::Temp qw/tempfile/;

our $directory;
our %temps;


sub setdir
{
	$directory = shift;
	mkpath $directory;
	die "No logging directory" unless -d $directory;
}

sub new
{
	my $class = shift;
	my $name = shift;
	$name = "$directory/$name.log";
	my $self = IO::File::new($class, $name, '>>');
	if (!$self) {
		if (defined $temps{$name}) {
			$self = IO::File::new($class, $temps{$name}, '>>');
		} else {
		    ($self, $temps{$name}) = tempfile(SUFFIX => '.log') or
			    die "Can't create any logfile";
		    print STDERR "*** Couldn't open $name, \n";
		    print STDERR "*** using ".$temps{$name}." instead\n";
		    bless $self, $class;
		}
	}
	$self->print("+++ ", `date`);
	$self->autoflush(1);
	return $self;
}

sub close
{
	my $self = shift;
	print $self "--- ", `date`;
	$self->SUPER::close();
}

sub DESTROY
{
	my $self = shift;
	$self->close();
}
}

use Getopt::Std;

our $opt_s;

getopts('s');

if (@@ARGV < 1) {
    print STDERR "Usage: $0 directory\n";
    exit 1;
}

Logger::setdir(shift);

my $logfile = undef;
my $ncontext = undef;

my $context;

while (<>) {
	print unless $opt_s;
	s/\cM+$//;
	# zap fetch & pkg_add progress bar
	s/^.*\cM//;
	if (m/^\=\=\=\>\s+
	    (?:
		(?: Extracting|
		    Applying\ distribution\ patches|
		    Patching|
		    Configuring|
		    Building|
		    Faking\ installation|
		    Building\ package|
		    Deinstalling|
		    Cleaning|
		    Dist\ cleaning|
		    Checking\ files|
		    Regression\ check|
		    Updating\ plist|
		    Updating|
		    Registering\ installation)\s+for\s+(.*)|
		Returning\ to\ build\ of\s+(.*)|
		Installing\s+(.*?)\s+from)
	    /ox) {
		$ncontext = "$1$2$3"; 	# XXX only one alternative matches
		chomp $ncontext;
		# register to `master' context.
		$ncontext=$1 if $ncontext =~ m/^.*\[(.*?)\]$/;
		if ($ncontext ne $context) {
			$context = $ncontext;
			$logfile = new Logger $context;
		}
	} elsif (m/^\=\=\=\> Exiting\s+(.*)\s+with an error$/) {
		undef $context;
	}
	unless (defined $context) {
		$context = default;
		$logfile = new Logger 'default';
	}
	$logfile->print($_);
}

@


1.15
log
@a few tweaks I should have committed long ago.
- better at handling progress meter incomplete lines and sanitizing them
before output
- less greedy about maintaining a context, let post-error messages stuff
end up in the default.log, instead of seeing huge swaths of entering directory
after errors.
- -s silent option, for use when we see the output but don't need to duplicate
it.

After work with NicM, portslogger is useable with tmux. From within tmux,
just run something like:
tmux pipe-pane 'perl /usr/ports/infrastructure/build/portslogger -s /usr/ports/log'

to log all ports building activity...
@
text
@d3 1
a3 1
# $OpenBSD: portslogger,v 1.14 2007/08/25 07:56:04 espie Exp $
@


1.14
log
@add message that shows we exited a directory after an error, stops log there
during rebuilds.
@
text
@d3 1
a3 1
# $OpenBSD: portslogger,v 1.13 2005/01/08 00:05:16 espie Exp $
d84 6
d103 4
d136 1
a136 4
		$ncontext = $1;
		if ($ncontext eq $context) {
			undef $context;
		}
a141 2
	# zap fetch progress bar
	next if m/^\cM\s*\d+\%/;
a142 1
	print;
@


1.13
log
@fix a stupid bug where some expr don't match, use extended expressions
to simplify things.
@
text
@d3 1
a3 1
# $OpenBSD: portslogger,v 1.12 2004/11/10 10:15:42 espie Exp $
d124 5
@


1.12
log
@allows for updates
@
text
@d3 1
a3 1
# $OpenBSD: portslogger,v 1.11 2004/08/06 11:31:22 espie Exp $
d97 20
a116 6
	if (m/^\=\=\=\>\s+(?:(?:Extracting|Applying distribution patches|\
Patching|Configuring|Building|Faking installation|Building package|\
Deinstalling|Cleaning|Dist cleaning|Checking files|\
Regression check|Updating plist|Updating|\
Registering installation)\s+for\s+(.*)|\
Returning to build of\s+(.*)|Installing\s+(.*?)\s+from)/o) {
@


1.11
log
@tag updating-plist case for logging.
@
text
@d3 1
a3 1
# $OpenBSD: portslogger,v 1.10 2002/05/18 18:37:47 espie Exp $
d100 1
a100 1
Regression check|Updating plist\
@


1.10
log
@zap fetch progress bar.
@
text
@d3 1
a3 1
# $OpenBSD: portslogger,v 1.9 2002/04/24 21:35:33 espie Exp $
d100 1
a100 1
Regression check|\
@


1.9
log
@teach portslogger to put patch/configure/build depends with the correct
package.
@
text
@d3 1
a3 1
# $OpenBSD: portslogger,v 1.8 2001/11/11 12:57:25 espie Exp $
d116 2
@


1.8
log
@Groan. Even after I refreshed my memory with perlvar(1), I still managed
to typo my way through.
@
text
@d3 1
a3 1
# $OpenBSD: portslogger,v 1.7 2001/11/11 12:38:57 espie Exp $
d105 2
@


1.7
log
@close PR2115
@
text
@d3 1
a3 1
# $OpenBSD: portslogger,v 1.6 2001/10/05 07:26:50 espie Exp $
d84 1
a84 1
if (@@ARG < 1) {
@


1.6
log
@synch with new regress target (I forgot to commit this)
@
text
@d3 1
a3 1
# $OpenBSD: portslogger,v 1.5 2001/07/26 14:53:53 espie Exp $
d82 5
@


1.5
log
@numbering of matches means we got to default log too often.
@
text
@d3 1
a3 1
# $OpenBSD: portslogger,v 1.4 2001/07/19 12:29:09 espie Exp $
d95 1
@


1.4
log
@Fix a few issues with portslogger, pointed out by Heikki Korpela.

I went a bit overboard with this one and implemented a Logger class
as a derived class on IO::File...
@
text
@d3 1
a3 1
# $OpenBSD: portslogger,v 1.3 2001/06/07 14:46:23 espie Exp $
d97 1
a97 1
		$ncontext = $1;
@


1.3
log
@Add old-install.mk names.
Noticed by naddy@@
@
text
@d3 1
a3 1
# $OpenBSD: portslogger,v 1.2 2001/05/05 21:23:56 espie Exp $
d29 4
d34 2
d37 2
a38 1
$directory = shift;
a39 1
mkpath $directory;
d41 6
a46 1
$logfile='';
d48 20
a67 8
sub changelogfile {
	my $n = shift;
	print LOGFILE "--- ", `date` if $logfile ne '';
	close LOGFILE;
	open LOGFILE, '>>', "$directory/$n.log";
	print LOGFILE "+++ ", `date`;
	$oldfh = select(LOGFILE); $|=1; select($oldfh);
	$logfile = $n;
d70 21
d94 8
a101 7
Desinstalling|Cleaning|Dist cleaning|Checking files|\
Installing|Registering installation)\s+for|\
Returning to build of|Installing)\s+/o) {
		$context = $';
		chomp $context;
		if ($context ne $logfile) {
			changelogfile($context);
d104 3
a106 2
	if ($logfile eq '') {
		changelogfile('default');
d108 1
a108 1
	print LOGFILE $_;
a111 3

print LOGFILE "--- ", `date` if $logfile ne '';
close LOGFILE;
@


1.2
log
@Add Installing...
@
text
@d3 1
a3 1
# $OpenBSD: portslogger,v 1.1 2001/03/13 22:00:15 espie Exp $
d50 2
a51 1
Desinstalling|Cleaning|Dist cleaning|Checking files)\s+for|\
@


1.1
log
@logger -> portslogger
to avoid conflict with logger(1)
@
text
@d3 1
a3 1
# $OpenBSD: logger,v 1.1 2001/03/01 00:00:26 espie Exp $
d51 1
a51 1
Returning to build of)\s+/o) {
@

