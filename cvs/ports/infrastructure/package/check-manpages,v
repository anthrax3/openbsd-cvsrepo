head	1.7;
access;
symbols
	OPENBSD_6_0:1.7.0.26
	OPENBSD_6_0_BASE:1.7
	OPENBSD_5_9:1.7.0.22
	OPENBSD_5_9_BASE:1.7
	OPENBSD_5_8:1.7.0.24
	OPENBSD_5_8_BASE:1.7
	OPENBSD_5_7:1.7.0.20
	OPENBSD_5_7_BASE:1.7
	OPENBSD_5_6:1.7.0.18
	OPENBSD_5_6_BASE:1.7
	OPENBSD_5_5:1.7.0.16
	OPENBSD_5_5_BASE:1.7
	OPENBSD_5_4:1.7.0.14
	OPENBSD_5_4_BASE:1.7
	OPENBSD_5_3:1.7.0.12
	OPENBSD_5_3_BASE:1.7
	OPENBSD_5_2:1.7.0.10
	OPENBSD_5_2_BASE:1.7
	OPENBSD_5_1_BASE:1.7
	OPENBSD_5_1:1.7.0.8
	OPENBSD_5_0:1.7.0.6
	OPENBSD_5_0_BASE:1.7
	OPENBSD_4_9:1.7.0.4
	OPENBSD_4_9_BASE:1.7
	OPENBSD_4_8:1.7.0.2
	OPENBSD_4_8_BASE:1.7
	OPENBSD_4_7:1.5.0.18
	OPENBSD_4_7_BASE:1.5
	OPENBSD_4_6:1.5.0.16
	OPENBSD_4_6_BASE:1.5
	OPENBSD_4_5:1.5.0.14
	OPENBSD_4_5_BASE:1.5
	OPENBSD_4_4:1.5.0.12
	OPENBSD_4_4_BASE:1.5
	OPENBSD_4_3:1.5.0.10
	OPENBSD_4_3_BASE:1.5
	OPENBSD_4_2:1.5.0.8
	OPENBSD_4_2_BASE:1.5
	OPENBSD_4_1:1.5.0.6
	OPENBSD_4_1_BASE:1.5
	OPENBSD_4_0:1.5.0.4
	OPENBSD_4_0_BASE:1.5
	OPENBSD_3_9:1.5.0.2
	OPENBSD_3_9_BASE:1.5
	OPENBSD_3_8:1.4.0.4
	OPENBSD_3_8_BASE:1.4
	OPENBSD_3_7:1.4.0.2
	OPENBSD_3_7_BASE:1.4
	OPENBSD_3_6:1.3.0.4
	OPENBSD_3_6_BASE:1.3
	OPENBSD_3_5:1.3.0.2
	OPENBSD_3_5_BASE:1.3
	OPENBSD_3_4:1.1.0.12
	OPENBSD_3_4_BASE:1.1
	OPENBSD_3_3:1.1.0.10
	OPENBSD_3_3_BASE:1.1
	OPENBSD_3_2:1.1.0.8
	OPENBSD_3_2_BASE:1.1
	OPENBSD_3_1:1.1.0.6
	OPENBSD_3_1_BASE:1.1
	OPENBSD_3_0:1.1.0.4
	OPENBSD_3_0_BASE:1.1
	OPENBSD_2_9_TRACKING_SWITCH:1.1
	OPENBSD_2_9:1.1.0.2
	OPENBSD_2_9_BASE:1.1;
locks; strict;
comment	@# @;


1.7
date	2010.06.30.11.11.19;	author espie;	state Exp;
branches;
next	1.6;

1.6
date	2010.03.20.17.06.16;	author espie;	state Exp;
branches;
next	1.5;

1.5
date	2005.09.13.20.48.41;	author espie;	state Exp;
branches;
next	1.4;

1.4
date	2004.11.13.11.49.48;	author espie;	state Exp;
branches;
next	1.3;

1.3
date	2004.03.04.17.48.29;	author espie;	state Exp;
branches;
next	1.2;

1.2
date	2004.02.10.20.37.45;	author espie;	state Exp;
branches;
next	1.1;

1.1
date	2000.11.12.17.06.26;	author espie;	state Exp;
branches;
next	;


desc
@@


1.7
log
@convert to newer interface. MAKE SURE you have -current pkg_add to run register_plist !
@
text
@#! /usr/bin/perl
# $OpenBSD: check-manpages,v 1.6 2010/03/20 17:06:16 espie Exp $
#
# Copyright (c) 2004 Marc Espie <espie@@openbsd.org>
#
# Permission to use, copy, modify, and distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
#
# check all manpages in existing packages

use OpenBSD::AddCreateDelete;
use OpenBSD::PackageInfo;
use OpenBSD::PackingList;
use OpenBSD::Ustar;
use File::Temp;

my $state = OpenBSD::AddCreateDelete::State->new('check-manpages');
$state->handle_options('[-mnx]');

$state->progress->set_header("Scanning packages");

if (@@ARGV==0) {
	@@ARGV=(<*.tgz>);
}

my $extract_dir = File::Temp::tempdir("manpages.XXXXXXXXXXXX", DIR => '.');
$state->say("Extracting all documentation into #1", $extract_dir);

my %mandirs=();
$state->progress->for_list("Scanning packages", \@@ARGV,
    sub {
    	my $pkgname = shift;
	my $true_package = $state->repo->find($pkgname);
	return unless $true_package;
	my $dir = $true_package->info;
	my $plist = OpenBSD::PackingList->fromfile($dir.CONTENTS);
	for my $item (@@{$plist->{items}}) {
		next unless $item->IsFile;
		my $n = $item->fullname;
		if ($n =~ m,/man/(?:man.*?|cat.*?)/,) {
			my $file;
			do {
				$file = $true_package->next;
			} while ($file->{name} ne $item->{name});
			$file->{name} = $n;
			$n =~ m,^(.*/man)/(?:man.*?|cat.?)/,;
			$mandirs{"$extract_dir$1"} = 1;
			$file->{cwd} = $item->cwd;
			$file->{destdir} = $extract_dir;
			eval { $file->create; };
		}
	}
	$true_package->close;
	$true_package->wipe_info;
	$plist->forget;
    });

$state->errsay("Running makewhatis in #1", join(' ', keys(%mandirs)));
$state->system("/usr/libexec/makewhatis -p ".join(' ', keys(%mandirs)));
@


1.6
log
@older code: use new methods code
@
text
@d2 1
a2 1
# $OpenBSD: check-manpages,v 1.5 2005/09/13 20:48:41 espie Exp $
d20 1
a20 1
use OpenBSD::PackageLocator;
d26 5
a30 2
print "Scanning packages\n";
print "-----------------\n";
d36 1
a36 1
print "Extracting all documentation into $extract_dir\n";
d39 5
a43 4
for my $pkgname (@@ARGV) {
	print STDERR "$pkgname\n";
	my $true_package = OpenBSD::PackageLocator->find($pkgname);
	next unless $true_package;
d65 1
a65 1
}
d67 2
a68 2
print STDERR "Running makewhatis in ", join(' ', keys(%mandirs)), "\n";
system("/usr/libexec/makewhatis -p ".join(' ', keys(%mandirs)));
@


1.5
log
@use new interface to Locator
@
text
@d2 1
a2 1
# $OpenBSD: check-manpages,v 1.4 2004/11/13 11:49:48 espie Exp $
d40 1
a40 1
	my $dir = $true_package->info();
d43 2
a44 2
		next unless $item->IsFile();
		my $n = $item->fullname();
d48 1
a48 1
				$file = $true_package->next();
d53 1
a53 1
			$file->{cwd} = $item->cwd();
d55 1
a55 1
			eval { $file->create(); };
d58 3
a60 3
	$true_package->close();
	$true_package->wipe_info();
	$plist->forget();
@


1.4
log
@synch with changes
@
text
@d2 1
a2 1
# $OpenBSD: check-manpages,v 1.3 2004/03/04 17:48:29 espie Exp $
d59 2
@


1.3
log
@replace with a new script that works faster.
@
text
@d2 1
a2 1
# $OpenBSD$
d53 1
a53 1
			$file->{cwd} = $item->{cwd};
@


1.2
log
@fix path
@
text
@d1 24
a24 1
#!/bin/sh
d26 5
a30 23
# $OpenBSD: check-manpages,v 1.1 2000/11/12 17:06:26 espie Exp $
# Copyright (c) 2000
# Marc Espie.  All rights reserved.
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Neither the name of OpenBSD nor the names of its contributors
#    may be used to endorse or promote products derived from this software
#    without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY ITS AUTHOR AND THE OpenBSD project ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.
d32 2
a33 1
# check all manpages in existing packages
d35 25
a59 3
: ${PORTSDIR=/usr/ports}
: ${ARCH=`uname -m`}
: ${PACKAGES=${PORTSDIR}/packages/${ARCH}/all}
d61 2
a62 7
rm -rf man
for i in ${PACKAGES}/*
do
# avoid  `unmatched' error
	tar zxf $i man/\* 2>/dev/null
done
/usr/libexec/makewhatis -p man
@


1.1
log
@Regression script: extract all man pages from all built packages, and
runs makewhatis on them.

Check the result for bugs in packages and limitations in makewhatis
@
text
@d3 1
a3 1
# $OpenBSD: check-package-dependencies,v 1.1 2000/04/19 14:31:18 espie Exp $
d31 1
a31 1
: ${PACKAGES=${PORTSDIR}/packages/${ARCH}/All}
@

