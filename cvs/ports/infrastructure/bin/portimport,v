head	1.5;
access;
symbols
	OPENBSD_6_1:1.5.0.14
	OPENBSD_6_1_BASE:1.5
	OPENBSD_6_0:1.5.0.12
	OPENBSD_6_0_BASE:1.5
	OPENBSD_5_9:1.5.0.8
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.5.0.10
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.5.0.6
	OPENBSD_5_7_BASE:1.5
	OPENBSD_5_6:1.5.0.4
	OPENBSD_5_6_BASE:1.5
	OPENBSD_5_5:1.5.0.2
	OPENBSD_5_5_BASE:1.5
	OPENBSD_5_4:1.2.0.2
	OPENBSD_5_4_BASE:1.2;
locks; strict;
comment	@# @;


1.5
date	2014.02.09.15.10.49;	author zhuk;	state Exp;
branches;
next	1.4;

1.4
date	2014.02.04.21.18.14;	author zhuk;	state Exp;
branches;
next	1.3;

1.3
date	2013.12.11.16.11.09;	author zhuk;	state Exp;
branches;
next	1.2;

1.2
date	2013.04.11.15.18.00;	author zhuk;	state Exp;
branches;
next	1.1;

1.1
date	2013.04.09.19.51.37;	author rpe;	state Exp;
branches;
next	;


desc
@@


1.5
log
@Unbreak portimport after previous. Clean up getopts call while there.
@
text
@#!/bin/ksh
#
# $OpenBSD: portimport,v 1.4 2014/02/04 21:18:14 zhuk Exp $
# Copyright (c) 2013 Robert Peichaer
# 
# Permission to use, copy, modify, and distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
# 
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
#
# Based on Marc Espie's portimport.
# sthen: Modified to handle imports from mystuff/ and do a dry run first.
# rpe:   rewrite based on sthen@@'s version
# zhuk:  checks and detection of pkgpath moved to portcheck(1)

set -e
set -u

usage() {
	echo "usage: $(basename $0) [-p portsdir] [-u username]" >&2
	exit 1
}

user=$(id -un)
portsdir=
set -A portcheck_args -- -N

while getopts "p:u:" OPT; do
	case $OPT in
	p)	portsdir="$OPTARG"
		portcheck_args[${#portcheck_args[@@]}]="-p$portsdir";;
	u)	user=$OPTARG;;
	*)	usage;;
	esac
done

shift $(($OPTIND - 1))
(($# > 0)) && usage

error=false
pkgpath=$(portcheck "${portcheck_args[@@]}") || error=true
if $error; then
	read ans?'Do you want to continue after those errors? [y/N] '
	[[ $ans == +(y|Y) ]] || exit
fi

portsdir=${portsdir:-${PWD%"/$pkgpath"}}
timestamp=$(date '+%Y%m%d')
cvsroot=$user@@cvs.openbsd.org:/cvs

echo -n "Import would go into: "
cvs -n -d$cvsroot import ports/$pkgpath $user ${user}_$timestamp 2>/dev/null | \
	grep Makefile | head -1 | awk '{print $2}' | xargs dirname

read ans?'Does this look correct? [y/n] '
if [[ $ans == +(y|Y) ]]; then
	cvs -d$cvsroot import ports/$pkgpath $user ${user}_$timestamp
	cd "$portsdir/${pkgpath%/*}"
	cvs -d$cvsroot update -AdP ${pkgpath##*/}
	echo "Don't forget to commit the ${pkgpath%/*}/Makefile when you're done!"
	pwd
fi
@


1.4
log
@Face the reality: portcheck(1) is heavily used now, and not only for new
ports. Given that you import port once but update it a few times, make
the update mode (-CU) default for portcheck, and provide a "new port"
switch (-N) instead.

This commit updates portcheck(1) and portimport(1): code, documentation and
tests. The WWW stuff will be updated separately.

Note: regression suite fails now as it detected an actual misconsistence
in portcheck's output. This will be handled ASAP, too.

Initial prodding by naddy@@
@
text
@d3 1
a3 1
# $OpenBSD: portimport,v 1.3 2013/12/11 16:11:09 zhuk Exp $
d32 1
a32 1
set portsdir=
d35 1
a35 1
while getopts "p:Uu:" OPT; do
@


1.3
log
@Now that we have portcheck(1), start relying on it instead of doing
the checks and pkgpath detection ourself in portimport(1).

Sitting on this diff since september, reminded by kirby@@.

Tested in the wild by importing many ports, mostly KDE4-related.

Input and okay sthen@@

(now committing the right file instead of ports/bin/portcheck)
@
text
@d3 1
a3 1
# $OpenBSD: portimport,v 1.2 2013/04/11 15:18:00 zhuk Exp $
d27 1
a27 1
	echo "usage: $(basename $0) [-U] [-p portsdir] [-u username]" >&2
d32 2
a33 3
portsdir=
portcheck_args=
unset portcheck_args[0]
a38 1
	U)	portcheck_args[${#portcheck_args[@@]}]="-U";;
d48 1
a48 1
pkgpath=$(portcheck "${portcheck_args[@@]:---}") || error=true
@


1.2
log
@Add -u option to portimport(1), allowing to specify your username in CVS.
BUGS section is gone now.
@
text
@d3 1
a3 1
# $OpenBSD: portimport,v 1.1 2013/04/09 19:51:37 rpe Exp $
d21 1
d24 1
d27 1
a27 1
	echo "usage: $(basename $0) [-u username]" >&2
d32 3
d36 1
a36 1
while getopts "u:" OPT; do
d38 4
a41 1
	u)	user="$OPTARG";;
d46 3
a48 1
cvsroot=$user@@cvs.openbsd.org:/cvs
d50 7
a56 2
fulldir=$(pwd)
importname="ports/${fulldir##*/ports/*(mystuff/|openbsd-wip/|p5-ports-wip/)}"
d58 1
a58 13

err() { echo "$*"; error=true; }

[[ -f Makefile && -f distinfo && -f pkg/DESCR  && -f pkg/PLIST ]] || err "No ports files?"
find . -name .git          -print|read i && err "You git!"
find . -name .\*.swp       -print|read i && err "Found vim swap file"
find . -name \*.orig       -print|read i && err "Found .orig file, ouch"
find . -name typescript    -print|read i && err "Found typescript file, ouch"
find . -path ./w-\*        -print|read i && err "Please wipe out work directory before importing"
find . -type d -name core  -print|read i && err "directory named core found, cvs will ignore it"
find . -type f -name .todo -print|read i && err "devtodo file found"
find . -type d -name CVS   -print|read i && err "Some CVS stuff already in there, very funky"
$error && exit 1
d61 1
a61 1
cvs -n -d$cvsroot import $importname $user ${user}_$timestamp 2>/dev/null | \
d64 1
a64 1
read ans?'Correct path? [y/n] '
d66 4
a69 5
	cvs -d$cvsroot import $importname $user ${user}_$timestamp
	cd /usr/$importname/../
	cvs -d$cvsroot update -AdP ${fulldir##*/}
	echo "Don't forget to commit the category Makefile when you're done!"
	cd /usr/$importname/../
@


1.1
log
@add portimport

portimport is used to import the directories and files of a new
port to the OpenBSD ports cvs(1) repository, avoiding common mistakes.
It has to be executed from within the new port's directory.

please read the BUGS section in portimport(1) for details about the
user login used to connect to cvs.openbsd.org !!

addition suggested by and OK sthen@@
no objections from jasper@@ espie@@ aja@@
manpage nits jmc@@
@
text
@d3 1
a3 1
# $OpenBSD$
d24 5
a28 3
# XXX
# XXX CHANGE if you login to cvs.openbsd.org with different user
# XXX
d30 7
@

