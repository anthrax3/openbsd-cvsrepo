head	1.5;
access;
symbols
	OPENBSD_6_0:1.5.0.10
	OPENBSD_6_0_BASE:1.5
	OPENBSD_5_9:1.5.0.6
	OPENBSD_5_9_BASE:1.5
	OPENBSD_5_8:1.5.0.8
	OPENBSD_5_8_BASE:1.5
	OPENBSD_5_7:1.5.0.4
	OPENBSD_5_7_BASE:1.5
	OPENBSD_5_6:1.5.0.2
	OPENBSD_5_6_BASE:1.5
	OPENBSD_5_5:1.4.0.6
	OPENBSD_5_5_BASE:1.4
	OPENBSD_5_4:1.4.0.4
	OPENBSD_5_4_BASE:1.4
	OPENBSD_5_3:1.4.0.2
	OPENBSD_5_3_BASE:1.4
	OPENBSD_4_6:1.1.0.6
	OPENBSD_4_6_BASE:1.1
	OPENBSD_4_5:1.1.0.4
	OPENBSD_4_5_BASE:1.1
	OPENBSD_4_4:1.1.0.2
	OPENBSD_4_4_BASE:1.1;
locks; strict;
comment	@# @;


1.5
date	2014.05.05.11.51.37;	author brad;	state Exp;
branches;
next	1.4;

1.4
date	2013.01.26.12.47.44;	author brad;	state Exp;
branches;
next	1.3;

1.3
date	2013.01.19.08.42.35;	author brad;	state Exp;
branches;
next	1.2;

1.2
date	2009.08.19.06.12.15;	author sthen;	state dead;
branches;
next	1.1;

1.1
date	2008.07.09.02.13.01;	author jakemsr;	state Exp;
branches;
next	;


desc
@@


1.5
log
@- Pull in some bits to deal with newer FFmpeg API. While testing I found
transcode was already broken as is due to it relying on certain functionality
with presets which is no longer relevant for more modern FFmpeg. Searching
via Google showed the same bug being reported with Debian, Gentoo and Arch.
They have eliminted the use of presets but that just exposed another bug.
So this builds with newer FFmpeg but it is essentially just as broken as
before. If anyone wants to take a look at this and figure out why it is
crashing go ahead.
- Merge the quicktime FLAVOR into the main port / package. IMO it doesn't
make sense to have an app like this that cannot work with the MP4 container

FFmpeg bits taken from FreeBSD and Debian packages.

ok ajacoutot@@
@
text
@$OpenBSD: patch-import_decode_lavc_c,v 1.4 2013/01/26 12:47:44 brad Exp $

Update for newer FFmpeg API.

--- import/decode_lavc.c.orig	Sat Nov 19 11:50:27 2011
+++ import/decode_lavc.c	Mon May  5 02:31:48 2014
@@@@ -120,6 +120,7 @@@@ void decode_lavc(decode_t *decode)
   char               *yuv2rgb_buffer = NULL;
   AVCodec            *lavc_dec_codec = NULL;
   AVCodecContext     *lavc_dec_context;
+  AVDictionary       *opts = NULL;
   int                 x_dim = 0, y_dim = 0;
   int                 pix_fmt, frame_size = 0, bpp = 8;
   struct ffmpeg_codec *codec;
@@@@ -128,7 +129,7 @@@@ void decode_lavc(decode_t *decode)
   char *mp4_ptr=NULL;
   int flush = 0;
   int mp4_size=0;
-  int buf_len=0;
+  unsigned int buf_len=0;
   int run=0;
 
   // decoder
@@@@ -170,23 +171,18 @@@@ void decode_lavc(decode_t *decode)
 
   // Set these to the expected values so that ffmpeg's decoder can
   // properly detect interlaced input.
-  lavc_dec_context = avcodec_alloc_context();
+  lavc_dec_context = avcodec_alloc_context3(lavc_dec_codec);
   if (lavc_dec_context == NULL) {
       tc_log_error(__FILE__, "Could not allocate enough memory.");
       goto decoder_error;
   }
   lavc_dec_context->width  = x_dim;
   lavc_dec_context->height = y_dim;
-
-#if LIBAVCODEC_VERSION_INT < ((52<<16)+(0<<8)+0)
-  lavc_dec_context->error_resilience  = 2;
-#else
-  lavc_dec_context->error_recognition = 2;
-#endif
+  av_dict_set(&opts, "err_detect", "compliant", 0);
   lavc_dec_context->error_concealment = 3;
   lavc_dec_context->workaround_bugs = FF_BUG_AUTODETECT;
 
-  if (avcodec_open(lavc_dec_context, lavc_dec_codec) < 0) {
+  if (avcodec_open2(lavc_dec_context, lavc_dec_codec, &opts) < 0) {
       tc_log_error(__FILE__, "Could not initialize the '%s' codec.",
 		   codec->name);
       goto decoder_error;
@


1.4
log
@Add a comment to the patches.

ok sthen@@
@
text
@d1 1
a1 1
$OpenBSD: patch-import_decode_lavc_c,v 1.3 2013/01/19 08:42:35 brad Exp $
d6 1
a6 1
+++ import/decode_lavc.c	Fri Jan 18 22:01:06 2013
d15 18
a32 1
@@@@ -177,16 +178,11 @@@@ void decode_lavc(decode_t *decode)
@


1.3
log
@Update for newer FFmpeg API.

ok ajacoutot@@
@
text
@d1 4
a4 1
$OpenBSD$
@


1.2
log
@Oops, forgot to cvs rm these files. Problem reported by Markus Lude.
@
text
@d1 24
a24 10
$OpenBSD: patch-import_decode_lavc_c,v 1.1 2008/07/09 02:13:01 jakemsr Exp $
--- import/decode_lavc.c.orig	Sat Jun 21 21:17:30 2008
+++ import/decode_lavc.c	Sat Jun 21 21:17:48 2008
@@@@ -31,7 +31,7 @@@@
 #ifdef EMULATE_FAST_INT
 #undef EMULATE_FAST_INT
 #endif
-#include <ffmpeg/avcodec.h>
+#include <libavcodec/avcodec.h>
 #include "yuv2rgb.h"
d26 5
a30 1
 #define READ_BUFFER_SIZE (10*1024*1024)
@


1.1
log
@
* FFmpeg headers moved
* FFmpeg LIB_DEPENDS/WANTLIB changes
* add @@bin markers in PLISTs
* bump PKGNAMEs

feedback/ok brad@@
@
text
@d1 1
a1 1
$OpenBSD$
@

