head	1.3;
access;
symbols
	OPENBSD_5_4:1.2.0.14
	OPENBSD_5_4_BASE:1.2
	OPENBSD_5_3:1.2.0.12
	OPENBSD_5_3_BASE:1.2
	OPENBSD_5_2:1.2.0.10
	OPENBSD_5_2_BASE:1.2
	OPENBSD_5_1_BASE:1.2
	OPENBSD_5_1:1.2.0.8
	OPENBSD_5_0:1.2.0.6
	OPENBSD_5_0_BASE:1.2
	OPENBSD_4_9:1.2.0.4
	OPENBSD_4_9_BASE:1.2
	OPENBSD_4_8:1.2.0.2
	OPENBSD_4_8_BASE:1.2
	OPENBSD_4_7:1.1.0.4
	OPENBSD_4_7_BASE:1.1
	OPENBSD_4_6:1.1.0.2
	OPENBSD_4_6_BASE:1.1;
locks; strict;
comment	@# @;


1.3
date	2013.09.25.07.07.24;	author jasper;	state dead;
branches;
next	1.2;

1.2
date	2010.07.01.10.10.09;	author jakemsr;	state Exp;
branches;
next	1.1;

1.1
date	2009.04.14.18.43.39;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.3
log
@remove recordmydesktop which is unmaintained, doesn't quite work 100% of the time
and gnome-shell-recorder does a much better job.

ok aja@@
@
text
@$OpenBSD: patch-src_rmd_opendev_c,v 1.2 2010/07/01 10:10:09 jakemsr Exp $

sndio

--- src/rmd_opendev.c.orig	Sat Dec 13 08:10:49 2008
+++ src/rmd_opendev.c	Wed Jun 30 21:21:27 2010
@@@@ -27,12 +27,14 @@@@
 #include "config.h"
 #include "rmd_opendev.h"
 
+#if 0
 #ifdef HAVE_LIBASOUND
     #include <alsa/asoundlib.h>
 #else
     #include <sys/ioctl.h>
     #include <sys/soundcard.h>
 #endif
+#endif
 
 #include <stdlib.h>
 #include <stdio.h>
@@@@ -129,48 +131,48 @@@@ snd_pcm_t *OpenDev( const char *pcm_dev,
 
 #else
 
-int OpenDev( const char *pcm_dev,
+struct sio_hdl * OpenDev( const char *pcm_dev,
              unsigned int channels,
              unsigned int frequency){
-    int fd ;
-    fd=open(pcm_dev,O_RDONLY);
+    struct sio_hdl *hdl;
+    struct sio_par par;
 
-    if(fd!=-1){
+    hdl=sio_open(NULL,SIO_REC,0);
+
+    if(hdl!=NULL){
         unsigned int value;
 
-        if(ioctl(fd,SNDCTL_DSP_GETFMTS,&value)<0){
-            fprintf(stderr,"Couldn't get audio format list\n");
-            return -1;
+        sio_initpar(&par);
+        par.bits = 16;
+        par.sig = 1;
+        par.le = SIO_LE_NATIVE;
+        par.rchan = channels;
+        par.rate = frequency;
+
+        if (!sio_setpar(hdl, &par) || !sio_getpar(hdl, &par)) {
+            fprintf(stderr,"Couldn't set audio format\n" );
+            return NULL;
         }
-        if(value & AFMT_S16_LE){
-            value=AFMT_S16_LE;
-        }
-        else if(value & AFMT_S16_BE){
-            value=AFMT_S16_BE;
-        }
-        else{
+
+        if (par.bits != 16 || par.sig != 1 || par.le != SIO_LE_NATIVE) {
             fprintf(stderr,"Soundcard doesn't support signed 16-bit-data\n");
-            return -1;
+            return NULL;
         }
-        if(ioctl(fd,SNDCTL_DSP_SETFMT,&value)<0){
-            fprintf(stderr,"Couldn't set audio format\n" );
-            return -1;
+	if (par.rate != frequency) {
+            fprintf(stderr,"Soundcard doesn't support %d sample rate\n", frequency);
+            return NULL;
+	}
+	if (par.rchan != channels) {
+            fprintf(stderr,"Soundcard doesn't support %d channels\n", channels);
+            return NULL;
+	}
+
+        if (!sio_start(hdl)) {
+            fprintf(stderr,"Couldn't start sndio\n");
+            return NULL;
         }
-        value = channels;
-        if(ioctl(fd,SNDCTL_DSP_CHANNELS,&value)<0){
-            fprintf(stderr,"Cannot set the number of channels\n" );
-            return -1;
-        }
-        value = frequency;
-        if(ioctl(fd,SNDCTL_DSP_SPEED,&value)<0){
-            fprintf(stderr,"Couldn't set audio frequency\n" );
-            return -1;
-        }
-        if(fcntl(fd,F_SETFL,fcntl(fd,F_GETFL) & ~O_NONBLOCK)<0){
-            fprintf(stderr,"Couldn't set audio blocking mode\n" );
-            return -1;
-        }
+
     }
-    return fd;
+    return hdl;
 }
 #endif
@


1.2
log
@convert to sndio, provide previously missing headers, provide previously
missing cvs tags
sndio bits reviewed by ratchov@@
@
text
@d1 1
a1 1
$OpenBSD: patch-src_rmd_opendev_c,v 1.1 2009/04/14 18:43:39 jasper Exp $
@


1.1
log
@- update recordmydesktop(-gtk) to their 0.3.8.x versions
@
text
@d1 1
a1 1
$OpenBSD$
d3 1
a3 1
Fix path to the header file.
d5 8
a12 3
--- src/rmd_opendev.c.orig	Tue Apr 14 20:00:57 2009
+++ src/rmd_opendev.c	Tue Apr 14 20:01:04 2009
@@@@ -31,7 +31,7 @@@@
d16 1
a16 2
-    #include <sys/soundcard.h>
+    #include <soundcard.h>
d18 1
d21 83
@

