head	1.13;
access;
symbols
	OPENBSD_5_0:1.10.0.2
	OPENBSD_5_0_BASE:1.10
	OPENBSD_4_8:1.7.0.2
	OPENBSD_4_8_BASE:1.7
	OPENBSD_4_7:1.6.0.2
	OPENBSD_4_7_BASE:1.6
	OPENBSD_4_6:1.5.0.8
	OPENBSD_4_6_BASE:1.5
	OPENBSD_4_5:1.5.0.6
	OPENBSD_4_5_BASE:1.5
	OPENBSD_4_4:1.5.0.4
	OPENBSD_4_4_BASE:1.5
	OPENBSD_4_3:1.5.0.2
	OPENBSD_4_3_BASE:1.5
	OPENBSD_4_2:1.4.0.2
	OPENBSD_4_2_BASE:1.4
	OPENBSD_4_1:1.2.0.2
	OPENBSD_4_1_BASE:1.2
	OPENBSD_4_0:1.1.1.1.0.2
	OPENBSD_4_0_BASE:1.1.1.1
	jakemsr:1.1.1.1
	jakemsr-20060324:1.1.1;
locks; strict;
comment	@# @;


1.13
date	2012.06.10.07.35.30;	author ajacoutot;	state dead;
branches;
next	1.12;

1.12
date	2012.05.09.06.29.43;	author ajacoutot;	state Exp;
branches;
next	1.11;

1.11
date	2011.11.16.00.43.17;	author sthen;	state dead;
branches;
next	1.10;

1.10
date	2011.05.11.09.05.55;	author dcoppa;	state Exp;
branches;
next	1.9;

1.9
date	2010.11.07.18.45.38;	author jasper;	state dead;
branches;
next	1.8;

1.8
date	2010.09.13.20.12.16;	author sthen;	state Exp;
branches;
next	1.7;

1.7
date	2010.04.20.11.32.14;	author sthen;	state Exp;
branches;
next	1.6;

1.6
date	2010.01.05.11.48.51;	author sthen;	state Exp;
branches;
next	1.5;

1.5
date	2008.01.15.00.36.46;	author jakemsr;	state Exp;
branches;
next	1.4;

1.4
date	2007.06.13.10.58.29;	author jakemsr;	state Exp;
branches;
next	1.3;

1.3
date	2007.05.01.20.05.10;	author naddy;	state Exp;
branches;
next	1.2;

1.2
date	2006.10.12.04.48.14;	author brad;	state Exp;
branches;
next	1.1;

1.1
date	2006.03.24.22.43.41;	author jakemsr;	state Exp;
branches
	1.1.1.1;
next	;

1.1.1.1
date	2006.03.24.22.43.41;	author jakemsr;	state Exp;
branches
	1.1.1.1.2.1;
next	;

1.1.1.1.2.1
date	2006.11.01.13.13.03;	author sturm;	state Exp;
branches;
next	;


desc
@@


1.13
log
@Update to stable, xine-lib-1.1.21.

from Brad (maintainer)
@
text
@$OpenBSD: patch-src_xine-engine_video_decoder_c,v 1.12 2012/05/09 06:29:43 ajacoutot Exp $
--- src/xine-engine/video_decoder.c.orig	Tue May  8 23:17:58 2012
+++ src/xine-engine/video_decoder.c	Tue May  8 23:18:56 2012
@@@@ -518,7 +518,7 @@@@ int _x_video_decoder_init (xine_stream_t *stream) {
   } else {
 
     pthread_attr_t       pth_attrs;
-#ifdef _POSIX_THREAD_PRIORITY_SCHEDULING
+#if defined(_POSIX_THREAD_PRIORITY_SCHEDULING) && (_POSIX_THREAD_PRIORITY_SCHEDULING > 0)
     struct sched_param   pth_params;
 #endif
     int		       err, num_buffers;
@@@@ -549,7 +549,7 @@@@ int _x_video_decoder_init (xine_stream_t *stream) {
     stream->spu_track_map_entries = 0;
 
     pthread_attr_init(&pth_attrs);
-#ifdef _POSIX_THREAD_PRIORITY_SCHEDULING
+#if defined(_POSIX_THREAD_PRIORITY_SCHEDULING) && (_POSIX_THREAD_PRIORITY_SCHEDULING > 0)
     pthread_attr_getschedparam(&pth_attrs, &pth_params);
     pth_params.sched_priority = sched_get_priority_min(SCHED_OTHER);
     pthread_attr_setschedparam(&pth_attrs, &pth_params);
@


1.12
log
@Correct the utilization of the _POSIX_THREAD_PRIORITY_SCHEDULING feature
test macro.

from Brad (maintainer)
@
text
@d1 1
a1 1
$OpenBSD$
@


1.11
log
@update to xine-lib 1.1.20, from Brad
@
text
@d1 21
a21 73
$OpenBSD: patch-src_xine-engine_video_decoder_c,v 1.10 2011/05/11 09:05:55 dcoppa Exp $

- Avoid video clock errors due to decoder flush at discontinuity.
- Disable decoder flush at discontinuity to avoid decoding errors.

--- src/xine-engine/video_decoder.c.orig	Mon May  9 20:56:04 2011
+++ src/xine-engine/video_decoder.c	Mon May  9 21:02:28 2011
@@@@ -102,6 +102,11 @@@@ int _x_spu_decoder_sleep(xine_stream_t *stream, int64_
   return thread_vacant;
 }
 
+static void video_decoder_update_disable_flush_at_discontinuity(void *disable_decoder_flush_at_discontinuity, xine_cfg_entry_t *entry)
+{
+  *(int *)disable_decoder_flush_at_discontinuity = entry->num_value;
+}
+
 static void *video_decoder_loop (void *stream_gen) {
 
   buf_element_t   *buf;
@@@@ -112,6 +117,7 @@@@ static void *video_decoder_loop (void *stream_gen) {
   int              prof_video_decode = -1;
   int              prof_spu_decode = -1;
   uint32_t         buftype_unknown = 0;
+  int              disable_decoder_flush_at_discontinuity;
 
 #ifndef WIN32
   /* nice(-value) will fail silently for normal users.
@@@@ -127,6 +133,15 @@@@ static void *video_decoder_loop (void *stream_gen) {
   if (prof_spu_decode == -1)
     prof_spu_decode = xine_profiler_allocate_slot ("spu decoder");
 
+  disable_decoder_flush_at_discontinuity = stream->xine->config->register_bool(stream->xine->config, "engine.decoder.disable_flush_at_discontinuity", 0,
+      _("disable decoder flush at discontinuity"),
+      _("when watching live tv a discontinuity happens for example about every 26.5 hours due to a pts wrap.\n"
+        "flushing the decoder at that time causes decoding errors for images after the pts wrap.\n"
+        "to avoid the decoding errors, decoder flush at discontinuity should be disabled.\n\n"
+        "WARNING: as the flush was introduced to fix some issues when playing DVD still images, it is\n"
+        "likely that these issues may reappear in case they haven't been fixed differently meanwhile.\n"),
+        20, video_decoder_update_disable_flush_at_discontinuity, &disable_decoder_flush_at_discontinuity);
+
   while (running) {
 
     lprintf ("getting buffer...\n");
@@@@ -307,10 +322,11 @@@@ static void *video_decoder_loop (void *stream_gen) {
 
       if (stream->video_decoder_plugin) {
         running_ticket->acquire(running_ticket, 0);
-        /* it might be a long time before we get back from a discontinuity, so we better flush
-	 * the decoder before */
-        stream->video_decoder_plugin->flush (stream->video_decoder_plugin);
         stream->video_decoder_plugin->discontinuity (stream->video_decoder_plugin);
+        /* it might be a long time before we get back from a handle_video_discontinuity,
+	 * so we better flush the decoder before */
+        if (!disable_decoder_flush_at_discontinuity)
+          stream->video_decoder_plugin->flush (stream->video_decoder_plugin);
         running_ticket->release(running_ticket, 0);
       }
 
@@@@ -323,10 +339,11 @@@@ static void *video_decoder_loop (void *stream_gen) {
 
       if (stream->video_decoder_plugin) {
         running_ticket->acquire(running_ticket, 0);
-        /* it might be a long time before we get back from a discontinuity, so we better flush
-	 * the decoder before */
-        stream->video_decoder_plugin->flush (stream->video_decoder_plugin);
         stream->video_decoder_plugin->discontinuity (stream->video_decoder_plugin);
+        /* it might be a long time before we get back from a handle_video_discontinuity,
+	 * so we better flush the decoder before */
+        if (!disable_decoder_flush_at_discontinuity)
+          stream->video_decoder_plugin->flush (stream->video_decoder_plugin);
         running_ticket->release(running_ticket, 0);
       }
 
@


1.10
log
@- Get rid of the use of libtool's -tag=disable-static.

- Merge in a whole bunch of various fixes from upstream and add
  comments for the existing fixes which didn't have a comment in
  the patch.

From Brad; OK sthen@@
@
text
@d1 1
a1 1
$OpenBSD$
@


1.9
log
@- remove unneeded patches that we have sched_get_priority_* now.

from brad (MAINTAINER)
@
text
@d1 73
a73 13
$OpenBSD: patch-src_xine-engine_video_decoder_c,v 1.8 2010/09/13 20:12:16 sthen Exp $
--- src/xine-engine/video_decoder.c.orig	Wed Jul 21 13:43:52 2010
+++ src/xine-engine/video_decoder.c	Tue Jul 27 16:54:58 2010
@@@@ -523,7 +523,9 @@@@ int _x_video_decoder_init (xine_stream_t *stream) {
     pthread_attr_init(&pth_attrs);
 #ifdef _POSIX_THREAD_PRIORITY_SCHEDULING
     pthread_attr_getschedparam(&pth_attrs, &pth_params);
+#ifndef __OpenBSD__
     pth_params.sched_priority = sched_get_priority_min(SCHED_OTHER);
+#endif
     pthread_attr_setschedparam(&pth_attrs, &pth_params);
     pthread_attr_setscope(&pth_attrs, PTHREAD_SCOPE_SYSTEM);
 #endif
@


1.8
log
@update xine-lib to 1.1.19 and switch to new-style LIB_DEPENDS/WANTLIB
from Brad, thanks landry@@ for testing in bulk build
@
text
@d1 1
a1 1
$OpenBSD: patch-src_xine-engine_video_decoder_c,v 1.7 2010/04/20 11:32:14 sthen Exp $
@


1.7
log
@Remove unused patch hunk (ifndef'd out), from Brad. No package change.
@
text
@d1 4
a4 16
$OpenBSD: patch-src_xine-engine_video_decoder_c,v 1.6 2010/01/05 11:48:51 sthen Exp $
--- src/xine-engine/video_decoder.c.orig	Tue Feb 23 17:27:15 2010
+++ src/xine-engine/video_decoder.c	Sun Apr 18 13:01:34 2010
@@@@ -486,7 +486,9 @@@@ int _x_video_decoder_init (xine_stream_t *stream) {
   } else {
 
     pthread_attr_t       pth_attrs;
+#if !defined(__OpenBSD__)
     struct sched_param   pth_params;
+#endif
     int		       err, num_buffers;
     /* The fifo size is based on dvd playback where buffers are filled
      * with 2k of data. With 500 buffers and a typical video data rate
@@@@ -515,10 +517,12 @@@@ int _x_video_decoder_init (xine_stream_t *stream) {
     stream->spu_track_map_entries = 0;
 
d6 1
a6 1
+#if !defined(__OpenBSD__)
d8 1
d10 1
d13 1
a13 4
+#endif
 
     stream->video_thread_created = 1;
     if ((err = pthread_create (&stream->video_thread,
@


1.6
log
@Update to xine-lib 1.1.17 and disable win32 codecs. From Brad.
@
text
@d1 4
a4 14
$OpenBSD: patch-src_xine-engine_video_decoder_c,v 1.5 2008/01/15 00:36:46 jakemsr Exp $
--- src/xine-engine/video_decoder.c.orig	Mon Nov 30 15:55:51 2009
+++ src/xine-engine/video_decoder.c	Wed Dec  2 19:15:36 2009
@@@@ -41,6 +41,9 @@@@
 
 #define SPU_SLEEP_INTERVAL (90000/2)
 
+#ifndef SCHED_OTHER
+#define SCHED_OTHER 0
+#endif
 
 static void update_spu_decoder (xine_stream_t *stream, int type) {
 
@@@@ -486,7 +489,9 @@@@ int _x_video_decoder_init (xine_stream_t *stream) {
d14 1
a14 1
@@@@ -515,10 +520,12 @@@@ int _x_video_decoder_init (xine_stream_t *stream) {
@


1.5
log
@update to 1.1.9.1

security fix: CVE-2008-0225 - heap-based buffer overflow in libreal (RTSP)

also incorporates post release bug fix in WMV decoding

from brad, thanks
@
text
@d1 3
a3 3
$OpenBSD: patch-src_xine-engine_video_decoder_c,v 1.4 2007/06/13 10:58:29 jakemsr Exp $
--- src/xine-engine/video_decoder.c.orig	Tue Jan  1 10:36:02 2008
+++ src/xine-engine/video_decoder.c	Wed Jan  9 01:50:22 2008
d16 1
a16 1
      
d26 1
a26 1
   
@


1.4
log
@update to xine-lib-1.1.7

- use some CONFIGURE_ENV instead of patching
- rearrange/update CONFIGURE_ARGS
- many patches no longer relevant
- add CD audio support

input, tetsing and prodding from brad@@
@
text
@d1 4
a4 4
$OpenBSD$
--- src/xine-engine/video_decoder.c.orig	Sun Apr 15 10:42:17 2007
+++ src/xine-engine/video_decoder.c	Sun May 20 22:40:14 2007
@@@@ -43,6 +43,9 @@@@
d14 1
a14 1
@@@@ -479,7 +482,9 @@@@ int _x_video_decoder_init (xine_stream_t *stream) {
d24 1
a24 1
@@@@ -508,10 +513,12 @@@@ int _x_video_decoder_init (xine_stream_t *stream) {
@


1.3
log
@regen patches
@
text
@d1 3
a3 3
$OpenBSD: patch-src_xine-engine_video_decoder_c,v 1.2 2006/10/12 04:48:14 brad Exp $
--- src/xine-engine/video_decoder.c.orig	Sun Jul  9 16:40:08 2006
+++ src/xine-engine/video_decoder.c	Tue May  1 22:03:06 2007
d14 1
a14 1
@@@@ -473,7 +476,9 @@@@ void _x_video_decoder_init (xine_stream_t *stream) {
d24 1
a24 1
@@@@ -497,10 +502,12 @@@@ void _x_video_decoder_init (xine_stream_t *stream) {
@


1.2
log
@upgrade to xine-lib 1.1.2

* Security fixes:
  - CVE-2006-2802: possible buffer overflow in the HTTP plugin.
  - possible buffer overflow via bad indexes in specially-crafted AVI files
* Fix a potential crash with fixed-size lacing in the Matroska demuxer
* Enable AMD64 mmx/sse support in some plugins (tvtime, libmpeg2, goom...)
* Fix xxmc subpictures (broken since 1.1.1)
* Add support for RealPlayer 10 codecs

WANTLIB tweak from bernd@@

testing by steven@@ and bernd@@
@
text
@d1 3
a3 3
$OpenBSD: patch-src_xine-engine_video_decoder_c,v 1.1.1.1 2006/03/24 22:43:41 jakemsr Exp $
--- src/xine-engine/video_decoder.c.orig	Sun Jul  9 10:40:08 2006
+++ src/xine-engine/video_decoder.c	Fri Sep 15 18:12:20 2006
d14 1
a14 1
@@@@ -473,7 +476,9 @@@@ void _x_video_decoder_init (xine_stream_
d24 1
a24 1
@@@@ -497,10 +502,12 @@@@ void _x_video_decoder_init (xine_stream_
@


1.1
log
@Initial revision
@
text
@d1 4
a4 4
$OpenBSD$
--- src/xine-engine/video_decoder.c.orig	Sat Oct 29 21:18:35 2005
+++ src/xine-engine/video_decoder.c	Fri Dec 30 02:32:50 2005
@@@@ -43,7 +43,11 @@@@
a11 1
+
d14 1
a14 2
   int streamtype = (type>>16) & 0xFF;
@@@@ -473,7 +477,9 @@@@ void _x_video_decoder_init (xine_stream_
d24 1
a24 1
@@@@ -497,10 +503,12 @@@@ void _x_video_decoder_init (xine_stream_
@


1.1.1.1
log
@initial import of xine-lib

xine is a free multimedia player. It plays back CDs, DVDs, and VCDs. It
also decodes multimedia files like AVI, MOV, WMV, and MP3 from local
disk drives, and displays multimedia streamed over the Internet. It
interprets many of the most common multimedia formats available - and
some of the most uncommon formats, too.

prodded by jolan@@ and bernd@@

@
text
@@


1.1.1.1.2.1
log
@MFC:
upgrade to xine-lib 1.1.2

* Security fixes:
- CVE-2006-2802: possible buffer overflow in the HTTP plugin.
- possible buffer overflow via bad indexes in specially-crafted AVI files
* Fix a potential crash with fixed-size lacing in the Matroska demuxer
* Enable AMD64 mmx/sse support in some plugins (tvtime, libmpeg2, goom...)
* Fix xxmc subpictures (broken since 1.1.1)
* Add support for RealPlayer 10 codecs

WANTLIB tweak from bernd@@
@
text
@d1 4
a4 4
$OpenBSD: patch-src_xine-engine_video_decoder_c,v 1.2 2006/10/12 04:48:14 brad Exp $
--- src/xine-engine/video_decoder.c.orig	Sun Jul  9 10:40:08 2006
+++ src/xine-engine/video_decoder.c	Fri Sep 15 18:12:20 2006
@@@@ -43,6 +43,9 @@@@
d12 1
d15 2
a16 1
@@@@ -473,7 +476,9 @@@@ void _x_video_decoder_init (xine_stream_
d26 1
a26 1
@@@@ -497,10 +502,12 @@@@ void _x_video_decoder_init (xine_stream_
@

