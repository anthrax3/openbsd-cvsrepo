head	1.8;
access;
symbols
	OPENBSD_5_0:1.1.0.2;
locks; strict;
comment	@# @;


1.8
date	2012.10.12.20.31.45;	author sthen;	state dead;
branches;
next	1.7;

1.7
date	2012.09.27.23.35.49;	author sthen;	state Exp;
branches;
next	1.6;

1.6
date	2012.01.30.11.46.36;	author nigel;	state dead;
branches;
next	1.5;

1.5
date	2012.01.24.11.59.57;	author sthen;	state Exp;
branches;
next	1.4;

1.4
date	2011.11.22.16.22.22;	author sthen;	state dead;
branches;
next	1.3;

1.3
date	2011.10.09.20.14.28;	author sthen;	state Exp;
branches;
next	1.2;

1.2
date	2011.09.19.12.40.06;	author sthen;	state Exp;
branches;
next	1.1;

1.1
date	2011.08.16.08.23.09;	author sthen;	state Exp;
branches
	1.1.2.1;
next	;

1.1.2.1
date	2011.08.24.07.52.00;	author jasper;	state Exp;
branches;
next	;


desc
@@


1.8
log
@update get-flash-videos to a newer snapshot
@
text
@$OpenBSD: patch-lib_FlashVideo_Site_Youtube_pm,v 1.7 2012/09/27 23:35:49 sthen Exp $

https://github.com/pder/get-flash-videos/commit/46f4dae05a1ad33dd0561c23d185fca1663bb4cf

--- lib/FlashVideo/Site/Youtube.pm.orig	Fri Sep 28 00:30:06 2012
+++ lib/FlashVideo/Site/Youtube.pm	Fri Sep 28 00:32:57 2012
@@@@ -178,6 +178,7 @@@@ sub parse_youtube_url_encoded_fmt_stream_map {
     
     my $format = "";
     my $url = "";
+    my $sig = "";
     
     foreach my $pair (split /&/, $params) {
       my ($name, $value) = split /=/, $pair;
@@@@ -185,10 +186,12 @@@@ sub parse_youtube_url_encoded_fmt_stream_map {
         $format = $value;
       } elsif ($name eq "url") {
         $url = uri_unescape($value);
+      } elsif ($name eq "sig") {
+        $sig = $value;
       }
     }
     
-    $map->{$format} = $url;
+    $map->{$format} = "$url&signature=$sig";
   }
   
   return $map;
@


1.7
log
@unbreak youtube with get_flash_videos; they now require a signature url param.
@
text
@d1 1
a1 1
$OpenBSD$
@


1.6
log
@Update for Channel4 and Itv Sites.

Ok sthen@@
@
text
@d1 28
a28 13
$OpenBSD: patch-lib_FlashVideo_Site_Youtube_pm,v 1.5 2012/01/24 11:59:57 sthen Exp $
--- lib/FlashVideo/Site/Youtube.pm.orig	Tue Jan 24 11:39:13 2012
+++ lib/FlashVideo/Site/Youtube.pm	Tue Jan 24 11:54:38 2012
@@@@ -62,7 +62,8 @@@@ sub find_video {
   my $video_id;
   if ($browser->content =~ /(?:var pageVideoId =|(?:CFG_)?VIDEO_ID'?\s*:)\s*'(.+?)'/
       || $browser->content =~ /"video_id": "([^"]+)"/
-      || $embed_url =~ /v=([^&]+)/) {
+      || $embed_url =~ /v=([^&]+)/
+      || $browser->content =~ /&amp;video_id=([^&]+)&amp;/) {
     $video_id = $1;
   } else {
     check_die($browser, "Couldn't extract video ID");
@


1.5
log
@update to a newer get_flash_videos snapshot

- UK users: adds support for c4, pointed out by nigel@@

- add a patch to deal with the "simple browser" fallback webpage that
gets sent when requests hit youtube via the youtu.be redirector,
pointed out by Antti Harri
@
text
@d1 1
a1 1
$OpenBSD$
@


1.4
log
@update to newer get-flash-videos snapshot
@
text
@d1 13
a13 79
$OpenBSD: patch-lib_FlashVideo_Site_Youtube_pm,v 1.3 2011/10/09 20:14:28 sthen Exp $
--- lib/FlashVideo/Site/Youtube.pm.orig	Tue Jul 12 10:01:47 2011
+++ lib/FlashVideo/Site/Youtube.pm	Sun Oct  9 21:12:28 2011
@@@@ -133,6 +133,12 @@@@ sub find_video {
     } elsif($info{fmt_url_map}) {
       debug "Using fmt_url_map method from info";
       return $self->download_fmt_map($prefs, $browser, $title, \%info, $info{fmt_url_map});
+    } elsif($info{url_encoded_fmt_stream_map}) {
+      debug "Using url_encoded_fmt_stream_map method from info";
+      if ($info{title}) {
+        $title=$info{title};
+      }
+      return $self->download_url_encoded_fmt_stream_map($prefs, $browser, $title, \%info, $info{url_encoded_fmt_stream_map});
     }
   }
 
@@@@ -140,6 +146,53 @@@@ sub find_video {
   return download_get_video($browser, $prefs, $video_id, $title, $t);
 }
 
+sub download_url_encoded_fmt_stream_map {
+  my($self, $prefs, $browser, $title, $info, $fmt_map) = @@_;
+
+  my $fmt_url_map = parse_youtube_url_encoded_fmt_stream_map($fmt_map);
+
+  if (!$title and $browser->uri->as_string =~ m'/user/.*?#') {
+    my $video_id = (split /\//, $browser->uri->fragment)[-1];
+
+    my %info = get_youtube_video_info($browser->clone, $video_id);
+
+    $title = $info->{title};
+  }
+
+  my $preferred_quality = $prefs->quality->choose(map { $fmt_url_map->{$_->{id}}
+      ? { resolution => $_->{resolution}, url => $fmt_url_map->{$_->{id}} }
+      : () } @@formats);
+
+  $browser->allow_redirects;
+
+  return $preferred_quality->{url}, title_to_filename($title, "mp4");
+}
+
+sub parse_youtube_url_encoded_fmt_stream_map {
+  my($raw_map) = @@_;;
+
+  my $map = {};
+
+  foreach my $params (split /,/, $raw_map) {
+    
+    my $format = "";
+    my $url = "";
+    
+    foreach my $pair (split /&/, $params) {
+      my ($name, $value) = split /=/, $pair;
+      if ($name eq "itag"){
+        $format = $value;
+      } elsif ($name eq "url") {
+        $url = uri_unescape($value);
+      }
+    }
+    
+    $map->{$format} = $url;
+  }
+  
+  return $map;
+}
+
 sub download_fmt_map {
   my($self, $prefs, $browser, $title, $info, $fmt_map) = @@_;
 
@@@@ -341,7 +394,7 @@@@ sub get_youtube_video_info {
       "http://www.youtube.com/get_video_info?&video_id=%s&el=$el&ps=default&eurl=%s&hl=en_US&t=%s";
 
     my $video_info_url = sprintf $video_info_url_template,
-      uri_escape($video_id), uri_escape($url), uri_escape($t);
+      uri_escape($video_id), uri_escape($url), uri_escape_utf8($t);
 
     debug "get_youtube_video_info: $video_info_url";
 
@


1.3
log
@add upstream patch: Get Youtube video title from video info - restores
sane filenames.
@
text
@d1 1
a1 1
$OpenBSD: patch-lib_FlashVideo_Site_Youtube_pm,v 1.2 2011/09/19 12:40:06 sthen Exp $
@


1.2
log
@fix get_flash_videos issue on youtube pages with utf8, reported by Antti Harri.
From swdyh's g-f-v fork on github
@
text
@d1 1
a1 1
$OpenBSD: patch-lib_FlashVideo_Site_Youtube_pm,v 1.1 2011/08/16 08:23:09 sthen Exp $
d3 2
a4 2
+++ lib/FlashVideo/Site/Youtube.pm	Mon Sep 19 13:30:48 2011
@@@@ -133,6 +133,9 @@@@ sub find_video {
d10 3
d17 1
a17 1
@@@@ -140,6 +143,53 @@@@ sub find_video {
d71 1
a71 1
@@@@ -341,7 +391,7 @@@@ sub get_youtube_video_info {
@


1.1
log
@fix following youtube changes; patch pointed out by nigel@@
@
text
@d1 4
a4 4
$OpenBSD$
--- lib/FlashVideo/Site/Youtube.pm.orig	Fri Aug  5 18:00:19 2011
+++ lib/FlashVideo/Site/Youtube.pm	Fri Aug  5 18:00:42 2011
@@@@ -133,11 +133,61 @@@@ sub find_video {
d14 1
a14 1
   # Try old get_video method, just incase.
d16 2
a17 2
+}
+
d63 13
a75 1
 }
a76 1
 sub download_fmt_map {
@


1.1.2.1
log
@Fix youtube functionality in OPENBSD_5_0, original commit by sthen@@
@
text
@d1 1
a1 1
$OpenBSD: patch-lib_FlashVideo_Site_Youtube_pm,v 1.1 2011/08/16 08:23:09 sthen Exp $
@

